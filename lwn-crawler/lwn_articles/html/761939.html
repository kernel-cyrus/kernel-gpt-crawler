        <!DOCTYPE html>
        <html lang="en">
        <head><title>WireGuarding the mainline [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/761939/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/761585/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/761939/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>WireGuarding the mainline</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 6, 2018</br>
           </div>
The <a href="https://www.wireguard.com/">WireGuard</a> VPN tunnel has been
under development — and attracting attention — for a few years now; LWN <a
href="/Articles/748582/">ran a review</a> of it in March.  While WireGuard
can be found in a number of distribution repositories, it is not yet
shipped with the mainline kernel because its author, Jason Donenfeld, hasn't
gotten around to proposing it for upstreaming.  That changed on 
July&nbsp;31, when Donenfeld <a
href="/ml/linux-kernel/20180731191102.2434-1-Jason@zx2c4.com/">posted
WireGuard 
for review</a>.  Getting WireGuard itself into the mainline would probably
not be 
all that hard; merging some of the support code it depends on could be
another story, though.
<p>
WireGuard implements a simple tunneling protocol allowing network traffic
to be routed through a virtual private network provider.  It has been
developed with an eye toward smallness, ease of verification, and
performance, rather than large numbers of features.  It is, according to the
patch posting, "<q>used by some massive companies pushing enormous
amounts of traffic</q>".  Some effort has gone into making WireGuard
widely available, an effort that has helped to create a significant user
community.  But the ultimate way to make this kind of software widely
available is to get it into everybody's kernel; that requires upstreaming.
<p>
Thus far, the WireGuard code itself does not appear to be hugely controversial.
There are plenty of little issues to deal with, including the inevitable
(for networking code) demand that variable declarations be put into
"reverse Christmas tree" order, along with a few technical issues that
would appear to be easily resolved.  Dealing with those things will likely
take a couple of iterations, but the real fate of WireGuard is likely to be
driven by <a
href="/ml/linux-kernel/CA+55aFz5EWE9OTbzDoMfsY2ez04Qv9eg0KQhwKfyJY0vFvoD3g@mail.gmail.com/">this
"review"</a> from Linus Torvalds:
<p>
<div class="BigQuote">
	I see that Jason actually made the pull
	request to have wireguard included in the kernel.
	<p>
	Can I just once again state my love for it and hope it gets merged
	soon? Maybe the code isn't perfect, but I've skimmed it, and compared
	to the horrors that are OpenVPN and IPSec, it's a work of art.
</div>
<p>

There is a potential sticking point, though.  WireGuard, as one would
expect, encrypts traffic between the ends of the tunnel, and endpoints
perform cryptographic authentication of their peers.  The kernel offers <a
href="https://www.kernel.org/doc/html/latest/crypto/index.html">an
extensive cryptographic subsystem</a> that could be used to perform these
operations, but Donenfeld turns out not to be a fan of that API.  In an <a
href="/Articles/748584/">"upstreaming roadmap"</a> posted last November, he
stated his intent to "<q>embark on a multi-pronged effort to overhaul
the crypto API</q>".  In the end, he has created a completely new
cryptographic subsystem for the kernel and based WireGuard on that
rather than on the existing cryptographic code.
<p>
Even without seeing this work, one can imagine that an effort to thrash
up a longstanding core API would be a relatively hard sell.  Donenfeld
seemed to be trying to make things harder yet: his "Zinc" cryptography API
was posted as a single, 24,000-line patch that was duly rejected by the
mailing-list filters.  It is <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/zx2c4/linux.git/commit/?h=zinc">available
in his repository</a>, though, for those who want to take a look.  The
changelog describes the motivations for Zinc in the sort of, shall we say,
highly self-assured language favored by security-oriented developers.  It
seems designed to raise enough hackles to prevent serious consideration of
what is actually being proposed.
<p>
In short, Donenfeld argues, the kernel's cryptographic API is far too
complex and difficult to use.  It is designed to work with acceleration
hardware and allow sophisticated composition of operations, requiring users
to do things like set up transform contexts and scatter/gather
lists for the data to be encrypted.  But most users simply want to perform
a simple cryptographic operation and do not benefit from the complexity of
the kernel's API, so developers tend to avoid it.  What's needed, he says,
is a different sort of cryptographic library:
<p>
<div class="BigQuote">
	The kernel is in the business usually not of coming up with new
	uses of crypto, but rather implementing various constructions,
	which means it essentially needs a library of primitives, not a
	highly abstracted enterprise-ready pluggable system, with a few
	particular exceptions.
</div>
<p>
Zinc follows this philosophy by providing a simple set of cryptographic
algorithms that can be called without any elaborate setup rituals.  A
number of those algorithms duplicate functionality that already exists in
the kernel's cryptographic layer.  There is talk in the changelog about
eventually reworking the in-kernel code to be based on Zinc, but that work
has not been done at this time.
<p>
While Zinc has not exactly been received with open arms, neither
has it been rejected out of hand.  Donenfeld does actually have a point when it
comes to the complexity of the current cryptographic API.  The <a
href="/ml/linux-kernel/20180801072246.GA15677@sol.localdomain">most
detailed review</a> so far has come from kernel cryptographic developer
Eric Biggers who, after saying
that he wanted to see WireGuard upstream, said that "<q>a few things are on
the wrong track</q>" on the Zinc side.  He would like to see the various
algorithms split out and added separately, for example, making the patch
set easier to review.  He pointed out that Zinc cannot support hardware
cryptographic accelerators, something that Donenfeld regards as a feature.
All told, he seems to not be opposed to the overall concepts behind Zinc,
but would like to see a number of changes in the implementation.
<p>
Andy Lutomirski <a
href="/ml/linux-kernel/CALCETrXD_VyoyW5C1U34o-ySJ4nFcO6PQ+ZNBVYxCpJ-f65CHw@mail.gmail.com/">was
generally favorable</a> as well, noting that he has tried to carry out some
similar changes to the cryptographic code in the past.  Support for
hardware accelerators should, he said, be built on top of Zinc; code
needing that support could then use the more complex API that would be
required, and the Zinc implementations could be used as fallbacks when
acceleration is not available or practical to use.  Lutomirski supported a
number of Biggers's requests for changes.  Meanwhile, Herbert Xu, the
maintainer of the cryptographic subsystem, has stayed out of the
discussion. 
<p>
Donenfeld has been generally receptive to the requests for changes, and has
promised a new version of Zinc with many of the issues raised so far
addressed.  That will almost certainly not be the end of the discussion; 
that kind of deep surgery on a core kernel subsystem does not happen
overnight.  But if all of the participants in the conversation continue to
be open to what the others are saying, the remaining kinks should be ironed
out before too long, and WireGuard will finally have a path into the
mainline.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Cryptography">Cryptography</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking-Virtual_private_networks">Networking/Virtual private networks</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Encryption-Network">Encryption/Network</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Virtual_private_network_VPN">Linux kernel/Virtual private network (VPN)</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/761939/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor761962"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 1:54 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/761962/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suppose this is as good a place to ask as any: what in an average Linux desktop distro actually makes use of the current crypto API? I see a few things required for filesystem checksums and wireless networking, but the latter is a weird case because hostapd/wpa_supplicant also wants userspace SSL libraries to speak WPA.<br>
<p>
(Also I think this is the most positive reaction I've seen from Linus to anything. Maybe that comes from using other VPNs? :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/761962/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor761968"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 5:35 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/761968/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; what in an average Linux desktop distro actually makes use of the current crypto API?</font><br>
<p>
Encrypted disks, filesystems that support file encryption, the CIFS/SMB filesystem, signed kernel modules, TCP Fast Open, Bluetooth, and various things that use compression (which goes through the crypto subsystem as well).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/761968/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762025"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 15:26 UTC (Tue)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/762025/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I encountered some of this while doing VMAP_STACK. The existing crypto APIs support for doing crypto on small stack buffers is mediocre, to put it mildly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762025/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor762296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2018 7:45 UTC (Fri)
                               by <b>ndesaulniers</b> (subscriber, #110768)
                              [<a href="/Articles/762296/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To add to this (maybe not average Linux desktop distro's), Google has a strong policy on encrypting data in flight or at rest.  The filesystem is encrypted on Pixel phones, and servers in our datacenters.  Both have some form of hardware acceleration for encrypting many blocks worth of data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor761964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 3:23 UTC (Tue)
                               by <b>unixbhaskar</b> (guest, #44758)
                              [<a href="/Articles/761964/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whoa! that sounds great. Why people jumping for more feature??? It is designed to be used with one single thing and it should do what it suppose to do. More feature(most of them not used by anybody) , go and take a look at the other part. If it's sticking with its current form with little bit enhancement in the future, which was suggested by other people, it will be good. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/761964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor761969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 5:54 UTC (Tue)
                               by <b>zx2c4</b> (subscriber, #82519)
                              [<a href="/Articles/761969/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>Donenfeld seemed to be trying to make things harder yet: his "Zinc" cryptography API was posted as a single, 24,000-line patch that was duly rejected by the mailing-list filters. It is available in his repository, though, for those who want to take a look. The changelog describes the motivations for Zinc in the sort of, shall we say, highly self-assured language favored by security-oriented developers. It seems designed to raise enough hackles to prevent serious consideration of what is actually being proposed.</blockquote>

Certainly not "trying to make things harder" and it wasn't "designed to raise enough hackles". But rest assured the Zinc portion will be considerably different in form for v2. Split into several separably reviewable parts, each message will have very specific commentary on the particulars of each patch, so there will be less of the language that's "favored by security-oriented developers," opting instead to get right down to the point of the patch. And regardless, I'm happy iterating on this until it's acceptable, as I think it's a significant improvement on the status quo.
      
          <div class="CommentReplyButton">
            <form action="/Articles/761969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor761976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 9:54 UTC (Tue)
                               by <b>kaliszad</b> (guest, #125214)
                              [<a href="/Articles/761976/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank You for Your hard work.<br>
<p>
I have been in Your talk at 34C3. As I said after it, I would very much like to use WireGuard with some kind of failover like VRRP/ keepalived or Pacemaker. I guess, this is a harder problem, than it looks. You have to move the virtual IP to the node (that is easily done) but the problem is to turn the interface on in such a way as to consider time outs and such of other dependent tasks. I haven't looked into it, I had other stuff to do besides I will not be able to use unsupported (by Red Hat in my case) features on a cluster - the inclusion in the kernel would make it a likely addition to the enterprise distributions the next round.<br>
<p>
Maybe, this business (like You say) is best left to some other management application, maybe a Pacemaker resource like systemd could start a unit or something. keepalived would probably need some kind of notify script that is executed on migration. I am just thinking out loud here.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/761976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor761982"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 12:19 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/761982/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Apologies if the, let's say, "language favored by LWN editors" raised some hackles of its own; obviously you weren't out to upset people.  The "significant improvement" part seems to be getting across - looking forward to having all of this in the mainline.
      
          <div class="CommentReplyButton">
            <form action="/Articles/761982/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor761984"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 13:20 UTC (Tue)
                               by <b>ms-tg</b> (subscriber, #89231)
                              [<a href="/Articles/761984/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; ...the Zinc portion will be considerably different in form for v2. Split into several separably reviewable parts...</font><br>
<p>
As others have said, *Thank You* for what you are doing!<br>
<p>
Do you think, at the end of the Zinc v2 patch series, there will be the patches that refactor the existing crypto subsystem to use the new Zinc as the default non-accelerated implementation, removing all existing non-accelerated implementations outside of Zinc, and then keeping the existing crypto acceleration features as a layer on top of Zinc?<br>
<p>
Super interested to see, as a "natural experiment", if that level of refactoring and unification across subsystems can really occur in the current kernel development process in a situation like this?<br>
<p>
Thanks,<br>
-Marc<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/761984/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor762707"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2018 14:58 UTC (Wed)
                               by <b>aigarius</b> (guest, #7329)
                              [<a href="/Articles/762707/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the point was to provide a simple crypto API ... why not just do that? Provide a simplified API, but then implement it using the existing kernel crypto system. You get both a simple and a comple API, hardware acceleration and easier path to merging it all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762707/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor761970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 6:17 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/761970/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To be fair, the bulk of Zinc code consists mostly of cut&amp;pasted crypto implementations, including manually unrolled assembly code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/761970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 15:16 UTC (Tue)
                               by <b>zx2c4</b> (subscriber, #82519)
                              [<a href="/Articles/762024/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's a bit more than cut&amp;paste -- we worked on that assembly quite a bit. But indeed the vast majority of the patch is optimized assembly, which tends to be, well, long.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762115"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 8, 2018 18:06 UTC (Wed)
                               by <b>lbt</b> (subscriber, #29672)
                              [<a href="/Articles/762115/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does that assembly cover a variety of architectures?<br>
Is there fallback to C?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762115/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762119"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 8, 2018 18:25 UTC (Wed)
                               by <b>zx2c4</b> (subscriber, #82519)
                              [<a href="/Articles/762119/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes and yes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762119/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor762041"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2018 19:03 UTC (Tue)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/762041/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I did some work on the kernel IPsec code in the past (added a few features needed for a particular product) and compared to other parts of the kernel I've also worked on, eg, the AF_UNIX socket implementation or some of the USB code, I didn't think it was that  bad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762041/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762077"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 8, 2018 14:14 UTC (Wed)
                               by <b>storner</b> (subscriber, #119)
                              [<a href="/Articles/762077/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From my understanding there is not so much criticism of the kernel IPSec implementation. It is the entire design of the IPSec specifications that is seen as "wrong", in the sense that they are overly complex, difficult to understand and implement, and implementations are - for all practical purposes - impossible to review for security issues.<br>
<p>
And since IPSec was designed many moons ago, it also carries a lot of cruft - but you cannot dump it because that would break interoperability between implementations.<br>
<p>
Wireguard is a fresh start on designing a VPN. Sometimes the best solution really is to start from scratch.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762077/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 8, 2018 17:26 UTC (Wed)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/762106/">Link</a>] 
      </p>
      
      </div>
      </summary>
      There's a Linus Torvalds quote in the text:

<blockquote>
Maybe the code isn't perfect, but I've skimmed it, and compared to the horrors that are OpenVPN and IPSec, it's a work of art. 
</blockquote>

I can't comment on OpenVPN but I can comment on the Linux IPsec implementation and this comment would be "This is a reasonably organized and well-structured piece of code I could understand and change [to suit some specifc needs, eg, migrating IPv4-based IPsec SAs etc to different IPs/ ports if a client address changes] fairly easily". The kernel does contain much worse things, examples I'm somewhat familiar with (due to other work) are UNIX domain sockets and the USB handling code.
<p/>
I also don't think the "the IPsec-specifications" are overly complex and difficult to understand but I admit that I've been working on a proprietary fork of an open source IKE implementation for years which might have helped here. But that's a different conversation.
      
          <div class="CommentReplyButton">
            <form action="/Articles/762106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor762143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 0:32 UTC (Thu)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/762143/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I actually strongly dislike the Linux implementation. I have never looked at the code, but the fact that the encapsulated and plaintext packets are on the same interface makes using Wireshark or any other packet capture tool miserable. And getting firewall rules right is interesting at best.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762148"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 4:20 UTC (Thu)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/762148/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's been a while for me, but I recall that IPsec packets have protocol 50 while UDP is 17 if you want to separate them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762148/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 12:28 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/762175/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's usually not going to help because one will usually encounter ESP in UDP encapsulation so that NAT-T is possible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 17:18 UTC (Thu)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/762232/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When I used to run IPsec it was at the border gateways, so I never had to use UDP encapsulation. That would make it trickier I suppose.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor762177"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 12:47 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/762177/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Encapsulated datagrams either use IP protocol 50 or UDP and port 4500, filtering to exclude them or to look exclusivey at them is not more difficult than excluding ARP, SSH and STP and whatever other uninteresting/ noise traffic happens to appear on some interface.<br>
What's more of an actual problem is that decapsulated reply traffic usually isn't visible in tcpdump output (it's entirely conceivable that I just don't know how to make it visible).<br>
<p>
But I was still making a statement about the code, so why did your "I want to talk about something entirely different" text get attached to that?<br>
<p>
Linux IPsec also supports so-called "route-based VPNs", BTW.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762177/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 14:54 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/762222/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Minor error in here: "Decapsulated reply traffic" make no sense.<br>
<p>
Assuming there's a VPN server to which clients connect which utilizes some internal network 'through' a set of ESP tunnels and also acts as NAT gateway to the outside world for clients, the ESP/ ESP-in-UDP traffic, the incoming traffic on the internal network and the incoming and outgoing traffic from the external address of the gateway can be captured but not the reply traffic on the internal network (logically) originating from the internal address of the gateway and destined for the internal address of some client as that's transformed according to the rules in the SPD before anything outside gets a chance to look at it (AIUI).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor762932"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 18, 2018 8:40 UTC (Sat)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/762932/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a rel="nofollow" href="https://commons.wikimedia.org/wiki/File:Netfilter-packet-flow.svg">https://commons.wikimedia.org/wiki/File:Netfilter-packet-...</a> has a (packet filter centric) view of the things that roughly happen. If you draw the crypto loop openvpn-style between "interface output" (tun0) and "local process" (other side of tun0) instead, then there are a handful of diagram boxes that necessarily get an additional execution before your packet leaves out eth0. And some people just wanted to do without that performance reduction when KLIPS/tun was replaced with Netkey IPsec/xfrm.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762932/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor762933"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel IPsec implementation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 18, 2018 9:03 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/762933/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is not unique for Wireguard. IPSec works in exactly the same way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762933/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor762262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2018 20:50 UTC (Thu)
                               by <b>lnnuser21821</b> (guest, #126296)
                              [<a href="/Articles/762262/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Remind me why the kernel needs a crypto library instead of just having it in userspace again?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762295"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2018 7:41 UTC (Fri)
                               by <b>ndesaulniers</b> (subscriber, #110768)
                              [<a href="/Articles/762295/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Remind me why we have a monolithic kernel and not a microkernel?"<br>
<p>
Networking subsystem and file systems absolutely can be moved to userspace.  Userspace can than link against 9 different implementations and versions all with different bugs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762295/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762308"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2018 12:46 UTC (Fri)
                               by <b>lnnuser21821</b> (guest, #126296)
                              [<a href="/Articles/762308/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Look, I don't mean to start a holy war, but the kernel should still be moving in that direction. To anyone not blinded by sunk cost fallacy, keeping the kernel as small as it can get is what we should be looking for, not extending potential for more privilege escalations. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762308/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762353"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2018 20:15 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/762353/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you're going to have file systems and networking in the kernel _at_all_, then putting the encryption for those into the kernel is a requirement.<br>
<p>
If you want a micro-kernel then build a micro-kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762353/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762972"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 16:16 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/762972/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not sure what you mean by "build" but I believe there is a number of micro kernels already, some of them commercially successful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762972/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor762956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 18, 2018 23:12 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/762956/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; keeping the kernel as small as it can get</font><br>
<p>
To anyone not blinded by theory, keeping the kernel as FAST as it can get is a priority. This is actively hindered by theoreticians fixated on micro-kernels.<br>
<p>
(NB - I said *a* priority, not *the* priority. In engineering, everything is a trade-off and small may not be beautiful at all ...)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 4:02 UTC (Sun)
                               by <b>mgb</b> (guest, #3226)
                              [<a href="/Articles/762957/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; To anyone not blinded by theory, keeping the kernel as FAST as it can get is a priority. This is actively hindered by theoreticians fixated on micro-kernels.</font><br>
<p>
For many applications security is more important than performance.<br>
<p>
For many applications a major increase in kernel performance results in only in minuscule improvement in overall performance.<br>
<p>
For the same amount of effort a smaller kernel is likely to be more secure than a larger kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor762958"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 4:08 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/762958/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Microkernels are not inherently more secure.<br>
<p>
For example, you move networking out of the kernel space. Now if somebody compromises the IPSec parser, your kernel will survive unscathed. Of course, all your network traffic will now be compromised but who cares? After all, there's not much an attacker can do if they control all the traffic, including domain sockets possibly used to send secure messages.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762958/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762959"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 7:12 UTC (Sun)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/762959/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Eh they're not able to escalate that into something that modifies the on-disk bootloader such that the compromise survives reboots<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762959/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 7:35 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/762961/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But they'll be able to modify the DNS traffic and/or mount MITM attacks. Never mind good old sniffing. If this happens on a web-server then it's actually probably enough by itself.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762962"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 7:51 UTC (Sun)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/762962/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It depends on what your threat is. Full control of network traffic is certainly bad, but doesn't necessarily break assumptions. Being able to compromise the entire kernel does.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762962/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor762971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">WireGuarding the mainline</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2018 16:04 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/762971/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://en.m.wikipedia.org/wiki/Defense_in_depth_">https://en.m.wikipedia.org/wiki/Defense_in_depth_</a>(computing)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
