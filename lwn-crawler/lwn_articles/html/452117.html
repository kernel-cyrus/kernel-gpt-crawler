        <!DOCTYPE html>
        <html lang="en">
        <head><title>How to ruin Linus's vacation [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/452117/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/451698/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/452117/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>How to ruin Linus's vacation</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 19, 2011</br>
           </div>
It's all Hugh's fault.
<p>
Linus was all set to release the final 3.0 kernel  when Hugh Dickins showed
up on the list with <a href="/Articles/452118/">a little problem</a>:
occasionally a full copy of the kernel source tree fails because one of the
files found therein vanishes temporarily.  What followed was a determined
bug-chasing exercise which demonstrates how subtle and tricky some of our
core code has become.  The problem has been found and squashed, but there
may be more.
<p>
A bit of background might help in understanding what was happening here.
The 2.6.38 release included the <a href="/Articles/419811/">dcache
scalability patches</a>; this code uses a number of tricks to avoid taking
locks during the process of looking up file names.  For the right kind of
workload, the "RCU walk" method yields impressive performance improvements.
But that only works if all of the relevant directory entry ("dentry")
structures are in the kernel's dentry cache and the lookup process does not
race with other CPUs which may be making changes on the same path.
Whenever such a situation is encountered, the lookup process will fall back
to the older, slower algorithm which requires locking each dentry.
<p>
The dentry cache (dcache) is a highly dynamic data structure, with dentries
coming and going at all times.  So one CPU might be removing a dentry at
the same time that another is using it to look up a name.  Chaos is avoided
through the use of read-copy-update (RCU) to manage the removal of dentries; a
dentry may be removed from the cache, but, if the thread using that dentry
for lookup got a reference to it before its removal, the structure itself will
continue to exist for as long as that thread needs it.  The same should be
true of the inode structure associated with that dentry.
<p>
Hugh tracked the problem down to a bit of code in
<tt>walk_component()</tt>:
<p>
<pre>
	err = do_lookup(nd, name, path, &amp;inode);
	/* ... */
	if (!inode) {
		path_to_nameidata(path, nd);
		terminate_walk(nd);
		return -ENOENT;
	}
</pre>
<p>
If <tt>do_lookup()</tt> returns a null inode pointer,
<tt>walk_component()</tt> assumes that a "negative dentry" has been
encountered.  Negative dentries are kept in the dentry cache to record the
fact that a specific name does
<i>not</i> exist; they are an important performance-enhancing feature in
the Linux virtual filesystem layer.  To see an example, run any simple
program under <tt>strace</tt> and watch how many system calls return with
ENOENT; lookups on nonexistent files happen frequently.  What Hugh
determined was that this inode pointer was coming back null even though the
file exists, leading the code to believe that a negative dentry had been
found and causing the "briefly vanishing file" problem.
<p>
Hugh must have looked at this code for some time before concluding that the
kernel must be removing the dentry from the dcache at just the wrong time
during the lookup process.  As described above, the dentry itself continues
to exist after its removal from the cache, but that does not mean that it
is unchanged:  the removal process sets its <tt>d_inode</tt> pointer to
<tt>NULL</tt>.  (It's worth noting that this behavior goes against normal
RCU practice, which calls for the structure to be preserved unmodified
until the last reference is known to be gone).
Hugh concluded that this null pointer was being picked up
later by the lookup process, causing <tt>walk_component()</tt>
to conclude that the file does not exist when all that had happened was the
removal of a dentry from the cache.  His problem report included a patch
causing the lookup code to check much more carefully when the inode pointer
comes up null.
<p>
Linus <a href="/Articles/452128/">acknowledged the problem</a> but didn't
like the fix which, he thought, was too specific to one particular
situation.  He proposed an alternative: just don't set <tt>d_inode</tt> to
<tt>NULL</tt>; that would keep the inode pointer from picking up that value
later.  Al Viro posted <a href="/Articles/452131/">an alternative
fix</a> which changed dcache behavior in less subtle ways, and <a
href="/Articles/452134/">worried</a> about the possibility of introducing
other weird bugs:
<p>
<div class="BigQuote">
	 I'm not entirely convinced that it's a valid optimization in the
	 first place (probably is, but I'm seriously scared by the
	 complexity we already have there), and I'm really not fond of the
	 idea of dealing with whatever subtle crap we might discover with
	 Linus' patch.  Again, dcache is not in a healthy shape right now;
	 at this point dumb and straightforward is, IMO, better than subtle
	 and risking to step on toes of very odd code out there...
<p>
	 Once we are done with code audit, sure, I'm fine with -&gt;d_inode
	 being kept until dentry is actually freed.  Any code that relies
	 on that thing being cleared is asking for trouble and should be
	 rewritten anyway.  The only thing is, it needs to be found before
	 we rewrite it...
</div>
<p>
Linus didn't like Al's fix either; it threatened to force slow lookups when
negative dentries are involved. 
The discussion of the patches went on at some length; in the process of
trying to find the safest way to fix this subtle bug the participants slowly
came to the realization that they did not actually know what was
happening.  After looking at things closely, Linus <a
href="/Articles/452136/">threw up his hands</a> and admitted he didn't
understand it:
<p>
<div class="BigQuote">
	So how could Hugh's NULL inode ever happen in the first place? Even
	with the current sources? It all looks solid to me now that I look
	at all the details.
</div>
<p>
As it happens, Linus's exposition was enough to point Hugh at the real
problem.  Just as the process of transiting through a specific dentry is
almost complete, <tt>do_lookup()</tt> makes a call to
<tt>__follow_mount_rcu()</tt>, whose job is to redirect the lookup process
if it is passing through a mount point.  The inode pointer is passed to
<tt>__follow_mount_rcu()</tt> separately; Hugh noticed that this function
was doing the following:
<p>
<pre>
	*inode = path-&gt;dentry-&gt;d_inode;
</pre>
<p>
In other words, the inode pointer is being re-fetched from the dentry
structure; this assignment happens regardless of whether the dentry
represents a mount point.
That is the true source of the
problem:  if the dentry has been removed from the dcache after the lookup
process gained a reference, <tt>d_inode</tt> will be <tt>NULL</tt>.  So
<tt>__follow_mount_rcu()</tt> will zero a pointer which had pointed to a
valid inode, causing later code to think that the file does not exist at
all.
<p>
Linus posted <a href="/Articles/452138/">a fix for the real problem</a>
along with his <a
href="https://plus.google.com/102150693225130002912/posts/2BXkWyrY4jH">now-famous
Google+ posting</a> saying that he was delaying the 3.0 release for a day
just in case:
<p>
<div class="BigQuote">
	We have a patch, we understand the problem, and it looks
	ObviouslyCorrect(tm), but I don't think I want to release 3.0 just
	a couple of hours after applying it.
</div>
<p>
Linus delayed the release despite <a href="/Articles/452145/">the
inconvenient fact</a> that it will push the 3.1 merge window into his
planned vacation.  That was a well-placed bit of caution on his part: the
ObviouslyCorrect(tm) patch had <a
href="/Articles/452141/">YetAnotherSubtleBug(tm) in it</a>.  A fixed
version of the patch exists, and this particular bug should, at this point,
be history.
<p>
There is a sobering conclusion to be drawn from this episode, though.  The
behavior of the dentry cache is, at this point, so subtle that even the
combined brainpower of developers like Linus, Al, and Hugh has a hard time
figuring out what is going on.  These same developers are visibly nervous
about making changes in that part of the kernel.  Our once approachable and
hackable kernel has, over time, become more complex and difficult to
understand.  Much of that is unavoidable; the environment the kernel runs
in has, itself, become much more complex over the last 20 years.  But if we
reach a point where almost nobody can understand, review, or fix some of
our core code, we may be headed for long-term trouble.
<p>
Meanwhile, we should be able to enjoy a 3.0 release (and a 2.6.39 update)
without mysteriously vanishing files.  One potential short-term problem
remains, though: given that the next merge window will push into Linus's
vacation, there is a distinct chance that he might be more than usually
grumpy with maintainers who get their pull requests in late.  Wise
subsystem maintainers may want to be ready to go when the merge window
opens.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Dentry_cache">Dentry cache</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/452117/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor452186"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 20:00 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/452186/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The behavior of the dentry cache is, at this point, so subtle that even the combined brainpower of developers like Linus, Al, and Hugh has a hard time figuring out what is going on. [...] But if we reach a point where almost nobody can understand, review, or fix some of our core code, we may be headed for long-term trouble.</font><br>
<p>
I wonder if we are reaching the point where we would need to write formal proofs for parts of the kernel code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452186/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452192"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 20:48 UTC (Tue)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/452192/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unfortunately, any VFS operation needs to be formally described not as in "X happens", but as in "there is an arbitrarily complex state Y which is transformed into the almost-identical state Y', and the only relevant difference between Y and Y' is X". (There may be non-relevant differences, e.g. cache state.)<br>
<p>
Add in the fact that the kernel is reentrant (formal descriptions for concurrent processes? Dream on) and has the aforementioned caching and RCU and whatnot (so for each file there are multiple valid pre- and postconditions), and you're in for a _real_ treat.<br>
<p>
I very much doubt that anybody can manage this for any specific non-trivial testcase, much less in general.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452192/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2011 3:24 UTC (Wed)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/452240/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Well, it's also true that you can't write purely "formal" proofs for most mathematical theorems.  And yet, mathematics gets done, because people can write perfectly good proofs in ordinary language.

<p>And in fact anyone that writes non-trivial code probably does form in their head at least a hand-wavy proof of its correctness.  If those actually got written down, it would probably help clarify thinking and avoid some bugs.  But that doesn't happen for the same reason that nobody writes documentation.

<p>An example of an exception: <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux.git;a=blob;f=Documentation/filesystems/directory-locking;h=ff7b611abf330d11b8a5aef416e06106a39abbca;hb=3a5c3743f15f27237ab025736a981e2d0c9fdfed">Documentation/filesystems/directory-locking</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/452240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2011 4:05 UTC (Wed)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/452243/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, well... you forgot to add "and actually read" to conditions...  Exhibit A: people adding hardlinks to directories or equivalents thereof, despite the aforementioned example of documentation ;-/<br>
<p>
We do need such writeups, of course.  If nothing else, writing them tends to find holes - see e.g. -&gt;d_lock mess discussion on fsdevel lately.  There the locking order had been fscked in head (not transitive, for one thing), but locks outside of that set had mostly avoided bad trouble.  Trying to write the proof of correctness hadn't been fun (and what I've got still relies on unverified assumptions about the things filesystem code does not do; verifying those has already caught a bunch of really broken things), but it helped to catch rather nasty stuff.  Simply by reasoning about the properties of counterexample - i.e. "what would a deadlock have to look like".  It's math, like any other...<br>
<p>
FWIW, I wonder what backgrounds people have - in my case, it's geometry and topology and _that_ has certainly helped to acquire many mental habits useful for that kind of work...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2011 23:02 UTC (Wed)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/452336/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Yeah.  Especially for CS students, something like the classic first point-set topology course might give good experience with that kind of proof-or-counterexample mode of problem solving.  I think that's rare, unfortunately, at least outside a few countries with very rigorous math programs?

<p>(Like some others, I'm a refugee from mathematics, coming late to this after getting a PhD (commutative algebra and some algebraic topology).  Not a particularly smart career path, but fun in its own way.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/452336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor452507"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2011 23:34 UTC (Thu)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/452507/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <i>"there is an arbitrarily complex state Y which is transformed into the almost-identical state Y', and the only relevant difference between Y and Y' is X"</i><p>
That sounds like the AI Frame Problem.

      
          <div class="CommentReplyButton">
            <form action="/Articles/452507/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor452197"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 20:54 UTC (Tue)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/452197/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure about complete proofs, but we do need better tools for testing certain assertions with respect to race conditions.<br>
<p>
It happens frequently that a cache introduced for performance actually contains some race condition. One way of checking this is to make the cache throw away entries almost immediately, this has a way of stress testing certain failure modes. I wonder if that would have helped here.<br>
<p>
In any case, testing assertions in the face of race conditions is something we could all use. There is software proving software that tries but the false positive rate is still too high. I truly hope that in the future we will have good tools for this, because complexity is only getting worse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452197/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452219"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 23:03 UTC (Tue)
                               by <b>Ben_P</b> (guest, #74247)
                              [<a href="/Articles/452219/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's also important to note than when working in languages with the freedom that C gives you, determining accurate life times and reference counts can be hellish if very strict coding conventions are not adhered to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452219/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor452205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 21:57 UTC (Tue)
                               by <b>tshow</b> (subscriber, #6411)
                              [<a href="/Articles/452205/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The trouble with formal proofs is that the logical errors and bad assumptions made when writing the code tend to be propagated into the formal proofs, where they typically remain equally unnoticed.  Or worse, the proof is fine, but the code deviates in subtle ways due to abstraction mismatches and model simplification.<br>
<p>
At least as I understand the state of the art in formal code proofs, the only place they work is places where they aren't particularly useful; places where things like timing, instruction reordering, hardware errors and concurrency are not considerations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor452207"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 22:13 UTC (Tue)
                               by <b>smoogen</b> (subscriber, #97)
                              [<a href="/Articles/452207/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder if this is anything related to a set of "crashes" I have had with the 3.0.0 kernels (the 2.6.39 works fine so maybe not)<br>
<p>
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=722472">https://bugzilla.redhat.com/show_bug.cgi?id=722472</a><br>
<p>
I noticed that at least in rc7 it came out with a new error message versus slowing down until the deadlock indicator starts spewing "hard-locks"<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452207/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor453236"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2011 17:12 UTC (Thu)
                               by <b>pebolle</b> (guest, #35204)
                              [<a href="/Articles/453236/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, it's not related. That bug has to do - as far as I can tell right now - with lockdep noticing there's recursive locking going on but not being told that this is a case of expected nested locking. Well, I think the nesting is expected ...<br>
<p>
Anyhow, the message lockdep prints, includes the neat line:<br>
    *** DEADLOCK ***<br>
<p>
It took me a few days before I noticed that the kernel actually still was running quite OK after that disturbing message.<br>
<p>
By the way, the reason you ran into this recently seems to be that systemd-30 is (apparently) the first program in wide use that triggers this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/453236/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor452209"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 22:22 UTC (Tue)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/452209/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While reading the article I had this quote in my mind all the time:<br>
<p>
"Debugging is twice as hard as writing the code in the first place. Therefore, if you write the code as cleverly as possible, you are, by definition, not smart enough to debug it."<br>
<p>
         Brian W. Kernighan and P. J. Plauger in The Elements of Programming Style.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452209/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452210"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 22:33 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/452210/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, it is a great quote.  But experience shows that it is wrong ... so where is the flaw?<br>
<p>
I think the reality is that writing really clever code actually makes you smarter - by solving a difficult problem you can learn something useful.  So having written (or just read and understood) really clever code, you become smart enough to at least make an attempt at debugging it.<br>
<p>
Maybe.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452210/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452217"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 22:55 UTC (Tue)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/452217/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe. But when you find yourself hunting that bug that makes no sense, you should question if you were as clever as you thought when writing the code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452217/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452231"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2011 0:26 UTC (Wed)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/452231/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have a lot of experience hunting bugs that make no sense, sometimes in my own code and sometimes in other people's.  I usually find it harder to find those bugs in my own code, and it certainly isn't because my code is particularly "clever".<br>
<p>
The common pattern that I find in "bugs that make no sense" is that I am believing something that isn't true.  Once I identify and challenge that belief, the bug becomes obvious.  The reason that these bugs are harder to find in my own code is because I believe my code is correct (in general, and in lots of specifics), so I don't question it so closely.  When I'm reading other people's code I have less belief that it is correct, so less hindrance to finding the bugs.<br>
<p>
Put another way: finding a bug in my code is both a success and an admission of failure.  Finding a bug in someone else's code is pure success.  This sounds like a strong case for pair-programming!<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452231/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452237"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2011 2:25 UTC (Wed)
                               by <b>elanthis</b> (guest, #6227)
                              [<a href="/Articles/452237/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is the same reason why authors of prose have editors.  Your internalized assumptions make it so your eyes can pass right over "obviously" bad constructs and not notice.<br>
<p>
It's also why "check your assumptions" is the first rule of debugging I teach to new coders.  :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452237/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452238"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2011 2:44 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/452238/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed.<br>
<p>
This is also why I find debugging with print and assert statements to be much more helpful than single stepping, in the vast majority of cases.  Single stepping was more useful to me when I didn't necessarily understand all the language constructs.  That was 20-25 years ago, though.<br>
<p>
Nowadays, if I have some weird bug, it's because something I think is true is not, or some other "invisible-to-me" error.  A judiciously placed print statement (perhaps guarded by an 'if' to filter out the noise) makes it easy for me to prove or disprove my assumptions about what's happening in the code, though, without disrupting any of the code around it.  I can compare working cases to non-working cases easily and in a batch-wise manner after the fact.  Very useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452238/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor452464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2011 19:19 UTC (Thu)
                               by <b>nas</b> (subscriber, #17)
                              [<a href="/Articles/452464/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is way the "Rubber Duckie Test" is effective.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452634"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2011 19:58 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/452634/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMHO you mean "This is *why ".<br>
<p>
Please enlighten us what this test means; not everybody is damiliar with the idiom.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452634/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2011 9:45 UTC (Sat)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/452672/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
*familiar. *grumble*<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452709"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2011 21:38 UTC (Sat)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/452709/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hadn't heard of it either .. but search engines are our friends.<br>
<p>
<a href="http://lmgtfy.com/?q=Rubber+Duckie+Test">http://lmgtfy.com/?q=Rubber+Duckie+Test</a><br>
<p>
Pick the wikipedia link on Rubber Duck Debugging.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452709/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2011 18:08 UTC (Mon)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/452841/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just knew the "janitor effect".<br>
<p>
I presume the name comes from working late because you can not figure out a problem. Then the janitor comes and he can sees you are kind of frustrated and asks what the problem is.<br>
<p>
You try to explain it to the janitor in simple terms and then you understand your problem and can fix it.<br>
<p>
Then you go home happy I guess.<br>
<p>
The ducky is just a way to try and induce that state of mind with an inanimate object where you are trying to explain the problem to someone else in simple terms.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor452367"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2011 8:34 UTC (Thu)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/452367/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have another quote for you:<br>
<p>
"Oh Lord it's hard to be humble<br>
when you're perfect in every way.<br>
I can't wait to look in the mirror<br>
cause I get better looking each day.<br>
To know me is to love me<br>
I must be a hell of a man.<br>
Oh Lord it's hard to be humble<br>
but I'm doing the best that I can."<br>
<p>
-- Mac Davis<br>
<p>
;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452367/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor452211"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's patch</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 23:18 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/452211/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm trying to understand Linus' patch.<br>
<p>
Moving the assignment to *inode from the start to the end makes lots of sense.<br>
<p>
The other mucking about with seqcount doesn't make any sense to me at all.<br>
<p>
What exactly is the read_seqcount_retry on path-&gt;dentry-&gt;d_seq trying to protect?  That dentry is the mounted-on dentry so it is pinned and cannot be renamed or deleted.<br>
<p>
About the only thing I can think of that might need to be protected against at this point is the mount being unmounted - but if that were the goal of the code I would have expected a comment to that effect, and it doesn't seem like the right place for it anyway..<br>
<p>
Any ideas?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452211/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's patch</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2011 23:47 UTC (Tue)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/452227/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, you are right - the check is BUG_ON() misspelled.  umount *can't* happen<br>
at that point - we are holding vfsmount_lock all the way through RCU<br>
walk.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor452783"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2011 8:57 UTC (Mon)
                               by <b>mlankhorst</b> (subscriber, #52260)
                              [<a href="/Articles/452783/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It's all Hugh's fault. </font><br>
Blame the messenger, not the person who originally introduced the bug?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452783/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor452812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to ruin Linus's vacation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2011 16:23 UTC (Mon)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/452812/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It was obviously a joke.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/452812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2011, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
