        <!DOCTYPE html>
        <html lang="en">
        <head><title>That massive filesystem thread [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/326471/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/325485/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/326471/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>That massive filesystem thread</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 31, 2009</br>
           </div>
Long, highly-technical, and animated discussion threads are certainly not
unheard of on the linux-kernel mailing list.  Even by linux-kernel
standards, though, <a
href="http://news.gmane.org/group/gmane.linux.kernel/thread=811167/force_load=t">the
thread that followed the 2.6.29 announcement</a> was impressive.  Over the
course of hundreds of messages, kernel developers argued about several
aspects of how filesystems and block I/O work on contemporary Linux
systems.  In the end (your editor will be optimistic and say that it has
mostly ended), we had a lot of heat - and some useful, concrete results.
<p>

One can only pity Jesper Krogh, who almost certainly didn't know what he
was getting into when he posted <a href="/Articles/326490/">a report</a> of
a process which had been hung up waiting for disk I/O for several minutes.
All he was hoping for was a suggestion on how to avoid these kinds of
delays - which are a manifestation of the famous ext3 <tt>fsync()</tt>
problem - on his server.  What he got, instead, was to be copied on the
entire discussion.
<p>
<h3>Journaling priority</h3>
<p>
One of the problems is at least somewhat understood: a call to
<tt>fsync()</tt> on an ext3 filesystem will force the filesystem journal
(and related file data) to
be committed to disk.  That operation can create a lot of write activity
which must be waited for.  But contemporary I/O schedulers tend to
favor read operations over writes.  Most of the time, that is a rational
choice: there is usually a process waiting for a read to complete, but
writes can be done asynchronously.  A journal commit is not asynchronous,
though, and it can cause a lot of things to wait while it is in progress.
So it would be better not to put journal I/O operations at the end of the
queue.
<p>
In fact, it would be better not to make journal operations contend with the
rest of the system at all.  To that end, Arjan van de Ven has long
maintained <a href="http://lwn.net/Articles/301467/">a simple patch</a>
which gives the <tt>kjournald</tt> thread realtime I/O priority.  <a
href="/Articles/326492/">According to Alan Cox</a>, this patch alone is
sufficient to make a lot of the problems go away.  The patch has never made
it into the mainline, though, because <a href="/Articles/326494/">Andrew
Morton has blocked it</a>.  This patch, he says, does not address the real
problem, and it causes a lot of unrelated I/O traffic to benefit from
elevated priority as well.  Andrew says the real fix is harder:
<p>
<div class="BigQuote">
	The bottom line is that someone needs to do some serious rooting
	through the very heart of JBD transaction logic and nobody has yet
	put their hand up.  If we do that, and it turns out to be just too
	hard to fix then yes, perhaps that's the time to start looking at
	palliative bandaids.
</div>
<p>
Bandaid or not, this approach has its adherents.  The ext4 filesystem has a
new mount option (<tt>journal_ioprio</tt>) which can be used to set the I/O
priority for journaling operations; it defaults to something higher than
normal (but not realtime).  More recently, Ted Ts'o has posted <a
href="http://lwn.net/Articles/324822/">a series of ext3 patches</a> which
sets the <tt>WRITE_SYNC</tt> flag on some journal writes.  That flag marks
the operations as synchronous, which will keep them from being blocked by a
long series of read operations.  According to Ted, this change helps quite
a bit, at least when there is a lot of read activity going on.  The ext3
changes have not yet been merged for 2.6.30 as of this writing (none of
Ted's trees have), but chances are they will go in before 2.6.30-rc1.

<p>
<h3>data=ordered, fsync(), and fbarrier()</h3>
<p>
The real problem, though, according to Ted, is the ext3
<tt>data=ordered</tt> mode.  That is the mode which makes ext3 relatively
robust in the face of crashes, but, says Ted, it has done so at the cost of
performance and the encouragement of poor user-space programming.  He went
so far as to <a href="/Articles/326503/">express his regrets</a> for
this behavior:
<p>
<div class="BigQuote">
	All I can do is apologize to all other filesystem developers
	profusely for ext3's data=ordered semantics; at this point, I very
	much regret that we made data=ordered the default for ext3.  But
	the application writers vastly outnumber us, and realistically
	we're not going to be able to easily roll back eight years of
	application writers being trained that fsync() is not necessary,
	and actually is detrimental for ext3.
</div>
<p>
The only problem here is that not everybody believes that ext3's behavior
is a bad thing - at least, with regard to robustness.  Much of this branch
of the discussion covered the same issues raised by LWN in <a
href="http://lwn.net/Articles/323752/">Better than POSIX?</a> a couple of
weeks before.  A significant subset of developers do not want the
additional robustness provided by ext3 <tt>data=ordered</tt> mode to go
away.  Matthew Garrett <a href="/Articles/326504/">expressed this position
well</a>:
<p>
<div class="BigQuote">
	But you're still arguing that applications should start using
	fsync().  I'm arguing that not only is this pointless (most of this
	code will never be "fixed") but it's also regressive. In most cases
	applications don't want the guarantees that fsync() makes, and
	given that we're going to have people running on ext3 for years to
	come they also don't want the performance hit that fsync()
	brings. Filesystems should just do the right thing, rather than
	losing people's data and then claiming that it's fine because POSIX
	said they could.
</div>
<p>
One option which came up a couple of times was to extend POSIX with a new
system call (called something like <tt>fbarrier()</tt>) which would enforce
ordering between filesystem operations.  A call to <tt>fbarrier()</tt>
could, for example, cause the data written to a new file to be forced out
to disk before that file could be renamed on top of another file.  The idea
has some appeal, but <a href="/Articles/326505/">Linus dislikes it</a>:
<p>
<div class="BigQuote">
	Anybody who wants more complex and subtle filesystem interfaces is
	just crazy. Not only will they never get used, they'll definitely
	not be stable...
	<p>
	So rather than come up with new barriers that nobody will use,
	filesystem people should aim to make "badly written" code "just
	work" unless people are really really unlucky. Because like it or
	not, that's what 99% of all code is.
</div>
<p>
And that is almost certainly how things will have to work.  In the end, a
system which just works is the system that people will want to use.
<p>
<h3>relatime</h3>
<p>

Meanwhile, another branch of the conversation revisited <a
href="http://lwn.net/Articles/244829/">an old topic</a>: atime 
updates.  Unix-style filesystems traditionally track the time that each
file was last accessed ("atime"), even though, in reality, there is very
little use for this information.  Tracking atime is a performance problem,
in that it turns every read operation into a filesystem write as well.  For
this reason, Linux has long had a "noatime" mount option which would
disable atime updates on the indicated filesystem.
<p>
As it happens, though, there can be problems with disabling atime
entirely.  One of them is that the <tt>mutt</tt> mail client uses atime to
determine whether there is new mail in a mailbox.  If the time of last
access is prior to the time of last modification, <tt>mutt</tt> knows that
mail has been delivered into that mailbox since the owner last looked at
it.  Disabling atime breaks this mechanism.  In response to this problem, 
the kernel added a "relatime" option which causes atime to be updated only
if the previous value is earlier than the modification time.  The relatime
option makes <tt>mutt</tt> work, but it, too, turns out to be insufficient:
some distributions have temporary-directory cleaning programs which delete
anything which hasn't been used for a sufficiently long period.  With
relatime, files can appear to be totally unused, even if they are read
frequently.
<p>
If relatime could be made to work, the benefits could be significant; the
elimination of atime updates can get rid of a lot of writes to the disk.
That, in turn, will reduce latencies for more useful traffic and will also
help to avoid disk spin-ups on laptops.  To that end, Matthew Garrett
posted a patch to modify the relatime semantics slightly: it allows atime
to be updated if the previous value is more than one day in the past.  This
approach eliminates almost all atime updates while still keeping the value
close to current.
<p>
This patch was proposed for merging, and more: it was suggested that
relatime should be made the default mode for filesystems mounted under
Linux.  Anybody wanting the traditional atime behavior would have to mount
their filesystems with the new "strictatime" mount option.  This idea ran
into some immediate opposition, for a couple of reasons.  Andrew Morton <a
href="/Articles/326508/">didn't like the hardwired 24-hour value</a>,
saying, instead, that the update period should be given as a mount option.
This option would be easy enough to implement, but few people think there
is any reason to do so; it's hard to imagine a use case which requires any
degree of control over the granularity of atime updates.
<p>
Alan Cox, instead, <a href="/Articles/326509/">objected</a> to the patch as
an ABI change and a standards violation.  He tried to "NAK" the patch,
saying that, instead, this sort of change should be done by distributors.
Linus, however, <a href="/Articles/326511/">said he doesn't care</a>; the
relatime change and strictatime option were the very first things he merged
when he opened the 2.6.30 merge window.  His position is that the
distributors have had more than a year to make this change, and they
haven't done so.  So the best thing to do, he says, is to change the
default in the kernel and let people use strictatime if they really need
that behavior.
<p>
For the curious, Valerie Aurora has <a
href="http://valhenson.livejournal.com/36519.html">written a detailed
article</a> about this change.  She doesn't think that the patch will
survive in its current form; your editor, though, does not see a whole lot
of pressure for change at this point.
<p>

<h3>I/O barriers</h3>
<p>

Suppose you are a diligent application developer who codes proper
<tt>fsync()</tt> calls where they are necessary.  You might think that you
are then protected against data loss in the face of a crash.  But there is
still a potential problem: the disk drive may lie to the operating system
about having written the data to persistent media.  Contemporary hardware
performs aggressive caching of operations to improve performance; this
caching will make a system run faster, but at the cost of adding another
way for data to get lost.
<p>
There is, of course, a way to tell a drive to actually write data to
persistent media.  The block layer has long had support for barrier
operations, which cause data to be flushed to disk before more operations
can be initiated.  But the ext3 filesystem does not use barriers by default
because there is an associated performance penalty.  With ext4, instead,
barriers are on by default.
<p>
Jeff Garzik <a href="/Articles/326513/">pointed out</a> one associated
problem: a call to <tt>fsync()</tt> does not necessarily cause the drive to
flush data to the physical media.  He suggested that <tt>fsync()</tt>
should create a barrier, even if the filesystem as a whole is not using
barriers.  In that way, he says, <tt>fsync()</tt> might actually live up to
the promise that it is making to application developers.
<p>
The idea was not controversial, even though people are, as a whole, less
concerned with caches inside disk drives.  Those caches tend to be 
short-lived, and they are quite likely to be written even if the operating
system crashes or some other component of the system fails.  So the chances
of data loss at that level are much smaller than they are with data in an
operating system cache.  Still, it's possible to provide a higher-level
guarantee, so Fernando Luis Vazquez Cao posted <a
href="/Articles/326514/">a series of patches</a> to add barriers to
<tt>fsync()</tt> calls.  And that is when the trouble started.
<p>
The fundamental disagreement here is over what should happen when an
attempt to send a flush operation to the device fails.  Fernando's patch
returned an <tt>ENOTSUPP</tt> error to the caller, but Linus <a
href="/Articles/326515/">asked for it to be removed</a>.  His position is
that there is nothing that the caller can do about a failed barrier
operation anyway, so there is no real reason to propagate that error
upward.  At most, the system should set a flag noting that the device
doesn't support barriers.  But, says Linus, filesystems should cope with
what the storage device provides.
<p>
Ric Wheeler, instead, <a href="/Articles/326517/">argues</a> that
filesystems should know if barrier operations are not working and be able
to respond accordingly.  Says Ric:
<p>
<div class="BigQuote">
	One thing the caller could do is to disable the write cache on the
	device. A second would be to stop using the transactions - skip the
	journal, just go back to ext2 mode or BSD like soft updates.
<p>
	Basically, it lets the file system know that its data integrity
	building blocks are not really there and allows it (if it cares) to
	try and minimize the chance of data loss.
</div>
<p>
Alan Cox also <a href="/Articles/326518/">jumped into this discussion</a>
in favor of stronger barriers:
<p>
<div class="BigQuote">
	Throw and pray the block layer can fake it simply isn't a valid
	model for serious enterprise computing, and if people understood
	the worst cases, for a lot of non enterprise computing.
</div>
<p>
Linus appears to be unswayed by these arguments, though.  In his view,
filesystems should do the best they can and accept what the underlying
device is able to do.  As of this writing, no patches adding barriers to
<tt>fsync()</tt> have been merged into the mainline.
<p>
Related to this is the concept of laptop mode.  It has been <a
href="/Articles/326522/">suggested</a> that, when a system is in laptop
mode, an <tt>fsync()</tt> call should not actually flush data to disk;
flushing the data would cause the drive to spin up, defeating the intent of
laptop mode.  The response to I/O barrier requests would presumably be
similar.  Some developers oppose this idea, though, seeing it as a
weakening of the promises provided by the API.  This looks like a topic
which could go a long time without any real resolution.

<p>
<h3>Performance tuning</h3>
<p>
Finally, there was some talk about trying to make the virtual memory
subsystem perform better in general.  Part of the problem here has been
recognized for some time: memory sizes have grown faster than disk speeds.
So it takes a lot longer to write out a full load of dirty pages than it
did in the past.  That simple dynamic is part of the reason why writeout
operations can stall for long periods; it just takes that long to funnel
gigabytes of data onto a disk drive.  It is generally expected that
solid-state drives will eventually make this problem go away, but it is
also expected that it will be quite some time, yet, before those drives are
universal.
<p>
In the mean time, one can try to improve performance by not allowing the
system to accumulate as much data in need of writing.  So, rather than
letting dirty pages stay in cache for (say) 30&nbsp;seconds, those pages
should be flushed more frequently.  Or the system could adjust the
percentage of RAM which is allowed to be dirty, perhaps in response to
observations about the actual bandwidth of the backing store devices.
The kernel already has a "percentage dirty" limit, but some developers are
now suggesting that the limit should be a fixed number of bytes instead.
In particular, that limit should be set to the number of bytes which can be
flushed to the backing store device in (say) one second.
<p>
Nobody objects to the idea of a better-tuned virtual memory subsystem.  But
there is some real disagreement over how that tuning should be done.  Some
developers argue for exposing the tuning knobs to user space and letting
the distributors work it out.  Andrew is <a href="/Articles/326529/">a
strong proponent</a> of this approach:
<p>
<div class="BigQuote">
	I've seen you repeatedly fiddle the in-kernel defaults based on
	in-field experience.  That could just as easily have been done in
	initscripts by distros, and much more effectively because it
	doesn't need a new kernel.  That's data.
	<p>
	The fact that this hasn't even been _attempted_ (afaik) is deplorable.
	Why does everyone just sit around waiting for the kernel to put a new
	value into two magic numbers which userspace scripts could have
	set?
</div>
<p>
The objections to that approach follow these lines: the distributors cannot
get these numbers right; in fact, they are not really even inclined to try
to get them right.  The proper tuning values tend to change from one kernel
to the next, so it makes sense to keep them with the kernel itself.  And
the kernel should be able to get these things right if it is doing its job
at all.  Needless to say, Linus <a href="/Articles/326530/">argues</a> for
this approach, saying:
<p>
<div class="BigQuote">
	We should aim to get it right. The "user space can tweak any
	numbers they want" is ALWAYS THE WRONG ANSWER. It's a cop-out, but
	more importantly, it's a cop-out that doesn't even work, and that
	just results in everybody having different setups. Then nobody is
	happy.
</div>
<p>
Linus has suggested (but not implemented) <a href="/Articles/326531/">one
set of heuristics</a> which could help the system to tune itself.  Neil
Brown also <a href="/Articles/326532/">has a suggested approach</a>, based
on measuring the actual performance of the system's storage devices.
Fixing things at this level is likely to take some time; virtual memory
changes always do.  But some smart people are starting to think about the
problem, and that's an important first step.
<p>
That, too, could be said for the discussion as a whole.  There are clearly
a lot of issues surrounding filesystems and I/O which have come to the
surface and need to be discussed.  The Linux kernel community as a whole needs to
think through the sort of guarantees (for both robustness and performance)
it will offer to its users and how 
those guarantees will be fulfilled.  As it happens, the <a
href="http://events.linuxfoundation.org/events/lsf-workshop">2009 Linux
Storage &amp; Filesystems Workshop</a> begins on April&nbsp;6.  Many of
these topics are likely to be discussed there.  Your editor has managed to
talk his way into that room; stay tuned.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems">Filesystems</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/326471/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor326567"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 0:36 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326567/">Link</a>] (37 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I love Linus' so called reality check:<br>
<p>
<font class="QuotedText">&gt; You may wish that was what they did, but  reality is that "open(filename, O_TRUNC | O_CREAT, 0666)" thing.</font><br>
<p>
Which is exactly what ext4 already works around. In line with reality.<br>
<p>
<font class="QuotedText">&gt; Harsh, I know. And in the end, even the _good_ applications will decide that it's not worth the performance penalty of doing an fsync(). In git, for example, where we generally try to be very very very careful, 'fsync()' on the object files is turned off by default.</font><br>
<p>
Ah, thinking of doing fsync() after all, are we?<br>
<p>
<font class="QuotedText">&gt; Why? Because turning it on results in unacceptable behavior on ext3.</font><br>
<p>
Chuckle :-)<br>
<p>
And then, the real reality:<br>
<p>
<font class="QuotedText">&gt; Now, admittedly, the git design means that a lost new DB file isn't deadly, just potentially very very annoying and confusing - you may have to roll back and re-do your operation by hand, and you have to know enough to be able to do it in the first place.</font><br>
<p>
Meaning, make your apps in such a way that an odd crash here and there cannot take out the whole thing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326567/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 3:39 UTC (Wed)
                               by <b>ajross</b> (guest, #4563)
                              [<a href="/Articles/326575/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't be snide, it wrecks the S/N ratio of this site.  No doubt you've already made yourself heard in the other flame wars on the subject.<br>
<p>
And to be fair, there's a difference in designing around "the odd crash here and there" and a 30 Second Window of Doom for every file creation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326576"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 4:19 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326576/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Don't be snide, it wrecks the S/N ratio of this site. No doubt you've already made yourself heard in the other flame wars on the subject.</font><br>
<p>
What is your point here exactly? That I should not post because you may not like reading it? If you are a moderator of the site, please feel free to remove my post.<br>
<p>
I make no apologies for my snideness - I think it was well deserved. Essentially, just because one file system does something in an idiotic way, we should now drop a perfectly good system call. Shouldn't we instead FIX what's broken so that all system calls and all file systems can be used as designed?<br>
<p>
Similarly, we have seen heaps of new system calls introduced into Linux in recent times (dup3 and friends + other, backup related stuff from Ulrich Drepper), which all have to do with files. Why? Because they were needed. No complaints there. I thought the deal was that they would never get used? (see, being snide again).<br>
<p>
<font class="QuotedText">&gt; And to be fair, there's a difference in designing around "the odd crash here and there" and a 30 Second Window of Doom for every file creation.</font><br>
<p>
And to be fair, there is difference in designing around complete system lockups for a number of seconds and committing data when required.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326576/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326606"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:34 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/326606/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Those new system calls (notably *at()) are present because 1) they fill a real hole in the API without which it is *impossible* to read files in particular directories (e.g. deeply nested ones) in a threaded app, and because 2) they allow real security holes in e.g. 'rm -r' to be fixed. Also they already existed in Solaris (hence the horrible misnaming of some of them, also inherited from Solaris). They are new syscalls hence there are no problems with people seeing old examples of their misuse.<br>
<p>
They're not really intended for use by everyman, anyway.<br>
<p>
The problem with what one might call the fsync() RANDOMLY_LOSE option is that it is something which must be used by everyman to avoid data loss, which if you get it wrong there is no sign unless you lose power at exactly the right time, and which nearly all programs you might clap eyes on other than Emacs have historically got wrong, and which many utility programs *cannot* get right no matter what, because there's no way they can tell if the data they are operating on is 'important', and thus should be fsync()ed, or not. (Sure, you could add a new command-line option to tell them, but that option is not in POSIX so portable applications can't rely on it for a long long time).<br>
<p>
That's a big difference.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326606/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 10:24 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326612/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; They're not really intended for use by everyman, anyway.</font><br>
<p>
You are kidding, right? dup3() is not for general use?<br>
<p>
<font class="QuotedText">&gt; That's a big difference.</font><br>
<p>
Look, I'm not really bent on a particular mechanism of actually making sure that programmers have a reliable interface for doing this. Using fsync() before close() is the only portable solution now, but it is far from optimal. I think there is very little doubt about that. And we all know it sucks to high heaven on ext3 in ordered mode.<br>
<p>
I don't know what the best way is: new call, some kind of flag to open that says O_ALWAYSDATABEFOREMETADATA, rename2(), close_with_magic() or whatever. But, saying that application programmers cannot grok this kind of stuff is just not true. They can and they will, only if given the tools. Just like they did dup3() and friends (and as you point out, there is little danger of misuse - these are new calls).<br>
<p>
As I said many times before, overloading current pattern with non-portable behaviour is dangerous, because it provides false sense of robustness and ties one up to a particular FS and kernel. If we can get POSIX updated so that rename() actually means "always data before metadata, but don't put on disk now", then it may even fly. But, I don't know how that's going to make guarantees retroactively, when even Linux features file systems that don't do that (e.g. ext3 in writeback mode).<br>
<p>
Also, having things like delayed allocation, where metadata can legitimately be committed before data, is really useful. Most short lived temporary files will never see disk platters, therefore making things faster and disks last longer. Meaning, keeping the old cruft around ain't that bad.<br>
<p>
As for utility programs that are called from scripts, you can use dd with conv=fsync or conv=fdatasync in your pipe to commit files to disk today. On FreeBSD, they already have standalone fsync program for that. Yeah, I know. It sucks. But, your usual tools don't have to make any decisions on fsync()-ing - you can.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326732"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 18:09 UTC (Wed)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/326732/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      By your logic, we should never fix bugs. Remember the <a href="http://www.theinquirer.net/inquirer/news/136/1043136/bsd-unix-finally-fixes-old">25 year old readdir bug</a>? Don't you agree it was good to fix that? What if a program, somewhere, depended on that behavior?

In reality, programs use rename for atomic replacement. POSIX doesn't say anything about guarantees after a hard system crash, and it's just disingenuous to think that by punishing application authors by giving them as little robustness as possible, you're doing them some kind of portability favor.
      
          <div class="CommentReplyButton">
            <form action="/Articles/326732/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326781"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 20:55 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326781/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I will just answer this one comment, so that nobody gets "offended".<br>
<p>
Quite the opposite. I'm all for fixing bugs and giving application programmers the _right_ tools for the job. If some Linux developers took a second to lift their noses out of the specifics of Linux and actually looked around, this could be fixed for _everyone_, not just for some Linux specific file systems. That is my point, in case you didn't get it by now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326781/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 21:37 UTC (Wed)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/326786/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      It is a worthless effort. Each filesystem must keep its house clean. Why invent a new system call which cannot (by necessity) be honored by ext2, or ext4 without a journal? Everything is working now fine in ext3, and if it doesn't work right in ext4 people will just look for a different filesystem.
<p>
After reading that Linus is not pulling from Mr Tso's trees made me suspect. Well, now that <a href="http://lwn.net/Articles/326786/rss">Ts'o's commit rights have been officially revoked</a> I think that the whole discussion is moot. I wonder if the next ext4 head maintainer will learn from this painful experience and just do the right thing.
      
          <div class="CommentReplyButton">
            <form action="/Articles/326786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326788"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 21:46 UTC (Wed)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/326788/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I'm confused.  The article said that Ted's trees had not been pulled <i>yet</i>.  In fact, that happened today; <a rel="nofollow" href="http://lwn.net/Articles/326708/">a bunch of ext4 work</a> went into the mainline, including a number of patches which increase robustness for applications which don't use <tt>fsync()</tt>.  I dunno what you were trying to link to, but it didn't work.  I've not seen anything about revocation of commit rights.  (It's hard to "revoke commit rights" in a distributed system in any case; at worst you can refuse to pull from somebody else's repository.)
<p>
Maybe it's an April 1 post that went over my head?
      
          <div class="CommentReplyButton">
            <form action="/Articles/326788/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326860"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Recursive linking</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 6:21 UTC (Thu)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/326860/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Sorry, it was a stupid attempt from a foreigner at an April Fools' prank :D  I was hoping that the recursive link would give it away, but maybe it was too plausible altogether.
<p>
Will try to do better next time :D)
      
          <div class="CommentReplyButton">
            <form action="/Articles/326860/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor326793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 22:38 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326793/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just a few points, so please don't get offended. I apologise in advance to all sensitive LWN readers for any injury caused by this post.<br>
<p>
<font class="QuotedText">&gt; Why invent a new system call which cannot (by necessity) be honored by ext2, or ext4 without a journal?</font><br>
<p>
Even if there was some kind of magical law that said that you could not order commits on the non-journaled file system this way, it can always be trivially implemented through - wait for it - fsync(), which has acceptable performance characteristics on such file systems.<br>
<p>
<font class="QuotedText">&gt; Everything is working now fine in ext3</font><br>
<p>
Sure. Except fsync(), which locks the whole system for a few seconds. Hopefully, this will get fixed (or at least its effect reduced) as a result of the hoopla.<br>
<p>
<font class="QuotedText">&gt; Well, now that Ts'o's commit rights have been officially revoked I think that the whole discussion is moot.</font><br>
<p>
Now you are really making a fool of yourself.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor327030"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 23:16 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/327030/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>The problem with what one might call the fsync()
RANDOMLY_LOSE option is that it is something which must be used by
everyman to avoid data loss, which if you get it wrong there is no
sign unless you lose power at exactly the right time, and which nearly
all programs you might clap eyes on other than Emacs have historically
got wrong</blockquote>

<a
href="http://www.complang.tuwien.ac.at/anton/sync-metadata-updates.html">s/other
than/including/</a>.  However, I don't agree that this application
behaviour is wrong; if the application wants to jump through hoops to
get a little bit of extra safety on low-quality file systems, that's
ok, but if it doesn't, that's also ok.  It's up to the users to chose
which applications they run and on which file system.

      
          <div class="CommentReplyButton">
            <form action="/Articles/327030/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor326581"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 5:31 UTC (Wed)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/326581/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is what the beginning of the end for unmoderated LWN commmenting looks like: "Please be polite." "You can't make me."  It's really astonishing that LWN has lasted this long.  It's not an accident. bojan, you are striking a beautiful, fragile object with a hammer. If you don't understand how destructive you are being, please stop and think until you do understand it. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326581/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326582"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 6:07 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326582/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you read my original post in this thread, you will find that I am pointing at inconsistencies of what Linus describes as reality check. So, I ridicule (among other things) his conclusion that: ext3 sucks at doing fsync(), hence we should drop fsync().<br>
<p>
What exactly is not polite about that? Is sarcasm now verboten on LWN? I see plenty of it. Daily.<br>
<p>
In a post not so long ago, someone accused me of hiding behind Ted's authority (although I actually used documentation to support my case - which many don't bother to read, of course). This time, I point out what to me is nonsense coming from an even bigger authority, but that's no good either. I'm not sure what position of mine would satisfy fragile sensibilities here. Only silence, I guess.<br>
<p>
This time I was being accused of making snide remarks. So, I replied to ajross using his terminology, although I do not actually agree with that qualification (which you can see from my sarcastic: "see, being snide again" remark) and I should have used "so called snideness" in my reply instead. I am really just being sarcastic, because we are all supposed to rally behind the high priest or something.<br>
<p>
Sure, Linus is a genius, but that doesn't mean that whatever he says is beyond criticism. And, I do not see how I am not being polite by exercising criticism with a hint of sarcasm.<br>
<p>
What is it exactly that you have the issue with in my posts? What exactly is impolite?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326582/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yup. It's the beginning of the end.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 7:54 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/326600/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>If you read my original post in this thread, you will find that 
I am pointing at inconsistencies of what Linus describes as reality 
check.</blockquote>

<p>Nope. You are being 100% smart-ass. Linus's reality <b>check</b> is not 
inconsistent. It's description of reality and <b>reality is not 
consistent</b>. Whenever it was? You have different factors and in 
different but quite real situations different factors prevail.</p>

<blockquote>So, I ridicule (among other things) his conclusion that: ext3 
sucks at doing fsync(), hence we should drop fsync().</blockquote>

<p>That's different facet of reality. When you consider reality from kernel 
developer POV what the applications are doing is your "unchangeable fact", 
your "speed of light", when you consider reality from application developer 
POV what the kernel does is "unchangeable fact" and you should deal with 
it. This is true even if kernel developer and application developer is the 
same person. You can only think differently if your application is designed 
to <b>only</b> be used "in-house" and you can <b>always</b> guarantee 
control over both kernel and userspace - and git was not designed to only 
be used "in-house"...</p>

<blockquote>And, I do not see how I am not being polite by exercising 
criticism with a hint of sarcasm.</blockquote>

<p>You are exercising ignorance with a hint of sarcasm. That's 
different.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/326600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yup. It's the beginning of the end.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:29 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326604/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; When you consider reality from kernel developer POV what the applications are doing is your "unchangeable fact", your "speed of light", when you consider reality from application developer POV what the kernel does is "unchangeable fact" and you should deal with it.</font><br>
<p>
Let me review.<br>
<p>
When another Unix kernel (or Linux) holds your data in buffers and commits metadata only (because it is allowed to), you, as an application developer, deal with it by ignoring that fact.<br>
<p>
And, when your file system does crazy things with the perfectly good system call, you also ignore it as a kernel developer.<br>
<p>
WOW, is that now the new "very special relativity"? We pick whichever behaviour is the most narrow to a specific file system and go with that?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326641"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yup. It's the beginning of the end.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 14:22 UTC (Wed)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/326641/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; When another Unix kernel (or Linux) holds your data in buffers and commits metadata only (because it is allowed to), you, as an application developer, deal with it by ignoring that fact.</font><br>
<p>
<p>
POSIX allows you never to write data to disk at all. That will make your file system very fast. After all you can have a POSIX-compliant file system that operates off of ramdisk quite easily.<br>
<p>
POSIX file system access is designed to describe the interface layer between userland and the file system. It leaves the actual integration between the file system and the hardware, as well as the internals to the file system itself is left up to the developer of the OS.<br>
<p>
It is like if you discovered all of a sudden a network service provided by a Apache-based web app uses SSL badly so that all usernames and passwords are transmitted over the Web in plain text... then you complain about it and the developer says back to you that his application's behavior is allowed by TCP/HTTP/SSL and that you should be changing your password with each usage, like people who use his app correctly do. Then he emails you some documentation from a security expert that says you should change your password frequently and that many other protocols like telnet or ftp send your username and password over the network in plain text.<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326641/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326691"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yup. It's the beginning of the end.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 16:10 UTC (Wed)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/326691/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is starting to get very repetitive...all these points have been made already at least once in one <br>
of the other article's threads. I'd like to suggest that it might be in everyone's interest to move on to <br>
more useful pass-times than rehashing the same arguments over and over again every time there's <br>
an update on the subject.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326691/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor327031"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sticks &amp; stones</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 23:17 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/327031/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In a post not so long ago, someone accused me of hiding behind Ted's authority</font><br>
<p>
I plead guilty and I apologise.  That was immediately after replying to someone else's post the gist of which was "Ted wrote ext2 and ext3 in the first place, he is therefore above criticism." It concluded with the words "Know your place", which got me riled.<br>
<p>
[proverb: in the midst of great anger, never answer anyone's letter]<br>
<p>
Your words were not so condescending but they had much the same emphasis: all ur filesystems are belong to POSIX (not users) 'cos POSIX is the law, and by the way Ted's interpretation is the only correct one because he's the primary implementor.<br>
<p>
I hope you understand where I was coming from.  Forgive me.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327031/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327036"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sticks &amp; stones</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 23:56 UTC (Thu)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/327036/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nothing to forgive. All is perfectly fine. I enjoy a robust discussion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327036/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor327757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2009 0:05 UTC (Wed)
                               by <b>jschrod</b> (subscriber, #1646)
                              [<a href="/Articles/327757/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, I just decided to give you feedback, from someone who is subscribed to LWN quite a bit longer than you and who did not participate in this topic after you took over all its discussion threads: You showed that LWN really needs a KILL file feature where one can put a poster in it; you, in particular. Others have succinctly explained why, no need to repeat this.<br>
<p>
But your self-rightousness doesn't allow to understand this, obviously. Luckily, there are still some discussion threads where you don't try to take over. I hope the likes of you will remain few on LWN in the future, this is not Slashdot, after all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor326669"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 15:46 UTC (Wed)
                               by <b>GreyWizard</b> (guest, #1026)
                              [<a href="/Articles/326669/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The comment from ajross above was not some gentle plea for polite discourse.  What he actually said included this: "No doubt you've already made yourself heard in the other flame wars on the subject."  A more accurate summary would have been, "Be polite you jerk."<br>
<p>
People get nasty in the comments here all the time.  If there's something beautiful and fragile here it's already in a thousand jagged pieces.  But people hector one another about being polite all the time too.  That also wrecks the signal-to-noise ratio and solves nothing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326669/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327280"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 4, 2009 9:05 UTC (Sat)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/327280/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmmm. Just say whatever your brain produces, and if somebody has a problem<br>
with what comes out, it's on their own plate.<br>
<p>
Living in a country where that mode of thinking is the norm, I can tell<br>
you it also has disadvantages... If only because the resulted hurt<br>
feelings can muddy the discussion more than you might think. Besides, it<br>
chases people away who would otherwise have contributed constructively -<br>
it's not acceptable behavior in all cultures. Ever wondered why the FOSS<br>
community is still predominantly western, despite many smart developers in<br>
countries like India?<br>
<p>
A little decency now and then doesn't hurt. I know people who, knowing how<br>
blunt they can be, ask someone else to read certain emails before sending<br>
them. After all, reality is that people DO have feelings.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327280/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327366"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2009 3:34 UTC (Sun)
                               by <b>GreyWizard</b> (guest, #1026)
                              [<a href="/Articles/327366/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Pardon me for saying so but you have not understood what I wrote.  I did not urge anyone to "say whatever [their] brain produces" or anything equivalent.  Nor did I issue a rallying cry against decency.  Elevating the level of discourse would be a wonderful thing and if you've got an effective suggestion for how to do so I would be glad to read it.<br>
<p>
But saying "be polite you jerk" merely drags things even further down into the muck.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327366/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327401"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2009 12:43 UTC (Sun)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/327401/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I disagree on your argument that saying 'be polite you jerk' merely drags things down, for two reasons.<br>
<p>
First of all, some people don't notice their behavior is unnecessarily impolite. Pointing it out can help them (if they are willing to be reasonable in the first place). Never pointing out somebodies failures will make them fail forever.<br>
<p>
Second, it shows you care about being polite. If others show they care too, a culture of 'you should be polite' can be maintained. As you might have noticed from the differences between FOSS communities, culture is important and heavily influential. And it can be changed.<br>
<p>
Some things to note:<br>
- people DO care about what others think of them. No matter how much they scream 'no I don't', they do. It is our nature.<br>
- people should know their arguments are not supported by being mean - it is the other way around.<br>
- I agree that a 'be polite you yerk' might not always be the best way to correct someone. A personal mail can do more. However, it won't show up in public (unless an apology is made), thus it does not much to influence others who might think it is acceptable behavior because the guy got away with it. Of course, giving a good example is better than anything else.<br>
- Of course discussing without end whether somebody was polite enough or not muddies the discussion and lowers the SNR.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327401/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327408"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2009 15:42 UTC (Sun)
                               by <b>GreyWizard</b> (guest, #1026)
                              [<a href="/Articles/327408/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Both of your arguments could reasonably be applied to a comment that says "please be polite" but both fail for "be polite you jerk."  Someone who is accidentally rude is much more likely to respond to the "you jerk" part than the "be polite" part.  The contradiction immediately destroys the credibility of the person posting because he or she is not willing to be held to the standard set for others.<br>
<p>
A truly polite request for more courtesy might help but it's difficult to be sure because such things are quite rare.  Giving in to the temptation to scold even just a little makes the comment worse than useless.  Unless you are absolutely certain you can do it right it's better to focus on substantive issues and avoid appointing yourself a courtesy cop.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327408/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327411"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2009 16:20 UTC (Sun)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/327411/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
True, if you meant to point out that 'be polite YOU JERK' isn't very effective, I agree. I do however think that it's better than nothing. Nothing changes nothing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327411/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327412"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2009 16:27 UTC (Sun)
                               by <b>GreyWizard</b> (guest, #1026)
                              [<a href="/Articles/327412/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's better to change nothing than to make the situation worse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327412/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of LWN comment dialog?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2009 17:11 UTC (Sun)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/327417/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe. Probably for this one response. However, as I pointed out, there are wider repercussions to be expected from such behavior, and it is worth to show, as a community, that we disapprove of such ways of communicating. Even if that is done in a rather unfriendly manner.<br>
<p>
On re-reading the thread, I think you are right in that ajross was more impolite than bojan, which often leads to a downward spiral and isn't helpful... bojan's post wasn't that far off from the normal tone on this site.<br>
<p>
Anyway. This is went pretty far off-topic, and I think we mostly agree. For as far as we don't, we at least agree on that ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor326585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 6:27 UTC (Wed)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/326585/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Meaning, make your apps in such a way that an odd crash here and there cannot take out the whole thing.</font><br>
<p>
Well, yes, it's a nice goal. The problem is that *you can't* without calling fsync. When the guy who wrote the system calls it "very very annoying and confusing", then it's not really a great example of how we can make all our apps more awesome and usable in general. Unfortunately.<br>
<p>
(During the whole ext4 discussion I spent some time trying to figure out how to abuse Ted's patches to create a transactional system that doesn't require rewriting whole databases on every write, and uses rename(2) for its write barrier instead of fsync(2). But I think block layer reordering makes it impossible. Maybe if there were an ioctl to trigger an immediate roll-over of the journal transaction.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326595"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 7:15 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326595/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The problem is that *you can't* without calling fsync.</font><br>
<p>
fsync() sucks because it is a "commit now" thing. Not everyone wants to commit now - I fully understand that. I'm a notebook user and I don't want my disk being spun up unnecessarily. But, current semantics are what they are, so ignoring them is looking for trouble elsewhere. Sucks - yes, but living in denial doesn't help either. And, as you say, not a great way to make our apps more awesome. Just a necessary evil right now. Some of it can be avoided with backup files, but the underlying badness will persist.<br>
<p>
It would be nice to have a system call that guarantees "data before metadata, but not necessarily now", so that other systems interested in it may also implement it. Then the apps could comfortably rely on this when renaming files over the top of other ones. I was even thinking that we should ask POSIX to standardise that fsync(-fd) means exactly that (because fd is always positive, but we use int for it, which can also have negative values), but this may confuse things even more and is probably stupid.<br>
<p>
Sure, some Linux file systems will continue making it more comfortable even with the undefined order of current semantics, which will please users (BTW, this is really interesting: <a href="http://lwn.net/Articles/326583/">http://lwn.net/Articles/326583/</a>). But, the long term solution in the world of Unix should probably be a bit more inclusive.<br>
<p>
PS. To be fair to fsync(), it is an indispensable tool for databases, so making it work as fast as possible is most definitely a good thing. What ext3 in ordered mode does with it an abomination.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326595/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 7:50 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/326599/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
POSIX/UNIX semantics guarantees that renames are atomic.<br>
<p>
POSIX/UNIX semantics do not make guarantees about the filesystem state after an OS crash.<br>
<p>
Not having to do fsck after a filesystem crash gives the illusion that the filesystem is not corrupted.<br>
<p>
It turns out that at least with extN after a crash we see filesystem<br>
states that are illegal during normal operations.  That is despite not<br>
needing to run fsck the filesystem was corrupted.<br>
<p>
It would be nice if there was a filesystem that could guarantee the visible state of the filesystem if fsck did not need to be run was:<br>
- A legal state for the filesystem in normal operation.<br>
- Everything that was fsynced was available.<br>
<p>
Does anyone know of a journaling filesystem that guarantees not to give me a corrupt filesystem if fsck does not need to be run?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor326602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:05 UTC (Wed)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/326602/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, fsync does look like too blunt an instrument for many purposes.  Your particular problem could be solved though, if the system owner (i.e. you) was able to take decisions about whether fsync should be honoured or not or partly or whatever, rather than having one filesystem do it, one not.  Having said that, you as the system owner are also in a position to choose a filesystem that works well with the behaviour you need...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor326607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:39 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/326607/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
fsync() sucks not because it is a 'commit now' operation (that would be fbarrier()) but because it is a 'commit and force to disk now' operation.<br>
<p>
Actually on many OSes it's a 'start a background force to disk now and return before it's done' operation; on Linux it's a 'lob it at the disk controller so it can cache it instead' operation. Still not necessarily useful (although that is changing to optionally emit a barrier to the disk controller too.)<br>
<p>
(Speaking as the owner of an Areca RAID card with a quarter-gig of battery-backed cache, using non-RAIDed filesystems purely as an fs-cache storage area, I *like* the ability to turn off barriers: all they do is slow my system down with no reliability gain at all.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326609"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:55 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/326609/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
By commit now, I meant force to disk. I think that was clear from the "disk being spun up unnecessarily" bit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326609/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor326619"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fbarrier vs. fsync</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 12:02 UTC (Wed)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/326619/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"fbarrier(fd)" is not a "commit now" operation - that would make it <br>
indistinguishable from fsync.  It is a "commit data before metadata" <br>
request. <br>
<p>
The real technical problem here is that from the application perspective, <br>
the meta data update must take place immediately, i.e. before the system <br>
call returns. However, from a recovery perspective, it is highly desirable <br>
that the persistent meta data state not be committed until after the data <br>
has been committed.  Unless a filesystem maintains two versions of its <br>
metadata (a la soft updates), that is an unusually difficult requirement to <br>
meet without serious performance problems. <br>
<p>
The alternative that I would really like to see is undo records for a few <br>
critical operations like rename replacement, such that the physical data / <br>
meta data ordering requirements are removed, and on recovery the filesystem <br>
un-does rename replacements where the replacement data has not been <br>
committed to disk.  That replaces the ideal of point-in-time recovery with <br>
the more practical ideal of consistent version recovery.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326619/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor326623"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 12:17 UTC (Wed)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/326623/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or in other words, fbarrier is a completely different kind of barrier than <br>
the one that the "barrier=1" mount option requests. The latter is a low <br>
level block I/O write barrier usually implemented with a full write cache <br>
flush (barring some sort of battery backup), the former is a data before <br>
meta data barrier.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326623/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor327001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 20:23 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/327001/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Linus actually overstated git's use of fsync(). There are three relevant cases:</p>
<ul>
<li>git writes to a brand new filename, and then updates an existing file to contain the new filename instead of an old filename. It will optionally do a fsync() between these two operations.</li>
<li>git writes all of the data from several existing files to a single new file, and then removes the existing files. It will always do a fsync() between these two operations.</li>
<li>git updates an existing file by writing to a temporary file and renaming over the existing file. It will never do a fsync() between these two operations.</li>
</ul>
<p>That is, git relies on the assumption that a rename() is atomic with respect to the disk and dependent on all operations previously issued on the inode that is being renamed. It uses fsync() only to make sure that operations to different files happen in the order that it wants.</p>
<p>Now, obviously, if you want to be really sure to keep some data, write it once and never replace it at all. That'll do a good job of protecting against everything, including bugs where you do something like "open(), fsync(), close(), rename()" but forget or mess up the "write()". Obviously, this isn't an option for a lot of situations, however, but it's what git does for the most important data.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/327001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor326597"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I/O barriers and LVM</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 7:11 UTC (Wed)
                               by <b>TRS-80</b> (guest, #1804)
                              [<a href="/Articles/326597/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Looks like <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=ab4c1424882be9cd70b89abf2b484add355712fa">LVM  finally got support for barriers in 2.6.29</a> (a <a href="http://lkml.org/lkml/2008/2/15/125">year after first submitted</a>) although only for linear targets.
      
          <div class="CommentReplyButton">
            <form action="/Articles/326597/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326634"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I/O barriers and LVM</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 13:40 UTC (Wed)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/326634/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nifty; thanks. This change alone is making me consider using a kernel.org kernel, something I haven't done in years.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326634/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I/O barriers and LVM</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 19:03 UTC (Wed)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/326757/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"""<br>
This change alone is making me consider using a kernel.org kernel, something I haven't done in years.<br>
"""<br>
<p>
Are you saying that distro kernels already do this? If so, I'm not suggesting that you are wrong. Just interested in more info. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I/O barriers and LVM</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 19:08 UTC (Wed)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/326759/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, they don't do this. LVM's lack of barrier support has resulted in my not using LVM in some circumstances. If kernel.org kernels grow LVM barrier support and are otherwise stable, it might be worth using them until distribution kernels are updated to include the functionality.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor326635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I/O barriers and LVM</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 13:44 UTC (Wed)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/326635/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unfortunately, they don't actually get the barriers down to the device.  There's a bug in the implementation...hopefully it'll get fixed up in 2.6.30 and then backported for 2.6.29-stable<br>
<p>
(Credit to Eric Sandeen for tracking it down).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor326598"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 7:38 UTC (Wed)
                               by <b>bakterie</b> (guest, #37541)
                              [<a href="/Articles/326598/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How do filesystems other than ext3/4 do it? I haven't seen mentions of<br>
other filesystems in the discussions, but then again I haven't looked very<br>
hard. One of my computers is using reiserfs. How does reiserfs do it?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326598/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326616"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 11:17 UTC (Wed)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/326616/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
More or less exactly the same as ext3 ;)  The reiesrfs data=ordered is very similar to ext3.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326616/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor326814"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 0:37 UTC (Thu)
                               by <b>davecb</b> (subscriber, #1574)
                              [<a href="/Articles/326814/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How do filesystems other than ext3/4 do it? <br>
<p>
Well, the Unix v6 filesystem implemented <br>
in-order writes, as did 4.x BSD and the<br>
other pre-journaled filesystems. POSIX allows<br>
reordering to make coalesence easy, as<br>
a lot of research was being done at that<br>
time to get better performance.<br>
<p>
A colleague at ICL (hi, Ian!) did his <br>
masters at UofT on that, and found you<br>
could get a performance improvement <br>
and still preserve correctness by using<br>
what I'd characterize as tsort(1), which<br>
worked better than BSD/Solaris soft updates.<br>
<p>
--dave<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326814/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor326603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:09 UTC (Wed)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/326603/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps the atime thing could also be massaged a bit by having strict atime behaviour, but a really low priority for the updates - leaving them in the cache to accumulate for a while, perhaps anything up to an hour, and trying to do them when the directory is to be updated anyway.  I'm sure that if some system crash causes a loss of atime data, few people will be very sad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326639"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 13:58 UTC (Wed)
                               by <b>TRS-80</b> (guest, #1804)
                              [<a href="/Articles/326639/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      People were suggesting the same thing with renames - queue them up until the data is written to disk, but apparently it's too complex (BSD FFS softupdates being proof of this).
      
          <div class="CommentReplyButton">
            <form action="/Articles/326639/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326857"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 6:40 UTC (Thu)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/326857/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
'softupdates' is proof of the complexity of keeping two fully generalized <br>
versions of the meta data around at all times - not only that but <br>
converting back and forth between the two versions on demand.<br>
<p>
You can't really "queue" a rename, without doing something comparable to <br>
what softupdates does, because the rename has to take immediate affect from <br>
the application perspective.  To do that, somewhere there must be a layer <br>
to keep track of the difference between what the user visible meta data is, <br>
and what the committed meta data is.  If the differences are sufficiently <br>
general, that is a major problem. If one wants high performance rename <br>
replacements, rename undo is much more practical.<br>
<p>
It would be practical to update atimes on a low priority basis, with the <br>
caveat that a lot of memory may be consumed holding metadata blocks around <br>
until the atime updates are complete.  In addition, on a system under <br>
sufficient load, moving I/O to a low priority thread doesn't really help <br>
anyway.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326857/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326898"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Rename undo</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 14:01 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/326898/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If one wants high performance rename replacements, rename undo is much more practical.</font><br>
<p>
I'm intrigued, but not satisfied.  Telling the journal that a metadata change is 'committed' means that the post-crash-recovery state will reflect the change (journal replay).<br>
<p>
Surely the only satisfactory way to commit data before committing the metadata change is to delay *all* journal commits in-order until after the relevant file data is written in place, or to journal the data itself.<br>
<p>
For performance reasons it's probably much saner not to journal most data, especially for random access within large files, but I'm thinking that if it makes sense to allocate-on-commit to preserve the in-order semantics of atomic rename, it might also make good sense to special-case data journalling for newly-written (created or truncated) files when they are renamed (perhaps only for small files, and allocate-on-commit larger ones as users will likey expect a delay).<br>
<p>
Having the ability to unwind a specific kind of metadata change seems very confusing.  I fear that winding back a rename could well result in a violation of expected in-order semantics w.r.t. metadata after crash recovery.  Or might it be possible to wind back an entire 'transaction', all other metadata changes since the rename included?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326898/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326977"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Rename undo</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 18:13 UTC (Thu)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/326977/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are right, if you want guaranteed preservation of in-order semantics <br>
there are no alternatives other than journalling the data or delaying all <br>
journal commits until the corresponding data has been written.   Both <br>
options are available (e.g. data=journal, and data=ordered), and both have <br>
serious performance problems.  Of course, if that is really what you need, <br>
than the price is worth paying.<br>
<p>
"data=writeback" is the current alternative which doesn't make any pretense <br>
to the preserving in-order semantics of data and meta-data after a crash.  <br>
You get a snapshot of your meta-data at a certain point of time, but the <br>
data may be trashed.<br>
<p>
Rename undo is a much less severe compromise to in-order semantics after a <br>
crash. It is not point in time recovery, it is consistent version recovery.   <br>
That can have some unexpected side effects, but none remotely as severe as <br>
losing the data completely.  <br>
<p>
In the case you mention, if you write a new version, rename it over the old <br>
one, change the security permissions on the replacement, and then the <br>
system crashes, you are not going to get the new (unwritten) data, the new <br>
inode, and the new permissions, you are going to get the old inode, the old <br>
data, and the old permissions.  The permissions go with the inode (and the <br>
data), not the directory entry.  That is what you want.  The old inode (and <br>
the old data) has to be kept around until the data for the new inode is <br>
completely on disk.  Otherwise you cannot undo the rename replacement after <br>
the fact.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326977/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor326763"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 19:41 UTC (Wed)
                               by <b>Steve_Baker</b> (guest, #265)
                              [<a href="/Articles/326763/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps instead they could just invert the meaning of the 'A' file <br>
attribute when a filesystem has been mounted with the noatime or relatime <br>
option to force strict atime updates for files so marked.  That way you <br>
can mount your filesystem(s) noatime and only put the A attribute on your <br>
mailboxes and you're done.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326763/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">per-inode noatime</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2009 10:06 UTC (Wed)
                               by <b>pjm</b> (guest, #2080)
                              [<a href="/Articles/336848/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One can more or less achieve that by applying chattr +A to the whole filesystem and then chattr -A on specific files.  Note that chattr +A on a directory will be inherited by any files created in that directory (excluding moving an existing file into that directory).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/336848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor327271"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 4, 2009 7:42 UTC (Sat)
                               by <b>dirtyepic</b> (guest, #30178)
                              [<a href="/Articles/327271/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
wouldn't mutt keep telling you there's new messages an hour after you've read them then?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327271/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327272"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 4, 2009 7:44 UTC (Sat)
                               by <b>dirtyepic</b> (guest, #30178)
                              [<a href="/Articles/327272/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
nevermind, you said cache didn't you.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327272/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor326610"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That massive filesystem thread</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 8:59 UTC (Wed)
                               by <b>lmb</b> (subscriber, #39048)
                              [<a href="/Articles/326610/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The key issue with the performance penalty is that application writers intend fsync() to apply to their file(s), but it actually forces a file system-wide barrier. Fixing that, and selectively syncing just a subset of the journal, should help with the performance issues.<br>
<p>
(A possible extension then might be to have fsyncl(), which accepts a list of fds to sync at the same time, but it is not strictly required.)<br>
<p>
Or, of course, to get application writers to use more async IO.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326610/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor326618"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">When to flush()?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 11:22 UTC (Wed)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/326618/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I remain convinced that this should be an open() option whether a file is critical, normal or expendable.  <br>
<p>
The write-to-disk policy would thus be per-file, but it would be the kernel's decision to flush what needs to be when it deems necessary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326618/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326626"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">When to flush()?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 12:20 UTC (Wed)
                               by <b>RobSeace</b> (subscriber, #4435)
                              [<a href="/Articles/326626/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You mean like open(O_SYNC)?  Or, do you mean something more than that is required?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326626/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326631"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">When to flush()?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 13:19 UTC (Wed)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/326631/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You mean like open(O_SYNC)?</font><br>
<p>
Yes, but with more granularity. O_SYNC means write everything immediately, whereas you might want to give the kernel some time to organise the reads/writes more efficiently:<br>
* O_CRITICAL: 1 second<br>
* O_EXPENDABLE: 30 seconds<br>
* default: 5 seconds<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326631/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326901"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Totally superfluous.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 14:14 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/326901/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The application developer who has the choice of using these options doesn't know whether the data is expendable or not, and the end-user doesn't care about the implementation details.<br>
<p>
Things go strangely pear-shaped when the most irrelevant, trivial data (eg. GNOME configs when we're only using GNOME because it's a default someone else chose) goes missing or gets corrupted.<br>
<p>
I most definitely don't care if GNOME forgets where I put a window or two.  But I do care if it fails to start.<br>
<p>
What we end-users want (I wear a developer hat much of the time but I'm *always* a user) is not to be annoyed by the things we don't care about.  O_EXPENDABLE and its ilk are an invitation for corner-cases to bite end-users.  End-users don't deserve such treatment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326901/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326904"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Totally superfluous.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 14:30 UTC (Thu)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/326904/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The application developer who has the choice of using these options doesn't know whether the data is expendable or not</font><br>
How then are they expected to know when to flush?<br>
<p>
And anyway, do we really not know which files are important and which are not?<br>
Examples:<br>
* pid file, browser cache: don't care<br>
* conf file, document, code: care<br>
* database file: care a lot<br>
<p>
But I do thank you for challenging this idea ;-) Please feel free to give counter-examples and -arguments.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326904/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor326630"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">use of atime</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 13:28 UTC (Wed)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/326630/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At least Debian popularity-constest (<a href="http://popcon.debian.org">http://popcon.debian.org</a>)uses atime to tell whether a package was used recently or not.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326630/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor326650"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">use of atime</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2009 14:25 UTC (Wed)
                               by <b>knobunc</b> (subscriber, #4678)
                              [<a href="/Articles/326650/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="http://beta.linuxfoundation.org/news-media/blogs/browse/2009/03/ssd%E2%80%99s-journaling-and-noatimerelatime">http://beta.linuxfoundation.org/news-media/blogs/browse/2...</a><br>
--<br>
Alternatively, you can use chattr +A to set the noatime flag on all files and directories where you dont want noatime semantics, and then clear the flag for the Unix mbox files where you care about the atime updates. Since the noatime flag is inherited by default, you can get this behaviour by setting running chattr +A /mntpt right after the filesystem is first created and mounted; all files and directories created in that file system will have the noatime file inherited.<br>
--<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326650/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor326992"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 19:15 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/326992/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus pointed out that, in his experience, the only way you can possibly lose data that has gotten to a drive's write cache is to suddenly lose power. And if you suddenly lose power, in his experience, the drive is actually much more likely to wipe out some arbitrary track of data from the disk than it is to have anything in the write cache and lose it. That is, if you want to be really certain that you don't lose data, you need to have a couple seconds of power for your disk drive after its input goes idle, or you might lose some data completely regardless of anything the application that writes it could possibly do.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/326992/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327032"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 23:28 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/327032/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>And if you suddenly lose power, in his experience, the
drive is actually much more likely to wipe out some arbitrary track of
data from the disk than it is to have anything in the write cache and
lose it.</blockquote>

While I have experienced drives that damage sectors or tracks on power
loss, I consider these drives faulty; and with such drives the problem
does not seem to be limited to drives that are trying to write
something at the time.  However, most drives don't wipe out arbitrary
data in my experience.

<p>But I have tested two drives with a <a
href="http://www.complang.tuwien.ac.at/anton/hdtest/">test program for
out-of-order writing</a>, and found that they both wrote data several
seconds out of order with a certain access sequence.  If we don't see
more frequent problems from this, that's probably because the disks don't
optimize accesses as aggressively as some people imagine.
      
          <div class="CommentReplyButton">
            <form action="/Articles/327032/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor327034"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2009 23:31 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/327034/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I haven't crashed many disks but my limited experience is similar.  If you get to the point where data loss is caused by the hardware, it is likely to be trashing a whole lot more than the contents of the cache at shutdown.  The solution to this problem is RAID; journals solve a different problem altogether.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327034/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327037"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 3, 2009 0:02 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/327037/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
RAID doesn't really solve sudden-power-loss situations: in fact RAID-5 in <br>
particular can make it much worse (turning small-range corruption into <br>
apparent scattershot corruption).<br>
<p>
A UPS, or battery-backing, is the answer (well, moves the failure point: <br>
if it's a UPS, the UPS must fail before you lose: if it's battery-backed, <br>
you often have to lose the battery first, then power, which is likely to <br>
happen because you often have no idea the battery has failed until it's <br>
too late).<br>
<p>
In conclusion: we all suck, our data is doomed, the Second Law shall <br>
triumph and Sod and Murphy shall dance above our mangled filesystems.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/327037/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor327235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 4, 2009 0:01 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/327235/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The answer is RAID and UPS, but not that way.  The RAID goes over the UPS; e.g. a mirror of two disk drives, each with its own UPS.
<p>
Such redundancy also makes it possible to test the UPS regularly and avoid the problem of two dead batteries when the external power fails.
<p>
The UPS doesn't count if you don't test, measure, and/or replace the its battery regularly.

      
          <div class="CommentReplyButton">
            <form action="/Articles/327235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor327230"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 3, 2009 23:49 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/327230/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>
It's hard to believe there are disk drives out there (not counting an occasional broken one) that write trash over random areas as they power down.  Disk drives I have seen have a special circuit to disconnect and park the head the moment voltage begins to drop.  It has to park the head because you can't let the head land on good recording surface, and it has to cut off the write current because otherwise it's dragging a writing head all the way across the disk, pretty much guaranteeing the disk will never come back.  I believe it's a simple circuit that doesn't involve any controller intelligence.
<p>
There is a related failure mode where the drive's <em>client</em> loses power and in its death throes ends up instructing the drive to trash itself while the drive still has enough power to operate normally.  I've heard that's not unusual, and it's the best argument I know for a UPS that powers a system long enough for it to shut down cleanly.

      
          <div class="CommentReplyButton">
            <form action="/Articles/327230/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330275"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2009 6:24 UTC (Mon)
                               by <b>bersl2</b> (guest, #34928)
                              [<a href="/Articles/330275/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><p>It's hard to believe there are disk drives out there (not counting an occasional broken one) that write trash over random areas as they power down. Disk drives I have seen have a special circuit to disconnect and park the head the moment voltage begins to drop. It has to park the head because you can't let the head land on good recording surface, and it has to cut off the write current because otherwise it's dragging a writing head all the way across the disk, pretty much guaranteeing the disk will never come back. I believe it's a simple circuit that doesn't involve any controller intelligence.</p>

<p>There is a related failure mode where the drive's <i>client</i> loses power and in its death throes ends up instructing the drive to trash itself while the drive still has enough power to operate normally. I've heard that's not unusual, and it's the best argument I know for a UPS that powers a system long enough for it to shut down cleanly.</p></blockquote>

<p>One of these happened to me. $DEITY as my witness, I will never run an important system without an UPS again.</p>

<p>Bonus: The drive was a Maxtor. Serves me right.<br>
Double bonus: That still wasn't traumatic enough to compel me to make backups.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/330275/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330294"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fsync() and disk flushes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2009 10:43 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/330294/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You don't need a UPS. A battery-backed disk controller is just as good <br>
(and perhaps better because the battery failing doesn't take your machine <br>
down if the power is otherwise OK, while the UPS failing *does*).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330294/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor328783"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Put hardware in between RAM and Disk features to work in between these</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 17, 2009 0:05 UTC (Fri)
                               by <b>hozelda</b> (guest, #19341)
                              [<a href="/Articles/328783/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a reason why solid state drives aren't use on PCs as a cache level ahead of the main disk drives? These can even be made replaceable (it's just a cache anyway). Wouldn't these improve the performance/correctness trade-offs enough for many use cases?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/328783/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
