        <!DOCTYPE html>
        <html lang="en">
        <head><title>Gathering multiple system parameters in a single call [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/890449/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/889854/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/890449/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Gathering multiple system parameters in a single call</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jake Edge</b><br>April 6, 2022</br>
           </div>
<p>
Running a command like <a
href="https://man7.org/linux/man-pages/man8/lsof.8.html"><tt>lsof</tt></a>,
which lists the open files on the system along with information about the
process that has each file open, takes a lot of system calls, mostly to read a
small amount of information from many <tt>/proc</tt> files.  Providing a
new interface to collect those calls together into a single (or, at least,
fewer) system calls is the target of Miklos Szeredi's <a
href="/ml/linux-kernel/20220322192712.709170-1-mszeredi@redhat.com/"><tt>getvalues()</tt>
RFC patch</a> that was posted on March&nbsp;22.  While the proposal does
not look like it is going far, at least in its current form, it did spark
some discussion of the need—or lack thereof—for a way to reduce this kind
of overhead, as well as to explore some alternative ways to get there via code that
already exists in the kernel.
</p>

<h4><tt>getvalues()</tt></h4>

<p>
In his post, Szeredi highlighted the performance problem: "<q>Calling
open/read/close for many small files is inefficient</q>". Running
<tt>lsof</tt> on his desktop resulted in around 60,000 calls to read small
amounts of data from <tt>/proc</tt> files; "<q>90% of those are 128
bytes or less</q>".  But another problem that <tt>getvalues()</tt> tries
to address is the fragmentation of the interfaces for gathering system
information on Linux:
<blockquote class="bq">
  For files we have basic stat, statx, extended attributes, file attributes
  (for which there are two overlapping ioctl interfaces).  For mounts and
  superblocks we have stat*fs as well as /proc/$PID/{mountinfo,mountstats}.
  The latter also has the problem on not allowing queries on a specific
  mount.
</blockquote>
</p>

<p>
His proposed solution is a system call with the following prototype, which
uses a new structure type:
<pre>
    struct name_val {
	    const char *name;		/* in */
	    struct iovec value_in;	/* in */
	    struct iovec value_out;	/* out */
	    uint32_t error;		/* out */
	    uint32_t reserved;
    };

    int getvalues(int dfd, const char *path, struct name_val *vec, size_t num,
	          unsigned int flags);
</pre>
</p>

<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
It will look up an object (which he calls <tt>$ORIGIN</tt>) using
<tt>dfd</tt> and <tt>path</tt>, as with <a href="https://man7.org/linux/man-pages/man2/open.2.html"><tt>openat()</tt></a>; 
<tt>flags</tt> is used to modify the <tt>path</tt>-based lookup.
<tt>vec</tt> is an array of <tt>num</tt> entries for the parameters of
interest.  <tt>getvalues()</tt> will return the number of values filled in
or an error.
</p>

<p>
The <tt>name</tt> field in <tt>struct&nbsp;name_val</tt> is where most of
the action is.  It consists of a string in a kind of new micro-language
that describes the value of interest, using prefixes to identify
different types of information.  From the post:
<blockquote class="bq">
<pre>
mnt                    - list of mount parameters
mnt:mountpoint         - the mountpoint of the mount of $ORIGIN
mntns                  - list of mount ID's reachable from the current root
mntns:21:parentid      - parent ID of the mount with ID of 21
xattr:security.selinux - the security.selinux extended attribute
data:foo/bar           - the data contained in file $ORIGIN/foo/bar
</pre>
</blockquote>
</p>

<p>
The prefix can be omitted if it is the same as that of the previous entry
in <tt>vec</tt>, so a "<tt>mnt:mountpoint</tt>" followed by a
"<tt>:parentid</tt>" would imply the "<tt>mnt</tt>" prefix on the latter.
<tt>value_in</tt> provides a buffer to hold the value retrieved; passing a
NULL for
<tt>iov_base</tt> in the <a
href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/uio.h#L17"><tt>struct&nbsp;iovec</tt></a>
will reuse the previous entry's buffer. That allows a single buffer to be
used for multiple retrieved values with <tt>getvalues()</tt> stepping
through the buffer as needed.  <tt>value_out</tt> will hold the
address of where the value was stored, which is useful for shared buffers,
and its length.  If an error occurs, 
its code will be stored in <tt>error</tt>.
</p>

<p>
It is a fairly straightforward interface, though it does add yet another
(simple) parser into the kernel.  Szeredi also posted a <a
href="/ml/linux-kernel/CAOssrKcJT=HCYW1tUwUaZbD8gi2CNh4__7Q6kqTPsdxF07dmBQ@mail.gmail.com/">sample
program</a> that shows how it can be used.
</p>

<h4>Reaction</h4>

<p>
Casey Schaufler <a
href="/ml/linux-kernel/f80f372b-4249-eb25-ed95-9f8615877745@schaufler-ca.com/">pointed
out</a> that the open/read/close problem could be addressed without all of
the rest of the generality with a <tt>openandread()</tt> system call or
similar.  He also had some questions and comments about the interface, some
of its shortcuts, and its behavior in the presence of errors.
Greg Kroah-Hartman <a
href="/ml/linux-kernel/YjrJWf+XMnWVd6K0@kroah.com/">noted</a> that he had
<a 
href="/ml/linux-kernel/20200704140250.423345-1-gregkh@linuxfoundation.org/">posted</a>
a proposal for a <tt>readfile()</tt> system call that would address the
overhead problem as well.  It was the subject of an <a
href="/Articles/813827/">LWN article</a> just over two years ago.  But it
turns out that he found little real-world performance improvement using
<tt>readfile()</tt>, which is part of why it was never merged.  "<q>Do
you have anything real that can use this that shows a speedup?</q>". 
</p>

<p>
Bernd Schubert <a
href="/ml/linux-kernel/d0e2573a-7736-bb3e-9f6a-5fa25e6d31a2@ddn.com/">thought</a>
that network filesystems could benefit, because operations could be batched
up rather than sent individually over the wire.  He said that because there
is no <tt>readfile()</tt> (or its equivalent) available, network filesystem
protocols are not adding combined operations for open/read/close.  But J. Bruce Fields <a
href="/ml/linux-kernel/20220323192958.GA18275@fieldses.org/">said</a> that
NFSv4 already has compound operations, "<q>so you can do OPEN+READ+CLOSE
in a single round trip</q>".  So far, at least, the NFS client does not
actually use it, but the protocol support is there.
</p>

<p>
While Christian Brauner <a
href="/ml/linux-kernel/20220323114215.pfrxy2b6vsvqig6a@wittgenstein/">was
in favor</a> of better ways to query filesystem information, he was
concerned about the ease-of-use for  <tt>getvalues()</tt>:
<blockquote class="bq">
 I would really like if
we had interfaces that are really easy to use from userspace comparable
to statx for example. I know having this generic as possible was the
goal but I'm just a bit uneasy with such interfaces. They become
cumbersome to use in userspace.
<p>
[...] Would it be really that bad if we added multiple syscalls for different
types of info? For example, querying mount information could reasonably
be a more focussed separate system call allowing to retrieve detailed
mount propagation info, flags, idmappings and so on. Prior approaches to
solve this in a completely generic way have gotten us not very far too
so I'm a bit worried about this aspect too.
</blockquote>
</p>

<p>
But Szeredi <a
href="/ml/linux-kernel/CAJfpegsCKEx41KA1S2QJ9gX9BEBG4_d8igA0DT66GFH2ZanspA@mail.gmail.com/">thinks</a>
that the generality of the interface is important for the future.  A system
call like <a
href="https://man7.org/linux/man-pages/man2/statx.2.html"><tt>statx()</tt></a>
could perhaps be added for filesystem information
(e.g. <tt>statfsx()</tt>), but that only works for data that can be
represented in a flat structure.  Hierarchical data has to be represented
in some other way.  He would like to see some kind of unified interface to
gather information from multiple different sources in the kernel, both
textual and binary, that uses hierarchical namespaces (a la file paths) for
data that does not have a flat structure—rather than a collection of ad hoc
interfaces that get added over time.
</p>

<p>
Kroah-Hartman pointed to two different mechanisms that might be used,
<a href="/ml/linux-kernel/Yjsiv2XesJRzoeTW@kroah.com/">starting</a> with the KVM <a
href="https://elixir.bootlin.com/linux/latest/source/virt/kvm/binary_stats.c"><tt>binary_stats.c</tt></a>
interface, "<q>which tried to create a 'generic' api, but ended up just
making something to work for KVM as they got tired of people ignoring
their more intrusive patch sets</q>". 
But Szeredi <a
href="/ml/linux-kernel/CAJfpegsBmed6dchjgVeQ-OPGYBiU+2GPgsoJegjuPTrcLs6-8g@mail.gmail.com/">said</a>
that the KVM mechanism would not be easily used for things like extended
attributes (xattrs) that do not have a fixed size.  Kroah-Hartman followed
that up with a <a
href="/ml/linux-kernel/YjwWHk9YYGrb6i07@kroah.com/">suggestion</a> to look
at <a href="https://varlink.org/">varlink</a> as a possible protocol for
transferring the data.
</p>

<p>
Ted Ts'o <a href="/ml/linux-kernel/YjudB7XARLlRtBiR@mit.edu/">was not
sure</a> what problem <tt>getvalues()</tt> was truly solving.  He noted
that an <tt>lsof</tt> on his laptop did not take an inordinate amount of
time, so the performance argument does not really make sense to him.  As
for ease-of-use, he suggested adding user-space libraries that gather up
the data from various sources "<q>to make life easier for
application programmers</q>".  He had other concerns as well:
<blockquote class="bq">
Each
new system call, especially with all of the parsing that this one is
going to use, is going to be an additional attack surface, and an
additional new system call that we have to maintain --- and for the
first 7-10 years, userspace programs are going to have to use the
existing open/read/close interface since enterprise kernels stick [around]
for a L-O-N-G time, so any kind of ease-of-use argument isn't 
really going to help application programs until RHEL 10 becomes
obsolete.
</blockquote>
</p>

<p>
If the open/read/close problem is real for some filesystems (e.g. network
or FUSE), Christoph Hellwig <a
href="/ml/linux-kernel/YjwQ4dLH7BWOqZqr@infradead.org/">said</a>, a better
way to address it would be with an <a href="/Articles/810414/">io_uring</a>
operation. "<q>And even on that I need to be sold first.</q>"  The
<tt>readfile()</tt> article linked above also has a section on a mechanism to
support that use case with io_uring. 
</p>

<p>
Linus Torvalds <a
href="/ml/linux-kernel/CAHk-=wibqjNiLgnsL2LcTDKqnKyQ17rhHJv-qkHY1w93LJuXjA@mail.gmail.com/">was
skeptical</a> of the whole concept.  Coalescing the open/read/close cycle
has been shown to make little difference from a performance standpoint, and
he did not think that the more general query interface was particularly
compelling either:
<blockquote class="bq">
With the "open-and-read" thing, the wins aren't that enormous.
<p>
And getvalues() isn't even that. It's literally a [specialty] interface
for a very special thing. Yes, I'm sure it avoids several system
calls. Yes, I'm sure it avoids parsing strings etc. But I really don't
think this is something we want to do unless people can show enormous
and real-world examples of where it makes such a huge difference that
we absolutely have to do it.
</blockquote>
</p>

<h4>Virtual xattrs?</h4>

<p>
Dave Chinner <a
href="/ml/linux-kernel/20220323225843.GI1609613@dread.disaster.area/">pointed
out</a> that the XFS filesystem has a somewhat similar <a
href="https://man7.org/linux/man-pages/man2/ioctl.2.html"><tt>ioctl()</tt></a>
command (<tt>XFS_IOC_ATTRMULTI_BY_HANDLE</tt>) that is used to dump and
restore extended attributes in batches.  He suggested that idea could be further
extended:
<blockquote class="bq">
I've said in the past when discussing things like statx() that maybe
everything should be addressable via the xattr namespace and
set/queried via xattr names regardless of how the filesystem stores
the data. The VFS/filesystem simply translates the name to the
storage location of the information. It might be held in xattrs, but
it could just be a flag bit in an inode field.
<p>
Then we just get named xattrs in batches from an open fd.
</blockquote>
</p>

<p>
He said that the values that Szeredi envisions being available via
<tt>getvalues()</tt> could simply be mapped into an xattr namespace and
retrieved using "<q>a new,
cleaner version of xattr batch APIs that have been around for 20-odd
years already</q>".   Schaufler <a
href="/ml/linux-kernel/4080a088-8d4a-9631-3374-ded001d35c58@schaufler-ca.com/">cautioned</a>
that there is a "<q>significant and vocal set of people who dislike xattrs
passionately</q>", but if that problem could be solved, Chinner's
approach had a lot going for it. "<q>You could even provide getvalues()
on top of it.</q>" 
</p>

<p>
Szeredi <a
href="/ml/linux-kernel/CAJfpegv6PmZ_RXipBs9UEjv_WfEUtTDE1uNZq+9fBkCzWPvXkw@mail.gmail.com/">seemed
amenable</a> to the idea, though he wondered about information from
elsewhere in the system.  Amir Goldstein <a
href="/ml/linux-kernel/CAOQ4uxhbm2mtTp8PmgEq5KmwTe0n6MRRGhShXM=Ot6Bz87HXjA@mail.gmail.com/">said</a>
that there is already precedence for "virtual xattrs" in the CIFS
filesystem, so that idea could be extended to mount information and
statistics of various kinds: "<q>I don't see a problem with querying
attributes of a mount/sb the same 
way as long as the namespace is clear about what is the object that
is being queried (e.g. getxattr(path, "fsinfo.sbiostats.rchar",...).</q>"
</p>

<p>
Chinner also <a
href="/ml/linux-kernel/20220324203116.GJ1609613@dread.disaster.area/">noted</a>
that using the xattr interface would provide "<q>a
symmetrical API for -changing- values</q>". Instead of using some other
mechanism (e.g. configfs) to change system parameters, they could be done
with a <a
href="https://man7.org/linux/man-pages/man2/setxattr.2.html"><tt>setxattr()</tt></a>
call. "<q>That retains the simplicity of proc and sysfs attributes in that you
can change them just by writing a new value to the file....</q>"
</p>

<p>
The discussion more or less wound down after that.  The xattrs-based idea
seemed reasonably popular and much of the infrastructure
to use it is already present in the kernel in various forms.   So, while
<tt>getvalues()</tt> itself does not have a path toward merging, seemingly,
the idea behind it could perhaps be preserved in a somewhat different
form.  So far, patches for that have not appeared, but perhaps that is
something we will see before too long.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls">System calls</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/890449/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor890517"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2022 22:59 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/890517/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Uhmm.... io_uring?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890517/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890523"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 0:14 UTC (Thu)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/890523/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Seems <a href="https://lwn.net/Articles/813777/">this</a> was merged a long time ago



      
          <div class="CommentReplyButton">
            <form action="/Articles/890523/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor890527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 1:11 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/890527/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
First thing I thought of while reading this, too. If the objective is to reduce syscall overhead that&#x27;s the obvious answer, though I agree with the parts where the syscalls themselves could be nicer to use.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor890526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 1:42 UTC (Thu)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/890526/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But I really don&#x27;t think this is something we want to do unless people can show enormous and real-world examples of where it makes such a huge difference that we absolutely have to do it. </font><br>
<p>
htop -d 10 , which gives me a nice, reliable view of what my system is doing, consumes 12-15% CPU.  htop -d 1, which gives a great picture of what my computer is up to that moment, goes up to 50-60% CPU.   12-15% may not sound like a lot, but its the highest or 2nd highest consumer most of the time.  This is on a system with two web browsers with well over 100 tabs open, as well as several other apps (some in python) running nearly constantly.  Having my performance monitoring tool eat up more CPU than Firefox&#x27;s 117 tabs in 3 windows is a little bit sad.<br>
<p>
<font class="QuotedText">&gt; He noted that an lsof on his laptop did not take an inordinate amount of time, so the performance argument does not really make sense to him.</font><br>
<p>
I should be clear that the machine I am writing this on (and running these tests on) is running in battery mode: cpu frequencies are locked at 800 mHz, everything in &quot;extreme power save mode&quot;, etc.  However, despite running this command thrice to ensure everything was nice and warm in the caches, I still got these results: <br>
<p>
time lsof &gt; /dev/null<br>
real	0m29.248s<br>
user	0m16.245s<br>
sys	0m12.842s<br>
<p>
This might not be &#x27;inordinate&#x27;, but it&#x27;s certainly significant.  Even if we assume that every last moment of the 12 seconds spent on system calls is vitally needed and cannot be optimized by this new call, what exactly is being done during the 16 seconds in userspace? How much of that time amounts to &quot;parse what the kernel gave us&quot;?<br>
<p>
This isn&#x27;t really a matter of user-facing performance for me: rather, it&#x27;s a question of power efficiency.  If I leave htop running in the background for a while, that shouldn&#x27;t harm my battery life substantially.  Performance monitoring tools in userspace are very common: think of how many there are running in the world right now.  If we make all of them twice as fast, we will save megawatts of power.  Using the standard &quot;oh, but tools won&#x27;t use it at first&quot; argument seems pretty silly to me: tools can detect the availability of system calls, and further, that argument applies to every possible bit of functionality: why aren&#x27;t we hearing that objection to argue that the performance gains of, say, io-uring are irrelevant?  As for attack surface, this interface is very easy to fuzz, and doesn&#x27;t need to be sophisticated or heavily optimized.  Compared to what it&#x27;s replacing (a confused mix of interfaces developed over decades), I think it&#x27;s very probable that the reduced attack surface in 10 years when distros can start configuring out the IOCTLs far exceeds that added by this interface.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890529"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 2:13 UTC (Thu)
                               by <b>anonymous_commenter</b> (guest, #117657)
                              [<a href="/Articles/890529/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Amen to your statistics, that reminds me of some articles on disk failure rate that Valerie Aurora worked on (which one, don’t remember exactly but here’s the list: <a href="https://lwn.net/Archives/GuestIndex/#Aurora_Henson_Valerie">https://lwn.net/Archives/GuestIndex/#Aurora_Henson_Valerie</a> ) and also, process monitors on one of my computers (a laptop).<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890529/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor890563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 10:37 UTC (Thu)
                               by <b>Kamiccolo</b> (subscriber, #95159)
                              [<a href="/Articles/890563/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
$ time lsof &gt; /dev/null<br>
<p>
real	0m12.425s<br>
user	0m1.496s<br>
sys	0m1.544s<br>
<p>
oh well...<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890655"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 21:03 UTC (Thu)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/890655/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See the wild difference between realtime and usertime + systime?  Is your system under heavy CPU load, or is the number of syscalls required for lsof causing the scheduler to keep sleeping the process uneccessarily?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890655/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890680"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2022 5:45 UTC (Fri)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/890680/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the difference is because lsof resolves hostnames by default. I got into a habit of running lsof -n for that reason.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890680/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2022 23:42 UTC (Fri)
                               by <b>HenrikH</b> (subscriber, #31152)
                              [<a href="/Articles/890784/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you are quite correct:<br>
<p>
henrik@Sineya:~$ time lsof &gt; /dev/null<br>
real	0m8,932s<br>
user	0m1,899s<br>
sys	0m1,497s<br>
<p>
henrik@Sineya:~$ time lsof -n &gt; /dev/null<br>
real	0m3,276s<br>
user	0m1,834s<br>
sys	0m1,387s<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor890626"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 14:21 UTC (Thu)
                               by <b>Hello71</b> (subscriber, #103412)
                              [<a href="/Articles/890626/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; cpu frequencies are locked at 800 mHz</font><br>
<p>
have you checked that this actually reduces battery usage? it has been the goal of Linux schedulers for quite some time to use the fastest reasonably-efficient speed available to complete a given task, then drop to a deep power-saving level. &quot;off&quot; uses so much less power than &quot;800 mHz&quot; (sic) that it saves energy significantly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890626/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 21:01 UTC (Thu)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/890654/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I didn&#x27;t actually &#x27;lock&#x27; them to that frequency: just the cpufreq governor to maximize power saving. <br>
<p>
I should note that I think the schedulers could use some fine-tuning on this, actually: I understand there is a latency (and accompanying power consumption) going from (say) C10 to C0, so it&#x27;d make sense to completely stop using some cores, but that isn&#x27;t what happens, based on what I see in Powertop: every core sees some use.   Of course, I don&#x27;t actually know what the most efficent thing is: just an observation from my machine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor891215"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2022 15:06 UTC (Wed)
                               by <b>metan</b> (subscriber, #74107)
                              [<a href="/Articles/891215/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I did have a look at the lsof code when this patchset has been discussed and as far as I can tell significant part of the overhead is caused by the fact that it uses FILE interface to parse single value proc files instead of much simpler open()/read()/close(). I bet that we can make it twice as fast without any kernel changes...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/891215/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor891466"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2022 14:55 UTC (Fri)
                               by <b>mrugiero</b> (guest, #153040)
                              [<a href="/Articles/891466/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I did have a look at the lsof code when this patchset has been discussed and as far as I can tell significant part of the overhead is caused by the fact that it uses FILE interface to parse single value proc files instead of much simpler open()/read()/close(). I bet that we can make it twice as fast without any kernel changes...</font><br>
<p>
Considering it already needs OS specific calls, that&#x27;s certainly some low-hanging fruit. Even if it didn&#x27;t, the odd one out in terms of having open/read/close as first class citizens is Windows, and I&#x27;m not even sure lsof runs there. I think that&#x27;s a good catch :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/891466/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor890536"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 4:02 UTC (Thu)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/890536/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This reminds me that tools to monitor hardware sensors; temperature, fan speed etc tend to run `sensors` once per second. Is there a way for them to instead stream sensor data from the Linux kernel?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890536/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890537"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 4:42 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/890537/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The information is available in sysfs so they can just read that directly rather than parse the output of sensors, but most motherboard sensor hardware doesn&#x27;t have any interrupt support so streaming from the kernel would just mean the kernel polling instead of userland polling. I guess there&#x27;s potentially a small performance benefit in the kernel polling with a reasonable amount of timer slack and only waking userland if a value has changed, but that doesn&#x27;t seem like a huge benefit tbh.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890537/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890541"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 6:09 UTC (Thu)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/890541/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A good middle ground is using libsensors. It will give the benefits of userspace (stable sensor names, labeling and applying arithmetic to correct readings) without overhead of exec, fork and config file parsing each time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890541/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890677"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2022 4:23 UTC (Fri)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/890677/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are there any daemons that do this already?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890677/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890886"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 11, 2022 10:57 UTC (Mon)
                               by <b>sur5r</b> (subscriber, #61490)
                              [<a href="/Articles/890886/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
collectd using the sensors plugin comes to mind.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890886/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor890544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 6:27 UTC (Thu)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/890544/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
/proc would be rejected today if sent for inclusion on speed reasons alone.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor892405"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2022 3:05 UTC (Sat)
                               by <b>cody_schafer</b> (guest, #85326)
                              [<a href="/Articles/892405/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps, though sysfs would need to be similarly rejected. And it&#x27;s use is still growing.<br>
<p>
The &quot;virtual file with 1 plain text value&quot; model only really works very well for folks writing shell scripts, and breaks down otherwise. There are also repeated issues in sysfs where it&#x27;s very difficult to decide what type of &quot;thing&quot; some directory represents because of how it lays out attributes.<br>
<p>
It&#x27;s clear that some nested key-value store is useful as a operating system API, and nested key-value store _is_ what the filesystem model is supposed to be. So it feels like improving the system call interface here to reduce overhead could be useful. Though perhaps some rethinking of the posix filesystem API also could make sense (transactions?)<br>
<p>
Alternates might include leaning towards an RPC style interface, but that seems like we&#x27;d be reimplementing open/close/read/write on top of a stream like protocol. This _might_ make the efficiency better given syscall overhead though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/892405/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor890546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 6:51 UTC (Thu)
                               by <b>tlamp</b> (subscriber, #108540)
                              [<a href="/Articles/890546/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
       <code>perf stat lsof</code> on my (quite active) workstation here:

<pre>
 Performance counter stats for 'lsof':

         24.013,25 msec task-clock                #    0,308 CPUs utilized          
         2.569.794      context-switches          #  107,016 K/sec                  
             1.474      cpu-migrations            #   61,383 /sec                   
            87.247      page-faults               #    3,633 K/sec                  
   106.298.004.008      cycles                    #    4,427 GHz                      (74,83%)
   136.488.994.248      instructions              #    1,28  insn per cycle           (75,31%)
    32.366.388.743      branches                  #    1,348 G/sec                    (74,98%)
       257.065.097      branch-misses             #    0,79% of all branches          (74,88%)

      78,066150910 seconds time elapsed

       9,366655000 seconds user
      19,249239000 seconds sys
</pre>

fwiw, lsof outputs 1072596 lines.

So, if there would be some more performant way to do this, I'd definitively look forward to it..




      
          <div class="CommentReplyButton">
            <form action="/Articles/890546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor890554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 8:46 UTC (Thu)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/890554/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I get figures in the same ballpark when not redirecting similarly-sized output, despite the terminal being in limited scrolling mode with 1K lines of scrollback - the running time is further nearly doubled or so when serializing the whole terminal scrollback to a SSD.<br>
The run time for lsof is less bad when piping the output to `wc -l`, but still not blazing fast, and shows more sys time than usr time here as well:
<pre>perf stat lsof | wc -l
lsof: WARNING: can't stat() fuse.portal file system /run/user/1000/doc
      Output information may be incomplete.

 Performance counter stats for 'lsof':

         16 993,59 msec task-clock                #    0,947 CPUs utilized          
            44 362      context-switches          #    2,611 K/sec                  
                 9      cpu-migrations            #    0,530 /sec                   
           103 592      page-faults               #    6,096 K/sec                  
    62 601 134 626      cycles                    #    3,684 GHz                    
   117 648 197 174      instructions              #    1,88  insn per cycle         
    31 922 541 769      branches                  #    1,879 G/sec                  
       139 279 693      branch-misses             #    0,44% of all branches        

      17,953006430 seconds time elapsed

       6,730828000 seconds user
      10,358977000 seconds sys


1243951</pre>


      
          <div class="CommentReplyButton">
            <form action="/Articles/890554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor890570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2022 11:47 UTC (Thu)
                               by <b>jschrod</b> (subscriber, #1646)
                              [<a href="/Articles/890570/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I don't have perf installed on my workstation, but system time needed for lsof is even longer:
<pre>
time /bin/bash -c 'lsof | wc -l'
521342

real    0m25.253s
user    0m10.128s
sys     0m21.455s
</pre>
This workstation has 2 Intel Xeon E5-2603 v4 CPUs, and 128 GiB memory.



      
          <div class="CommentReplyButton">
            <form action="/Articles/890570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor890828"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gathering multiple system parameters in a single call</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2022 19:05 UTC (Sat)
                               by <b>judas_iscariote</b> (guest, #47386)
                              [<a href="/Articles/890828/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is a system call for getting the current directory, all sorts of obscure and obsolete ones.. but anything actually useful is off-limits and must be done writting a large amount of buggy, slow, racy code for parsing and dealing with /proc /sys /dev because reasons, or  provided as an ioctl, fnctl or interfaces with a lot of baggage like open with O_TMPFILE instead of a sanely designed tmpfd syscall. the list goes on and on.. the end result of this ain&#x27;t nice or is often useless.<br>
<p>
 <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/890828/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
