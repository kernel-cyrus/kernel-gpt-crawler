        <!DOCTYPE html>
        <html lang="en">
        <head><title>Fun with NULL pointers, part 2 [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/342420/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/341621/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/342420/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Fun with NULL pointers, part 2</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 21, 2009</br>
           </div>
<a href="http://lwn.net/Articles/342330/">Fun with NULL pointers, part
1</a> took a detailed look at the long chain of failures which allowed the
kernel to be compromised by way of a NULL pointer dereference.  Eliminating
that particular bug was a straightforward fix; it was, in fact, fixed
before the nature of the vulnerability was widely understood.
The importance of this particular problem is, in one sense,
relatively small; there are very few distributions which shipped vulnerable
versions of the kernel.  But this exploit suggests that there could be a
whole class of related problems in the kernel; there is a definite chance
that similar vulnerabilities could be discovered - if, indeed, they have
not already been found.
<p>
One obvious problem is that <strike> when the security module mechanism is
configured into the kernel, the administrator-specified limits on the
lowest valid user-space virtual address are ignored</strike>
security modules are allowed to override the administrator-specified limit
(<tt>mmap_min_addr</tt>)
on the lowest valid user-space address.  This behavior is a
violation of the understanding by which security modules operate: they are
supposed to be able to restrict privileges, but never increase them.  In
this case, the mere presence of SELinux increased
privilege, and the policy enforced by most SELinux deployments failed to
close that hole (comments in the exploit code suggest that AppArmor fared
no better).  
<P>
Additionally, with security modules configured out entirely,
<tt>mmap_min_addr</tt> was not enforced at all.
The mainline now has a patch which causes the
<tt>map_min_addr</tt> sysctl knob to always be in effect; this patch has
also been put into the 2.6.27.27 and 2.6.30.2 updates (as have many of the
others described here).
<p>
Things are also <a
href="http://blog.namei.org/2009/07/18/a-brief-note-on-the-2630-kernel-null-pointer-vulnerability/">being
fixed at the SELinux level</a>.  Future versions of Red Hat's SELinux
policy will no longer allow unconfined (but otherwise unprivileged)
processes to map pages into the bottom of the address space.  There are <a
href="http://lwn.net/Articles/342573/">still some open problems</a>, though,
especially when programs like WINE are thrown into the mix.  It's not yet
clear how the system can securely support a small number of programs
needing the ability to map the zero page.  Ideas like running WINE with root
privilege - thus, perhaps, carrying Windows-like behavior a little too far
- have garnered little enthusiasm.

<p>
There is another way around <tt>map_min_addr</tt> which also must be
addressed: a privileged 
process which is run under the SVR4 personality will, at <tt>exec()</tt>
time, have a read-only page mapped at the zero address.  Evidently some old
SVR4 programs expect that page to be there, but its presence helps to make
null-pointer exploits possible.  So another patch merged into mainline and
the stable updates resets the SVR4 personality (or, at least, the part that
maps the zero page) whenever a setuid program is run.  This patch is enough
to defeat the pulseaudio-based trick which was used to gain access to a
zero-mapped page.
<p>
This change is not enough for some users, who have <a
href="/Articles/342425/">requested</a> the ability to turn off the
personality feature altogether.  The ability to run binaries from 386-based
Unix systems just lacks the importance it had in, say, 1995, so some
question whether the personality feature makes any sense given its costs.
Linus <a href="/Articles/342427/">answered</a>:
<p>
<div class="BigQuote">
	We could probably get rid of that idiotic feature. It's simply not
	important enough any more. Does anybody really care? At the same
	time, over years we've grown _other_ personality flags, and some of
	them are still relevant.
</div>
<p>
In particular, it seems that the ability to disable address-space
randomization (which is a personality feature) is useful in a number of
situations.  So <tt>personality()</tt> is likely to stay, but its zero-page
mapping feature might go away.

<p>
Yet another link in the chain of failure is the removal of the null-pointer
check by the compiler.  This check would have stopped the attack, but GCC
optimized it out on the theory that the pointer could not (by virtue of
already having been dereferenced) be NULL.  GCC (naturally) has a
flag which disables that particular optimization; so, from now on, kernels
will, by default, be compiled with the
<tt>-fno-delete-null-pointer-checks</tt> flag.  Given that NULL might truly
be a valid pointer value in the kernel, it probably makes sense to disable
this particular optimization indefinitely.
<p>
One could well argue, though, that while all of the above changes are good,
they also partly miss the point: a quality kernel would not be
dereferencing NULL pointers in the first place.  It's those dereferences
which are the real bug, so they should really be the place where the
problem is fixed.  There is some interesting history here, though, in that
kernel developers have often <a
href="http://lkml.org/lkml/2008/2/1/74">been</a> <a
href="http://lkml.org/lkml/2008/2/13/71">advised</a> to omit checks for
NULL pointers.  In particular, code like:
<p>
<pre>
    BUG_ON(some_pointer == NULL);
    /* dereference some_pointer */
</pre>
<p>
has often seen the <tt>BUG_ON()</tt> line removed with a comment like:
<p>
<div class="BigQuote">
	If we dereference NULL then the kernel will display basically the
	same information as would a BUG, and it takes the same action.  So
	adding a BUG_ON here really doesn't gain us anything.
</div>
<p>
This reasoning is based on the idea that dereferencing a NULL pointer will
cause a kernel oops.  On its face, it makes sense: if the hardware will
detect a NULL-pointer dereference, there is little point in adding the
overhead of a software check too. 
But that reasoning is demonstrably faulty, as shown by
this exploit.  There are even legitimate reasons for mapping page zero, so
it will never be true that a NULL pointer is necessarily invalid.  One
assumes that the relevant developers understand this now, but there may be
a lot of places in the kernel where necessary pointer checks were removed
from the code.
<p>
Most of the NULL pointer problems in the kernel are probably just
oversights, though.  Most of those, in turn, are not exploitable; if there
is no way to cause the kernel to actually encounter a NULL pointer in the
relevant code, the lack of a check does not change anything.  Still, it
would be nice to fix all of those up.
<p>
One way of finding these problems may be the <a
href="http://smatch.sourceforge.net/">Smatch</a> static analysis tool.
Smatch went quiet for some years, but it appears that Dan Carpenter is
working on it again; he recently posted <a href="/Articles/342439/">a NULL
pointer bug</a> that Smatch found for him.  If Smatch could be turned into
a general-purpose tool that could find this sort of problem, the result should
be a more secure kernel.  It is unfortunate that checkers like this do not
seem to attract very many interested developers; free software is very much
behind the state of the art in this area and it hurts us.
<p>
Another approach is being taken by Julia Lawall, who has put together a <a
href="http://lwn.net/Articles/315686/">Coccinelle</a> "semantic patch" to
find and fix check-after-dereference bugs like the one found in the TUN
driver.  A series of patches (<a href="/Articles/342440/">example</a>) has
been posted to fix a number of these bugs.  Cases where a pointer is
checked after the first dereference are probably a small subset of all the
NULL pointer problems in the kernel, but each one indicates a situation
where the programmer thought that a NULL pointer was possible and
problematic.  So they are all certainly worth fixing.
<p>
All told, the posting of this exploit has served as a sort of wakeup call
for the kernel community; it will, with luck, result in the cleaning up of
a lot of code and the closing of a number of security problems.  Brad
Spengler, the author of the exploit, is clearly hoping for a little more,
though: he has often expressed concerns that serious kernel security bugs
are silently fixed or dismissed as being denial-of-service problems at
worst.  Whether that will change remains to be seen; in the kernel
environment, many bugs can have security implications which are not
immediately obvious when the bug is fixed.  So we may not see more bugs
explicitly advertised as security issues, but, with luck, we will see more
bugs fixed.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Vulnerabilities">Security/Vulnerabilities</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel">Linux kernel</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Vulnerabilities-Privilege_escalation">Vulnerabilities/Privilege escalation</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/342420/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor342679"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 21:31 UTC (Tue)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/342679/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"One assumes that the relevant developers understand this now, but there may be a lot of places in the kernel where necessary pointer checks were removed from the code."<br>
<p>
I wouldn't be so sure: those mails you link to are from 2008;  we had gone through the whole "NULL pointer dereferences can be exploitable" thing back in 2007 when I released my first exploit.<br>
<p>
But I hope you're right ;)<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342679/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342694"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 21:50 UTC (Tue)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/342694/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No.  BUG_ON(ptr == NULL) is generally a bad idea because it is fixing<br>
a problem in the wrong place.  Leading to maintenance problems etc.<br>
<p>
In some common places like sysfs where the are a lot of users and mistakes are common because of the volume of use of the interface it makes sense.<br>
<p>
In general it is better to simply make it impossible for a NULL pointer<br>
to reach someplace.  Or to handle that NULL pointer dereference.<br>
<p>
Checking for the impossible just makes the code harder to understand.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342694/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342699"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 21:53 UTC (Tue)
                               by <b>eparis</b> (guest, #33060)
                              [<a href="/Articles/342699/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Clearly you never make mistakes, but when Herbert Xu does, I think it proves that any of us mere mortals can.  Writing code defensively is clearly a good idea and one I think all of us should embrace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342699/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 22:11 UTC (Tue)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/342704/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As best I can tell Herbert badly resolved a merge between my changes<br>
to tun.c and his changes to tun.c, and simply had not realized how much<br>
I had changed tun.c.<br>
<p>
As for writing code defensively.  Doing that routinely doubles your number of bugs.<br>
<p>
You have the wrong input should never have been generated in the first place.<br>
<p>
You have the wrong BUG_ON in the function.<br>
<p>
Bugs per line of code are roughly constant.  Therefore you want a design<br>
that uses fewer lines of code.<br>
<p>
What made all of this interesting is the fact someone found a way around the defensive measure of mmap_min_addr.<br>
<p>
Eric<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342765"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 7:01 UTC (Wed)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/342765/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; What made all of this interesting is the fact someone found a way around the defensive measure of mmap_min_addr.</font><br>
<p>
It's not at all interesting because any feature which is *designed* to be circumventible will be, well, circumvented. From day one it was obvious and publicly discussed that exploit writers would go after the needed capability (that assuming they don't have better bugs to exploit not needing it ;).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342765/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342781"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 9:10 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/342781/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
You have the wrong input should never have been generated in the first place.
<p>
You have the wrong BUG_ON in the function.
<p>
Bugs per line of code are roughly constant. Therefore you want a design
that uses fewer lines of code.</blockquote>Adding the null pointer check does not cause the first bug you mention, although it may help to reveal it.  The second item is a coding style issue, not a bug (and your logic is circular; you try to show that adding the BUG_ON is a bad idea, so you cannot assume that in your argument).  The third assertion needs some evidence, and even if true cannot be used to show that adding any particular line of code introduces a bug, any more than you could use it to justify removing one particular line of code from the middle of your program.  (It is sometimes the case that adding overzealous error checking introduces a bug, but that needs to be shown in each individual case, and you haven't shown it here.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/342781/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are you an idiot or just play one or TV?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 5:35 UTC (Thu)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/342969/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>It's not even funny: you are discussing one particular function in 
<b>it's current incarnation</b> where Eric discusses the whole 
approach.</p>

<blockquote>Adding the null pointer check does not cause the first bug you 
mention, although it may help to reveal it.</blockquote>

<p>But it can crash the perfectly working system tomorrow after some kind 
of refactoring.</p>

<blockquote>The second item is a coding style issue, not a bug (and your 
logic is circular; you try to show that adding the BUG_ON is a bad idea, so 
you cannot assume that in your argument).</blockquote>

<p>Today human mistakes are promoted to "code style issue"? News to 
me...</p>

<blockquote>The third assertion needs some evidence, and even if true 
cannot be used to show that adding any particular line of code introduces a 
bug</blockquote>

<p>There were a lot of investigations. Number of bugs per line of code does 
not change too much when you switch languages, paradigms, etc. It reduces 
if you do a lot of rafactoring (like kernel developers do) and srinks when 
you are using different autodetection tools (which are they using too), 
this change is pretty limited. It'll be somewhat strange to see that BUG_ON  
is somehow 100 times less buggy then the rest of the code.</p>

<blockquote> any more than you could use it to justify removing one 
particular line of code from the middle of your program.</blockquote>

<p>Yup. Justification is the same as for the rest of code: if you function 
will continue to work - why have this line in first place? Redundant 
comments can be kept around, but actual line of code? Please - a lot of 
stuff kernel developers are doing is this exact "removal lines of code from 
the middle of your program".</p>

<blockquote>(It is sometimes the case that adding overzealous error 
checking introduces a bug, but that needs to be shown in each individual 
case, and you haven't shown it here.)</blockquote>

<p>And now sound almost adequately. If sometimes overzealous error checking 
introduces a bug then it's good idea to <b>keep it out</b> of program: 
asserts, coverity, etc. These things can detect bug but they can not 
introduce new bug (false positive is not a bug as it's not compiled in 
actual kernel).</p>

<p>Defensive programming makes sense when you suspect other code has lower 
quality (userspace, drivers for obscure devices, etc), but to try to 
protect code from code of equal quality with so-called "defensive 
programming" is to increase number of bugs!</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/342969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor343000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are you an idiot or just play one or TV?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 11:15 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/343000/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Why yes, I was talking about this particular case.  Doing a null pointer check earlier (whether with BUG_ON(x==NULL) or some other test) would have avoided a local root exploit in this one case.  That suggests that the whole approach is not completely useless, even if in other cases it doesn't help.
<p>
I am not arguing for 'defensive programming' as sometimes practised, where you cruft up the code with workarounds to silently return or do something random if a caller is buggy.  That tends to hide bugs and thus cause buggier software in the long run.  (Although even this kind of defensive programming can occasionally be useful, for example in safety-critical systems where the code must keep running no matter what.)
<blockquote>There were a lot of investigations. Number of bugs per line of code does not change too much when you switch languages, paradigms, etc.</blockquote>That is quite true but you cannot reason as follows: on average, more lines of code means more bugs, therefore an average 101-line program is buggier than an average 100-line program, therefore adding *this particular line of code* to *this particular* program is likely to cause a bug!  Of course it depends on the individual case!  Some kinds of code such as assertions (runtime checking) and type annotation (compile-time checking) exist only to catch bugs, and it doesn't make sense to say that adding them will tend to make code buggier just based on a general rule about lines of code.
<p>
An incorrect BUG_ON(x==NULL) certainly can introduce a bug into a program, but then an incorrect anything can introduce a bug.
      
          <div class="CommentReplyButton">
            <form action="/Articles/343000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor343043"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">+1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 14:57 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/343043/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
+1, for sanity.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/343043/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor343011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 12:27 UTC (Thu)
                               by <b>ortalo</b> (guest, #4654)
                              [<a href="/Articles/343011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't you think a static checker could benefit from BUG_ON()-like information (or ASSERT() or whatever you want to name it) by using the given check/assumption for code analysis.<br>
 In this case, the additional line is more an annotation (like those many static checkers introduce) than source code.<br>
As a developper you may legitimately want that such annotations be placed elsewhere than in the middle of code, but then where would you like to place them?<br>
<p>
Side note: I really do not buy the constant number_of_fault/loc assumption. But well... that's another debate; and anyway IMHO your argument with respect to code readability and maintanability is totally valid.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/343011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor342726"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 23:32 UTC (Tue)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/342726/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Besides, depending on the platform the compiler could elide the BUG_ON(ptr == NULL) anyway, no? It's often just

<pre>
if (unlikely(ptr == NULL))
    out_of_line_bug();
</pre>

or something like that?
      
          <div class="CommentReplyButton">
            <form action="/Articles/342726/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342752"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 4:12 UTC (Wed)
                               by <b>gmaxwell</b> (guest, #30048)
                              [<a href="/Articles/342752/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
Yes, if the compiler can prove that its impossible for the condition to be true it can and will omit the check.  Sadly because the compiler's visibility is so narrow it usually can't do this except in the most obvious of situations.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342752/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 9:53 UTC (Wed)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/342784/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, for most architectures the BUG() functions are __attribute__((noreturn)) or something equivalent. So the compiler cannot assume that the execution flow reaches to after the if (!ptr) check at all, if ptr is NULL. So it should not optimize it out in that case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342798"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 11:23 UTC (Wed)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/342798/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Really? I thought the out_of_line_bug() in my example would have that attribute, but not the BUG() itself. But powerpc for example is different though, it just inserts a trap (twi or such).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342798/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor346497"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2009 18:50 UTC (Tue)
                               by <b>bdonlan</b> (guest, #51264)
                              [<a href="/Articles/346497/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
BUG_ON doesn't fix a problem - it complains about one. It's a bit like <br>
assert(!condition) in userspace - if you actually hit it, the program's <br>
already doomed. The Linux kernel tries to keep going a bit, just because it's <br>
difficult to get debug information after a panic, but this is _not_ fixing a <br>
problem, and a tripped BUG_ON is _by definition_ a bug.<br>
<p>
As such, the only disadvantage to extra BUG_ONs is the run-time overhead from <br>
them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/346497/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor342676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 21:35 UTC (Tue)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/342676/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; has often seen the BUG_ON() line removed with a comment like:</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    If we dereference NULL then the kernel will display basically the same </font><br>
<font class="QuotedText">&gt;    information as would a BUG, and it takes the same action. So adding a </font><br>
<font class="QuotedText">&gt;    BUG_ON here really doesn't gain us anything.</font><br>
&gt;<br>
<font class="QuotedText">&gt; This reasoning is based on the idea that dereferencing a NULL pointer</font><br>
<font class="QuotedText">&gt; will cause a kernel oops.</font><br>
<p>
For the Smack example, if you read the code it's clear that the BUG_ON check makes no sense. It is in a static function and all callers either check or dereference the pointer. More generically, adding BUG_ONs everywhere for pointers that shouldn't be NULL is the wrong approach: Either make sure that all callers don't pass in a NULL pointer, or if that isn't possible, add a check and return with an error.<br>
<p>
For the other example the kernel better make that it notices it when it's NULL, one way or the other.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342782"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 9:15 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/342782/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>Either make sure that all callers don't pass in a NULL pointer, or if that isn't possible, add a check and return with an error.</blockquote>Suppose you take the first option; you check all the code that could call your routine and make sure NULL is never passed.  Then there is no need for a runtime check, right?  In theory this is true but I know I make mistakes, so even after checking all the code I would still put in the check for this 'impossible condition' to stop a small oversight causing a big problem.
<p>
It's the same argument for any assertion you put in your code: since they are checking for something that can never ever happen, why bother with them at all?  All programmers make mistakes, but the better ones are aware of this fact and take appropriate measures.
<p>
(This is not an argument for sloppy 'defensive programming' as sometimes practised, where you insert code to silently return the wrong answer or do something random if the inputs aren't as you expect.  You want a macro like BUG_ON or assert() which loudly announces the problem, not hides it.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/342782/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342788"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 10:19 UTC (Wed)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/342788/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Making sure that a pointer is never NULL is easy when it is passed to a static function. For public functions it is harder and more checks are needed, but if all callers are limited to one directory it's still not hard.<br>
<p>
If you pass along a pointer and say "hey, do something with this", in general that code did something with it before, otherwise the second function could be called directly.<br>
<p>
For pointers within structures it's much harder though, then it helps to have clean code with clear lifetime rules. If it's messy enough you can make things more messy by adding NULL checks everywhere. If this adds more unexpected error paths then it's not a good way forwards though. If it's unclear if something can be NULL or not then in the long term it's much better to clean up the code. Like assertions BUG_ON is good while developing a new piece of code to make sure all assumptions hold. When the code gets more into shape and becomes more stable there should be not much need for such checks anymore.<br>
<p>
An exception is low level library like code which can be used by many users and which wants to prevent them making the same bloody mistakes. It's also a good way to prevent corruptions from spreading around.<br>
<p>
The further away the code giving the input is from the code using it the more checking is necessary.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342788/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342792"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 11:14 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/342792/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>Making sure that a pointer is never NULL is easy when it is passed to a static function. For public functions it is harder and more checks are needed, but if all callers are limited to one directory it's still not hard.</blockquote>It's not hard, but I know that I am able to make mistakes on even the simplest tasks.  I also know that I am not quite the world's worst programmer or the most careless, so if I can screw up, others can too.  That's why even after you have carefully gone through the code and made sure that 'obviously', NULL can never be passed, it is still a good idea to include a check just in case, to stop a minor oversight becoming a major bug (such as the root exploit discussed in the article).
<p>
The best option is for the compiler to statically ensure non-null pointers; tools like <a href="http://splint.org/">Splint</a> let you be certain that getting null is impossible.
<blockquote>If it's unclear if something can be NULL or not then in the long term it's much better to clean up the code.</blockquote>Absolutely agreed.  If it's unclear whether NULL is allowed, then BUG_ON(x==NULL) is not the right way, except as a temporary debugging aid.  You need to check the code and make a decision - can NULL ever legally be passed here?  If the answer is no, then you should make sure all the callers are behaving properly - but then when you've finished put in the BUG_ON check anyway, because even Linus makes mistakes.

      
          <div class="CommentReplyButton">
            <form action="/Articles/342792/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor342813"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 13:25 UTC (Wed)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/342813/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looks like a variation of the "end to end principle" (<a href="http://en.wikipedia.org/wiki/End-to-end_principle">http://en.wikipedia.org/wiki/End-to-end_principle</a>). No matter that callers check for NULL, the callee has still to check it, again.<br>
<p>
Also, as someone has pointed out, NULL is just *one* invalid pointer value (even if a common one). The kernel should better be testing to prevent pointers to user space, except when needed. <br>
<p>
I don't know enough Linux internals. Should it be possible to make those tests with some memory protection trickery?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342813/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 16:03 UTC (Wed)
                               by <b>brianomahoney</b> (guest, #6206)
                              [<a href="/Articles/342848/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Add more checks of all types, we all make mistakes is pure nonsense, it will make the kernel slow and fat, with no real improvement in reliability. it is the mark of a confused and poor programmer who has no sense of design and debugging kernel code.<br>
<p>
This bug happened because the author wrote patently idiotic code, using a pointer and THEN checking it. This code, and all others like it need to be fixed so it actually does what it is intended to do. We do not need the kernel full of ah, well, but checks and other kruft.<br>
<p>
The secondary, and very worrying thing is GCC silently dropping the check, we do not need optimizations like that without a STRONG warning, but I guess the motivations of the GCC developers are different here, and they really cannot win, there is constant pressure to improve compiled code and not to introduce more baby-minding warnings.<br>
<p>
Perhaps COVERTY can help here, but we need more and better analysis, and focused bug-fixing bu good developers not the injection of confused well meaning tests.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342940"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 23:26 UTC (Wed)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/342940/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This bug happened because the author wrote patently idiotic code, using a pointer and THEN checking it.</font><br>
<p>
My understanding was that two people worked on the same code and that this was a result of a bad merge, though I could be confusing this with another case.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342940/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342988"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 8:09 UTC (Thu)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/342988/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except that the kernel is not designed, it evolves. Linus has pointed it out several times. At most, some features are initially designed, but from there on, it's all evolution. <br>
<p>
Maybe you write perfectly designed code that works wonderfully and will never need an update, fix or improvement. I centainly don't. I make mistakes, that's why my code is full of assertions, and I try to manage impossible situations in a sane way, just in case.<br>
<p>
With regards to fat and slow... Any check can be made optional, by simply putting it between a pair of #ifdefs. Maybe somebody will apreciate a more rugged, even if slower kernel for certain servers that are exposed to the outside World. An important point would be to measure how much slower that kernel would be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342988/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor342683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 21:36 UTC (Tue)
                               by <b>christian.convey</b> (guest, #39159)
                              [<a href="/Articles/342683/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn't Coverity already scan the kernel periodically for this kind of thing?  (scan.coverity.com)<br>
<p>
If so, how was this missed?  Did one someone intentionally tell Coverity to ignore the warning about checking for a NULL *after* referencing it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342775"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 8:47 UTC (Wed)
                               by <b>msmeissn</b> (subscriber, #13641)
                              [<a href="/Articles/342775/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, Coverity scans the kernel.<br>
<p>
They issued a press release that they found the issue (REVERSE_INULL I <br>
would guess).<br>
<p>
Just someone needs to read and investigate all the reports, and<br>
its quite an amount and not so funny work.<br>
<p>
Ciao, Marcus<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342775/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342805"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 12:13 UTC (Wed)
                               by <b>nick.lowe</b> (guest, #54609)
                              [<a href="/Articles/342805/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="http://blog.coverity.com/posts/general/would-you-like-to-know-about-0day-defects-months-in-advance">http://blog.coverity.com/posts/general/would-you-like-to-...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342805/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342809"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 12:51 UTC (Wed)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/342809/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Now that the blog was posted, I can mention that the tun.c bug was found by Coverity months ago and reported, but it went unfixed.<br>
<p>
Couple that with the information from this study:<br>
<a href="http://www.usenix.org/events/usenix09/tech/full_papers/guo/guo_html/index.html">http://www.usenix.org/events/usenix09/tech/full_papers/gu...</a><br>
<p>
that 40% of the issues reported by the static checkers aren't being triaged.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342809/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342912"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 20:52 UTC (Wed)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/342912/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is the information that the checker produces actually getting to the developers that can do something about it?<br>
<p>
That seems to be a valid question...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342912/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342913"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 21:04 UTC (Wed)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/342913/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
this is actually a very interesting presentation. videos are available at <br>
<a href="http://www.usenix.org/events/usenix09/tech/">http://www.usenix.org/events/usenix09/tech/</a> (I believe they are available to everyone, not just usenix members, please let me know if that is not the case)<br>
<p>
<p>
there are a number of trends (not very surprising in retrospect)<br>
<p>
if you have a false positive, the chances of anyone paying attention to further reports in that section of the code drop drasticly.<br>
<p>
if you have a maintainer who looks at one report, the chances of them dealing with all of them in that area go up significantly<br>
<p>
if a fix is produced as a result of a report, the chances of all the reports for a given area being looked at and fixed go up drasticly<br>
<p>
if there is not an active maintainer of that section of code the chances of the reports being looked at go down drasticly.<br>
<p>
a large percentage of real bugs and vunerabilities have had reports on that section of the code (note that this is _not_ the same thing as saying that a large percentage of reports have been found to cause real bugs and vunerabilities)<br>
<p>
there is a significant push from kernel developers to avoid rushing to clean up the code to silence the warnings, there is a large enough correlation between these reports and more significant bugs that many of them want the entire section where reports are found to be examined, there is a significant chance that there is a more significant and subtle bug lurking in that area.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342913/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 2:36 UTC (Thu)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/342956/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The videos require being a USENIX member.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor342681"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Incorrect statements:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 21:37 UTC (Tue)
                               by <b>eparis</b> (guest, #33060)
                              [<a href="/Articles/342681/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"One obvious problem is that, when the security module mechanism is configured into the kernel, the administrator-specified limits on the lowest valid user-space virtual address are ignored."<br>
<p>
WRONG.  Flat wrong.  There are differences in what is/was required when using SELinux and not using SELinux, but it was never ignored.<br>
<p>
"The mainline now has a patch which causes the map_min_addr sysctl knob to always be in effect; this patch has also been put into the 2.6.27.27 and 2.6.30.2 updates"<br>
<p>
This is true, but wrong in context.  The knob causes mmap_min_addr to be applied with !CONFIG_SECURITY.  But the whole paragraph was about having it set....<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342681/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Incorrect statements:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 22:06 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/342701/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Hmm, I misread the patch and blew it.  Not the first  time.  The text has been tweaked somewhat and is hopefully less fictional now; sorry for the confusion.
      
          <div class="CommentReplyButton">
            <form action="/Articles/342701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342721"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Incorrect statements:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 23:12 UTC (Tue)
                               by <b>eparis</b> (guest, #33060)
                              [<a href="/Articles/342721/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Less fictional (but I still wouldn't call it perfect) *smile*<br>
<p>
I did try to specifically address the issue of the differences between SELinux and non-SELinux mmap_min_addr use in a blog I created today.<br>
<p>
<a href="http://eparis.livejournal.com/606.html">http://eparis.livejournal.com/606.html</a><br>
<p>
From the point of view of an authenticated and logged in user SELinux is doing a worse job and I clearly want to fix this.  From the point of view of a remote attack or in light of people who run dumb things (run wine), SELinux was taking a better approach.<br>
<p>
I'm hoping to fix those dumb things.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342721/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Incorrect statements:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 2:45 UTC (Thu)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/342957/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We have a word for those "dumb things" that grant more privilege than the system normally would: "vulnerability."  So where's the CVE?<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor342700"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 22:04 UTC (Tue)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/342700/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Presumably if a NULL pointer can be a valid pointer under certain circumstances then checks for NULL to determine invalid pointers would be wrong under the same circumstances, and the right thing would be to avoid using pointers which have not been initialised to their final value.  Note that gcc *can* spot and warn about that if the pointer is not initialised to NULL first.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342700/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342708"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 22:18 UTC (Tue)
                               by <b>sourcejedi</b> (guest, #45153)
                              [<a href="/Articles/342708/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, I don't think it is valid for kernel code to dereference NULL.  The reason being, it would be a __user address, which should be accessed using copy_from_user() or similar.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342708/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 23:01 UTC (Tue)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/342714/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That speaks for checking pointers against the user-kernel boundary rather than against NULL.  Slightly less efficient I know, but more effective defensively.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 11:50 UTC (Wed)
                               by <b>etienne_lorrain@yahoo.fr</b> (guest, #38022)
                              [<a href="/Articles/342801/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
 And the i386 has a very nice assembly instruction for that, which perfectly fits: "bound".<br>
The nice thing is that it is very short, and never mess with the jump instruction prediction subsystem because if not inside boundaries, an exception is generated.<br>
I just know one single software using that assembly instruction, and it works as intended.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342954"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 2:20 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/342954/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <a href="http://www.arl.wustl.edu/~lockwood/class/cs306/books/artofasm/Chapter_6/CH06-5.html#HEADING5-171">Not really all that nice:</a>

<blockquote><p>Intel's designers added the bound instruction to allow a quick check of the range of a value in a register. This is useful in Pascal, for example, which checking array bounds validity and when checking to see if a subrange integer is within an allowable range. There are two problems with this instruction, however. On 80486 and Pentium/586 processors, the bound instruction is generally slower than the sequence of instructions it would replace:
<pre>
     cmp     reg, LowerBound
     jl      OutOfBounds
     cmp     reg, UpperBound
     jg      OutOfBounds
</pre>
<p>
On the 80486 and Pentium/586 chips, the sequence above only requires four clock cycles assuming you can use the immediate addressing mode and the branches are not taken; the bound instruction requires 7-8 clock cycles under similar circumstances and also assuming the memory operands are in the cache.

A second problem with the bound instruction is that it executes an int 5 if the specified register is out of range. IBM, in their infinite wisdom, decided to use the int 5 interrupt handler routine to print the screen. Therefore, if you execute a bound instruction and the value is out of range, the system will, by default, print a copy of the screen to the printer. If you replace the default int 5 handler with one of your own, pressing the PrtSc key will transfer control to your bound instruction handler. Although there are ways around this problem, most people don't bother since the bound instruction is so slow.

</blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/342954/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342989"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2009 8:54 UTC (Thu)
                               by <b>etienne_lorrain@yahoo.fr</b> (guest, #38022)
                              [<a href="/Articles/342989/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
 Nowadays, if you are not in a tight loop written in assembly, you no more count the number of cycles of instructions but the amount of time it takes to load it into the layer 1 memory cache, and the time to reload the previous cache line after executing your instruction, it is basically proportional to the size of the instruction.<br>
 The two cmp solution needs 16 bytes (in protected mode) if the out-of-bound handler is within 256 bytes of the test, and 32 bytes if not: that is a complete cache line.<br>
 The bound solution needs 8 bytes, mostly because it does not encode the out-of-bound address handler.<br>
 The difference loading the other 24 bytes is a lot more significant than the 4 cycles difference.<br>
 Even the failed branch prediction you will probably get is more important - even the fact that you have polluted the branch prediction cache is probably more important.<br>
 The default INT5 screen print handler is not accessible under Linux, BIOS is not mapped and the APIC is configured differently, if I remember well you have a SIGBUS exception in user mode and something as easy to trap/abort in kernel mode.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342989/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor342728"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting blog</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2009 23:42 UTC (Tue)
                               by <b>jamesmrh</b> (guest, #31622)
                              [<a href="/Articles/342728/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Btw, someone has started posting security analysis of bugs which have been reported or fixed upstream:<br>
<p>
<a href="http://xorl.wordpress.com/">http://xorl.wordpress.com/</a><br>
<p>
I don't know who it is, but for anyone wanting to help in this area, please check it out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342728/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342730"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting blog</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 0:09 UTC (Wed)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/342730/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just posted a demo exploit for the SGI GRU vulnerability mentioned on the blog:<br>
<a href="http://grsecurity.net/~spender/exploit_demo.c">http://grsecurity.net/~spender/exploit_demo.c</a><br>
Total development time: 1 hour.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342730/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor342740"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 3:11 UTC (Wed)
                               by <b>bartoldeman</b> (guest, #4205)
                              [<a href="/Articles/342740/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The null page is only really *needed* for vm86() -- for 16-bit protected mode code an LDT with a constant non-zero base offset for all segments can be used and a pure 16-bit protected mode program (I think many use vm86() though!) that runs in Wine does not even know it.<br>
<p>
But for vm86() there is no easy and fast solution: every program that uses it (Wine, DOSEMU, X when it's been changed to run without root privs, a few others) will have to use CPU emulation. Now mapping the zero page needs CAP_SYS_RAWIO but that by itself is a much higher capability. That is, CAP_SYS_RAWIO allows direct I/O to hardware, surely giving root-like capabilities, even if the kernel is watertight. That way, one could argue for CAP_MAY_MAP_ZERO or something like that.<br>
<p>
A technical solution would be Brad's UDEREF, or the Linux 2.0 kernel method of using segment limits, where user space needs to be accessed via FS and there is no direct kernel address space via CS/DS/ES below 3GB (keep in mind, vm86() is i386 only) but those segment limits aren't so popular anymore and I'm not sure how they interact with modern virtualization environments.<br>
<p>
Another way would be to sandbox vm86() completely so it has the zero page,<br>
which can be alias-mapped elsewhere, accessible -- after all inside vm86() 16-bit code you can't do system calls. But that would mean to change the page protections on every vm86() call, exit, and also on every interrupt (unmap 0 as soon as possible as an IRQ happens to be effective). Too complex, I think.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342740/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342747"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 3:26 UTC (Wed)
                               by <b>bartoldeman</b> (guest, #4205)
                              [<a href="/Articles/342747/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Correction about Wine:<br>
<a href="http://www.nabble.com/Re%3A-vm86-mode-is-not-supported-p23884662.html">http://www.nabble.com/Re%3A-vm86-mode-is-not-supported-p2...</a><br>
<p>
Alexandre Julliard:<br>
Win16 applications don't need vm86, and work just fine on 64-bit. <br>
<p>
OK, that means that with some LDT tricks Win16 apps may work in Wine. I'm not 100% sure but I know the LDT offset trick works for DPMI applications in DOSEMU which I tested a bit last year. Wine can also execute some DOS apps, and those won't be possible in i386 without zero mapping unless Wine acquires a CPU emulator or someone can think of another solution.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342747/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342750"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 3:53 UTC (Wed)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/342750/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <i>The null page is only really *needed* for vm86()...</i>That is just not true [except of course for arguments regarding universality, or emulating every access to page 0 via SIGSEGV, etc.]  &nbsp;I have written programs where having page 0 is essential (for elegance, or ease of maintenance, or time performance, or space performance, etc.), and I object to those programs becoming non-functional.  
      
          <div class="CommentReplyButton">
            <form action="/Articles/342750/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342751"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 3:54 UTC (Wed)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/342751/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
UDEREF is a PaX feature, developed entirely by the PaX Team -- not by me.<br>
<p>
You are correct though that the real problem is any invalid userland access in general.  There are many bugs that have existed and will exist that involve (or can involve) userland in ways that simply preventing mappings within the first 64kb won't stop.  For instance, in the exploit I developed today that I linked to in this thread, I don't have to worry about how I'll inject arbitrary code into the kernel -- all I need is to get it to execute my already-existing code in userland (allowing for all the auditing/SELinux/AppArmor/LSM disabling code to be reused easily).<br>
<p>
With a one-byte write of of 0 (a value I don't control) to an address my technique allows me to 100% reliably control, on x86 I set the highest byte in a function pointer belonging to a module to 0, turning it into a userland address -- game over.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342751/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 4:54 UTC (Wed)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/342755/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You are correct though that the real problem is any invalid userland access in general.</font><br>
<p>
Given the above and the fact that solutions to this type of bug exist (if I understand UDEREF correctly), why is the kernel not being patched so we don't see this ever again? Or am I being overly naive?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, you are overly naive...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 5:42 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/342757/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>Given the above and the fact that solutions to this type of bug 
exist (if I understand UDEREF correctly), why is the kernel not being patched 
so we don't see this ever again? Or am I being overly naive?</blockquote>

<p>The sad truth is that UDEREF is history now. The only architecture where 
it was useful slowly goes away: most architectures never had segments and 
Intel/Amd "lost" them recently: x86-64 does not have full segments in 64-bit 
mode... Segments only retained one attribute: base address, nothing else - 
good for TLS, not enough for UDEREF...</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/342757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342764"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, you are overly naive...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 6:56 UTC (Wed)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/342764/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Note that the fundamental problem in all this NULL deref misery is the lack of userland/kernel virtual address space separation. UDEREF/i386 simulates it by using the IA-32 segmentation logic, but there're certainly other ways to do the same, say address space ID tags in the TLB. Unfortunately AMD had butchered the segmentation logic without providing an alternative (it's not only about security, virtualization vendors weren't that happy either).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342764/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, you are overly naive...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 8:02 UTC (Wed)
                               by <b>gmaxwell</b> (guest, #30048)
                              [<a href="/Articles/342770/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
How terrible for performance would it be to make all userspace accessible memory no-execute on kernel entrance?   (or otherwise achieve the same result, like making it unreachable and then faulting it back in with NX-set).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342864"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, you are overly naive...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 17:25 UTC (Wed)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/342864/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
this would be _very_ expensive. changing the page tables is relativly expensive (especially if you have to do a lot of them)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342864/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342895"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, you are overly naive...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 18:53 UTC (Wed)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/342895/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
well, the actual page table manipulation would not be that expensive, with some tradeoffs you can reduce it to changing a few top-level page table entries and a single TLB flush, which would be a few hundred cycles or so. <br>
<p>
however there's more cost to this: TLB repopulation which would inevitably occur after returning to userland. that is the real expense as we're talking about up to hundreds of TLB entries on modern CPU cores, each potentially missing in the data cache and incurring hundreds of cycles.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342895/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor342793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, you are overly naive...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 11:13 UTC (Wed)
                               by <b>ajb</b> (guest, #9694)
                              [<a href="/Articles/342793/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
According to wikipedia newer cpus have an 'address space' tag which can be used to avoid flushing the TLB on VM switches. Could also be used for kernel vs user mode? It would require cooperating with the VM monitor though. (I wish VMs could be nested - it would be nice to be able to run untrusted code on EC2 without using QEMU. ).<br>
<p>
 Although that doesn't obviously help for the cases where the kernel needs to access user mode memory; one would still have to change the permissions to access it and then change them back.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor342941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">NKX-bit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 23:37 UTC (Wed)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/342941/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems like the execute (and perhaps some other) memory permissions should be split up into user and kernel versions, that would solve this particular problem at least. That said, if they just got used to a separate no-execute bit, it may take a really long time before they introduce a no-kernel-execute bit (or ring0, whatever).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor342787"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Not NULL assertions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 10:14 UTC (Wed)
                               by <b>iq-0</b> (subscriber, #36655)
                              [<a href="/Articles/342787/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is argued that adding assertions to your code helps you describe and optionally enforce your contract (design/programming by contract).<br>
<p>
I agree that the default BUG_ON(..) is the wrong way to go, but removing it removes a piece of information, namely that we assume the pointer to be not null. I think that a better solution would be to introduce:<br>
<p>
ASSERT(expr) and possibly ASSERT_NOT_NULL(ptr) or ASSERT_VALID_PTR(ptr) which also checks for error pointers. They perfectly describe what we expect from our input parameters and you with a DEBUG_ASSERTIONS configuration option you would activate these additional checks (which for production systems would not be enabled by default).<br>
<p>
The other thing I personally encountered during some kernel programming was that it's often not clear if a pointer could be NULL at a given point. Idealistically one would always write input and output documentation for functions, but I don't think that would be realistic and it would get outdated soon (or people make the wrong assumptions because the documentation said so, but forgot to mention the out of memory error pointer).<br>
Most tricky bits however ware the hooks one writes in the device drivers, which are called by some other parts of the kernel. There are far fewer of those and changes there are always done very carefully for there are many users of those callbacks (both calling and providing). So a changes any changes here are much more well thought through and given the care that must be taken the updating (and given the symantics change, any resulting code that has to be modified to handle the new symantics) would make the documentation update pretty minor. Idealisticly you should also be able to introduce (preferably with one simple config option) a way that a debug proxy function would be inserted or a debug hook be called before calling the actual hook function. This would probably mean that calling a hook or registering a hook should be made more explicit, which would be a good thing (especially calling a hook, registering is very frequent, but calls are much more sporadic).<br>
<p>
This of course assumes that some people would be willing to run test-kernels which are easily 5% slower than the production versions, though they should be more secure and at least as stable as soon as the first wrinkles are ironed out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342787/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 12:08 UTC (Wed)
                               by <b>MisterIO</b> (guest, #36192)
                              [<a href="/Articles/342803/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A check for a situation where a pointer dereference is followed by a check for NULL on that pointer will be present in the next release of cppcheck(1.35).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/342803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor342826"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fun with NULL pointers, part 2</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2009 14:57 UTC (Wed)
                               by <b>error27</b> (subscriber, #8346)
                              [<a href="/Articles/342826/">Link</a>] 
      </p>
      
      </div>
      </summary>
      One thing that is delaying smatch is that I'm cycling through Africa right now :P.  The smatch web page is out of date.  I gave up trying to ssh in and fix it from internet cafes, but now I'm in South Africa maybe it's possible.

<p>
The new link for smatch is:  <a href=http://repo.or.cz/w/smatch.git/>http://repo.or.cz/w/smatch.git/</a>

<p>
One issue with printing an error after a dereference is that some macros do needless checking.

<p>
But it's easy enough to write a script for that.  I don't have electric tonight but hopefully I will be able to post a script in a two or three days.  I wrote a first draft of the script yesterday and it did find a bug.

      
          <div class="CommentReplyButton">
            <form action="/Articles/342826/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor343205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2009 1:31 UTC (Fri)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/343205/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be great if LWN could engage Brad and PaXTeam to write an article in which they lay out what/how the kernel should be changed so that we don't see bugs like this exploited any more.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/343205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor343235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2009 8:58 UTC (Fri)
                               by <b>Trou.fr</b> (subscriber, #26289)
                              [<a href="/Articles/343235/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I concur. Some well detailed explanation about the current shortcomings of the kernel, and how to they could possibly fixed. Without ranting ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/343235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor343255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2009 13:04 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/343255/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      You're not the only one to think about such things...I just noticed that LinuxFR.org has posted <a rel="nofollow" href="http://linuxfr.org/2009/07/24/25761.html">an interview with Brad</a>.  Only possible problem is that it's in French...
      
          <div class="CommentReplyButton">
            <form action="/Articles/343255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor343272"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2009 14:35 UTC (Fri)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/343272/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The original English version was just posted as a comment to the article:<br>
<a href="http://linuxfr.org/2009/07/24/25761.html">http://linuxfr.org/2009/07/24/25761.html</a><br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/343272/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor343273"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2009 14:37 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/343273/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Cool, that speeds the reading process for some of us.  FWIW, here's <a rel="nofollow" href="http://linuxfr.org/comments/1052695.html#1052695">a direct link</a> to the comment.
      
          <div class="CommentReplyButton">
            <form action="/Articles/343273/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor343352"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2009 23:29 UTC (Fri)
                               by <b>eparis123</b> (guest, #59739)
                              [<a href="/Articles/343352/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
An older interview with the other half of the Pax team on June:<br>
<p>
<a href="http://www.phrack.org/issues.html?issue=66&amp;id=2#article">http://www.phrack.org/issues.html?issue=66&amp;id=2#article</a><br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/343352/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
