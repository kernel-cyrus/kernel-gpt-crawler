        <!DOCTYPE html>
        <html lang="en">
        <head><title>Shrinking the kernel with link-time garbage collection [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/741494/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/741463/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/741494/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Shrinking the kernel with link-time garbage collection</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="GAByline">
           <p>December 15, 2017</p>
           <p>This article was contributed by Nicolas Pitre</p>
           </div>
One of the keys to fitting the Linux kernel into a small system is to
remove any code that is not needed.  The kernel's configuration system
allows that to be done on a large scale, but it still results in the
building of a kernel containing many smaller chunks of unused code and
data.  With a bit of work, though, the compiler and linker can be made to
work together to garbage-collect much of that unused code and recover the
wasted space for more important uses.

<p>This is the first article of a series discussing various methods of
reducing the size of the Linux kernel to make it suitable for small
environments.  Several approaches will be examined, from the
straightforward to the daring.

<p>It is a fact that Linux has conquered the high end of the computing spectrum.
Since Linux started small 26 years ago, there was great emphasis on scaling up,
which eventually made it the platform of choice for server rooms, data centers
and the cloud infrastructure.  Since November 2017, all the
<a href="http://www.top500.org/lists/2017/11/">top 500 supercomputers</a> use
Linux-based operating systems. No more to say there.</p>

<p>On the desktop this is not as clear. Linux market share has only now surpassed
the three-percent mark
(<a href="http://www.netmarketshare.com/operating-system-market-share.aspx?qprid=9&amp;qpcustomb=0&amp;qpsp=200&amp;qpnp=25&amp;qptimeframe=M">
according to Net Applications</a>) even though it has been available and
working well for 
years. Unless we consider mobile as the new desktop, in which case the
presence of at least <a
href="https://blog.google/products/android/2bn-milestone/">two-billion
active Android devices</a> should make up for it and cover the middle
range of the spectrum pretty well. But mobile devices, while being physically
small, are far from matching the "tiny" Linux definition. Mobile is simply
desktop software (more or less) that we can carry in our pocket but that only
20 years ago required a big computer tower to run.</p>

<p>Small often implies "embedded", and embedded Linux is often considered as
being at the low end of the computing spectrum.  Linux is successful in
this area too; small, embedded Linux examples are plentiful, from wireless
routers to smart light bulbs, from airline in-flight entertainment to car GPS
systems, etc. Linux is everywhere, and most of the time its presence is
unsuspected. But those systems still have a relatively generous amount of
resources to work with, e.g. typically 32MB of RAM to start with. That's not
<em>really</em> tiny yet.</p>

<p>So what does "tiny" actually mean? Let's define it as a sub-megabyte system
or thereabout. Battery-powered operation is a given and batteries are
expected to last for
months or years. Power consumption has to be extremely low, which implies
static RAM (or SRAM).
Because SRAM is expensive, it is typically deployed in minimal quantities.
We're talking small, cheap, and ubiquitous
<a href="http://en.wikipedia.org/wiki/Internet_of_things">IoT</a> devices that are
increasingly being connected to the Internet with all its perils. The software
in this space is fragmented, and Linux has next to no presence at all.</p>

<p>Operating systems carrying an open-source license for the tiny space are
many.  A few random examples are:
<a href="http://www.contiki-os.org/">Contiki</a>,
<a href="http://www.freertos.org/">FreeRTOS</a>,
<a href="http://www.mbed.com/en/platform/mbed-os/">Mbed OS</a>,
<a href="http://www.nuttx.org/">NuttX RTOS</a>,
<a href="http://riot-os.org/">RIOT OS</a>, or even
<a href="http://www.fuzix.org/">Fuzix OS</a> for the nostalgic.
There is also an effort to consolidate this tiny space with the
<a href="https://lwn.net/Articles/682723/">Zephyr Project</a>.
Diversity is also prominent in the proprietary world.
So why bother with Linux in this space?</p>

<h4>The open-source gravitational field</h4>

<p>Successful open-source projects may be compared to celestial objects. Some of
them grow big, as universal gravitation works to pull them together
into stars and planets.  There are relatively few such objects in
the end since the gravity field from large objects absorbs any other objects in
their vicinity. Sometimes, however, objects that fail to consolidate with
others remain numerous, roughly shaped, and sparsely distributed like
asteroids.</p>

<p>The tiny computing space is just like an asteroid field; numerous projects
exist, but they lack the required center of gravity for effective and
self-sustained communities to form naturally around them. Consolidation
efforts are moving slowly because of that. The end result is a highly
fragmented space with relatively few developers per project and, therefore,
fewer resources to rely upon when issues come up. Vulnerabilities are more
likely to turn into a security nightmare.</p>

<p>The Linux ecosystem, instead, reached planet status a long time ago. It
has a lot
of knowledgeable people around it, a lot of testing infrastructure and tooling
available already, etc. If a security issue turns up on Linux, it has a
greater chance of being caught early, or fixed quickly, and finding
people with the right knowledge is easier with Linux than it would ever be on
any other tiny operating system out there. Leveraging that ecosystem could be
a big plus for the tiny computing space, and it would truly mean world
domination for Linux.</p>

<h4>Scaling Linux down</h4>

<p>With this short rationale in hand, let's dive into the actual technical stuff.
Of course, the biggest obstacle to a tiny Linux kernel is its size. It is
unrealistic
to expect Linux to ever run in 64KB of RAM. Such targets are best left to
the likes of Zephyr. But maybe "640K ought to be enough for
anybody" as someone once said. Many modern microcontrollers capable of running
Linux do have about that amount of on-chip SRAM which would make them nice
single-chip Linux targets. So let's see how this can be achieved.</p>

<h4>Automatic kernel size reduction</h4>

<p>Wouldn't it be nice if computers could be leveraged to do the job
automatically for us? After all, if there is one thing that computers are good
at, it is finding unused code and optimizing the resulting binary. There
are two ways in which currently available tools can achieve automatic size
reduction: garbage collection of unused input sections
and link-time optimization (LTO).  This article will
focus on the first of these two approaches.

<p>Please note that most examples presented here were produced using the ARM
architecture, however the principles themselves are not architecture-dependent.</p>

<h4>Linker section garbage collection</h4>

<p>The linker is already able to omit stuff from a linked binary given
extra input data. Let's think about the libraries used to produce an executable
for example: if the whole of a library (say libc) were always linked into
the final executable, then that executable would be rather big and
inefficient. That's assuming static linking of course, but the kernel is a
statically linked executable for the most part, so let's forget about
dynamic linking and modules for the purpose of this demonstration.</p>

<p>Let's consider the following code as test.c:</p>
<p>
<pre>
   int foo(void)  { return 1; }

   int bar(void)  { return foo() + 2; }

   int main(void) { return foo() + 4; }
</pre>
<p>
<p>The compiler generates the following (simplified) assembly output for that code:</p>
<p>
<pre>
        .text

        .type   foo, %function
    foo:
        mov     r0, #1
        bx      lr

        .type   bar, %function
    bar:
        push    {r3, lr}
        bl      foo
        adds    r0, r0, #2
        pop     {r3, pc}

        .type   main, %function
    main:
        push    {r3, lr}
        bl      foo
        adds    r0, r0, #4
        pop     {r3, pc}
</pre>
<p>

<p>Despite <tt>bar()</tt> not being called, it is still part of the compiled output
because there is no way for the compiler to actually know if some other file
might call it. Only the linker can know, once it gathered all the object files
to be linked together, whether <tt>bar()</tt> is referenced from another object file
or not.</p>

<p>And even then, the linker has no knowledge of the object file content other
than the different sections it contains (.text, .data, etc.), where named
things start (symbol table), and how to patch in final addresses (relocation
table). So all the linker can do is to pull an object file into the final link
if it contains a symbol that is referenced by another object file. The linker
simply cannot carve out a piece of the <tt>.text</tt> section to drop the
unused <tt>bar()</tt> code.</p>

<p>In the Linux kernel, this happens quite often when the core kernel API provides
functions that are not called when some unwanted feature is configured out. It
could be argued that the unused core function should be <tt>#ifdef</tt>'d in or out
along with its user, but this gets hairy when multiple features sharing the
same core API may be configured in and out independently. Tracking this kind
of dependency can be done manually in the <tt>Kconfig</tt> language, but
there is a point where too many configuration symbols and <tt>#ifdef</tt>s in the code
become a maintenance burden.</p>

<p>Alternatively, we could move every core function into a separate source
file, causing each to be compiled into its own object file.
The linker could work out what is used and what is not like it does with
libraries, but that wouldn't sit well with kernel developers either.

Fortunately, there is a GCC flag to request the creation of a separate code
section for every function, namely <tt>-ffunction-sections</tt>. When recompiling our
test code above with <tt>-ffunction-sections</tt> the output becomes:</p>
<p>
<pre>
        .section .text.foo,"ax",%progbits
        .type   foo, %function
    foo:
        mov     r0, #1
        bx      lr

        .section .text.bar,"ax",%progbits
        .type   bar, %function
    bar:
        push    {r3, lr}
        bl      foo
        adds    r0, r0, #2
        pop     {r3, pc}

        .section .text.main,"ax",%progbits
        .type   main, %function
    main:
        push    {r3, lr}
        bl      foo
        adds    r0, r0, #4
        pop     {r3, pc}
</pre>
<p>

<p>Now, we get three distinct sections rather than the single
<tt>.text</tt> section we had
initially, one per function, named after the function they contain plus some
attributes to indicate that they contain executable code. Separate sections
are just as good as separate object files to the linker, since it can drop
unreferenced code on a per function granularity as long as the linker is
also passed the <tt>-gc-sections</tt> flag.</p>

<p>Let's try it out, first without any special flags:</p>
<p>
<pre>
    $ gcc -O2 -o test test.c
    $ ./test
    $ echo $?
    5
    $ nm test | grep "foo\|bar"
    00008520 T bar
    000084fc T foo
</pre>

<p>The code works as expected, and the bar symbol is still present as expected.
Let's add our special flags now (using the special "<tt>-Wl</tt>" flag to
pass options through to the linker):</p>
<p>
<pre>
    $ gcc -ffunction-sections \
    &gt;     -Wl,-gc-sections -Wl,-print-gc-sections \
    &gt;     -O2 -o test test.c
    ld: Removing unused section '.text.bar' in file 'test.o'
    $ ./test
    $ echo $?
    5
    $ nm test | grep "foo\|bar"
    000084fc T foo
</pre>

<p>Now <tt>bar()</tt> is gone. We get an automatic size reduction and we
didn't have to modify the source code at all. Instant gratification! The
attentive reader would have noticed the extra <tt>-print-gc-sections</tt>
linker flag that may be used to confirm what sections are actually
removed.</p>

<p>In addition to <tt>-ffunction-sections</tt>, GCC also accepts
<tt>-fdata-sections</tt> to
perform the same split-section trick with global data variables. It is
typical to see both flags used together.</p>

<p>Can we just add those flags to the kernel build? Unfortunately, things aren't
that simple. Just adding those flags will produce a non-booting
kernel. The problem comes from various sections that the kernel code creates
to let the linker gather scattered pieces of information together into a
table that can be used by the running kernel. For example, let's consider
this macro that closely resembles what's
used to implement <tt>put_user()</tt> on ARM:</p>
<p>
<pre>
    #define __put_user_asm_word(x, __pu_addr, err)              \
        __asm__ __volatile__(                                   \
        "1:     strt    %1, [%2]\n"                             \
        "2:\n"                                                  \
        "       .pushsection .text.fixup,\"ax\"\n"              \
        "       .align  2\n"                                    \
        "3:     mov     %0, %3\n"                               \
        "       b       2b\n"                                   \
        "       .popsection\n"                                  \
        "       .pushsection __ex_table,\"a\"\n"                \
        "       .align  3\n"                                    \
        "       .long   1b, 3b\n"                               \
        "       .popsection"                                    \
        : "+r" (err)                                            \
        : "r" (x), "r" (__pu_addr), "i" (-EFAULT)               \
        : "cc")
</pre>

<p>For those who might wonder what those "<tt>1b</tt>", "<tt>2b</tt>" and
"<tt>3b</tt>" symbols might be: those are backward references to the
respective local labels without the "<tt>b</tt>" suffix. The "<tt>f</tt>"
suffix is also available for forward references. See <a
href="https://sourceware.org/binutils/docs/as/Symbol-Names.html#Local-Labels-1">the
binutils documentation</a> for more details.</p>

<p>The code above adds a single <tt>strt</tt> instruction in the currently
active section, which is a special instruction that perform a user-space
store after testing user access permissions. It also adds some code to the
<tt>.text.fixup</tt> section, and finally records in the
<tt>__ex_table</tt> section the location of the <tt>strt</tt> instruction
and the <tt>.text.fixup</tt> code.</p>

<p>To better illustrate what's happening, let's consider this code:</p>

<p>
<pre>
    int foobar(int __user *p)
    {
        return put_user(0x5a, p);
    }
</pre>

<p>The assembly result is:</p>
<p>
<pre>
        .section .text.foobar,"ax"
    foobar:
        mov     r3, #0
        mov     r2, #0x5a
    1:  strt    r2, [r0]
    2:  mov     r0, r3
        bx      lr

        .section .text.fixup,"ax"
    3:  mov     r3, #-EFAULT
        b       2b

        .section __ex_table,"a"
        .long   1b, 3b
</pre>

<p>In the example above, the code preloads zero into <tt>r3</tt>, performs
the user-space
access and, if an exception occurs, <tt>r3</tt> is loaded with
<tt>-EFAULT</tt> by the fixup
code and execution is resumed past the faulting instruction.</p>

<p>What's important to remember here is that the linker gathers the
<tt>__ex_table</tt> sections from every <tt>put_user()</tt> instance into a single
section to form a table. That table is searched by the kernel
exception-handling code to decide what to do if the faulting instruction
matches a table entry when an exception occurs.</p>

<p>The problem with these <tt>__ex_table</tt> sections is that nothing has an actual
reference to them.  They are just a bunch of address values pulled together. So,
when the linker is passed the <tt>-gc-sections</tt> flag, it is free to drop all of
them because they aren't referenced by anyone since they don't define any
symbol themselves anyway. So we end up with a final kernel that has an empty
exception table. This is true for many such kernel tables created by the
linker, such as the list of kernel command-line argument parsers or the
the initcall pointer table. And a kernel without any initcalls won't boot very
far.</p>

<p>Of course there is a linker script directive that allows for overriding the
<tt>-gc-sections</tt> effect on a per section basis, namely the
<tt>KEEP()</tt> directive. So 
<a
href="http://elixir.free-electrons.com/linux/v4.14.6/source/include/asm-generic/vmlinux.lds.h#L521">the
kernel linker script</a> has gained entries that look like this:</p> 
<p>
<pre>
    __ex_table {
	__start___ex_table = .;
	KEEP(*(__ex_table))
	__stop___ex_table = .;
    }
</pre>

<p>With the appropriate sprinkling of <tt>KEEP()</tt> annotations in the
linker script, the 
kernel does eventually boot properly. Yay! So now the extent of our
modifications consists of a few extra flags to the compiler/linker and a couple
<tt>KEEP()</tt> annotations in the linker script. That is, in fact, what the
mainline kernel 
already offers since v4.10 with the
<tt>CONFIG_LD_DEAD_CODE_DATA_ELIMINATION</tt> configuration option.</p>

<h4>The "backward reference" problem</h4>

<p>Maybe we shouldn't celebrate just yet. Let's consider multiple functions like
the previous example, each with a call to <tt>put_user()</tt>. We'd end up with
something like the following assembly representation after the final link:</p>
<p>
<pre>
       .section .text.foo1,"ax"
    foo1:
    	...
	mov     r3, #0
    1:  strt    ...
    2:  ...

        .section .text.foo2,"ax"
    foo2:
   	...
        mov     r3, #0
    3:  strt    ...
    4:  ...

        .section .text.foo3,"ax"
    foo3:
	...
        mov     r3, #0
    5:  strt    ...
    6:  ...

        .section .text.fixup,"ax"
    7:  mov     r3, #-EFAULT
        b       2b
    8:  mov     r3, #-EFAULT
        b       4b
    9:  mov     r3, #-EFAULT
        b       6b

        .section __ex_table,"a"
        .long   1b, 7b
        .long   3b, 8b
        .long   5b, 9b
</pre>


<p>Here we clearly see the <tt>__ex_table</tt> section containing a table of tuples,
each with the address of a potentially exception-raising instruction and the
address of the code to execute in that case. Of course our linker script has a
<tt>KEEP()</tt> on the individual <tt>__ex_table</tt> entries to pull them
into the final binary, 
otherwise the linker would discard them. But despite the fact that the
<tt>__ex_table</tt> entries don't define symbols of their own, they
<em>do</em> reference
other symbols, namely the location of the <tt>strt</tt> instructions, illustrated by
backward references to labels 1, 3 and 5. References to the fixup code also
pull in the corresponding section, which also has yet more references to those
individual functions.</p>

<p>That means all those functions with a <tt>put_user()</tt> call in them,
and all other functions using similar constructs that create table entries
using the same mechanism, are always pulled into the final binary even if
they are never referenced by anything else. And those functions will pull in
all the functions they call, and so on, down to leaf functions. This makes
the whole idea of dropping unused code by garbage-collecting unreferenced
sections rather ineffective in this case.</p>

<p>What can we do about that? We could apply the same trick already applied to
those original functions themselves and create separate sections for each of
the exception and fixup entries so the linker can link some of them and drop
the others. However, in the function case, it is the compiler that does the
section splitting for us with <tt>-ffunction-sections</tt>. Here we're providing our
own assembly stubs.</p>

<p>One could suggest something like <tt>__put_user(val, ptr, __func__)</tt>. The
compiler provides the <tt>__func__</tt> identifier that holds the name of the current
function as a string. That could be used with the <tt>.pushsection</tt> directive to
create section names after the function where this is invoked:</p>

<p>
<pre>
    #define __put_user_asm_word(x, __pu_addr, err)              \
        __asm__ __volatile__(                                   \
        "1:     strt    %1, [%2]\n"                             \
        "2:\n"                                                  \
        "       .pushsection .text.fixup." __func__ ",\"ax\"\n" \
        "       .align  2\n"                                    \
        "3:     mov     %0, %3\n"                               \
        "       b       2b\n"                                   \
        "       .popsection\n"                                  \
        "       .pushsection __ex_table." __func__ ",\"a\"\n"   \
        "       .align  3\n"                                    \
        "       .long   1b, 3b\n"                               \
        "       .popsection"                                    \
        : "+r" (err)                                            \
        : "r" (x), "r" (__pu_addr), "i" (-EFAULT)               \
        : "cc")
</pre>

<p>The problem is that <tt>__func__</tt> is not a string literal. It is a string pointer
and therefore cannot be used to construct a string for the <tt>asm()</tt> statement.
What about <tt>__FUNCTION__</tt> then? That used to work. However, <a
href="https://gcc.gnu.org/onlinedocs/gcc-3.4.0/gcc/Function-Names.html">the
GCC documentation</a> says:</p>

<div class="BigQuote">
<p>These identifiers are not preprocessor macros. In GCC 3.3 and earlier, in C
only, __FUNCTION__ and __PRETTY_FUNCTION__ were treated as string literals;
they could be used to initialize char arrays, and they could be concatenated
with other string literals. GCC 3.4 and later treat them as variables, like
<em>func</em>. In C++, __FUNCTION__ and __PRETTY_FUNCTION__ have always been
variables.</p>
</div>

<p>What about <tt>__put_user(val, ptr, __FILE__, __LINE__)</tt>? That can
work to some extent, as <tt>__FILE__</tt> is a string literal and
<tt>__LINE__</tt> can be stringified. 
But this scheme falls flat when invoking static inline functions as the file
and line information correspond to the function definition location and not
to where it is inlined. That means multiple instances would end up with the
same section name, which is precisely what we're trying to avoid.</p>

<p>The ultimate and simplest solution requires some involvement from the
assembler. A
<a href="http://sourceware.org/git/?p=binutils-gdb.git;a=commitdiff;h=451133cefa839104">
section name substitution sequence</a> is possible when using binutils version
2.26 or later. With that feature, the previous <tt>.pushsection</tt> directives would
simply become:</p>
<p>
<pre>
    #define __put_user_asm_word(x, __pu_addr, err)              \
        __asm__ __volatile__(                                   \
        "1:     strt    %1, [%2]\n"                             \
        "2:\n"                                                  \
        "       .pushsection %S.fixup,\"ax\"\n"                 \
        "       .align  2\n"                                    \
        "3:     mov     %0, %3\n"                               \
        "       b       2b\n"                                   \
        "       .popsection\n"                                  \
        "       .pushsection __ex_table%S,\"a\"\n"              \
        "       .align  3\n"                                    \
        "       .long   1b, 3b\n"                               \
        "       .popsection"                                    \
        : "+r" (err)                                            \
        : "r" (x), "r" (__pu_addr), "i" (-EFAULT)               \
        : "cc")
</pre>

<p>Given the function <tt>foobar()</tt> invoking <tt>put_user()</tt>, the
active section name would 
be <tt>.text.foobar</tt>. Then the fixup code would end up in section
<tt>.text.foobar.fixup</tt> and the exception table entry in
<tt>__ex_table.text.foobar</tt>. The linker has now the ability to include only the
relevant parts of the exception table and fixup code.</p>

<p>Still, we didn't fix anything, did we?</p>

<h4>The "missing forward reference" problem</h4>

<p>At this point we have managed to create separate sections for functions, fixup code
per function, and exception table entries per function. But we still need a
<tt>KEEP(__ex_table.*)</tt> in the linker script or we'll still end up with all our
exception sections discarded like before. Having separate sections with pretty
names still doesn't create any reference to them.</p>

<p>What we need is some kind of explicit reference from the invoking code to
the corresponding exception table entry so the linker will pull it in along the
function when it is needed without having to forcefully <tt>KEEP()</tt> them.
Something illustrated by a hypothetical <tt>.tug</tt> assembly directive
like this:</p> 
<p>
<pre>
	.section .text.foobar,"ax"
    foobar:
        mov     r3, #0
        mov     r2, #0x5a
    1:  strt    r2, [r0]
        <b>.tug    4f</b>
    2:  mov     r0, r3
        bx      lr

        .section .fixup.text.foobar,"ax"
    3:  mov     r3, #-EFAULT
        b       2b

        .section __ex_table.text.foobar,"a"
    4:  .long   1b, 3b
</pre>

<p>Here, a simple call to <tt>foobar()</tt> from some other code will
prompt the linker to 
pull the <tt>foobar()</tt> code in.  That code, in turn, contains a
reference to its exception entry, prompting the linker to pull that in too,
and the exception entry has a
reference to the fixup code which would be pulled into the link as well. Now
we're going somewhere!</p>

<p>But how can we create such a reference? The most obvious way is to replace
<tt>.tug</tt> with <tt>.long</tt> above, which would store the address of
the exception table 
entry at that location. However this would require the code to branch
over that value, which has no use other than creating a reference, wasting
memory and making the code less optimal.</p>

<p>Turns out that the GNU assembler already has the necessary feature to create
an explicit reference without allocating any space in the code, at least on
ARM:</p>
<p>
<pre>
       .section .text.foobar,"ax"
    foobar:
        mov     r3, #0
        mov     r2, #0x5a
    1:  strt    r2, [r0]
        <b>.reloc  ., R_ARM_NONE, 4f</b>
    2:  mov     r0, r3
        bx      lr

        .section .fixup.text.foobar,"ax"
    3:   mov     r3, #-EFAULT
        b       2b

        .section __ex_table.text.foobar,"a"
4:      .long   1b, 3b
</pre>

<p>Yes, our <tt>.tug</tt> directive can be defined in terms of the <tt>.reloc</tt>
directive with a 
no-op relocation type. What <tt>.reloc</tt> means and how relocations work is
beyond the scope of this article though.</p>

<h4>Conclusion</h4>

<p>We've seen how the linker <tt>-gc-sections</tt> feature can be exploited to its full
potential on the Linux kernel. This requires more changes to the source code
than one might have hoped, involving some obscure (or exotic depending on your
taste) assembler tricks. However this does not yet unveil the full extent of
what
the automatic size reduction current tools are capable of when using link-time
optimization (LTO). So in the next article in this series we'll <a
href="/Articles/744507/">look at LTO</a> 
instead.</p>

<p>Still, there is a longstanding issue with kernel code annotated with the
<tt>__exit</tt> marker that can be fixed with what we've seen already. Because
exception table entries hold references to the originating code, that code has
to be pulled into the final link or unresolved symbol errors will occur. This
is why the built-in <tt>__exit</tt> code is currently linked into the .init section
to be dropped at runtime rather than being discarded upfront at link time.
However, with the section name substitution feature, it is possible to create
something that looks like:</p>
<p>
<pre>
        .text
    foobar:
    1:  ...

        .section .init.text
    foobar_init:
    2:  ...

        .section .exit.text
    foobar_exit:
    3:  ...

        .section .text.fixup
        do_fix  1b

        .section .init.text.fixup
        do_fix  2b

        .section .exit.text.fixup
        do_fix  3b
</pre>

<p>This way, it would be possible to discard the <tt>__exit</tt> code as originally
intended, along with the exception entries that reference it. Any takers?</p>
<p>

The rest of this series is made up of:
<p>
<ul class="spacylist">


<li> <a href="/Articles/744507/">Shrinking the kernel with link-time
     optimization</a> 
<li> <a href="/Articles/746780/">Shrinking the kernel with an axe</a>
<li> <a href="/Articles/748198/">Shrinking the kernel with a
     hammer</a>
</ul><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Build_system">Build system</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Embedded_systems">Embedded systems</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Optimization_tools">Optimization tools</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Pitre_Nicolas">Pitre, Nicolas</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/741494/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor741617"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2017 4:09 UTC (Sat)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/741617/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      This "missing forward reference" use case was <a href="https://groups.google.com/d/msg/generic-abi/_CbBM6T6WeM/9nNnwRNHAQAJ">recently discussed</a> on the "generic-abi" email list. The conclusion was that the SHF_LINK_ORDER flag's semantics should be slightly extended to cover this.

Unfortunately, it's not yet implemented in the GNU linker nor assembler. However, if you use recent clang and lld, you can see it in action today. (A <a href="https://sourceware.org/ml/binutils/2017-04/msg00000.html">patch</a> was posted for gold, but doesn't seem to have been applied yet)
<p>

E.g. here's a slightly modified example from article. I've removed the ".reloc" hack, and modified the .section line, in red, to create a section marked with SHF_LINK_ORDER (that's the "o" in the "ao" flag):
<p>
In file test.s:
<pre>
        .section .text.foobar,"ax"
.globl foobar
foobar:
        mov     r3, #0
        mov     r2, #0x5a
1:        strt    r2, [r0]
2:        mov     r0, r3
        bx      lr

        .section .fixup.text.foobar,"ax"
3:         mov     r3, #-57
        b       2b

<b><font color="red">        .section __ex_table.text.foobar, "ao", %progbits,.text.foobar</font></b>
4:            .long   1b, 3b
</pre>

In file test2.c:
<pre>
int foobar();
int main() {
  foobar();
}
</pre>

I run:
<pre>
$ clang -target arm-linux-gnueabihf -c -o test.o test.s
$ clang -target arm-linux-gnueabihf -c -o test2.o test2.c
$ clang -target arm-linux-gnueabihf -o test test2.o test.o -Wl,--gc-sections -fuse-ld=lld
</pre>

Doing an "objdump -x test", you will see that the "__ex_table.text.foobar" section made it into the output file. If you then comment out the call in main() to "foobar()", you'll see the __ex_table disappears too.
<p>

I'd recommend the kernel folks get the GNU tools to implement these semantics, so that weird no-op reloc tricks aren't needed.
      
          <div class="CommentReplyButton">
            <form action="/Articles/741617/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor741653"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Let's see some numbers!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2017 2:03 UTC (Sun)
                               by <b>david.a.wheeler</b> (subscriber, #72896)
                              [<a href="/Articles/741653/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd very much like to see before-and-after numbers.  If the work reduces memory use by 10 bytes, it probably doesn't matter.  I suspect that approaches are more effective when combined, but even so, I'd like to see if the effort appear to have the desired result.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741653/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor741719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Let's see some numbers!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2017 16:03 UTC (Mon)
                               by <b>npitre</b> (subscriber, #5680)
                              [<a href="/Articles/741719/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Numbers will come in a subsequent article after more methods are exposed then compared.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor847713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2021 5:01 UTC (Mon)
                               by <b>maskray</b> (subscriber, #112608)
                              [<a href="/Articles/847713/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I managed to convince binutils that generic SHF_LINK_ORDER (not just arm) is useful, in particular, __patchable_function_entries needs it. H.J. Lu kindly implemented it and another nice syntax `,unique` in binutils 2.35.<br>
<p>
SHF_LINK_ORDER unfortunately has some pitfalls. I have a summary in <a href="https://maskray.me/blog/2021-01-31-metadata-sections-comdat-and-shf-link-order">https://maskray.me/blog/2021-01-31-metadata-sections-comd...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/847713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor741618"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2017 7:17 UTC (Sat)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/741618/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is cool work! It'd be nice for us mainstream users as well as embedded; my vmlinuz images have almost doubled in size since I first put together this desktop…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741618/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor741652"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2017 1:45 UTC (Sun)
                               by <b>ThinkRob</b> (guest, #64513)
                              [<a href="/Articles/741652/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>One "mainstream" (aka not embedded) use might be those of us running coreboot.  Some laptops have pretty limited flash, and there's not enough room for a Linux payload *and* another toy or two.  So anything that might get the kernel down to the point where it all fits is nice.</p>

<p>That said, "mainstream" might be a stretch.  I mean, there may be dozens of us.  But still... "<i>There are dozens of us!  Dozens!</i>" ;)</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/741652/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor742095"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2017 0:20 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/742095/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another thing came to mind re-reading this just now: routers. OpenWRT/LEDE has dropped or declined to support quite a few models as Linux has grown too big for them over the years, and the flash size is comparable to what you'd have available to install coreboot in.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/742095/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor741629"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compile as one huge object</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2017 12:59 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/741629/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would have expected to skip the linking step altogether by concatenating all the source files into a big lump and then building that with optimization turned on.  Some munging might be needed for symbols which are defined in multiple source files, but surely it's manageable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741629/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor741633"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compile as one huge object</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2017 16:16 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/741633/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Well, it would at least let you know whether your compiler's execution time is polynomial in the size of the translation unit.
      
          <div class="CommentReplyButton">
            <form action="/Articles/741633/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor741638"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compile as one huge object</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2017 17:40 UTC (Sat)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/741638/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's exactly what link-time optimization does.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741638/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor741637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compile as one huge object</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2017 17:44 UTC (Sat)
                               by <b>gutschke</b> (subscriber, #27910)
                              [<a href="/Articles/741637/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Compilers aren't optimized for this use case, and tend to run out of memory if you try to naively load everything into them at the same time. But even if that was taken care of, you are going to run into a lot of conflicts with incompatible reuse of symbols. You should try this one day on any project that is bigger than just a "toy" example. It usually turns out to be insanely painful.<br>
<p>
You also lose out on a lot of the error messages that you would normally *want* to get, when there are layering violations and code reaches into private implementation details of other parts of the system. So, in practice, you'd have to maintain the code so that it can be compiled in the traditional fashion (that would happen during normal development cycles) and so that it can be compiled as one big file. That's very painful for the developers.<br>
<p>
As far as I can tell, there are some compilers that internally do something similar to what you are suggesting. And with proper compiler support, it can of course be made to work. But honestly, from the developer's point of view, it ends up looking very similar to what is described in this article. And it would still need the same source-code annotations to help the compiler figure out which references are life and which ones aren't.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor741720"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compile as one huge object</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2017 16:06 UTC (Mon)
                               by <b>mwsealey</b> (guest, #71282)
                              [<a href="/Articles/741720/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Multi-file compilation is a thing. You can actually use both together - the key aspect if LTO as per the article is putting each function and data item in it's own named section, because the linker can only act on individual sections as an unbreakable unit. Multi-file complication would still allow you to do this, but also provide greater inlining opportunities at the compiler level (for functional equivalence or tail-calling) which the linker has less information about.<br>
<p>
It's probably best to leave the MFC part on a per module/subsystem basis (so, anything that gets a built-in.o) and then LTO both the main kernel binary and any modules. The difficulty is going to be making sure that public functions do not<br>
get LTO'd away, while C99 inlining somewhat forces preservation of the 'original' function even if it inlines everything, LTO could strip it out if there's no out-of-line reference to it, and then your modules wouldn't load.<br>
<p>
It's a pain in the backside, all told, but the results are always worth it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741720/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor741658"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2017 3:39 UTC (Sun)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/741658/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This work would probably be useful for Intel's KVM based Clear Containers, now renamed to Kata Containers:<br>
<p>
<a href="https://katacontainers.io/">https://katacontainers.io/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/741658/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor742105"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2017 8:55 UTC (Fri)
                               by <b>linusw</b> (subscriber, #40300)
                              [<a href="/Articles/742105/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just love this metaphor with the open source gravity field.<br>
<p>
It comes close to describing how it actually works and correspond with the social law that people like to belong to something and to get recognition from their peers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/742105/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor742143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2017 16:41 UTC (Fri)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/742143/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; "So what does "tiny" actually mean? Let's define it as a sub-megabyte system or thereabout. "</font><br>
<p>
"See? See? I told you that nobody really *needed* more than 640K of memory," said Gill Bates.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/742143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor742150"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2017 18:37 UTC (Fri)
                               by <b>liw</b> (subscriber, #6379)
                              [<a href="/Articles/742150/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
During this time of the year, in the northern parts of the northern hemisphere, it is good to repeat that often: 640K ought to be enough for everyone. Any hotter and it'll get really uncomfortable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/742150/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor742173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with link-time garbage collection</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2017 0:18 UTC (Sat)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/742173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed, 692F will have you jamming to Talking Heads "Burning Down the House", albeit briefly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/742173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor743049"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with intelligent config</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2018 20:42 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/743049/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From what I've picked up no-one's even considering this, but what I'd like to see is the kernel config system made much simpler.<br>
<p>
It would be nice if there was a hardware section, so you could, say, select "AMD system". This would then ask you "which processor", "which chipset", "which motherboard" etc, and that will select the options to pull in all the drivers for that specific hardware.<br>
<p>
If you've got fixed hardware, like a router for example, you would then be able to compile all the drivers into the kernel, plus maybe a load of modules for USB for stuff you want to support. It would be great for size reduction - and security - making it far easier to create targeted monolithic kernels with no extra stuff beyond what you need.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743049/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor743067"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with intelligent config</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2018 21:31 UTC (Thu)
                               by <b>gregkh</b> (subscriber, #8)
                              [<a href="/Articles/743067/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; From what I've picked up no-one's even considering this, but what I'd like to see is the kernel config system made much simpler.</font><br>
<p>
This comes up all the time, everyone wants it done, no one has actually taken the time to do it :(<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743067/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor743127"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with intelligent config</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2018 0:40 UTC (Fri)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/743127/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What's wrong with `make localmodconfig`?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743127/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor743176"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with intelligent config</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2018 12:01 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/743176/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've got to have a running kernel first.<br>
<p>
Plus I think there's other stuff wrong with it from my view.<br>
<p>
Plus I think it defines things as modules, not loaded in.<br>
<p>
Plus what happens if the plug-in hardware is still awaiting delivery.<br>
<p>
Localmodconfig is a good idea, don't get me wrong. But it doesn't satisfy all use cases, and building a kernel specifically configured to a known hardware set is one of them.<br>
<p>
(Don't forget I run gentoo :-) so building targeted kernels is normal. And I've been floating around the linux scene since kernel 1.3 ... :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743176/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor743419"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with intelligent config</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2018 4:39 UTC (Sun)
                               by <b>fest3er</b> (guest, #60379)
                              [<a href="/Articles/743419/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Any reason the output of 'lshw' can't be twerked and combined with a file that lists 'hardware to be added' and 'features to be included' to provide input to a kernel configurator? You don't so much need to know how the hardware is laid out as you need to know which hardware is present. The configurator should then be able to enable just those bits of kit and features and dependencies....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743419/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor743055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The asteroid belt</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2018 20:54 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/743055/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The tiny computing space is just like an asteroid field; numerous projects exist, but they lack the required center of gravity for effective and self-sustained communities to form naturally around them. Consolidation efforts are moving slowly because of that. The end result is a highly fragmented space with relatively few developers per project and, therefore, fewer resources to rely upon when issues come up. Vulnerabilities are more likely to turn into a security nightmare.</font><br>
<p>
Actually, as an astronomer, they DON'T lack the required centre of gravity (at least, that's not the main problem). The asteroid belt has insufficient distance between it and Mars and Saturn, so should a cluster of asteroids happen to form and start coalescing (as you'd expect), every time Saturn goes past the gravitational disruption pushes them apart again. They're literally torn apart by gravitational tides from nearby larger objects.<br>
<p>
Which could also be a good analogy as to what happens to these small projects - the developers are heavily subjected to being lured away by larger projects in the same general eco-system.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor743420"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The asteroid belt</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2018 4:43 UTC (Sun)
                               by <b>fest3er</b> (guest, #60379)
                              [<a href="/Articles/743420/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
(I like to pick nits....)<br>
<p>
I trust you meant Jupiter....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/743420/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2017, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
