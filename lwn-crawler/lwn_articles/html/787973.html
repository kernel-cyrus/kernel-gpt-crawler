        <!DOCTYPE html>
        <html lang="en">
        <head><title>DAX semantics [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/787973/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/787960/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/787973/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>DAX semantics</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 13, 2019</br>
           <hr>
<a href="/Articles/lsfmm2019/">LSFMM</a>
</div>
<p>
In the filesystems track at the 2019 Linux Storage, Filesystem, and
Memory-Management Summit, Ted Ts'o led a discussion about an inode flag to
indicate DAX files, which is meant to be applied to files that should be
directly accessed without going through the page cache.  XFS has such a
flag, but ext4 and 
other filesystems do not.  The semantics of what the flag would mean are
not clear to Ts'o (and probably others), so the intent of the discussion
was to try to nail those down.
</p>

<p>
Dan Williams said that the XFS DAX flag is silently ignored if the device
is not DAX capable. Otherwise, the file must be accessed with DAX.  Ts'o said
there are lots of questions about what 
turning on or off a DAX flag might mean; does it matter whether there are
already pages in the page cache, for example.  He said that he did not have any
strong preference but thought that all filesystems should stick with one
interpretation. 
</p>

<p>
While Christoph Hellwig described things as "all broken", Ts'o was hoping
that some agreement could be reached among the disparate ideas of what a
DAX flag would mean.  A few people think there should be no flag and that
it should all be determined automatically, but most think the flag is
useful.  He suggested starting with something "super conservative", such as
only being able to set the flag for zero-length files or only empty
directories where the files in it would inherit the flag.  Those constraints
could be relaxed later if there was a need.
</p>

<a href="/Articles/788291/">
<img src="https://static.lwn.net/images/2019/lsf-tso-sm.jpg" border=0 hspace=5 align="right"
alt="[Ted Ts'o]" title="Ted Ts'o" width=236 height=280>
</a>

<p>
Boaz Harrosh wondered why someone might want to turn DAX off for a
persistent memory device.  Hellwig said that the performance "could suck";
Williams noted that the page cache could be useful for some applications as
well.  Jan Kara pointed out that reads from persistent memory are close to DRAM
speed, but that writes are not; the page cache could be helpful for frequent
writes.  Applications need to change to fully take advantage of DAX,
Williams said; part of the promise of adding a flag is that users can do
DAX on smaller granularities than a full filesystem.
</p>

<p>
When he developed DAX, he added the DAX flag as a "chicken bit", Matthew
Wilcox said.  The intent was that administrators could control the use of
DAX on their systems; he would like to preserve that ability going
forward.  It may not only depend on whether the application is DAX aware or
not, but also on the workload that the application is handling.  Ts'o said
that there may be applications that want to use persistent memory in its
"full unexpurgated form"; requiring administrators to set a flag on a file
to enable that is not particularly friendly. Wilcox agreed, saying that he
did not want to make administrator's jobs harder, but he did want to
preserve the ability to override what an application developer chose.
</p>

<p>
But Chuck Lever wondered why these DAX-aware applications would want to use
a filesystem at all; wouldn't they rather simply get access to a chunk of
persistent memory directly via <tt>mmap()</tt> or similar?  Williams said
that is exactly what DAX does; if you <tt>mmap()</tt> a DAX file, you get a
chunk of the persistent memory mapped in.  The problem is that other
applications using the same filesystem may not be ready to get that same
kind of access; they may be relying on filesystem semantics for file-backed
memory. 
</p>

<p>
One way to look at it, Ts'o said, is that if someone buys a chunk of
persistent memory for a single application that is going to use all of it,
they don't need a filesystem at all.  They can just point the application
directly at the block device.  But if someone wants to share that
persistent memory with multiple applications, user IDs, and such, then a
filesystem makes sense.
</p>

<p>
Lever asked why some kind of namespace would not be used to
make that distinction.  Williams said that administrators are used to the
tools to deal with filesystems and files, so that would make a better
interface.  For the "I know what I want" users, device DAX solves their
problems, but for other users, some other interface is needed and
file-oriented interfaces make the most sense.  In addition, Ts'o pointed
out that a namespace or bind mount is not sufficient since a file either
needs to use the page cache or it needs to stay completely out of it,
trying to do both will lead to problems.  Partitioning a block device into
DAX and non-DAX portions would be another way to make it all work, but that
lacks 
flexibility. 
</p>

<p>
An attendee asked what it meant for an application to be DAX aware.  
Williams said that DAX-aware applications want
to do in-place updates of their data and want to manage the CPU cache
themselves; these applications want to do accesses on data that is smaller
than a page in size directly in memory versus having some kind of buffering
or the page cache.
</p>

<p>
Ts'o said that there are a number of papers out there that describe
libraries that can use persistent memory to, for example, update a B-Tree
in place.  These algorithms do the operations in the right order and flush
the caches in such a way that a crash at any point will leave the data
structure in a consistent state.  It is important to note that these are
libraries that would be used by applications because Ts'o said he would not
normally trust application authors to get this kind of thing right.  But
Hellwig expressed skepticism that any non-academic filesystem author would
actually trust the CPU's memory subsystem to always get this right; that
was met with a fair amount of laughter. 
</p>

<p>
Amir Goldstein asked how allowing DAX and non-DAX access to a file was
different from allowing buffered and direct I/O access to the same file.
Hellwig said that, while mixing buffered and direct I/O is allowed, it does
not give the results that users expect.
Goldstein also asked about mixing direct I/O and DAX, but that does not work,
Kara said; mixing buffered and direct I/O doesn't really work either, but
the kernel pretends that it does.  For DAX, kernel developers decided not
to repeat that 
mistake. 
</p>

<p>
Direct I/O and DAX do not work together, but they could if someone wanted
to rework the existing implementation, Hellwig said.  It would be useful to
be able to read persistent memory without using the page cache and to write
via the page cache, but 
it would be
tremendously complex to handle the CPU cache coherency correctly,
which is probably what has scared everyone away.  Another problem is when a
DAX-aware application gets surprised by having the page cache between it
and persistence; it believes that the cache-flush instructions it issues
are making the data persistent when they are not.
</p>

<p>
But Hellwig said that there is an API problem if applications are issuing
"random weird instructions" and expecting them to work; there are too many
other layers potentially in between the application and the storage.  He is
not entirely sure that making these kinds of programming models more
widespread is a good idea, but if that's the path that will be taken, there
should be some kind of interface at the VDSO level that applications can call
where the kernel will ensure that they do the right thing.  The kernel will
issue the 
proper cache-flush instructions or whatever else is necessary.  The
existing model for applications "can't ever work", he said.
</p>

<p>
Ts'o said that there can be a debate about how reliable these models and
cache-flush instructions truly are, but he is reasonably confident that if
they don't work, the hardware vendors will fix them when customers put
pressure on them.  In any case, though,
that is orthogonal to the question of having a per-file DAX flag and what
its semantics should be.
</p>

<p>
Williams said he was uncomfortable calling it a "DAX flag", though he
acknowledged that could lead directly to the bike shed.  He thought that
perhaps a <tt>MAP_SYNC</tt> flag on the inode would be better.  Hellwig
suggested that 
the name "DAX" should be retired because it is confusing at this point; he,
of course, had his own suggestion for a name for the flag ("writethrough"),
as did 
several others, though no real conclusion was reached.
</p>

<p>
The discussion moved onto how the flag, however named, could be set.  Ts'o
said he was uncomfortable restricting it to empty directories, and then
having all of the
files in it inheriting the attribute, due to hard links and renames.  If
that is really going to be the way forward, then filesystems need to look
at restricting hard links and renames.  This is why he wants to nail down
the semantics before implementing it in filesystems.
</p>

<p>
Lever is uncomfortable with a "permanent sticky bit" in the filesystem that
is set by administrators, however.  He is concerned that administrators
will turn it off when it needs to be on, or the reverse; he wondered if a
flag to <tt>open()</tt> was a better path, since the application should
know what it needs.  But Hellwig pointed out that <tt>open()</tt> flags are
not checked to see if unsupported options are being passed; applications
could not be sure to get the behavior they asked for.
</p>

<p>
Williams pointed out that there already is a <tt>dax</tt> mount option, so
that ship has already sailed to some extent.  Ts'o also noted that
<tt>open()</tt> is not the right time to specify this; it needs to be a
property of the file itself.  If the file is opened twice, once with DAX and
once without, what would that mean?  One way to handle that might be to
fail an <tt>open()</tt> with the "wrong" mode if the file is already open;
the "real disaster" for buffered versus direct I/O was in allowing both
types of <tt>open()</tt> to succeed.  Beyond that, though, Hellwig was
emphatic that <tt>open()</tt> flags should never be used for data integrity
purposes. 
</p>

<p>
Sprinkled throughout the latter part of the discussion were more
suggestions of different names for the flag, but Ts'o thinks they are stuck
with the DAX name.  There were also questions about how per-file flags
interact with the global mount option, including whether a <tt>nodax</tt>
mount option was required.  Most seemed to think that option was not
needed, however.
</p>

<p>
In summary, Ts'o said that he thought the overall consensus was to have a
flag for empty directories that would be inherited on files created there.
The flag could also be set for zero-length files and he heard no enthusiasm
for allowing the flag to be cleared once it was set.  He plans to summarize
the discussion in a post to the relevant mailing lists (fsdevel and DAX)
for further discussion.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#DAX">DAX</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Nonvolatile_memory">Memory management/Nonvolatile memory</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2019">Storage, Filesystem, and Memory-Management Summit/2019</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/787973/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor788310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">DAX semantics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2019 1:04 UTC (Tue)
                               by <b>gutschke</b> (subscriber, #27910)
                              [<a href="/Articles/788310/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If regular file I/O and DAX semantics are mutually exclusive, then setting a flag on the file is going to be an administrative pain. All of a sudden, there is a file that cannot be accessed with "normal" UNIX tools. How about calling "file", "sed", "dd", "tar", or "cp" on a DAX file? These all seem reasonable administrative things to do -- at least whenever the file isn't concurrently opened in DAX mode.<br>
<p>
I think, from a usability point of view, having a flag on open() is a lot less surprising for any object that lives inside of the filesystem namespace. I do agree though, that files should lock out incompatible access modes, if they have already been opened in another mode. There is some precedence for that. open() already returns ETXTBSY in similar situations. Currently, that can only happen for write access, but it wouldn't be too far-fetched to also do so for write access of DAX files.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788311"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">DAX semantics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2019 1:13 UTC (Tue)
                               by <b>gutschke</b> (subscriber, #27910)
                              [<a href="/Articles/788311/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
$s/write/read/<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788311/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">DAX semantics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 18:15 UTC (Fri)
                               by <b>mcr</b> (subscriber, #99374)
                              [<a href="/Articles/789380/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I want to echo gutschke's comments about the flag causing standard tools to break.  They should continue to work for read-only, as getting good backups depends upon this.<br>
Backups in general are a big issue, I have wanted the VFS layer to provide better access to backups for along time.  I would go as far as saying that file systems should be able to turn file contents plus *all* metadata (and extensions, etc.) into POSIX CPIO format directly.  (Or, dump format, but I think that is far less standard) The CPIO/TAR/etc. can't be expected to keep up with whatever innovation file system creators are doing.  This would significantly free file systems to innovate more, knowing that backup tools would continue to work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor788332"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">DAX semantics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2019 13:09 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/788332/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
Hellwig was emphatic that open() flags should never be used for data integrity purposes
</blockquote>
What are O_SYNC et al, if not that?
      
          <div class="CommentReplyButton">
            <form action="/Articles/788332/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788334"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2019 13:41 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/788334/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      I believe that <tt>O_SYNC</tt> exactly illustrates his point.  Since older kernels will simply ignore that flag, an application can never know that it's actually getting the behavior it's asking for.  If you must know that your data has made it to media, you still have to call <tt>fsync()</tt> regardless of whether you opened with <tt>O_SYNC</tt>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/788334/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788337"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2019 13:59 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/788337/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can we patch up the broken open() interface with a system call that, given an open file descriptor, returns back the flags that are in effect?  So you could open() and then check that none of the flags you passed were ignored...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788337/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788340"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2019 14:20 UTC (Tue)
                               by <b>jlayton</b> (subscriber, #31672)
                              [<a href="/Articles/788340/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
fcntl(F_GETFL, ...) ?<br>
<p>
...though I'm not sure how accurate that is across filesystems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788340/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor788425"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2019 13:31 UTC (Wed)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/788425/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And then what? If it turns out to be unsupported and the application is supposed to cope with that, it'll need to fall back to fsync at runtime. Which means that this detour can be avoided by simply using fsync all the time.<br>
<p>
NB: I strongly suspect that a huge number of 'practical' O_SYNC uses will be entirely gratuitious performance drags because it's being employed as "magic countermeasure" for occasional data corruption caused by writing through dangling pointers.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788425/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788523"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2019 15:41 UTC (Wed)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/788523/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If latency is more relevant than throughout there can be decent reasons to use O_SYNC. The fact that an fsync might later need to flush large amounts of data, possibly generated by different processes, can be quite problematic. Using sync instead puts the cost at the writer, instead of a more or less random time later (i.e. when dirty limits are reached). <br>
<p>
<p>
Really wish there were a good posix way to tell the kernel 1) initiate write back very soon, I'm not going to redirty 2) I am / am not going to read that data again soon. 3) amount of pending dirty data is limited.<br>
<p>
But without the perf overhead of O_SYNC (which often will end up generating much more random writes than necessary). One can get there using sync_file_range(WRITE) plus fadvise. But it's much harder than necessary.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788523/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788587"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 0:34 UTC (Thu)
                               by <b>TMM</b> (subscriber, #79398)
                              [<a href="/Articles/788587/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's what fadvise is for, it works pretty well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788587/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788592"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 2:14 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/788592/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  That's what fadvise is for, it works pretty well.</font><br>
<p>
I referenced fadvise?<br>
<p>
And no, it doesn't. You can't initiate writeback with it, without also causing the page cache contents to be thrown out. For that you need sync_file_range(SYNC_FILE_RANGE_WRITE).<br>
<p>
And to not suck performance-wise you need to coalesce the sync_file_range() calls in userspace, and issue them over larger ranges of blocks, otherwise there'll be unnecessarily random IO. And no, just write()ing larger blocks isn't really a good solution either.<br>
<p>
To me this is the kernel's job, and I should easily be able to a) max amount of dirty data caused by an process for an fd b) that I'm not going to redirty data that's being written, and that writeback should write back whenever it makes sense from a granularity perspective (i.e. optimize for efficient writes, without unnecessarily keeping dirty till the next dirty_writeback_centisecs).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788592/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor788704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 17:19 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/788704/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fsync is a system call which flushes all outstanding writes for a file referred to by a certain file descriptor. That's not the same as the sync system call.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788705"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 17:40 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/788705/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Fsync is a system call which flushes all outstanding writes for a file referred to by a certain file descriptor. That's not the same as the sync system call.</font><br>
<p>
Uh, yes, obviously? What does that have to do with what I wrote? You can have a lot of dirty data for a single fd?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788705/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 18:53 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/788713/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; The fact that an fsync might later need to flush large amounts of data, possibly generated by different processes, can be quite </font><br>
<font class="QuotedText">&gt;&gt; problematic. Using sync instead puts the cost at the writer, instead of a more or less random time later (i.e. when dirty limits are &gt;&gt; reached). </font><br>
<p>
Looks like a description of the sync system call (or rather, it looks less like something which doesn't describe sync than like something which doesn't describe fsync :-&gt;).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 20:04 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/788717/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was just talking about O_SYNC, the topic of this subthread (and referenced a few words before and after). On a phone, which makes capitalizing words a pain.  If you use O_SYNC the amount of dirty data that later needs to be written back (after dirty_{writeback_centisecs, background_bytes, bytes, ...} or fsync) is pretty limited. Therefore not incurring latency at the later stage where an fsync() might need to write back huge amounts of data, or where write() might suddenly block (due to dirty_bytes), or where read() will be slow because dirty_writeback_centisecs/fsync triggered a lot of IO submissions in a very short amount of time.<br>
<p>
When using O_SYNC, or controlling writeback using sync_file_range(SYNC_FILE_RANGE_WRITE) etc, you prevent these latency type issues.<br>
<p>
It's quite possible, although the linux kernel has improved a fair bit in that regards in the last few years, to trigger individual read()s taking many seconds, because the kernel is busy flushing back a few gigabytes of dirty data. <br>
<p>
<p>
I explained this because you said:<br>
<font class="QuotedText">&gt; Which means that this detour can be avoided by simply using fsync all the time.</font><br>
etc.  Which I think is not correct.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788718"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2019 20:38 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/788718/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When using fsync, the amount of data which will be written back is just as limited: It's outstanding modifications to a certain open file, this referring to a per-process data structure referred to by a file descriptor. This can be as little or as much as an individual application desires it to be as it's up to the application to call fsync whenever this makes sense.<br>
<p>
Dirty_writeback_centics is a /proc-file which can be used to change the time interval between automatically performed sync-operation by the kernel. That's still sync and not fsync.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788718/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2019 4:48 UTC (Fri)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/788738/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You appear to intentionally misunderstanding, and/or you're making entirely unrelated statements. <br>
<p>
<font class="QuotedText">&gt; Dirty_writeback_centics is a /proc-file </font><br>
<p>
What on earth made you think I didn't know that?<br>
<p>
<p>
<font class="QuotedText">&gt; which can be used to change the time interval between automatically performed sync-operation by the kernel. That's still sync and not fsync.</font><br>
<p>
It's neither. Writeback triggered by those controls doesn't trigger data integrity flushes, but sync(1) and fsync() do.<br>
<p>
<p>
<font class="QuotedText">&gt; It's outstanding modifications to a certain open file, this referring to a per-process data structure referred to by a file descriptor. This can be as little or as much as an individual application desires it to be as it's up to the application to call fsync whenever this makes sense.</font><br>
<p>
Well, fsync is synchronous, so constantly emitting it is less performant than the alternative I mentioned with controlling writeback via sync_file_range() (and less efficient than what I wished for) - needs to interact with the drive cache. And where have I doubted that one can also issue fsyncs to control the amount of outstanding data?<br>
<p>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor788799"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2019 17:28 UTC (Fri)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/788799/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; Dirty_writeback_centics is a /proc-file</font><br>
<font class="QuotedText">&gt; What on earth made you think I didn't know that?</font><br>
<p>
Why did you hack this sentence apart in order to insert a (wrong) conjecture about something I could have thought?<br>
<p>
<font class="QuotedText">&gt;&gt;  which can be used to change the time interval between automatically performed sync-operation by the kernel. That's </font><br>
<font class="QuotedText">&gt;&gt; still sync and not fsync.</font><br>
<font class="QuotedText">&gt; It's neither. </font><br>
<p>
Indeed. The name is obviously different. Nevertheless, it refers to a timeout for periodically flushing all dirty page cache pages to stable storage, just like the sync but not the fsync system call would do, IOW, the combination "dirty_writeback_centisecs/fsync" makes no sense. For the case of a single process writing to a certain open file, the effects of O_SYNC are by definition (POSIX) identical to pairing each write(2) with an fsync(2) on the same file descriptor. As additional benefit, fsync is more portable and it enables application to batch several writes if so desired, eg, when creating a file, write the complete file content and then fsync it.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788799/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2019 23:10 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/789052/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
Nevertheless, it refers to a timeout for periodically flushing all dirty page cache pages to stable storage, just like the sync but not the fsync system call would do
</blockquote>
Except that's not what it does. Every dirty_writeback_centisecs, dirty inodes that became dirty longer ago than dirty_writeback_centisecs are flushed. inodes that were dirtied more recently than that are *not* flushed. That's nothing like sync(), which flushes everything regardless of first dirty time, and you can't do it with fsync() either (even if you track the timing yourself, good luck with that) because there is extra behaviour regarding flushes that take too long which cannot be mimicked with fsync().

      
          <div class="CommentReplyButton">
            <form action="/Articles/789052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor788742"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2019 7:38 UTC (Fri)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/788742/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Depending on the behaviour of the underlying filesystem, calling fsync() can reify rather more write()s than just the ones to the fd you're fsync()ing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788742/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 13:46 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/789687/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Applications should not have to concern themselves with filesystem-specific code.<br>
<p>
THAT caused major grief at the ext3/4 transition, iirc. ext3 was "save your data - friendly" by accidental default. ext4 was not. ext3 was NOT sync-friendly, ext4 was.<br>
<p>
So you had a choice - write an ext4-friendly program and watch performance go through the floor on ext3, or an ext3-friendly program and watch crashes corrupt your data. NOT nice.<br>
<p>
I don't want to know what filesystem my application is running on. I don't want serious differences in behaviour based on that fact. And as someone who is interested in databases and logging and all that, I also probably don't care whether my data made it to disk okay or not, I just want to know that whatever is on disk is consistent!<br>
<p>
So the ability to put a "write barrier" in the queue, between the "write the log" and "update the files", is actually important to me. If the log is not updated properly, then the transaction is lost. If the log is safe, and the files are not, I can recover the transaction. Either way, the data is consistent. But if the filesystem moves HALF the file updates before the log is properly saved, I'm screwed.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2019 23:03 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/789051/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
It's outstanding modifications to a certain open file, this referring to a per-process data structure referred to by a file descriptor
</blockquote>
That's not actually true (though in practice it usually is). It's outstanding modifications to a certain open file, this referring to a file <i>description</i> (not descriptor). This is not a single-process entity but can be shared among processes, all of which can be writing to the file description simultaneously: all that data needs synchronous flushing if O_SYNC is on, and the other writing processes will all be blocked if they try to write to it while that write is ongoing.
      
          <div class="CommentReplyButton">
            <form action="/Articles/789051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor788847"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_SYNC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2019 11:49 UTC (Sun)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/788847/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I meant for open flags in general, not just O_SYNC. Possibly it would be useful to introspect these things anyway, as when a process inherits open filehandles from its parent. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/788847/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
