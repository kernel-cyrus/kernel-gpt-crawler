        <!DOCTYPE html>
        <html lang="en">
        <head><title>On the value of static tracepoints [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/330402/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/329788/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/330402/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>On the value of static tracepoints</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 28, 2009</br>
           </div>
As has been well publicized by now, the Linux kernel lacks the sort of
tracing features which can be found in certain other Unix-like kernels.
That gap is not the result of a want of trying.  In the past,
developers trying to put tracing infrastructure into the kernel
have often run into a number of challenges, including opposition from their
colleagues who do not see the 
value of that infrastructure and resent its perceived
overhead.  More recently, it would seem that the increased
interest in tracing has helped developers to overcome some of those
objections; an ongoing
discussion shows, though, that concerns about tracing are still alive and
have the potential to derail the addition of tracing facilities to the
kernel. 
<p>
Sun's DTrace is famously a dynamic tracing facility, meaning that it can be
used to insert tracepoints at (almost) any location in the kernel.  But the
Solaris kernel also comes with <a
href="http://docs.sun.com/app/docs/doc/817-6223">an extensive and
well-documented set of static tracepoints</a> which can be activated by
name.  These tracepoints have been placed at carefully-considered locations
which facilitate investigations into what the kernel is actually doing.
Many real-world DTrace scripts need only the static tracepoints and do no
dynamic tracepoint insertion at all.
<p>
There is clear value in these static tracepoints.  They represent the
wisdom of the developers who (presumably) are the most familiar with each
kernel subsystem.  System administrators can use them to extract a great
deal of useful information without having to know the code in question.
Properly-placed static tracepoints bring a significant amount of transparency to
the kernel.  As tracing capabilities in Linux improve, developers naturally
want to provide a similar set of static tracepoints.  The fact that static
tracing is reasonably well supported (via FTrace) in mainline kernels -
with more extensive support available via SystemTap and LTTng - also
encourages the creation of static tracepoints.  As a result, there have
been recent patches adding tracepoints to <a
href="http://lwn.net/Articles/330004/">workqueues</a> and <a
href="http://lwn.net/Articles/329577/">some core memory management
functions</a>, among others.
<p>
<h3>Digression: static tracepoints</h3>
<p>

As an aside, it's worth looking at the form these tracepoints take; the
design of Linux tracepoints gives a perspective on the problems they were
intended to solve.  As an example, consider the following 
tracepoints for the memory management code which reports on
page allocations.  The declaration of the tracepoint looks like this:

<p>
<pre>
    #include &lt;linux/tracepoint.h&gt;
  
    TRACE_EVENT(mm_page_allocation,

	TP_PROTO(unsigned long pfn, unsigned long free),

	TP_ARGS(pfn, free),

	TP_STRUCT__entry(
		__field(unsigned long, pfn)
		__field(unsigned long, free)
	),

	TP_fast_assign(
		__entry-&gt;pfn = pfn;
		__entry-&gt;free = free;
	),

	TP_printk("pfn=%lx zone_free=%ld", __entry-&gt;pfn, __entry-&gt;free)
	);
</pre>
<p>

That seems like a lot of boilerplate for what is, in a sense, a switchable
<tt>printk()</tt> call.  But, naturally, there is a reason for each piece.
The <tt>TRACE_EVENT()</tt> macro declares a tracepoint - this one is called
<tt>mm_page_allocation</tt> - but does not yet instantiate it in the code.
The tracepoint has arguments which are passed 
to at its actual instantiation (which we'll get to below); they are
declared fully in the <tt>TP_PROTO()</tt> macro and named in the
<tt>TP_ARGS()</tt> macro.  Essentially, <tt>TP_PROTO()</tt> provides a
function prototype for the tracepoint, while <tt>TP_ARGS()</tt> looks like
a call to that tracepoint.  
<p>
These values are enough to let the programmer
place a tracepoint in the code with a line like:
<p>
<pre>
    trace_mm_page_allocation(page_to_pfn(page),
			     zone_page_state(zone, NR_FREE_PAGES));
</pre>
<p>
This tracepoint is really just a known point in the code which can have, at run
time, one or more function pointers stored into it by in-kernel tracing
utilities like SystemTap or 
Ftrace.  When the tracepoint is enabled, any functions stored there will be called with
the given arguments.  In this case, enabling the tracepoint will result in
calls whenever a page is allocated; those calls will receive the page frame
number of the allocated page and the number of free pages remaining as
parameters. 

<p>
As can be seen in the declaration above, there's more to the tracepoint 
than those arguments; the rest of
the information in the tracepoint declaration is used by the Ftrace
subsystem.  Ftrace has a couple of 
seemingly conflicting goals; it wants to be able to quickly enable
human-readable output from a tracepoint with no external tools, but the
Ftrace developers also want to be able to export trace data from the kernel
quickly, without the overhead of encoding it first.  And that's where the
remaining arguments to <tt>TRACE_EVENT()</tt> come in.
<p>
When properly defined (the magic exists in a bunch of header files under
<tt>kernel/trace</tt>), <tt>TP_STRUCT__entry()</tt> adds extra fields to
the structure which represent the tracepoint; those fields should be
capable of holding the binary parameters associated with the tracepoint.
The <tt>TP_fast_assign()</tt> macro provides the code needed to copy the
relevant data into that structure.  That data can, with some changes merged
for 2.6.30, be exported directly to user space in binary format.  But, if
the user just wants to see formatted information, the <tt>TP_printk()</tt> macro
gives the format string and arguments needed to make that happen.
<p>
The end result is that defining a tracepoint takes a small amount of work,
but using it thereafter is relatively easy.  With Ftrace, it's a simple
matter of accessing a couple of debugfs files.  But other tools, including
LTTng and SystemTap, are also able to make use of these tracepoints.  
<p>
<h3>The disagreement</h3>
<p>
Given all the talk about tracing in recent years, there is clearly demand
for this sort of facility in the kernel.  So one might think that adding
tracepoints would be uncontroversial.  But, naturally enough, it's not that
simple.
<p>
The first objection that usually arises has to do with the performance
impact of tracepoints, which are often placed in the most
performance-critical code paths in the kernel.  That is, after all, where
the real action happens.  So adding an unconditional function call to
implement a tracepoint is out of the question; even putting an <tt>if</tt>
test around it is problematic.  After literally years of work, the
developers came up with a scheme <strike>involving run-time code patching</strike> that
reduces the performance cost of an inactive tracepoint to, for all
practical purposes, zero.  Even the most performance-conscious developers
have stopped fretting about this particular issue.  But, of course, there
are others.
<p>
A tracepoint exists to make specific kernel information available to user
space.  So, in some real sense, it becomes part of the kernel ABI.  As an
ABI feature, a tracepoint becomes set in stone once it's shipped in a
stable kernel.  There is not a universal agreement on the immutability of
kernel tracepoints, but the simple fact is that, once these tracepoints
become established and prove their usefulness, changing them will cause
user-space tracing tools to break.  That means that, even if tracepoints
are not seen as a stable ABI the way system calls are, there will still be
considerable resistance to changing them.  
<p>
Keeping tracepoints stable when the code around them changes will be a
challenge.  A substantial subset of the developer community will probably
never use those tracepoints, so they will tend to be unaware of them and
will not notice when they break.  But even a developer who is trying to
keep tracepoints stable is going to run into trouble when the code evolves
to the point that the original tracepoint no longer makes sense.  One can
imagine all kinds of cruft being added so that a set of tracepoints gives
the illusion of a very different set of decisions than is being made in a
future kernel; one can also imagine the hostile reception any such code
will find.
<p>
The maintenance burden associated with tracepoints is the reason behind
Andrew Morton's opposition to their addition.  With regard to the workqueue
tracepoints, Andrew <a href="/Articles/330456/">said</a>:
<p>
<div class="BigQuote">
	If someone wants to get down and optimise our use of workqueues
	then good for them, but that exercise doesn't require the permanent
	addition of large amounts of code to the kernel.

	The same amount of additional code and additional churn could be
	added to probably tens of core kernel subsystems, but what _point_
	is there to all this?  Who is using it, what problems are they
	solving?
	<p>
	We keep on adding all these fancy debug gizmos to the core kernel
	which look like they will be used by one person, once.  If that!
</div>
<p>

Needless to say, the tracing developers see the code as being more widely
useful than that.  Frederic Weisbecker gave <a href="/Articles/330457/">a
detailed description</a> of the sort of debugging which can be done with
the workqueue tracepoints.  Ingo Molnar's <a
href="/Articles/330568/">response</a> appears to be an attempt to hold up
the addition of other types of kernel instrumentation until the tracepoint
issue is resolved.  Andrew remains unconvinced, though; it seems he
would rather see much of this work done with dynamic tracing tools
instead.
<p>
As of this writing, that's where things stand.  If these tracepoints do not
get into the mainline, it is hard to see developers going out and creating
others in the future.  So Linux could end up without a set of well-defined
static tracepoints for a long time yet - though it would not be surprising
to see the enterprise Linux vendors adding some to their own kernels.  Perhaps
that is the outcome that the development community as a whole wants, but
it's not clear that this 
feeling is universal at this time.  If, instead, Linux is going to end up
with a reasonable set of tracepoints, the development community will need
to come to some sort of consensus on which kinds of tracing instrumentation
is acceptable.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_tools-Kernel_tracing">Development tools/Kernel tracing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Ftrace">Ftrace</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Tracing">Tracing</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/330402/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor330635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 17:33 UTC (Tue)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/330635/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would it help to define the tracepoints deeper in the kernel internals as kernel version-dependent APIs, and warn that any application or script using them may be tied to a few kernel versions?  It might help if the user space APIs for accessing static tracepoints were able to fail with something equivalent to "tracepoint no longer available", and this was clearly documented.  And including the version number of the kernel where the tracepoint first appeared in the tracepoint name might be a hint too.  Presumably though most users of these tracepoints would be sufficiently tied to those kernel versions anyway that this would not be such an issue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330641"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 18:13 UTC (Tue)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/330641/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It might help if the user space APIs for accessing static tracepoints were </font><br>
<font class="QuotedText">&gt; able to fail with something equivalent to "tracepoint no longer available",</font><br>
<font class="QuotedText">&gt; and this was clearly documented</font><br>
<p>
It's not an API in the sense of a programming interface, but the way<br>
systemtap exposes tracepoints (and indeed any other event source such<br>
as kprobes, utrace events, timers, ....), is that an attempt to attach<br>
to a facility that does not exist/match results in just such an error<br>
message.<br>
<p>
Systemtap also has some facilities to adapt to changes in kernels and<br>
elsewhere, using both a preprocessor construct (similar to a #if <br>
KERNEL_VERSION), and a syntax to specify a list of alternative sources<br>
of the same events (the "?" and "!" operators in a probe point sequence).<br>
<p>
So systemtap's use of tracepoints in no way imposes a requirement that<br>
they be unmodified and permanent.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330641/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor330687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 19:59 UTC (Tue)
                               by <b>ajb</b> (guest, #9694)
                              [<a href="/Articles/330687/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe these developer-only API's should only get enabled by a magic sysrq key being pressed on the console. That way software which uses them can't become embedded in end-user software.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor330640"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 18:06 UTC (Tue)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/330640/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; After literally years of work, the developers came up with a scheme </font><br>
<font class="QuotedText">&gt; involving run-time code patching that reduces the performance cost of an </font><br>
<font class="QuotedText">&gt; inactive tracepoint to, for all practical purposes, zero.</font><br>
<p>
Can someone point me to the code that applies code patching to tracepoints?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330640/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330668"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Code patching</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 18:33 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/330668/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Sigh.  I had figured that the <a rel="nofollow" href="http://lwn.net/Articles/245671/">immediate values/kernel marker</a> stuff was being used here, but a closer look makes it clear that tracepoints do not use that infrastructure.  Not sure why.  Sorry for the confusion.
      
          <div class="CommentReplyButton">
            <form action="/Articles/330668/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330678"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Code patching</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 19:21 UTC (Tue)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/330678/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The Immediate Values are still waiting in the LTTng tree. Actually, I am waiting to see enough tracepoints in the mainline Linux kernel to justify the use of Immediate Values before I re-post them. Otherwise, I seem to be the only one convinced of their use, given the number of tracepoints present in the LTTng kernel tree.<br>
<p>
Regarding Mainline, kmemtrace adds enough tracepoints to have a tiny, but measurable, impact on the localhost tbench workload (one would still have to figure out if it's really statistically significant by running more passes than I can given the time I have on my hands). Note that this workload is _very_ heavy on the number of tracepoint sites executed and sensitive to cache-line layout changes.<br>
<p>
I won't fight to push them, but if there is sufficient willingness to have them merged, I will consider posting them as a "git pull" request.<br>
<p>
Mathieu<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330678/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor330654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">patchset</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 18:26 UTC (Tue)
                               by <b>mattmelton</b> (guest, #34842)
                              [<a href="/Articles/330654/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
it would make more sense if someone maintained a patchset that provided the static trace points - ie: a dev kernel build. before a hacker makes the changes to their git repo public, they pop the patchset - or git does it for the developer magically. does git have the ability to transparently add/remove private patches like this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">patchset</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 19:59 UTC (Tue)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/330690/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It already exists, and it's called LTTng.<br>
<p>
See :<br>
<p>
<a href="http://git.kernel.org/?p=linux/kernel/git/compudj/linux-2.6-lttng.git">http://git.kernel.org/?p=linux/kernel/git/compudj/linux-2...</a><br>
<p>
Note that it contains both the instrumentation and the LTTng tracer.<br>
<p>
The patchsets are available at :<br>
<p>
<a href="http://www.kernel.org/pub/linux/kernel/people/compudj/patches/2.6/">http://www.kernel.org/pub/linux/kernel/people/compudj/pat...</a><br>
<p>
Mathieu<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor330671"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 18:43 UTC (Tue)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/330671/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Presumably DTrace has solved a lot of these concerns.  What decisions did they make?<br>
<p>
Also, what's wrong with letting tracepoints just disappear in new kernel releases?  Userspace should expect this and it can deal with it gracefully.<br>
<p>
Adding code to the kernel just to try to maintain tracepoint backward compatibility?  Hah!  That'll be the day.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330671/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330691"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 20:23 UTC (Tue)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/330691/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <I>Presumably DTrace has solved a lot of these concerns. What decisions did they make?</I>
<P>
I guess they are not releasing a new kernel every 3 months... I think this "new release every 3 months" schedule with the "no stable ABI" policy just doesn't work well with "enterprise". I mean an application developer or system administrator might spend a considerable time to get to know these tracepoints, but if they change with every release, then the users won't be happy. And it's not just tracepoints, but tuning parameters under /proc or /sys, configuration parameters, etc. Even filesystems can start to work differently with each new kernel version (see the ext3 issues). I would hate to develop for such a moving target (it's quite enough to follow the customer's requests).
<P>
On the other hand people are forced to upgrade to get the security fixes, so they can't afford to stay with the stable well-known solution. I know that this is the market for the enterprise distributions, but it also means that the kernels of the (enterprise) distributions are diverging from the mainline kernel, even though the new kernel development methodology supposed to prevent this.
<P>
Mark Shuttleworth had this idea some time ago that the distributions (or applications) should sync their releases. It might be useful if let's say RHEL, SLE[SD], Ubuntu LTS (and maybe Debian stable) would be released around the same time, would get the same kernel and the same tracepoints, tuning parameters, etc. This could be labelled as a .0 release. This way the enterprise distrubitions could also backport the same security fixes from the later kernel versions.
      
          <div class="CommentReplyButton">
            <form action="/Articles/330691/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 9:54 UTC (Wed)
                               by <b>flewellyn</b> (subscriber, #5047)
                              [<a href="/Articles/330757/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p><i>On the other hand people are forced to upgrade to get the security fixes, so they can't afford to stay with the stable well-known solution.</i></p>

<p>That's what the stable tree is for.  The 2.6.x.y ones.  You do know about those, yes?
      
          <div class="CommentReplyButton">
            <form action="/Articles/330757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 10:01 UTC (Wed)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/330758/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And a 2.6.29.1 stable release would help in what way on a 2.6.16 kernel? Because running the same kernel for two years *is* stability, changing kernels every 6 months is not.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 10:21 UTC (Wed)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/330759/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Obviously one would get the latest release for the kernel you are running. If that doesn't exist, maybe "stable" has become "obsolete". Arguing that "changing kernels" every six months is necessary is nonsense, even disregarding the fact that it has little or nothing to do with stability in the first place.
<p>
If it <em>has</em>, you are doing something wrong.


      
          <div class="CommentReplyButton">
            <form action="/Articles/330759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor330760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 10:22 UTC (Wed)
                               by <b>abacus</b> (guest, #49001)
                              [<a href="/Articles/330760/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you can't live with fast changes, stick to an enterprise distro. These distro's even offer a stable binary kernel API.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor330801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 16:12 UTC (Wed)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/330801/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
2.6.16 *was* maintained for over two years (and is no doubt still maintained by distributions even if the mainline support has been dropped). It's now been replaced by 2.6.27.x as the stable line. There's rather more than 6 months between 16 and 27, but if you really want long-term maintainence then you could always use 2.4.37.1. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332163"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 6, 2009 21:13 UTC (Wed)
                               by <b>roelofs</b> (guest, #2599)
                              [<a href="/Articles/332163/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <FONT COLOR="#884400"><I>... but if you really want long-term maintainence then you could always use 2.4.37.1.</I></FONT>

<P>
Not if you want a working ntpd.

<P>
Greg
      
          <div class="CommentReplyButton">
            <form action="/Articles/332163/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor330679"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Simplifying the declaration may help</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 19:26 UTC (Tue)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/330679/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>While I appreciate the value of trace points, if someone said they'd add 30 lines of macros to my lovely code because it might benefit a user someday, I'd probably not take kindly to it either.

<p>The printk support doesn't seem useful, it's like a design argument was abandoned in favour of implementing both sides of the debate. Even with printk, it should be possible to combine instantiation + declaration like so:

<pre>#define TRACE_EVENT(name, assign, fields...)

TRACE_EVENT(mm_page_allocation,
            ({ t->pfn = pfn; t->free = free; }),
            unsigned long pfn, unsigned long free)</pre>

<p>The <kbd>fields</kbd> argument could be stringified with cpp's paste operator and converted to a format string on first use at runtime, or perhaps by reading debug information during the build.
      
          <div class="CommentReplyButton">
            <form action="/Articles/330679/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330686"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Simplifying the declaration may help</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 19:56 UTC (Tue)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/330686/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a no-go, as Linux Kernel Markers history has shown. It's good for debug-style ad-hoc tracing, but having a declaration in a global header, like the tracepoints are doing, _really_ helps for tracepoint maintainability.<br>
<p>
Having to dig into the C source to find buried trace_mark() instances is not a pretty picture.<br>
<p>
I think keeping the trace_mark() infrastructure is good as far as quick local tracing addition is concerned, but should not be added to mainline kernel code, given it is hard to maintain.<br>
<p>
And regarding the declaration complexity, it's added by the TRACE_EVENT() macros done by Steven. The original tracepoint flavor I did use DECLARE_TRACE, which is far simpler, e.g.<br>
<p>
DECLARE_TRACE(irq_entry,<br>
        TP_PROTO(unsigned int id, struct pt_regs *regs,<br>
                        struct irqaction *action),<br>
                TP_ARGS(id, regs, action));<br>
<p>
But it involves creating a probe module which contains the callback elsewhere. Adding tracer-specific callbacks in a different location is seen as too much of a burden by Ingo and Steven, hence their TRACE_EVENT() macro, which combines declaration and callback "definition".<br>
<p>
I am still unconvinced it's the best way to go though, as keeping the callbacks separated from the header declaration isolates the "tracer ABI" from the kernel instrumentation. But given we stipulate that the tracer ABI *will* evolve over time (given we give the userspace tools enough flexibility to cope with this), it can be argued that having an "all in one place" TRACE_EVENT() declaration/definition is more valuable than isolation of instrumentation for userspace-visible ABI. I guess usage will tell.<br>
<p>
Mathieu<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330686/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor330681"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2009 19:45 UTC (Tue)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/330681/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>
As an answer to Andrew Morton (which I should have probably posted on LKML rather than here), I would say that one of the primary strength of a system-side kernel tracer is to give Linux users the ability to answer to this simple question : "Why am I not getting the expected performance or latency when I run such application or use such device on my system ?"
<p>
The answer to this question is rather easy when parts of the system are _actively_ eating up CPU time (oprofile is very good at system-wide profiling), but becomes less clear when the issue is a "worse-case latency" or involves delays caused by process "waiting time". Having a trace of wakeup dependencies and the identity of each thread consuming CPU time along with scheduler decisions are incredibly valuable in getting an overall view of the system's behavior.
<p>
If this has not been expressed clearly enough in the many presentations many of us have done in the past years, then I guess we are simply unable to reach the right audience. A good case study of the static tracepoint value has been presented in this paper 2 years ago. It presents how static tracing has been used to debug problems at Google, IBM and Autodesk.
<p>
<a href="http://ltt.polymtl.ca/files/papers/bligh-Reprint.pdf">Linux Kernel Debugging on Google-sized clusters</a> at Ottawa Linux Symposium 2007
<p>
I have, in addition, personally been involved with and helped static tracer deployment at Google, IBM, Autodesk, Nokia, Ericsson, Siemens, Novell (SuSE Enterprise real-time), WindRiver, Montavista (Carrier Grade Linux distribution).
<p>
And if kernel developers still think that a kernel tracer is only valuable to kernel developers, then we have a big marketing job to do because they are just not getting the message : kernel tracing is _very_ valuable to Linux *users*.
<p>
P.S.: I did not reply on this topic on LKML because I think I have done my share of the explanation in the past 4 years, and I would just be repeating myself. *Linux users* have to speak up, not me.
      
          <div class="CommentReplyButton">
            <form action="/Articles/330681/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330726"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 2:22 UTC (Wed)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/330726/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
LKML is scary and forbidding.<br>
You're suggesting i wander into a contentious topic and start opinionating?<br>
<p>
<p>
I am a Linux user who does, among other things, systems performance tuning.  I do this ad hoc and also as a significant portion of my job.  Luckily I have the freedom to do portions of my work on Solaris, where dtrace is accessible.  Unfortunately the Solaris internals are generally less well documented or at least less familiar than Linux to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330726/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330731"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 5:22 UTC (Wed)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/330731/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Andrew Morton has said before that he would like to hear from more users and perhaps you should just do that with some good information on why and how these features are useful. The worst you will get is some flames from other people. Not a huge deal, really.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330731/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor330756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 9:46 UTC (Wed)
                               by <b>dunlapg</b> (guest, #57764)
                              [<a href="/Articles/330756/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"kernel tracing is _very_ valuable to Linux *users*."<br>
<p>
Isn't this exactly what the article says Andrew Morton is resistant to?  If it's ultimately exposed to the end-user, then it will have to have a set of stable user-space tools to gather the information, which means it will essentially be a part of the ABI that has to be maintained, or which people will complain of if broken.<br>
<p>
The Xen hypervisor has a binary-only static tracing facility that I use extensively for my development.  The particular traces change on a regular basis as the code evolves; trying to maintain the same interface for user-land tools would be basically impossible.  As it is, before each release I have to go through and make sure that all of the traces I need are still there and haven't been broken by someone else.  I think it's worth my time as a developer dealing with the instability.  But I wouldn't want that promise exposed to an end-user.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On the value of static tracepoints</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2009 13:08 UTC (Wed)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/330770/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think think Andrew has no problem with exposing this information to trace analysis tools, and that eventually trace analysis tool developers will have to adapt these tools to follow kernel revisions. We just have to make sure we add version identifiers in the exported data and make the tools flexible enough so we don't end up breaking at each kernel version. As an example, maintaining LTTV for about 7 years has not required any tremendous effort to follow new kernel releases, given we made it flexible enough.<br>
<p>
I think the main issue he raises here is that Ftrace looks like a gathering of single-purpose tracer which will be useful only to kernel developers (and probably only once, as he say). Maybe Andrew exaggerates a bit, but his main concern, which I think is plausible, is whether Ftrace approach is useful to the Linux end-users.<br>
<p>
Kernel developers can replace some of the static tracepoints discussed above by dynamic instrumentation because they usually won't face the low performance impact requirements as users doing system-wide tracing on heavily-loaded production systems face (yes, people do this with LTTng). So the addition of such tracepoints for either a special-purpose tracer or for a tracer which does not care so much about slowing the system down because it only collects a specific subset of data can clearly be arguable. I think the main answer to this is to bring a high-performance, system-wide user-available tracer in Linux, so those tracepoints have a in-tree user which uses them extensively. LTTng happens to have been providing this out-of-tree for a few years now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor330957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Macros</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2009 10:14 UTC (Thu)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/330957/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When are the kernel developers going to fork gcc (or build their own language compiler) that <br>
includes LISP-like macros over kernel code?  This is a classic case for them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor330981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Macros</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2009 13:30 UTC (Thu)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/330981/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds like you are reading in Ingo Molnar's mind :<br>
<p>
[rfc] built-in native compiler for Linux?<br>
<a href="http://lkml.org/lkml/2009/4/22/78">http://lkml.org/lkml/2009/4/22/78</a><br>
<p>
Mathieu<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/330981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
