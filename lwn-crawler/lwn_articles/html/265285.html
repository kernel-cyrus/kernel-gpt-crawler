        <!DOCTYPE html>
        <html lang="en">
        <head><title>ext3 metaclustering [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/265285/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/264521/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/265285/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>ext3 metaclustering</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 16, 2008</br>
           </div>
The ext3 system uses the classic Unix block pointer method for keeping
track of the blocks in each file.  For a given file, the on-disk inode
structure contains space for twelve block numbers; they point to the first
twelve blocks in the file - the first 48KB of space.  If the file is larger
than that, a 13th pointer contains the address of the first <i>indirect
block</i>; this block contains another 1024 (on a 4K block filesystem)
block pointers.  Should that not suffice, there's a 14th pointer for the
double-indirect block - each entry in that block is the address of an
indirect block.  And if even that is not enough, there's a 15th entry
pointing to a triple-indirect block full of pointers to double-indirect
blocks. 
<p>

This is a very efficient representation for small files - the kinds of
files Unix systems typically held, once upon a time.  In current times, when one can forget
about that directory full of DVD images and never even notice the lost
space, it does not work quite as well - there is a lot of overhead for all
of those individual block pointers, and a large data structure to manage.
That is why removing a large file on an ext3 filesystem can take a long
time - the system has to chase down all of those indirect blocks, which, in
turn, forces a lot of disk activity and head seeks.  For this reason,
contemporary filesystems tend to use extent-based mechanisms to associate
blocks with files, but that is not really an option for ext3.
<p>

An additional problem with all those indirect blocks is that filesystem
checkers must locate and verify them all.  That, again, causes a lot of
head seeking and makes fsck run slowly.  Slow filesystem checking was the
motivation behind <a href="http://lwn.net/Articles/264970/">this patch from
Abhishek Rai</a> which attempts to improve performance on filesystems with
a lot of indirect blocks.
<p>

The approach taken is relatively simple: the patch just tries to group 
indirect block allocations together on the disk.  The current ext3 code
will allocate indirect blocks when they are needed to account for data
blocks being added to the file; they are usually placed adjacent to those
data blocks.  One might think that this placement would speed subsequent
accesses to the file, but that is not necessarily so; the reading or
writing of the indirect block will tend to happen at a different time than
operations on the data blocks.  What this placement does accomplish,
though, is the distribution of the indirect blocks all over the disk.  So a
process which must examine all of the indirect blocks associated with a
file must cause the disk to do a lot of head seeks.
<p>

The "metaclustering" approach works by reserving a set of contiguous
blocks at the end of each block group.  Whenever an indirect block is
needed, the filesystem tries to get one from this dedicated area first.
The end result is that all of the indirect blocks are located next to each
other.  Should somebody need to read a number of those blocks without being
interested in the contents of the data blocks, they can grab them all
quickly with minimal seeking.  Filesystem checkers, as it happens, need to
do exactly that - as does the file removal process.  The patch did not come
with benchmarks, but the speedup that comes from the elimination of all
those seeks should be significant.
<p>
Even so, Andrew Morton <a href="/Articles/265286/">questioned the need</a>
for this patch, worrying that its benefits do not justify the risks that
comes with modifying an established, heavily-used filesystem:
<p>
<div class="BigQuote">
	In any decent environment, people will fsck their ext3 filesystems
	during planned downtime, and the benefit of reducing that downtime
	from 6 hours/machine to 2 hours/machine is probably fairly small,
	given that there is no service interruption.
</div>
<p>
Others disagreed, though, noting that it's the <i>unplanned</i> filesystem
checks which are often the most time-critical.  That includes the
delightful "maximal mount count" boot-time check which, in your editor's
experience, always happens when one is trying to get set up to give a talk
somewhere.  So this patch might just find eventual acceptance - it should
be relatively low-risk and does not require any on-disk format changes.
This is a filesystem patch, though, so nobody will be in any hurry to get
it into the mainline before a lot of testing and review has been done.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ext3">Filesystems/ext3</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/265285/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor265481"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 12:33 UTC (Thu)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/265481/">Link</a>] (38 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
The maximal mount count check is optional. It exists because Linux has traditionally run on
lots of cheap PCs people lashed together in basements, and because people like running release
candidates, random patches they found on the Internet and so-on. If you're pretty confident
that your hardware works and your filesystem driver works, these checks are surplus to
requirements.

Many operating systems don't perform such routine checks. Some don't even have the tools to
perform them if you wanted to. So using tune2fs to disable the periodic checks isn't
unreasonable.

And you have backups, yes ?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265481/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265504"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 13:42 UTC (Thu)
                               by <b>glm</b> (subscriber, #45719)
                              [<a href="/Articles/265504/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
There is another (less radical) workaround against an unwanted "maximal mount count" boot-time
check: simply interrupt the check with Ctrl+C. This will defer the check until the next
boot-time, hopefully on a less time critical occasion.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265504/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265521"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 15:20 UTC (Thu)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/265521/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
On all the distros I have tried, ctrl-c doesn't stop it.  Nothing stops it.  Not even if you
are in a situation where a 30 minute forced fsck is *really* embarrassing.  And it is "opt
out".  So one must remember to turn it off with tune2fs or expect it to kick in as a surprise
when one can least afford it.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265521/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265536"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 16:04 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/265536/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
That's because signals aren't delivered from the initial console by default, and the program
which fixes that (getty) doesn't run until a long time after fsck runs.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265536/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 17:39 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/265570/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
So, how does one stop it?

I suppose the right time to run the automatic fsck is when the volume is being unmounted at
shutdown.  I don't mind at all if the computer wants to chug along happily for 20 minutes and
then power itself off.  I sure as heck mind if it happens at startup and prevents me from
using the computer for 1/2 hour in the morning!

Any thoughts?  Should I file an Ubuntu feature request?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265608"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 20:29 UTC (Thu)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/265608/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Hmmm... does putting an "stty sane" early in the boot scripts make it work?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265608/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor266027"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2008 0:09 UTC (Tue)
                               by <b>fergal</b> (guest, #602)
                              [<a href="/Articles/266027/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
This was just recently discusses on ubuntu-devel-discuss, the thread should be in the
archives.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/266027/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265765"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 18:16 UTC (Fri)
                               by <b>ranmachan</b> (guest, #21283)
                              [<a href="/Articles/265765/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
On Debian, the filesystem check can be stopped with Ctrl+C, at least for filesystems other
than /. I'm not sure about /, since it _may_ be different and my / is usually small enough to
just wait for fsck to finish. /home can be quite annoyingly long though and gets the Ctrl+C
treatment sometimes.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265765/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265542"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 16:23 UTC (Thu)
                               by <b>Velmont</b> (guest, #46433)
                              [<a href="/Articles/265542/">Link</a>] (30 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><code>sudo tune2fs -c 0 /dev/sda1</code></blockquote>

<p>Ahh... Feels good. I'll never be embarrassed ever again.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/265542/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265567"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 17:26 UTC (Thu)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/265567/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Yes, you can now plan your important public presentation scheduled for July 15, 2008 with
confidence.

(Hint! Hint!)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265567/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor265568"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 17:30 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/265568/">Link</a>] (28 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
... except when a tiny inconsistency spreads and ends up corrupting half of your partition
(the half with the presentation on it of course).

Oh, if only you'd run periodic fscks!  The corruption would have been caught early and fixed
without you ever knowing about it.   :-P
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265568/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 18:05 UTC (Thu)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/265575/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I'd like to see some proof that this really happens in the real world.  That such spreading of
a tiny corruption to destroy one's whole file system is a real concern for real people.  Sure,
ext3 can, rarely, experience serious corruption.  But how do we know whether or not it started
out as a tiny problem?  Until it's proven, it's sounds like hearsay to me.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265643"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 22:43 UTC (Thu)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265643/">Link</a>] (25 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Disks deteriorate underneath the filesystem.  Usually it's age causing 
increasingly large bad spots.  The filesystem may have no bugs, but things 
can happen to the disk to corrupt the filesystem.  I'd rather know about 
that.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265643/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265647"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 23:15 UTC (Thu)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/265647/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Then have "badblocks" run independently of e2fsck at 3AM once a week or so?  Instead of
forcing the user and conference attendees to sit through a mandatory hour-long e2fsck at the
whim of the machine, hoping that the e2fsck happens to catch what badblocks is far better
designed to catch?

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265647/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265651"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 23:31 UTC (Thu)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265651/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Hour-long e2fsck?

1.  Partition your disk -- root, /var, /usr, /home on different filesystems.
2.  If you ever do enable the automatic checks, set the mounts-before-check count on 
each filesystem to be a different prime number.  That way multiple filesystems almost 
never get checked at the same time.

I've never had an fsck on a non-server system (which seems to be the topic here) go 
anywhere near an hour.  Maybe five minutes at most.

In my experience, badblocks is far far slower than e2fsck.

And running anything automatically at 3am generally isn't an option on 
conference-presentation laptops.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265651/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 14:56 UTC (Fri)
                               by <b>fatrat</b> (guest, #1518)
                              [<a href="/Articles/265729/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>

Not sure that partitions help here. If we are taking personal box/laptop /home is the only
thing I care about and it'll have all the disk space as well.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265731"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 15:06 UTC (Fri)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265731/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
OK, then you won't mind if I rm -rf /usr on your machine.  :-)

Try:  du -shc /var /usr /home
(There's also the root stuff not in those, but it's harder to measure that.)
You may be surprised at how much is in /var and /usr.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265731/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265733"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 15:19 UTC (Fri)
                               by <b>fatrat</b> (guest, #1518)
                              [<a href="/Articles/265733/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
My home dir contains ~82 Gb. Compared to that, /usr and /var don't contain a lot (under 10gb).
I'm sure most people are similar, hence my comment.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265733/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 15:45 UTC (Fri)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265735/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
10GB is still a big important chunk of disk, whether the rest is 20GB or 82GB.  Checking 
it separately *will* speed up each check, and separating it into a separate filesystem will 
make sure that errors on one part won't mess up the other part.

(Come to think of it, I suspect that the fsck speed is more dependent on number of files 
than data size, though I don't know for sure.)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor265860"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 22:22 UTC (Sat)
                               by <b>Frej</b> (guest, #4165)
                              [<a href="/Articles/265860/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Partitioning is fixing the symptoms, not the problem. 
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265860/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor267127"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Multiple fscks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2008 3:28 UTC (Wed)
                               by <b>Max.Hyre</b> (subscriber, #1054)
                              [<a href="/Articles/267127/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote><i>
[S]et the mounts-before-check count on 
each filesystem to be a different prime number.  That way multiple filesystems almost 
never get checked at the same time.
</i></blockquote>

Even better is setting the mounts/count to the same number on all filesystems, then use tunefs to set the starting count to a different value on each.

<p>Voila!  Never a multiple fsck.

      
          <div class="CommentReplyButton">
            <form action="/Articles/267127/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265648"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 23:19 UTC (Thu)
                               by <b>magila</b> (guest, #49627)
                              [<a href="/Articles/265648/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Disks these days are pretty good at hiding bad sectors from the host. If it gets bad enough
that the OS starts seeing bad data then the drive is probably on it's last legs and will soon
fail completely. In any case monitoring the SMART logs will usually catch a drive that is
gradually degrading without the frustrating fsck delays.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265648/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265652"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 23:33 UTC (Thu)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265652/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
True, but how many people monitor SMART logs on a laptop, or even a desktop?
More to the point, how many of the people disabling the auto-fsck monitor their SMART 
logs?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265652/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 22:00 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/265797/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
smartd can send you emails when things go suspiciously wrong.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265802"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 22:05 UTC (Fri)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265802/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
True.  How many people have system-level email working properly on their laptops, and 
are able to get such emails?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265802/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265804"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 22:14 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/265804/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Um, anyone competent? All sorts of other email, some security-important, 
gets sent by various daemons and shouldn't just be binned or ignored... of 
course a lot of people aren't competent :/
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265804/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265805"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 22:20 UTC (Fri)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/265805/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
My programmer coworkers have enough trouble with the task, and they're techies.  
Forget about the non-techie user that is adopting Linux more and more.

Everyone sets up their GUI mail program, and totally ignores the system-level MTA 
(sendmail/postfix/exim).  They just never get those emails.

(Sysadmin types being the exception, of course, but they're few and far between these 
days.)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265805/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 18:35 UTC (Sat)
                               by <b>raxyx</b> (guest, #50026)
                              [<a href="/Articles/265854/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
So THAT's that these MTAs are for. Cool. 


<font class="QuotedText">&gt; Everyone sets up their GUI mail program, and totally ignores the system-level MTA </font>
<font class="QuotedText">&gt; (sendmail/postfix/exim).  They just never get those emails.</font>

Full ack on that. On some of my Debian machines, during the boot sequence, the thing that
takes the most time to get loaded is exim4, so one day I got fed up with it and removed it,
didn't notice any difference afterwards. I guess I'm going to rethink that move :-)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor265858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">lightweight MTAs for outgoing mail only</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 20:08 UTC (Sat)
                               by <b>liamh</b> (guest, #4872)
                              [<a href="/Articles/265858/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I have taken to removing exim4 and installing either ssmtp or nullmailer
 aptitude install ssmtp exim4- exim4-base- exim4-config- exim4-daemon-light-
Just enough MTA to get the word out.  Since few people want/need a full MTA, this seems like
it should be the default.  But I don't smart disk monitoring; a few years back I tried it and
it led to some unreliable system behavior.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265828"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 1:56 UTC (Sat)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/265828/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Well, Debian configures smartd to both mail root and display a notification on the desktops of
currently-logged-in users. :)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265828/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor265656"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 23:56 UTC (Thu)
                               by <b>dberkholz</b> (guest, #23346)
                              [<a href="/Articles/265656/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Google published a paper fairly recently on a large study of disk failures. As I recall, they
found that SMART logs were not reliable indicators.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265656/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265679"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 4:12 UTC (Fri)
                               by <b>magila</b> (guest, #49627)
                              [<a href="/Articles/265679/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Notice I said gradually degrading. SMART won't help in the event of a catastrophic mechanical
failure, which is what most of the unanticipated failures in the Google study probably were.
Fsck doesn't help in that case either though. It's only the kinds of failures that cause a
slow accumulation of bad sectors that fsck would matter for, and those are the kinds of
failures that SMART is piratically guaranteed to catch.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265679/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265696"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 8:51 UTC (Fri)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/265696/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
piratically... guaranteed...?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265696/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 22:03 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/265801/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
That's SMArrrT for you.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor266694"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using fsck to defend against disk failures?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2008 15:45 UTC (Sun)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/266694/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      That and the "spreading inconsistency" theory and some other things I
have read by people writing about fsck are failure types that I have
never seen or read a first-hand report of, so I guess they are just
myths or a perverted form of wishful thinking.

<p>The kinds of disk failures I have seen have always been different.
In particular, even if a drive developed a bad block, it recognized
that itself (very slowly) and returned an error rather than wrong
data.  I'm not sure if fsck programs are up to dealing with a bad
block of this kind in the metadata, but if a drive has a bad block,
that's certainly a good time to replace the drive and restore the data
from backup.  Or you run RAID 1 or RAID 5, you
just need to replace the drive (and make it known to the RAID driver).

<p>Moreover, even if a disk drive deteriorates over time, that's more
likely to hit the data first rather than the meta-data.  But fsck
checks only some kinds of errors in the meta-data, so if fsck is your
defense against bad blocks, you don't value your data at all.  Making
a backup is more likely to unveil bad blocks than fsck (also in data),
and has obvious additional benefits.

<p>Finally, a good way (much better than fsck) to test the drive for
bad blocks is "smartctl -t long", even though I am sceptical about the
predictive capabilities of SMART.

<p>Overall, I am very sceptical about the value of fsck for dealing
with hardware failures, and a little bit less sceptical about its
value when dealing with software failures (but I think I have not been
bitten by a file system bug yet); in many cases (especially the
hardware ones) we have to restore from backup anyway.

      
          <div class="CommentReplyButton">
            <form action="/Articles/266694/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor266697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using fsck to defend against disk failures?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2008 16:32 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/266697/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
My mum's ancient 486 laptop had a really strange disk failure this 
Christmas. It started with a single bad sector, but then within about 
fifteen minutes one third of the sectors on the disk (in contiguous runs 
of varying length) were returning, not bad sectors, but `sector not 
found', i.e. the drive couldn't even find the sector address markers.

What I suspect may have happened, based on my extensive lack of experience 
in hard drive design, is that all the G forces the head assembly is 
exposed to whenever a seek happens had over time twisted the head reading 
the farthest side of whichever platter didn't contain the servo track out 
of true, so that when the servo track said it was over track X, the 
topmost heads were actually midway between tracks or something like that. 
In that position they couldn't read the sector addresses, couldn't find 
any data, and whoompfh, goodbye data.

(I've never heard of this failure mode anywhere else, and perhaps it was 
something different, but still, it was very strange. Disks *can* go mostly 
bad all at once. It's just rare.)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/266697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor266709"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Disk failures</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2008 21:58 UTC (Sun)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/266709/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Disk drives have not used servo tracks for a long time, because one
could no longer align all the heads precisely enough (e.g., because of
thermal expansion).  Instead, servo information exists on each
platter, interspersed in some way with the data.  I don't know when
this change happened; a 15+-year old disk (486 generation) might still
have a servo track.  But couldn't the symptoms also be explained by
the failure of just one of the heads?

      
          <div class="CommentReplyButton">
            <form action="/Articles/266709/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor266711"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Disk failures</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2008 22:55 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/266711/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I said it was a prehistoric system, and indeed anything more modern than 
about, what, 1991 won't have this problem.

I'm not sure if a head failure could cause a failure to find sector 
address markers: I'm not sure if you could even distinguish the two cases 
without digging into the drive. (As I said, my expertise in hard drive 
engineering is notable mainly by its absence.)

It's just that heads are solid-state, and solid-state stuff doesn't die 
all that often, while the head assembly itself is being wrenched all over 
the place: simple bending could explain this, I think.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/266711/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor265661"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext3 metaclustering</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 0:24 UTC (Fri)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/265661/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
These days, it doesn't make much sense to use -c periodic checking, since disk data errors are
unlikely to be associated with mounting. It makes a lot more sense to use -i periodic
checking, which you can schedule for some time when you're not giving a presentation.

Actually, it would make most sense to do it at shutdown sometime the system is plugged in and
you're going to bed, controlled with cron/anacron for noticing the need to check it and
shutdown scripts to identify that it's appropriate. Obviously, there's practically no chance
that the periodic check would actually happen to trigger on the first mount after disk
corruption occurs, and it's more likely that corruption would happen during a write (and thus,
while it's mounted) anyway.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265661/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2008, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
