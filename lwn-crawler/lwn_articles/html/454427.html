        <!DOCTYPE html>
        <html lang="en">
        <head><title>TCP connection hijacking and parasites - as a good thing [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/454427/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/454308/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/454427/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>TCP connection hijacking and parasites - as a good thing</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 9, 2011</br>
           </div>
The 3.1 kernel will include a number of enhancements to the
<tt>ptrace()</tt> system call by Tejun Heo.  These improvements are meant
to make reliable debugging of programs easier, but Tejun, it seems, is not
one to be satisfied with mundane objectives like that.  So he has <a
href="/Articles/454304/">posted an example program</a> showing how the new
features can be used to solve a difficult problem faced by
checkpoint/restart implementations: capturing and restoring the state of
network connections.  The code is in an early stage of development; it's
audacious and scary, but it may show how interesting things can be done.
<p>
The traditional <tt>ptrace()</tt> API calls for a tracing program to attach
to a target process with the <tt>PTRACE_ATTACH</tt> command; that command
puts the target into a traced state and stops it in its tracks.
<tt>PTRACE_ATTACH</tt> has never been perfect; it changes the target's
signal handling and can never be entirely transparent to the target.  So
Tejun supplemented it with a new <tt>PTRACE_SEIZE</tt> command;
<tt>PTRACE_SEIZE</tt> attaches to the target but does not stop it or change
its signal handling in any way.  Stopping a seized process is done with
<tt>PTRACE_INTERRUPT</tt> which, again, does not send any signals or make
any signal handling changes.  The result is a mechanism which enables the
manipulation of processes in a more transparent, less disruptive way.
<p>
All of this seems useful, but it does not necessarily seem like part of a
checkpoint/restart implementation.  But it can help in an important way.
One of the problems associated with saving the state of a process is that
not all of that state is visible from user space.  Getting around this
limitation has tended to involve doing checkpointing from within the kernel
or the addition of new interfaces to expose the required information;
neither approach is seen as ideal.  But, in many cases, the required
information can be had by running in the context of the targeted process;
that is where an approach based on <tt>ptrace()</tt> can have a role to
play.
<p>
Tejun took on the task of saving and restoring the state of an open TCP
connection for his example implementation.  The process starts by using
<tt>ptrace()</tt> to seize and stop the target thread(s); then it's just a
matter of running some code in that process's context to get the requisite
information.  To do so, Tejun's example program digs around in the target's
address space for a nice bit of memory which has execute permission; the
contents of that memory are saved and replaced by his "parasite" code.  A
bit of register manipulation allows the target process to be restarted in
the injected code, which does the needed information gathering.  Once
that's done, the original code and registers are restored, and the target
process is as it was before all this happened.
<p>
The "parasite" code starts by gathering the basic information about open
connections: IP addresses, ports, etc.  The state of the receive side of
each connection is saved by (1)&nbsp;copying any buffered incoming data
using the <tt>MSG_PEEK</tt> option to <tt>recvmsg()</tt>, and
(2)&nbsp;getting the sequence number to be read next with a new
<tt>SIOCGINSEQ</tt> <tt>ioctl()</tt> command.  On the transmit side, the
sequence number of each queued outgoing packet - along with the packet data
itself must be captured with another pair of new <tt>ioctl()</tt>
commands.  With that done, the checkpointing of the network connection is
complete.
<p>

Restarting the connection - possibly in a different process on a different
machine entirely - is a bit tricky; the kernel's idea of the connection
must be made to match the situation at checkpoint time without perturbing
or confusing the other side.  That requires the restart code to pretend to
be the other side of the connection for as long as it takes to get things
in sync.  The kernel already provides most of the machinery needed for this
task: outgoing packets can be intercepted with the "nf_queue" mechanism,
and a raw socket can be used to inject new packets that appear to be coming
from the remote side.
<p>
So, at restart time, things start by simply opening a new socket to the
remote end.  Another new <tt>ioctl()</tt> command (<tt>SIOCSOUTSEQ</tt>) is
used to set the sequence number before connecting to make it match the
number found at checkpoint time.  Once the connection process starts, the
outgoing SYN packet will be intercepted - the remote side will certainly
not be prepared to deal with it - and a SYN/ACK reply will be injected
locally.  The outgoing ACK must also be intercepted and dropped on the
floor, of course.  Once that is done, the kernel thinks it has an open
connection, with sequence numbers matching the pre-checkpoint connection,
to the remote side.
<p>
After that, it's a matter of restoring the incoming data that had been
found queued in the kernel at checkpoint time; that is done by injecting
new packets containing that data and intercepting the resulting ACKs from
the network stack.  Outgoing data, instead, can be replaced with a series
of simple <tt>send()</tt> calls, but there is one little twist.  Packets in
the outgoing queue may have already been transmitted and received by the
remote side.  Retransmitting those packets is not a problem, as long as the
size of those packets remains the same.  If, instead, the system uses different
offsets as it divides the outgoing data into packets, it can create
confusion at the remote end.  To keep that from happening, Tejun added one
more <tt>ioctl()</tt> (<tt>SIOCFORCEOUTBD</tt>) to force the packets to
match those created before the checkpoint operation began.
<p>
Once the transmit queue is restored, the connection is back to its original
state.  At this point, the interception of outgoing packets can stop.
<p>
All of this seems somewhat complex and fragile, but Tejun states that it
"<q>actually works rather reliably</q>".  That said, there are a lot
of details that have been ignored; it is, after all, a proof-of-concept
implementation.  It's not meant to be a complete solution to the problem of
checkpointing and 
restarting network connections; the idea is to show that the problem can,
indeed, be solved.  If the <a href="/Articles/452184/">user-space
checkpoint/restart work</a> proceeds, it may well adopt some variant of
this approach at some point.  In the meantime, though, what we have is a
fun hack showing what can be done with the new <tt>ptrace()</tt> commands.
Those wanting more details on how it works can find them in <a
href="https://code.google.com/p/ptrace-parasite/source/browse/README">the
README file</a> found in the example code repository.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Checkpointing">Checkpointing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking">Networking</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#ptrace">ptrace()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/454427/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor454664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2011 13:35 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/454664/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is it just me, or is this whole "patch a stopped process and then muck with TCP forging a SYN/ACK sequence" procedure looks kinda Rube Goldbergesque?<br>
<p>
What are you going to do with SIP connections? Or with SCTP connections?<br>
<p>
This code should properly be in the kernel, possibly integrated with conntrack module of iptables (which seems to be the ideal place for it).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2011 17:16 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/454701/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's a good prototype.  Glue random parts together and see if it flies.  If it does, THEN you do the engineering to turn it into a product.  If not, no big deal.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2011 21:29 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/454725/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm very interested in checkpointing to the extent that I've implemented userspace TCP/IP stack using <a href="http://sourceforge.net/projects/cipsuite/">http://sourceforge.net/projects/cipsuite/</a> with support for rapid resuming.<br>
<p>
However, the proposed solution is what I'd call an example of how NOT to do checkpointing. I've read its code and I'd say that it conclusively proves that there should be kernel-level support for it.<br>
<p>
Actually, it should not even be that hard! We already have /proc/pid/fd directory with the list of open handles. So we just need to add, say, /proc/pid/fd-pickle directory with the list of files, containing handles' information. So TCP connections would store their endpoints, sequence numbers, the sets of TCP flags, and probably IPSec state in these files.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454730"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2011 22:27 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/454730/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
cipsuite looks impressive!  Wish I'd had it back in my embedded days.<br>
<p>
Agreed, the article's technique not the best way of doing it.  /proc/pid/fd-pickle seems like it would be somewhat high maint and prone to racing... Is it possible to extract the fd info and other kernel state after the process is frozen?<br>
<p>
(asking as someone who has never actually checkpointed a process...)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454730/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2011 22:52 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/454735/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It shouldn't be hard, actually I'm thinking of implementing it myself.<br>
<p>
Race conditions would be a problem, but:<br>
1) Checkpoint/restart is inherently racy. Network packets might got lost, connections can time out during migration, etc.<br>
2) It can be mitigated somewhat by providing kernel-level support for freezing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor454812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2011 19:58 UTC (Fri)
                               by <b>gswoods</b> (subscriber, #37)
                              [<a href="/Articles/454812/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The question I have about this is, doesn't the other end of the connection also keep state? Won't it drop the connection after some period of time?<br>
<p>
Checkpointing is, presumably, something that is going to be done when it is expected that the checkpointed process(es) will be suspended for a relatively long period of time. What happens when those packets are reinjected after the remote side has already torn down the connection?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2011 21:13 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/454817/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
actually, one of the most valuable use cases for checkpoint/restart is where you only expect to be down for a few seconds because you want to migrate a process from one system to another one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454830"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2011 23:08 UTC (Fri)
                               by <b>martinfick</b> (subscriber, #4455)
                              [<a href="/Articles/454830/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am not sure it's the most valuable, but most likely the only really usable one give the types of issues you bring up.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454830/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor454843"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 0:46 UTC (Sat)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/454843/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder if checkpoint/restart would at some point in the future be useful to do regular checkpoints to a shared filesystem.<br>
<p>
So when a machine crashes it can (automatically) be started on an other machine.<br>
<p>
It might not be useful for all workloads, but maybe some ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454843/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454846"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 1:41 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/454846/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the problem is that if the system crashes, you don't have a checkpoint at the time of the crash. at best you have a checkpoint that's fairly recent but is prior to the crash.<br>
<p>
If you take that older checkpoint and start it on another machine, you have time-warped the application, and there may be other components that you are talking to that haven't done a similar time warp.<br>
<p>
a perfect example of this:<br>
<p>
I was evaluating a commercial product that goes out and changes the root password on your system on a frequent basis. If you need the root password you make a request to this system. When I asked the vendor how they did High Availability and Disaster Recovery for the system (i.e. what happens if the hardware it's running on bursts into flames), their answer was that they used vmware and vmware would auto-migrate the service to another server.<br>
<p>
When I pointed out that vmware could not be 100% up to date and the old instance may have changed passwords on systems and the new instance won't know about it, their answer turned into "just trust us"<br>
<p>
not all apps are subject to problems like this from time warps, but the more it communicates with the outside world, the more likely it is to have a problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454846/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 4:49 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/454855/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The vendor here is probably more right than you give credit for. Either you have a case where the vm live migrates to another machine and there is no lost data or time warp or the hardware crashes and the only important thing is what is committed to disk, which does not introduce any new or special problem. The vm would be booted an another piece of hardware, no time warp only crash recovery, journal replay, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454856"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 5:00 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/454856/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
no, if the password gets changed on a remote machine and the time warp happens, the password is now known by no system.<br>
<p>
even if they were smart enough to not change the remote password until they stored it (and then what happens if they can't change the password? they did _not_ keep a record of old passwords), I've seen too many cases where a dieing system scribbles on the disk to be comfortable with the idea of betting that such a thing does not happen for access to my servers.<br>
<p>
the company abandoned the product (shut it down, didn't even sell it off) about 9 months later, so I don't think I was the only person asking such hard questions of them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454856/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 22:37 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/454906/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you misunderstood my point, I wasnt clear enough. I do not disagree that in a system such as that that data loss from a rolled back transaction record of a password change during crash recovery would be very problematic I only disagree that the introduction of a vm environment meaningfully changes that risk one way or another. <br>
<p>
I am surprised that they couldn't give you a better answer though, I can think of three or four ways to mitigate that risk off the top of my head. Maybe their sales force was undertrained or their engineers were chuckleheads. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 22:46 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/454907/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One other thing.. Unless you are taking snapshots of a running vm and reverting back to them I do not think you can have the "time warp" you describe.   Failing to commit changes to permanent storage is a different issue. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor454909"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 22:55 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/454909/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the thing is, that's exactly what vmware does when it migrates machines, it takes snapshots of the VM periodically, and then if a system dies, boots the latest snapshot on another system.<br>
<p>
this works quite well if you aren't sensitive to time warps, and everything is in one geographic location so that you can have the snapshots stored on shared disks.<br>
<p>
if you are sensitive to time warps, and you need to allow for your recovery to be in a different geographic location (so that there is a significant lag in the storage changes getting replicated to the new datacenter) then the approach of just saying "vmware solves our HA/DR issues, we don't need to care about them at an application design level" is a very bad approach to take.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454909/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455100"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2011 20:50 UTC (Mon)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/455100/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you are confused and talking about two different things.  If a system dies, then the VMs which were running on it crash and are booted on other systems in the cluster, there are no snapshots or time warps involved.  This has nothing to do which live migration of machines which does not in any way make machines more highly available except that one manually live migrate off of one host in a cluster to do maintenance on it.  Live migration does not cause time warps, at best the system is unavailable on the network for a few moments while the switches relearn what port its MAC address is coming from.<br>
<p>
Of course, saying that VM solves our HA/DR problems like so much secret sauce is BS without making the application resilient to the same kind of problems that can happen to bare metal such as unexpected crashes and some way to handle DR which is very different than HA.<br>
<p>
Actually VMware does have a feature now called Fault Tolerance where a VM is run in lockstep on two different nodes in a cluster.  They are kept running the same instruction for instruction AFAIK so there would be no time warp during a failover event, there are some product demos on youtube showing them playing a video file over a remote desktop and it not skipping a frame while failing over.  That could work as an HA solution but would do nothing for DR.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455100/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455120"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2011 0:08 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/455120/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I fully agree that for live migration when nothing is wrong, virtual machines (and containers with checkpoint/restore) can be very nice.<br>
<p>
In this case the vendor was claiming that this also solved crash problems because vmware would just restart the application on the other server exactly where it left off when the first server crashed.<br>
<p>
I doubt that the vmware Fault Tolerance would work for any system that used random numbers as I don't see how they could find all the places that generated or used the random numbers and make both machines have the exact same results.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455120/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455228"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2011 20:36 UTC (Tue)
                               by <b>robbe</b> (guest, #16131)
                              [<a href="/Articles/455228/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In this case the vendor was claiming that this also solved crash problems because vmware would just restart the application on the other server exactly where it left off when the first server crashed.</font><br>
<p>
VMware's HA feature just restarts the VM affected by a server crash on another ESX server. From the perspective of the VM it looks like a spontaneous reboot. This guarantees minimum downtime, but does not make the crash invisible to the application.<br>
 <br>
<font class="QuotedText">&gt; I doubt that the vmware Fault Tolerance would work for any system that used random numbers [...]</font><br>
<p>
Remember that all the HW excepting the CPU is emulated. Fault Tolerance works by replicating the external events (e.g. an incoming network packet) seen by the original VM at the same point in time on the backup VM. Usual sources of entropy will be equal to both machines.<br>
<p>
Maybe someone could deliberately construct a program that runs differently in the original and the backup VM. The only thing I can think of right now is measuring time via a covert channel (the normal means like RDTSC are covered, of course) -- but this is too vague still to make into an "exploit".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455228/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2011 20:52 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/455233/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
given that the entropy sources include nanosecond timeing, and if the CPU supports it, thermal noise on the CPU, I _really_ doubt that the resulting random numbers would be the same on the two systems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2011 22:12 UTC (Tue)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/455242/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you underestimate the state of the art.  Considering how often modern systems use random numbers I can't imagine this case not being handled, by disabling any hardware mechanism that could introduce non-determinism at the very least.  <br>
<p>
Looking at the VMware FT docs the hypervisor for the primary VM very thoroughly records anything that could change state and does not pass it through to the primary until it is transmitted and receipt acknowledged by the hypervisor for the secondary VM.  Features such as SMP or hardware MMU are disabled as their state can't be recorded and could introduce non-determinism.  Each event is injected into the secondary at the same execution point.  That certainly has to work with nanosecond timing, from the point view from inside the secondary VM.  According to wall clock time the secondary will always be lagging behind, the demos show lag in the millisecond range, but because events are recorded it can be brought up to current during a failover event, so no state should be lost.<br>
<p>
If you are interested you may want to do a little research on the topic, on your own.  When I get this set up in my test environment I'll definitely run though creating ssh keys and whatnot to validate my understanding that this does work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455275"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 17, 2011 9:25 UTC (Wed)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/455275/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does that mean you would expect it to work, even if I use something like  <a href="http://www.issihosts.com/haveged/">http://www.issihosts.com/haveged/</a> as one of the sources of random ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455275/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455281"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 17, 2011 13:24 UTC (Wed)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/455281/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's what I would expect.  I'd love to get my test environment straightened out and then I could determine one way or another.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455281/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor454908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 22:48 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/454908/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the 'correct' answer (and what competing products do) is to have multiple servers, and have the data replicated to all the servers.<br>
<p>
it's fairly common (although complex) at the application level to implement updates of small amounts of information across a geographically distributed cluster of machines (lookup two phase commit). but if you rely on the entire VM state being synced, there is just too much unnecessary data involved to keep things synced in real time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455105"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2011 21:00 UTC (Mon)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/455105/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One thing I thought of when mentally designing a system as you described is that you would both need to have complete history but also a large window of near-future passwords.  If you restore a host from last year, you need to be able to log into it and if you restore last week's backup of your password management system it needs to know what the current passwords would be otherwise you have no DR, just HA. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455105/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455121"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2011 0:09 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/455121/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yes, you do need to have a record of the historic passwords as well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455121/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor454876"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 10:11 UTC (Sat)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/454876/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So I guess the workload where it is easiest to work with is: long running calculations that have mostly read-only data on the network.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454876/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor454902"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2011 20:04 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/454902/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Additionally, it's not unusual to checkpoint the state of both endpoints simultaneously. <br>
<p>
We're doing exactly that. It's kinda awe-inspiring to see the whole cluster with all the interconnections to 'time-warp' into a previous state.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/454902/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor455473"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 18, 2011 10:30 UTC (Thu)
                               by <b>etienne</b> (guest, #25256)
                              [<a href="/Articles/455473/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I do not understand how you can hide the originating IP address of the process you are restarting.<br>
Can you only checkpoint/restart on a machine with the same IP address (so the machine you are restarting cannot be present on the network at the checkpoint time because it would be duplicate IP)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455473/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor455588"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 18, 2011 18:19 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/455588/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
you create a separate IP address for the service group that you want to migrate, then you move that IP address along with the services.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455588/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor455663"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2011 2:04 UTC (Fri)
                               by <b>kevinm</b> (guest, #69913)
                              [<a href="/Articles/455663/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <pre>(1) copying any buffered incoming data using the MSG_PEEK option to
recvmsg(), and (2) getting the sequence number to be read next with a new
SIOCGINSEQ ioctl() command.</pre>
<p>This seems fundamentally racy.  What happens if a new segment arrives in the kernel in between (1) and (2)? Instead of a new ioctl(), it should be a new `MSG_PEEK_SEQ` flag to recvmsg() that supplies a control message containing the sequence number, with the iovec pointing to the peeked data.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/455663/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor455757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2011 17:24 UTC (Fri)
                               by <b>swebb</b> (guest, #78608)
                              [<a href="/Articles/455757/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Tejun's example program digs around in the target's address space for a nice bit of memory which has execute permission; the contents of that memory are saved and replaced by his "parasite" code.</font><br>
<p>
I covered this technique and its limitations in my Defcon 19 presentation. I created a project called libhijack that allows injection of arbitrary code into new memory mappings. I have a feeling libhijack will get much more powerful with PTRACE_SEIZE.<br>
<p>
I'm curious why Linux developers don't implement a DTrace clone. PTrace should die a horrible death.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor456063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2011 12:15 UTC (Tue)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/456063/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why would libhijack become more powerful with PTRACE_SEIZE?<br>
As far as I can tell, it only makes ptracing more transparent,<br>
not more powerful.<br>
<p>
This example doesn't do anything that couldn't have been done<br>
with normal ptrace, as far as I can tell.<br>
<p>
And the whole approach is total madness. Why not just steal the<br>
connection by passing the socket fd to the new target and closing<br>
it in the original task? For that you only need to inject a couple<br>
of system calls, with less disruptive data injections. No need to<br>
muck around in TCP states, netfilter and all that other madness.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/456063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor456077"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2011 15:00 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/456077/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
you can only pass the socket FD to a process on the same system.<br>
<p>
this approach can move the TCP connection to a different system.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/456077/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor456140"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2011 21:39 UTC (Tue)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/456140/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think that the current code only handles local processes too, <br>
at least that was my impression after reading the code, especially <br>
main.c. You're right that this approach could make remote moves<br>
possible.<br>
<p>
But damn, it's ugly. I'd say, add an explicit connection moving<br>
API instead of this mess.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/456140/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor455838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP connection hijacking and parasites - as a good thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2011 7:36 UTC (Sat)
                               by <b>slashdot</b> (guest, #22014)
                              [<a href="/Articles/455838/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Restoring the socket state by injecting packets is quite brilliant, as it guarantees to avoid the risk of being able to use the resume feature to get the TCP stack in a state which is otherwise impossible (and which can cause a kernel crash or exploit).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/455838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2011, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
