        <!DOCTYPE html>
        <html lang="en">
        <head><title>Namespaces in operation, part 7: Network namespaces [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/580893/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/580732/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/580893/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Namespaces in operation, part 7: Network namespaces</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>January 22, 2014</br>
           <hr>
<a href="/Articles/531114/#series_index">Namespaces in operation</a>
</div>
<p>
It's been a while since last we looked at Linux namespaces.  Our
series has been missing a piece that we are finally filling
in: network namespaces.  As the name would imply, network namespaces
partition the use of the network—devices, addresses, ports, routes,
firewall rules, 
etc.—into 
separate boxes, essentially virtualizing the network within a single
running kernel instance.  Network namespaces entered the kernel in 2.6.24,
almost exactly five years ago; it took something approaching a year before
they were ready for prime time.  Since then, they seem to have been largely
ignored by many developers.
</p>

<p>
<h4>Basic network namespace management</h4>
<p>
As with the others, network namespaces are created by passing a flag to the
<tt>clone()</tt> system call: <tt>CLONE_NEWNET</tt>.  From the command
line, though, it is convenient to use the <tt>ip</tt> networking
configuration tool to set up and work with network namespaces.  For
example:
<pre>
    # ip netns add netns1
</pre>
<p>
This command creates a new network namespace called <tt>netns1</tt>.
When the <tt>ip</tt> tool creates a network namespace, it will create a
bind mount for it under <tt>/var/run/netns</tt>; that allows the namespace
to persist even when no processes are running within it and facilitates the
manipulation of the namespace itself.  Since network namespaces typically
require a fair amount of configuration before they are ready for use, this
feature will be appreciated by system administrators.
<p>
The "<tt>ip netns exec</tt>" command can be used to run network
management commands within the namespace:
<p>
<pre>
    # ip netns exec netns1 ip link list
    1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT 
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</pre>
<p>
This command lists the interfaces visible inside the namespace.  A
network namespace can be removed with:
<p>
<pre>
    # ip netns delete netns1
</pre>
<p>
This command removes the bind mount referring to the given network
namespace.  The namespace itself, however, will persist for as long as any
processes are running within it.
</p>

<p>
<h4>Network namespace configuration</h4>
<p>
New network namespaces will have a loopback device but no other network
devices.  Aside from the loopback device, each network device (physical or
virtual interfaces, bridges, etc.) can only be present
in a single 
network namespace. In addition, physical devices (those connected to real
hardware) 
cannot be assigned to namespaces other than the root.  Instead, virtual
network devices (e.g. virtual ethernet or veth) can be created and assigned
to a namespace.  These virtual devices allow processes inside the namespace
to communicate over the network; it is the configuration, routing, and so on
that determine who they can communicate with.
</p>

<p>
When first created, the <tt>lo</tt> loopback device in the new namespace is
down, so even a loopback <tt>ping</tt> will fail:
<pre>
    # ip netns exec netns1 ping 127.0.0.1
    connect: Network is unreachable
</pre>
Bringing that interface up will allow pinging the loopback address:
<pre>
    # ip netns exec netns1 ip link set dev lo up
    # ip netns exec netns1 ping 127.0.0.1
    PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
    64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.051 ms
    ...
</pre>
But that still doesn't allow communication between netns1 and the root
namespace.  To do that, virtual ethernet devices need to be created and
configured: 
<pre>
    # ip link add veth0 type veth peer name veth1
    # ip link set veth1 netns netns1
</pre>
The first command sets up a pair of virtual ethernet devices that are
connected.  Packets sent to <tt>veth0</tt> will be received by
<tt>veth1</tt> and vice versa.  The second command assigns <tt>veth1</tt>
to the netns1 namespace.
<pre>
    # ip netns exec netns1 ifconfig veth1 10.1.1.1/24 up
    # ifconfig veth0 10.1.1.2/24 up
</pre>
Then, these two commands set IP addresses for
the two devices.    
<pre>
    # ping 10.1.1.1
    PING 10.1.1.1 (10.1.1.1) 56(84) bytes of data.
    64 bytes from 10.1.1.1: icmp_seq=1 ttl=64 time=0.087 ms
    ...
    
    # ip netns exec netns1 ping 10.1.1.2
    PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.
    64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.054 ms
    ...
</pre>
Communication in both directions is now possible as the <tt>ping</tt>
    commands above show.  
</p>

<p>
As mentioned, though, namespaces do not share routing tables or firewall
rules, as running <tt>route</tt> and <tt>iptables&nbsp;-L</tt> in netns1 will
attest. 
<pre>
    # ip netns exec netns1 route
    # ip netns exec netns1 iptables -L
</pre>
The first will simply show a route for packets to the 10.1.1 subnet (using
<tt>veth1</tt>), while the second shows no iptables configured.
All of that means that packets sent from netns1 to the internet at large
will get the 
dreaded "Network is unreachable" message.  There are several ways to
connect the namespace to the internet if that is desired.  A <a
href="http://www.linuxfoundation.org/collaborate/workgroups/networking/bridge">bridge</a>
can be created in the root namespace and the veth device from netns1.
Alternatively, IP forwarding coupled with <a
href="http://en.wikipedia.org/wiki/Network_address_translation">network
address translation</a> (NAT) could be configured in the root namespace.
Either of those (and there are other configuration possibilities) will
allow packets from netns1 to reach the internet and for replies to be
received in netns1.
</p>

<p>
Non-root processes that are assigned to a namespace (via <tt>clone()</tt>,
<tt>unshare()</tt>, or <tt>setns()</tt>) only have access to the networking
devices and configuration that have been set up in that namespace—root can
add new devices and configure them, of course.  
Using the <tt>ip&nbsp;netns</tt> sub-command, there are two ways to address
a network namespace: by its name, like netns1, or by the process ID of a
process in that namespace.  Since <tt>init</tt> generally lives in the root
namespace, one could use a command like:
<pre>
    # ip link set vethX netns 1
</pre>
That would put a (presumably newly created) veth device into the root
namespace and it would work for a root user from any other namespace.  In
situations where it is not desirable to allow root to perform such
operations from within a network namespace, the PID and mount namespace
features can be used to make the other network namespaces unreachable.

<p>
<h4>Uses for network namespaces</h4>
<p>
As we
have seen, a namespace's networking can range from none at all (or just
loopback) to 
full access to the system's networking capabilities. That leads to a number
of different use cases for network namespaces. 
</p>

<p>
By essentially turning off the network inside a namespace, administrators
can ensure that processes
running there will be unable to make connections outside of the namespace.
Even if a process is compromised through some kind of security
vulnerability, it will be unable to perform actions like joining a
botnet or sending spam.  

<p>
Even processes that handle network traffic (a web
server worker process or web browser rendering process for example) can be
placed into a restricted namespace.  
Once a connection is established by or to the remote endpoint, the file
descriptor for that connection could be handled by a child process that is
placed in a new network namespace created by a <tt>clone()</tt> call.  The
child would inherit its parent's file descriptors, thus have access to the
connected descriptor.  Another possibility would be for the parent to send
the connected file descriptor to a process in a restricted network
namespace via a Unix socket.  In either case, the lack of suitable network
devices in the namespace would make it impossible for the child or worker
process to make additional network connections.
</p>

<p>
Namespaces could also be used to test complicated or intricate networking
configurations all on a single box.  Running sensitive services in more
locked-down, firewall-restricted namespace is another.  Obviously,
container implementations also use network namespaces to give each
container its own view of the network, untrammeled by processes outside of
the container.  And so on.
</p>

<p>
Namespaces in general provide a way to partition system resources and to
isolate groups of processes from each other's resources.  Network
namespaces are more of the same, but since networking is a
sensitive area for security flaws, providing network isolation of various
sorts is particularly valuable.  Of course, using multiple namespace types
together can provide 
even more isolation for both security and other needs. 
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Namespaces">Namespaces</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/580893/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor581942"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 3:27 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/581942/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yay! Thanks for the walkthrough. I'll have to try out stuffing a tmux session into a network namespace with which to use VPN with instead of forcing all of my traffic over it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/581942/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor581949"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 4:43 UTC (Thu)
                               by <b>mikemol</b> (guest, #83507)
                              [<a href="/Articles/581949/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, for pete's sake. I've been wanting a way to do multiple virtual routers on the same machine for months...and this has been there the entire time? I've got an ugly mess of a source-specific routing ruled this would have cleaned up nicely...though I doubt Sanewall has support for namespaces at this time...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/581949/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 22:13 UTC (Thu)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/582116/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which is a large part of the point of ip netns exec.   It allows you to run unmodified code in a network namespace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor581966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 8:30 UTC (Thu)
                               by <b>nicollet</b> (subscriber, #37185)
                              [<a href="/Articles/581966/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a way to do layer3 devices like openVZ venet devices ?<br>
<p>
Cheers,<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/581966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor581984"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 11:03 UTC (Thu)
                               by <b>nelljerram</b> (subscriber, #12005)
                              [<a href="/Articles/581984/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure I've fully understand the behaviour of a venet device (from <a href="http://openvz.org/Virtual_network_device">http://openvz.org/Virtual_network_device</a>).  But I believe that a veth device effectively becomes layer 3 if you add an IP address to it and don't plug it into a bridge.  Does that help at all?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/581984/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 14:34 UTC (Thu)
                               by <b>nicollet</b> (subscriber, #37185)
                              [<a href="/Articles/582024/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not really, from a performance point of view, venet devices seem better.<br>
<p>
see: <a href="http://html5tv.rot13.org/media/lpc2009-Network_namespaces/presentation.pdf">http://html5tv.rot13.org/media/lpc2009-Network_namespaces...</a><br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor582110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 21:40 UTC (Thu)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/582110/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are macvlan devices which are similar in usage.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor581970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 9:05 UTC (Thu)
                               by <b>mbizon</b> (subscriber, #37138)
                              [<a href="/Articles/581970/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
<font class="QuotedText">&gt; In addition, physical devices (those connected to real hardware) cannot be assigned to namespaces other than the root</font><br>
<p>
yes they can, unless you meant something else by "real hardware"<br>
<p>
I can move eth0, my actual laptop ethernet device, to another namespace without problem.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/581970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582004"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 13:25 UTC (Thu)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/582004/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
AFAIK, anything that shows up separately in "ip link" can be moved, except for the loopback.  You can move physical devices and even individual VLANs (sub-interfaces) of a physical device to other network namespaces, independently.<br>
<p>
Now, I haven't tried fun stuff like moving a tunnel to a namespace where the underlying device isn't present, etc.  Or moving a physical device which has vlans spread over several namespaces.  Or any other number of netns manipulations that would touch boundary conditions.  It might work.  It might go bonkers.  It might drink your beer or do something unspeakable to your pet.<br>
<p>
I recall netns didn't work well for the stuff "tc" interacts with (traffic policer/shaper/classifier) in an earlier 3.0 kernel, for example.  Yeah, that was way back in 12/2011, so chances are someone fixed it already.<br>
<p>
Network namespaces can be quite "interesting" in the ancient chinese curses/proverbs sense: the thing has more boundary conditions than the number of D&amp;D D20 dice you'd find in one of the country-wide roleplaying game conventions during the gold age of tabletop RPG gaming...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582004/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 13:36 UTC (Thu)
                               by <b>mbizon</b> (subscriber, #37138)
                              [<a href="/Articles/582011/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
There is a flag on some netdevices (NETIF_F_NETNS_LOCAL) that prevent them from being moved.<br>
<p>
It is present on special devices like lo, but also on some virtual/tunnel devices like ppp.<br>
<p>
The rational for the latter is that packets sent on these interfaces may cross namespace boundaries, and that requires special handling (reset skb state). So until the codepath has been audited/fixed the flag is set.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582032"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 15:03 UTC (Thu)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/582032/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW, we also set it on wireless interfaces and only allow moving all virtual interfaces for the same hardware together, otherwise we'd get into very strange cross-netns issues<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582032/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor666488"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2015 13:38 UTC (Wed)
                               by <b>sourcejedi</b> (guest, #45153)
                              [<a href="/Articles/666488/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't see why F_NETNS_LOCAL would be set on ppp, and I don't think it is.  In fact it doesn't seem to be set on tunnel interfaces generally.  (Unless you enable "metadata collection", whatever that is).  The code explicitly records the netns the tunnel was created in and uses it in the xmit routine.  Which is great because that's probably what you want if you move a tunnel into a network namespace.  I haven't tested it yet though :).<br>
<p>
<a rel="nofollow" href="http://lxr.free-electrons.com/ident?i=NETIF_F_NETNS_LOCAL">http://lxr.free-electrons.com/ident?i=NETIF_F_NETNS_LOCAL</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/666488/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor689473"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2016 6:46 UTC (Thu)
                               by <b>ravi239</b> (guest, #109082)
                              [<a href="/Articles/689473/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I observed that on moving eth0 to another namespace, ip6tnl0 (tunnel) interface is also moved automatically along with eth0.<br>
Can we restrict  ip6tnl0 movement and allow only eth0 to be moved to another namespace ?  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/689473/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor582017"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 13:57 UTC (Thu)
                               by <b>zuki</b> (subscriber, #41808)
                              [<a href="/Articles/582017/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>they seem to have been largely ignored by many developers</blockquote>

FWIW, systemd has <a href="http://www.freedesktop.org/software/systemd/man/systemd.exec.html#PrivateNetwork=">PrivateNetwork=</a> since a long while and recently <a href="http://www.freedesktop.org/software/systemd/man/systemd.unit.html#JoinsNamespaceOf=">JoinsNamespaceOf=</a>. The first one is fairly heavily used.
      
          <div class="CommentReplyButton">
            <form action="/Articles/582017/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582046"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 15:21 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/582046/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm…would this work (all under a vpn-work.target directory):<br>
<p>
  - vpn-work-namespace.service with PrivateNetwork=true;<br>
  - vpn-work-setup@.service which is After=vpn-work-namespace.service and Before=vpn-work.service which migrates the %i device into the namespace created in the above service, creates a bridge and clones the routing tables;<br>
  - vpn-work.service JoinsNamespaceOf=vpn-work-namespace.service which starts up the VPN with the proper configuration file.<br>
<p>
I can then start openvpn in a new network service with "systemctl start vpn-work.target". Also, how does /etc/resolv.conf work here?<br>
<p>
The question I'm really interested in, assuming the above works: can my user have a unit file which JoinsNamespaceOf= to a system target (so that I can, as a user, start up apps in the VPN environment). Maybe system services would need a AllowUsersIntoNamespace=true option for this to work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582046/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 16:24 UTC (Thu)
                               by <b>zuki</b> (subscriber, #41808)
                              [<a href="/Articles/582055/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I can then start openvpn in a new network service with "systemctl start </font><br>
<font class="QuotedText">&gt; vpn-work.target".</font><br>
I imagine that this should work...<br>
<p>
<font class="QuotedText">&gt; Also, how does /etc/resolv.conf work here?</font><br>
Unfortunately resolv.conf is global. There are some plans to replace it with something dynamic that can return different results for different interfaces, but afaik, nothing's been done yet.<br>
<p>
<font class="QuotedText">&gt; The question I'm really interested in, assuming the above works: can my</font><br>
<font class="QuotedText">&gt; user have a unit file which JoinsNamespaceOf= to a system target</font><br>
No, the user systemd instance is unprivileged and cannot manipulate any namespace stuff right now. Though it would be really nice to add this kind of functionality.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582059"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 16:31 UTC (Thu)
                               by <b>mbizon</b> (subscriber, #37138)
                              [<a href="/Articles/582059/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Unfortunately resolv.conf is global. There are some plans to replace it with something dynamic that can return different results for different interfaces, but afaik, nothing's been done yet.</font><br>
<p>
when you use "ip netns exec NS ...", the process is launched such as /etc/resolv.conf is a bind mount of /etc/netns/&lt;NS&gt;/resolv.conf<br>
<p>
see the manual page of ip(8) for more details<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582059/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582060"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 16:34 UTC (Thu)
                               by <b>zuki</b> (subscriber, #41808)
                              [<a href="/Articles/582060/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Good to know, thanks. Systemd should probably do something similar.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582060/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582061"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 16:37 UTC (Thu)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/582061/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They do or atleast intend to<br>
<p>
<a href="http://cgit.freedesktop.org/systemd/systemd/commit/?id=3bef724f7e7f7eaca69881548b06e221b77d7031">http://cgit.freedesktop.org/systemd/systemd/commit/?id=3b...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582061/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor582062"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 16:41 UTC (Thu)
                               by <b>zuki</b> (subscriber, #41808)
                              [<a href="/Articles/582062/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"intend to" — yes. Done anything — unfortunately no. Tom Gundersen's commit that you linked to creates a very classic resolv.conf file. It is created in /run/... and has to be manually symlinked to in /etc/ to be seen by resolvers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582062/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor582058"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 16:32 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/582058/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Unfortunately resolv.conf is global.</font><br>
<p>
Yeah, this is what I feared. I guess I could just stick the VPN DNS servers at the bottom of the list and have them just take longer to resolve.<br>
<p>
<font class="QuotedText">&gt; No, the user systemd instance is unprivileged and cannot manipulate any namespace stuff right now. Though it would be really nice to add this kind of functionality.</font><br>
<p>
I presume it works in tandem with PID 1 though. Maybe stuffing some the relevant namespace FDs over some sockets would work here (as allowed by the .service defining the namespace(s)). Maybe something like "ExposeNamespaceToUsers=uid:500;gid:1000;group:vpn,wheel" in the top-level service?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582058/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor582095"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 19:25 UTC (Thu)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/582095/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I should point out that there is a common framework used in networking circles that uses network namespaces for testing called Mininet <a href="http://mininet.org/">http://mininet.org/</a> which is a python application that can create complex topologies using OpenVSwitch and OpenFlow to connect them together.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582095/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor583063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2014 10:54 UTC (Wed)
                               by <b>amarao</b> (subscriber, #87073)
                              [<a href="/Articles/583063/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I found rather funny behaviour of ip netns command. If tun interface (from openvpn) is assigned to network namespace, it loose it own IP. <br>
<p>
I think this is a feature, but rather strange, because restoring IP on openvpn interface require some hacks and tricks in scripts (to get old IP, to reassign it back).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/583063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor583372"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2014 11:39 UTC (Thu)
                               by <b>kevinm</b> (guest, #69913)
                              [<a href="/Articles/583372/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do network namespaces also partition AF_UNIX sockets?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/583372/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor583376"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2014 12:22 UTC (Thu)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/583376/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The code looks like it should:

<pre>
static struct sock *__unix_find_socket_byname(struct net *net,
                                              struct sockaddr_un *sunname,
                                              int len, int type, unsigned int hash)
{
        struct sock *s;

        sk_for_each(s, &amp;unix_socket_table[hash ^ type]) {
                struct unix_sock *u = unix_sk(s);

                if (!net_eq(sock_net(s), net))
                        continue;
[...]
</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/583376/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor672251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2016 10:50 UTC (Mon)
                               by <b>axlmac</b> (guest, #106395)
                              [<a href="/Articles/672251/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi all,<br>
<p>
I saw that interface indexing is local to namespaces and when trying to understand a bit more and assigning interfaces created on a namespace to another one I saw that rtnetlink prevented me to do that because the interface I tried to assign had the same index of another interface already present in the target namespace<br>
<p>
RTNETLINK answers: File exists<br>
<p>
Is there a way to assign ranges to the indexes of interfaces (by block of 1000 for instance) within a certain namespaces so that if moved they don't overlap? This might also give info on which namespace the interface was created (given for granted that namespaces have an index)<br>
<p>
The question came up into my mind while creating a veth interface pair where the interfaces are created in a namespace and then one of them is associated/moved to another one.<br>
<p>
Thanks Alex<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/672251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor672260"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2016 11:50 UTC (Mon)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/672260/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Create them in the default namespace (or at least, always create in a common namespace) and then assign to where ever needed?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/672260/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor672349"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2016 19:55 UTC (Mon)
                               by <b>axlmac</b> (guest, #106395)
                              [<a href="/Articles/672349/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well that's a good idea if all the interfaces were create by a central authority and in the main namespace but if in a namespace you terminate many ppp connections you'll get dozens of pppX interfaces and if the one you have just created in the main one has the index of one of those ppp conns I think you may get the same error.<br>
Also if some namespaces are managed by tenants (in term of OpenStack.org) they may have created already other interfaces without the Central Authority knows it<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/672349/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor674439"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 3, 2016 1:09 UTC (Wed)
                               by <b>axlmac</b> (guest, #106395)
                              [<a href="/Articles/674439/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When speaking about veth interfaces, is there a way to know which namespace the other end of a veth pair is in? How does the kernel know that? I've sought the Internet for this info for almost an hour with no luck. So far I can retrieve the index of the other end of a pair and nothing else ("ip -d link show dev vethX")<br>
<p>
Thanks, Alex<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/674439/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2019 8:05 UTC (Fri)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/779882/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This looks pretty relevant: <a href="https://unix.stackexchange.com/questions/441876/how-to-find-the-network-namespace-of-a-veth-peer-ifindex">https://unix.stackexchange.com/questions/441876/how-to-fi...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor919654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 7: Network namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 11, 2023 16:09 UTC (Wed)
                               by <b>vinipsmaker</b> (guest, #126735)
                              [<a href="/Articles/919654/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Once a connection is established by or to the remote endpoint, the file descriptor for that connection could be handled by a child process that is placed in a new network namespace created by a clone() call. The child would inherit its parent's file descriptors, thus have access to the connected descriptor. Another possibility would be for the parent to send the connected file descriptor to a process in a restricted network namespace via a Unix socket.</span><br>
<p>
I was writing some test code to build a sandbox for my application and I tried just this, but it doesn't work.<br>
<p>
1. Unprivileged process creates a new process in a new user+network namespace.<br>
2. Let's say the parent process is the supervisor and the child process is the guest.<br>
3. The supervisor creates a TCP connection to www.google.com:443 and sends the connected socket to the guest through SCM_RIGHTS.<br>
4. The guest successfully receives the file descriptor (it is not -1 and it is properly allocated on the process table).<br>
5. Any operation on that socket from the guest will error with EBADF (for other types of file descriptors such as a pipe it'll work just fine).<br>
<p>
I guess I'll just have to create proxy services that send an AF_UNIX socket (these sockets work fine) and perform all the operations on the guest's behalf.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/919654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2014, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
