        <!DOCTYPE html>
        <html lang="en">
        <head><title>The kernel connection multiplexer [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/657999/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/657667/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/657999/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The kernel connection multiplexer</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 21, 2015</br>
           </div>
As the introduction to Tom Herbert's <a href="/Articles/657970/">kernel
connection multiplexer (KCM) patch set</a> notes, TCP is often used for
message-oriented communication protocols even though, as a streaming
transport, it has no native support for message-oriented communications.
KCM is an effort to make it easier to send and receive messages over TCP
which adds a couple of other interesting features as well.
<p>
<h4>KCM functionality</h4>
<p>
In its simplest form, a KCM socket can be thought of as a sort of wrapper
attached to an ordinary TCP socket:
<p>
<blockquote>
<img src="https://static.lwn.net/images/2015/kcm1.png" width=523 height=22 alt="[KCM diagram]">
</blockquote>
<p>
Within the kernel, an object called a "psock" sits between the
application (which is using the KCM socket) and the actual TCP connection
to the world.  Outgoing messages are sent as formatted by the application.
Incoming data is buffered until the kernel sees (via a mechanism to be
discussed momentarily) that a full message has arrived; that message is
then made available to the application via the KCM socket.  The psock
module ensures that messages are sent and received as atomic units, freeing
the application from having to manage that aspect of the protocol.
<p>
Applications are often split into multiple processes, though, each of which
can deal with incoming messages in the same way.  Multiplexers to dispatch
messages are thus built into many applications.  But, while the kernel is
handling message receipt, it can also deal with the multiplexing.  So the
actual architecture of KCM looks a bit more like this:
<p>
<blockquote>
<img src="https://static.lwn.net/images/2015/kcm2.png" width=523 height=142 alt="[KCM diagram]">
</blockquote>
<p>
Each of the KCM sockets is seen as equivalent by the kernel — an incoming
message can just as well be passed to any one of them.  What actually
happens, of course, is that the kernel chooses between one of the processes
that is actually waiting for a message when one arrives; if there are no
waiting processes, the message will be queued.
<p>
Things get more complicated on the other side of the multiplexer as well,
in that there could be value in having multiple TCP connections to the same
destination.  A phone handset, for example, might connect to a service over
both broadband and WiFi.  In such a situation, the multiplexer could choose
between those connections for outgoing messages, and accept incoming
messages on any of them.  And, indeed, that's what KCM does:
<p>
<blockquote>
<img src="https://static.lwn.net/images/2015/kcm3.png" width=523 height=152 alt="[KCM diagram]">
</blockquote>
<p>
Thus, KCM can be thought of as implementing a sort of poor hacker's <a
href="/Articles/544399/">multipath TCP</a>, where the application is
charged with setting up the connections over the various paths.
<p>
There is one final detail: how is the TCP data stream broken up into
discrete messages?  One could certainly envision building some sort of
framing mechanism into KCM, as has been done in the kernel's <a
href="http://linux.die.net/man/7/rds">reliable datagram sockets</a> layer,
but that would limit its flexibility when it 
comes to implementing <i>existing</i> protocols.  If KCM is to be usable
for an existing message-oriented mechanism, there must be a way to tell KCM
how the framing of messages is done.
<p>
The solution here is perhaps predictable, since it is increasingly being used as
the way to extend kernel functionality: use the <a
href="/Articles/612878/">Berkeley packet filter (BPF)</a> subsystem.
Whenever some data shows up at the psock level, it is passed to a BPF
program for evaluation.  Normally, the program will examine the data,
determine the length of the message, and return that value.  A return value
of zero indicates that the length cannot be determined yet — more data must
be received before trying again.  A negative number indicates some sort of
protocol error; when that happens, KCM will stop servicing the affected
connection and signal an error to user space.
<p>
<h4>API details</h4>
<p>
An application wanting to use KCM starts by creating a new multiplexer;
this is done with a <tt>socket()</tt> call:
<p>
<pre>
    #include &lt;linux/kcm.h&gt;

    kcm_socket = socket(AF_KCM, SOCK_DGRAM, KCMPROTO_CONNECTED);
</pre>
<p>
If additional KCM sockets (attached to the same multiplexer) are needed,
they can be created by calling <tt>accept()</tt> on the initial KCM
socket.  Normally, <tt>accept()</tt> is not applicable to datagram sockets,
so this usage, while perhaps a little surprising, is arguably a reasonable
way of overloading this system call.

<p>
The application must also take care of the establishment of one or more TCP
connections to the remote side and attaching them to the multiplexer.  Once 
a socket is open, it should be placed into a <tt>kcm_attach</tt> structure:
<p>
<pre>
    struct kcm_attach {
        int fd;
        int bpf_type;
        union {
            int bpf_fd;
            struct sock_fprog fprog;
        };
    };
</pre>
<p>
Here, <tt>fd</tt> is the file descriptor for the open socket.  The rest of
this structure exists so that the application can supply the BPF program
that will help split the incoming data stream into messages.  If
<tt>bpf_type</tt> is <tt>KCM_BPF_TYPE_FD</tt>, then <tt>bpf_fd</tt>
contains a file descriptor corresponding to a BPF program that has been
loaded with the <tt>bpf()</tt> system call.  Otherwise, if
<tt>bpf_type</tt> is <tt>KCM_BPF_TYPE_PROG</tt>, then <tt>fprog</tt> points
to a program to be loaded directly at this time.
<p>
The provision of two ways to load the BPF program may look a bit strange.
It is, in fact, a combination of new and old ways of solving this
particular problem.
The <tt>bpf()</tt> approach is the newer way of doing things, while the
<tt>sock_fprog</tt> approach has been used to load BPF programs into the
network subsystem until now.  It would not be entirely surprising to see a
request from reviewers to narrow the interface down to just one of the two,
most likely the <tt>bpf()</tt> method.
<p>
In any case, once the structure has been filled in, it is passed to a new
<tt>ioctl()</tt> command (<tt>SIOCKCMATTACH</tt>) to connect the socket to
the multiplexer.  There is also a <tt>SIOCKCMUNATTACH</tt> operation to
disconnect a socket.
<p>
Once the pieces are connected together, the application can use the KCM
socket(s) like any other datagram socket.  Messages can be sent and
received with interfaces like <tt>sendmsg()</tt> and <tt>recvmsg()</tt> (or
<tt>write()</tt> and <tt>read()</tt>), <tt>poll()</tt> can be used to wait
for a message to arrive, and so on.  The whole structure will persist until
the last KCM socket is closed, at which point it is torn down.
<p>
One might wonder why this mechanism is being proposed for the kernel, given
that applications have been solving this problem in user space for years.
There is no explicit justification offered in the patch set, but one can
imagine that it would involve performance improvements (avoiding copying or
retransmission of data), the ability to do smart load balancing, and having
a single implementation used by all.  The "to do" list in the patch
posting, which says that "<q>TLS-in-kernel is a separate
initiative<q>", suggests that there may be efforts to push other
functionality into the kernel in the future.  Whether these efforts will
succeed remains to be seen, but there is clearly a lot of interest in
adding interesting functionality to the Linux networking stack.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking">Networking</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/657999/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor658019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 21, 2015 23:33 UTC (Mon)
                               by <b>flewellyn</b> (subscriber, #5047)
                              [<a href="/Articles/658019/">Link</a>] (29 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm...dubious.<br>
<p>
This kind of task seems to me to be a user-space task.  And I don't really see the justification for putting it in-kernel, vis a vis performance.  <br>
<p>
Besides which, if you want message-oriented service with reliable delivery, there's RUDP, DCCP, SCTP, and others.  Why force TCP into doing something it's not designed for?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 21, 2015 23:55 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658020/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; And I don't really see the justification for putting it in-kernel, vis a vis performance.</font><br>
It'll be a major improvement for many protocols that do a "read-4-octet-length-and-then-the-packet" song-and-dance.<br>
<p>
<font class="QuotedText">&gt; Why force TCP into doing something it's not designed for?</font><br>
Middleboxes...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658025"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 7:13 UTC (Tue)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/658025/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm also sceptic. This is a solved problem nobody is complaining about. You seem to have a clear opinion of what it brings to the table, so please explain it a bit more (with a real application example that can benefit if possible). Actually the best I could think of is messaging middleware, which is a rather specialized niche.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658025/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658033"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 8:25 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658033/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One interesting use-case - encryption handling in the kernel.<br>
<p>
Personally, I always wished to be able to do "socket(AF_TLS, SOCK_SEQPACKET)" and be able to use encryption transparently. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658033/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 9:09 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/658039/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please no. i just have had to spend a lot of time fighting problems on windows systems where they have such a system call. The problem is that when things don't work, getting info on WHY it's not happy with the connection is extremely hard.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658043"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 12:25 UTC (Tue)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/658043/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I figure that's different from this access pattern. Good debug info, yes, always helpful. Notably when you have to complexity of key type, encryption method and expected outcome, there's a special need to understand what's not right in ... what might best be described as a signal-processing chain. So good places for inspection are what you're asking for, not a rejection of this proposed pattern, right?<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658043/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor658086"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 17:37 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658086/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Uhm, which call are you thinking about? There's WinInet/WinHttp families of functions, but they are implemented in userspace (poorly).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658086/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 18:24 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/658089/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't know the call, I was at the mercy of closed source software trying to talk to a different AD server and failing because it didn't like the cert. All the vendor could tell me what that they were making the 'standard call to establish an encrypted connection' and it was failing<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 20:25 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658110/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly the same could happen if this software used OpenSSL with an incorrect trust storage or something.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor687966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2016 6:01 UTC (Thu)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/687966/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Two points, con and pro:<br>
<p>
1) Con: Which would you prefer: having to upgrade your kernel when a TLS issue arises, or OpenSSL? Keep in mind, we also must appreciate the cost of upgrading incurred by our network peers. Upgrading and evolving TLS across the global network would be even slower if OpenSSL weren't the predominate server-side library. At one of the companies I work at, we're still using 2.6 kernels. Apple has tried to shift away from OpenSSL, but their CoreCrypto stack is pretty limited, both wrt to certificate management APIs and cipher mode support. They simply bit off more than they could chew, but few notice because few people use the stack or demand much of it, or when they do they either control the server side or simply are oblivious to the problems.<br>
<p>
Adding another TLS implementation to the heap probably isn't a good idea. Which is why libressl and BoringSSL are so committed to practical API compatibility; and keeping code in sync between themselves and, as much as possible, with OpenSSL. Imagine trying to roll out something like ALPN. That would be much uglier than the current problems wrt  HTTP/2 if there was another widely used stack.<br>
<p>
2) Pro: IIRC, proposals for kernel-based TLS support which have come closest to inclusion keep the handshake and PKI management in userspace. The kernel layer is only invoked once the session is established, and perhaps in initial routing based on SNI. That aspect of the protocol changes the least, at least going forward and assuming the latest crop of cipher mode schemes remain viable.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/687966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor658094"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 19:29 UTC (Tue)
                               by <b>smckay</b> (guest, #103253)
                              [<a href="/Articles/658094/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Userspace could do that just as well--OpenSSL is definitely not the best possible TLS implementation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658094/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 20:04 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658103/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How? I don't see a way to make read(2) decrypt data without dirty tricks like LD_PRELOAD.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658105"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 20:15 UTC (Tue)
                               by <b>smckay</b> (guest, #103253)
                              [<a href="/Articles/658105/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, we have that already, more or less--it's called SSL termination. But I doubt that was your point. So you're using a library. So what? Shoving the code into the kernel isn't going to make the experience of setting up a TLS connection any more pleasant. You still have to do key exchange and authentication, and TLS still gives you a million ways to do both.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658105/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658114"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 20:40 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658114/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Certainly, handling TLS setup in userspace is OK, but after connection is established and keys are negotiated it'd be nice to delegate decryption to the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658114/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658115"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 20:49 UTC (Tue)
                               by <b>smckay</b> (guest, #103253)
                              [<a href="/Articles/658115/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, I can see that, especially to keep key material out of userspace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658115/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658119"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 21:14 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658119/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, what I'd like to see is an ability to send TLS sockets between processes. So this way Apache can delegate SSL connection negotiation to a separate process that has access to private keys and once it's done, just send the socket to the actual web-server process.<br>
<p>
Can be done in userspace, but no existing TLS library can serialize its internal state for inter-process transmission (bad OpenSSL, bad).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658119/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658340"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2015 19:24 UTC (Thu)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/658340/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Will this really outperform a well-written epoll-based userspace SSL terminator that passes ends of socketpairs around?<br>
<p>
Also, TLS supports things like renegotiation, so it's not as simple as "create a connection, set up session keys, and you're done".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658340/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658352"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2015 20:35 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658352/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Will this really outperform a well-written epoll-based userspace SSL terminator that passes ends of socketpairs around?</font><br>
Absolutely. "SSL Terminator" is about the worst pattern for high-performance services. You have _multiple_ kernel switches with lots of TLB thrashing for each packet as a result.<br>
<p>
<font class="QuotedText">&gt;  Also, TLS supports things like renegotiation, so it's not as simple as "create a connection, set up session keys, and you're done".</font><br>
They are optional (and should not be used, anyway). Just terminate the connection in this case.<br>
<p>
Also, having a dedicated userspace component is also a possibility - i.e. the kernel happily demuxes everything during the normal operation but punts requests back to userspace if anything is abnormal (like requests for renegotiation or PFS key renewal).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658352/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658407"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 25, 2015 9:49 UTC (Fri)
                               by <b>hkario</b> (subscriber, #94864)
                              [<a href="/Articles/658407/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For long-lived sessions (remember, it has to be completely transparent), you need to do key renegotiation simply because you have transferred so much data (even petabytes with 10Gbps Ethernet isn't much) that you will start leaking keys.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658407/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor687968"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2016 6:12 UTC (Thu)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/687968/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe both libressl and BoringSSL have ripped out renegotiation. I'm not sure about their reasons beyond concern with the complexity of the implementing code, but IMO the safer course going forwarding is probably using a cipher mode with a longer period instead of relying on a complex, error prone protocol-level renegotiation. I'm unsure if there are any standardized cipher modes with a long-enough period (AES-GCM or ChaCha20-Poly1035?), but given the current state of TLS and TLS implementations, worrying about the ability to send such large streams is a good problem to have at the moment.<br>
<p>
It also might be the case that TLS session resumption permits rekeying, and that might still be supported by libressl and BoringSSL. In that case applications could still do a little dance to rekey a session.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/687968/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1002961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 20, 2024 5:09 UTC (Fri)
                               by <b>matthijs</b> (guest, #128389)
                              [<a href="/Articles/1002961/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Renegotiation was a source of security vulnerabilities. Nowadays it's typically disabled by implementations and TLS 1.3 entirely removed it as a feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1002961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor658149"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 23, 2015 7:40 UTC (Wed)
                               by <b>lsl</b> (subscriber, #86508)
                              [<a href="/Articles/658149/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yep. Plan 9 does it that way with its TLS device. Pretty nice to be able to push TLS onto any file descriptor.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658149/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor658083"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 17:38 UTC (Tue)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/658083/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <blockquote> <blockquote>And I don't really see the justification for putting it in-kernel, vis a vis performance.</blockquote>
It'll be a major improvement for many protocols that do a "read-4-octet-length-and-then-the-packet" song-and-dance.</blockquote>

<p>For small messages you can normally just receive into a large buffer and get a header and message in one go, so long as the sender is careful about using MSG_MORE or TCP_CORK correctly when sending.  You still have to handle the case it doesn't come off like that, but the efficiency of handling lots of small messages over TCP can be made reasonably efficient with some care.</p>

<p>KCM will also always add overhead in touching payloads an extra time for the BPF message length determination.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/658083/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658112"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 20:29 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658112/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is another issue with connections with very slow rate of incoming data. As a result your application can get storms of very short reads. And it actually happens a lot with connection from mobile devices and it is a problem for servers handling a lot of connections.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658112/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658122"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 21:41 UTC (Tue)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/658122/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Never seen that myself.  Once you have a partial message you can do a blocking read to get the rest of the payload, and normally the Linux kernel is pretty good at returning what it has with recv().<br>
<p>
You aren't doing something funny with signals are you, and interrupting all your system calls to get EINTR?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658122/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658124"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 21:49 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658124/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linux kernel can and will return only partial data if it's coming too slow. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658124/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor658263"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2015 8:21 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658263/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, think about this way. <br>
<p>
Modern high-performance network servers are often limited by the context switching overhead, so there are several projects that instead move _everything_ to userspace, including the network stack itself. And results are often quite impressive - just check <a rel="nofollow" href="http://www.seastar-project.org/">http://www.seastar-project.org/</a> with DPDK.<br>
<p>
But this doesn't really scale - to get the best performance you have to dedicate a whole network card to one application. And then you lose many important kernel features (firewalls, iptables, shapers, security). It would be nice if we could get _most_ of DPDK performance by adding kernel features like KCM.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658263/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658326"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2015 16:41 UTC (Thu)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/658326/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SolarFlare have similar stuff, moving the stack and most of the device driver to userspace.  I think their adaptors can handle multiple applications efficiently and even cope with application crashes too.<br>
<p>
Really it all smacks of the old Berkeley sockets API not being appropriate to high performance applications though.  I'm not sure this kmux thing is the answer to that, though it causes no harm either.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658326/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor658477"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 25, 2015 18:20 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/658477/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Quite. If that's the only justification, then this is code in the kernel to compensate for incompetent userspace programmers.<br>
<p>
(I wrote a library that does more or less exactly what this is proposing in a previous job, in, oh, 2000 lines, except it worked for arbitrary stream file descriptors, not just TCP network sockets. It always read() big lumps at once (or the maximum available, if no big lump was available). It was not hard to write.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658477/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor659108"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2015 5:48 UTC (Sun)
                               by <b>toyotabedzrock</b> (guest, #88005)
                              [<a href="/Articles/659108/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So everyone who needs to send simple network messages doesn't make their own often flawed and insecure implementation? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/659108/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor658030"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 7:53 UTC (Tue)
                               by <b>kugel</b> (subscriber, #70540)
                              [<a href="/Articles/658030/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm unclear what the advantage over SCTP is which also offers reliable message transport.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658030/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658045"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 12:43 UTC (Tue)
                               by <b>tshow</b> (subscriber, #6411)
                              [<a href="/Articles/658045/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I'm unclear what the advantage over SCTP is which also offers reliable message transport.</font><br>
<p>
From the looks of it, the advantage is that the other end of the connection doesn't know the difference, and so just talks TCP.  I'd *love* to use SCTP, and have wanted to be able to since 2000 or so, but invariably I have a Linux server that can speak SCTP and a bunch of clients (windows machines, game consoles, phones, tablets...) which will probably never have SCTP in their stack, regardless of how fervently I wish for it.<br>
<p>
Believe me; I've been wishing REALLY hard for a decade and a half, and it hasn't been working.<br>
<p>
So, I'm tunneling reliable-ish message-oriented traffic over TCP and UDP (a lot of what I'm doing is games, so it's TCP for bulk data transfers and UDP for time-critical game data).  This would appear to make things cleaner on the server side.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658045/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658046"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 14:33 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/658046/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
how do you figure that this new setup wouldn't require any support on the other side? or that it will be deployed any wider than SCTP or the other existing options?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658046/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 16:16 UTC (Tue)
                               by <b>smckay</b> (guest, #103253)
                              [<a href="/Articles/658073/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because KCM sends and receives TCP packets. How could it require support from the peer?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor658076"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 16:26 UTC (Tue)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/658076/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is designed to be used with existing wire protocols.<br>
<p>
<font class="QuotedText">&gt; In order to delineate message in a TCP stream for receive in KCM, the</font><br>
<font class="QuotedText">&gt; kernel implements a message parser. For this we chose to employ BPF</font><br>
<font class="QuotedText">&gt; which is applied to the TCP stream. BPF code parses application layer</font><br>
<font class="QuotedText">&gt; messages and returns a message length. Nearly all binary application</font><br>
<font class="QuotedText">&gt; protocols are parsable in this manner, so KCM should be applicable</font><br>
<font class="QuotedText">&gt; across a wide range of applications.</font><br>
<p>
One of the major advantages of doing this is you can avoid waking up the user process until a complete message is received.  It also allows you to efficiently load balance incoming TCP datagrams on the same connection across multiple threads or processes.  No user space demultiplexing thread required.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658076/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor658156"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 23, 2015 11:05 UTC (Wed)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/658156/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No to mention that there's the entire Internet built of devices that see anything other than TCP and UDP as something to filter out. So, I'm not holding by breath that SCTP will ever gain traction, unfortunately.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658156/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658165"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 23, 2015 15:46 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/658165/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's possible to encapsulate SCTP in UDP (RFC 6951), so long as both endpoints are SCTP-capable and implement the RFC.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658165/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658361"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2015 21:21 UTC (Thu)
                               by <b>tdalman</b> (guest, #41971)
                              [<a href="/Articles/658361/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting. Didn't know about RFC6951 :)<br>
<p>
I also would like to see SCTP to be used more in real-life applications. Unfortunately, it seems that up until now almost all use cases are only found in the academic area :-(<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658361/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor658412"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 25, 2015 10:34 UTC (Fri)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/658412/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It's possible to encapsulate SCTP in UDP</font><br>
<p>
Well, yeah :) "Any problem in computer science can be solved by another layer of indirection", after all ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658412/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor658029"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 7:53 UTC (Tue)
                               by <b>bytelicker</b> (guest, #92320)
                              [<a href="/Articles/658029/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There has clearly been put a lot of work into this. It seems neat, but I I'm having a hard time wondering if this belongs in the kernel or user space. Either way maybe this makes some sense. It would provide a low-level message-oriented communication directly though the kernel.<br>
<p>
Maybe it tries to solve a problem that was never a problem, but it does not mean that it is a worthless addition. I think this potentially could be very useful for future projects.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658029/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 16:47 UTC (Tue)
                               by <b>shemminger</b> (subscriber, #5739)
                              [<a href="/Articles/658079/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Userspace ZMQ already does things like this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 17:35 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658085/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No it doesn't. It provides simple primitives that can do this, but it doesn't deal with a lot of other stuff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor658144"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 23, 2015 4:31 UTC (Wed)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/658144/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ragel solves 80% of the headaches with message parsing, and 90% of the headaches parsing a byte stream from a non-blocking I/O source. Because it's restartable--no callbacks, and only a single integer as state for basic grammars--it's easy to integrate into almost any project. In many cases it removes the need to implement intermediate buffering of grammar elements (lines, blocks, etc) altogether, even if the grammar is recursive.<br>
<p>
Using AF_KCM you'll still have to go through the trouble of compiling a BPF parser as part of your build, and it would be exceptionally limited. One might as well just use Ragel, which is immensely more powerful and expressive.<br>
<p>
People in the telecommunication industry use ASN.1 to send and receive billions, nay trillions, of tiny messages each day. But you'll almost never see them using a low-level ASN.1 library as in OpenSSL, parsing messages field-by-field. They use ASN.1 compilers that generate the code to pack and unpack all the data into application data structures. There's only a single open source project that does this, asn1c, which is pretty good. You can feed the parsers it generates arbitrary numbers of bytes and attempt to dequeue parsed messages. it reduces what would be a tortuous and bug-ridden I/O, buffering, and parsing module into: while (buflen = socket_read(buf)) { parser_write(parser, buf, buflen); while ((msg = parser_getmsg(parser))) { ... } }. Notice how that pattern works whether the socket source is blocking or non-blocking.<br>
<p>
Ragel is a general purpose tool that allows you to easily implement this pattern for any arbitrary protocol, in C and many other languages. Not only will it simplify your code, but your parser will invariably be much faster than handwritten C code. All my Ragel-based parsers, for example, blow away ffmpeg's container parsers, which are implemented using the typical parser pattern--read a length tag, buffer length-bytes, then parse all the fields individually with applicable conditional logic.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658144/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658147"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 23, 2015 5:36 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/658147/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nothing in userspace can solve problems on the kernel-userspace interface. You still have to do a syscall roundtrip for every read(2).<br>
<p>
And telecom people? There's a reason why so many telecom protocols are message-based.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658147/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658260"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2015 7:45 UTC (Thu)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/658260/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's also the reason why telecoms use SCTP a lot.<br>
<p>
KCM solves a real problem, and it solves it without requiring changes to the routing quipment between the two ends. It's not optimal, especially on the sending side (if you're doing high-throughput 1:1 comms it doesn't help, for example) but it helps a lot.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658260/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor658117"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 21:05 UTC (Tue)
                               by <b>caitlinbestler</b> (guest, #32532)
                              [<a href="/Articles/658117/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What is the benefit of running the multiplexed messages over TCP?<br>
<p>
This would be a very thin library if the kernel-to-kernel communications were done with SCTP.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658117/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor658116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel connection multiplexer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 21:30 UTC (Tue)
                               by <b>smckay</b> (guest, #103253)
                              [<a href="/Articles/658116/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not quite seeing this for HTTP. HTTP/2, I guess, or web sockets.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2015, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
