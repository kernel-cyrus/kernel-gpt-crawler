        <!DOCTYPE html>
        <html lang="en">
        <head><title>Suppressing SIGBUS signals [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/860419/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/860821/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/860419/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Suppressing SIGBUS signals</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>June 25, 2021</br>
           </div>
The <a
href="https://man7.org/linux/man-pages/man2/mmap.2.html"><tt>mmap()</tt>
system call</a> creates a mapping for a range of virtual addresses; it
has a long list of options controlling just how that mapping should work.
Ming Lin is <a
href="/ml/linux-kernel/1622792602-40459-1-git-send-email-mlin@kernel.org/">proposing</a>
the addition of yet another option, called <tt>MAP_NOSIGBUS</tt>, which
changes the kernel's response when a process accesses an unmapped address.
What this option does is relatively easy to understand; why it is 
useful takes a bit more explanation.

<p>
Normally, when a process performs an operation involving memory, it expects the
desired data to be read from or written to the requested location.  Sometimes,
though, things can go wrong, resulting in the delivery of a fatal (by
default) signal to the process.  A "segmentation violation"
(<tt>SIGSEGV</tt>) signal is generated in response to an attempt to access a
valid memory address in a way that is contrary to its protection — writing
to read-only memory, for example.  Attempting to access an address that is
invalid, 
instead, results in a "bus error" (<tt>SIGBUS</tt>).  Bus errors can be
provoked in a number of ways, including  using an improperly aligned
address or an address that is not mapped at all.  If a process uses
<tt>mmap()</tt> to create a mapping that extends beyond the end of the
backing file, attempts to access the pages past the end of the file will
result in <tt>SIGBUS</tt> signals.
<p>
If, however, a memory range has been mapped with the proposed
<tt>MAP_NOSIGBUS</tt> flag, <tt>SIGBUS</tt> signals will no longer be
generated in response to an invalid address that lies within the mapped
area.  Instead, the guilty process will get a new page filled with zeroes.
If the mapped area is backed up by a file on disk, the new page will not be
added to that file.  To a first approximation, the new option simply makes
<tt>SIGBUS</tt> signals go away, with the process never even knowing that
it had tried to access an invalid address.
<p>
<h4>OK...but why?</h4>
<p>
This behavior may seem like a strange thing to want.  One would not
normally expect a mapped area to contain invalid addresses within it, and
one ordinarily wants to know if a program is generating and using invalid
addresses.  As it happens, mapped areas <i>can</i> contain invalid
addresses in one normal use case: if that area is mapping a file, and it
extends beyond the end of the file on disk.  Attempts to access pages
beyond the end of the file will generate a <tt>SIGBUS</tt> signal; this
situation can be avoided by extending the file before attempting to access
it through the mapping.
<p>
<tt>MAP_NOSIGBUS</tt> is explicitly incompatible with that way of working,
though; since the zero-filled pages that it creates in response to invalid
addresses are not connected to the backing file, it makes extending the
file without redoing the mapping impossible.  Instead, this option exists to
address another problem:
graphical clients that can, accidentally or intentionally, cause a
compositor to crash.
<p>
Graphical applications often have to communicate large amounts of data to
the compositor.  An efficient way of doing this can be to map a file and
pass a descriptor to the compositor; that file (which can live in a
memory-only filesystem) becomes a shared-memory segment between the two
processes.  If, however, the client process then calls <a
href="https://man7.org/linux/man-pages/man2/ftruncate.2.html"><tt>ftruncate()</tt></a>
to shorten the file, the result is a mapping (in the compositor) that
extends beyond the end of that file.  If the compositor tries to access the
shared-memory segment beyond the new end of the file, it will get a
<tt>SIGBUS</tt> signal; in the absence
of measures taken to the contrary, that will cause the compositor to crash,
which is the sort of thing that user-experience developers usually make at
least a modest effort to avoid.  The <tt>SIGBUS</tt> signal can be caught
and handled in the compositor, but that can be complex and hard to get
right.
<p>
As Simon Ser, who works on Wayland compositors, <a
href="/ml/linux-mm/vs1Us2sm4qmfvLOqNat0-r16GyfmWzqUzQ4KHbXJwEcjhzeoQ4sBTxx7QXDG9B6zk5AeT7FsNb3CSr94LaKy6Novh1fbbw8D_BBxYsbPLms=@emersion.fr/">noted</a> back
in April, there is another mechanism for passing data between the two
processes: the <a href="/Articles/593918/">memfd</a> abstraction.  A memfd
can be "sealed", meaning that the creator cannot shrink it as described
above (or, indeed, change it at all); the recipient, knowing that the
segment will not change unexpectedly, can access it safely.  But, as Ser
points out, no 
compositor requires the use of sealed memfds because there are clients that
are unwilling or unable to use them.  So compositors must either jump
through the <tt>SIGBUS</tt>-handling hoops or risk filling the disk with
embarrassing core dumps.
<p>
But if the compositor could map a segment in a way that wouldn't create
<tt>SIGBUS</tt> signals on invalid addresses, this whole problem would go
away.  Ser suggested looking at the <tt>__MAP_NOFAULT</tt> flag supported
by OpenBSD as a possible solution.  At the beginning of June, Lin responded
with <a
href="/ml/linux-kernel/1622589753-9206-1-git-send-email-mlin@kernel.org/">an
implementation</a> of
<tt>MAP_NOSIGBUS</tt>, which differs from <tt>__MAP_NOFAULT</tt> in a
number of ways.  The initial implementation only worked for the in-memory
tmpfs filesystem, but Hugh Dickins <a
href="/ml/linux-kernel/alpine.LSU.2.11.2106011913590.3353@eggly.anvils/">objected</a>,
saying that it should apply to any mapping; the second (and current
revision) reflects that criticism and works regardless of the backing store
behind a mapping.
<p>
<h4>Limitations</h4>
<p>
One significant limitation of the current implementation is that it only
works for <tt>MAP_PRIVATE</tt> mappings — that seems like it could be a
fatal flaw for a mechanism that is meant for use with mappings shared
between clients and a compositor.  But, as Ser <a
href="/ml/linux-mm/lpi4uT69AFMwtmWtwW_qJAmYm_r0jRikL11G_zI4X7wq--6Jtpiej8kGn8gePfv0Dtn4VmzsOqT2Q5-L3ca2niDi0nlC0nVYphbFBnNJnw0=@emersion.fr/">explained</a>,
private mappings will work in almost all cases; since the data transfer is
one-way from the client to the compositor, the mapping can be read-only on
the compositor side.  The big exception is screen capture, which will still
have to be handled specially as long as shared mappings are not supported.
So the solution is not complete, but 90% is a big step in the right
direction.
<p>
The second version of the patch set has seen relatively little discussion;
it seems that the developers who care about it are relatively happy with
its current condition (though Kirill Shutemov was <a
href="/ml/linux-kernel/20210604152407.ouchyfuxjvchfroe@box/">heard to
grumble a bit</a> about "<q>one-user features</q>").  There are never
any guarantees, but there does seem 
to be a reasonable chance that this change could be merged as early as the
5.14 release.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-mmap">System calls/mmap()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/860419/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor861000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2021 17:37 UTC (Fri)
                               by <b>pm215</b> (subscriber, #98099)
                              [<a href="/Articles/861000/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another kernel ABI change with no documentation ? That&#x27;s certainly a good way to keep it a one-user feature...<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861027"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2021 22:11 UTC (Fri)
                               by <b>angelsl</b> (subscriber, #144646)
                              [<a href="/Articles/861027/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s not actually accepted yet.<br>
<p>
It will be documented once it gets into mainline.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861027/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 12:24 UTC (Sat)
                               by <b>pm215</b> (subscriber, #98099)
                              [<a href="/Articles/861063/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m not a kernel dev, but when I do review KVM ABI changes (from my POV as a userspace consumer of the ABI) I always want to *start* with the documentation patch. That tells me what the intention is, which I can then use to check whether the implementation matches the intention. Documentation that appears after the fact doesn&#x27;t permit that and I think it tends to encourage &quot;thing that&#x27;s easy&quot; or &quot;first thing I thought of&quot; ABI design rather than &quot;ABI that makes sense to consumers&quot;.<br>
<p>
And indeed sometimes &quot;documentation after the fact&quot; becomes &quot;documentation never&quot; or &quot;documentation years later&quot; -- I&#x27;ve run into a few cases of that when implementing QEMU&#x27;s syscall emulation layer. The point of leverage for ensuring contributions meet a minimum standard is before patches are accepted; once they go in that leverage disappears.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861081"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 19:21 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/861081/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agreed. It&#x27;s the same reason commit messages are so important for diffs: it helps to introduce others to what the change does as a whole, how it is used, and to (ideally) say why it is useful. Documentation is even more important because it should be what people look for first when trying to figure out how to do something. Commit messages are just harder to dig up via manpages…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861081/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor861009"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2021 20:13 UTC (Fri)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/861009/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This would be useful for Rust (and I guess other languages that take safety seriously). A private, read-only mapping of a file to get a &amp;[u8] *should* be safe, but it technically isn&#x27;t because of this exact issue --- something could truncate the backing file, causing some innocent user of the &amp;[u8] to crash. MAP_NOSIGBUS would make it really safe. So this sounds great.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861009/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2021 21:11 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/861019/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t know that I would call pages of zeros with no other indication of an error &quot;safe.&quot;<br>
<p>
I believe the program can get a few other signals from memory map access too. IO errors on a disk read for example. I just looked it up, and it is still a SIGBUS but if you use sigaction and a SA_SIGINFO handler, the si_code field will give details about what exactly happened.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861035"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 0:57 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/861035/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The word &quot;safe&quot; has two different meanings in this context:<br>
<p>
1. I know, at compile time, that dereferencing a given pointer will never cause the program to crash, corrupt the heap, or otherwise misbehave. The pointer is &quot;safe.&quot;<br>
2. I know, at compile time, that my program will handle all error cases within a given subroutine. The subroutine is &quot;safe.&quot;<br>
<p>
The problem is that mmap basically can&#x27;t support (2) if the map is backed by a real file, unless you want to catch and handle SIGBUS. But nobody *wants* to handle SIGBUS, especially in a &quot;let&#x27;s try to recover and keep executing&quot; way (as opposed to a &quot;let&#x27;s print a cryptic error message and call abort&quot; way). (1), on the other hand, is solved quite effectively with this patch, and anyone who really does want (2) can use something other than mmap to read the file (which is no worse than the status quo).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861035/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861037"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 1:21 UTC (Sat)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/861037/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think Rust considers crashing the program to be &quot;safe&quot; (certainly I do); that&#x27;s what it does on OOM, after all.<br>
<p>
So I think this is misguided: I think SIGBUS signals on bad memory accesses are already safe, in Rust terms.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861037/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861040"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 2:04 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/861040/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Meh, that&#x27;s a matter of perspective. Crashing is only the default behavior, and they are working to make it easier to avoid crashing on OOM. There is no technical reason* why OOMing needs to crash, in a language with manual memory management. You could instead have fallible allocation and require the application to handle an OOM condition explicitly.<br>
<p>
* You cannot control what the OOM killer does (although the sysadmin can, to some extent). But the OOM killer could even kill a completely unrelated process, and is not part of Rust itself, so let&#x27;s ignore it. Besides, since Rust is a systems language, it can be used to write kernelspace code that is exempt from the OOM killer altogether.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861040/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861093"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 5:57 UTC (Sun)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/861093/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; why OOMing needs to crash, in a language with manual memory management. You could instead have fallible allocation and require the application to handle an OOM condition explicitly.</font><br>
<p>
Not every system is an overcommit system. Windows isn&#x27;t. Linux with vm.overcommit_memory=2 isn&#x27;t either. <br>
<p>
Anyway, Rust wouldn&#x27;t be having this problem at all if it had just adopted exceptions for error handling.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861093/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861101"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 12:14 UTC (Sun)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/861101/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Anyway, Rust wouldn&#x27;t be having this problem at all if it had just adopted exceptions for error handling.</font><br>
<p>
I dare say it would be having others, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861101/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor861141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 21:26 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/861141/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Not every system is an overcommit system. Windows isn&#x27;t. Linux with vm.overcommit_memory=2 isn&#x27;t either.</font><br>
<p>
Yes, that&#x27;s why I included the footnote about the OOM killer being out of scope. It&#x27;s not part of Rust in the first place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor861073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 17:16 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/861073/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t know. `&amp;[u8]` might be fine, but if I mmap&#x27;d something like `&amp;[RawSpriteData]`, I think I&#x27;d *prefer* to crash because all-zeros isn&#x27;t very useful to me.<br>
<p>
<font class="QuotedText">&gt; I know, at compile time, that dereferencing a given pointer will never cause the program to crash, corrupt the heap, or otherwise misbehave.</font><br>
<p>
Rust (or any language for that matter) can only do so much. If, say, the hypervisor ends up fiddling with the VM&#x27;s page tables, programs can certainly crash no matter how &quot;safe&quot; the language or runtime is. If the RAM gets a bit twiddled by a cosmic ray, all bets are similarly off in most cases. These kinds of things are outside of a language&#x27;s control and are, IMO, purely in the realm of &quot;just how paranoid do you need to be?&quot; when coding any project in any language. JoeSchmo webapp? Users are probably trained to refresh on weird errors these days and such things are fine with systemd&#x27;s restart logic. Sending a rover to Mars? Random RAM flips are very relevant, better have redundant hardware.<br>
<p>
<font class="QuotedText">&gt; I know, at compile time, that my program will handle all error cases within a given subroutine. The subroutine is &quot;safe.&quot;</font><br>
<p>
Not sure how you plan to handle the &quot;power lost&quot; error condition, but I&#x27;d be interested :) .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861090"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 4:12 UTC (Sun)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/861090/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; `&amp;[u8]` might be fine, but if I mmap&#x27;d something like `&amp;[RawSpriteData]`, I think I&#x27;d *prefer* to crash because all-zeros isn&#x27;t very useful to me.</font><br>
<p>
You can have a safe mmap function that returns &amp;[u8]. Then you could use something like <a href="https://docs.rs/safe-transmute/0.11.2/safe_transmute">https://docs.rs/safe-transmute/0.11.2/safe_transmute</a> to transmute to a different kind of reference if that&#x27;s safe.<br>
<p>
You&#x27;re right that in extremes, safety gets a bit fuzzy. It&#x27;s nice to be able to push the boundaries pretty far out though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861090/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861112"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 17:17 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/861112/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t think it is semantically possible to avoid making a copy. The length of the mmap is equal to the length on disk, and because Linux went with the no-mandatory-file-locking model, that length can change at any time, regardless of whether you&#x27;re using Rust, C, or a magnetic needle and a steady hand. If you want to end up with a &quot;safe&quot; object, you need it to not get suddenly truncated/zero-filled while you&#x27;re halfway through processing it.<br>
<p>
Making a copy also resolves issues of the form &quot;What if someone decides to scribble all over the file without changing its length, while I&#x27;m halfway through processing it?&quot; More generally, this falls into the &quot;validate, then process&quot; model of doing things - you can&#x27;t validate something if it can change out from under you!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861112/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861155"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 2:50 UTC (Mon)
                               by <b>ilammy</b> (subscriber, #145312)
                              [<a href="/Articles/861155/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I wonder if some sort of copy-on-write private file mappings could help with that by avoiding copying the entire range (since mapped files tend to be huge). Like, you map a file a get a snapshot of its contents. Your process writing to that memory copies a page just for you and never syncs that page with the actual file. If any other process touches the file in any way via non-cow mapping or normal file ops, then the original data is copied and <em>other</em> process cow-mappings are dissociated from the file.
      
          <div class="CommentReplyButton">
            <form action="/Articles/861155/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2021 11:57 UTC (Wed)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/861360/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That looks like it would have been a much more generally useful (and expensive, complicated, etc) feature to implement than suppressing sigbus or zero-extending...<br>
<p>
Mmap snapshot (maybe with a read-only result if that would be much easier or cheaper to implement and still cover the use cases).<br>
<p>
But until someone offers to do that work...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861484"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2021 2:16 UTC (Thu)
                               by <b>ilammy</b> (subscriber, #145312)
                              [<a href="/Articles/861484/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
After doing some research, this idea is implemented in some systems as a MAP_COPY flag for mmap() [1]. That&#x27;s basically the semantics of MAP_PRIVATE mapping, but with a “snapshot” guarantee that the data won&#x27;t change, making your copy genuinely private, but avoiding the actual copy if the data does not change.<br>
<p>
While thinking of how this could be implemented, I realized that it could be quite expensive, complicated, and full of “spooky action at a distance”. If some process grabs or released a MAP_COPY mapping of a file, then all existing processes must be made aware of it (e.g., by turning all mappings for everyone RO and catching page faults). Any change by the other process forces said process to expend some kernel time doing the copy of the page for the benefit of some other process, which is not particularly fair.<br>
<p>
Turns out, adding MAP_COPY into Linux was discussed several times [2][3], but it&#x27;s still considered a pretty stupid idea.<br>
<p>
[1]: <a href="https://www.gnu.org/software/hurd/glibc/mmap.html">https://www.gnu.org/software/hurd/glibc/mmap.html</a><br>
[2]: <a href="https://yarchive.net/comp/linux/map_copy.html">https://yarchive.net/comp/linux/map_copy.html</a><br>
[3]: <a href="https://www.spinics.net/lists/linux-mm/msg119339.html">https://www.spinics.net/lists/linux-mm/msg119339.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861484/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor861052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 9:41 UTC (Sat)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/861052/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Finding zeroes in some pages is perfectly reasonably behaviour. After all, the file could have just contained zeroes there to start with. Rust safety only requires that &amp;[u8] reference a range of memory that doesn&#x27;t change and doesn&#x27;t cause a crash if you access it.<br>
<p>
If MAP_NOSIGBUS still triggers SIGBUS on I/O errors then I think it is misnamed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861078"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 18:02 UTC (Sat)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/861078/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Rust safety only requires that &amp;[u8] reference a range of memory that doesn&#x27;t change and doesn&#x27;t cause a crash if you access it.</font><br>
<p>
Consider the following sequence of events:<br>
1. Program A maps the file with MAP_PRIVATE | MAP_NOSIGBUS.<br>
2. Program A accesses page P from that file.<br>
3. Program B truncates the file to zero.<br>
4. Page P is evicted from RAM due to memory pressure.<br>
5. Program A accesses page P again.<br>
<p>
How is the resulting page fault handled? If a zero-filled page is mapped, then the contents of the range of memory does change silently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861078/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861091"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 4:14 UTC (Sun)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/861091/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s a good point.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861091/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor861107"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 14:24 UTC (Sun)
                               by <b>ocrete</b> (subscriber, #107180)
                              [<a href="/Articles/861107/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Isn&#x27;t the content of a memory range chaning silently always possible if another program is modifying the file?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861107/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861150"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 0:07 UTC (Mon)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/861150/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes (the man page says that behavior of MAP_PRIVATE is unspecified if the underlying file changes, but this is what happens on Linux in practice). The ftruncate()-based scenario is only somewhat interesting because it might seem like it only changes the file metadata, but in fact the data in the truncated tail also changes (as observed by mmap() users).<br>
<p>
To be clear, the same behavior within the last page of the file is already possible with current kernels: ftruncate() that doesn&#x27;t remove the last page completely will look like filling its remainder with zeros (though it&#x27;s also formally unspecified).<br>
<p>
So, overall, I don&#x27;t see how MAP_NOSIGBUS would help with unsafety of Rust&#x27;s &amp;[u8] referring to mmap()&#x27;ed range.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861150/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor861038"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 1:30 UTC (Sat)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/861038/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; something could truncate the backing file</font><br>
<p>
Why would an application sharing memory with the compositor call ftruncate()?   The article explains why NOSIGBUS solves a problem, but not why the problem arises in the first place.   What is the point of truncating the backing file?  Is the system writing the backing file hitting a quota, or is the swap space getting full?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861038/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 2:00 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/861039/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are several answers to that:<br>
<p>
- The operating system† should protect the user from incompetently-written software. Poorly written software should not cause any part of the operating system to crash.<br>
- Depending on your security model, the application may be considered untrusted, in which case it should not be allowed to bring down the compositor (as that would be a denial-of-service attack).<br>
- The application calling ftruncate might not even be the same application which created the file, if the latter leaves a directory entry lying around.<br>
<p>
† Outside of the FOSS world, the compositor is universally considered to be part of &quot;the operating system.&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor861046"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 7:29 UTC (Sat)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/861046/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agree. It seems like there might be an actual problem here, but this seems like a very ham-fisted way to address it.<br>
<p>
It seems like the compositor should be in full control of its file, and the client process should be physically unable to do anything with that file except write data into pages mapped from it. Then the client could mess up and crash itself, as is its privilege, but the compositor could not.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861046/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor861092"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 5:51 UTC (Sun)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/861092/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or the language could just do the right thing and install a signal handler and report the access failure as a language-specific exception or panic --- but the entire Linux ecosystem has been inexplicably reluctant to change or improve anything whatsoever relating to signals, so it&#x27;s very hard for a general-purpose library to use a signal handler in a way that doesn&#x27;t stomp over someone else&#x27;s desired use.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861092/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861114"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 19:35 UTC (Sun)
                               by <b>jayalane</b> (subscriber, #133964)
                              [<a href="/Articles/861114/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can’t change signal handling semantics much at all without breaking a ton of old stuff. Pretty sure Linus would not approve. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861114/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor861429"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2021 15:52 UTC (Wed)
                               by <b>miquels</b> (guest, #59247)
                              [<a href="/Articles/861429/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A process that panic()s or crashes on invalid memory accesses is inherently safe, isn&#x27;t it?<br>
<p>
The problem with Rust and mmap is that it just doesn&#x27;t work if you write from one thread or process and read from another - that&#x27;s instant UB (Undefined Behaviour) and that is _really_ unsafe.<br>
<p>
I think the only safe way to read from or write to mmap&#x27;ed memory in Rust is to use atomics - mmap it as AtomicU&lt;whatever&gt; and only read/write using the load/store operations on the atomic values.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861429/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861444"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2021 17:59 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/861444/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; A process that panic()s or crashes on invalid memory accesses is inherently safe, isn&#x27;t it?</font><br>
<p>
And if you&#x27;re in the aircraft where that software is controlling the plane&#x27;s fly-by-wire system ... ?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861444/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861445"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2021 18:03 UTC (Wed)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/861445/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve said this elsewhere, but &quot;safe&quot; is a lot like security: it depends on your environment (threat model in security). I don&#x27;t care much about cosmic rays flipping bits (in the &quot;I should consider this case&quot; sense) and count that as outside of the safety model of my code. NASA can&#x27;t work with such reckless abandon and have *far* higher concerns about such things. But languages don&#x27;t save you there: redundancy does.<br>
<p>
Aircraft have similarly high standards and I imagine the solution there is along the lines of rip out (or somehow poison) the `panic` function and let the linker tell you that you have a case that isn&#x27;t *explicitly* handled.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861445/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 7, 2021 6:48 UTC (Wed)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/861995/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, I imagine redundancy would be a better solution. Better to have the fly-by-wire fail over to a backup, then try to limp along in some weird state.<br>
<p>
Of course, time and again, cost-cutting works against that, and you have cars that share data buses between control systems &amp; the entertainment system :(<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor861050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 9:06 UTC (Sat)
                               by <b>Bigos</b> (subscriber, #96807)
                              [<a href="/Articles/861050/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I understand the premise that given &quot;bad applications&quot; the compositor authors want a mechanism to protect themselves from wrong client behavior that is set up solely by the compositor. It means less work on the whole ecosystem. But that just puts more custom logic into the kernel for no other reason than &quot;let the kernel deal with it&quot;.<br>
<p>
I thought Wayland was an extensible protocol that would allow one to fix such API mistakes and have clients and servers adopt the change gradually. However, nothing like that has been done for 7 years it seems. When can we expect Wayland successor that fixes this, then?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861061"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 11:00 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/861061/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I understand the premise that given &quot;bad applications&quot; the compositor authors want a mechanism to protect themselves from wrong client behavior that is set up solely by the compositor.</font><br>
<p>
Except it&#x27;s nothing to do with &quot;wrong client behaviour&quot;. You could be running a perfect client and then I log in on the same computer, truncate a file you&#x27;re using, and bring YOUR desktop crashing down because of what I&#x27;VE done.<br>
<p>
That&#x27;s a vulnerability to a malicious actor, and this is (presumably) intended to fix that vulnerability (not bug).<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861061/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861070"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 14:45 UTC (Sat)
                               by <b>Bigos</b> (subscriber, #96807)
                              [<a href="/Articles/861070/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I meant is to fix all legitimate applications (doing a change in mesa might solve the majority of it) and then eventually require sealed memfds instead of supporting the mechanism that is, as you mentioned, prone to abuse.<br>
<p>
However, it seems the ship has already sailed and no one wants to change the protocol to accommodate this safer way of passing buffers around. Which is sad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861070/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor861838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2021 8:54 UTC (Mon)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/861838/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m sure there are many ways to bring things down if you can arbitrarily truncate files I&#x27;m using.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor861068"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 14:08 UTC (Sat)
                               by <b>re:fi.64</b> (subscriber, #132628)
                              [<a href="/Articles/861068/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Afaik this isn&#x27;t really a solvable issue for any protocol without just not supporting sending these at all, which would be a performance hit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861068/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor861087"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2021 23:10 UTC (Sat)
                               by <b>ju3Ceemi</b> (subscriber, #102464)
                              [<a href="/Articles/861087/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why are they using a memory-baked file as shared memory ?<br>
Why not use shared memory as shared memory ?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861087/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 8:09 UTC (Sun)
                               by <b>randomguy3</b> (subscriber, #71063)
                              [<a href="/Articles/861096/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are you referring to MAP_SHARED + MAP_ANONYMOUS memory? As I understand it, you can only share such memory with your child processes.<br>
<p>
Or perhaps you mean using mem_fd? That possibility was mentioned in the article, which also notes &quot;no compositor requires the use of sealed memfds because there are clients that are unwilling or unable to use them&quot;.<br>
<p>
I am interested in the reasons behind this &quot;unable or unwilling&quot;, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861098"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 8:13 UTC (Sun)
                               by <b>randomguy3</b> (subscriber, #71063)
                              [<a href="/Articles/861098/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I went and looked up the link:

<blockquote>
The reason is that there will always exist clients which are either old
(and predate file sealing) or refuse to use Linux-only APIs (they don't
use memfd and file sealing, instead they use e.g. shm_open). Requiring
sealed memfds in compositors would break these clients.

<p>I don't believe the situation is about to change.

<p>Rather than requiring changes in all compositors *and* clients, can we
maybe only require changes in compositors? For instance, OpenBSD has a
__MAP_NOFAULT flag. When passed to mmap, it means that out-of-bound
accesses will read as zeroes instead of triggering SIGBUS. Such a flag
would be very helpful to unblock the annoying SIGBUS situation.</blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/861098/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 1:25 UTC (Mon)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/861154/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Create and open a file on tmpfs, in directory not accessible to anyone else.  mmap() it.  Pass the descriptor over SCM_RIGHTS datagram.  And unlink() the damn thing, to keep the clutter down.  Or use O_TMPFILE, for that matter, since that&#x27;s no more Linux-specific than new mmap flags would be.<br>
<p>
Sure, somebody malicious and controlling a process with your credentials will be able to screw you over, but then they could attach gdb to your client and have their merry way with it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861708"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 2, 2021 19:28 UTC (Fri)
                               by <b>daniels</b> (subscriber, #16193)
                              [<a href="/Articles/861708/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Create and open a file on tmpfs, in directory not accessible to anyone else. mmap() it. Pass the descriptor over SCM_RIGHTS datagram. And unlink() the damn thing, to keep the clutter down.</font><br>
<p>
That’s literally what we do, yeah.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861708/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor861103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 13:52 UTC (Sun)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/861103/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I would have thought about System V shared memory stuff (shmget and friends), and I was wondering about that myself when I read the article.  Not that I have experience with it, but it seems that it was made for this.  I now see that there is also POSIX shared memory (see man shm_overview), but it supports ftrucate(), so that probably does not help.
      
          <div class="CommentReplyButton">
            <form action="/Articles/861103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor861099"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 9:42 UTC (Sun)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/861099/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote><i>responded with an implementation of MAP_NOSIGBUS, which differs from __MAP_NOFAULT in a number of ways</i></blockquote>
<p>
I wonder why? Would it not be useful if *ix -style systems implemented similar extensions similarly? That would help porting and also they would probably eventually get standardized.

      
          <div class="CommentReplyButton">
            <form action="/Articles/861099/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor861104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 13:49 UTC (Sun)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/861104/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Having now thought about it for a while, this seems like a pretty bad approach to me.<br>
<p>
It seems to be targeted at exactly one use case (as others have mentioned).<br>
Further more it would actually only make the intended us case situation worse. Now clients can behave badly, and the compositor won&#x27;t even be able to notice. No longs, no disconnected the miss behaving client, just users with &quot;ugly windows&quot;, and they may not even know what program it was. Sounds like a nightmare to debug.<br>
<p>
Further more, for non RGB buffer layouts, I&#x27;m not even sure what that would end up looking like on the screen.<br>
<p>
Again having thought about it for a while, it seems a sane thing to do would be: handle the SIGBUS by noting where(address) it&#x27;s failing, and then mapping in a private page of all zero (or ones, or w/e) over the now invalid mapping. Then the compositor can log something like &quot;client XXXX has given malformed buffer&quot; or what ever. It can even take corrective action, like dropping the client connection (and thus implicitly destroying the bad display content), or maybe even popping up an error message for the user (depending on settings,use case ,etc).<br>
<p>
I don&#x27;t think papering over the problem (and then closing your eyes to it ever existing) is going to make better user experiences, or more stable software. However that seems to be the approach this patch series wants to take.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861108"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 14:46 UTC (Sun)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/861108/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Further more it would actually only make the intended us case situation worse. Now clients can behave badly, and the compositor won&#x27;t even be able to notice. No longs, no disconnected the miss behaving client, just users with &quot;ugly windows&quot;, </font><br>
<p>
This was always the case. If the client changes the contents of the buffer to garbage, the compositor will not notice and the window will display garbage. Nothing new here. The change is that the client truncating the buffer now will look exactly the same as the client clearing the buffer at an inappropriate time. <br>
<p>
<font class="QuotedText">&gt; and they may not even know what program it was. Sounds like a nightmare to debug.</font><br>
<p>
Probably the program whose window displays garbage. <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861108/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861160"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 8:35 UTC (Mon)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/861160/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  This was always the case. If the client changes the contents of the buffer to garbage, the compositor will not notice and the window will display garbage. Nothing new here. The change is that the client truncating the buffer now will look exactly the same as the client clearing the buffer at an inappropriate time. </font><br>
<p>
You appear to be conflating two very different issues here. It&#x27;s true the compositor has never really be able to tell if the client has been displaying garbage. However the source of SIGBUS is essentially a protocol error. The client has promised the compositor that there was buffer here, and instead there was a hand grande. SIGBUS always allowed the compositor to detect and handle such protocol violations. The proposed changes remove that ability (for the case of compositors that use it, so I guess it being &quot;opt-in&quot; is better than being &quot;opt-out&quot;).<br>
<p>
<p>
<font class="QuotedText">&gt; Probably the program whose window displays garbage. </font><br>
<p>
Except the compositor doesn&#x27;t know there&#x27;s even a problem, so it&#x27;s can&#x27;t say &quot;hey it&#x27;s connection XXX&quot;, or it registered with string &quot;YYY&quot;. Not all programs have server side decoration (and IIRC the wayland standard is client side decoration). So if the user wasn&#x27;t looking at that window, or doesn&#x27;t remember which one it is (or never new in the case of dialogs, and a few other things), then it becomes difficult to figure out. If the window is on a &quot;task list&quot; like WM UI element, that might help, but not all windows are placed there.<br>
<p>
It&#x27;s probably not impossible, but it surely wouldn&#x27;t be easy.<br>
<p>
<p>
To sum it up (again):  The approach here appears to be &quot;make it work &#x27;safely&#x27; by sweeping all the problems under the rug&quot;. I don&#x27;t think that&#x27;s a good long term solution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861160/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861171"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 13:18 UTC (Mon)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/861171/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Isn&#x27;t the real problem here the use of signal? The compositor is just doing a memory lookup, at assembly level there is no such thing as a &quot;failed read&quot;. The kernel can generate a signal but it can&#x27;t fail the original instruction, the MOV has to return something. The compositor would have to do a siglongjmp() because otherwise it&#x27;s going to generate a SIGBUS for every single instruction accessing the missing pages. And siglongjmp() is pretty tricky at the best of times.<br>
<p>
I can understand that developers would prefer if the kernel would just return zeros and the compositor recheck the size of the file after the copy completes. It&#x27;s just less moving parts that way.<br>
<p>
Someone else here noted userfaultfd() is doing something similar, so maybe there&#x27;s an answer there. The compositor thread would be blocked and the handler could remap the pages to avoid the SIGBUS retriggerring.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861171/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861200"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 14:52 UTC (Mon)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/861200/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Isn&#x27;t the real problem here the use of signal? The compositor is just doing a memory lookup, at assembly level there is no such thing as a &quot;failed read&quot;. </font><br>
<p>
As I said in my original post: I&#x27;m pretty sure the compositors SIGBUS handler could mmap over the faulting region, and then set a flag that the given client is miss behaving.<br>
<p>
When the compositor returns from the signal handler, it would finish it&#x27;s turn function/call stack (using the newly mmaped region... possibly zero filled, possibly full of kitten pictures.), eventually get high enough to notice that that connection had been marked as bad, then either discard the processing it had done, or perhaps show one frame with a garbage window.<br>
<p>
That way you resume from the error AND get notification of the buggy/malicious client. And you can have meaningful error messages.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861200/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 17:29 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/861232/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; As I said in my original post: I&#x27;m pretty sure the compositors SIGBUS handler could mmap over the faulting region, and then set a flag that the given client is miss behaving.</font><br>
<p>
signal-safety(7) does not list mmap as async-signal-safe, at least on my system. But that just means that POSIX doesn&#x27;t require it to be safe. I suppose it&#x27;s possible that Linux does implement an async-signal-safe mmap as an extension?<br>
<p>
(Unfortunately, we can&#x27;t just use the usual trick of &quot;set a flag and return, then do the real work from the main event loop&quot; because we need to fix the memory problem *before* we return from the SIGBUS handler, or else we&#x27;d need to pause the offending thread, call mmap from a different thread, etc.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor861243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 18:54 UTC (Mon)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/861243/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would not imagine &quot;mmap&quot; could ever be fully async-signal-safe (after all you are screwing with the page table). However for the every narrow case of replacing a no-longer valid mapping, it should be fine.<br>
<p>
Seeing as mmap is typically a thin wrapper around a syscall (AFAIK there is no currently known way for this to not be a kernel task) most of this must naturally be done in kernel, which negates most of the issues.<br>
<p>
However since you brought it up, I&#x27;m assuming you are implying being portable/standards conformant is important. So for that we would need a change of standards. But that&#x27;s probably more of a &#x27;paper&#x27; change (while it&#x27;s possible some implementations that are posix.1 2008 compliant implement mmap(2) in a way that would be unsafe for this proposed usage, I kind of doubt it).<br>
<p>
A linux-only change, that just papers over the issue seems like a poor solution.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor861199"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2021 14:53 UTC (Mon)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/861199/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The compositor is just doing a memory lookup, at assembly level there is no such thing as a &quot;failed read&quot;. The kernel can generate a signal but it can&#x27;t fail the original instruction, the MOV has to return something.</font><br>
<p>
I don&#x27;t think that&#x27;s really true. At the assembly level, the outcome of the MOV instruction is that it either loads a value into the register *or* triggers an exception. E.g. if you look in the ARMv8-A Architecture Reference Manual, it explicitly defines the LDR instruction in terms of the &quot;AArch64.MemSingle&quot; operation which can call the &quot;AArch64.TakeException&quot; operation, which sets up the exception state then calls &quot;EndOfInstruction&quot; to stop any further processing of the LDR instruction, so it won&#x27;t write anything to the destination register.<br>
<p>
Once the exception is triggered, the kernel is free to do whatever it wants - update the page tables then jump back to the MOV instruction to retry it, manually update the register state then jump back to the instruction after the MOV, call a signal handler, etc. Anyone writing user-space assembly code has to be aware of that, e.g. there are often ABI rules about stack pointers that are specifically there to allow the kernel to interrupt your thread at any point and run a signal handler on its current stack. So that&#x27;s not something you can safely ignore when working at assembly level.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861199/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor861267"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 29, 2021 10:34 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/861267/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You appear to be conflating two very different issues here. It&#x27;s true the compositor has never really be able to tell if the client has been displaying garbage. However the source of SIGBUS is essentially a protocol error. The client has promised the compositor that there was buffer here, and instead there was a hand grande. SIGBUS always allowed the compositor to detect and handle such protocol violations. </font><br>
<p>
The client has promised that there is a buffer that does not change while the compositor is using it. Any change would be a protocol error. Only in the very special case that the change is truncate, this protocol error could be detected by the compositor. With the proposed change of semantics, this special case just looks like other cases where the client changes the buffer at the wrong time.<br>
<p>
<font class="QuotedText">&gt; [Finding out which program displays garbage] is probably not impossible, but it surely wouldn&#x27;t be easy.</font><br>
<p>
For debugging purposes there should be a possibility to ask the compositor to which program some window belongs. After all, you also want to debug cases where a program just opens a window with garbage in it. Probably a much more common case than a program calling truncate on the buffer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861267/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor861133"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Suppressing SIGBUS signals</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2021 20:11 UTC (Sun)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/861133/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It occurs to me that one way to address the original problem with SIGBUS is to wire up userfaultfd to the mapping somehow. Then the compositor could arrange for the zero substitution --- or any other policy --- on its own without hard-coding zero-fill policy into the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861133/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
