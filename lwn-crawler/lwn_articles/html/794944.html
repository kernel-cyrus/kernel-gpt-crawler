        <!DOCTYPE html>
        <html lang="en">
        <head><title>An end to implicit fall-throughs in the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/794944/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/795102/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/794944/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>An end to implicit fall-throughs in the kernel</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 1, 2019</br>
           </div>
The C <tt>switch</tt> statement has, since the beginning of the language,
required the use of explicit <tt>break</tt> statements to prevent execution
from falling through from one <tt>case</tt> to the next.  This behavior can
be a useful feature, allowing for more compact code, but it can also lead
to bugs.  The effort to rid the kernel of implicit fall-through coding
patterns came to a conclusion with the 5.3-rc2 release, where
the last cases were fixed.  There is a good chance that these fixes will
have to be redone in the future, though.
<p>
The problem with C's fall-through behavior is that it is implicit, with no
indication of whether the behavior is intended or not.  Developers learn
(the hard way, sometimes) to
end each case with a <tt>break</tt> statement as a matter of habit, but
it's still an easy thing to forget, and the resulting code is seen by the
compiler as being entirely valid.  A forgotten <tt>break</tt> almost
certainly introduces a bug, even if it might not manifest itself for years.
Many 
developers have had reason to wish that the C language required an explicit
indication by the programmer that fall-through behavior is desired.
<p>
<h4>Making fall-through behavior explicit</h4>
<p>
The GCC compiler has, for some time, offered a warning option
(<tt>-Wimplicit-fallthrough</tt>) intended to catch missing <tt>break</tt>
statements.  It will trigger for any <tt>case</tt> that falls through into
a succeeding <tt>case</tt> unless an explicit marker has been placed to
indicate that the behavior is correct.  It turns out that that there are
many ways of placing this marker, depending on the value provided with
<tt>-Wimplicit-fallthrough</tt>; the full set can be found in <a
href="https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wimplicit-fallthrough">the
GCC documentation</a>.  At its most lax, the presence of any
comment at all prior to a <tt>case</tt> statement will allow warning-free
fall-through into that case.  Using <tt>-Wimplicit-fallthrough=3</tt>
causes the compiler to look for comments matching a fairly large set of
regular expressions.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
In the kernel, one is most likely to find comments
that look like:
<p>
<blockquote>
<table class="OddEven">
<tr><th>Style</th><th>Count</th></tr>
<tr><td><tt>/* fallthrough */</tt></td><td align="right">350</td></tr>
<tr><td><tt>/* fall through */</tt></td><td align="right">3,091</td></tr>
<tr><td><tt>/* falls through */</tt></td><td align="right">8</td></tr>
<tr><td><tt>/* fall-through */</tt></td><td align="right">167</td></tr>
</table>
</blockquote>
<p>
Note that case was ignored in generating the above numbers, and that there are
probably other variants in the code as well.
All of those comment styles will be recognized by GCC with
<tt>-Wimplicit-fallthrough=3</tt> and will thus cause warnings to be suppressed.
<p>
As can be seen, there are a lot of these comments in the kernel source now,
some of which 
date back to before the beginning of the Git era.  Their number has
increased in recent times, though, due mostly to a focused effort by
Gustavo A. R. Silva, who has been working to eliminate every implicit
fall-through warning in the kernel.  The point of this effort, beyond
fixing any bugs caused by missing <tt>break</tt> statements, is to make it
possible to enable <tt>-Wimplicit-fallthrough=3</tt> in the kernel build by
default.  As long as that option generates a pile of warnings, developers
will ignore them and nobody will notice when new ones are added.  Once the
kernel is warning-free, though, it should be possible to keep it that way.
<p>
This work, which was supported by the Linux Foundation, has resulted in
over 400 patches since 2017.   
As Silva has worked through the kernel source eliminating fall-through
warnings, he has encountered (and fixed) a number of bugs.  A quick search
turns up the following commits, for example:
<p>
<blockquote>
<table class="OddEven">

<tr><td><a href="https://git.kernel.org/linus/d64062b57eeb"><tt>d64062b57eeb</tt></a></td><td>drm/amdgpu/gfx10: Fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/737298d18836"><tt>737298d18836</tt></a></td><td>drm/amdkfd: Fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/60747828eac2"><tt>60747828eac2</tt></a></td><td>net: socket: Fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/84242b82d81c"><tt>84242b82d81c</tt></a></td><td>rtlwifi: rtl8723ae: Fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/7850b51b6c21"><tt>7850b51b6c21</tt></a></td><td>scsi: mpt3sas: Add missing breaks in switch statements</td></tr>
<tr><td><a href="https://git.kernel.org/linus/5e420fe63581"><tt>5e420fe63581</tt></a></td><td>scsi: aacraid: Fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/09186e503486"><tt>09186e503486</tt></a></td><td>security: mark expected switch fall-throughs and add a missing break</td></tr>
<tr><td><a href="https://git.kernel.org/linus/b5be853181a8"><tt>b5be853181a8</tt></a></td><td>crypto: ccree - fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/7264235ee74f"><tt>7264235ee74f</tt></a></td><td>IB/hfi1: Add missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/cc5034a5d293"><tt>cc5034a5d293</tt></a></td><td>drm/radeon/evergreen_cs: fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/479826cc8611"><tt>479826cc8611</tt></a></td><td>staging: comedi: ni_660x: fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/5340f23df8fe"><tt>5340f23df8fe</tt></a></td><td>gpio: sprd: Add missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/df997abeebad"><tt>df997abeebad</tt></a></td><td>iscsi_ibft: Fix missing break in switch statement</td></tr>
<tr><td><a href="https://git.kernel.org/linus/2f10d8237396"><tt>2f10d8237396</tt></a></td><td>drm/amd/powerplay: Fix missing break in switch</td></tr>
<tr><td><a href="https://git.kernel.org/linus/307b00c5e695"><tt>307b00c5e695</tt></a></td><td>rtl8xxxu: Fix missing break in switch</td></tr>
<tr><td><a href="https://git.kernel.org/linus/5d25ff7a5448"><tt>5d25ff7a5448</tt></a></td><td>scsi: ips: fix missing break in switch</td></tr>
<tr><td><a href="https://git.kernel.org/linus/a7ed5b3e7dca"><tt>a7ed5b3e7dca</tt></a></td><td>staging: comedi: tio: fix multiple missing break in switch bugs</td></tr>
<tr><td><a href="https://git.kernel.org/linus/c24bfa8f21b5"><tt>c24bfa8f21b5</tt></a></td><td>spi: slave: Fix missing break in switch</td></tr>
<tr><td><a href="https://git.kernel.org/linus/ad0eaee6195d"><tt>ad0eaee6195d</tt></a></td><td>ASoC: wm8994: Fix missing break in switch</td></tr>
<tr><td><a href="https://git.kernel.org/linus/9ba8376ce1e2"><tt>9ba8376ce1e2</tt></a></td><td>ptp: fix missing break in switch</td></tr>
<tr><td><a
href="https://git.kernel.org/linus/4e57562b4846"><tt>4e57562b4846</tt></a></td><td>iio:
imu: inv_mpu6050: fix missing break in switch</td></tr>
</table>
</blockquote>
<p>
The above list is clearly incomplete, though, since a number of the other
fixes do not explicitly mention missing <tt>break</tt> statements in the
subject line; see <a
href="https://git.kernel.org/linus/ed4ed4043a12">commit
<tt>ed4ed4043a12</tt></a>, for example.
<p>
On July 27, a milestone of sorts was hit with <a
href="https://git.kernel.org/linus/88c508344245">this pull</a> into the
mainline from Silva's repository: the final implicit fall-through warning
has been fixed, and <tt>-Wimplicit-fallthrough=3</tt> <a
href="https://git.kernel.org/linus/a035d552a93b">is now the default</a> for
kernel builds.  In other words, the kernel's coding style has just been
tweaked to disallow the use of implicit fall-through in <tt>switch</tt>
statements.  It must be a satisfying conclusion to a long project.
<p>
<h4>Moving beyond comments</h4>
<p>
Naturally, though, some developers are not entirely happy with this
change.  Nobody who actually works in the kernel community seems to
disagree with the idea of eliminating implicit fall-throughs, but the
mechanism used to do so does not sit well with everybody; as Peter Zijlstra <a
href="/ml/linux-kernel/20190624193123.GI3436@hirez.programming.kicks-ass.net/">put
it</a> back in June: "<q>I still consider it an abomination that the C
parser looks at comments</q>".  Zijlstra, like others, would prefer that
there were another way.
<p>
As it happens, there <i>is</i> another way.  GCC starting with version 7 allows
the use of a special attribute on a statement instead:
<p>
<pre>
    __attribute__((fallthrough))
</pre>
<p>
The use of this attribute can perhaps made more visually pleasing with a
definition like:
<p>
<pre>
    #define __fallthrough __attribute__((fallthrough))
</pre>
<p>
The <tt>__fallthrough</tt> symbol could then be used instead of the magic
comments to eliminate implicit fall-through warnings.  A <a
href="/ml/linux-kernel/20181021171414.22674-1-miguel.ojeda.sandonis@gmail.com/">patch
set</a> implementing this option was posted by Miguel Ojeda in October
2018; it generated a fair amount of interest but was not adopted for a
couple of reasons: it doesn't work with older versions of GCC, and the LLVM
Clang compiler does not implement that attribute at all.  Since Clang does
successfully build the kernel in some settings (and is evidently used for
the Android build), breaking it is not an appealing option.
<p>
The good news is that the Clang developers appear to be working on
implementing this attribute.  They also, it seems, have an implementation
aimed at the proposed next standard for the C language, currently called C2X.
The bad news is that the syntax there is different:
<p>
<pre>
    [[fallthrough]]
</pre>
<p>
If this version becomes an actual part of the C standard, it would probably
be the preferable one to use going forward.  But that may not be fully
resolved for some time.  In any case, the actual mechanism used to mark
explicit fall-through behavior can be hidden behind a <tt>#define</tt> as
shown above.
<p>
The one thing that <i>can't</i> be done is:
<p>
<pre>
    #define __fallthrough /* fall through */
</pre>
<p>
since the preprocessor will simply delete the comment rather than
substituting it into the source.  So the comments have to remain for now.
But one can imagine that, at some point in the future when a better
alternative is available, those thousands of comments are likely to be
replaced with something like <tt>__fallthrough</tt> in a set of massive,
tree-wide patches. 
<p>
Meanwhile, though, the kernel has finally reached a point where there are
no <tt>switch</tt> statements with implicit fall-through behavior, and the
build process has been amended to prevent such behavior from being added in
the future.  One source of kernel bugs has been closed, a switch that can
only be seen as a best-case scenario.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Coding_style">Coding style</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Kernel_hardening">Security/Kernel hardening</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Hardening">Linux kernel/Hardening</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/794944/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor795137"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&gt; Miguel Ojeda</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 2:16 UTC (Fri)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/795137/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Numerous people (including me) posted patches avoiding these magic comments. I am the maintainer of distcc, and use of magic comments makes distcc (which compiles the prepossessed files that lack comments) very noisy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795137/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795161"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distcc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 10:30 UTC (Fri)
                               by <b>jani</b> (subscriber, #74547)
                              [<a href="/Articles/795161/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; use of magic comments makes distcc (which compiles the prepossessed files that lack comments) very noisy.</font><br>
<p>
Care to elaborate?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795161/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795162"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distcc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 10:38 UTC (Fri)
                               by <b>mageta</b> (subscriber, #89696)
                              [<a href="/Articles/795162/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I imagine it stems from the fact that distcc sends already pre-processed files to the "compute"-nodes (it does this so the compute-nodes don't need any of the include files and such, so they just need to do the compile-step, which should be free of any "side-effects"). As such they have all comments stripped from them, but the compiler flags are still passed to the compiler running on the compute-node, and because they don't see the comments, they will complain about the missing comments.<br>
<p>
Similar things can happen with other certain diagnostics that rely on seeing un-expanded macros (e.g.: -Wtautological-compare). They will complain, because Macros are already expanded in the files sent to the compute-node.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795162/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795172"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distcc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 12:55 UTC (Fri)
                               by <b>mageta</b> (subscriber, #89696)
                              [<a href="/Articles/795172/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I forgot, one can suppress the major grunt of these warnings by passing additional CFLAGs into the KBuild system.<br>
<p>
When building with distcc, I have been passing 'KCFLAGS=-Wno-tautological-compare' for a while now. This suppresses 95% of the complaints, but not every compiler-call honors KCFLAGS.. and I have been too lazy to track down why that is, its probably a bug.<br>
<p>
I imagine one can work around the new warnings from the fall-through diagnostics in a similar way! Have not tested it yet though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795172/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795239"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distcc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 18:20 UTC (Fri)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/795239/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is great to know. I will consider adding this by default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795239/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor795175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&gt; Miguel Ojeda</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 13:44 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/795175/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is `-fdirectives-only` not sufficient? That would end up handling `#include`, and `#if`-like directives (`#define` is handled, but left in the output), leaving macro use in the code itself as-is. I guess the comments still end up being stripped though…but this could help the tautological-compare warnings at least.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor795142"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 6:01 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/795142/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  and that there are probably other variants in the code as well.</font><br>
<p>
Indeed ...  including 3  "fall though"  ( one "fallthough" was recently removed) 14 "Intentional fallthrough" and 10 "lint -fallthrough".<br>
<p>
And in case the compiler is a bit deaf,<br>
                        /* !!!!!!!!! Fall Through !!!!!!!!!!!!! */<br>
<p>
Archeology is fun!<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795142/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor795158"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 9:36 UTC (Fri)
                               by <b>domo</b> (guest, #14031)
                              [<a href="/Articles/795158/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thosr /*fallthru*/ comments nevet worked for me, probably since c preprocesdor filtered those out before compiler could see those...<br>
<p>
... So i've been wondering how it is possible  it is documented and so on...<br>
<p>
i've used #if GNUC &gt;= 7 for __attribute__ define and empty define #else.<br>
<p>
the hardest thing there has been the #define name.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795158/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor795159"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 10:11 UTC (Fri)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/795159/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In my experience,<br>
<p>
/* fall through */ <br>
<p>
is OK, but <br>
<p>
/* no break */<br>
<p>
is superior (from the perspective of a non-native English speaker).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795159/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 13:04 UTC (Fri)
                               by <b>Freeaqingme</b> (subscriber, #103259)
                              [<a href="/Articles/795173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nonnative speaker reporting in as well. I think programming syntax doesn't have to be 1:1 good English. The brain uses separate 'linguistic registers' for programming languages. So even though a programming language uses primarily English terms, the brain will typically regard them as their own language (or dialect, so you wish) when looking at some code.<br>
<p>
So for all intents and purposes they could call it 'foobar', and you'd simply learn what 'foobar' means in this context. Furthermore, I think it's a good practice to actually describe the behavior by what it does, not by what it doesn't do. <br>
<p>
As a fun anecdote, the PHP language for a very long time had a T_PAAMAYIM_NEKUDOTAYIM token ('::'). Even though PHP uses primarily English terms, it was written by two Israeli men, who felt it was nice to put something of their own culture/heritage in the language. Undoubtedly it's a bit weird for an English programmer to get an error message 'unexpected T_PAAMAYIM_NEKUDOTAYIM', but after you Google it the first time you simply remember that you probably put some '::' somewhere where the interpreter did not expect it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor795252"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 21:35 UTC (Fri)
                               by <b>edeloget</b> (subscriber, #88392)
                              [<a href="/Articles/795252/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
/* fall through */ tells what the code is expected to do (i.e. it documents the intention), while /*no break */ is just telling how it's written. The latter could have been added by someone who was surprised that there were no break, and might be a hasitly and lazily written question :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795252/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795323"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 10:19 UTC (Mon)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/795323/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My intention is always to write code that does not break. Sincerely, I hate code that falls throught.<br>
<p>
;-P<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795323/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor795170"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 12:21 UTC (Fri)
                               by <b>mtthu</b> (subscriber, #123091)
                              [<a href="/Articles/795170/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The somewhat strange looking syntax for the attribute [[fallthrough]] (at least to me it looks a bit strange) seems to be in line with the C++17 standard. Even though I don't really like the double square brackets for the look, the alignment of the C and C++ standards is very desirable to me (and I expect not only to me). I don't think that the C and C++ standards will diverge in this matter. The introduction of the [[fallthrough]] notation in the upcoming C standards seems very likely to me.<br>
<p>
BTW: In C++17 two other attributes have been added as well: [[maybe_unused]] and [[nodiscard]]; C++20 adds [[likely]] and [[unlikely]]. Some might be useful in C as well, some not.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795170/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2019 12:04 UTC (Sat)
                               by <b>danieljo</b> (guest, #6161)
                              [<a href="/Articles/795872/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      One annoying thing about then [[fallthrouh]] syntax is that it would still need to be hidden behind something like

<pre>
#if COMPILER_SUPPORT
# define __fallthrough  [[fallthrough]]
#else
# define __fallthrough /*something else*/
#endif
</pre>
since the following is not valid C and a "raw" [[fallthrough]] is difficult to hide from older compilers.
<pre>
#if NO_SUPPORT
# define [[fallthrough]] /*something else*/
#endif
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/795872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795876"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2019 13:31 UTC (Sat)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/795876/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
# define __fallthrough /*something else*/<br>
<p>
doesn't work one though - the preprocessor will remove the comment, rather than place it<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795876/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795891"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2019 1:03 UTC (Sun)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/795891/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Since GCC 7 there is a GCC attribute you could use in place of the comment:</p>

<pre>#if !defined(__fallthrough) &amp;&amp; defined(__has_cpp_attribute)
  #if __has_cpp_attribute(fallthrough)
    #define __fallthrough [[fallthrough]]
  #elif __has_cpp_attribute(gnu::fallthrough)
    #define __fallthrough [[gnu::fallthrough]]
  #endif
#endif

#if !defined(__fallthrough) &amp;&amp; defined(__has_attribute)
  #if __has_attribute(__fallthrough__)
    #define __fallthrough __attribute__((__fallthrough__))
  #endif
#endif

#if !defined(__fallthrough) /* well, we tried */
  #define __fallthrough ((void)0)
#endif</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/795891/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor805136"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 19, 2019 15:26 UTC (Tue)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/805136/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a way to say that _all_ the cases in a given switch fall through ? This is very common and<br>
adding 'fall through' at each line instead of once is counterproductive.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/805136/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor805303"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 21, 2019 16:04 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/805303/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; very common</font><br>
<p>
Do you have an example to show? Other than Duff's device (which I also wouldn't classify as "very common" since it's a stereotypical "what's this weird piece of C doing" snippet), what's the use case?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/805303/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor805453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 24, 2019 22:06 UTC (Sun)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/805453/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Handling a data structure with variable length.<br>
switch (strlen(s)-1)<br>
{<br>
case 3: a[3] = cvt3(s[3]);<br>
case 2: a[2] = cvt2(s[2]);<br>
case 1: a[1] = cvt1(s[1]);<br>
case 0: a[0] = cvt0(s[0]);<br>
}<br>
or<br>
switch(a.dim)<br>
{<br>
case 4: checkt(a.t);<br>
case 3: checkz(a.z);<br>
case 2: checky(a.y);<br>
case 1: checkx(a.x);<br>
}<br>
<p>
finishing after a loop unrolling<br>
<p>
for(i=l;i&gt;=3;i-=4)<br>
{ f(i); f(i-1);f(i-2);f(i-3);}<br>
switch(i)<br>
{<br>
case 3: f(3);<br>
case 2: f(2);<br>
case 1: f(1);<br>
case 0: f(0);<br>
} <br>
<p>
conversion<br>
switch(type(z))<br>
{<br>
   case FOO: z = FOO_to_BAR(z);<br>
   case BAR: z = BAR_to_BAZ(z);<br>
   case BAZ: return process_BAZ(z);<br>
}<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/805453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor805540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2019 16:35 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/805540/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Handling a data structure with variable length.</font><br>
<p>
The first seems like abusing a C string for data storage. A better data structure seems relevant here. It would certainly make the code clearer.<br>
<p>
<font class="QuotedText">&gt; a.dim</font><br>
<p>
I feel like this would be wrapped up better in a `checkvec` function in the first place. Though this is C; why is one abusing a vec4 to store vec3 or vec2 information (losing cache line benefits given the usual suspects for code using such structures).<br>
<p>
<font class="QuotedText">&gt; loop unrolling</font><br>
<p>
Something I expect the compiler to be better at today than myself (pending benchmarks showing that the vectorization/unrolling isn't happening).<br>
<p>
<font class="QuotedText">&gt; conversion</font><br>
<p>
Well, this is what you get with crappy type hierarchies :) . I think the normal way would be something like:<br>
<p>
baz* p = NULL;<br>
switch(type(z)) // Assuming `z` is some kind of tagged union structure.<br>
{<br>
case FOO: p = &amp;z-&gt;foo.baz; break;<br>
case BAR: p = &amp;z-&gt;bar.baz; break;<br>
case BAZ: p = &amp;z-&gt;baz;<br>
}<br>
if (p) process_BAZ(p);<br>
<p>
These are interesting use cases, but I still wouldn't classify them as "common" or even idiomatic.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/805540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor795270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2019 9:06 UTC (Sat)
                               by <b>swilmet</b> (guest, #98424)
                              [<a href="/Articles/795270/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
An independent thing that makes a missing break more visible in the code, is to add an empty line after each break, to space out cases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor795296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 4, 2019 20:38 UTC (Sun)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/795296/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is no such thing as "implicit fallthrough": A C switch statement causes execution to continue at a certain label depending on the value of the controlling expression. It's basically a specific form of a computed goto and the case-labels are nothing but labels. In absence of explicit control-flow affecting statements, execution continues sequentially after a goto because execution always continues sequentially unless this is changed.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795303"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 4, 2019 21:10 UTC (Sun)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/795303/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is that Sancho Panza standing behind you, by any chance? :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795303/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795332"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 14:16 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/795332/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Try reading the C language definition. The relevant part would seem to be

<blockquote>
A switch statement causes control to jump to, into, or past the statement that is the
switch body, depending on the value of a controlling expression, and on the presence of a
default label and the values of any case labels on or in the switch body. A case or
default label is accessible only within the closest enclosing switch statement.
</blockquote>

It's just nonsense to refer to the sequential execution of sequence of statemens as "implicit fallthrough" when thinking of C control structures. 

      
          <div class="CommentReplyButton">
            <form action="/Articles/795332/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795351"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 14:53 UTC (Mon)
                               by <b>karkhaz</b> (subscriber, #99844)
                              [<a href="/Articles/795351/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nobody learns C by reading the standard. People instead use the same mental model for switch statements that they do for if statements, i.e., they are two different ways of writing a conditional expression.<br>
<p>
Since you only ever take (at most) one branch of an if statement, it makes sense that programmers expect the same behaviour from the cases of a switch statement. Unlearning this mental model is difficult because people rarely use goto statements and commonly use if statements. So for most people, switch statements are a syntactic sugar for if statements (removing the need to explicitly test the value of the expression for each branch), rather than being sugar for goto statements.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795351/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795353"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 15:50 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/795353/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I would suspect assumptions based on how multiway conditionals work in other languages, eg, Pascal or the Bourne shell language, here.  Such a construct can be emulated in C by combining switch and break but it doesn't have one. OTOH, a C switch can be used to do things which can't be done with a multiway conditional, eg,

<pre>
switch ((uintptr_t)p &amp; 3) {
case 3:
    *p++ = c;

case 2:
    *p++ = c;

case 1:
    *p++ = c;
}
</pre>

to align a pointer while storing some values (I'm aware that this is not standardized C).

One could argue that such cases are rare and that a proper multiway conditional had been a better idea.
      
          <div class="CommentReplyButton">
            <form action="/Articles/795353/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795383"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 18:40 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/795383/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The pseudo-C-example has the case 3 and case 1 cases inverted :-). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795383/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor795683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 8, 2019 3:03 UTC (Thu)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/795683/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In C (not the generated assembly, which isn’t the same thing) a switch statement isn’t *just* a series of jumps.  What’s the “break” for if it’s just a set of gotos?  It’s a *switch* or *case* statement, and it does indeed have fall through from one condition to the next.  It gets to conditions using labels in a manner basically the same as goto, but that’s an implementation detail.  Switch/case have a higher level meaning, independent of the generated assembly or the use of labels.<br>
<p>
What behavior would constitute “fall through” in your view?  Fall through simply means proceeding from one case to the next instead of breaking out.  C does so unless told otherwise, so it’s implicit.  The fact that the generated assembly is just a set of jumps to labels has no bearing on this higher level language observation, which is comparing C to other languages on the behavior of the switch statement.<br>
<p>
Basically you’re saying C doesn’t have fall through at all, because a switch statement is just a set of gotos so we should stop talking about this.  That’s certainly *a* perspective.  It’s not an interesting or useful one and those of us who want to have a name for this behavior that refers to the higher level language are just going to keep talking about falling through cases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor795362"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 16:45 UTC (Mon)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/795362/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you consider switch to be essentially goto, jumping into the middle of a sequence of statements, then "Go To Statement Considered Harmful" seems relevant. Dijkstra said "we should do (as wise programmers aware of our limitations) our utmost to shorten the conceptual gap between the static program and the dynamic process, to make the correspondence between the program (spread out in text space) and the process (spread out in time) as trivial as possible."<br>
<p>
The conceptual gap here is between the switch being a set of mutually exclusive cases (which is how they're typically used, and how they're typically formatted with indentation and braces and blank lines), vs it being a sequence of statements with jumps (which is how it's implemented). After some decades of experience with C, observing all the bugs caused by missing breaks, people have got wise enough to recognise their limitations and are changing the language to reduce that gap.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795362/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795390"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 21:46 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/795390/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suggest you read Dijkstras text. This is more sensible than quoting soundbites wildly out of context. <br>
<p>
A switch is a form of computed goto because that's what the language definition says. A "conceptual gap" only manifests itself here if people (wrongly) regard it as something different. <br>
<p>
It can't really determine when this feature was implemented but judging from code I've seen, I think lint must have supported flagging absence of break in switch statements since some time in the 1980s and by then, it certainly wasn't based on "decades of experience", probably more on some kind of "This new and different! It must be terribly wrong!!" knee-jerk reaction from people used to something else.<br>
<p>
Had Linux not managed fine without this feature for almost three decades, Google employees wouldn't be paid to retrofit it to a large code base.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795390/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795393"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2019 22:04 UTC (Mon)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/795393/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It hadn't managed fine. The analysis caught multiple real bugs. Whatever your conceptual objections to this work, it makes a certain category of failure much less likely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795393/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795509"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 6, 2019 16:55 UTC (Tue)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/795509/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For my definition of "managed fine", it had: I've been using Linux for a long time in all kinds of private and professional settings and I was never forced to fix a bug caused by a missing break. The same will be true for a few millions of other people, otherwise, I wouldn't be writing this here using the software I'm using to write this.<br>
<p>
Some analysis of the commits also supports this: The person who worked on this produced 415 commits relating to it. 392 were about adding comments to correct switches. 23 about adding missing breaks. This means that 94.45% of the commits didn't fix anything while 5.54% were bugfixes, presumably mostly to more or less dead code handling corner cases which never happen in practice as  the missing breaks would have caused runtime failures otherwise. This gets even more interesting when looking at the number of switch-cases in the kernel code: There are 265,383 of them. Which means that 0.15% didn't have a break and in 0.009% of the cases, this turned out to be wrong. Applying the usual statistican's sleight-of-hand, IOW, assuming that relative frequencies in a particilar statistic are the same as probabilities of a certain outcome in a random selection, one can thus confidently state that "empirical evidence suggests that switch cases are used incorrectly 0.009% of the time!"<br>
<p>
That's not my idea of "a serious problem" and even if this was different, I wouldn't consider "make switch harder to use" a sensible solution to it. YMMV.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795509/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor796299"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2019 10:18 UTC (Thu)
                               by <b>ksandstr</b> (guest, #60862)
                              [<a href="/Articles/796299/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Furthermore, often switch-case is used to have multiple values land execution at the same statement. The syntax for this, i.e. consecutive case labels with no statements in between, is indistinguishable from unannounced fall-through.<br>
<p>
The underlying problem here is that switch-case is, with seeming regularity, learned as "what C has for select-case in Visual Basic". That, like many common assumptions regarding C-family languages, is very wrong.<br>
<p>
Thirdly, the compiler-oriented solution implies that review will actually compile submitted code and has both care and cojones to require warnings fixed. If that's the case, nice; but I'm not even convinced that any of these "fix fallthru warning" patches' cases were hit in a specific test first to determine that fallthru is actually the correct behaviour. Done wrong, that could be worse than changing nothing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/796299/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor796347"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2019 17:34 UTC (Thu)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/796347/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; consecutive case labels with no statements in between, is indistinguishable from unannounced fall-through.</font><br>
<p>
It seems to me that "this case label has no statements between it and the next case label" is fairly readily distinguishable from "this case label has statements between it and the next case label, but those statements do not include a break; statement".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/796347/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor796361"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2019 20:29 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/796361/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And -wimplicit-fallthrough does make that distinction<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/796361/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor796465"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2019 15:02 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/796465/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>The "implicit fall-through for adjacent case labels" situation doesn't really exist, so there's no need for special handling in -Wimplicit-fallthrough. Labels apply to the following <em>statement</em>; when you have a list of labels with no intervening statements, every label in the list is associated with the same statement at the end, not the next label. You can never end up branching into the middle of a group of labels, so there is no fall-through.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/796465/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor795586"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Nobody will notice when new warnings are added...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2019 13:02 UTC (Wed)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/795586/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; As long as that option generates a pile of warnings, developers will ignore them and nobody will notice when new ones are added.</font><br>
<p>
Of course we notice: <br>
<p>
<font class="QuotedText">&gt; Below is the list of build error/warning regressions/improvements in</font><br>
<font class="QuotedText">&gt; v5.3-rc3[1] compared to v5.2[2].</font><br>
&gt;<br>
<font class="QuotedText">&gt; 133 warning regressions:</font><br>
<p>
<a href="https://lore.kernel.org/lkml/20190806071711.12294-1-geert@linux-m68k.org/">https://lore.kernel.org/lkml/20190806071711.12294-1-geert...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795586/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor795587"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 7, 2019 13:05 UTC (Wed)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/795587/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And to make things even more surprising: it turns out the warnings do not go away when using legacy indentation styles.<br>
<p>
<a href="https://lore.kernel.org/lkml/CAMuHMdWAboq1YxVVJUop0woJTcantfpftVoR8T5qm3KsAMyCPg@mail.gmail.com/">https://lore.kernel.org/lkml/CAMuHMdWAboq1YxVVJUop0woJTca...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795587/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor796473"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An end to implicit fall-throughs in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2019 17:22 UTC (Fri)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/796473/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
BSD lint(1) <a href="https://www.mirbsd.org/htman/i386/man1/lint.htm">https://www.mirbsd.org/htman/i386/man1/lint.htm</a> wants /* FALLTHROUGH */ (or /* FALLTHRU */ which is deprecated though).<br>
<p>
The (GNU) C præprocessor and GCC also have the option -CC, which is “generally used to support lint comments” but has potentially disturbing side effects. It could be used to define a macro expanding to a comment, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/796473/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
