        <!DOCTYPE html>
        <html lang="en">
        <head><title>The first half of the 6.5 merge window [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/936418/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/936801/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/936418/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The first half of the 6.5 merge window</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>June 30, 2023</br>
           </div>
The first days of the 6.5 merge window have been a bit calmer than usual,
with "only" 4,000 non-merge changesets having been pulled into the mainline
repository.  Those changesets include a fair amount of significant work,
though.  Read on for LWN's summary of the first set of changes merged for
the next major kernel release.
<br clear="all">
<p>
<h4>Architecture-specific</h4>
<p>
<ul class="spacylist">

<li> X86 systems can now parallelize much of the process of bringing up
     all of the CPUs, reducing the time to get all processors online by as
     much as a factor of ten.
<li> Intel's "Topology Aware Register and PM Capsule Interface"
     (abbreviated "TPMI") is now supported.  This is an interface that
     provides a better way of managing power-management features.
<li> The <a href="/Articles/925757/">arm64 permission-indirection
     extension</a> is now supported.  There is no new functionality
     resulting from this support now, but it is needed for some upcoming
     features.
</ul>


<p>
<h4>Core kernel</h4>
<p>
<ul class="spacylist">

<li> The io_uring subsystem has gained the ability to store the rings and
     submission queue in user-space memory, rather than having the kernel
     allocate that memory.  This allows user space to allocate the needed
     memory as huge pages, hopefully improving performance.  <a
     href="https://git.kernel.org/linus/03d89a2de25b">This changelog</a>
     has a little more information.
<li> The kernel's Rust support has been upgraded to the Rust 1.68.2 release,
     the first such upgrade since that support was merged.  Other than
     that, the changes to Rust support were relatively minor this time
     around; <a href="https://git.kernel.org/linus/a1257b5e3b7f">this merge
     message</a> has the details.
<li> The kernel has <a href="/Articles/928328/">gained support for
     unaccepted memory</a> — the protocol by which secure guest systems
     accept memory allocated by the host.  The merged code includes the
     (somewhat) controversial protocol to automatically accept all provided
     memory in the firmware when running a guest kernel without support for
     memory acceptance.
<li> The BPF subsystem has gained the ability to attach filter functions to
     <a href="/Articles/856005/">kfuncs</a>; the filter can limit the
     contexts from which the kfunc can be invoked.  The initial use is to
     restrict callers of <a
     href="https://git.kernel.org/linus/4ddbcb886268"><tt>bpf_sock_destroy()</tt></a>
     to programs of the <tt>BPF_TRACE_ITER</tt> type.
<li> Pinning of BPF objects can now be done using <tt>O_PATH</tt> file
     descriptors as an alternative to providing the path name for the
     target directory.
</ul>
<p>
<h4>Filesystems and block I/O</h4>
<p>
<ul class="spacylist">

<li> It is now possible to mount a filesystem underneath an existing mount
     on the same mount point; this feature is useful for the provision of
     seamless updates within containers.  See <a
     href="/Articles/927491/">this article</a>, <a
     href="/Articles/934094/">this article</a>, and <a
     href="https://git.kernel.org/linus/c0a572d9d32f">the merge message</a>
     for details.
<li> The new <tt>cachestat()</tt> system call can query the page-cache
     state of files and directories, allowing user space to determine which
     of its file pages are currently in RAM.  See <a
     href="/Articles/917096/">this article</a> for details and <a
     href="https://git.kernel.org/linus/cf264e1329fb">this commit</a> for a
     man page.

</ul>

<p>
<h4>Hardware support</h4>
<p>
<ul class="spacylist">
<li> <b>Miscellaneous</b>:
     Renesas RZ/V2M clocked serial interfaces.
<li> <b>Networking</b>:
     Fintek F81604 USB to 2CAN interfaces,
     Microchip LAN865x Rev.B0 10BASE-T1S Internal PHYs,
     Realtek RTL8192FU interfaces,
     Realtek 8723DS SDIO wireless network adapters,
     Realtek 8851BE PCI wireless network adapters, and
     MediaTek SoC Ethernet PHYs.
<li> <b>Regulator</b>:
     TI TPS6287x power regulators,
     TI TPS6594 power-management chips,
     Rockchip RK806 power-management chips, and
     Renesas RAA215300 power-management ICs.
</ul>

<p>
<h4>Miscellaneous</h4>
<p>
<ul class="spacylist">

<li> The <a href="/Articles/920158/">nolibc library</a> has gained stack
     protector support, a number of architecture-specific improvements, and
     more.

</ul>


<p>
<h4>Networking</h4>
<p>
<ul class="spacylist">

<li> The passing of process credentials, as done with the
     <tt>SCM_CREDENTIALS</tt> control message, has been enhanced with a new
     <tt>SCM_PIDFD</tt> type.  As might be expected from the name, this
     message passes a <a href="/Articles/794707/">pidfd</a> rather than a
     process ID.  There is also a new <tt>SO_PEERPIDFD</tt> option to
     <tt><a
     href="https://man7.org/linux/man-pages/man2/setsockopt.2.html">getsockopt()</a></tt>
     that obtains the pidfd of the peer process.

</ul>

<p>
<h4>Security-related</h4>
<p>
<ul class="spacylist">

<li> The "secretmem" facility, in the form of the <a
     href="/Articles/865256/"><tt>memfd_secret()</tt> system call</a>, is
     now enabled by default.  This change was made after <a
     href="/Articles/931406/">some research</a> determined that secretmem
     use does not hurt performance as had been thought.

</ul>

<p>
<h4>Internal kernel changes</h4>
<p>
<ul class="spacylist">

<li> The workqueue subsystem will now automatically detect CPU-intensive
     work items (defined as running for at least 10ms by default) and mark
     them.  This will prevent such items from blocking the execution of
     other work items.  There is a new configuration debugging option to
     enable the reporting of CPU-intensive work items detected in this way.
<li> The kernel is now built with the <tt>-fstrict-flex-arrays=3</tt>
     compiler option, adding more warnings around the use of flexible
     arrays.  See <a href="/Articles/908817/">this article</a> for more
     details on this work.
<li> The new attribute macro <tt>__counted_by()</tt> can be used to
     document which field in a structure contains the number of elements
     stored in a flexible array (in the same structure).  The documentation
     is useful, but it can also eventually be used for bounds checks as
     well.
</ul>
<p>
The 6.5 merge window can be expected to remain open until July&nbsp;9.
LWN will be back shortly after that with a summary of the changes pulled in
the second half; stay tuned.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-6.5">Releases/6.5</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/936418/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor937009"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2023 15:44 UTC (Fri)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/937009/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; The passing of process credentials, as done with the SCM_CREDENTIALS control message, has been enhanced with a new SCM_PIDFD type. As might be expected from the name, this message passes a pidfd rather than a process ID. There is also a new SO_PEERPIDFD option to getsockopt() that obtains the pidfd of the peer process.</span><br>
<p>
To add some more details at the risk of blowing my own trumpet, this is a collab between Canonical and Microsoft to enable secure and race-free process tracking in the auth stack, more precisely between systemd, D-Bus and policykit. Together with the kernel side, this is the userspace side which will hopefully follow once the new uapi is released:<br>
<p>
<a href="https://gitlab.freedesktop.org/dbus/dbus/-/merge_requests/398">https://gitlab.freedesktop.org/dbus/dbus/-/merge_requests...</a><br>
<a href="https://github.com/bus1/dbus-broker/pull/312">https://github.com/bus1/dbus-broker/pull/312</a><br>
<a href="https://gitlab.freedesktop.org/polkit/polkit/-/merge_requests/154">https://gitlab.freedesktop.org/polkit/polkit/-/merge_requ...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937009/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2023 15:50 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Bit-by-bit we're getting comprehensive pidfd-based process management. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor937044"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 30, 2023 21:32 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/937044/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Good work! Magic numbers are a scourge that needs to be fixed. I'd go as far as saying sequential fd numbers themselves ought to be next and replaced with opaque handles, but realistically I don't see POSIX systems getting around to that in my lifetime.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937044/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937053"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 2:08 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937053/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It can just be a prctl() setting. Dense file descriptors make no sense for multithreaded programs anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937053/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937057"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 10:22 UTC (Sat)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/937057/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From the kernel side, managing a dense array is far easier than managing a sparse array. It would be nice to be able to allocate a batch of fd space to each thread, so the allocation was only semi-sparse. fork() of such a beast would be a pain, but threaded tasks don't often call fork().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937057/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 18:19 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937073/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be nice to avoid locking in multithreaded apps, especially for resources like memfd(). Something like a simple rbtree would work better than the dense array.<br>
<p>
For optimizations, a cache of FDs for each thread might also help.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937074"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 18:35 UTC (Sat)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/937074/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The rbtree is a TERRIBLE data structure. It's as bad as a linked list in terms of cache misses. B-trees are much better. I need to do a proper article on this with measurements across a few modern CPUs and some historical ones to explain why the rbtree used to be a good choice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937074/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 2, 2023 14:50 UTC (Sun)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/937116/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This would be a lovely explainer to have, for a multitude of reasons<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor937143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 3, 2023 7:23 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937143/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure. Then use something else.<br>
<p>
For example, each thread can get FDs in bulk in sequential blocks of 2^16. The FDs that are given to userspace can be encrypted by RC5 with 32-bit or 64-bit block size to prevent users from guessing the sequential position within the block. This way, allocation can be done locally without any locks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937148"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 3, 2023 12:04 UTC (Mon)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/937148/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; For example, each thread can get FDs in bulk in sequential blocks of 2^16.</span><br>
<p>
This will fail spectacularly on any program using select(2).  I guess you could make it opt-in, but whether you could ensure select(2) not used in any of the libraries you depend on...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937148/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937206"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 3, 2023 13:59 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/937206/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, as the manpage says, this is absurdly small for most modern applications, so I guess very few modern applications use it :-)<br>
<p>
I think it'll be the classic "roll it out slowly, and fix the breakage".<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937206/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor937220"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 3, 2023 15:44 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937220/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
select() already fails on any program that uses more than 1024 FDs.<br>
<p>
And yes, it has to be an opt-in via prctl() and/or via ELF flags.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937220/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937267"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2023 13:10 UTC (Tue)
                               by <b>Bigos</b> (subscriber, #96807)
                              [<a href="/Articles/937267/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can use select() with more than 1024 file descriptors. It's just fd_set is defined as a fixed-length bit array and 1024 seems to be the size in bits (128 bytes) as defined in the system headers (not sure who is the actual source, probably glibc). You can provide bigger bit arrays if you manage them yourself and then cast to fd_set*.<br>
<p>
Whether it would be efficient is a different question.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937267/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor937135"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 2, 2023 23:03 UTC (Sun)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/937135/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The nice thing about opaque handles is that the kernel is free to use whatever allocation strategy makes its job easiest.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937135/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor937261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2023 9:15 UTC (Tue)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/937261/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think in basically every LWN article that references file descriptors, you pop up and say the same thing =)<br>
<p>
Since<br>
<a href="https://lwn.net/Articles/863483/">https://lwn.net/Articles/863483/</a><br>
the io_uring work has landed, and it seems to me to be the most practical way forward - more work, but more benefit.<br>
<p>
Talking about memfd seems illustrative; today there's no io_uring op to allocate a memfd in the fixed descriptor table, but there could be.  And to complete the picture here we need the io_uring spawn <a href="https://lwn.net/Articles/908268/">https://lwn.net/Articles/908268/</a> flow to allow passing the memfd to a child process.  And io_uring support for setsockopt() for this article.<br>
<p>
And we'd need io_uring equivalent of the pidfd APIs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937319"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2023 3:19 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937319/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  I think in basically every LWN article that references file descriptors, you pop up and say the same thing =)</span><br>
Carthago delanda est.<br>
<p>
io_uring is a good foot-in-the-door. So at least we now have some infrastructure for handle-based management. A prctl() option would automatically extend it to all syscalls, even the ones that are not yet supported natively in io_uring.<br>
<p>
I like io_uring, it is becoming a better syscall interface layer. But right now, it requires a pretty heavy commitment. And it's also hard to compose across the application/library borders.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937319/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937444"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2023 7:42 UTC (Thu)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/937444/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Carthago delanda est.</span><br>
<p>
I had to look this up; but I learned something and it's a perfect reply, thanks =)<br>
<p>
<span class="QuotedText">&gt; And [io_uring is] also hard to compose across the application/library borders.</span><br>
<p>
Yeah, this is a good point.  <br>
<p>
<span class="QuotedText">&gt; A prctl() option would automatically extend it to all syscalls, even the ones that are not yet supported natively in io_uring.</span><br>
<p>
Yeah, ultimately though I think something this involved would require a serious champion; but what might be slightly more of a win than LWN threads is to draft up something like a github gist or a draft PR that shows what you think of the desired interface, then you can just link to it and maybe others can contribute.<br>
<p>
To be clear I agree with you; as the file descriptor has evolved to be "kernel API object reference" its historical semantics leave much to be desired.  Related to this and your comments about encrypting the fds; I was looking at Cap'n Proto recently and its "capabilities" are pretty nice; <a href="https://capnproto.org/rpc.html#distributed-objects">https://capnproto.org/rpc.html#distributed-objects</a>  It also has somewhat io_uring like semantics in allowing chained operations on those capabilities asynchronously.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937444/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2023 23:01 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937527/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  I had to look this up; but I learned something and it's a perfect reply, thanks =)</span><br>
<p>
Well, it worked for Cato eventually :)<br>
<p>
<span class="QuotedText">&gt; Yeah, ultimately though I think something this involved would require a serious champion</span><br>
<p>
I thought about it, but I'm not a serious kernel developer. And this would require some major surgery in the cornerstone parts of Linux. This is not something to do lightly.<br>
<p>
The change to discontinuous FDs is not a big deal, we'd just need to modify alloc_fd in file.c to not care about continuity. But then things get trickier and more complicated. <br>
<p>
First, FDs won't be stored in a dense array anymore, so they'll have to be stored in a hashtable or some kind of a tree. Not a big deal, but this by itself will likely complicate the code and it won't provide any benefits by itself.<br>
<p>
And we want the change to actually have a positive outcome in at least some benchmarks, and that's where complications start to pile up. A whole new infrastructure to allocate FDs will be needed. Ideally, threads should get their own per-thread FD pools to avoid global locking on FD allocation and deallocation. But then you get issues like allocating FDs in one thread and closing them from a different thread, so there'll be a need for some kind of a delayed close queue. In short, we're now talking about replicating what a modern memory allocator does, but for file descriptors.<br>
<p>
I believe that it will absolutely result in faster code eventually, but not before a huge amount of work. I can sponsor some of it, but I don't have nearly enough kernel coding experience to pull it off.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor937453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2023 10:55 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/937453/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
Carthago delanda est.
</blockquote>

Spelling flames are lame, but still: Ceterum censeo, Carthaginem esse delendam.


      
          <div class="CommentReplyButton">
            <form action="/Articles/937453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2023 22:48 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/937526/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe "Carthago delanda est" is grammatically correct, although it indeed is not a verbatim quote of Cato. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 7, 2023 8:36 UTC (Fri)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/937554/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
It's “delenda”, not “delanda”, but otherwise you're correct. “Carthago delenda est” just means “Carthage must be destroyed” where the longer quote means “In addition, it is my opinion that Carthage must be destroyed”. The story goes that Cato used to finish every speech in the Senate with it, even if the speech was on a completely unrelated topic.
</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/937554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor942888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2023 4:17 UTC (Mon)
                               by <b>gutschke</b> (subscriber, #27910)
                              [<a href="/Articles/942888/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Both forms are valid ways of saying "... must be destroyed". But "carthago delenda est" sounds grating and borderline idiomatically incorrect to me; "carthaginem esse delenda" flows much better and is more eloquent.<br>
<p>
In fact, it's often the canonical example that students learn when the grammatical structure of an ACI (accusativus cum infinitivo) is first introduced.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/942888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor937062"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 13:10 UTC (Sat)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/937062/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's too much software relying on close+dup or close+open instead of dup2 when you want a specific file descriptor number.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937062/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor937076"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 19:54 UTC (Sat)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/937076/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You couldn't do it by default, but you could let applications opt into it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937076/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor937098"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 2, 2023 7:28 UTC (Sun)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/937098/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Elsewhere, people wished for 64-bit PIDs (sequential, I presume) so that they do not get re-used in reasonable time, so sequential might not be the big problem in itself. Also, fds are already opaque in that, without more calls, you do not know what they are about (e.g. file/socket). Just like pthread_t.<br>
It will be interesting to see where we will be in 20 years.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937098/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor937056"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2023 6:15 UTC (Sat)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/937056/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nice work!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937056/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor937097"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The first half of the 6.5 merge window</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 2, 2023 7:00 UTC (Sun)
                               by <b>brauner</b> (subscriber, #109349)
                              [<a href="/Articles/937097/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; To add some more details at the risk of blowing my own trumpet, this is a collab between Canonical and Microsoft to enable secure and race-free process tracking in the auth stack, more precisely between systemd, D-Bus and policykit.</span><br>
<p>
Technically this may be a collab but it bothers me a little since our idea's origin has zero to do with any companies. SCM_PIDFD was conceived of years ago but I've never had time to work on it. So a year or more ago we put it onto our public:<br>
<a href="https://github.com/uapi-group/kernel-features">https://github.com/uapi-group/kernel-features</a> (see SCM_PIDFD entry) (sometimes questionable) ideas list and voila, Alex showed up eager to implement it with our help which we're super grateful for. And Luca did the excellent userspace part of the work. Otherwise the uptake would probably take a lot longer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/937097/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2023, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
