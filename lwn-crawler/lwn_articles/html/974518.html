        <!DOCTYPE html>
        <html lang="en">
        <head><title>Two sessions on CXL memory [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/974518/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/973889/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/974518/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Two sessions on CXL memory</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 22, 2024</br>
           <hr>
<a href="/Articles/lsfmmbpf2024/">LSFMM+BPF</a>
</div>
<a href="https://en.wikipedia.org/wiki/Compute_Express_Link">Compute
Express Link (CXL)</a> is a data-center-oriented memory solution that,
according to some in the industry, will yield large cost savings and
performance improvements.  Others are more skeptical.  At the <a
href="https://events.linuxfoundation.org/lsfmmbpf/">2024 Linux Storage,
Filesystem, Memory-Management and BPF Summit</a>, two sessions covered CXL
and how it will be supported in future kernels.
<br clear="all">

<h4>CXL development</h4>
<p>
The first session, led by Adam Manzanares, covered the kernel's support for
CXL in general.  He started by saying that CXL is often mentioned in
connection with memory tiering, but there is more to it than that.  He
would like to see more attention given to some of the other CXL-related
code, such as the driver layer.  CXL development is <a
href="https://patchwork.kernel.org/bundle/cxllinux/cxl-next/">using the
kernel.org patchwork server</a> now, so it is easy for interested
developers to see where the work stands.
<p>
<a href="/Articles/974520/"><img
src="https://static.lwn.net/images/conf/2024/lsfmm/AdamManzanares-sm.png" alt="[Adam Manzanares]"
title="Adam Manzanares" class="rthumb"></a>

Manzanares would especially like some help from developers with an
understanding of the PCI bus.  CXL, he said, is a bit of an awkward fit
with the PCI core, so some effort is needed to make the pieces work well together.
He is also interested in reliability, availability, and serviceability
(RAS) issues, and would like to talk with developers from other subsystems
with experience in dealing with memory errors.  Having a memory controller
on a device complicates things, he said.  He wondered why the CXL code does
its own event handling rather than using the existing <a
href="https://docs.kernel.org/driver-api/edac.html">error detection and
correction (EDAC)</a> code.
<p>
Dan Williams answered that EDAC was invented to abstract the information
about the memory controller; CXL is a standardization of that abstraction.
So, in the future, the kernel will only need to understand CXL rather than
EDAC; and other vendors will find themselves having to make their devices
look more like CXL.  He has been working on translating CXL events into the
EDAC subsystem, which <a href="https://github.com/mchehab/rasdaemon">RAS
Daemon</a>, which is used to collect and report on error notifications,
knows how to deal with.  RAS Daemon may be a legacy tool, but there is
value in its ability to handle errors; there is, however, no desire to
modify it to handle a new interface.
<p>
Hannes Reinecke pointed out that RAS Daemon is running <i>in memory</i>;
what happens if a memory problem affects it?  Williams answered that "if
it kills the daemon, you lose".  The result of the killing of the RAS
Daemon will be a machine-check error, Manzanares said.
<p>
Williams said that there is ongoing work in defining a new scrub subsystem
that is designed to proactively find memory problems.  There is always a
tradeoff between scrubbing frequency and performance. Both ACPI and CXL
have mechanisms to handle scrubbing; EDAC does too.  There are a lot of
people independently solving the same problems, he said; it would be better
if they worked together.
<p>
Turning to benchmarks, Manzanares said that it would be good to have a
general agreement on a few workloads to run for performance measurements.
Since he works for a CXL vendor, he said, he might not be the best person
to be doing benchmarking; end users are better suited to that sort of
task.  The <a href="https://www.opencompute.org/">Open Compute Project</a>
might be a good home for this work; the newly formed tiering
working group might be another.  Williams echoed the need for good
benchmarks; touching the memory-management code is hard, and
developers never know when they are regressing somebody's workload.
<p>
The session concluded with a note that CXL is moving quickly.  Hardware is
currently hard to get, which does not make life easier for developers who
are trying to support it.  It would be good, Manzanares said, to have a
central site where developers could report information about specific
devices.
<p>
<h4>CXL compression</h4>
<p>
Normally, CXL memory is thought of as being voluminous and cheap, but with
higher latency than normal DRAM.  There is potential for other types of CXL
memory as well, though.  Presenting remotely, Yiannis Nikolakopoulos
described the use of compression within CXL devices and how it might work
with Linux.
<p>
In a conventional tiered layout, the top tier of memory lives in the host,
while a lower tier is stored on a CXL device.  The "densemem" concept
extends that design by adding yet another CXL box, adding a third tier to
the system.  The address space on that box is oversubscribed — the box claims to
have more memory than is actually installed.  When data is written to that
memory, it is compressed by the densemem box and mapped accordingly.  The
host is charged with managing this space and reacting to notifications
about capacity changes; it can configure the size of the address space and
the oversubscription factor.
<p>
Making this work requires the addition of a "backpressure" API that will
inform the host about how much free space actually remains on the device.
There are four watermark levels that can be established, and the host will
be interrupted whenever usage passes one of them.  The host can respond by
delaying writes, but it can also take actions like changing the compression
algorithm for better (but presumably slower) compression.  The host can
also defragment the device, or simply free memory.
<p>
Most of the upstream support for this hardware will run in user space, but
there will be some kernel components too.  Nikolakopoulos is working on a
driver to expose the control knobs and give user space control over the
device.
<p>
Davidlohr Bueso asked why developers should care about compression; it
seemed to him to be a way to add latency to a technology that is already
slow.  Manzanares answered that compression is in the Open Compute Project
specification; it is a desired feature, and it is not up to the kernel
community to fight it.  It is, in the end, a cost-saving measure, he said.
<p>
David Hildenbrand said that the only reasonable use for densemem is <a
href="https://docs.kernel.org/admin-guide/mm/zswap.html">zswap</a>; the
kernel could be configured to use it while avoiding the overhead of
<tt>page</tt> structures.  The kernel would not have to manage the
compression, it could just swap to the device.  Williams agreed that it
would be like zswap, but it could provide an additional advantage: since it
is directly addressable, there would be no need to swap data back in to
access it.
<p>
Matthew Wilcox repeated the complaint that CXL already has high latency,
and that compression will make it worse.  Williams answered that densemem
is intended for cold memory; it is better to move that memory there than to
swap it out to disk.  Wilcox said that the PCI bus is intended for storage,
not memory access; he agreed that using PCI-attached CXL memory as a swap
device might be workable, though.
<p>
The session wound down at that point with Williams asking CXL vendors for a
couple of features from this technology.  One current problem is the lack
of a good promotion signal — an indication that memory is being accessed
and should be moved to faster storage.  He also requested an interface to
identify the least-compressible pages stored on the device; those could be
migrated back to faster memory to free space on the densemem device.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Compute_Express_Link_CXL">Compute Express Link (CXL)</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_Memory-Management_and_BPF_Summit-2024">Storage, Filesystem, Memory-Management and BPF Summit/2024</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/974518/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor974669"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">PCI bus</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2024 6:32 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/974669/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The article talks about the PCI bus. Is that really what’s meant? I thought PCI had long been superseded by newer technologies like PCI Express, which resemble PCI only in their name. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/974669/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor974705"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">PCI bus</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2024 12:47 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/974705/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      PCIe, of course, is what was really being discussed here.


      
          <div class="CommentReplyButton">
            <form action="/Articles/974705/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor975136"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">PCI bus</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2024 18:19 UTC (Sun)
                               by <b>snajpa</b> (subscriber, #73467)
                              [<a href="/Articles/975136/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To be honest, it really does look like PCIe specifics were not taken into account and then, CXL is even more distant concept from there... CXL has been designed to be able to support cross socket linking of CPUs, the only reason CXL.mem has so high latencies in current designs is that CXL.mem was wired into them after the fact...<br>
<p>
it'll require a few more design iterations to get it right as it needs more tight coupling of the involved IP blocks, esp. with vendors who have had multi-socket links before CXL came along (+- everyone except Ampere I think) - but current high latencies aren't here to stay<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975136/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor974680"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RASDaemon - Legacy?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2024 8:46 UTC (Thu)
                               by <b>jic23</b> (subscriber, #56049)
                              [<a href="/Articles/974680/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm curious about the RAS Daemon legacy comment.  EDAC does have a bunch of interfaces that could maybe be called legacy. However, EDAC is just one of the interfaces used by RAS Daemon to get error information.  It also handles CXL RAS tracepoints and many other sources of information.  Some large companies have said publicly that they are standardizing on RAS Daemon for all error information handling on host.  Sure there is more to do on the CXL front, but it's early days.  I definitely don't see a call for 'yet another' user space RAS daemon.<br>
<p>
In plenty of cases the user space part is just about logging because an error is synchronously reported and must be handled now (so is a kernel problem), but for the rest policy and the statistics to make decisions under that policy belong in user space and RAS Daemon is a good upstream project to do that work in.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/974680/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
