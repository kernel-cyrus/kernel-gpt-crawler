        <!DOCTYPE html>
        <html lang="en">
        <head><title>Improving ext4: bigalloc, inline data, and metadata checksums [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/469805/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/469437/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/469805/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Improving ext4: bigalloc, inline data, and metadata checksums</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 29, 2011</br>
           </div>
It may be tempting to see ext4 as last year's filesystem.  It is solid and
reliable, but it is based on an old design; all the action is to be found
in next-generation filesystems like Btrfs.  But it may be a while until
Btrfs earns the necessary level of confidence in the wider user community;
meanwhile, ext4's growing user base has not lost its appetite for
improvement.  A few recently-posted patch sets show that the addition
of new features to ext4 has not stopped, even as that filesystem settles in
for a long period of stable deployments.
<p>
<h4>Bigalloc</h4>
<p>
In the early days of Linux, disk drives were still measured in megabytes
and filesystems worked with blocks of 1KB to 4KB in size.  As this article
is being written, 
terabyte disk drives are not quite as cheap as they recently were, but the
fact remains: disk drives have gotten a lot larger, as have the files
stored on them.  But the ext4 filesystem still deals in 4KB blocks of data.
As a 
result, there are a lot of blocks to keep track of, the associated
allocation bitmaps have grown, and the overhead of managing all those
blocks is significant.
<p>
Raising the filesystem block size in the kernel is a dauntingly difficult
task involving major changes to memory management, the page cache, and
more.  It is not something anybody expects to see happen anytime soon.  But
there is nothing preventing filesystem implementations from using larger
blocks on disk.  As of the 3.2 kernel, ext4 will be capable of doing
exactly that.  The "bigalloc" patch set adds the concept of "block clusters"
to the filesystem; rather than allocate single blocks, a filesystem using
clusters will allocate them in larger groups.  Mapping between these larger
blocks and the 4KB blocks seen by the core kernel is handled entirely
within the filesystem.
<p>

The cluster size to use is set by the system administrator at filesystem
creation time (using a development version of e2fsprogs), but it must be a
power of two.  A 64KB cluster size may make sense in a lot of situations;
for a filesystem that holds only very large files, a 1MB cluster size might
be the right choice.  Needless to say, selecting a large cluster size for a
filesystem dominated by small files may lead to a substantial amount of
wasted space.

<p>
Clustering reduces the space overhead of the block bitmaps and other
management data structures.  But, as Ted Ts'o <a
href="/Articles/469821/">documented</a> back in July, it can also increase
performance in situations where large files are in use.  Block allocation
times drop significantly, but file I/O performance also improves in general
as the result of reduced on-disk fragmentation.  Expect this feature to
attract a lot of interest once the 3.2 kernel (and e2fsprogs 1.42) make
their way to users. 

<p>
<h4>Inline data</h4>
<p>
An inode is a data structure describing a single file within a filesystem.
For most filesystems, there are actually two types of inode: the
filesystem-independent in-kernel
variety (represented by <tt>struct&nbsp;inode</tt>), and the
filesystem-specific on-disk version.  As a general rule, the kernel cannot
manipulate a file in any way until it has a copy of the inode, so inodes,
naturally, are the focal point for a lot of block I/O.
<p>
In the ext4 filesystem, the size of on-disk inodes can be set when a
filesystem is created.  The default size is 256 bytes, but the on-disk
structure (<tt>struct ext4_inode</tt>) only requires about half of that
space.  The remaining space after the <tt>ext4_inode</tt> structure is
normally used to hold extended attributes.  Thus, for example, SELinux
labels can be found there.  On systems where extended attributes are not
heavily used, the space between on-disk inode structures may simply go to
waste.
<p>
Meanwhile, space for file data is allocated in units of blocks, separately
from the inode.  If a file
is very small (and, even on current systems, there are a lot of small
files), much of the block used to hold that file will be wasted.  If the
filesystem is using clustering, the amount of lost space will grow even
further, to the point that users may start to complain.
<p>
Tao Ma's <a href="/Articles/468678/">ext4 inline data patches</a> may
change that situation.  The idea is quite simple: very small files can be
stored directly in the space between inodes without the need to allocate a
separate data block at all.  On filesystems with 256-byte on-disk inodes,
the entire remaining space will be given over to the storage of small
files.  If the filesystem is built with larger on-disk inodes, only half of
the leftover space will be used in this way, leaving space for
late-arriving extended attributes that would otherwise be forced out of the
inode.
<p>
Tao says that, with this patch set applied, the space required to store a
kernel tree drops by about 1%, and <tt>/usr</tt> gets about 3% smaller.
The savings on filesystems where clustering is enabled should be somewhat
larger, but those have not yet been quantified.  There are a number of
details to be worked out yet - including e2fsck support and the potential
cost of forcing extended attributes to be stored outside of the inode - so
this feature is unlikely to be ready for inclusion before 3.4 at the
earliest. 
<p>
<h4>Metadata checksumming</h4>
<p>
Storage devices are not always as reliable as we would like them to be;
stories of data corrupted by the hardware are not uncommon.  For this
reason, people who care about their data make use of technologies like RAID
and/or filesystems like Btrfs which can maintain checksums of data and
metadata and ensure that nothing has been mangled by the drive.  The ext4
filesystem, though, lacks this capability.
<p>
Darrick Wong's <a href="/Articles/469717/">checksumming patch set</a> does
not address the entire problem.  Indeed, it risks reinforcing the old jest
that filesystem developers don't really care about the data they store as
long as the filesystem metadata is correct.  This patch set seeks to
achieve that latter goal by attaching checksums to the various data
structures found on an ext4 filesystem - superblocks, bitmaps, inodes,
directory indexes, extent trees, etc. - and verifying that the checksums
match the data read from the filesystem later on.  A checksum failure can
cause the filesystem to fail to mount or, if it happens on a mounted
filesystem, remount it read-only and issue pleas for help to the system
log.
<p>
Darrick makes no mention of any plans to add checksums for data as well.
In a number of ways, that would be a bigger set of changes; checksums are
relatively easy to add to existing metadata structures, but an entirely new
data structure would have to be added to the filesystem to hold data block
checksums.  The performance impact of full-data checksumming would also be
higher.  So, while somebody might attack that problem in the future, it
does not appear to be on anybody's list at the moment.
<p>
The changes to the filesystem are
significant, even for metadata-only checksums,
but the bulk of the work 
actually went into e2fsprogs.  In particular, e2fsck gains the ability to
check all of those checksums and, in some cases, fix things when the
checksum indicates that there is a problem.  Checksumming can be
enabled with mke2fs and toggled with tune2fs.  All told, it is a lot of
work, but it should help to improve confidence in the filesystem's
structure.  According to Darrick, the overhead of the checksum calculation
and verification is not measurable in most situations.  This feature has
not drawn a lot of comments this time around, and may be close to ready for
inclusion, but nobody has yet said when that might happen.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ext4">Filesystems/ext4</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/469805/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor469850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 29, 2011 23:44 UTC (Tue)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/469850/">Link</a>] (103 responses)
      </p>
      
      </div>
      </summary>
      <p><font class="QuotedText"> &gt; It is solid and reliable</font></p>

<p>I'm not so sure about that; I've suffered data corruption in a stand-alone ext4 filesystem with a bunch of OGG Vorbis files&mdash;occasionally <tt>ogginfo(1)</tt> reports corrupt OGG files.  Fortunately I have backups.</p>

<p>I'm going back to ext3 at the soonest opportunity. FWIW I'm using a multi-disk LVM setup&mdash;I wonder if that's the culprit?<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/469850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469851"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 29, 2011 23:49 UTC (Tue)
                               by <b>yoe</b> (guest, #25743)
                              [<a href="/Articles/469851/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What you're trying to do with moving back to ext3 is what the Jargon File calls shotgun debugging: trying out some radical move in hopes that this will fix your problem.<br>
<p>
Try to nail down whether your problem is LVM, one of your disks dying, or ext4, before changing things like that. Otherwise you'll be debugging for a long time to come...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469851/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 4:49 UTC (Wed)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/469871/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... or bad RAM, bad CPU cache, CPU heat, an unrelated kernel bug in (eg) a disk controller, a disk controller firmware bug, a disk firmware bug, or all sorts of other exciting possibilities.<br>
<p>
I recently had a batch of disks in a backup server start eating data because of a HDD firmware bug. It does happen.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 8:29 UTC (Wed)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/469882/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please disclose disc model and fw level, this kind of stuff is important as it often helps someone avoid data loss...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor469896"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 12:02 UTC (Wed)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/469896/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"occasionally ogginfo(1) reports corrupt OGG files"<br>
<p>
Screams RAM or cache fault to me. It's that word "occasionally" which does it. Bugs tend to be systematic. Their symptoms may be bizarre, but there's usually something consistent about them, because after all someone has specifically (albeit accidentally) programmed the computer to do exactly whatever it was that happened. Even the most subtle Heisenbug will have some sort of pattern to it.<br>
<p>
Yoe should be especially suspicious of their "blame ext4" idea if this "corruption" is one or two corrupted bits rather than big holes in the file. Disks don't tend to lose individual bits. Disk controllers don't tend to lose individual bits. Filesystems don't tend to lose individual bits. These things all deal in blocks, when they lose something they will tend to lose really big pieces.<br>
<p>
But dying RAM, heat-damaged CPU cache, or a serial link with too little margin of error, those lose bits. Those are the places to look when something mysteriously becomes slightly corrupted.<br>
<p>
Low-level network protocols often lose bits. But because there are checksums in so many layers you won't usually see this in a production system even when someone has goofed (e.g. not implemented Ethernet checksums at all) because the other layers act as a safety net.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469896/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 12:44 UTC (Wed)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/469906/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Bah, should specify pr1268 not Yoe. Sorry.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor469926"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 15:42 UTC (Wed)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/469926/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>The corruption I was getting was not merely &quot;one or two bits&quot; but rather a hole in the OGG file big enough to cause an audible &quot;skip&quot; in the playback&mdash;large enough to believe it was a whole block disappearing from the filesystem.  Also, the discussion of write barriers came up; I have <tt>noatime,data=ordered,barrier=1</tt> as mount options for this filesystem in my <tt>/etc/fstab</tt> file&mdash;I'm pretty sure those are the &quot;safe&quot; defaults (but I could be wrong).</p> 
      
          <div class="CommentReplyButton">
            <form action="/Articles/469926/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 17:31 UTC (Wed)
                               by <b>rillian</b> (subscriber, #11344)
                              [<a href="/Articles/469951/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ogg files have block-level checksums too.<br>
<p>
That means that a few bit errors will cause the decoder to drop ~100 ms of audio at a time, and tools will report this as 'hole in data'. To see if it's disk or filesystem corruption, look for pages of zeros in a hexdump around where the glitch is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 3:17 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/470052/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe ogg's block-level checksums aren't such a good idea after all. Most likely, a few wrong bits won't affect the sound output much, and a 100ms skip sounds much worse than just playing a single wrong sample. Checksums make sense for things that must stay intact, but I don't think most multimedia benefits from this kind of robustness.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470093"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 10:07 UTC (Thu)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/470093/">Link</a>] 
      </p>
      
      </div>
      </summary>
      A few wrong bits in a Vorbis stream seem likely to give you more than just "one wrong sample".
      
          <div class="CommentReplyButton">
            <form action="/Articles/470093/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470202"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 18:25 UTC (Thu)
                               by <b>rillian</b> (subscriber, #11344)
                              [<a href="/Articles/470202/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed. A few corrupt bits in a compressed format can result in a whole block of nasty noise in the output.<br>
<p>
The idea with the Ogg checksums was to protect the listener's ears (and possibly speakers) from corrupt output. It's also nice to have a built-in check for data corruption in your archives, which is working as designed here.<br>
<p>
What you said is valid for video, because we're more tolerant of high frequency visual noise, and because the extra data dimensions and longer prediction intervals mean you can get more useful information from a corrupt frame than you do with audio. Making the checksum optional for the packet data is one of the things we'd do if we ever revised the Ogg format.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470202/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470429"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">shotgun debugging</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 22:09 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/470429/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
What you're trying to do with moving back to ext3 is what the Jargon File calls shotgun debugging: trying out some radical move in hopes that this will fix your problem.
</blockquote>
<p>
That's not shotgun debugging (and not what the Jargon File calls it).  The salient property of a shotgun isn't that it makes radical changes, but that it makes widespread changes.  So you hit what you want to hit without aiming at it.
<p>
Shotgun debugging is trying lots of little things, none that you particularly believe will fix the bug.
<p>
In this case, the fallback to ext3 is fairly well targeted: the problem came contemporaneously with this one major and known change to the system, so it's not unreasonable to try undoing that change.
<p>
The other comments give good reason to believe this is not the best way forward, but it isn't because it's shotgun debugging.
<p>
There must be a term for the debugging mistake in which you give too much weight to the one recent change you know about in the area; I don't know what it is.  (I've lost count of how many people accused me of breaking their Windows system because after I used it, there was a Putty icon on the desktop and something broke soon after that).

      
          <div class="CommentReplyButton">
            <form action="/Articles/470429/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor469854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 0:00 UTC (Wed)
                               by <b>bpepple</b> (subscriber, #50705)
                              [<a href="/Articles/469854/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Depending on how you encoded those ogg files, the corruption you're seeing might not be due to ext4 but to this bug(1).<br>
<p>
1. <a href="https://bugzilla.redhat.com/show_bug.cgi?id=722667">https://bugzilla.redhat.com/show_bug.cgi?id=722667</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 0:32 UTC (Wed)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/469855/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <p>Thanks for the pointer, and thanks also to <a href="http://lwn.net/Articles/469851/">yoe's reply</a> above.  But, my music collection (currently over 10,000 files) has existed for almost four years, ever since I converted the entire collection from MP3 to OGG (via a homemade script which took about a week to run).<sup>1</sup> (I've never converted from FLAC to OGG, although I do have a couple of FLAC files.)  I never noticed any corruption in the OGG files until a few months ago, shortly after I did a clean OS re-install (Slackware 13.37) on bare disks (including copying the music files)<sup>2</sup>.  I'm all too eager to blame the corruption on ext4 and/or LVM, since those were the only two things that changed immediately prior to the corruption, but you both bring up a good point that maybe I should dig a little deeper into finding the root cause before I jump to conclusions.</p>

<p><sup>1</sup> I've had this collection of (legitimately acquired) songs for years prior, even having it on NTFS back in my Win2000/XP days.  I abandoned Windows (including NTFS) in August 2004, and my music collection was entirely MP3 format (at 320 kbit) since I got my first 200GB hard disk.  After seeing the benefits of the OGG Vorbis format, I decided to switch.</p>

<p><sup>2</sup> I have four physical disks (volumes) in which I've set up PV set spanning across all disks for fast I/O performance.  I'm not totally impressed at the performance&mdash;it <i>is</i> somewhat faster&mdash;but that's a whole other discussion.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/469855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 0:57 UTC (Wed)
                               by <b>yokem_55</b> (guest, #10498)
                              [<a href="/Articles/469858/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would also run smartctl -l error to see if your hard drives are bugging out and maybe even run memtest86+ overnight to see if you are having memory errors. Wierd, widespread data (with metadata intact) corruption in my experience tends to be more hardware related than anything else. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469863"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 experience</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 2:11 UTC (Wed)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/469863/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p>I also had a very nasty experience with ext4.  A server I built using ext4 suffered a power failure and the file system was <em>completely</em> toast after it powered back up.  fsck threw hundreds of errors and I ended up rebuilding from scratch.

<p>I have no idea if ext4 was the cause of the problem, but I've never seen that on an ext3 system.  I am very nervous... possibly irrationally so, but I think I'll stick to ext3 for now.

      
          <div class="CommentReplyButton">
            <form action="/Articles/469863/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 experience</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 4:52 UTC (Wed)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/469872/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The usual culprit in those sorts of severe corruption or loss cases is aggressive write-back caching without battery backup. Some cheap RAID controllers will let you enable write-back caching without a BBU, and some HDDs support it too.<br>
<p>
Write-back caching on volatile storage without careful use of write barriers and forced flushes *will* cause severe data corruption if the storage is cleared due to (eg) unexpected power loss.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 experience</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 9:00 UTC (Wed)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/469888/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are right about battery backup.  Every modern hard disk uses writeback caching, and some of them make it hard to ensure that the cache is flushed when the kernel wants to ensure a write barrier is implemented.  The size of hard disk caches (32 MB typically) and the use of journalling filesystems (concentrating key metadata writes in journal blocks) can mean that a power loss or hard crash loses a large amount of filesystem metadata.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 experience</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 12:40 UTC (Wed)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/469905/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>My system was using Linux Software RAID, so there wasn't a cheap RAID controller in the mix.  You could be correct about the hard drives doing caching, but it seems odd that I've never seen this with ext3 but did with ext4.  I am still hoping it was simply bad luck, bad timing, and writeback caching... but I'm also still pretty nervous.

      
          <div class="CommentReplyButton">
            <form action="/Articles/469905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 experience</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 12:50 UTC (Wed)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/469908/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Ah... reading http://serverfault.com/questions/279571/lvm-dangers-and-caveats makes me think I was a victim of LVM and no write barriers.  I've followed the suggestions in that article.  So maybe I'll give ext4 another try.
      
          <div class="CommentReplyButton">
            <form action="/Articles/469908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor469990"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 experience</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 20:20 UTC (Wed)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/469990/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You have been wishing for O_PONIES!<br>
<p>
It is a very well known issue usually involving unaware sysadms and cheating developers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469990/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor469864"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 2:13 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/469864/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Quite so. I've been using ext4 atop LVM (atop raid1 md, raid5 md, and Areca hardware RAID) for many years, and have never encountered a single instance of fs corruption which fsck could not repair -- and only one severe enough to prevent mounting which was not attributable to abrupt powerdowns, and *that* was caused by a panic at the end of a suspend, and e2fsck fixed it.<br>
<p>
I'm quite willing to believe that bad RAM and the like can cause data corruption, but even when I was running ext4 on a machine with RAM so bad that you couldn't md5sum a 10Mb file three times and get the same answer thrice, I had no serious corruption (though it is true that I didn't engage in major file writing while the RAM was that bad, and I did get the occasional instances of bitflips in the page cache, and oopses every day or so).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469864/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bitflips</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 12:49 UTC (Wed)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/469907/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"occasional instances of bitflips in the page cache"<br>
<p>
To someone who isn't looking for RAM/ cache issues as the root cause, those often look just like filesystem corruption of whatever kind. They try to open a file, get an error saying it's corrupted. Or they run a program and it mysteriously crashes.<br>
<p>
If you _already know_ you have bad RAM, then you say "Ha, bitflip in page cache" and maybe you flush a cache and try again. But if you've already begun to harbour doubts about Seagate disks, or Dell RAID controllers, or XFS then of course that's what you will tend to blame for the problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470225"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bitflips</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 19:23 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470225/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This does depend on how bad the RAM was. The RAM on this machine was so bad that the fs was not the only thing misbehaving by any means.<br>
<p>
Rare bitflips are normally going to be harmless or fixed up by e2fsck, one would hope. There may be places where a single bitflip, written back, toasts the fs, but I'd hope not. (The various fs fuzzing tools would probably have helped comb those out.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470225/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor469889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 10:19 UTC (Wed)
                               by <b>Trou.fr</b> (subscriber, #26289)
                              [<a href="/Articles/469889/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not related to the current discussion : I hope you are aware that transcoding your MP3 collection to Vorbis only decreased their audio quality : <a href="http://wiki.hydrogenaudio.org/index.php?title=Transcoding">http://wiki.hydrogenaudio.org/index.php?title=Transcoding</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469925"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 15:35 UTC (Wed)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/469925/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>From that article: <font class="QuotedText">Mp3 to Ogg Ogg -q6 was required to achieve transparency against the (high-quality) mp3 with difficult samples.</font></p>

<p>I used <tt>-q8</tt> (or higher) when transcoding with <tt>oggenc(1)</tt>; I've done extensive testing by transcoding back-and-forth to different formats (including RIFF WAV) and have never noticed any decrease in audio quality or frequency response, even when measured with a spectrum analyzer.  I do value your point, though.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/469925/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470265"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 22:54 UTC (Thu)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/470265/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just to clarify for everyone (who perhaps stumbles in via a web search): converting from mp3 to ogg, or indeed any time you apply lossy compression to something already lossy compressed, can only make the quality worse. The best case here is "at least not audibly worse".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470265/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471580"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2011 1:04 UTC (Sat)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/471580/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When one approximate another approximation it is possible the result will be closer to the original than the initial approximation. So in theory one can get better result with MP3-&gt;OGG conversion. For this reason if tests show that people cannot detect the difference with the *properly* done conversion, then I do not see how one can claim that it can only made the quality worse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471580/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471641"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Lossy format conversion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2011 15:20 UTC (Sat)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/471641/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Pretty far off-topic, but: it is a rare situation indeed where the removal of information will improve the fidelity of a signal.  One might not be able to hear the difference, but I have a hard time imagining how conversion between lossy formats could do anything but degrade the quality.  You can't put back something that the first lossy encoding took out, but you can certainly remove parts of the signal that the first encoding preserved.
      
          <div class="CommentReplyButton">
            <form action="/Articles/471641/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Lossy format conversion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 2:54 UTC (Mon)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/471735/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>You can't replace missing information, but you could still make something that sounds better -- in a subjective sense.  For example, maybe the mp3 has harsh artifacts at higher frequencies that the ogg encoder would remove.

<p>It could apply to lossy image transformations too.  Consider <a href="http://jim.sh/~jim/tmp/lossy/">this sample set of images</a>.
An initial image is pixelated (lossy), and that result is then blurred (also lossy).  Some might argue that the final result looks better than the intermediate one, even though all it did was throw away more information.

<p>But I do agree that this is off-topic, and that such improvement is probably rare in practice.
      
          <div class="CommentReplyButton">
            <form action="/Articles/471735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor469884"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 8:50 UTC (Wed)
                               by <b>ebirdie</b> (guest, #512)
                              [<a href="/Articles/469884/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I did administer a backup server with multidisk LVM volumes and had a persistent problem in one volume with XFS. I even reported the problem to XFS development mailing list. I couldn't find no evident, where the problem came from eventually. My final conclusion was that mkfs.xfs had some bug at the time the volume was created, since newer XFS volumes never got similar problem and after couple upgrades to xfs utilities newer xfs_repair pushed the problem over the edge to non existence.<br>
<p>
Lesson learned: it pays to keep data on smaller volumes although it is very very tempting to stuff data to ever bigger volumes and postpone the headache in splitting and managing smaller volumes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469884/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor469887"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 8:57 UTC (Wed)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/469887/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It can be difficult to ensure that writes are getting to disk through caches in the hard disk and kernel (write barriers etc), particularly when using LVM.  Turning off hard disk write caching may be necessary in some cases.<br>
<p>
This may help: <a href="http://serverfault.com/questions/279571/lvm-dangers-and-caveats">http://serverfault.com/questions/279571/lvm-dangers-and-c...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469887/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor469999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 21:01 UTC (Wed)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/469999/">Link</a>] (58 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As to corruption, you might want to read some nice papers by CERN presented at HEPiX on silent corruption. It happens everywhere, and it can have subtle effects. But as a legendary quote goes, "as far as we know we never had an undetected error" (mainframe IT manager interviewed by Datamation many years ago) is a common position. Thanks to 'ogginfo' you have discovered just how important end-to-end arguments are.<br>
<p>
But the main issue is not that, by all accounts 'ext4' is quite reliable (when on a properly setup storage system and properly used by applications).<br>
<p>
The big problem with 'ext4' is that its only reason to be is to allow Red Hat customers to upgrade in place existing systems, and what Red Hat wants, Red Hat gets (also because they usually pay for that and the community is very grateful).<br>
<p>
Other than that new "typical" systems almost only JFS and XFS make sense (and perhaps in the distant future BTRFS).<br>
<p>
In particular JFS should have been the "default" Linux filesystem instead of ext[23] for a long time. Not making JFS the default was probably the single worst strategic decision for Linux (but it can be argued that letting GKH near the kernel was even worse). JFS is still probably (by a significant margin) the best ''all-rounder'' filesystem (XFS beats it in performance only on very parallel large workloads, and it is way more complex, and JFS has two uncommon but amazingly useful special features).<br>
<p>
Sure it was very convenient to let people (in particular Red Hat customers) upgrade in place from 'ext' to 'ext2' to 'ext3' to 'ext4' (each in-place upgrade keeping existing files unchanged and usually with terrible performance), but given that when JFS was introduced the Linux base was growing rapidly, new installations could be expected to outnumber old ones very soon, making that point largely moot.<br>
<p>
PS: There are other little known good filesystems, like OCFS2 (which is pretty good in non-clustered mode) and NILFS2 (probably going to be very useful on SSDs), but JFS is amazingly still very good. Reiser4 was also very promising (it seems little known that the main developer of BTRFS was also the main developer of Reiser4). As a pet peeve of mine UDF could have been very promising too, as it was quite well suited to RW media like hard disks too (and the Linux implementation almost worked in RW mode on an ordinary partition), and also to SSDs.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 22:07 UTC (Wed)
                               by <b>yokem_55</b> (guest, #10498)
                              [<a href="/Articles/470011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree that both jfs and disk based RW udf are way underrated. I use jfs on our laptop as it supposedly tends to have less cpu usage, and thus is better for reducing power usage. UDF, if properly supported by the kernel, would make a fantastic fs for accessing data in dual boot situations as Windows has pretty good support and it doesn't have the limitations of vfat nor does it require a nasty, awful, performance sucking hack like ntfs-3g. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470022"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 23:12 UTC (Wed)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/470022/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The main developer of ext234fs is currently a Google employee.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470022/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470038"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 0:53 UTC (Thu)
                               by <b>SLi</b> (subscriber, #53131)
                              [<a href="/Articles/470038/">Link</a>] (37 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I very much disagree about JFS or XFS being the preferable filesystem on normal Linux use. Believe me, I've tried them both, benchmarked them both, and on almost all counts ext4 outperforms the two by a really wide margin (note that strictly speaking I'm not comparing the filesystems but their Linux implementations). In addition any failures have tended to be much worse on JFS and XFS than on ext4.<br>
<p>
The only filesystem, years back, that could have said to outperform ext4 on most counts was ReiserFS 4. Unfortunately on each of the three times I stress tested it I hit different bugs that caused data loss.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470038/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470045"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 2:03 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470045/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
for a lot of people, ext4 is a pretty new filesystem, just now getting to the point where it has enough of a track record to trust data to.<br>
<p>
I haven't benchmarked against ext4, but I have done benchmarks with the filesystems prior to it, and I've run into many cases where JFS and XFS are clear winners.<br>
<p>
even against ext4, if you have a fileserver situation where you have lots of drives involved, XFS is still likely to be a win, ext4 just doesn't have enough developers/testers with large numbers of disks to work with (this isn't my opinion, it's a statement from Ted Tso in response to someone pointing out where EXT4 doesn't do as well as XFS with a high performance disk array)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470045/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470399"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 18:52 UTC (Fri)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470399/">Link</a>] (35 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><p>JFS or XFS being the preferable filesystem on normal Linux use. Believe me, I've tried them both, benchmarked them both, and on almost all counts ext4 outperforms the two by a really wide margin (note that strictly speaking I'm not comparing the filesystems but their Linux implementations). In addition any failures have tended to be much worse on JFS and XFS than on ext4.</p></blockquote>

Most well done benchmarks I have seen show them mostly equivalent performance, with XFS leading the group in scalability, JFS pretty good across the field, and 'ext4' just like the previous 'ext's being good only on totally freshly loaded filesystems as it packs newly created files pretty densely, and when there is ample caching (no use of 'O_DIRECT'), and both fresh loading and caching mask its fundamental, BSD FFS derived, downsides.

It is very very easy to do meaningless filesystem benchmarks (the vast majority that I see on LWN and most others are worthless).

      
          <div class="CommentReplyButton">
            <form action="/Articles/470399/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470437"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 23:15 UTC (Fri)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470437/">Link</a>] (34 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One caution about JFS.   JFS does not issue cache flush (i.e., barrier) requests, which (a) gives it a speed advantage of file systems that do issue cache flush commands as necessary, and (b) it makes JFS unsafe against power failures.   Which is most of the point of having a journal...<br>
<p>
So benchmarking JFS against file systems that are engineered to be safe against power failures, such as ext4 and XFS, isn't particularly fair.   You can disable cache flushes for both ext4 and XFS, but would you really want to run in an unsafe configuration for production servers?   And JFS doesn't even have an option for enabling barrier support, so you can't make it run safely without fixing the file system code.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470437/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 0:56 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470451/">Link</a>] (31 responses)
      </p>
      
      </div>
      </summary>
      <p>As to JFS and performance and barriers with XFS and <tt>ext4</tt>:<p>

<ul>
<li>I mentioned JFS as a "general purpose" filesystem, for example desktops, and random servers, in that it should have been the default instead of <tt>ext3</tt> (which acquired barriers a bit late).</li>
<li>Anyhow on production servers I personally regard battery backup as essential, as barriers and/or disabling write caching both can have a huge impact, depending on workload.</li>
<li>The speed tests I have done and seen and that I trust are with barriers disabled and either batteries or write caching off, and with <tt>O_DIRECT</tt> (it is very difficult for me to like any file system test without <tt>O_DIRECT</tt>). I think these are fair conditions.</li>
<li>Part of the reason why barriers were added to <tt>ext3</tt> (and at least initially they had <a href="http://www.redhat.com/archives/ext3-users/2007-May/msg00022.html">horrible performance</a>) and not JFS is that <tt>ext3</tt> was chosen as the default filesystem and thus became community supported and JFS did not.</li>
</ul>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470457"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 1:56 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470457/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
battery backup does not make disabling barriers safe. without barriers, stuff leaves RAM to be sent to the disk at unpredictable times, and so if you loose the contents of RAM (power off, reboot, hang, etc) you can end up with garbage on your disk as a result, even if you have a battery-backed disk controller.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470457/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470460"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 3:06 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/470460/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm pretty sure, in this context, the OP was talking about battery backed write cache ram on the disk controller<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470460/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470469"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 6:29 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470469/">Link</a>] (25 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that's what I think as well, and my point is that having battery backed ram on the controller does not make it safe to disable barriers.<br>
<p>
it should make barriers very fast so there isn't a big performance hit from leaving them on, but if you disable barriers and think the battery will save you, you are sadly mistaken<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470469/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470479"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 11:05 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470479/">Link</a>] (24 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Really? In that case there's an awful lot of documentation out there that needs rewriting. I was fairly sure that the raison d'etre of battery backup was 1) to make RAID-[56] work in the presence of power failures without data loss, and 2) to eliminate the need to force-flush to disk to ensure data integrity, ever, except if you think your power will be off for so very long that the battery will run out.<br>
<p>
If the power is out for months, civilization has probably fallen, and I'll have bigger things to care about than a bit of data loss. Similarly I don't care that battery backup doesn't defend me against people disconnecting the controller or pulling the battery while data is in transit. What other situation does battery backup not defend you against?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470479/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470489"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 15:39 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470489/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
there are two stages to writing things to a raid array<br>
<p>
1. writing from the OS to the raid card<br>
<p>
2. writing from the raid card to the drives<br>
<p>
battery backup on the raid card makes step 2 reliable. this means that if the data is written to the raid card it should be considered as safe as if it was on the actual drives (it's not quite that safe, but close enough)<br>
<p>
However, without barriers, the data isn't sent from the OS to the raid card in any predictable pattern. It's sent at the whim of the OS cache flusing algorithm. This can result in some data making it to the raid controller and other data not making it to raid controller if you have an unclean shutdown. If the data is never sent to the raid controller, then the battery there can't do you any good.<br>
<p>
With Barriers, the system can enforce that data gets to raid controller in a particular order, and so the only data that would be lost is the data since the last barrier operation was completed.<br>
<p>
<p>
note that if you are using software raid, things are much uglier as the OS may have written the stripe to one drive and not to another (barriers only work on a single drive, not across drives). this is one of the places where hardware raid is significantly more robust than software raid.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470489/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470498"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 18:04 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/470498/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe I'm wrong but I dont think it works that way. Barriers are there to control the write cache after data has been posted to the storage device, to ensure that the device doesn't report completion until the data is actually perminanely committed.   So I think it already works the way you want, filesystems already manage their writes and caching afaik<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470498/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470503"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 19:31 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470503/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not quite sure which part of my statement you are disagreeing with<br>
<p>
barriers preserve the ordering of writes throughout the entire disk subsystem, so once the filesystem decides that a barrier needs to be at a particular place, going through a layer of LVM (before it supported barriers) would run the risk of the writes getting out of order<br>
<p>
with barriers on software raid, the raid layer won't let the writes on a particular disk get out of order, but it doesn't enforce that all writes before the barrier on disk 1 get written before the writes after the barrier on disk 2<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470503/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470539"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 6:17 UTC (Sun)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/470539/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess I was under the impression, incorrect it may be, that the concepts of write barriers were already baked into most responsible filesystems but that the support for working through LVM was recent (in the last 5yrs) and the support for actually issuing the right commands to the storage and having the storage respect them was also more recent.  Maybe I'm wrong and barriers as a concept are newer.<br>
<p>
In any event there is a bright line between how the kernel handles internal data structures and what the hardware does and for storage with battery backed write cache once an IO is posted to the storage it is as good as done so there is no need to ask the storage to commit its blocks in any particular fashion.  The only issue is that the kernel issue the IO requests in a responsible manner.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470539/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 6:41 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470540/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
barriers as a concept are not new, but your assumption that filesystems support them is the issue.<br>
<p>
per the messages earlier in this thread, JFS does not, for a long time (even after it was the default in Fedora), LVM did not.<br>
<p>
so barriers actually working correctly is relatively new (and very recently they have found more efficient ways to enforce ordering than the older version of barriers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470551"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 11:24 UTC (Sun)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470551/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
JFS still to this day does not issues barriers / cache flushes.<br>
<p>
It shouldn't be that hard to add support, but no one is doing any development work on it.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470551/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 16:26 UTC (Sun)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/470563/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
JFS has never been default in Fedora. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 16:50 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470564/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I didn't think that I ever implied that it was.<br>
<p>
Fedora has actually been rather limited in it's support of various filesystems. The kernel supports the different filesystems, but the installer hasn't given you the option of using XFS and JFS for your main filsystem for example.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470568"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 17:41 UTC (Sun)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/470568/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It appears you did<br>
<p>
"JFS does not, for a long time (even after it was the default in Fedora)"<br>
<p>
You are inaccurate about your claim on the installer as well.  XFS is a standard option in Fedora for several releases ever since Red Hat hired Eric Sandeen from SGI to maintain it (and help develop Ext4).  JFS is a non-standard option. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470568/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470572"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 19:22 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470572/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
re: JFS, oops, I don't know what I was thinking when I typed that.<br>
<p>
re: XFS, I've been using linux since '94, so XFS support in the installer is very recent :-)<br>
<p>
I haven't been using Fedora for quite a while, my experiance to RedHat distros is mostly RHEL (and CentOS), which lag behind. I believe that RHEL5 still didn't support XFS in the installer<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470572/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470576"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 19:53 UTC (Sun)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/470576/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Very recent" is relative and not quite so accurate either.  All versions of Fedora installer have supported XFS. You just had to pass "xfs" as a installer option.  Same with jfs or reiserfs.  Atleast Fedora 10 beta onwards supports XFS as a standard option without having to do anything<br>
<p>
<a href="http://fedoraproject.org/wiki/Releases/10/Beta/ReleaseNotes#XFS">http://fedoraproject.org/wiki/Releases/10/Beta/ReleaseNot...</a><br>
<p>
That is early 2008.  RHEL 6 has xfs support as a add-on subscription and is supported within the installer as well IIRC. <br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470576/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 5, 2011 16:15 UTC (Mon)
                               by <b>wookey</b> (guest, #5501)
                              [<a href="/Articles/470635/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think dlang meant this: <br>
"..., for a long time (even after it was the default in Fedora), LVM did not"<br>
<p>
(I parsed it the way rahulsundaram did too - it's not clear).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470644"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 5, 2011 16:59 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470644/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yes, now that you say that ir reminds me that I was meaning that for a long time after LVM was the default on Fedora, it didn't support barriers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470644/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor478026"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2012 8:50 UTC (Mon)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/478026/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Old thread, I know. But why people are still talking about barriers I'm not sure. Abandoning the use of barriers was agreed upon at the 2010 Linux Filesystem Summit. And they completed their departure in 2.6.37, IIRC. Barriers are no more. They don't matter. They've been replaced by FUA, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/478026/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor471264"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 17:54 UTC (Thu)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/471264/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Barriers are there to control the write cache after data has been posted to the storage device, to ensure that the device doesn't report completion until the data is actually perminanely committed</font><br>
<p>
Surely what you're describing is a cache flush, not a barrier?<br>
<p>
A barrier is intended to control the *order* in which two pieces of data are written, not when or even *if* they're written. A barrier *could* be implemented by issuing a cache flush in between writes (maybe this is what's commonly done in practice?) but in that case you're getting slightly more than you asked for (ie. you're getting durability of the first write), with a corresponding performance impact.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471264/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471374"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 23:24 UTC (Thu)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/471374/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you are right, I may have misspoke.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471374/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor471767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 12:01 UTC (Mon)
                               by <b>jlokier</b> (guest, #52227)
                              [<a href="/Articles/471767/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe dlang is right.  You need to enable barriers even with battery-backed disk write cache.  If the storage device has a good implementation, the cache flush requests (used to implement barriers) will be low overhead.<br>
<p>
Some battery-backed disk write caches can commit the RAM to flash storage or something else, on battery power, in the event that the power supply is removed for a long time.  These systems don't need a large battery and provide stronger long-term guarantees.<br>
<p>
Even ignoring ext3's no barrier default, and LVM missing them for ages, there is the kernel I/O queue (elevator) which can reorder requests.  If the filesystem issues barrier requests, the elevator will send writes to the storage device in the correct order.  If you turn off barriers in the filesystem when mounting, the kernel elevator is free to send writes out of order; then after a system crash, the system recovery will find inconsistent data from the storage unit.  This can happen even after a normal crash such as a kernel panic or hard-reboot, no power loss required.<br>
<p>
Whether that can happen when you tell the filesystem not to bother with barriers depends on the filesystem's implementation.  To be honest, I don't know how ext3/4, xfs, btrfs etc. behave in that case.  I always use barriers :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471790"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 15:40 UTC (Mon)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/471790/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think these days any sensible fs actually waits for the writes to reach storage independent of barrier usage. The only different with barriers on/off is whether a FUA/barrier/whatever is sent to the device to force the device to write out the data.<br>
I am rather sure at least ext4 and xfs do it that way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471790/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 18:14 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/471819/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
no, jlokier is right, barriers are still needed to enforce ordering<br>
<p>
there is no modern filesystem that waits for the data to be written before proceeding. Every single filesystem out there will allow it's writes to be cached and actually written out later (in some cases, this can be _much_ later)<br>
<p>
when the OS finally gets around to writing the data out, it has no idea what the application (or filesystem) cares about, unless there are barriers issued to tell the OS that 'these writes must happen before these other writes'<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 18:15 UTC (Mon)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/471820/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The do wait for journaled data uppon journal commit. Which is the place where barriers are issued anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471829"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 18:39 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/471829/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
issueing barriers is _how_ the filesystem 'waits'<br>
<p>
it actually doesn't stop processing requests and wait for the confirmation from the disk, it issues a barrier to tell the rest of the storage stack not to reorder around that point and goes on to process the next requrest and get it in flight.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471829/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471830"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 18:53 UTC (Mon)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/471830/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Err. Read the code. xfs uses io completion callbacks and only relies on the contents of the journal after the completion returned. (xlog_sync()-&gt;xlog_bdstrat()-&gt;xfs_buf_iorequest()-&gt;_xfs_buf_ioend()).<br>
jbd does something similar but I don't want to look it up unless youre really interested.<br>
<p>
It worked a littlebit more like you describe before 2.6.37 but back then it waited if barriers were disabled.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471830/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 13, 2011 13:35 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/471951/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, this is clear as mud :) guess I'd better do some code reading and figure out wtf the properties of the system actually are...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471952"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 13, 2011 13:38 UTC (Tue)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/471952/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you want I can give you the approx calltrace for jbd2 as well, I know it took me some time when I looked it up...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471952/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 11:00 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470478/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You got that backwards. Filesystems do not become community-supported because they are chosen as a default (though if they are common, community members *are* more likely to show an interest in them). It is more that they are very unlikely ever to be chosen as a default by anyone except their originator unless they are already community-supported.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470499"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 18:06 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/470499/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Reiserfs3 being an example of that, being widely shipped but unsupported and unsupportable by the community leading to more stringent support guidelines for future code acceptance<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470499/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor470505"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 20:33 UTC (Sat)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470505/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Again, you have this backwards.  Ext3 was chosen in part because it was a community-supported file system.    From the very beginning, ext2 and ext3 had support from a broad set of developers, at a large number of ***different*** companies.   Of the original three major developers of ext2/ext3 (Remy Card, Stephen Tweedie, and myself), only Stephen worked at Red Hat.  Remy was a professor at a university in France, and I was working at MIT as the technical lead for Kerberos.   And there were many other people submitting contributions to ext3 and choosing to use ext3 in embedded products (including Andrew Morton, when he worked at Digeo between 2001 and 2003).<br>
<p>
ext3 was first supported by RHEL as of RHEL 2 which was released May 2003 --- and as you can see from the dates above, we had developers working at a wide range of companies, thus making it a communuty-supported distribution, long before Red Hat supported ext3 in their RHEL product.  In contrast, most of the reiserfs developers worked at Namesys (with a one or two exceptions, most notably Chris Mason when he was at SuSE), and most of the XFS developers worked at SGI.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470505/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor470636"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 5, 2011 16:29 UTC (Mon)
                               by <b>wookey</b> (guest, #5501)
                              [<a href="/Articles/470636/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm very surprised by the assertion that XFS is intended to be safe against power failures, as it directly condtradicts my experience. I found it to be a nice filesystem with some cool features (live resizing was really cool back circa 2005/6), but I also found (twice, on different machines) that it was emphatically not designed for systems without UPS. In both caces a power failure caused significant filesystem corruption (those machines had lvm as well as XFS).<br>
<p>
When I managed to repair them I found that many files had big blocks of zeros in them - essentially anything that was in the journal and had not been written. Up to that point I had naively thought that the point of the journal was to keep actual data, not just filesystem metadata.  Files that have been 'repaired' by being silently filled with big chunks of zeros did not impress me. <br>
<p>
So I now believe that XFS is/was good, but only on properly UPSed servers. Am I wrong about that?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470636/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470645"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 5, 2011 17:03 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470645/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
for a very long time, LVS did not support barriers, which means that _any_ filesystem running on top of LVM could not be safe.<br>
<p>
XFS caches more stuff than ext does, so a crash looses more stuff.<br>
<p>
so XFS or ext* with barriers disabled is not good to use, For a long time, running these things on top of LVM had the side effect of disabling barriers, it's only recently that LVM gained the ability to support them<br>
<p>
JFS is not good to use (as it doesn't have barriers at all)<br>
<p>
note that when XFS is designed to be safe, that doesn't mean that it won't loose data, just that the metadata will not be corrupt.<br>
<p>
the only way to not loose data in a crash/power failure is to do no buffering at all, and that will absolutely kill your performance (and we are talking hundreds of times slower, not just a few percentage points)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470645/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 2:58 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470050/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The main reason JFS wasn't accepted in the community was because all of the developers worked at IBM.   Very few people in the other distributions understood it, which meant that there weren't people who could support at the distro's.   One of the things that I've always been very happy about is the fact that developers for ext2/3/4 come from many, many different companies.<br>
<p>
JFS was a very good file system, and at the time when it was released, it certainly was better than ext3.  But there's a lot more to having a successful open source project beyond having the best technology.  The fact that ext2 was well understood, and had a mature set of file system utilities, including tools like "debugfs", are one of the things that do make a huge difference towards people accepting the technology.<br>
<p>
At this point, though, ext4 has a number of features which JFS lacks, including delayed allocation, fallocate, punch, and TRIM/discard support.   These are all features which I'm sure JFS would have developed if it still had a development community, but when IBM decided to defund the project, there were few or no developers who were not IBM'ers, and so the project stalled out.<br>
<p>
---<br>
<p>
People who upgrade in place from ext3 to ext4 will see roughly half the performance increase compared to doing a backup, reformat to ext4, and restore operation.   But they *do* see a performance increase if they do an upgrade-in-place operation.  In fact, even if they don't upgrade the file system image, and use ext4 to mount an ext2 file system image, they will see some performance improvement.   So this gives them flexibility, which from a system administrator's point of view, is very, very important!<br>
<p>
---<br>
<p>
Finally, I find it interesting that you consider OCFS2 "pretty good" in non-clustered mode.   OCFS2 is a fork of the ext3 code base[1] (it even uses fs/jbd and now fs/jbd2) with support added for clustered operation, and with support for extents (which ext4 has as well, of course).   It doesn't have delayed allocation.   But ext4 will be better than ocfs2 in non-clustered mode, simply because it's been optimized for it.  The fact that you seem to think OCFS2 to be "pretty good", while you don't seem to think much about ext4 makes me wondered if you have some pretty strong biases against the ext[234] file system family.<br>
<p>
[1] Ocfs2progs is also a fork of e2fsprogs.   Which they did with my blessing, BTW. I'm glad to see that the code that has come out of the ext[234] project have been useful in so many places.  Heck, parts of the e2fsprogs (the UUID library, which I relicensed to BSD for Apple's benefit) can be found in Mac OS X!   :-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470229"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 20:25 UTC (Thu)
                               by <b>sniper</b> (guest, #13219)
                              [<a href="/Articles/470229/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Small correction.<br>
<p>
ocfs2 is not a fork of ext3 and neither is ocfs2-tools a fork of e2fsprogs. But both have benefited a _lot_ from ext3. In some instances, we copied code (non-indexed dir layout). In some instances, we used a different approach because of collective experience (indexed dir). grep ext3 fs/ocfs2/* for more.<br>
<p>
The toolset has a lot more similarities to e2fsprogs. It was modeled after it because it is well designed and to also allow admins to quickly learn it. The tools even use the same parameter names where possible. grep -r e2fsprogs * for more.<br>
<p>
BTW, ocfs2 has had bigalloc (aka clusters) since day 1, inline-data since 2.6.24 and metadata checksums since 2.6.29. Yes, it does not have delayed allocations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470229/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor492329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2012 19:30 UTC (Fri)
                               by <b>fragmede</b> (guest, #50925)
                              [<a href="/Articles/492329/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OCFS2 does have snapshots though, which is why I use it. :)<br>
<p>
LVM snapshots are a joke if you have *lots* of snapshots, though I haven't looked at btrfs snapshots since it became production ready.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/492329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor470051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 3:22 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470051/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One other thought.   At least at the beginning ext4's raison d'etre (its reason for being) was as a stopgap file system until btrfs could be ready.   We started with ext3 code which was proven, solid code, and support for delayed allocation, multiblock allocation, and extents had also been in use for quite a while in Clustrefs's Lustre product.   So that code wasn't exactly new, either.   What I did was integrate Cluterfs's contributions, and then worked on stablizing them so that we would have something that was better than ext3 ready in the short term.<br>
<p>
At the time when I started working on ext4, XFS developers were all mostly still working for SGI, so there was a similar problem with the distributions not having anyone who could support or debugfs XFS problems.   This has changed more recently, as more and more XFS developers have left (volunteraliy or involuntarily) SGI and joined companies such as Red Hat.  XFS has also improved its small file performance, which was something it didn't do particularly well simply because SGI didn't optimize for that; its sweet spot was and still is really large files on huge RAID arrays.<br>
<p>
One of the reasons why I felt it was necessary to work on ext4 was that everyone I talked to who had created a file system before in the industry, whether it was GPFS (IBM's cluster file system), or Digital Unix's advfs, or Sun's ZFS, gave estimates of somewhere between 50 to 200 person years worth of effort before the file system was "ready".   Even if we assume that open source development practices would make development go twice as fast, and if we ignore the high end of the range because cluster file systems are hard, I was skeptical it would get done in two years (which was the original estimate) given the number of developers it was likely to attract.   Given that btrfs started at the beginning of 2007, and here we are almost at 2012, I'd say my fears were justified.<br>
<p>
At this point, I'm actually finding that ext4 has found a second life as a server file system in large cloud data centers.   It turns out that if you don't need the fancy-shamcy features that Copy-on-Write file systems give you, they aren't free.  In particular, ZFS has truly a prodigious appetite for memory, and one of the things about cloud servers is that in order for them to make economic sense, you try to pack as many jobs or VM's on them, so they are constantly under memory pressure.  We've done some further optimizations so that ext4 performs much better when under memory pressure, and I suspect at this point that in a cloud setting, using a CoW file system may simply not make sense.<br>
<p>
Once btrfs is ready for some serious benchmarking, it would be interesting to benchmark it under serious memory pressure, and see how well it performs.   Previous CoW file systems, such as BSD's lfs two decades ago, and ZFS more recently, have needed a lot of memory to cache metadata blocks, and it will be interesting to see if btrfs has similar issues.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 19:36 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470227/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      I shouldn't respond to this troll-bait, but nonetheless...
<blockquote>
The big problem with 'ext4' is that its only reason to be is to allow Red Hat customers to upgrade in place existing systems, and what Red Hat wants, Red Hat gets (also because they usually pay for that and the community is very grateful).
</blockquote>
Interesting. tytso wasn't working for RH when ext4 started up, and still isn't working for them now. So their influence must be more subtle.
<p>
I also see that I was making some sort of horrible mistake by installing ext4 on all my newer systems, but you never make clear what that mistake might have been.
<blockquote>
In particular JFS should have been the "default" Linux filesystem instead of ext[23] for a long time. Not making JFS the default was probably the single worst strategic decision for Linux (but it can be argued that letting GKH near the kernel was even worse).
</blockquote>
Ah, yeah. Because stable kernels, USB support, mentoring newbies, the driver core, -staging... all these things were <i>bad</i>.
<p>
I've been wracking my brains and I can't think of one thing Greg has done that has come to public knowledge and could be considered bad. So this looks like groundless personal animosity to me.
      
          <div class="CommentReplyButton">
            <form action="/Articles/470227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470228"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 19:41 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/470228/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I've been wracking my brains and I can't think of one thing Greg has done that has come to public knowledge and could be considered bad. So this looks like groundless personal animosity to me.</font><br>
Also, uhm. Didn't he work for Suse?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470228/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470324"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 11:35 UTC (Fri)
                               by <b>alankila</b> (guest, #47141)
                              [<a href="/Articles/470324/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I dimly recall that the animosity originated from the work with udev, and the removal of devfs. Since I personally don't care one bit about this issue, I have hard time now reconstructing the relevant arguments, but my guess is that some people really hate the idea that a system needs more than just kernel to be useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470324/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470397"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 18:40 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470397/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
udev is prone to creating frothing-at-the-mouth even in otherwise reasonable people, due to the udev authors' patent lack of concern for backward compatibility. Twice now they've broken existing systems without so much as a by-your-leave: firstly with the massive migration of all system-provided state out of /etc/udev.d/rules into /lib/udev/rules: what, you customized them? sucks to be you, now you have to customize them before *building* udev, and more recently with the abrupt movement of /sbin/udevd into /lib/udev without even leaving behind a symlink! Oh, you were starting that at bootup and relying on it to be there? Sorry, we just broke your bootup, your own fault for not reading the release notes! Hope you don't need to downgrade!<br>
<p>
(Yes, I read the release notes, so didn't fall into these traps, but FFS, at least the latter problem was trivial to work around -- one line in the makefile to drop a symlink in /sbin -- and they just didn't bother.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470397/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 23:40 UTC (Fri)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470438/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>As to <tt>udev</tt> some people dislike smarmy shysters who replace well designed working subsystems seemingly for the sole reason of making a political landgrab, because the replacement has both more kernel complexity <b>and</b> more userland complexity and less stability.</p>

<p>The key features of <tt>devfs</tt> were that it would populate automatically <tt>/dev</tt> from the kernel with basic device files (major, minor) and then use a very simple userland daemon to add extra aliases as required.</p>

<p>It turns out that after several attempts to get it to work <tt>udev</tt> adds to <tt>/sys</tt> from inside the kernel exactly the same information, so there has been no migration of functionality from kernel to userspace:</p>

<pre>$ ls -ld /dev/tty9
crw--w---- 1 root tty <b>4, 9</b> 2011-11-28 14:03 /dev/tty9
$ cat /sys/class/tty/tty9/dev
<b>4:9</b></pre>

<p>And the userland part is also far more complex and unstable than <tt>devfsd</tt> ever was (for example <tt>devfs</tt> did not require cold start).</p>

<p>And <tt>udev</tt> is just the most shining example of a series of similar poor decisions (which however seem to have been improving a bit with time).</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 3:16 UTC (Sat)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/470461/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure that is an accurate portrayal of what happened, on this planet at least.  My recollection from the time is that there were fundamental technical problems with the devfs implementation which is why it was redone into udev.  I think those problems were some inherent race conditions on device add/removal, plus concerns about how much policy about /dev file names, permissions, etc was hard coded into the kernel and unmodifyable by an end user or sysadmin.  That is just my recollection.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470481"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 11:07 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470481/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The latter is doubly ironic now that udev forbids you from changing the names given to devices by the kernel. (You can introduce new names, but you can't change the kernel's anymore.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470481/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor470467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 4:04 UTC (Sat)
                               by <b>alankila</b> (guest, #47141)
                              [<a href="/Articles/470467/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To your specific example: obviously the kernel is going to have some kind of (generated) name for a device, and to know the major/minor number pair which is the very thing that faciliates the communication between userspace and kernel... But udev is still controlling things like permissions and aliases for those devices where necessary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor470443"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 0:12 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470443/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p><i>tytso wasn't working for RH when ext4 started up, and still isn't working for them now. So their influence must be more subtle. </i></p>

<p>Quite irrelevant: a lot of file system were somebody's hobby file systems, but they did not achieve prominence and instant integration into mainline even if <a href="http://lkml.org/lkml/2006/6/28/454">rather alpha</a>, and RedHat did not spend enormous amounts of resources quality assuring them to make them production ready either, and quality assurance is a pretty vital detail for file systems, as the Namesys people discovered.</p>

<p>Pointing to <tt>tytso</tt> is just misleading. Also because <tt>ext4</tt> really was seeded by Lustre people <a href="http://ext2.sourceforge.net/2005-ols/2005-ols-ext3.html">before <tt>tytso</tt> became active on it</a> in his role as <tt>ext3</tt> curator (and in 2005, which is 5 years later than when JFS became available).</p>

<p>Similarly for BTRFS, it has been initiated by Oracle (who have an <tt>ext3</tt> installed base), but its main appeal is still as the next inplace upgrade on the Red Hat installed base (thus the interest in trialing it in Fedora, where EL candidate stuff is mass tested), even if for once it is not just an extension of the <tt>ext</tt> line but has some interesting new angles.</p>

<p>But considering <tt>ext4</tt> on its own is a partial view; one must consider the pre-existing JFS and XFS stability and robustness and performance, and from a technical point of view <tt>ext4</tt> is not that interesting (euphemism) and its sole appeal is inplace upgrades, and the widest installed based for that is RedHat, and to a large extent that could have been said of <tt>ext3</tt> too.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470443/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 0:52 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470452/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So you're blaming the Lustre people now? You do realise Lustre is not owned by Red Hat, and never was?<br>
<p>
And if you're claiming that btrfs is effectively RH-controlled merely because RH customers will benefit, then *everything* that happens to Linux must by your bizarre definition be RH-controlled. That's a hell of a conspiracy: so vague that the coconspirators don't even realise they're conspiring!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor492331"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2012 19:34 UTC (Fri)
                               by <b>fragmede</b> (guest, #50925)
                              [<a href="/Articles/492331/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I though *Oracle* was a/the big contributor to btrfs...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/492331/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor470504"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 19:45 UTC (Sat)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470504/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, and I've always been careful to give the Lustre folk credit for the work that they did between 2003 and 2006 extending ext3 to add support for delayed allocation (which JFS didn't have), multi-block allocation (which JFS didn't have) and extents (OK, JFS had extents). <br>
<p>
But you can't have it both ways.  If that code had been in use by paying Lustre companies, then it's hardly alpha code, wouldn't you agree?<br>
<p>
And why did the Lustre developers at Clustrefs chose ext3?   Because the engineers they hired knew ext3, since it was a community-supported distribution, whereas JFS was controlled by a core team that was all IBM'ers, and hardly anyone outside of IBM was available who knew JFS really well.<br>
<p>
But as others have already pointed out, there was no grand conspiracy to pick ext2/3/4 over its competition.   It won partially due to its installed base, and partially because of the availability of developers who understood it (and books written about it, etc., etc., etc.)    The way you've been writing you seem to think there was some secret cabal (at Red Hat?) that made these decisions, and there was a "mistake" because they didn't chose your favorite file systems.<br>
<p>
The reality is that file systems all have trade-offs, and what's good for some people are not so great for others.   Take a look at some of the benchmarks at btrfs.boxacle.net; they're a bit old, but they are well done, and they show that across many different workloads at that time (2-3 years ago) there was no one single file system that was the best across all of the different workloads.   So anyone who only uses a single workload, or a single hardware configuration, and tries to use that to prove that their favorite file system is the "best" is trying to sell you something, or who is a slashdot kiddie who has a fan-favorite file system.   The reality is a lot more complicated than that, and it's not just about performance.   (Truth be told, for many/most uses cases, the file system is not the bottleneck.)  Issues like availability of engineers to support the file system in a commercial product, the maturity of the userspace support tools, ease of maintainability, etc. are at least as important if not more so.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470504/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470506"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 20:43 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470506/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
at the time ext3 became the standard, JFS and XFS had little support (single vendor) and were both 'glued on' to linux with heavy compatibility layers.<br>
<p>
Add to this the fact that you did not need to reformat your system to use ext3 when upgrading, and the fact that ext3 became the standard (taking over from ext2, which was the prior standard) is a no-brainer, and no conspiracy.<br>
<p>
In those days XFS would outperform ext3, but only in benchmarks on massive disk arrays (which were even more out of people's price ranges at that point then they are today)<br>
<p>
XFS was scalable to high-end systems, but it's low-end performance was mediocre<br>
<p>
looking at things nowdays, XFS has had a lot of continuous improvement and integration, both improving it's high-end performance and reliability, and improving it's low-end performance without loosing it's scalability. There are also more people, working for more companies supporting it, making it far less of a risk today, with far more in the way of upsides.<br>
<p>
JFS has received very little attention after the initial code dump from IBM, and there is now nobody actively maintaining/improving it, so it really isn't a good choice going forward.<br>
<p>
reiserfs had some interesting features and performance, but it suffered from some seriously questionably benchmarking (the one that turned me off to it entirely was a spectacular benchmarking test that reiserfs completed in 20 seconds that took several minutes on ext*, but then we discovered that reiserfs defaulted to a 30 second delay before writing everything to disk, so the entire benchmark was complete before any day started getting written to disk, after that I didn't trust anything that they claimed), and a few major problems (the fsck scrambling is a huge one). It was then abandoned by the developer in favor of the future reiserfs4, with improvements that were submitted being rejected as they were going to be part of the new, incompatible filesystem.<br>
<p>
ext4 is in large part a new filesystem who's name just happens to be similar to what people are running, but it has now been out for several years, with developers who are responsive to issues, are a diverse set (no vendor lock-in or dependencies) and are willing to say where the filesystem is not the best choice.<br>
<p>
btrfs is still under development (the fact that they don't yet have a fsck tool is telling), is making claims that seem too good to be true, and have already run into several cases where they have pathalogical behavior and have had to modify things significantly. I wouldn't trust it for anything other than non-critical personal use for another several years.<br>
<p>
<p>
as a result, I am currently using XFS for the most part, but once I get a chance to do another round of testing, ext4 will probably join it. I have a number of systems that have significant numbers of disks, so XFS will probably remain in use.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470506/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 1:12 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
ext4 is in large part a new filesystem who's name just happens to be similar to what people are running
</blockquote>
ext4 is ext3 with a bunch of new extensions (some incompatible): indeed, initially the ext4 work was going to be done to ext3, until Linus asked for it to be done in a newly-named clone of the code instead. It says a lot for the ext2 code and disk formats that they've been evolvable to this degree.

      
          <div class="CommentReplyButton">
            <form action="/Articles/470519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470060"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 3:46 UTC (Thu)
                               by <b>eli</b> (guest, #11265)
                              [<a href="/Articles/470060/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You mention that you have backups.  Have you done a bit-wise comparison of the corrupted files versus the backups to see how much was actually corrupted and if there might be some pattern to the corruption in the file?  Given the points made about bit-flipping vs blocks dropped (or replaced by something else), a "cmp -l" might help you find the root cause.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470060/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2011 1:06 UTC (Tue)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/470701/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Thanks for the suggestion; I'll give it a try sometime if/when I find a corrupt OGG file.</p>

<p>Just to bring some closure to this discussion, I wish to make a few points:</p>

<ol>

<li>In 13 years of using Linux, I've <b><i>not once ever</i></b> experienced data corruption on any filesystem running in Linux (prior to the random OGG errors I encountered a few months ago on ext4 and LVM).  This includes ext2, ext3, Reiser(3)fs, and Linux's fat and vfat implementations.  (Hardware failures are not included, but I've been fortunate not to have much experience with those.)</li>

<li>My existing hard drives are error-free (according to <tt>smartctl -l</tt> as suggested above).  I have two IDE disks and two SATA disks, all Seagate brand (not that this matters, but I do admire their 5-year warranty).</li>

<li>My OGG files are all on their own filesystem/partition (ext4), for which only root has write privileges, and thus my non-privileged account can't accidentally be writing to this filesystem (or so I'd hope).</li>

<li>I've since created an <tt>oggcheck.sh</tt> script which scans the whole filesystem containing the OGG files and reports any errors found to a log.</li>

<li>Running this script lately (within past 1 month or so) has yielded no errors, so I'm wondering if (hoping that) this is some weird anomaly which has passed.</li>

<li>Any errors experienced on the OGG filesystem would imply the <i>possibility</i> of similar errors on my <tt>/</tt> filesystem (which includes <tt>/home</tt>), but I haven't noticed any such errors as of yet (and I hope that none exist!).</li>

<li>I'm all too eager to blame this on ext4 or LVM (or the combination of both), but I'm <i>equally</i> eager to blame this on some strange operator error.  Trust me, I'm good at creating these!</li>

</ol>

<p>Many thanks to everyone's discussion above; I always learn a lot from the comments here on LWN.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor471230"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 15:34 UTC (Thu)
                               by <b>lopgok</b> (guest, #43164)
                              [<a href="/Articles/471230/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You should generate a checksum for each file in your filesystem.<br>
I wrote a trivial python script to generate a checksum file for each directory's files. If you run it, and it finds a checksum file, it checks that the files in the directory match the checksum file, and if they don't it reports that.<br>
<p>
I wrote it when I had a serverworks chipset on my motherboard that corrupted IDE hard drives when DMA was enabled. However, the utility lets me know there is no bit rot in my files.<br>
<p>
It can be found at <a rel="nofollow" href="http://jdeifik.com/">http://jdeifik.com/</a> , look for 'md5sum a directory tree'. It is GPL3 code. It works independently from the files being checksummed and independently of the file system. I have found flaky disks that passed every other test with this utility.<br>
<p>
The other thing that can corrupt files is memory errors. Many new computers do not support ECC memory. If you care about data integrity, you should use ECC memory. Intel has this feature for their server chips (xeons) and AMD has this feature for all ofgf their processors (though not all motherboard makers support it).<br>
It is very cheap insurance.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471230/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471245"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 16:24 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/471245/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
It is very cheap insurance.
</blockquote>
Look at the price differential between the motherboards and CPUs that support ECCRAM and those that do not. Now add in the extra cost of the RAM.
<p>
ECCRAM is worthwhile, but it is <i>not</i> at all cheap once you factor all that in.
      
          <div class="CommentReplyButton">
            <form action="/Articles/471245/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471263"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 17:47 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/471263/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whether or not it is cheap or not depends on how much you value your data.<br>
<p>
It's like people who balk at spending an extra $200 to mirror their data, or to provide a hot spare for their RAID array.   How much would you be willing to spend to get back your data after you discover it's been vaporized?   What kind of chances are you willing to take against that eventuality happen?<br>
<p>
It will vary depending on each person, but traditional people are terrible and figuring out cost/benefit tradeoffs.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471263/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 19:10 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/471283/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yep. That's why I said it was worthwhile. But 'very cheap'? Not unless 'cheap' means 'costs much more money than other alternatives'. Yes, it has benefits, but immediate financial return is not one of them.<br>
<p>
(Also, last time I tried you couldn't buy a desktop with ECCRAM for love nor money. Servers, sure, but not desktops. So of course all my work stays on the server with battery-backed hardware RAID and ECCRAM, and I just have to hope the desktop doesn't corrupt it in transit.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2011 0:57 UTC (Fri)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/471378/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I have under my desk at work (and I'm quite happy with it) is the Dell T3500 Precision Workstation, which supports up to 24GB of ECC or non-ECC memory.   It's not a mini-ATX desktop, but it's definitely not a server, either.<br>
<p>
I really like how quickly I can build kernels on this machine.  :-)<br>
<p>
I'll grant it's not "cheap" in absolute terms, but I've always believed that skimping on a craftsman's tools is false economy.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471413"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2011 7:41 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/471413/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Dell T3500 Precision Workstation, which supports up to 24GB of ECC or non-ECC memory. </font><br>
<p>
I have the same machine. Oddly enough, it only supports 12GB of non-ECC memory, at least according to Dell's manual. How does that happen?<br>
<p>
(Also, Intel's processor datasheet claims that several hundred gigabytes of either ECC or non-ECC memory should be supported using the integrated memory controller. I wonder why Dell's system supports less.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471413/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor471449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2011 12:40 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/471449/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, agreed. I've seen multiple rounds of friends deciding to save money on a cheap PC, trying to do real work on it, and finding the result a crashy erratic data-corrupting horror that is almost impossible to debug unless you have a second identical machine to swap parts out of... and losing years of working time to these unreliable nightmares. I pay a bit more (well, OK, quite a lot more) and those problems simply don't happen. I don't think this is ECCRAM, though: I think it's simply a matter of tested components with a decent safety margin rather than bargain-basement junk. <br>
<p>
EDAC support for my Nehalem systems landed in mainline a couple of years ago but I'll admit to never having looked into how to get it to tell me what errors may have been corrected, so I have no idea how frequent they might be.<br>
<p>
(And if it didn't mean dealing with Dell I might consider one of those machines myself...)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor471450"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2011 13:53 UTC (Fri)
                               by <b>james</b> (subscriber, #1325)
                              [<a href="/Articles/471450/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
AMD processors since the Athlon 64 all support ECC, and most Asus AMD boards (even cheap ones) wire the lines up.<br>
<p>
Even ECC memory isn't that much more expensive: Crucial do a 2x2GB ECC kit for 27 + VAT ($42 in the US) against 19 ($30).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471450/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471460"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2011 15:19 UTC (Fri)
                               by <b>lopgok</b> (guest, #43164)
                              [<a href="/Articles/471460/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree. The last 3 motherboards I have bought were for AMD processors. I bought a 3 core phenom II, an asus motherboard, and 4gb of ECC ram for around $200. I have no idea why Intel only supports ECC on their server motherboards. For me, this is a critical feature. In my experience, many Gigabyte motherboards do not support ECC, so check the motherboard manual, or list of supported memory before buying. In fact AMD supports IBM's Chipkill technology which will detect 4 bit errors and correct 3 bit errors. In addition, my Asus motherboards support memory scrubbing, which can help detect memory errors in a timely fashion.<br>
<p>
If you buy assembled computers and can't get ECC support without spending big bucks, it is time to switch vendors.<br>
<p>
It is true that ECC memory is more expensive and less available than non-ECC memory, but the price difference is around 20% or so, and Newegg and others sell a wide variety of ECC memory. Mainstream memory manufacturers, including Kingston sell ECC memory.<br>
<p>
Of course, virtually all server computers come with ECC memory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471460/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor475537"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 15, 2012 3:45 UTC (Sun)
                               by <b>sbergman27</b> (guest, #10767)
                              [<a href="/Articles/475537/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mount with "nodelalloc". I have servers which host quite a few Cobol C/ISAM files. I was uncomfortable with the very idea of delayed allocation. But the EXT4 delayed allocation cheer-leading section, headed by Ted T'So, convinced me that after 2.6.30, it would be OK.<br>
<p>
The very first time we had an power failure, with a UPS with a bad battery, we experienced corruption in several files of those files. Never *ever* *ever* had we experienced such a thing with EXT3. I immediately added nodelalloc as a mount option, and the EXT4 filesystem now seems as resilient as EXT3 ever was. Note that at around the same time as 2.6.30, EXT3 was made less reliable by adding the same 2.6.30 patches to it, and making data=writeback the default journalling mode. So if you do move back to EXT3, make sure to mount with data=journal.<br>
<p>
BTW, I've not noted any performance differences mounting EXT4 with nodelalloc. Maybe in a side by side benchmark comparison I'd detect something.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/475537/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor538945"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2013 10:23 UTC (Tue)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/538945/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For LVM and write caching setup generally, see <a href="http://serverfault.com/questions/279571/lvm-dangers-and-caveats">http://serverfault.com/questions/279571/lvm-dangers-and-c...</a> <br>
<p>
You might also like to try ZFS or btrfs - both have enough built-in checksumming that they should detect issues sooner, though in this case Ogg's checksumming is doing that for audio files.  With a checksumming FS you could detect whether the corruption is in RAM (seen when writing to file) or on disk (seen when reading from file).  ZFS also does periodic scrubbing to validate checksums.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/538945/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor469861"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 1:07 UTC (Wed)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/469861/">Link</a>] (39 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
bigalloc sounds like it could be really good for SSDs.<br>
<p>
Especially if mkfs could somehow align the block clusters to the flash page size.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469861/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469883"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 8:35 UTC (Wed)
                               by <b>ebirdie</b> (guest, #512)
                              [<a href="/Articles/469883/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
...and bigalloc sounds good for volumes holding VM image files or other sparse files.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469883/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 21:05 UTC (Wed)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470002/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sparse VM virtual disks are usually a very big performance mistake. There is always the option to have VM virtual disks as logical volumes under LVM2, which usually is enormously better than as large files under any filesystem.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 23:04 UTC (Thu)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/470270/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Did you benchmark that? I tried it once under VMware and I was surprised to find out that the opposite was true. It may of course have been a fluke or a result of some VMware-specific behaviour and I did not pursue it further. I'm just interested in your findings.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 0:34 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470447/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>I had to completely re-vase a set of virtual machines that were installed by some less thoughtful predecessor into growable VMware virtual disks. Several virtual disks had several hundred thousand extents (measured with <tt>filefrag</tt>) and a couple had over a million, all mixed up randomly on the real disk. Performance was horrifying (it did not help that there were another two absurd choices in the setup).</p>

<p>I ended up with just the mostly readonly filesystem in the VM disk, and all the writable subtrees mounted via NFS from the host machine, which was much faster. In particular during backups, because I could run the backup program (BackupPC based on RSYNC) on the real machine and remote backup is a very high IO load operation, and running it inside the virtual machines on a virtual disk was much much slower.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470799"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2011 21:26 UTC (Tue)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/470799/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sorry, I didn't type that clearly. I meant using LVM volumes as virtual disks, not using sparse virtual disks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470799/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor469991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 20:22 UTC (Wed)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/469991/">Link</a>] (33 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No journaled filesystem is good for SSDs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470009"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 21:33 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/470009/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      Take a look <a href="http://kernelnewbies.org/Linux_2_6_29#head-012b42d4dad6cf4af587e30c4738fc7b0904b03e">here</a>. Note the linux version number...
      
          <div class="CommentReplyButton">
            <form action="/Articles/470009/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470021"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 23:16 UTC (Wed)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/470021/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Google stores it's data on ext4 without journal:<br>
<p>
<a href="http://www.youtube.com/watch?v=Wp5Ehw7ByuU">http://www.youtube.com/watch?v=Wp5Ehw7ByuU</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470021/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 1:01 UTC (Thu)
                               by <b>SLi</b> (subscriber, #53131)
                              [<a href="/Articles/470039/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then again Google normally has three copies of every piece of important data on different computers, so they're not too concerned about failures due to not journaling.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470044"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 1:59 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470044/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
journaling (as used by default on every distro I know) almost never prevents data loss, at least not directly. All that journaling does is make it so that the filesystem metadata makes sense, the metadata may be pointing at garbage data, but you aren't as likely to get the metadata corrupted in such a way that continues use of the filesystem after a failure will corrupt existing data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470044/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470056"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 3:29 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470056/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
fsync() in combination with a journal will protect against data loss.<br>
<p>
But yes, a journal by itself has as its primary feature avoiding long fsck times.  One nice thing with ext4 is that fsck times are reduced (typically) by a factor of 7-12 times.   So a TB file system that previously took 20-25 minutes might now only take 2-3 minutes.<br>
<p>
If you are replicating your data anyway because you're using a cluster file system such as Hadoopfs, and you're confident that your data center has appropriate contingencies that mitigate against a simultaneous data-center wide power loss event (i.e., you have bat, and diesel generators, etc., and you test all of this equipment regularly), then it may be that going without a journal makes sense.   You really need to know what you are doing though, and it requires careful design both at the hardware level, the data center level, as well as the storage stack above the local disk file system.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470056/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 18:55 UTC (Fri)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470403/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><p>One nice thing with ext4 is that fsck times are reduced (typically) by a factor of 7-12 times. So a TB file system that previously took 20-25 minutes might now only take 2-3 minutes.</p></blockquote>

That is the case only for fully undamaged filesystems, that is the common case of a periodic filesystem check. I have never seen any reports that the new 'e2fsck' is faster on damaged filesystems too. And since a damaged 1.5TB 'ext3' filesystem was reported take 2 months to 'fsck', even a factor of 10 is not going to help a lot.
      
          <div class="CommentReplyButton">
            <form action="/Articles/470403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470407"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 19:10 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470407/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've had to do fsck on multi-TB filesystems after unclean shutdowns, they can take a long time, but time measured in hours (to a couple days for the larger ones). I suspect that if you are taking months, you have some other bottleneck in place as well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470407/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 0:40 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470449/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>An <q>unclean shutdown</q> is usually not that <q>damaged</q>, which can however happen with a particularly bad unclean shutdown (lots of stuff in flight, for example on a wide RAID) or RAM/disk errors. The report I saw was not for a "enterprise" system with battery, ECC and a redundant storage layer.<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor470422"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 21:41 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470422/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This has been wrong for years. As long as your filesystem was built with the uninit_bg option (which it is by default), block groups which have never been used will not need to be fscked either, hugely speeding up passes 2 and 5 (at the very least).<br>
<p>
Fill up the fs, even once, and this benefit goes away -- but a *lot* of filesystems sit for years mostly empty. fscking those filesystems is very, very fast these days (I've seen subsecond times for mostly-empty multi-Tb filesystems).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470422/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470433"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 22:45 UTC (Fri)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470433/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We could fix things so that as you delete files from a full file system, we reduce the high watermark field for each block group's inode table, which would restore the speedups caused by needing to scan the entire inode table.  I haven't bothered to do this, but I'll add it to my todo list.  (Or someone can send me a patch; it would be trivial to do this at e2fsck, but we could do it in the kernel, too.)<br>
<p>
Not all of the improvements in fsck time come from being able to skip reading portions of the inode table.   Extent tree blocks are also far more efficient than indirect blocks, and so that contributes to much of the speed improvements of fsck'ing an ext4 filesystem compared to an ext2 or ext3 file system.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470433/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And this is relevant to ext4... exactly how?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 23:35 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470440/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
We could fix things so that as you delete files from a full file system, we reduce the high watermark field for each block group's inode table
</blockquote>
That seems hard to me. It's easy to tell if you need to increase the high watermark when adding a new file: but when you delete one, how can you tell what to reduce the high watermark to without doing a fairly expensive scan?
      
          <div class="CommentReplyButton">
            <form action="/Articles/470440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 4:25 UTC (Sun)
                               by <b>alankila</b> (guest, #47141)
                              [<a href="/Articles/470532/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just to get the argument out in the open, what is the basis for making this claim?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 4:38 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470534/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
for one thing, SSDs are write limited and have effectively zero seek time.<br>
<p>
journaling writes data twice with the idea being that the first one is to a sequential location that is going to be fast and then the following write will be to the random location<br>
<p>
with no seek time, you should be able to write the data to it's final location directly and avoid the second write. All you need to do is to enforce the ordering of the writes and you should be just as safe as with a journal, without the extra overhead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470537"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 4:49 UTC (Sun)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/470537/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn't that assume that you can perform a series of atomic operations that will result in a consistent filesystem? If that's not true then you still need to be able to indicate the beginning of a transaction, the contents of that transaction and the end of it. If all of that hits the journal first then you can play the entire transaction, but if you were doing it directly to the filesystem then a poorly timed crash might hit an inconsistent point in the middle.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470537/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470538"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 5:05 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470538/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that's true, but the trade-off is that you avoid writing the data to the journal, and then writing to the journal again to indicate the the transaction is finished.<br>
<p>
if what you are writing is metadata, it seems like it shouldn't be that hard, since there isn't that much metadata to be written.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470538/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470552"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 11:32 UTC (Sun)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470552/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem is that many file system operations require you to update more than one metadata block.   For example, when you move a file from one directory to another, you need to add a directory entry into one directory, and remove a directory entry from another.<br>
<p>
Or when you allocate a disk block, you need to modify the block allocation bitmap (or whatever data structure you use to indicate that the block is in use) and then update the data structures which map a particular inode's logical to physical block map.<br>
<p>
Without a journal, you can't do this atomically, which means the state of the file system is undefined after a unclean/unexpected shutdown of the OS.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470552/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470565"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 17:02 UTC (Sun)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/470565/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed. If there were an efficient way to guarantee consistency without a journal there'd be a significant market for it, namely in databases. Journals are a well understood and effective way of managing integrity of complicated disk structures. There are other ways, but journaling beats the others on a number of fronts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470565/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470700"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2011 0:40 UTC (Tue)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/470700/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is an efficient way to guarantee consistency without a journal.  Soft updates.  See <a href="http://en.wikipedia.org/wiki/Soft_updates">http://en.wikipedia.org/wiki/Soft_updates</a>.  The main disadvantage of soft updates is that the code seems to be more complex.<br>
<p>
Soft updates would not work for databases, because database operations often need to be logged "logically" rather than "physically."  For example, when you encounter an update statement that modifies every row of the table, you just want to add the update statement itself to the journal, not the contents of every row.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470700/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2011 1:24 UTC (Tue)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470704/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problems with Soft Updates are quite adequately summed up here, by Val Aurora (formerly Henson): <a href="http://lwn.net/Articles/339337/">http://lwn.net/Articles/339337/</a><br>
<p>
My favorite line from that article is "...and then I turn to page 8 and my head explodes."<br>
<p>
The *BSD's didn't get advanced features such as Extended Attribute until some 2 or 3 years after Linux.  My theory why is that it required someone as smart as Kirk McKusick to be able to modify UFS with Soft Updates to add support for Extended Attributes and ACL's.<br>
<p>
Also, note that because of how Soft Update works, it requires forcing metadata blocks out to disk more frequently than without Soft Updates; it is not free.  What's worse, it depends on the disk not reordering write requests, which modern disks do to avoid seeks (in some cases a write can not make it onto the platter in the absence of a Cache Flush request for 5-10 seconds or more).   If you disable the HDD's write cacheing, your lose a lot of performance on HDD's; if you leave it enabled (which is the default) your data is not safe.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471681"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2011 10:18 UTC (Sun)
                               by <b>vsrinivas</b> (subscriber, #56913)
                              [<a href="/Articles/471681/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FFS w/ soft updates assumes that drives honor write requests in the order they were dispatched. This is not necessarily the case, weakening the guarantees it means to provide. Also FFS doesn't ever issue what linux calls 'barriers' (on BSD known as device cache flushes or BUF_CMD_FLUSH).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471681/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor473236"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 21, 2011 23:09 UTC (Wed)
                               by <b>GalacticDomin8r</b> (guest, #81935)
                              [<a href="/Articles/473236/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Also, note that because of how Soft Update works, it requires forcing metadata blocks out to disk more frequently than without Soft Updates</font><br>
<p>
Duh.  Can you name a file system with integrity features that doesn't introduce a performance penalty?  I thought not.  The point is that the Soft Updates method is (far) less overhead than most.<br>
<p>
<font class="QuotedText">&gt; What's worse, it depends on the disk not reordering write requests</font><br>
<p>
Bald faced lie.  The only requirement of SU's is that writes reported as done by disk driver are indeed safely landed in the nonvolatile storage.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/473236/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor473293"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2011 11:32 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/473293/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A little civility would be appreciated. Unless you're a minor filesystem deity in pseudonymous disguise, it is reasonable to assume that Ted knows a hell of a lot more about filesystems than you (because he knows a hell of a lot more about filesystems than almost anyone). It's also extremely impolite to accuse someone of lying unless you have proof that what they are saying is not only wrong but maliciously meant. That is very unlikely here.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/473293/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470566"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 17:13 UTC (Sun)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/470566/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The trade-off is that you go from a situation where you can guarantee metadata consistency to one where you can't. SSDs may make the window of inconsistency smaller, but it's still there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470566/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor470546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 10:31 UTC (Sun)
                               by <b>alankila</b> (guest, #47141)
                              [<a href="/Articles/470546/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As far as I can tell, the same argument could be made about rotational media. If only there was a way to write things out in atomic chunks that result in FS metadata moving from a valid state to another valid state, journal wouldn't be necessary... The journal doesn't even improve performance (or shouldn't) because its contents must be merged with the on-disk datastructures at some point anyway.<br>
<p>
Anyway, isn't btrfs going to give us journal-less but atomic filesystem modification behavior?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470553"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 11:43 UTC (Sun)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470553/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, in some cases btrfs (or any copy on write, or CoW file system) may require more metadata blocks to be written than a traditional journalling file system design.  That's because even though a CoW file system doesn't have a journal, when you update a metadata block, you have to update all of the metadata blocks that point to it.<br>
<p>
So if you modify a node at the bottom of the b-tree, you write a new copy of the leaf block, but then you need to write a copy of its parent node with a pointer to the new leaf block, and then you need to write a copy of its grandparent, with a pointer to the new parent node, all the way up to the root of the tree.   This also implies that all of these nodes had better be in memory, or you will need to read them into memory before you can write them back out.   Which is why CoW file systems tend to be very memory hungry; if you are under a lot of memory pressure because you're running a cloud server, and are trying to keep lots of VM's packed into a server (or are on an EC2 VM where extra memory costs $$$$), good luck to you.<br>
<p>
At least in theory, CoW file systems will try to batch multiple file system operations into a single big transaction (just as ext3 will try to batch many file system operations into a single transaction, to try to minimize writes to the journal).   But if you have a really fsync()-happy workload, there definitely could be situations where a CoW file system like btrfs or ZFS could end up needing to update more blocks on an SSD than a traditional update-in-place file system with journaling, such as ext3 or XFS.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470553/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 12:13 UTC (Mon)
                               by <b>jlokier</b> (guest, #52227)
                              [<a href="/Articles/471769/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't know if btrfs works as you describe, but it is certainly possible to implement a CoW filesystem without "writing all the way up the tree". Think about how journals work without requiring updates to the superblocks that point to them.  If btrfs doesn't use that, it's an optimisation waiting to happen.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor473603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2011 20:56 UTC (Sat)
                               by <b>rich0</b> (guest, #55509)
                              [<a href="/Articles/473603/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can't implement a COW tree without writing all the way up the tree.  You write a new node to the tree, so you have to have the tree point to it.  You either copy an existing parent node and fix it, or you overwrite it in place.  If you do the latter, then you aren't doing COW.  If you copy the parent node, then its parent is pointing to the wrong place, all the way up to the root.<br>
<p>
I believe Btrfs actually uses a journal, and then updates the tree very 30 seconds.  This is a compromise between pure journal-less COW behavior and the memory-hungry behavior described above.  So, the tree itself is always in a clean state (if the change propagates to the root then it points to an up-to-date clean tree, and if it doesn't propagate to the root then it points to a stale clean tree), and then the journal can be replayed to catch the last 30 seconds worth of writes.<br>
<p>
I believe that the Btfs journal does effectively protect both data and metadata (equivalent to data=ordered).  Since data is not overwritten in place you end up with what appears to be atomic writes I think (within a single file only).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/473603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor473607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2011 22:17 UTC (Sat)
                               by <b>jlokier</b> (guest, #52227)
                              [<a href="/Articles/473607/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>You can't implement a COW tree without writing all the way up the tree. You write a new node to the tree, so you have to have the tree point to it. You either copy an existing parent node and fix it, or you overwrite it in place. If you do the latter, then you aren't doing COW. If you copy the parent node, then its parent is pointing to the wrong place, all the way up to the root.</blockquote>

<p>In fact you can.  The simplest illustration: for every tree node currently, allocate 2 on storage, and replace every pointer in a current interior node format with 2 pointers, pointing to the 2 allocated storage nodes.  Those 2 storage nodes both contain a 2-bit version number.  The one with larger version number (using wraparound comparison) is "current node", and the other is "potential node".</p>

<p>To update a tree node in COW fashion, without writing all the way up the tree on every update, simply locate the tree node's "potential node" partner, and overwrite that in place with a version 1 higher than the existing tree node.  The tree is thus updated.  It is made atomic using the same methods as needed for a robust journal: if it's a single sector and the medium writes those atomically, or by using a node checksum, or by writing version number at start and end if the medium is sure to write sequentially.</p>

<p>Note I didn't say it made reading any faster :-)  (Though with non-seeking media, speed might not be a problem.)</p>

<p>That method is clearly space inefficient and reads slowly (unless you can cache a lot of the node selections).  It can be made more efficient in a variety of ways, such as sharing "potential node" space among multiple potential nodes, or having a few pre-allocated pools of "potential node" space which migrate into the explicit tree with a delay - very much like multiple classical journals.  One extreme of that strategy is a classical journal, which can be viewed as every tree node having an implicit reference to the same range of locations, any of which might be regarded as containing that node's latest version overriding the explicit tree structure.</p>

<p>You can imagine there a variety of structures with space and behaviour in between a single, flat journal and an explicitly replicated tree of micro-journalled nodes.</p>

<p>The "replay" employed by classical journals also has an analogue: preloading of node selections either on mount, or lazily as parts of the tree are first read in after mounting, potentially updating tree nodes at preload time to reduce the number of pointer traversals on future reads.</p>

<p>The modern trick of "mounted dirty" bits for large block ranges in some filesystems to reduce fsck time, also has a natural analogue: Dirty subtree bits, indicating whether the "potential" pointers (implicit or explicit) need to be followed or can be ignored.  Those bits must be set with a barrier in advance of using the pointers, but they don't have to be set again for new updates after that, and can be cleaned in a variety of ways; one of which is the preload mentioned above.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/473607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor499085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2012 8:49 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/499085/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not 100% sure but I think you just meant:<br>
<p>
"You can implement a COW tree without writing all the way up the tree if your tree implements versioning".<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/499085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470555"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 13:11 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470555/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SSDs are inherently COW, they can't modify a block in place, but have to copy it (and all the other disk blocks that form up the erase block) to a new erase block.<br>
<p>
this is ok with large streaming writes, but horrible with many small writes to the same area of disk.<br>
<p>
the journal is many small writes to the same area of disk, exactly the worst case for an SSD<br>
<p>
also with rotational media, writing all the block in place requires many seeks before the data can be considered safe, and if you need to write the blocks in a particular order, you may end up seeking back and forth across the disk. with a SSD the order the blocks are written in doesn't affect how long it takes to write them.<br>
<p>
by the way, i'm not the OP who said that all journaling filesystems are bad on SSDs, I'm just pointing out some reasons why this could be the case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470555/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470567"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 17:39 UTC (Sun)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470567/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Flash erase blocks are around a megabyte these days.  So all modern SSD's use a Flash Translation Layer (FTL) that allows writes smaller to than an erase block to get written together in a single erase block.   So it's simply not true that if you do a small random write of 16k, that the SSD will need to copy all of the other disk blocks that form up the erase block.<br>
<p>
This might be the case for cheap MMC or SD cards that are designed for use in digital cameras, but an SSD which is meant for use in a computer will have a much more sophisticated FTL than that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470567/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470573"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 19:38 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470573/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
if you have 4K of data that is part of an eraseblock that you modify, that eraseblock now no longer contains valid info, so since it can't overwrite the 4K it will need to write to a new eraseblock.<br>
<p>
yes, in theory it could mark that 4k of data as being obsolete and only write new data to a new eraseblock, but that would lead to fragmentation where the disk could have 256 1M chunks, each with 4K of obsolete data in them, and to regain any space it would then need to re-write 255M of data.<br>
<p>
given the performance impact of stalling for this long on a write (not the mention the problems you would run into if you didn't have that many blank eraseblocks available), I would assume that if you re-write a 4k chunk, when it writes that data it will re-write the rest of the eraseblock as well so that it can free up the old eraseblock<br>
<p>
the flash translation layer lets it mix the logical blocks in the eraseblocks, and the drives probably do something in between the two extremes I listed above (so they probably track a few holes, but not too many)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470573/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470588"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 5, 2011 1:34 UTC (Mon)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/470588/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
walex said:<br>
<font class="QuotedText">&gt; &gt; No journaled filesystem is good for SSDs</font><br>
<p>
alankila said:<br>
<font class="QuotedText">&gt; Just to get the argument out in the open, what is the basis </font><br>
<font class="QuotedText">&gt; for making this claim?</font><br>
<p>
Well, SSDs have a limited number of write cycles.  With metadata journaling, you're effectively writing all the metadata changes twice instead of once.  That will wear out the flash faster.  I think a filesystem based on soft updates might do well on SSDs.<br>
<p>
Of course the optimal thing would be if the hardware would just expose an actual MTD interface and let us use NilFS or UBIFS.  But so far, that shows no signs of happening.  The main reason seems to be that Windows is not able to use raw MTD devices, and most SSDs are sold into the traditional Windows desktop market.<br>
<p>
Valerie Aurora also wrote an excellent article about the similarities between SSD block remapping layers and log structured filesystems here: <a href="http://lwn.net/Articles/353411/">http://lwn.net/Articles/353411/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470588/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor469862"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 2:05 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/469862/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
rather than allocate single blocks, a filesystem using clusters will allocate them in larger groups
</blockquote>
Like FAT, only less forced-by-misdesign. Everything old is new again...
      
          <div class="CommentReplyButton">
            <form action="/Articles/469862/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470100"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 10:46 UTC (Thu)
                               by <b>trasz</b> (guest, #45786)
                              [<a href="/Articles/470100/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or rather, like UFS did for over a decade.  In UFS, "blocks", which are kind of what's called clusters here, are 32kB by default, and consist of "fragments" - 4kB by default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470100/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470178"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 16:36 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/470178/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which UFS are you talking about?   UFS as found in BSD 4.4 and FreeBSD uses a default cluster size of 8k with 1k fragments.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470178/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 20:03 UTC (Thu)
                               by <b>trasz</b> (guest, #45786)
                              [<a href="/Articles/470233/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
UFS as found in FreeBSD 10 uses 32kB/4kB.  Older versions used 16/2kB sizes since, IIRC, FreeBSD 4.   See newfs(8) manual page (<a href="http://www.freebsd.org/cgi/man.cgi?newfs">http://www.freebsd.org/cgi/man.cgi?newfs</a>).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470442"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2011 23:43 UTC (Fri)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470442/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p><i>UFS as found in FreeBSD 10 uses 32kB/4kB</i></p>

<p>That is terrible, becase it means that except for the tail the system enforces a fixed 32KiB read ahead and write behind, rather than an adaptive (or at least tunable) one.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470442/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 1:01 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470453/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>BTW many years ago I persuaded the original developer of <tt>ext</tt> to not implement in it the demented BSD FFS idea of large block/small fragment, arguing that adaptive read-ahead and write-behind would give better dynamic performance, and adaptive allocate-ahead (reservations) better contiguity, without the downsides.</p>

<p>Not everything got implemented as I suggested, but at least all the absurd complications of large block/small fragment (for example the page mapping issues) were avoided in Linux, as well as the implied fixed ra/wb/aa.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470480"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 11:06 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470480/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But of course we have had page-mapping-related bugs, in the *other* direction, from people building filesystems with sub-page-size blocks. (Support for this case is unavoidable unless you want filesystems not to be portable from machines with a large page size to machines with a small one, but it's still tricky stuff.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470480/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor474060"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2012 17:38 UTC (Tue)
                               by <b>jsdyson</b> (guest, #71944)
                              [<a href="/Articles/474060/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, as the author of earlier forms of the FreeBSD readahead/writebehind, I do know that FreeBSD can be very aggressive with larger reads/writes than just the block size.   One really big advantage of the FreeBSD buffering is that the length of the queues/pending writes is generally planned to be smaller, thereby avoiding that nasty sluggish feeling (or apparent stopping) that occurs with horribly large pending writes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/474060/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor469902"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 12:36 UTC (Wed)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/469902/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How will this interact with huge, almost randomly written files?<br>
<p>
I have an application where what we really want is lots of RAM. But RAM is expensive. We can afford to buy 2TB of RAM, but not 20TB. However we can afford to go quite a lot slower than RAM sometimes so long as our averages are good enough, so our solution is to use SSDs plus RAM, via mmap()<br>
<p>
When we're lucky, the page we want is in RAM, we update it, and the kernel lazily writes it back to an SSD whenever. When we're unlucky, the SSD has to retrieve the page we need, which takes longer and of course forces one of the other pages out of cache, in the worst case forcing it to wait for that page to be written first. We can arrange to be somewhat luckier than pure chance would dictate, on average, but we certainly can't make this into a nice linear operation.<br>
<p>
Right now, with 4096 byte pages, the performance is... well, we're working on it but it's already surprisingly good. But if bigalloc clusters mean the unit of caching is larger, it seems like bad news for us.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469902/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469920"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 14:34 UTC (Wed)
                               by <b>Seegras</b> (guest, #20463)
                              [<a href="/Articles/469920/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But if bigalloc clusters mean the unit of caching is larger, it seems like </font><br>
<font class="QuotedText">&gt; bad news for us.</font><br>
<p>
You're not supposed to make filesystems with bigalloc clusters if you don't want them or if it hampers your performance.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469920/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 18:22 UTC (Wed)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/469970/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, OK, I somehow got the idea this was the unavoidable future, rather than another option. Nothing to worry about then. Thanks for pointing that out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469979"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 19:19 UTC (Wed)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/469979/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It also seems that you might not want to use a filesystem at all for that type of application, but instead just mmap a block device directly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469979/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor501992"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2012 14:19 UTC (Thu)
                               by <b>Klavs</b> (guest, #10563)
                              [<a href="/Articles/501992/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
like varnish does :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/501992/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor469983"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 20:02 UTC (Wed)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/469983/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My impression is that bigalloc doesn't affect the unit of caching. Rather, it affects the unit of disk block allocation, meaning that pages 0-1023 are adjacent on your SSD and the filesystem metadata specifies that that 4M is in use and the inode has a single disk location to find it, but the pages are still accessed independently.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469983/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 21:16 UTC (Wed)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470005/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Note that 'ext4' supports extents, so files can get allocated with very large contiguous extents already, for example for a 70MB file:</p>
<pre>#  du -sm /usr/share/icons/oxygen/icon-theme.cache
69      /usr/share/icons/oxygen/icon-theme.cache
#  filefrag /usr/share/icons/oxygen/icon-theme.cache
/usr/share/icons/oxygen/icon-theme.cache: 1 extent found
#  df -T /usr/share/icons/oxygen/icon-theme.cache
Filesystem    Type   1M-blocks      Used Available Use% Mounted on
/dev/sda3     ext4       25383     12558     11545  53% /</pre>

<p>But so far the free space has been tracked in block-sized units,
and the new thing seems to change the amount of free space accounted
for by each bit in the free space bitmap.</p>

<p>Which means that as surmised the granularity of allocation has changed
(for example minimum extent size).</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/470005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor470010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 21:58 UTC (Wed)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/470010/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Right now, with 4096 byte pages, the performance is... well, we're working </font><br>
<font class="QuotedText">&gt; on it but it's already surprisingly good. But if bigalloc clusters mean </font><br>
<font class="QuotedText">&gt; the unit of caching is larger, it seems like bad news for us.</font><br>
<p>
mmap is such an elegant faculty, but it lacks a few things.  The first is a way to handle I/O errors reasonably.  The second is a way to do nonblocking I/O.  You can sort of fudge the second point by using mincore(), but it doesn't work that well.<br>
<p>
As far as performance goes... SSDs are great at random reads, but small random writes are often not so good.  Don't assume that you can write small chunks anywhere on the flash "for free."  The firmware has to do a lot of write coalescing to even make that possible, let alone fast.<br>
<p>
bigalloc might very well be slower for you IF you have poor locality-- for example, if most data structures are smaller than 4k, and you never access two sequential data structures.  If you have bigger data structures, bigalloc could very well end up being faster.<br>
<p>
If you have poor locality, you should try reducing readahead in /sys/block/sda/queue/read_ahead_kb or wherever.  There's no point reading bytes that you're not going to access.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470169"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 16:56 UTC (Thu)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/470169/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On I/O errors: Sure. We even catch some implausible signal like SIGBUS if we write to a previously unallocated block on a full filesystem for example. But in practice other than giving developers like myself a terrible shock when it first happened (a SIGBUS? what the hell did I touch?) such behaviour isn't too troubling for us. If an SSD actually dies, we're out of action for some time no matter what, just as we would be if the RAM failed. We anticipate this happening once in a while, it isn't a reason to give up and go home.<br>
<p>
Yes, our locality is fairly poor such that readahead is actively bad news. The data structures which dominate are exactly page-sized. We may end up changing anything from a few bytes to a whole page (and even when we write a whole page we need the old contents to determine the new contents), but the chance we then move on to the linearly next (or previous) page is negligible.<br>
<p>
My impression was that readahead would be disabled by suitable incantations of madvise(). Is that wrong? It didn't benchmark as wrong on toy systems, but I would have to check whether we actually re-tested on the big machines.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470169/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bigalloc</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 20:36 UTC (Thu)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/470240/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; We even catch some implausible signal like SIGBUS if we write to</font><br>
<font class="QuotedText">&gt; a previously unallocated block on a full filesystem for example.</font><br>
<p>
If I were you, I'd use posix_fallocate to de-sparsify (manifest?) all of the blocks.  Then you don't have unpleasant surprises waiting for you later.<br>
<p>
<font class="QuotedText">&gt; My impression was that readahead would be disabled by suitable</font><br>
<font class="QuotedText">&gt; incantations of madvise(). Is that wrong? It didn't benchmark as wrong on</font><br>
<font class="QuotedText">&gt; toy systems, but I would have to check whether we actually re-tested on</font><br>
<font class="QuotedText">&gt; the big machines.</font><br>
<p>
I looked at mm/filemap.c and found this:<br>
<p>
<font class="QuotedText">&gt; static void do_sync_mmap_readahead(...) {</font><br>
<font class="QuotedText">&gt; ...</font><br>
<font class="QuotedText">&gt; if (VM_RandomReadHint(vma))</font><br>
<font class="QuotedText">&gt;         return;</font><br>
<font class="QuotedText">&gt; ...</font><br>
<font class="QuotedText">&gt; }</font><br>
<p>
So I'm guessing you're safe with MADV_RANDOM.  But it might be wise to check the source of the kernel you're using in case something is different in that version.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor469932"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">e2fsprogs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 16:00 UTC (Wed)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/469932/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      My usual luck holds...the upcoming e2fsprogs release mentioned in the article <a rel="nofollow" href="/Articles/469931/">became official</a> moments after my last look at the ext4 mailing list before posting.
      
          <div class="CommentReplyButton">
            <form action="/Articles/469932/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor469974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">e2fsprogs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 19:02 UTC (Wed)
                               by <b>zuki</b> (subscriber, #41808)
                              [<a href="/Articles/469974/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... and the release announcement is very impressive! The amount of new features is staggering.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/469974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470163"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">e2fsprogs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2011 15:17 UTC (Thu)
                               by <b>obi</b> (guest, #5784)
                              [<a href="/Articles/470163/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, you know we wouldn't have releases of anything if you didn't write articles about them first! All progress would halt! ;-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470163/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor469998"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 21:22 UTC (Wed)
                               by <b>mleu</b> (guest, #73224)
                              [<a href="/Articles/469998/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      As a SLES customer reading these (great) LWN articles just gives me the feeling I'm <a href="http://article.gmane.org/gmane.linux.redhat.fedora.general/402923">once again</a> on the <a href="http://www.suse.com/company/newsletter/suse-geeko-gazette-oct2011_1.html#file">wrong</a> <a href="http://www.novell.com/linux/releasenotes/x86_64/SUSE-SLES/11-SP2/#Support:TechPreviews">side</a> of the filesystem situation.
      
          <div class="CommentReplyButton">
            <form action="/Articles/469998/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470013"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2011 22:11 UTC (Wed)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/470013/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't worry, btrfs won't be the default let alone only option in SLES anytime soon. Surely will be supported and well integrated with tools like Snapper but it's still a choice.<br>
<p>
As a matter of fact, there is work going on to allow use of snapper with Ext4 so SUSE ain't jumping ship there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470013/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor470446"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 0:25 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470446/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <p>Don't worry about SLES. Reiser3 after some initial issues was actually quite robust, and was designed for robustness. If there were issues after the initial shaking down period it was because of the <tt>O_PONIES</tt> problem that causes so much distrust against <tt>ext4</tt> itself, and previously against XFS; but not against JFS because JFS has always had a rather twitchy flushing logic sort of equivalent to the short flushout <tt>ext3</tt> has always had.</p>

<p>Indeed <tt>ext3</tt> got a good reputation mostly just because even when it did not support barriers it had a very short flushing interval etc. which made it seemingly resilient in many cases to sudden power off even for applications that did not issue <tt>fsync</tt>(2).</p>

<p>To some extend it is sad that SLES switched to the <tt>ext</tt> line, but I guess a large part of it was marketing (it is an <q>industry standard</q>) and the sad story with Namesys.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470446/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470482"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 11:30 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/470482/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      Did anyone ever fix the ReiserFS tools to the point that you could safely fsck a ReiserFS volume that contained an uncompressed ReiserFS image?
      
          <div class="CommentReplyButton">
            <form action="/Articles/470482/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470497"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">deep recovery and embedded filesystem images</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2011 17:57 UTC (Sat)
                               by <b>walex</b> (subscriber, #69836)
                              [<a href="/Articles/470497/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>That's an interesting case. ReiserFS was designed to be very robust in the face of partial data loss, allowing for a reconstruction of the file system metadata from recognizable copies embedded in the files themselves.</p>

<p>Thus the contents of an embedded ReiserFS image will look like lost files from the containing filesystem, <em>if the option to reconstruct metadata</em> is enabled.</p>

<p>Running <tt>man reiserfsck</tt> is advised before doing recovery on a damaged ReiserFS image. Paying particular attention to the various mentions of <tt>--rebuild-tree</tt> may be wise.</p>

<p>In other words there is nothing to fix, except a lack of awareness of one of the better features of ReiserFS, or perhaps a lack of a specific warning.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470497/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor470517"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">deep recovery and embedded filesystem images</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 1:05 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/470517/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're the only person I have ever heard call reiserfsck's propensity to fuse disk images into an unholy union with their containing filesystem a *feature*.<br>
<p>
I don't think it was ever any part of reiserfsck's design to "reconstruct[] file system metadata from recognizable copies embedded in the files themselves" because nobody ever does that (how many copies of your inode tables do you have written to files in your filesystem for safety? None, that's right). It's more that reiserfsck --rebuild-tree simply scanned the whole partition for things that looked like btree nodes, and if it found them, it assumed they came from the same filesystem, and not from a completely different filesystem that happened to be merged into it -- there was no per-filesystem identifier in each node or anything like that, so they all got merged together.<br>
<p>
This is plainly a design error, but equally plainly not one that would have been as obvious when reiserfs was designed as it is now, when disks were smaller than they are today and virtual machine images much rarer.<br>
<p>
If you want some real fun, try a reiserfs filesystem with an ext3 filesystem inside it and another reiserfs filesystem embedded in that. To describe what reiserfsck --rebuild-tree on the outermost filesystem does to the innermost two would require using words insufficiently family-friendly for this site (though it is extremely amusing if you have nothing important on the fs).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470517/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Rebuild tree a useful feature with side-effects.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 4:26 UTC (Thu)
                               by <b>gmatht</b> (subscriber, #58961)
                              [<a href="/Articles/471050/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think that merging filesystems was meant to be a feature, but rather the rebuild-tree is useful feature that other fscks don't have.<br>
<p>
If someone has stored all their precious photos and media files on a disk, and the metadata is trashed, then rebuilding the tree should get them their files back where a regular fsck wouldn't. I wouldn't trust --rebuild-tree not to add random files at the best of times, for example, I understand that it restores deleted files [1] which you probably don't want to do in a routine fsck. If, on the other hand, you've just found out that all your backups are on write-only media, rebuilding a tree from leaves could save you from losing years of work.  It would be even better if it didn't merge partitions, but is still better than nothing if used as a last resort. <br>
<p>
I think it would also be better if it encouraged you to rebuild the tree onto an entirely new partition.<br>
<p>
[1] <a rel="nofollow" href="http://www.linuxquestions.org/linux/answers/Hardware/ReiserFS_Data_Recovery_Tips">http://www.linuxquestions.org/linux/answers/Hardware/Reis...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471057"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Rebuild tree a useful feature with side-effects.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2011 5:35 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/471057/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The fsck for ext2/3/4 doesn't have this feature because it doesn't need it.   One of the tradeoffs of using a dynamic inode table (since in reiserfs it is stored as part of the btree) is if you lose the root node of the file system, you have no choice but to search the entire disk looking for nodes that appear to belong to the file system b-tree.<br>
<p>
With ext 2/3/4, we have a static inode table.  This does have some disadvantages, but the advantage is that it's much more robust against file system damage, since the location of the metadata is much more predictable.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471057/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor471795"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 16:15 UTC (Mon)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/471795/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Did anyone ever fix the ReiserFS tools to the point that you could safely fsck a ReiserFS volume that contained an uncompressed ReiserFS image?</font><br>
<p>
The existing replies have basically answered this, but just to make it clear:<br>
<p>
You could always do that.<br>
<p>
Reiserfs *additionally* came with an *option* designed to make a last-ditched attempt at recovering a totally hosed filesystem by looking for any data on the disk that looked like Reiserfs data structures and making its best guess at rebuilding it based on that.<br>
<p>
Somehow the FUD brigade latched on to the drawbacks of that feature and conveniently 'forgot' that it was neither the only, nor the default fsck method.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471795/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 16:46 UTC (Mon)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/471801/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In my long-ago experience, reiserfsck --fix-fixable did absolutely nothing to improve a broken filesystem, and --rebuild-tree was the only way to get anything out.  Maybe you got very lucky?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor471967"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving ext4: bigalloc, inline data, and metadata checksums</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 14, 2011 12:15 UTC (Wed)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/471967/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Maybe you got very lucky?</font><br>
<p>
Maybe I did. Or maybe you got unlucky. Most of the people commenting on it though *never tried*; they just heard something bad via hearsay and parrotted it, and that just gets to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471967/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor470556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I wonder if this can be made to work well with SSD eraseblocks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2011 13:14 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/470556/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If bigalloc can be made to match the eraseblock size of an SSD, align properly, have the I/O for the entire block written at once, etc (and prevent the SSD smarts from confusing things), this could be a huge win for both a durability and performance point of view on a SSD<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/470556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2011, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
