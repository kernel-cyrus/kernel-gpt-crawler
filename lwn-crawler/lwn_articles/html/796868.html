        <!DOCTYPE html>
        <html lang="en">
        <head><title>Restricting path name lookup with openat2() [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/796868/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/796965/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/796868/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Restricting path name lookup with openat2()</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 22, 2019</br>
           </div>
Looking up a file given a path name seems like a straightforward task, but
it turns out to be one of the more complex things the kernel does.  Things
get more complicated if one is trying to write robust (user-space) code
that can do the right thing with paths that are controlled by a potentially
hostile user.  Attempts to make the <a
href="http://man7.org/linux/man-pages/man2/open.2.html"><tt>open()</tt> and
<tt>openat()</tt> system calls</a> safer date back
at least to an attempt to add <a
href="/Articles/619146/"><tt>O_BENEATH</tt> in 2014</a>, but 
numerous problems remain.  Aleksa Sarai, who has <a
href="/Articles/767547/">been working in this area</a> for a while, has now
concluded that a new version of <tt>openat()</tt>, naturally called <a
href="/ml/linux-kernel/20190820033406.29796-1-cyphar@cyphar.com/"><tt>openat2()</tt></a>,
is required to truly solve this problem.
<p>
The immediate purpose behind <tt>openat2()</tt> is to allow a program to
safely open a path that is 
possibly under the control of an attacker; in practice, that means placing
restrictions on how the lookup process will be carried out.  Past attempts
have centered around adding new flags to <tt>openat()</tt>, but there are a
couple of problems with that approach: <tt>openat()</tt> doesn't check for
unknown flags, and the number of available bits for new flags is not
large.  The failure to check for unknown flags is <a
href="/Articles/588444/">a well-known antipattern</a>.  A program using a
path-restricting flag needs to know whether the requested behavior is
understood by the kernel or not; the alternative is to accept security
vulnerabilities on kernels that do not implement those flags.
<p>
Changing <tt>openat()</tt> to return errors when passed unknown flags is
not an option; that would almost certainly break existing code.  So the
only alternative is to create a new system call that <i>does</i> check its
flags; thus <tt>openat2()</tt>:
<p>
<pre>
    struct open_how {
	__u32 flags;
	union {
	    __u16 mode;
	    __u16 upgrade_mask;
	};
	__u16 resolve;
	__u64 reserved[7]; /* must be zeroed */
    };

    int openat2(int dfd, const char *filename, const struct open_how *how);
</pre>
<p>

(Note that, as always, this is how the system call is presented at the
user-space boundary; C libraries could expose something different.)
<p>
Rather than add another argument for the new flags, Sarai opted to move all
of the behavior-affecting information into a separate structure.  Among
other things, this means that, unlike <tt>open()</tt> and
<tt>openat()</tt>, the new system call always has the same number of
arguments.  The <tt>flags</tt> field holds the same <tt>O_</tt> flags
understood by <tt>open()</tt> and <tt>openat()</tt>, but unknown flags in
this field will result in an error.  Similarly, the
<tt>mode</tt> field contains the permission bits used when a new file is
created. 
<p>
The <tt>resolve</tt> field, instead, contains a new set of flags that
control how pathname lookup will be performed.  The flags implemented in
the patch set are:
<p>
<blockquote>
<dl>
<dt><tt>RESOLVE_NO_XDEV</tt></dt>
<dd>
	The lookup process will not be allowed to cross any mount points
	(including bind mounts).  In other words, the file to be opened
	must reside on the same mount as the <tt>dfd</tt> descriptor (or
	the current working directory if <tt>dfd</tt> is passed as
	<tt>AT_FDCWD</tt>). 
</dd>
<p>
<dt><tt>RESOLVE_NO_MAGICLINKS</tt></dt>
<dd>
	There are relatively few types of objects that can be found in a
	filesystem directory; they include regular files, directories,
	devices, FIFOs, and symbolic links.  With this option, Sarai is in
	essence acknowledging that there is another type that has been lurking
	in plain sight for years: the "magic link".  Examples include the
	links found in <tt>/proc/<i>PID</i>/fd</tt> directories; they are
	implemented by the kernel and have some possibly surprising
	properties.  
	<p>
	The presence of this flag will prevent a path lookup operation from
	traversing through one of these magic links, thus blocking (for
	example) attempts to escape from a container via a <tt>/proc</tt>
	entry for an open file descriptor.
</dd>
<p>
<dt><tt>RESOLVE_NO_SYMLINKS</tt></dt>
<dd>
	Blocks any traversal through symbolic links, including magic
	links.  This option differs from the <tt>O_NOFOLLOW</tt> flag in
	that it prevents following a link at any point in the lookup
	process, while <tt>O_NOFOLLOW</tt> only applies to the last
	component in the path.
</dd>
<p>
<dt><tt>RESOLVE_BENEATH</tt></dt>
<dd>
	The lookup process is contained within the directory tree below the
	starting point; attempts to use components like "<tt>../</tt>" to
	escape that tree will generate an error.
</dd>
<p>
<dt><tt>RESOLVE_IN_ROOT</tt></dt>
<dd>
	This flag causes the lookup process to behave as if a
	<a
	href="http://man7.org/linux/man-pages/man2/chroot.2.html"><tt>chroot()</tt></a>
	to the starting point had been performed.  Absolute paths will
	begin relative to the starting directory, and "<tt>../</tt>" will
	not proceed above that directory.  Some work has been done to make
	<tt>RESOLVE_IN_ROOT</tt> free of some of the race conditions that
	plague <tt>chroot()</tt>; see <a
	href="/ml/linux-kernel/20190820033406.29796-7-cyphar@cyphar.com/">this
	changelog</a> for some details.

</dd>
</dl>
</blockquote>
<p>
The issue of magic links appears a few times in this patch set.  The
<tt>RESOLVE_NO_MAGICLINKS</tt> option prevents them from being traversed
(or opened), but it turns out that there are numerous cases where it is
indeed useful to open such links.  The problem is that allowing that to
happen can be dangerous; the <a href="/Articles/781013/"><tt>runc</tt>
container breakout vulnerability</a> reported in February was the result of
hostile code using the <tt>/proc/<i>PID</i>/exe</tt> link to open the
<tt>runc</tt> binary for write access.  That can make for leaky containers,
to put it mildly.
<p>
The <a
href="/ml/linux-kernel/20190820033406.29796-2-cyphar@cyphar.com/">first
patch</a> in the series changes the semantics of <tt>open()</tt> (in all
variants) when magic links are involved: while previously the permission
bits on the magic link itself were ignored, now they are taken into
account.  Then, for example, the permissions for
<tt>/proc/<i>PID</i>/exe</tt> are <a
href="/ml/linux-kernel/20190820033406.29796-3-cyphar@cyphar.com/">changed
in the kernel</a> to disallow opening 
for write access, blocking the <tt>runc</tt> breakout attack.
<p>
This change enables one other feature provided by <tt>openat2()</tt> (and,
indeed, <tt>openat()</tt> as well).
There is a new flag (<tt>O_EMPTYPATH</tt>) that causes the path argument to
be ignored; instead, the call will simply reopen the file descriptor passed
as the <tt>dfd</tt> argument using the new mode provided.  A common use
case is to reopen a file descriptor initially opened with <tt>O_PATH</tt>
to gain access to file contents or metadata — access which is otherwise
not possible with an <tt>O_PATH</tt> descriptor (see <a
href="http://man7.org/linux/man-pages/man2/open.2.html">the man page</a>
for details on <tt>O_PATH</tt>).  Programs have
typically done this sort of reopening using a path into
<tt>/proc/<i>PID</i>/fd</tt>, but <tt>O_EMPTYPATH</tt> will work even if
<tt>/proc</tt> is not available.
<p>

Finally, the new API also allows the placement of limits on how a file
descriptor created with <tt>O_PATH</tt> can be "upgraded" as described
above. When <tt>openat2()</tt> is used to open an <tt>O_PATH</tt> file
descriptor, the <tt>upgrade_mask</tt> field in the <tt>how</tt> structure can be
used to limit the access that can be obtained by reopening in the future.
Specifying <tt>UPGRADE_NOREAD</tt> will prevent reopening with read access,
and <tt>UPGRADE_NOWRITE</tt> will prevent the acquisition of write access.
This restriction can limit the damage should a hostile program obtain
access to an <tt>O_PATH</tt> file descriptor.

<p>
Previous versions of this patch set have generated a fair amount of
discussion.  The relative quiet after this posting may reflect the fact
that most of the concerns raised have been addressed over time — or
possibly just that the people who would comment on it are attending the
Linux Security Summit and falling behind on email.  Either way, there is a
clear demand for the ability to restrict how file path names are traversed
so, sooner or later, some version of this patch set seems likely to find
its way into the mainline.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Virtual_filesystem_layer">Filesystems/Virtual filesystem layer</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-openat2">System calls/openat2()</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Virtual_filesystem_layer">Linux kernel/Virtual filesystem layer</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/796868/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor796999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2019 21:10 UTC (Thu)
                               by <b>brauner</b> (subscriber, #109349)
                              [<a href="/Articles/796999/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just mentioned this patchset in the "Making Containers Safer" talk we gave at LSS.<br>
<p>
I'm very happy that the precedent we set with clone3() in using a dedicated and more easily extensible structures in syscall arguments is seeing more acceptance. The flag argument would usually have been placed in a register making the syscall hard to extend once we're out of flags. Yes, there's a problem for seccomp with these sycalls since it can't filter pointer arguments currently but hopefully we will enable seccomp to do this after we had time to discuss this at KSummit:<br>
<a href="https://lists.linuxfoundation.org/pipermail/ksummit-discuss/2019-July/006699.html">https://lists.linuxfoundation.org/pipermail/ksummit-discu...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/796999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2019 22:21 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/797002/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm, that led me to Kees Cook's message: <a href="https://lists.linuxfoundation.org/pipermail/ksummit-discuss/2019-July/006701.html">https://lists.linuxfoundation.org/pipermail/ksummit-discu...</a><br>
<font class="QuotedText">&gt; With a solution looming, now my mind turns to "how do we write filters</font><br>
that check argument data?" Can this be done sanely with cBPF or are we<br>
finally to requiring eBPF?<br>
<p>
If unprivileged eBPF is dead then it would be hugely problematic to require eBPF for seccomp filters that check argument data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor797005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2019 23:53 UTC (Thu)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/797005/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not a fan of using a structure in memory to pass arguments that would fit in registers. Besides the very important seccomp issues, I also find it distasteful to have to allocate memory (stack allocation is allocation!) just to pass arguments to the kernel. That makes it more difficult and less efficient to use these syscalls in any case where memory is not so easily allocatable, including in early program startup, assembly, or when ptracing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797013"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 5:29 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/797013/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In single-threaded code can’t you have a single statically allocated struct you use for every open2()?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797013/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797038"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 13:17 UTC (Fri)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/797038/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A statically allocated region for arguments works in some single threaded environments, but not in early program start, when ptracing, or, of course, any multi-threaded environments; that last one is enough to rule it out IMO.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797038/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor797160"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 14:53 UTC (Sat)
                               by <b>dezgeg</b> (subscriber, #92243)
                              [<a href="/Articles/797160/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How is stack memory not 'easily allocatable' in early program startup or assembly? Unless you have called sigaltstack() or blocked all signals, a signal sent to the process can cause stack allocation for the signal handler at any time. <br>
<p>
If you are injecting a syscall via ptrace(), don't you need to anyway to allocate memory for the syscall instruction itself? Not to mention for openat() you will need memory just for the path string itself...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797160/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797318"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 26, 2019 19:29 UTC (Mon)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/797318/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;How is stack memory not 'easily allocatable' in early program startup or assembly?</font><br>
<p>
Most trivially, when the stack hasn't been allocated yet. Or when it's fixed in size. Of course you wouldn't establish a signal handler in this environment anyway.<br>
<p>
<font class="QuotedText">&gt;If you are injecting a syscall via ptrace(), don't you need to anyway to allocate memory for the syscall instruction itself? Not to mention for openat() you will need memory just for the path string itself...</font><br>
<p>
As one example, you could be using the existing glibc syscall() function, and use a path string that already exists in the target program's address space. That's a somewhat unusual example, but it's a situation where this requirement for allocating more memory for the argument struct is clearly limiting.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797318/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor798563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 7:45 UTC (Fri)
                               by <b>polyp</b> (guest, #53146)
                              [<a href="/Articles/798563/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The system call overhead is probably hundreds of CPU cycles so why worry about maybe 5 cycles for allocating and populating a small constant-size structure on the stack? IMHO the gains in extensibility clearly outweigh the performance hit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor797242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 26, 2019 11:26 UTC (Mon)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/797242/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The flag argument would usually have been placed in a register making the syscall hard to extend once we're out of flags. </font><br>
<p>
Ummmm, you can just use the last flag as a "look in this other register for more flags", kind of the way fnctl works.......<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor797010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How disappointing!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 4:16 UTC (Fri)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/797010/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not call it "openatat" and release it on May 4th?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797087"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How disappointing!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 19:15 UTC (Fri)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/797087/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I googled this and now am in pain.<br>
<p>
(For others not aware, may fourth is a star wars pun/joke date.  (may the force..))<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797087/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797107"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How disappointing!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 22:56 UTC (Fri)
                               by <b>Beolach</b> (guest, #77384)
                              [<a href="/Articles/797107/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I got it &amp; groaned... the other half of the pun: <a href="https://starwars.fandom.com/wiki/All_Terrain_Armored_Transport">https://starwars.fandom.com/wiki/All_Terrain_Armored_Tran...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797107/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797109"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How disappointing!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 23:28 UTC (Fri)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/797109/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sorry (but not much :-)  I come from a lot of assembler coding where labels and variable names were pretty short and always was on the lookout for bad jokes.  I don't know any good ones :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797109/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor797011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 4:55 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/797011/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It might be useful to have a flag which suppresses directory traversal altogether, that is, only lets you open something directly inside the current working directory. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797032"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 12:00 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797032/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That might be useful, though it could be done (without a hypothetical RESOLVE_NO_SUBDIRS) by checking whether the path contains a '/' in userspace and using O_NOFOLLOW (you wouldn't even need RESOLVE_NO_SYMLINKS).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797032/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797035"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 12:38 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/797035/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the idea of attacker controlled path is supposed to extend to full control over that blob of memory, so any user space checks are subject to races.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797035/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797075"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 16:50 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/797075/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Copy the shared buffer into an area of private memory, and thereafter only use the private buffer.<br>
<p>
The only way an attacker can go after that is to 1) ptrace you or 2) already be running code in your process. If either of those is the case, then you've already lost.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797075/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797093"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 20:05 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/797093/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, there are safe ways to do it, but a flag would be convenient, obvious, and relatively foolproof. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797093/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797119"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 5:40 UTC (Sat)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797119/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With the downside that using the syscall would be more frustrating -- users that don't care about resolution would need to pass an extra 0 all the time (and the upgrade_mask union would be quite ugly to use too). Not to mention that there is a limit on the number of syscall arguments (6), so in the future we would probably need to switch to a struct-based argument anyway. Linus also mentioned in an earlier review that he wasn't a fan of the variadic open(2) semantics -- so I would like to avoid carrying that syscall design forward as well.<br>
<p>
This isn't all a hypothetical -- my first draft of the syscall did just add a new argument, and I discovered pretty quickly (while writing the selftests) that it was abysmal to actually use that interface. The fact that C zeroes out structs when you do designated initialisation makes using structs so much more straightforward here. All of that being said, I'm not married to the current interface at all. If the only concern people have with the patches is what the syscall looks like, I'm more than happy to change it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797119/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 8:00 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/797132/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When I said a ‘flag’ I didn’t mean it had to be an extra argument. A Boolean flag can be passed in lots of ways, including a bitmask of flags, and could be part of a struct. What I meant was, in addition to all the funky options mentioned in the article to stop following ‘magic links’ and so on, there could be one more to stop following any directory traversal whatever. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797138"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 8:26 UTC (Sat)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797138/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I'm really sorry -- I completely misread the rest of the comment thread I was responding to. I thought you were arguing for not having a struct *at all* (as someone else has suggested in a separate thread) and that's what I was talking about. Yes, a RESOLVE_NO_SUBDIRS (or whatever) could be useful -- though I'd prefer to land openat2() first and then we can work on extensions like that (I'm already worried enough that the patch touches too many things).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797138/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor797014"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 6:21 UTC (Fri)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/797014/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><font class="QuotedText"><tt>__u64 reserved[7]; /* must be zeroed */</tt></font></blockquote>

<p>Why so much empty reserved space?  Requiring the use of a struct with 56 empty bytes simply for &quot;reserve&quot; seems unusual.</p>

<p>I'm sure there's a good reason, not just for having the <tt>reserve</tt> space, but also for having <em>so much</em> of it, but I didn't glean that from the article.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797014/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797031"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 11:57 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797031/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't have a particularly strong justification for the size, it was just an arbitrary* (and probably wrong) choice. I don't really mind how we handle the extensibility of open_how, so long as it means we can expand openat2(2) in the future sanely. One other idea I had was a version or size field that would allow for the struct to be resized (rather than taking up a block of space needlessly), but I have a feeling that would be even less acceptable to most people.<br>
<p>
* Though, the struct being 64-bytes overall does mean it fits in one cache-line. That's not a good argument for it to be that big, but it does mean that making it any bigger than 64 bytes would be a much worse idea. I figured that I might as well make it as big as reasonable and see what other ideas people came up with.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797031/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 22:21 UTC (Fri)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/797103/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You don't need to have a separate size field, just reserve one of the flags in the flags field to indicate future structure growth. Then, some future version that needs to add more data to the structure can set that flag.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797121"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 5:54 UTC (Sat)
                               by <b>buck</b> (subscriber, #55985)
                              [<a href="/Articles/797121/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
forgive me if this is covered on the kernel developers list or is a common antipattern. (if so, please feel free to dismiss this with an informative link in reply). but why not start the structure with a protocol version number, like network packets (e.g., IP first nibble, kerberos protocol messages'  and SNMP PDUs' first integer)? then you pass in whatever struct is appropriate to the protocol version, with its size (a la socklen_t of bind(2)), and the kernel checks the protocol version at the top to figure out which structure it's been passed and how to interpret<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797121/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 20:05 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/797173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The size *is* a protocol version number, essentially.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor842148"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2021 7:55 UTC (Sat)
                               by <b>Serentty</b> (guest, #132335)
                              [<a href="/Articles/842148/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why reserve any space at all instead of passing in the size like clone3() does?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/842148/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor844901"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 3, 2021 5:50 UTC (Wed)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/844901/">Link</a>] 
      </p>
      
      </div>
      </summary>
      clone3 and openat2 use the same design for extension, and Christian and I gave a talk about this design <a href="https://lwn.net/Articles/830666/">at Linux Plumbers last year</a>. You're commenting on a thread which is almost 2 years old. :P
      
          <div class="CommentReplyButton">
            <form action="/Articles/844901/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor797033"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 12:05 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797033/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Great article! The one thing I'd add is that in addition to the kernel work, we need to switch many userspace programs to start handling paths more carefully (it's very hard to get right). To that end, I've been working on a helper library called libpathrs[1] that effectively acts as a much easier-to-use wrapper around RESOLVE_IN_ROOT (with userspace emulation for older kernels). I am quite hopeful that we can eliminate a whole class of path-related attacks by having a more ergonomic library to use.<br>
<p>
[1]: <a href="https://github.com/openSUSE/libpathrs">https://github.com/openSUSE/libpathrs</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797033/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2019 18:56 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/797635/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My worry about this stuff is that people will start to use it unthinkingly, breaking real use cases: and with bind-mounts becoming more and more common as a result of containerization and other things, use of RESOLVE_NO_XDEV in particular seems like a disaster waiting to happen unless it is done in specific response to user request (in response to something like an -xdev flag, for instance). At the very least, this should come with some big warnings about careless use and note that users use mount points for all sorts of things, and refusing to traverse them without providing a way to change that decision is at the very least rude.<br>
<p>
(In times past, I would have hoped that breaking real use cases could be fixed on a case-by-case basis by raising a bug and fixing the software, but in the current environment I just bet some people would say "Linux is not about choice" and demand that users stop using mount points in ways that break their software instead: after all, their laptop has only one big mount under / so your system should too. It seems best to me to try to stop this sort of thing from happening in the first place.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2019 3:44 UTC (Thu)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797704/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We can definitely include a warning to that effect in the man page -- though I would hope that it would be obvious (as it is with RESOLVE_NO_SYMLINKS) that you shouldn't use it everywhere unless you specifically need it for some reason. However, libpathrs doesn't use RESOLVE_NO_XDEV -- only RESOLVE_IN_ROOT (which at the moment implies RESOLVE_NO_MAGICLINKS).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor797037"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 13:17 UTC (Fri)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/797037/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This looks great!  I love the fact that it comes with selftests that try to exploit the race conditions it fixes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797037/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor797088"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2019 19:22 UTC (Fri)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/797088/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have a small and foolish question about the buffer slice that must be zeroed.  Is this just a prescriptive statement, or will it be checked?<br>
<p>
I'm also kind of a newb on system call versioning.  I've written code that tests for availability of system calls to decide what path to implement (which was a bit scary across the various architectures, but I got it right in the end), but I haven't written code to try to decide if a particular system call has a particular feature.  Is there a better way than kernel version numbers?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797088/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 4:46 UTC (Sat)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/797116/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>I was curious about that, too, but I didn't ask that in my previous question.</p>

<p>It would seem that (1) callers ensuring that <tt>reserved</tt> is zeroed, <em>and</em> (2) <tt>openat2</tt> enforcing this zeroing would be really expensive.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797117"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 5:23 UTC (Sat)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797117/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Yes, openat2(2) checks that it's zeroed. It's not particularly expensive, there's an optimised function for doing checks like that in lib/ (memchr_inv). Zeroing structures and flag bits before passing them to the kernel is already a very common practice (as discussed in <a href="https://lwn.net/Articles/588444/">this LWN article</a>).
      
          <div class="CommentReplyButton">
            <form action="/Articles/797117/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor797118"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 5:28 UTC (Sat)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797118/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Yes, it is checked (you get -EINVAL if it's non-zero).

<p>As for figuring out whether syscalls have particular features, the best way is to pass the flag and see if you get -EINVAL -- this is why <a href="https://lwn.net/Articles/588444/">checking whether there are unknown flags present and returning -EINVAL is important in syscall design</a>. If you don't check whether unknown flags are passed, you end up with situations where userspace cannot easily figure out whether the flag is actually supported. open(2) doesn't do this check (which makes it significantly more complicated to figure out whether your kernel supports a particular open(2) feature), but in openat2(2) we do check whether there are unknown O_* flags present.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/797118/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797174"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2019 20:14 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/797174/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This check makes a lot of sense when we're talking about *flags*. But why also check reserved fields when any future use of a reserved field could be signaled through the use of a flag? Can you elaborate on what concrete problems checking this reserved field zero check is supposed to address when any new functionality will get a new flag anyway?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797174/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797194"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 25, 2019 14:51 UTC (Sun)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/797194/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It wouldn't be necessary to add a new flag to represent entirely new features if you have a reserved (must be zeroed) block in the struct. As an example, imagine if open_how-&gt;resolve wasn't included in this version of the series (and open_how-&gt;reserved was one u16 bigger). In a later kernel version we could introduce open_how-&gt;resolve as a field and shrink open_how-&gt;reserved -- as long as the zero-value had identical semantics there wouldn't be a break in backwards-compatibility and new programs could use the new field (getting -EINVAL if they run on older kernels).<br>
<p>
All of that being said, I am gravitating towards not having reserved space. I don't have particularly strong opinions either way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797194/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor797315"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 26, 2019 19:18 UTC (Mon)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/797315/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks.  That makes sense.   Probably the manpage will tell me to do just that, and I would have figured it out upon reading it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797315/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor816284"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2020 16:09 UTC (Mon)
                               by <b>gb</b> (subscriber, #58328)
                              [<a href="/Articles/816284/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Very strange approach - let's introduce my own function to send params via struct.<br>
<p>
Why not introduce flag 'generate error on unknown flags' and introduce new syscall once you really run out of flags not in advance?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/816284/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor816314"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2020 23:14 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/816314/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because if you didn't have that flag before (so unknown flags were ignored) then introducing a flag to make unknown flags generate an error would be a breaking change: programs that worked before while setting that bit along with one or more other unknown flags bits would suddenly stop working.<br>
<p>
If you don't make unknown flags an error up front then the unused bits basically become permanently reserved. You can never safely *stop* ignoring them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/816314/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor816329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting path name lookup with openat2()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2020 7:07 UTC (Tue)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/816329/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Why not introduce flag 'generate error on unknown flags' </font><br>
<p>
Becuase that unknown flag could have been passed by a program before it was introduced....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/816329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
