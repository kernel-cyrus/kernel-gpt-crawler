        <!DOCTYPE html>
        <html lang="en">
        <head><title>Unprivileged chroot() [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/849125/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/849075/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/849125/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Unprivileged chroot()</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 15, 2021</br>
           </div>
It is probably fair to say that most Linux developers never end up using <a
href="https://man7.org/linux/man-pages/man2/chroot.2.html"><tt>chroot()</tt></a>
in an application.  This system call puts the calling process into a new
view of the filesystem, with the passed-in directory as the root
directory.  It can be used to isolate a process from the bulk of the
filesystem, though its security benefits are somewhat limited.  Calling
<tt>chroot()</tt> is a privileged operation but, if Mickaël Salaün has his
way with <a
href="/ml/linux-kernel/20210310181857.401675-1-mic@digikod.net/">this patch
set</a>, that will not be true for much longer, in some situations at
least.
<p>
Typically, <tt>chroot()</tt> is used for tasks like "jailing" a network
daemon process; should that process be compromised, its ability to access the
filesystem will be limited to the directory tree below the new root.  The
resulting security boundary is not the strongest — there are a number of
ways to break out of <tt>chroot()</tt> jails — but it can still present a
barrier to attackers.  <tt>chroot()</tt> can also be used to create a
different view of the file system to, for example, run containers within.
<p>
This system call is not available to just anybody; the <tt>CAP_SYS_CHROOT</tt>
capability is required to be able to call <tt>chroot()</tt>.  This
restriction is in place to thwart attackers who would otherwise try to
confuse (and exploit) setuid programs by running them inside a specially
crafted filesystem tree.  As a simple example, consider the sort of mayhem
that might be possible if setuid programs saw a version of
<tt>/etc/passwd</tt> or <tt>/etc/sudoers</tt> that was created by an
attacker.
<p>
The limitations of <tt>chroot()</tt> have long limited its applicability;
in recent years it has fallen even further out of favor.  <a
href="/Articles/689856/">Mount namespaces</a> are a much more flexible
mechanism for creating new views of the filesystem; they can also be harder
to break out of.  So relatively few developers see a reason to use
<tt>chroot()</tt> for anything new.
<p>
Thus, some folks were a bit surprised when Salaün showed up with his
<tt>chroot()</tt> patch.  Once applied, unprivileged processes are able to
call <tt>chroot()</tt>, but only if a few conditions apply:
<P>
<ul class="spacylist">
<li> The process in question must have done a <a
     href="https://man7.org/linux/man-pages/man2/prctl.2.html"><tt>prctl()</tt></a>
     call with the <tt>PR_SET_NO_NEW_PRIVS</tt> option.  That prevents the
     process from gaining any new privileges; running setuid and setgid
     programs will no longer gain the privileges of the owner of the
     executable file, for example.  Since privileged programs no longer
     exist in that mode, their privileges cannot be exploited.
<li> The process cannot be sharing its filesystem context (<a
     href="https://elixir.bootlin.com/linux/v5.11.6/source/include/linux/fs_struct.h#L9"><tt>struct
     fs_struct</tt></a>, which contains the root and current working
     directories)  with any other
     processes; otherwise the <tt>chroot()</tt> call would affect both
     processes, and the other one may not be expecting its filesystem
     environment to change abruptly.
<li> The new root must be underneath the current root in the filesystem
     hierarchy.  This prevents trickery that could otherwise facilitate
     escape from an existing jail or mount namespace.
</ul>
<p>
If these conditions are met, it is argued, it is safe to allow a process to
call <tt>chroot()</tt>.
<p>
There is still the question of why one might <i>want</i> to do that.  Among
other things, a functioning <tt>chroot()</tt> environment normally needs to
have a minimally populated <tt>/dev</tt> directory; creating device nodes
remains a privileged operation.  And, as noted above, Linux has had better
options than <tt>chroot()</tt> for some time now.  But Salaün says that
there are use cases where a process might want to sandbox itself after the
things it needs from the wider environment (libraries, for example) have
been loaded, and device files can often be done without.
<p>
The initial reception for this patch has been a bit chilly at best.  Eric
Biederman <a
href="/ml/linux-kernel/m1lfavt0bf.fsf@fess.ebiederm.org/">worried</a> about
the security implications of unprivileged <tt>chroot()</tt> when mixed with
other mechanisms:
<p>
<blockquote class="bq">
	Still allowing chroot after the sandbox has been built, a seccomp
	filter has been installed and no_new_privs has been enabled seems
	like it is asking for trouble and may weaken existing sandboxes.
</blockquote>
<p>
Casey Schaufler <a
href="/ml/linux-kernel/4b9a1bb3-94f0-72af-f8f6-27f1ca2b43a2@schaufler-ca.com/">argued</a>
that <tt>chroot()</tt> is obsolete and also worried about interactions:
"<q>We're still finding edge cases (e.g. ptrace) where no_new_privs is
imperfect</q>".  He also <a
href="/ml/linux-kernel/0dfd4306-8e7c-239b-2829-d4103395ea44@schaufler-ca.com/">pointed
out</a> that access to <tt>chroot()</tt> is already finely controlled with
the <tt>CAP_SYS_CHROOT</tt> capability:
<p>
<blockquote class="bq">
	CAP_SYS_CHROOT is specific to chroot. It doesn't give you privilege
	beyond what you expect, unlike CAP_CHOWN or CAP_SYS_ADMIN. Making
	chroot unprivileged is silly when it's possibly the best example of
	how the capability mechanism is supposed to work.
</blockquote>
<p>
Salaün has not answered all of these points, but seems undeterred; he
posted <a
href="/ml/linux-kernel/20210310181857.401675-1-mic@digikod.net/">a second
version of the patch set</a> after that discussion had 
occurred.  Without a stronger answer, though, upstreaming this change is
likely to be difficult.  Security-oriented developers will need some
convincing that <tt>chroot()</tt> merits any improvements at all; the bar
for changes that raise worries about unexpected interactions with other
security mechanisms will be higher.
<p>
The discussion is likely to come down to use cases in the end; is there
truly a need for unprivileged <tt>chroot()</tt> in 2021?  If there are
users out there who could benefit from this feature, now would probably be
a good time for them to come forward and explain why they need it.  In the
absence of that information, unprivileged <tt>chroot()</tt> seems likely to
be one of those ideas that didn't quite make it.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-chroot">System calls/chroot()</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#chroot">chroot()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/849125/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor849434"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 15, 2021 19:04 UTC (Mon)
                               by <b>nickodell</b> (subscriber, #125165)
                              [<a href="/Articles/849434/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Here&#x27;s a context where unprivileged chroot would be useful: a tool called Outrun. (<a href="https://github.com/Overv/outrun">https://github.com/Overv/outrun</a>)<br>
<p>
Outrun lets you execute a local command using the processing power of another Linux machine. In order to do this, it runs the process on the remote system, and redirects all filesystem calls back to the local system. It does this through two systems: FUSE and chroot. FUSE can be done in userspace with no extra permissions. chroot, however, requires root. For that reason, Outrun requires root privileges, even if the application you&#x27;re running doesn&#x27;t.<br>
<p>
There doesn&#x27;t seem to be a great way to solve this problem under the current permission scheme. Sure, there&#x27;s a chroot capability. But how do you give that chroot capability to processes running in Outrun? Outrun spawns processes from a normal login shell. If you give all login shells chroot capability, then that opens a security hole, due to setuid programs which can&#x27;t be allowed to run inside chroots.<br>
<p>
One solution which Outrun discussed was to write a setuid helper, which could run the chroot syscall on behalf of Outrun. However, those carry their own security risks. (See also: calibre&#x27;s setuid helper.)<br>
<p>
For these reasons, I think this patchset would be useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849434/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849436"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 15, 2021 19:20 UTC (Mon)
                               by <b>mcon147</b> (subscriber, #56569)
                              [<a href="/Articles/849436/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can outrun use &#x27;unshare&#x27; ?<br>
It seems like you can do<br>
    $ unshare -mr chroot os-tree-dir bash<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849436/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849445"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 15, 2021 20:59 UTC (Mon)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/849445/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That will fail if unprivileged user namespaces are disallowed, which is still the default on Debian, for instance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849445/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 15, 2021 22:30 UTC (Mon)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/849451/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Debian allows unprivileged user namespaces these days, as of version 5.10.4-1 of the Linux packaging.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 7:52 UTC (Tue)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/849464/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My program might want to open a sqlite database and a log file, *then* chroot to /run/user/UID/my-jail. When I restart the thing it might want to do the same thing and read the session files which the first program dumped there.<br>
<p>
There&#x27;s no way to do that without chroot.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849529"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 19:07 UTC (Tue)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/849529/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That doesn&#x27;t require an *unprivileged* chroot; you could do something like:<br>
<p>
    logfile = fopen(&quot;foo.log&quot;, &quot;a&quot;);<br>
    sqlite3_open(&quot;foo.db&quot;, &amp;db);<br>
    sprintf(rootdir, &quot;/run/user/%d/my-jail&quot;, getuid());<br>
    chdir(rootdir);<br>
    unshare(CLONE_NEWUSER);<br>
    chroot(&quot;.&quot;);<br>
    caps = cap_get_proc();<br>
    cap_clear(caps);<br>
    cap_set_proc(caps);<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849529/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849560"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 10:09 UTC (Wed)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/849560/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know that there are several options to do this with a privileged process. My point is that this task should not require any. That way, if the user does get hacked, at least there&#x27;s no setuid executable for them to play with.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849560/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 17:39 UTC (Wed)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/849599/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, but the point is that you *don&#x27;t* need a setuid executable.  Creating a user namespace (calling &quot;unshare&quot;) normally doesn&#x27;t require any special privileges.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849678"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 1:03 UTC (Thu)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/849678/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It does if your distro or sysadmin has disabled unprivileged namespaces by default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849678/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849703"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 12:54 UTC (Thu)
                               by <b>domenpk</b> (guest, #12382)
                              [<a href="/Articles/849703/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That same distro or sysadmin will almost surely also disable unprivileged chroot (being a newer and less tested feature), so you won&#x27;t gain anything.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849703/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor850868"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2021 18:54 UTC (Sat)
                               by <b>l0kod</b> (subscriber, #111864)
                              [<a href="/Articles/850868/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
chroot(2) is much more simple (and limited) than namespaces, which is why there is no valid reason to be able to disable it (i.e. this unprivileged chroot is not, by design, a security risk).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/850868/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 19:28 UTC (Tue)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/851794/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
is less of* a security risk<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor849673"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot() and Outrun</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 22:39 UTC (Wed)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/849673/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Reading through user_namespaces(7), I can think of the following problems:<br>
<p>
1. You have to set up uid_map and gid_map if you want to interact with the filesystem. Since you are using chroot(), you almost certainly do want to interact with the filesystem, so this is an obvious source of friction. Not impossible, just annoying.<br>
2. Assuming you don&#x27;t have CAP_SETUID/GID (in the parent user namespace), which is a safe assumption because otherwise you wouldn&#x27;t be asking for &quot;unprivileged chroot&quot; in the first place, then the man page appears to say that you can only map your own UID/GID. That certainly makes logical sense (the whole point of this operation is to give you a &quot;containerized&quot; or unprivileged CAP_SETUID, so we need to constrain it somehow), but it also means that stat(2) will lie to you about the ownership of any file you don&#x27;t own (the UID/GID is unmapped, so it gets converted to a generic &quot;don&#x27;t know&quot; value in the child namespace).<br>
3. SCM_CREDENTIALS will also produce unmapped garbage, as will plenty of other UID/GID-related interfaces. If you want to IPC with any process owned by a different user (e.g. a daemon running under a role account), you basically can&#x27;t confirm its identity, although it can confirm yours (which may be sufficient in some cases).<br>
4. Pervasively fixing all of the above, testing it, and maintaining everything, is likely harder than just granting CAP_SYS_CHROOT in the first place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849673/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor849455"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 0:11 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/849455/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I ran into a use-case for this just recently.<br>
<p>
Our application runs in a container. It needs access to subtrees of the host filesystem. We mount each subtree /a/b/c under /host/a/b/c. Unfortunately this breaks because absolute symbolic links in the host filesystem (e.g. /a/b/c -&gt; /foo/bar) don&#x27;t exist in the container&#x27;s mount namespace (it would need to be interpreted as /host/foo/bar). I ended up writing an implementation of `realpath` that manually resolves symbolic links and knows how to rebase absolute symbolic links to the /host directory. It&#x27;s probably not nearly as efficient as doing it in the kernel though. I would have thought a lot of people ran into a need for this.<br>
<p>
Obviously unprivileged chroot() would provide a solution. Though, maybe unprivileged chroot alone wouldn&#x27;t be that great for us; we&#x27;d have to fork a helper process to do the chroot and pass fds back to the main process, which would be fairly complicated and maybe not faster than manual symlink resolution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849455/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849462"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 6:30 UTC (Tue)
                               by <b>dbnichol</b> (subscriber, #39622)
                              [<a href="/Articles/849462/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you&#x27;re already in a container with it&#x27;s own mount and user namespace (presumably), then can&#x27;t you just supply it with CAP_SYS_CHROOT?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849462/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 10:05 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/849467/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s a good point. I prefer the code in question to run unprivileged inside its container, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 13:45 UTC (Tue)
                               by <b>gscrivano</b> (subscriber, #74830)
                              [<a href="/Articles/849478/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Have you already considered openat2(RESOLVE_IN_ROOT)?  Wouldn&#x27;t that be enough to replace chroot()?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 2:07 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/849550/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oooh, I didn&#x27;t know about RESOLVE_IN_ROOT. That solves my use-case perfectly!<br>
<p>
Unfortunately I can&#x27;t use it yet because I can&#x27;t guarantee we&#x27;re running on 5.6 or above, but this is the right API for me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849548"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 0:28 UTC (Wed)
                               by <b>dbnichol</b> (subscriber, #39622)
                              [<a href="/Articles/849548/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right. The way I&#x27;ve seen this done before is to start the new process with several capabilities, setup the environment, and then drop all but the required caps before starting the real work. In a sense it&#x27;s better than what you could do with the unprivileged chroot that&#x27;s being suggested here. Once you do the intended chroot, you can drop the capability and then the rest of the code can&#x27;t use it anymore.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849548/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor849457"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 0:50 UTC (Tue)
                               by <b>geofft</b> (subscriber, #59789)
                              [<a href="/Articles/849457/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unprivileged chroot, I think, was one of the original motivations for PR_SET_NO_NEW_PRIVS back in the day.<br>
<p>
Anyway, there&#x27;s one advantage of direct unprivileged chroot over making an unprivileged user + mount namespace and calling chroot inside there: you retain a full UID map of the outside system. If you use &quot;unshare -cm --keep-caps,&quot; you get to map a single UID, your own, and so things like &quot;ls -l /bin&quot; don&#x27;t display the results you&#x27;d expect. Since unprivileged chroot wouldn&#x27;t create a user namespace, things would still look normal.<br>
<p>
Maybe this could be worked around by saying something like, if you&#x27;re inside a user namespace, you have no capabilities, and you map to the same UID outside the namespace, and you call PR_SET_NO_NEW_PRIVS, you get the ability to write an identity map to uid_map and gid_map, even if they&#x27;ve already been written to. After all, in no new privs mode, you can&#x27;t switch users or gain any capabilities, so it doesn&#x27;t matter what UID mapping you see. But it seems extremely tricky to get the detail of that right and you&#x27;d probably introduce exploitable bugs the first few times you try.<br>
<p>
(I don&#x27;t believe CAP_SYS_CHROOT is a meaningful alternative here. How would you grant it? Would you give filesystem capabilities to the chroot command? It won&#x27;t be enforcing the NO_NEW_PRIVS requirement, then, and will turn into an immediate local root escalation. It _can&#x27;t_ enforce that requirement, in fact: if you run a setcap program under NO_NEW_PRIVS, those capabilities are ignored, specifically because you asked for no new privs! So it wouldn&#x27;t work if run from a no-new-privs parent process. If you somehow could avoid that constraint and run a setcap chroot, you could call it twice, the second time with a modified /lib thanks to being able to modify your chroot, and you could use that to escape the first chroot and hold onto chrooting privileges. It is technically true that CAP_SYS_CHROOT is the best example of how the capability mechanism is supposed to work - it&#x27;s a fantastic demonstration of how useless that mechanism is.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849457/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849685"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 9:14 UTC (Thu)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/849685/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would it be possible to create a chroot command that has CAP_SYS_CHROOT filesystem capabilities, does the chroot, drops CAP_SYS_CHROOT and sets NO_NEW_PRIVS before calling the supplied command?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849685/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 12:26 UTC (Thu)
                               by <b>winstonx86</b> (subscriber, #138536)
                              [<a href="/Articles/849701/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes but I suppose you couldn’t perform a second chroot because of the NO_NEW_PRIVS<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 16:54 UTC (Thu)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/849759/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s dangerous to allow that if the process is already chrooted, since it lets you escape from the outer chroot.<br>
<p>
For that reason (I think), unprivileged processes can&#x27;t create user namespaces when they&#x27;re already chrooted, and the proposed unprivileged chroot would likewise be forbidden.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849765"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 17:05 UTC (Thu)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/849765/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, my suggestion was to use the modified chroot command as an alternative to unprivileged chroot() syscall. And it was not meant to be used repeatedly. Obviously, it cannot be used repeatedly as after one execution NO_NEW_PRIVS is set and the CAP_CHROOT filesystem capability will have no effect.<br>
<p>
And of course, if someone chroots a process without NO_NEW_PRIVS in a classic way, there should be no enchanted chroot command that gets capabilities from the filesystem laying around inside the new root. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849765/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor849458"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 3:47 UTC (Tue)
                               by <b>rsidd</b> (subscriber, #2582)
                              [<a href="/Articles/849458/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      The last time I used chroot was to run a linux subsystem in an android tab. I had a full xfce-based desktop on android, and did actual work on it. It required a rooted tab and, even so, later android releases made it hard. I haven't tried it recently but it seems these days they use <A HREF="https://wiki.termux.com/wiki/PRoot">proot</A> for this purpose, and root is not needed.  
      
          <div class="CommentReplyButton">
            <form action="/Articles/849458/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849460"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 4:32 UTC (Tue)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/849460/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Some of the other chroot-on-Android options are listed here:<br>
<p>
<a href="https://wiki.debian.org/ChrootOnAndroid">https://wiki.debian.org/ChrootOnAndroid</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849460/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849465"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2021 8:21 UTC (Tue)
                               by <b>l0kod</b> (subscriber, #111864)
                              [<a href="/Articles/849465/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Salaün has not answered all of these points</font><br>
<p>
They are answered, especially with the third version: <a href="https://lore.kernel.org/lkml/20210311105242.874506-2-mic@digikod.net/">https://lore.kernel.org/lkml/20210311105242.874506-2-mic@...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849465/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849573"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 12:49 UTC (Wed)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/849573/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just echoing my comments from 2012 in that thread with Andy: I still think running a process without at least the &quot;API devices&quot; e.g. `/dev/null` (and `/proc`) is just unnecessary painful for everyone authoring a shared library.   There&#x27;s a lot of software that opens `/dev/null` when spawning child processes.  And things like wanting to read `/proc/cpuinfo` as part of a multiprocessing library to determine how many threads to spawn.<br>
<p>
And yes, there&#x27;s now a syscall instead of `/dev/urandom` but still.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849573/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 13:15 UTC (Wed)
                               by <b>l0kod</b> (subscriber, #111864)
                              [<a href="/Articles/849575/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
These concerns have been taken into account in the commit message. ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor850790"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged mknod() or use FUSE?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 26, 2021 23:13 UTC (Fri)
                               by <b>jrincayc</b> (guest, #29129)
                              [<a href="/Articles/850790/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hm, I wonder if you could get around the lack of things like no dev by either doing a &quot;dev&quot; in FUSE or possibly by another patch to allow some unprivileged uses of mknod?  I would think that it might be possible to allow making /dev/null, /dev/zero, /dev/random and /dev/urandom be unprivileged.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/850790/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor849649"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2021 17:58 UTC (Wed)
                               by <b>metalheart</b> (guest, #89328)
                              [<a href="/Articles/849649/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Kernel noob here. This change will not affect the /usr/sbin/chroot tool?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849649/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849679"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 1:48 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/849679/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It depends on how your system&#x27;s chroot(8) was written.<br>
<p>
* If it explicitly checks geteuid() == 0, then it will continue to fail for non-root. This is probably a bad design decision, but not impossible if the application writer was trying to be &quot;helpful&quot; and provide a more explicit error message. On non-Linux systems, it would not be wrong to insert such a check, and some of these tools are written for &quot;any random Unix-like&quot; rather than Linux specifically.<br>
* Unless it calls prctl() with PR_SET_NO_NEW_PRIVS, it will continue to fail for non-root. I see nothing about this in the man page for the GNU version, but it&#x27;s possible a vendor might ship a version of chroot which does this. If this patch does get implemented, future versions of the GNU tool might grow a command-line argument to enable this functionality (or they might not; I can&#x27;t read the GNU people&#x27;s collective mind).<br>
* Because chroot(8) runs a separate executable after doing the chroot, shared libraries etc. need to be accessible from within the chroot environment. It is complicated (but not categorically impossible) for a non-privileged user to set this up.<br>
<p>
TL;DR: You probably still need to be root to profitably use chroot(8), even with this patch.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849679/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849695"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 11:01 UTC (Thu)
                               by <b>l0kod</b> (subscriber, #111864)
                              [<a href="/Articles/849695/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This should work with setpriv --no-new-privs /usr/sbin/chroot /new/root /bin/sh<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849695/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849763"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 16:45 UTC (Thu)
                               by <b>jcpunk</b> (subscriber, #95796)
                              [<a href="/Articles/849763/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m certain it is my ignorance showing, but is there a reason `chroot()` isn&#x27;t a type of mount namespace these days?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849763/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849787"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 22:11 UTC (Thu)
                               by <b>kentonv</b> (subscriber, #92073)
                              [<a href="/Articles/849787/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do chroots stack? Or does calling chroot simply update the root pointer to point at something new?<br>
<p>
In the latter case, I think allowing unprivileged chroot() ironically makes it possible to escape a preexisting chroot jail by the following means:<br>
<p>
1. chdir(&quot;/foo&quot;)<br>
2. chroot(&quot;/bar&quot;)<br>
3. open(&quot;../..&quot;)<br>
<p>
Step 3 opens the parent of the previous root! Because &quot;..&quot; is no longer recognized as being the current root, the kernel doesn&#x27;t prevent traversing up past it.<br>
<p>
Verifying that the current directory is under the new root is not enough... Instead of chdir() in step 1 you could also open a file descriptor to &quot;/foo&quot; and then openat() in step 3.<br>
<p>
Verifying that all open file descriptors are under the new root still isn&#x27;t enough, because file descirptors could be transmitted via SCM_RIGHTS over a unix socket from an accomplice program that isn&#x27;t inside the new chroot.<br>
<p>
I think it only works if chroots stack, but my understanding is that they don&#x27;t.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849787/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849799"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 0:12 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/849799/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a trap as old as time in using chroot securely: you&#x27;re supposed to call chroot() immediately followed by -  at a bare minimum - chdir(&quot;/&quot;), to prevent escapes via old cwd handles, but the API lends itself well to forgetting.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849799/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 0:22 UTC (Fri)
                               by <b>kentonv</b> (subscriber, #92073)
                              [<a href="/Articles/849801/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, but, my point is that the proposed feature would let anyone break out of chroots even if they were set up &quot;correctly&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849881"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 18:32 UTC (Fri)
                               by <b>l0kod</b> (subscriber, #111864)
                              [<a href="/Articles/849881/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is the reason of the unprivileged chroot limitations. It is only allowed to chroot one time: <a href="https://lore.kernel.org/lkml/20210316203633.424794-2-mic@digikod.net/">https://lore.kernel.org/lkml/20210316203633.424794-2-mic@...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849881/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 21:56 UTC (Fri)
                               by <b>kentonv</b> (subscriber, #92073)
                              [<a href="/Articles/849889/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ahhhhh I see.<br>
<p>
That seems like a disappointing limitation though... any program that uses this feature will mysteriously break when run in a chroot.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849944"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unprivileged chroot()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2021 10:50 UTC (Sun)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/849944/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Running in a plain chroot isn&#x27;t a good idea anyway; as soon as you do anything nontrivial things tend to break. The new unprivileged-chroot sycall is just one more example of many.<br>
<p>
Much better to use systemd-nspawn or some other tool that sets up a &quot;real&quot; file system namespace. The unprivileged chroot(2) will work there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849944/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
