        <!DOCTYPE html>
        <html lang="en">
        <head><title>4.3 Merge window, part 3 [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/657325/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/657114/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/657325/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>4.3 Merge window, part 3</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 14, 2015</br>
           </div>
<a href="/Articles/656731/">Last week's merge window summary</a> ended with
a guess that the bulk of the changes for 4.3 had been seen by that point.
By the time Linus <a href="/Articles/657217/">released 4.3-rc1</a> and
closed the merge window, 10,756 non-merge changesets had been pulled into
the mainline repository; that's about 550 since last week.  So the patch
rate did indeed fall off as expected, but there were still some significant
changes that slipped in before the window closed.
<p>
Significant user-visible changes include:
<p>
<ul>
<li> The new file <tt>/proc/kpagecgroup</tt> can be used to determine which
     memory control group each page of physical memory is charged to.
<p>
<li> The <a href="/Articles/642202/">idle-page tracking feature</a> has
     been merged.  This feature enables the discovery of memory pages that
     are not in active use; this information can be used to optimize the
     allocation of memory between containers or virtual machines.
<p>
<li> The <a href="/Articles/369567/"><tt>membarrier()</tt> system call</a>,
     which has been circulating since (at least) 2010, has been merged.
     See <a
     href="http://git.kernel.org/linus/5b25b13ab08f616efd566347d809b4ece54570d1">this
     commit</a> for the latest description and man page.
<p>
<li> The <a href="/Articles/648292/">control-group writeback improvement
     patches</a> have been merged.
<p>
<li> New hardware support includes Microchip LAN88XX PHYs,
     NXP LPC18xx/43xx watchdog timers,
     Atmel SAMA5D4 watchdog timers,
     Toradex Colibri VF50 touchscreens, and
     Freescale i.MX6UL touchscreen controllers.
</ul>
<p>
<h4>get_vaddr_frames()</h4>
<p>
With regard to changes visible to kernel developers: there has been one
significant addition to the memory-management interface.  Certain driver
subsystems (media, for example) have long had to reach deep into the
memory-management subsystem to implement high-performance I/O to user-space
buffers.  Some of the resulting code raised eyebrows in memory-management
circles; it also stood in the way of efforts to make the <tt>mmap_sem</tt>
semaphore less of a bottleneck.
<p>
Jan Kara has been working on reducing <tt>mmap_sem</tt> use for a while;
that effort has extended into improving the memory-management primitives
used in the driver tree.  In 4.3 he has added a new set of helpers for the
easy mapping of I/O buffers.  It creates a new type, <tt>struct
frame_vector</tt>, to describe a mapped buffer.  That structure lives in
<tt>&lt;linux/mm.h&gt;</tt>, but it's probably best if most users treat it
as if it were an opaque structure.
<p>
A frame vector can be allocated or destroyed with:
<p>
<pre>
    struct frame_vector *frame_vector_create(unsigned int nr_frames);
    void frame_vector_destroy(struct frame_vector *vec);
</pre>
<p>
Here, <tt>nr_frames</tt> is the maximum number of pages that will be mapped
using this vector.  The mapping itself is done with:
<p>
<pre>
    int get_vaddr_frames(unsigned long start, unsigned int nr_frames,
		         bool write, bool force, struct frame_vector *vec);
</pre>
<p>
The beginning virtual address of the buffer to be mapped is passed in
<tt>start</tt>, and the size of the buffer in <tt>nr_frames</tt>.  If
<tt>write</tt> is set, the buffer will be mapped for write access; if
<tt>force</tt> is set, write access will be set up even if the buffer is
mapped read-only in user space.  After a successful call, <tt>vec</tt> will
contain the results of the mapping, and the return value will be the number
of pages actually mapped.
<p>
If the buffer lives in ordinary memory, <tt>get_vaddr_frames()</tt> will
take a reference to each mapped page to keep it in RAM.  That reference
must be released at some point to unpin the pages; to do so, call:
<p>
<pre>
    void put_vaddr_frames(struct frame_vector *vec);
</pre>
<p>
Note that <tt>frame_vector_destroy()</tt> does <i>not</i> make this call;
users must take care to do it themselves.
<p>
Once upon a time (i.e. last year), this type of interface would have
returned an array of <tt>struct&nbsp;page</tt> pointers to refer to the
mapped pages.  The increasing use of <a href="/Articles/656197/">not quite
real memory</a> in hardware has created pressure to use page-frame numbers
(PFNs) instead.  As it happens, the contents of the frame vector may be
<i>either</i> <tt>struct&nbsp;page</tt> pointers or PFNs, depending on the
type of memory mapped.  Driver-level code need not be aware of this
practice, but it does have to be explicit about what it wants.  To gain
access to the mapped buffer (for DMA mapping, for example), use one of:
<p>
<pre>
    struct page **frame_vector_pages(struct frame_vector *vec);
    unsigned long *frame_vector_pfns(struct frame_vector *vec);
</pre>
<p>
The call to <tt>frame_vector_pages()</tt> can fail if it is not possible to
represent the buffer using <tt>page</tt> structures; the error code will be
returned as an <tt>ERR_PTR()</tt> value, so a macro like <tt>IS_ERR()</tt>
should be used to check the returned pointer before using it.  Conversion
to PFNs is unconditionally successful in the current implementation.
<p>
All of the above functions are exported to modules (with no explicit GPL
limitation).  Driver
code has been fixed up in a number of places (<a
href="http://git.kernel.org/linus/fb639eb39154312af8bf08c58cc0142179e0c224">example</a>)
to use the new interface; the result is a net reduction in lines of code
and, hopefully, an improvement in robustness.
<p>
<h4>In summary</h4>
<p>
Meanwhile, the 4.3 development cycle has now entered the stabilization
phase.  For the curious, Stephen Rothwell's <a
href="/Articles/657332/">post-merge-window summary</a> gives some
statistics about the changes that were merged this time around.  It seems
that 94% of them were in the linux-next tree at the beginning of the merge
window, with the DRM and networking trees being the biggest source of
commits that weren't there.  Some 587 commits in linux-next didn't make it
into the mainline; nearly a quarter of those come from the kdbus tree,
which was not proposed for merging this time around.  Also not merged was
<a href="/Articles/643165/">OrangeFS</a>, which <a
href="/Articles/657333/">ran into some trouble</a> when the pull request
went out; chances are good OrangeFS will make it in for&nbsp;4.4.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#get_vaddr_frames">get_vaddr_frames()</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-4.3">Releases/4.3</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/657325/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2015, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
