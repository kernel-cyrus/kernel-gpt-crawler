        <!DOCTYPE html>
        <html lang="en">
        <head><title>Expanding the kernel stack [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/600644/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/599931/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/600644/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Expanding the kernel stack</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 29, 2014</br>
           </div>
Every process in the system occupies a certain amount of memory just by
existing.  Though it may seem small, one of the more important pieces of
memory required for each process is a place to put the kernel stack.  Since
every process could conceivably be running in the kernel at the same time,
each must have its own kernel stack area.  If there are a lot of processes
in the system, the space taken for kernel stacks can add up; the fact that
the stack must be physically contiguous can stress the memory management
subsystem as well.  These concerns have always provided a strong motivation
to keep the size of the kernel stack small.
<p>
For most of the history of Linux, on most architectures, the kernel stack
has been put into an 8KB allocation — two physical pages.  As recently as
2008 some developers were <a href="/Articles/279229/">trying to shrink the
stack to 4KB</a>, but that effort eventually proved to be unrealistic.
Modern kernels can end up creating surprisingly deep call chains that just
do not fit into a 4KB stack.
<p>
Increasingly, it seems, those call chains don't even fit into an 8KB stack
on x86-64 systems.  Recently, Minchan Kim tracked down a crash that turned
out to be a stack overflow; he <a href="/Articles/600645/">responded</a> by
proposing that it was time to double the stack size on x86-64 to 16KB.
Such proposals have seen resistance before, and that happened this time
around as well; Alan Cox <a href="/Articles/600646/">argued</a> that the
solution is to be found elsewhere.  But he seems to be nearly alone in that
point of view.
<p>
Dave Chinner often has to deal with stack overflow problems, since they
often occur with the XFS filesystem, which happens to be a bit more
stack-hungry than others.  He was <a href="/Articles/600647/">quite
supportive</a> of this change:
<p>
<div class="BigQuote">
	8k stacks were never large enough to fit the linux IO architecture
	on x86-64, but nobody outside filesystem and IO developers has been
	willing to accept that argument as valid, despite regular stack
	overruns and filesystem having to add workaround after workaround
	to prevent stack overruns.
</div>
<p>
Linus was unconvinced at the outset, and he <a
href="/Articles/600649/">made it clear</a> that work on reducing the
kernel's stack footprint needs to continue.  But Linus, too, seems to have
come around to the idea that playing "whack-a-stack" is not going to be
enough to solve the problem in a reliable way:
<p>
<div class="BigQuote">
	[S]o while I am basically planning on applying that patch, I _also_
	want to make sure that we fix the problems we do see and not just
	paper them over.  The 8kB stack has been somewhat restrictive and
	painful for a while, and I'm ok with admitting that it is just
	getting _too_ damn painful, but I don't want to just give up
	entirely when we have a known deep stack case.
</div>
<p>
Linus has also, unsurprisingly, made it clear that he is not interested in
changing the stack size in the 3.15 kernel.  But the 3.16 merge window can
be expected to open in the near future; at that point, we may well see this
patch go in as one of the first changes.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Kernel_stack">Kernel stack</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/600644/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor600736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 10:51 UTC (Fri)
                               by <b>HIGHGuY</b> (subscriber, #62277)
                              [<a href="/Articles/600736/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would it be possible to set the newly added 8K of the stack read-only and issue a warning with backtrace when a page fault happens for it?<br>
Seems like a nice middle-ground between not crashing while also not ignoring the need to fix offenders.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 13:36 UTC (Fri)
                               by <b>richard_weinberger</b> (subscriber, #38938)
                              [<a href="/Articles/600758/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not needed, we have already CONFIG_DEBUG_STACK_USAGE<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600795"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 17:11 UTC (Fri)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/600795/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
CONFIG_DEBUG_STACK_USAGE isn't entirely reliable -- guard pages would be nicer.  The downside is that we couldn't use huge pages.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600795/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600821"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 18:41 UTC (Fri)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/600821/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
i have good news then, the very new GRKERNSEC_KSTACKOVERFLOW feature solves this without breaking up huge pages. throw in our 3-year-old move of thread_info off the kstack and we've got a winner! ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600821/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 19:55 UTC (Fri)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/600837/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That thing uses vmalloc, right?  Then it still prevents hugepages from being used for the kernel stack.  This will cost a TLB slot or two.  It's probably still a good tradeoff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600843"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 20:49 UTC (Fri)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/600843/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
correct but note that the lowmem map will keep using 2M/1G pages. as for its TLB impact, it's a tradeoff between one 2MB (or 1GB) TLB entry and 1-4 4k entries. the net performance impact depends on how the TLBs for each page size are organized in a given CPU and the access pattern of the virtual memory mapped by those entries (e.g., if there're separate TLBs for each page size and the access pattern continuously exhausts one but no the other(s) then obviously freeing/taking up extra entries will have a net positive/negative impact). i think in practice it'll come down to how many accesses are made to lowmem vs. the vmalloc ranges in a workload.<br>
<p>
another advantage is that vmalloc by its nature handles lowmem fragmentation much better which becomes even more important now that amd64 kstacks have become order-2 allocations. it'd also be easy to implement lazy page allocation for kstacks further reducing their memory consumption (let's face it, many kstacks will never actually make use of the whole 16k yet they'll always have to be fully allocated in the current scheme).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600843/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 20:52 UTC (Fri)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/600845/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It could pay to send the patch upstream.  If it's clean, I'll advocate for it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor692755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2016 0:50 UTC (Mon)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/692755/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Lazy page allocation is an interesting idea.  I can think of two potential problems, though:<br>
<p>
1. What do you do if lazy allocation fails?<br>
<p>
2. Hitting a not-present page on the stack is likely to result in a double-fault.  Intel's manual advises against trying to recover from a double-fault, and I'd like to know why before messing with it.  Even if recovery were guaranteed to work, it could be interesting trying to allocate memory (which can block) in a double-fault handler.<br>
<p>
The espfix64 code can double-fault and recover, but we ran that specific abuse of the CPU by some Intel and AMD engineers before doing it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor600943"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2014 8:35 UTC (Sun)
                               by <b>richard_weinberger</b> (subscriber, #38938)
                              [<a href="/Articles/600943/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are you willing to send this feature as stand-alone patch upstream for review?<br>
Would be awesome. :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600943/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2014 12:38 UTC (Sun)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/600951/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
it's spender's code, so you'd have to convince him to go through the process.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor601011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2014 11:49 UTC (Mon)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/601011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or someone else to adopt the code and champion it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/601011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor600810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 17:38 UTC (Fri)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/600810/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems to me that this is another case of "direct reclaim is a problem"; all of the overflows seem to come from doing a reasonable amount of regular work plus a reasonable amount of direct reclaim on the same stack, and it seems to me that, instead of a process actually performing direct reclaim itself, it would be better to have the process just donate its timeslice to a separate direct reclaim thread, so that you don't need the stack space for direct reclaim per-process, but only per-cpu. Sure, priority inheritance is a mess to do in general, but this special case (code that can inherit can't donate) isn't nearly so bad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor600836"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Merged for 3.15</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 19:45 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/600836/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Well, I was wrong about one thing...Linus just merged the 16K stack patch for 3.15.
      
          <div class="CommentReplyButton">
            <form action="/Articles/600836/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Merged for 3.15</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 19:56 UTC (Fri)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/600838/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It happens. BTW, how's your health?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Merged for 3.15</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 20:05 UTC (Fri)
                               by <b>boog</b> (subscriber, #30882)
                              [<a href="/Articles/600840/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Should anybody wish to help, a good starting place would be to not ask for details on my condition or treatment plans; I do not intend to discuss such things in public spaces."<br>
<p>
<a href="http://lwn.net/Articles/594980/">http://lwn.net/Articles/594980/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor600847"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 21:35 UTC (Fri)
                               by <b>parcs</b> (guest, #71985)
                              [<a href="/Articles/600847/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why is the kernel stack a fixed size? Does it have to be that way?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600847/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2014 21:49 UTC (Fri)
                               by <b>nevets</b> (subscriber, #11875)
                              [<a href="/Articles/600848/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, but it is the easiest and currently the most efficient way of implementing a kernel stack.<br>
<p>
A dynamic stack would be incredibly complex to implement. What happens when you need more stack? You would need to make sure the task faults when it overflows, and then the fault handler would require a separate stack. Where do you allocate the next page from? Oh, and as the stack must be continuous, the stack must be mapped into virtual memory. Currently, all kernel memory (except things like modules and stuff allocated with vmalloc) is mapped in huge page tables, and the kernel stack is just a pointer within that mapping.<br>
<p>
The kernel stack doesn't have to be a fixed size, but the alternatives are much worse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2014 22:28 UTC (Sat)
                               by <b>sdalley</b> (subscriber, #18550)
                              [<a href="/Articles/600908/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would there be scope for keeping fixed sizes, but just giving the (presumably few) stack-hogging tasks the 16K size and leaving the others at 8K (or even 4K)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600911"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2014 23:06 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/600911/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The thing is that the problem isn't particular tasks. It's how many layers of indirection are involved<br>
<p>
you have the task info, then the scheduler puts some info there, then you access memory and that does a page fault, finds that you need to interact with swap, makes a call to access the disk, which may need to go through raid, lvm, union mounts and then the filesystem needs it's data.....<br>
<p>
In the case that triggered this, you didn't have a complex storage layer, you had a compile option that ate some space and a lot of cases where gcc decided to put variable data on the stack, and did so particularly inefficiently as well.<br>
<p>
But the task doing the work that triggered this mess wasn't doing anything special, so there's no way to size the stack per task.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600911/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600947"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2014 10:55 UTC (Sun)
                               by <b>sdalley</b> (subscriber, #18550)
                              [<a href="/Articles/600947/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, thanks for that explanation.<br>
<p>
Indeed, one can't afford to assume low stack usage if one don't know ahead of time whether a task might need lots of stack, even if very infrequently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600947/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor601069"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2014 17:21 UTC (Mon)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/601069/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A stack doesn't /have/ to be contiguous.  GoLang has demonstrated that segmented stacks are viable, if your willing to break the C calling conventions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/601069/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor601259"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2014 18:57 UTC (Wed)
                               by <b>dtlin</b> (subscriber, #36537)
                              [<a href="/Articles/601259/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>GCC <a rel="nofollow" href="http://gcc.gnu.org/wiki/SplitStacks"><tt>-fsplit-stacks</tt></a> works for C/C++ code in user-space now, at least on i386/x86_64 Linux.  I'm not sure how hard it would be to get it working in the kernel, but at a glance it looks non-trivial: the implementation depends on <tt>-fuse-ld=gold</tt>, which doesn't work with the kernel; the generated code uses the <tt>__private_ss</tt> slot in the <tt>%gs</tt>/<tt>%fs</tt> TCB, which would presumably have to change to access something in <tt>task_struct *current</tt> instead; and <tt>__morestack</tt> uses <tt>mmap</tt> to allocate new stack segments, which won't work (and there isn't one obvious way to safely allocate memory in kernel context).

<p>For Go, split stacks were problematic (performance-wise) and 1.3 will switch to <a rel="nofollow" href="https://docs.google.com/document/d/1wAaf1rYoM4S4gtnPh0zOlGzWtrZFQ5suE8qr2sD8uWQ/pub">reallocating contiguous stacks</a>.  Since it involves <i>moving</i> the stack (and thus changing the addresses of everything that's on the stack), it's probably not doable for C/C++.  Well, I suppose you could dynamically allocate anything that escapes (like Go does), but that seems pretty invasive&hellip;
      
          <div class="CommentReplyButton">
            <form action="/Articles/601259/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor601282"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2014 20:41 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/601282/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW, Rust also switched from split stacks to growing-on-demand stacks with guard pages.<br>
<p>
Also for performance reasons.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/601282/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor601659"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2014 5:38 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/601659/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm. I wonder how the Mill architecture will fit with this which does not have contiguous stacks (see the security talk). In fact, it makes digging through stack rubble (all new memory is implicitly zero'd) and return a oriented a programming impossible (parent frame pointers are stored in memory not accessible to the process).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/601659/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor601672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2014 10:52 UTC (Sat)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/601672/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
in practice, the very first gadget usually executes a stack pivot exactly because that's not where the rest of the payload is, so it doesn't matter how the rest of the stack is fragmented.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/601672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor601674"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2014 11:24 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/601674/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My understanding was that the only way to modify the stack pointer was either call, return, or resizing your frame. There is no register to write to which contains your stack location, so how would you do a stack pivot?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/601674/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor600872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2014 9:21 UTC (Sat)
                               by <b>mslusarz</b> (guest, #58587)
                              [<a href="/Articles/600872/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm wondering, can't known offenders (like direct reclaim code) switch stack on the fly to bigger area? You don't need to allocate this space for every thread...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600877"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2014 11:35 UTC (Sat)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/600877/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      That is essentially what is done in a number of places — work is shifted to a kernel thread, which has the effect of going to a different stack (one that is known not to be almost full already).  Doing it any other way involves controlling access to some sort of shared stack infrastructure; that would add a lot of unwelcome complexity, to say the least.
      
          <div class="CommentReplyButton">
            <form action="/Articles/600877/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2014 0:51 UTC (Sun)
                               by <b>dgc</b> (subscriber, #6611)
                              [<a href="/Articles/600919/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And the problem with doing this is that each "stack switch" requires two context switches and an unknown amount of scheduler and workqueue latency to execute. We found that the added latency can have devastating effects of performance in XFS, so we have^W had to be very careful where we placed the stack switches. <br>
<p>
-Dave.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/600919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor600946"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Expanding the kernel stack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2014 10:54 UTC (Sun)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/600946/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Sounds like a bug to me. It looks like it should be possible to do such switch “for cheap” (i.e.: by changing a few data structures without context switches), but this will require special-casing (effectively this will mean that this special thread will be executed on it's own kernel stack with with “borrowed” userspace) and tricky additional manipulations.</p>

<p>Still it may be preferable to endlessly growing kernel stack.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/600946/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2014, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
