        <!DOCTYPE html>
        <html lang="en">
        <head><title>Variable-length arrays and the max() mess [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/749064/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/748871/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/749064/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Variable-length arrays and the max() mess</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we donâ€™t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 12, 2018</br>
           </div>
Variable-length arrays (VLAs) have a non-constant size that is determined (and
which can vary) at run time; they are supported by the ISO&nbsp;C99
standard.   Use of VLAs in the
kernel has long been discouraged but not prohibited, so there are naturally
numerous VLA instances to be found.  A recent push to remove VLAs from the
kernel entirely has gained momentum, but it ran into an interesting snag on
the way.
<p>
A VLA is simply an array that is declared with a non-constant dimension.
For example, <a
href="https://elixir.bootlin.com/linux/latest/source/lib/btree.c#L639"><tt>btree_merge()</tt></a>
begins like this:
<p>
<pre>
    int btree_merge(struct btree_head *target, struct btree_head *victim,
		    struct btree_geo *geo, gfp_t gfp)
    {
	unsigned long key[geo-&gt;keylen];
	unsigned long dup[geo-&gt;keylen];
</pre>
<p>
The length of both the <tt>key</tt> and <tt>dup</tt> arrays is determined
by the value stored in the <tt>keylen</tt> field of the passed-in
<tt>geo</tt> structure.  The compiler cannot know what that value will be
at compile time, so those arrays must be allocated at run time.  For this
reason, VLAs must be automatic variables, allocated on the stack.
<p>
As an extension to the language, GCC also allows the use of VLAs within
structures.  The LLVM Clang developers have refused to add this extension,
though; that has led developers interested in building the kernel with
Clang to work to remove VLAs from structures in the kernel.  C99 VLAs are
supported by Clang, though, so developers working on Clang compatibility
have not paid much attention to them.
<p>
Since VLAs are standard C, one might wonder why there is a desire to remove
them.  One reason is that they add a bit of run-time overhead, since the size of
a VLA must be calculated every time that the function declaring it is
called.  But the bigger issue has to do with stack usage.  Stacks in the
kernel are small, so every kernel developer must be constantly aware of how
much stack space each function is using.  VLAs, since they are automatic
variables whose size is determined at run time, add a degree of uncertainty
to a function's stack usage. 
Changes in distant code might result in a VLA growing in surprising ways.
If an attacker finds a way to influence the size of a VLA, the potential
for all kinds of mischief arises.
<p>
For these reasons, Linus Torvalds recently <a
href="/Articles/749089/">declared</a> that "<q>using VLA's is actively
bad not just for security worries, but simply because VLA's are a really
horribly bad idea in general in the kernel</q>".  That added some energy
to the VLA-removal work that was already underway.  In the process, though,
Kees Cook discovered an interesting surprise: a number of VLAs in the
kernel are not actually variable in length and were never meant to be seen
as such by the compiler.
<p>
<h4>Accidental VLAs and the difficult story of max()</h4>
<p>

A useful tool in the quest to remove VLAs from the kernel is the GCC
<tt>-Wvla</tt> option, which issues warnings when VLAs are declared.  Cook
<a href="/Articles/749091/">found</a>, though, that it was issuing warnings
for arrays that were meant to be of constant size; one of them was this bit
of code from <a
href="https://elixir.bootlin.com/linux/latest/source/lib/vsprintf.c#L741"><tt>lib/vsprintf.c</tt></a>:
<p>
<pre>
    #define RSRC_BUF_SIZE	((2 * sizeof(resource_size_t)) + 4)
    #define FLAG_BUF_SIZE	(2 * sizeof(res-&gt;flags))
    #define DECODED_BUF_SIZE	sizeof("[mem - 64bit pref window disabled]")
    #define RAW_BUF_SIZE	sizeof("[mem - flags 0x]")
	char sym[max(2*RSRC_BUF_SIZE + DECODED_BUF_SIZE,
		     2*RSRC_BUF_SIZE + FLAG_BUF_SIZE + RAW_BUF_SIZE)];
</pre>
<p>
The length of <tt>sym</tt> is clearly constant and can be determined at
compile time, but GCC warns that <tt>sym</tt> is a VLA anyway.  The problem
turns out to be the kernel's <tt>max()</tt> macro, which generates an expression
that is not recognized as constant by the compiler.
<p>
If one looks on page 87 of the original edition of <a
href="https://archive.org/details/TheCProgrammingLanguageFirstEdition"><i>The
C&nbsp;Programming Language</i></a> by Kernighan and Ritchie, one will find
the classic definition of the <tt>max()</tt> macro:
<p>
<pre>
    #define max(A, B)  ((A) &gt; (B) ? (A) : (B))
</pre>
<p>
There are some problems with this definition that make it
unsuitable for kernel use, including the double-evaluation of the arguments
and the lack of any sort of type checking.  So a lot of effort has gone
into the kernel's <a
href="https://elixir.bootlin.com/linux/v4.15.9/source/include/linux/kernel.h#L804">special
version of <tt>max()</tt></a>:
<p>
<pre>
    #define __max(t1, t2, max1, max2, x, y) ({		\
	t1 max1 = (x);					\
	t2 max2 = (y);					\
	(void) (&amp;max1 == &amp;max2);			\
	max1 &gt; max2 ? max1 : max2; })

    #define max(x, y)					\
	__max(typeof(x), typeof(y),			\
	      __UNIQUE_ID(max1_), __UNIQUE_ID(max2_),	\
	      x, y)
</pre>
<p>

For the curious, the outer <tt>max()</tt> macro uses <tt><a
href="https://elixir.bootlin.com/linux/v4.15.9/source/include/linux/compiler-gcc.h#L189">__UNIQUE_ID()</a></tt>
to generate two unique variable names.  Those names, along with the types
of the two values and the values themselves, are passed to
<tt>__max()</tt>.  That macro declares two new variables (using the unique
names) and assigns the passed-in values to them; this is done to prevent
<tt>x</tt> and&nbsp;<tt>y</tt> from being evaluated more than once.
Pointers to those two variables are then compared while discarding the
result; this is done to force the compiler to issue an error 
if the two operands do not have compatible types.  Finally, the
two values themselves are compared to determine which one is greater.
<p>
It was initially assumed that GCC was simply not smart enough to understand
that the result of this whole mess was still constant, so it created a VLA
instead.  Torvalds eventually <a href="/Articles/749093/">figured out</a>
the real problem, though: the C&nbsp;standard makes a distinction between a
"constant value" and a "constant expression".  Array dimensions are
required to be constant expressions, but the <tt>max()</tt> macro does not
qualify as such.  As Torvalds pointed out, the warning from GCC is thus somewhat
misleading; while the compiler is emitting the VLA code for these arrays,
they are not actually variable in length, and the problem is more a matter
of syntax.
<p>
Regardless of the reason for their creation, it clearly would be a good
thing to get rid of these
"accidental" VLAs.  What followed was an effort to rewrite <tt>max()</tt>;
it was the sort of quest that the kernel community is so good at mustering.  At one
point, Cook <a href="/Articles/749095/">came up with this</a>:
<p>
<pre>
    #define __single_eval_max(t1, t2, max1, max2, x, y) ({	\
 	t1 max1 = (x);					\
 	t2 max2 = (y);					\
 	(void) (&amp;max1 == &amp;max2);			\
 	max1 &gt; max2 ? max1 : max2; })

    #define __max(t1, t2, x, y)						\
	__builtin_choose_expr(__builtin_constant_p(x) &amp;&amp;		\
			      __builtin_constant_p(y),			\
			      (t1)(x) &gt; (t2)(y) ? (t1)(x) : (t2)(y),	\
			      __single_eval_max(t1, t2,			\
						__UNIQUE_ID(max1_),	\
						__UNIQUE_ID(max2_),	\
						x, y))

    #define max(x, y)	__max(typeof(x), typeof(y), x, y)
</pre>
<p>
Essentially, this version uses more macro trickery to short out much of the
<tt>max()</tt> logic when the two operands are constants.  It worked well â€”
on recent compilers.  The results turned out to not be so pleasing on older
compilers, though.  Initially there was some thought of revisiting the
discussion on <a href="/Articles/748074/">deprecating support for older
compilers</a>, but then 4.8.5 was <a href="/Articles/749097/">reported</a>
to fail as well.  At that point, 
Cook <a href="/Articles/749096/">threw up his hands</a> and gave up on
creating a better <tt>max()</tt>.  The solution going forward is likely to
be what he suggested when he first discovered the problem: create a new
<tt>SIMPLE_MAX()</tt> macro that is really just the original Kernighan and
Ritchie <tt>max()</tt> with a different name.  It is good enough for
constant array dimensions.
<p>
<h4>Finishing the job</h4>
<p>
Now that this discussion has run its course, the process of eliminating all
of the non-accidental VLAs can continue.  There are just over 200 of them
in the kernel; many of them are easily replaced with
ordinary fixed-length arrays.  Several developers have posted patches
eliminating VLAs from various kernel subsystems.  Getting rid of all of
them will probably take some time; a few instances may require fairly deep
analysis to determine the real maximum length and, perhaps, internal API
changes.  Eventually, though, we will get to a point where a <tt>-Wvla</tt>
build generates no warnings.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Variable-length_arrays">Variable-length arrays</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/749064/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor749129"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2018 21:50 UTC (Mon)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/749129/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Occasionally, C++ (in this case, with constexpr std::max) does seem like the more sane language. :-) Only occasionally, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749129/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749140"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 7:38 UTC (Tue)
                               by <b>kccqzy</b> (guest, #121854)
                              [<a href="/Articles/749140/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Really? I think the kernel developers want to additionally make sure the two expressions have the same type, and cause a compile-time error if they do not.</p>
<p>My C++ is quite rusty but hereâ€™s my version:</p>
<pre><code>#include &lt;type_traits&gt;

template &lt;typename T1, typename T2,
          typename = typename std::enable_if&lt;
              std::is_same&lt;typename std::decay&lt;T1&gt;::type,
                           typename std::decay&lt;T2&gt;::type&gt;::value,
              T1&gt;::type&gt;
inline constexpr auto maxx(T1 a, T2 b) {
  return a &gt; b ? a : b;
}

int test(void) {
  int a = maxx(12, 14);         // should compile
  int b = maxx(12ul, 14l);      // should fail
  int c[maxx(17, 19)];          // should compile
}</code></pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749140/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 8:30 UTC (Tue)
                               by <b>Homer512</b> (subscriber, #85295)
                              [<a href="/Articles/749141/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I could be wrong but that seems unnecessary. std::max will already fail to compile if you give it two different integer types. You just have to define it with a single type for both both parameters.<br>
<p>
template&lt;class T&gt;<br>
constexpr T max(const T&amp; left, const T&amp; right);<br>
<p>
Also works for pass-by-value.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749142"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 8:32 UTC (Tue)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/749142/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes; it's defined with one template parameter only, so if you give it two different types, you'll either need to cast one or (better) say explicitly which max() you want, e.g. std::max&lt;int&gt;(a, b). See <a href="http://en.cppreference.com/w/cpp/algorithm/max">http://en.cppreference.com/w/cpp/algorithm/max</a>.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749142/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor749465"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2018 4:22 UTC (Fri)
                               by <b>inphi</b> (guest, #120554)
                              [<a href="/Articles/749465/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
assuming C++, I wonder how much of the kernel can be constexpr'd and what would be the performance consequences.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749465/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2018 19:10 UTC (Thu)
                               by <b>antnisp</b> (guest, #123056)
                              [<a href="/Articles/749991/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Other than VLAs, what else precludes g++ from compiling the kernel?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749994"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2018 20:53 UTC (Thu)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/749994/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://lwn.net/Articles/734449/">https://lwn.net/Articles/734449/</a> has some relevant information.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749994/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor749132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2018 22:44 UTC (Mon)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/749132/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I might have missed this in the discussion, but surely that should be<br>
<p>
    #define __max(t1, t2, max1, max2, x, y) ({		\<br>
	const t1 max1 = (x);		/* add const here */			\<br>
	const t2 max2 = (y);					\<br>
	(void) (&amp;max1 == &amp;max2);			\<br>
	max1 &gt; max2 ? max1 : max2; })<br>
<p>
    #define max(x, y)					\<br>
	__max(typeof(x), typeof(y),			\<br>
	      __UNIQUE_ID(max1_), __UNIQUE_ID(max2_),	\<br>
	      x, y)<br>
<p>
otherwise &amp;max1 is a pointer to non-const t1, and who knows what side-effects that has.  (OK, you and I know, but the compiler may not).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749249"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 14:51 UTC (Wed)
                               by <b>fweimer</b> (guest, #111581)
                              [<a href="/Articles/749249/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Not sure what your point is, but <tt>const</tt> variables are not constant expressions in C.

This creates a VLA:

<pre>
const int count = 5;
int array[count];
</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749249/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749306"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 17:50 UTC (Wed)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/749306/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The original version, annotated:

<pre>
#define __max(t1, t2, max1, max2, x, y) ({	\
    t1 max1 = (x);	\    // max1 is a non-const t1
    t2 max2 = (y);	\    // max2 is a non-const t2
    (void) (&amp;max1 == &amp;max2);	\
        // compute address of a non-const t1
        // compute address of a non-const t2
        // compare addresses
        // don't emit code for the last three lines
        // see questions below
    max1 &gt; max2 ? max1 : max2; })
 </pre>

At what point do the compiler's pointer-aliasing optimization rules kick in?  Does the compiler realize the pointers are not used, or must it assume that because these pointers exist, that max1 and max2 might be modified before the comparison?  Does the &amp; operator force the compiler to instantiate max1 and max2, then later elide the code but not forget the side-effect?  Does even asking this question cause the compiler to be unable to reduce this to a compile-time constant, and turn this into a VLA instead?
      
          <div class="CommentReplyButton">
            <form action="/Articles/749306/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor749138"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 2:26 UTC (Tue)
                               by <b>nevyn</b> (guest, #33129)
                              [<a href="/Articles/749138/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Anyone know why they don't use the new magic max() on newer compilers, but continue letting older ones generate "VLAs"?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749138/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor749146"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 11:24 UTC (Tue)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/749146/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><em>At that point, Cook threw up his hands and gave up on creating a better <tt>max()</tt>.</em></blockquote>
<p>
Does that mean Miracle <tt>max()</tt> is mostly dead?
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/749146/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749315"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 18:57 UTC (Wed)
                               by <b>tmattox</b> (subscriber, #4169)
                              [<a href="/Articles/749315/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
LOL! Love that movie!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749315/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor749149"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 13:20 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/749149/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do variable-length arrays have to go on the stack?  Could the compiler generate code to call some allocation function, and then some free function when leaving the stack frame?  These would have to be specified by the programmer somehow as compiler options, so it would be un-C-like, but might give a way to have the convenient syntax of VLAs while doing memory management the way kernel programmers like.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749149/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749159"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VLAs on the heap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 14:47 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/749159/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The kernel community tends to be less than thrilled about that kind of behind-the-curtain magic; it obscures things in a setting where developers really need to know exactly what is happening.  There's also the little issue of figuring out which GFP flags to use.   So I don't think I see anything like this happening.
      
          <div class="CommentReplyButton">
            <form action="/Articles/749159/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor749164"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 14:50 UTC (Tue)
                               by <b>comio</b> (subscriber, #115526)
                              [<a href="/Articles/749164/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
if you needn't why you should use? 90% of cases you can use fixed size vectors. About 10% you can find a solid way avoiding vla. Why do kernel's devs enable warning on VLA by default? this will reduce the usage in short time avoiding wrong coding style in the future.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749164/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749179"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 14:53 UTC (Tue)
                               by <b>comio</b> (subscriber, #115526)
                              [<a href="/Articles/749179/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I killed royal majesty the queen of UK with the last post.<br>
<p>
If you needn't why should you use? In 90% of cases you can use fixed size vectors instead. About 10%, you can find a solid way avoiding vla. Why don't kernel's devs enable warning on VLA by default? this will reduce the usage in short time avoiding wrong coding style in the future.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749179/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749186"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 16:52 UTC (Tue)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/749186/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suspect they *will* enable warn on VLA by default, once they've sorted removing all the existing ones.  And I also suspect that some part of the automatic building/testing infrastructure of the kernel will be tweaked to fail when VLA warnings are found.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749186/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor749565"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2018 21:43 UTC (Sat)
                               by <b>gerdesj</b> (subscriber, #5446)
                              [<a href="/Articles/749565/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Missing out two letters and an apostrophe is hardly regicide!  <br>
<p>
However, if you are going to pick on a monarch, you ought to be aware that that particular Queen is multiple monarchs at the same time.  You will also have attacked the Queen of Australia, New Zealand, Canada, Jamaica and several others.  Each of those Queens is a separate person who happens to be the same physical individual.  I'm not sure how you could have bumped off just one of them.  Anyway, why did you pick on ours?<br>
<p>
God bless her and all who sail in her!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749565/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor749181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 16:10 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/749181/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What if the allocation fails?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749187"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2018 17:29 UTC (Tue)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/749187/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then BUG(). Which is certainly no worse than the result of a stack allocation failure (i.e. stack overflow).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749187/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor749302"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 17:33 UTC (Wed)
                               by <b>mkatiyar</b> (guest, #75286)
                              [<a href="/Articles/749302/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; doing memory management the way kernel programmers like.</font><br>
<p>
unfortunately ppl do like to do crazy things like.<br>
<p>
foo(int x) {<br>
  int vla[x];<br>
  int y;<br>
<p>
 // size of x = <br>
  printf("%d\n", (&amp;y - &amp;vla[0])/sizeof(int *));<br>
 ....<br>
}<br>
<p>
This clearly won't work if vla is not on stack.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749302/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 18:15 UTC (Wed)
                               by <b>dtlin</b> (subscriber, #36537)
                              [<a href="/Articles/749310/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's UB with or without VLAs. Pointer arithmetic is only defined within the same object (or one past the end of an array).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749945"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2018 13:13 UTC (Thu)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/749945/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      By the way, is it allowed to have a pointer that is one past the end of a variable that isn't an array? Something like this:
<pre>
void print_ints(const int *begin, const int *end) {
  for (; begin &lt; end; ++begin) {
    printf("%d\n", *begin);
  }
}

int main() {
  int i = 42;
  print_ints(&amp;i, &amp;i + 1);
  return 0;
}
</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749945/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749946"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2018 13:17 UTC (Thu)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/749946/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When compiling this with -fsanitize=address, it doesn't complain, so it's probably OKâ€¦ but still, i isn't technically an array, right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749946/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2018 15:08 UTC (Thu)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/749969/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1570.pdf">http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1570.pdf</a> says "For the purposes of these operators ['+' and '-'], a pointer to an object that is not an element of an array behaves the same as a pointer to the first element of an array of length one with the type of the object as its element type.", immediately before defining the rules for pointer arithmetic (where it's undefined behaviour unless "both the pointer operand and the result point to elements of the same array object, or one past the last element of the array object"). So it sounds to me like your code is fine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor751733"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 12, 2018 23:24 UTC (Thu)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/751733/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah right, that is the part of the spec I was looking for, thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/751733/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor749234"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 8:04 UTC (Wed)
                               by <b>flewellyn</b> (subscriber, #5047)
                              [<a href="/Articles/749234/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All of this macrology...why not an inline function for max()?  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749234/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor749237"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 10:06 UTC (Wed)
                               by <b>Koral</b> (guest, #115236)
                              [<a href="/Articles/749237/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When a function is declared the type of the arguments are specified.<br>
max macro is type agnostic.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749237/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor749304"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Variable-length arrays and the max() mess</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2018 17:35 UTC (Wed)
                               by <b>mkatiyar</b> (guest, #75286)
                              [<a href="/Articles/749304/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Inline functions are not compile time...isn't it ? So you can't declare global variables using max.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/749304/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
