        <!DOCTYPE html>
        <html lang="en">
        <head><title>ELC: Using LTTng [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/384118/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/383595/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/384118/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>ELC: Using LTTng</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>April 21, 2010</br>
           </div>
<p>
Several tracing presentations were in evidence at this year's <a
href="http://www.embeddedlinuxconference.com/elc_2010/index.html">Embedded
Linux Conference</a>, including Mathieu Desnoyers's "<q>hands-on
tutorial</q>" on the <a href="http://lttng.org/">Linux Trace
Toolkit next generation</a> (LTTng).  Desnoyers showed how to use LTTng to
solve real-world performance and latency problems, while giving a good
overview of the process of Linux kernel problem solving.  The target was
embedded developers, but the presentation was useful for anyone interested
in finding and fixing problems in Linux itself, or applications running
atop it.
</p>

<p>
Desnoyers has been hacking on the kernel for many years, and was recently
awarded his Ph.D. in computer engineering <a
href="http://lwn.net/Articles/370992/">based</a> largely on his work with
LTTng. Since then, he has started his own company, <a
href="http://www.efficios.com/">EfficiOS</a> to do consulting work on LTTng
as well as helping various customers diagnose their performance problems.
In addition to LTTng itself, he also developed the <a
href="http://lttng.org/urcu">Userspace RCU library</a> that allows
user-space applications to use the Read-Copy-Update (RCU) data
synchronization technique that is used by the kernel.
</p>

<p>
LTTng consists of three separate components: patches to the Linux kernel to
add tracepoints along with the LTTng infrastructure and ring buffer, the LTT control
user-space application, and the LTTV GUI interface for viewing trace
output.  Each is available on the LTTng web site and there are <a
href="http://lttng.org/cgi-bin/gitweb.cgi?p=lttv.git;a=blob_plain;f=doc/developer/lttng-lttv-compatibility.html;hb=HEAD">versions</a>
for kernels going back to 2.6.12.  There is extensive <a
href="http://lttng.org/content/documentation">documentation</a> as well.
</p>

<h4>Lockless trace clock</h4>

<p>
The lockless trace clock is "<q>one major piece of LTTng that is
architecture dependent</q>".  This clock is a high-precision timestamp
derived from the processor's cycle counter that is placed on each trace
event.  The timestamp is coordinated between separate 
processors allowing system-wide correlation of events. 
On processors with frequency scaling and non-synchronized cycle counters, like
some x86 systems, the trace clock can get confused when the processor
operating frequency changes, so that feature needs to
be disabled before tracing. Desnoyers noted that Nokia had funded work for LTTng to
properly handle frequency scaling and power management
features of the ARM OMAP3 processor, but that it hasn't yet been done for x86.
</p>

<h4>Tracing strategy</h4>

<p>
A portion of the talk was about the tradeoffs of various tracing
strategies.  Desnoyers described the factors that need to be considered
when deciding on how to trace a problem including what kind of bug it is,
how reproducible it is, how much tracing overhead the system can tolerate,
the availability of the system to reproduce it on, 
whether it occurs only on production systems, and so on.  Each of these
things "<q>impact the number of tracing iterations available</q>".
It may be that because it occurs infrequently or is on a third-party
production system, one can only get a single tracing run, "<q>or you may
have the luxury of multiple trace runs</q>". 
</p>

<p>
Based on those factors, there are different kinds of tracing to choose from
in LTTng.  At the top level, you can use producer-consumer tracing,
where all of the enabled events are recorded to a filesystem, "flight
recorder" mode, where the events are stored in fixed-size memory buffers
and newer events overwrite the old, or both of these modes can be active at
once.  There are advantages and disadvantages
to each, of course, starting with higher overhead for producer-consumer
traces.  But the amount of data which can be stored for those types of traces is generally
much higher than for flight recorder traces.
</p>

<p>
Because there is generally an enormous amount of data in a trace, Desnoyers
described several techniques to help hone in on the problem area.  In
LTTng, events are grouped by subsystem into "channels" and each channel can
have a different buffer size for flight recorder mode.  That allows more backlog
for certain kinds of events, while limiting others.  In addition,
instrumentation (trace events, kernel markers) can be disabled to reduce
the amount of trace data that is generated.
</p>

<p>
Another technique is to use "anchors", specific events in the trace that
are the starting point for analysis.  The anchor is often used by going
backward in the trace from that point.  The anchors can either come from
instrumentation like the LTTng user-space tracer or kernel trace events, or
they can be generated by the analysis itself.  The longest timer interrupt
jitter (i.e. how far from the nominal time where it should happen) is an
example he gave of one kind of analysis-generated anchor.
</p>

<p>
A related idea is "triggers", which are a kind of instrumentation with a
side-effect.  By using <tt>ltt_trace_stop("name")</tt>, a trigger can stop
the tracing when a particular condition occurs in the kernel.  Using
<tt>lttctl</tt> from user space is another way to stop a trace.  Triggers
are particularly helpful for flight recorder traces, he said. 
</p>

<h4>Live demo</h4>

<p>
Desnoyers also did a demonstration of LTTng on two separate kinds of
problems both involving the scheduler.  One was to try to identify
sources of audio latency by running a program with a periodic timer that expired
every 10ms. The code was written to put an anchor into the trace data every
time the timer missed by more than 5ms.  He ran the program, then moved a
window around on the screen, which caused delays to the timer of up to 60ms.
</p>

<a href="http://lwn.net/Articles/384275/">
<img src="https://static.lwn.net/images/2010/lttv-sm.png" border=0 hspace=3 width=125 height=79
alt="[LTTV]" align="left">
</a>

<p>
Using that data, he brought up the LTTV GUI to look at what was going on.  It
was a bit hard to follow exactly what he was doing, but eventually he
narrowed it down to the scheduling of the X.org server.  He then
instrumented the kernel scheduler with a kernel marker to get more
information on how it was making its decisions.  Kernel markers were
proposed for upstream inclusion a ways back, but were roundly criticized
for cluttering up the kernel with things that looked like a debug
<tt>printk()</tt>. Markers are good for ad hoc tracepoints, but
"<q>don't try to push it upstream</q>", he warned. 
</p>

<p>
The other demo was to look at a buffer underrun in ALSA's <tt>aplay</tt>
utility.  The same scheduler marker was used to investigate that problem as well.
</p>

<h4>The status of LTTng</h4>

<p>
Perhaps the hardest question was saved to the end of the presentation: what
is the status of LTTng getting into the mainline?  Desnoyers seemed upbeat
about the prospects of that happening, partly because there has been so
much progress made in the kernel tracing area.  Most of the instrumentation
side has already gone in, and the tracer itself is ongoing work that he now
has time do.  He presented a "status of LTTng" presentation at the Linux
Foundation Collaboration Summit (LFCS), which was held just after ELC, and there
was agreement among some of the tracing developers to work together on
getting more of LTTng into the kernel.
</p>

<p>
Desnoyers does not see a problem with having multiple tracers in the
kernel, so long as they use common infrastructure and target different
audiences.  Ftrace is "<q>more oriented toward kernel
developers</q>", he said, and it has different tracers for specific
purposes.  LTTng on the other hand is geared toward users and user-space
programmers who need a look into the kernel to diagnose their problems.
With Ftrace developer Steven Rostedt participating in both the ELC and LFCS
talks&mdash;and agreeing with many of Desnoyers's ideas&mdash;the prospects
look good for at least parts of LTTng to make their way into the mainline
over the next year.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_tools-Kernel_tracing">Development tools/Kernel tracing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Tracing">Tracing</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Embedded_Linux_Conference-2010">Embedded Linux Conference/2010</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/384118/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor384558"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELC: Using LTTng</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2010 19:56 UTC (Fri)
                               by <b>danscox</b> (subscriber, #4125)
                              [<a href="/Articles/384558/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps a bit off-topic, but how does one pronounce the presenter's name?  Being Southern, I tend to pronounce it des-noy-yers.  However, the more French sounding des-noy-yay presents itself.  Of course, those may both be far off the mark ;-).<br>
<p>
Thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384558/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384561"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELC: Using LTTng</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2010 20:52 UTC (Fri)
                               by <b>compudj</b> (subscriber, #43335)
                              [<a href="/Articles/384561/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi,<br>
<p>
Both my first and last names are of French origins (I'm french canadian).<br>
<p>
Something close my name pronunciation for an English-speaker would be:<br>
<p>
My first name, Mathieu: "Ma-tee-eu"<br>
  ("ee" shorter than the English "ee")<br>
  ("eu" is close to the indefinite article "a" in English, with a sharper sound. <br>
  Better to listen to this sample:<br>
   audio sample corresponding to "[ø] ay rounded  	jeu, yeux, queue, bleu  	eu"<br>
at  <a href="http://www.ielanguages.com/frenchphonetics.html">http://www.ielanguages.com/frenchphonetics.html</a>)<br>
<p>
My last name, Desnoyers: "Day-nwa-yay".<br>
<p>
Thanks for asking,<br>
<p>
Mathieu<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384561/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor394773"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELC: Using LTTng</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2010 22:13 UTC (Sun)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/394773/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd say that LTT is more for looking at what happens in the whole system (from the kernel point of view), especially when you don't have any idea about what could be reason for the issue you're investigating whereas ftrace is more for looking at some specific area within the kernel, when you either already have some idea about the (potential) cause for the issue or are only interested about a specific kernel area (like say a file system maintainer would).<br>
<p>
LTTv being able to easily process gigabyte sized trace data and to view it interactively helps a lot.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/394773/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
