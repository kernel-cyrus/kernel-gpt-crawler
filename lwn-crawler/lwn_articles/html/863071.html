        <!DOCTYPE html>
        <html lang="en">
        <head><title>Descriptorless files for io_uring [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/863071/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/862959/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/863071/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Descriptorless files for io_uring</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 19, 2021</br>
           </div>
The lowly file descriptor is one of the fundamental objects in Linux
systems.  A file descriptor, which is a simple integer value, can refer to an
open file — or to a network connection, a running process, a loaded BPF
program, or a namespace. 
Over the years, the use of file descriptors to refer to transient objects
has grown to the point that it can be difficult to justify an API that
uses anything else.  Interestingly, though, the <a
href="/Articles/776703/">io_uring subsystem</a> looks as if it is moving
toward its own number space separate from file descriptors.
<p>
Io_uring was created to solve the asynchronous I/O problem; this is a
functionality that Linux has never supported as well as users would have
liked.  User space can queue operations in a memory segment that is shared
directly with the kernel, allowing those operations to be initiated, in
many cases, without the need for an expensive system call.  Similarly,
another shared-memory segment contains the results of those operations once
they complete.  Initially, io_uring focused on simple operations (reading
and writing, for example), but it has quickly <a
href="/Articles/810414/">gained support for many other 
system</a> calls.  It is evolving into the general asynchronous-operation API
that Linux systems have always lacked.
<p>
<h4>Fixed files</h4>
<p>
A read or write operation must specify both the file descriptor to be
operated on and 
a buffer to hold the data.  There is a fair amount of setup work that must
be done in the kernel before that operation can proceed, though.  That
includes taking a reference to the open file (to prevent it from going away
while the operation is underway) and locking down the memory for the buffer.
That overhead can, in many cases, add up to a significant part of the
total cost of the operation; since programs tend to perform multiple
operations with the same file descriptors and the same buffers, this
overhead can be paid many times for the same resources, and it can add up.
<p>
From the beginning, io_uring has included a way to reduce that overhead in
the form of the <a
href="https://manpages.debian.org/unstable/liburing-dev/io_uring_register.2.en.html"><tt>io_uring_register()</tt>
system call</a>:
<p>
<pre>
    int io_uring_register(unsigned int fd, unsigned int opcode,
                          void *arg, unsigned int nr_args);
</pre>
<p>
If <tt>opcode</tt> is <tt>IORING_REGISTER_BUFFERS</tt>, the io_uring
subsystem will perform the setup work for the <tt>nr_args</tt> buffers
pointed to by 
<tt>arg</tt> and keep the result; those buffers can then be used multiple
times without paying that setup cost each time.  If, instead,
<tt>opcode</tt> is <tt>IORING_REGISTER_FILES</tt>, then <tt>arg</tt> is
interpreted as an array of <tt>nr_args</tt> file descriptors.  Each file in
that array will be referenced and held open so that, once again, it can be
used efficiently in multiple operations.  These file descriptors are called
"fixed" in io_uring jargon.
<p>
There are a couple of interesting aspects to fixed files.  One is that the
application can call <tt>close()</tt> on the file descriptor associated
with a fixed file, but the reference within io_uring will remain and will
still be usable.  The other is that a fixed file is not referenced in
subsequent io_uring operations by its file-descriptor number.  Instead,
operations use the offset where that file descriptor appeared in the
<tt>args</tt> array during the <tt>io_uring_register()</tt> call.  So if
file descriptor&nbsp;42 was placed in <tt>args[13]</tt>, it will
subsequently be known as fixed file&nbsp;13 within io_uring.
<p>
So the io_uring subsystem has, in essence, set up a parallel descriptor
space that can refer to open files, but which is independent of the regular
file descriptors.  In current kernels, though, it is still necessary to
obtain a regular file descriptor for a file and register it for the file to
appear in the io_uring fixed-file space.  If, however, an application will
never do anything with a file outside of io_uring, the creation of the
regular file descriptor serves no real purpose.
<p>
It is, indeed, possible to create, use, and close a file descriptor
entirely within io_uring.  As noted above, this subsystem is not limited to
simple I/O; it is also possible to open files and accept network
connections with io_uring operations.  At the moment, though, user space
must intervene between the creation of the file descriptor and its use to
install it as a fixed file.  The cost of this work is not huge but it, too,
can add up in an application that processes a lot of file descriptors.
<p>
<h4>No more file descriptors</h4>
<p>
To address this problem, Pavel Begunkov has posted <a
href="/ml/linux-kernel/cover.1625657451.git.asml.silence@gmail.com/">this
patch series</a> adding a direct-to-fixed open operation.  The io_uring
operations that can create file descriptors — the equivalents of the <a
href="https://man7.org/linux/man-pages/man2/openat2.2.html"><tt>openat2()</tt></a>
and <a
href="https://man7.org/linux/man-pages/man2/accept.2.html"><tt>accept()</tt></a>
system calls — gain the ability to, instead, store their result directly into
the fixed-file table at a user-supplied offset.  When this option is
selected, there is no regular file descriptor created at all; the io_uring
alternative descriptor is the only way to refer to the file.
<p>
The most likely use case for this feature is network servers; a busy server
can create (with <tt>accept()</tt>) and use huge numbers of file
descriptors in a short period of time.  While io_uring operations, being
asynchronous, can generally be executed in any order, it is possible to
chain operations so that one does not begin before the previous one has
successfully completed.  Using this capability, a network server could
queue a series of operations to accept the next incoming connection
(storing it in the fixed-file table), write
out the standard greeting, and initiate a read for the first data from the
remote peer.  User space would only need to become involved once that data
has arrived and is ready to be processed.
<p>
This is clearly an interesting capability, and it shows how io_uring is
quickly evolving into an alternative programming interface for Linux
systems.  The separation from the traditional file-descriptor space is just
one more step in that direction.  With the future addition of <a
href="/Articles/847951/">BPF support</a> (which is <a
href="/ml/linux-kernel/23168ac0-0f05-3cd7-90dc-08855dd275b2@gmail.com/">still
under development</a>), the separation will become even more pronounced;
the user-space component of some applications may become small indeed.
Use of the io_uring API will probably not be worthwhile for the majority
of applications, but for some it can make a large difference.  It will be
interesting to see where it goes from here.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#io_uring">io_uring</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/863071/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor863483"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2021 17:58 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/863483/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can we get these lightweight file descriptors for userspace as well?<br>
<p>
The last time I was profiling an app that needed a lot of openat calls, the locking and searching for a free file descriptor in the kernel took something like 20% of the total time. We basically need a way to say: &quot;I don&#x27; care about descriptors being dense and all of that POSIX nonsense, just give me a fucking number!&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863483/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863504"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2021 20:30 UTC (Mon)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/863504/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s very much the use case this is for. Entries in the fixed file table are assigned by userspace choosing which one to use, not by the kernel assigning a free one.<br>
<p>
This is similar to how X Window System clients assign resource IDs: when you create an object like a window or pixmap, you assign the ID yourself from a range of valid IDs you were given, and you can then batch creation and usage of an object in the same batch.<br>
<p>
If you then want to use the object outside of io_uring, you can always use an io_uring operation to link the fixed-file into a normal file descriptor, and then use it with normal syscalls. And if you want, you can assign a specific file descriptor yourself rather than relying on the kernel&#x27;s &quot;allocate the lowest unused number&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863504/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 0:46 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/863533/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; And if you want, you can assign a specific file descriptor yourself rather than relying on the kernel&#x27;s &quot;allocate the lowest unused number&quot;.</font><br>
<p>
How?!? This would help me a lot. I can&#x27;t change all the read/write calls to use io_uring, but I can do that with opens.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863542"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 6:03 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/863542/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We can add an operation to link a fixed file into the process file descriptor table, given a fixed file index and an fd. Effectively, dup3 with one fixed file as the source and a non-fixed file as the destination.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863542/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863543"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 6:44 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/863543/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So basically I&#x27;ll need to pre-open a dummy file, dup() it a ton of times to reserve descriptors and then have some kind of an allocator for them? How would I do close()? Just use the magic io_uring dup() back to the original dummy file descriptor?<br>
<p>
I guess it can work, but it seems kinda hacky.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863543/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 7:08 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/863544/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are you a library or a program? If you&#x27;re a program, you own the descriptor space; just pick a high base and allocate descriptors above that as you see fit.<br>
<p>
If you&#x27;re a library or otherwise have to cooperatively manage the file descriptor space, you have to take more care, but you could still let your caller tell you a range you can use. Or we could add operations to reserve a range of descriptors for future use.<br>
<p>
But ultimately, the best way to have a private space of file descriptors you can allocate as you see fit is to use io_uring with your own private ring and allocate from its fixed file table.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863545"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 7:28 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/863545/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Are you a library or a program? </font><br>
A program mostly.<br>
<p>
<font class="QuotedText">&gt; If you&#x27;re a program, you own the descriptor space; just pick a high base and allocate descriptors above that as you see fit.</font><br>
But how can I do that? Is it something that&#x27;s still being planned?<br>
<p>
I think I might be missing something, but as far as I understand, all syscalls that create file descriptors can&#x27;t accept number ranges.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863545/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 8:43 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/863546/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
dup2/3 can both create new file descriptors at specific numeric values (just pass whatever number you want as newfd). Of course, you still have to call them one at a time, and you still have to track which numbers are available on your own, but the functionality does exist. The concern, as josh noted, is that if a library did this, and then a different library tried to pull the same trick, they could easily end up walking all over each other. But a program doesn&#x27;t really need to worry about that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863920"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2021 7:44 UTC (Thu)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/863920/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn&#x27;t that be trivial to solve by just having parameters in the library for base fd and number of fds after that to use?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863920/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865094"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2021 20:33 UTC (Tue)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865094/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be, if a library could ensure that its reservation didn&#x27;t conflict with another library&#x27;s reservation. There should be a syscall like mmap(PROT_NONE) to just reserve a range of fds, and fail if it conflicts with an existing reservation. Then the system would promise to never open(), dup(), etc. onto any reserved fd.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865094/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor863632"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 16:54 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/863632/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So does this then look a bit like FORTRAN?<br>
<p>
Okay, you&#x27;d need a new open command, but first you&#x27;d call a routine to set up your io_uring, and then you have your private file descriptor space - iirc 1 was the tty, 2 might have been the tape drive, up to about 4, and then your program simply allocated file descriptors from 5 upwards. Can&#x27;t remember the syntax but it was something like<br>
<p>
OPEN( unit, filename, attributes)<br>
<p>
I guess in C you&#x27;d end up doing something like &quot;fd = open(unit, filename, attributes)&quot; where &quot;unit&quot; would be your index into the ring, and &quot;fd&quot; would be whatever the linux file descriptor was, that your uring had block pre-allocated.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863632/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863949"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2021 12:18 UTC (Thu)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/863949/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Approximately right for Fortran (no longer all caps).  Plus the unit can be an embedded data statement.<br>
<p>
I&#x27;ve been watching this and similar things wondering how much it differs from old methods.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863949/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor863510"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 19, 2021 20:43 UTC (Mon)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/863510/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another option is a prctl that would allow a process to opt into relaxed FD allocation rules. The vast majority of software would Just Work in that environment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863510/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865095"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2021 20:35 UTC (Tue)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865095/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There should absolutely be such a facility. It would be a huge perf win in many cases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865095/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor863534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 0:48 UTC (Tue)
                               by <b>JohnVonNeumann</b> (guest, #131609)
                              [<a href="/Articles/863534/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a world where traditional file descriptors are no longer used?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2021 13:34 UTC (Thu)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/863956/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, it&#x27;s called Win32.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2021 20:35 UTC (Tue)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865096/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except they&#x27;re called HANDLE ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865101"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 4, 2021 20:06 UTC (Wed)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/865101/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They are not traditional file descriptors. The significant difference is they are not allocated as small integers, but rather arbitrary 32/64-bit integers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865101/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor863550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 8:51 UTC (Tue)
                               by <b>ddevault</b> (subscriber, #99589)
                              [<a href="/Articles/863550/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The degree to which io_uring is changing the perspective on I/O in Linux is really quite profound. It seems to me like one of the most significant innovations in mainstream OS design in the last decade. I suspect that Linux is incubating a design which will flourish as the primary I/O paradigm of a new kernel in the future.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 16:56 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/863635/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And is io_uring just a copy of a technique that&#x27;s been around since the dawn of modern computing, just forgotten as a result of *nix trampling everything else underfoot?<br>
<p>
It wouldn&#x27;t surprise me if the basic idea of it comes from the 60s - much of what we learnt then has been forgotten ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor864658"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 30, 2021 11:58 UTC (Fri)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/864658/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s not a forgotten technique, it&#x27;s a common technique in hardware. For instance, it&#x27;s how NVMe works, it&#x27;s very common in network interfaces, and all modern GPUs use command buffers. In the software side, we have things like Wayland, and network protocols like X11. What&#x27;s unusual is using it as a way to talk to the kernel, I don&#x27;t recall any operating system which uses ring buffers instead of synchronous calls to the kernel, even microkernels with message queues AFAIK use a synchronous &quot;add this message to the queue&quot; system call.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864658/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 4, 2021 20:40 UTC (Wed)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/865243/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Now I imagined an OS with *no* system calls. Rather, you just put a message in your message queue, and the kernel checks it whenever you get pre-empted, and you can also call SYSENTER to yield your time slice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865276"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2021 10:31 UTC (Thu)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/865276/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p><tt>io_uring</tt> is headed that way - you can run it in a mode where it puts commands in one queue, Linux picks them up and executes them, and puts the results in the other queue. Doesn't yet handle all Linux system calls (ioctl being the next one on the list), but it's a direction that Linux is taking.
<p>Done sensibly, it could be a very efficient way to work; you need a few syscalls to make it work well, but SYSENTER/SYSCALL give you register space to handle that. All syscalls tell the kernel to check the submission queue for new work, but the kernel is always allowed to check the queue at its discretion. The queue itself has dependency marks in it, so that the kernel can execute work out of order if there's no flagged dependencies (e.g. so that you can submit GPU work, network reads and disk writes all in parallel). However, if you do mark dependencies, a work item cannot start until all its dependencies are complete.
<ol>
<li>Syscall 1 simply tells the kernel that there is work in the submission queue that the application would like the kernel to do. This call returns "quickly" - it just ensures that the kernel knows to check your submission queue - it's your "yield your timeslice" option.
<li>Syscall 2 asks the kernel to block the application until a timeout is reached, <em>or</em> a given submitted work item has completed. Because the queue can complete out of order at kernel discretion, this says nothing about ordering other than that already supplied in the queue. It's allowed to return early, and it's on the application to check completion properly - e.g. loop until the blocking item has completed. As a quality of implementation issue, though, the kernel should aim to avoid returning until the timeout is reached, or the selected item has completed.
<li>Syscall 3 asks the kernel to block the application until a timeout is reached, or until there is space in the submission queue for N more items. Again, this syscall can return early, and it's up to the application to loop until there's enough space in the submission queue.
<li>Syscall 4 sets up your submission and completion queues (where in your VA space they live, how large they are etc). An application should be allowed multiple queues if it wants to avoid locking (e.g. have a thread-local queue for thread-local background work), but there is no way to have the kernel enforce dependencies between work items in different queues (two submission queues run in parallel at all times).
<li>Syscall 5 tears down a queue pair when it's no longer needed.
</ol>
<p>With those 5 syscalls, you have a full system for a queued syscall mechanism that gives the kernel lots of freedom to run work in parallel (although it's not obliged to), and gives applications lots of freedom to be high performance.
<p>Syscall 1 is your idea, and is necessary.
<p>You need syscalls 2 and 3 to block the application if it cannot do any further useful work without a response from the outside world; the timeout allows the application to still do background maintenance (cache TTL cleanouts, for example) even though the outside world is not affecting it yet. Without these syscalls, the application busy-loops on the kernel completing work, wasting CPU time - and given that you want the kernel to block you, you might as well be able to tell the kernel what it will take for you to be able to do something so that it can avoid giving you CPU cycles if you're not going to use them.
<p>And syscalls 4 and 5 <em>could</em> be simply something done at process creation time, but it's powerful to be able to run (say) queue per worker thread and not have to do application-level locking when there truly isn't a dependency between threads.



      
          <div class="CommentReplyButton">
            <form action="/Articles/865276/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865402"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 6, 2021 1:14 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/865402/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think your syscall 1, 2, and 3 could usefully be combined into one system call with two arguments besides the queue ID: &quot;min_free&quot; and &quot;timeout&quot;. If timeout is zero then you get syscall 1 (no waiting). Otherwise the thread should be woken when any item in the queue with a &quot;notify completion&quot; flag enabled has completed, or (if timeout is greater than zero) when the timeout expires, or (if min_free is greater than zero) when there are at least min_free available slots at the tail of the submission queue. (The &quot;has completed&quot; state should be persistent, to avoid race conditions: If any &quot;notify completion&quot; item completed since the syscall last returned then it should return immediately rather than waiting for the next event.)<br>
<p>
The case which was missed in splitting up the syscalls is the combination of 2 &amp; 3: the thread may be able to do useful work if *either* a prior request completes *or* space becomes available in the queue, but with separate syscalls there is no way to wait for whichever occurs first.<br>
<p>
If a process is created with an initial submission queue and there is support for queuing &quot;create queue&quot; and &quot;destroy queue&quot; commands then you don&#x27;t really need syscalls 4 &amp; 5, which brings us back down to a single syscall.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865402/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor865696"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2021 15:53 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/865696/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Now I imagined an OS with *no* system calls.</font><br>
<p>
I&#x27;ve been thinking about that for a few months, as a though experiment: would it be possible to create an operating system based solely on multiple asynchronous ring buffers, not only for IPC but also for all communication with the kernel, to the extreme of having no system call at all?<br>
<p>
I came to the conclusion that there are two important exceptions. The first one is yielding the time slice, either when there&#x27;s nothing to do, or as an optimization to wake up another task to read something the current task wrote to a ring buffer. Since the point of this exercise is to go to the extreme, that would be the single system call, but it would have no inputs and no outputs (and all registers would be kept unchanged); the kernel would read what to do from one of the ring buffers (&quot;wake up task X&quot;, &quot;wake up task Y&quot;, &quot;I don&#x27;t need the timeslice anymore until another task wakes me up&quot;), and unless told otherwise (&quot;I don&#x27;t need the timeslice anymore&quot;) would return immediately after reading these messages.<br>
<p>
The second one is reading the clock, which must be synchronous and fast. For that, instead of synchronous system calls, or asynchronous messages through a ring buffer, it should directly read hardware registers visible to user space (CNTPCT/CNTFRQ or similar) and apply adjustments read from a shared read-only page (this is AFAIK similar to what the Linux VDSO already does).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865696/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor863659"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 19:26 UTC (Tue)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/863659/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given that it implements Windows NT designs, it is hardly an innovations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863659/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863660"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 19:30 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/863660/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nope, it&#x27;s not even close to the NT design.<br>
<p>
NT implements completion ports for async IO, not ring-based pull communication.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863660/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863869"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2021 16:44 UTC (Wed)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/863869/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nor do windows completion ports have support for sensible handling of buffers when handling many connections, readiness style notification (not building data to send out before socket is ready is useful for efficiency, even if one otherwise uses completion notification), ...<br>
<p>
However, the big issue with windows IOPC imo are the awful docs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863869/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor864552"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 29, 2021 6:11 UTC (Thu)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/864552/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Nor do windows completion ports have support for sensible handling of buffers when handling many connections</font><br>
<p>
I haven&#x27;t tried using Windows&#x27;s &quot;registered IO&quot;, their equivalent to io_uring&#x27;s ring buffer and registered buffers... is it particularly broken somehow?<br>
<p>
<font class="QuotedText">&gt; readiness style notification (not building data to send out before socket is ready is useful for efficiency, even if one otherwise uses completion notification), ...</font><br>
<p>
FWIW, IOCP actually does support readiness-style notification -- the windows kernel only understands IOCP, not `select`, so Winsock `select` is actually using IOCP syscalls underneath. The API for this was supposed to be completely internal and undocumented, but someone (@piscisaureus) reverse-engineered it, and it&#x27;s now used in a number of modern event-loop libraries like libuv, tokio, trio, etc. (And also apparently &quot;Starcraft: Remastered&quot;, according to the wine issue tracker.) It&#x27;s awkward and janky and has some outright bugs you have to work around, but it&#x27;s so much better than dealing with `select` that it&#x27;s worth it.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864552/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor864557"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 29, 2021 7:34 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/864557/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I haven&#x27;t tried using Windows&#x27;s &quot;registered IO&quot;, their equivalent to io_uring&#x27;s ring buffer and registered buffers... is it particularly broken somehow?</font><br>
<p>
Well, RIO is kinda a completely separate API from regular IOCP and overlapped IO. It is indeed similar to io_uring, albeit more limited.<br>
<p>
IOCP is pretty well designed, actually. It&#x27;s a way better design than the classic POSIX asynchronous APIs, but it&#x27;s around 20 years old by now and its age is showing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864557/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor864725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 31, 2021 0:56 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/864725/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  &gt; Nor do windows completion ports have support for sensible handling of buffers when handling many connections</font><br>
<p>
<font class="QuotedText">&gt; I haven&#x27;t tried using Windows&#x27;s &quot;registered IO&quot;, their equivalent to io_uring&#x27;s ring buffer and registered buffers... is it particularly broken somehow?</font><br>
<p>
Well, it&#x27;s not really IOCP network IO, but something that can be bolted sideways to iocp :). But yes, fair enough.<br>
<p>
<p>
<font class="QuotedText">&gt;  &gt; readiness style notification (not building data to send out before socket is ready is useful for efficiency, even if one otherwise uses completion notification), ...</font><br>
<p>
<font class="QuotedText">&gt; FWIW, IOCP actually does support readiness-style notification -- the windows kernel only understands IOCP, not `select`, so Winsock `select` is actually using IOCP syscalls underneath. The API for this was supposed to be completely internal and undocumented, but someone (@piscisaureus) reverse-engineered it, and it&#x27;s now used in a number of modern event-loop libraries like libuv, tokio, trio, etc. (And also apparently &quot;Starcraft: Remastered&quot;, according to the wine issue tracker.) It&#x27;s awkward and janky and has some outright bugs you have to work around, but it&#x27;s so much better than dealing with `select` that it&#x27;s worth it.</font><br>
<p>
That is *very* interesting. I&#x27;ve occasionally looked in that space because the winsock restrictions are problematic for some things in postgres..<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 5, 2021 1:43 UTC (Thu)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/865261/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; That is *very* interesting. I&#x27;ve occasionally looked in that space because the winsock restrictions are problematic for some things in postgres..</font><br>
<p>
If you want to dig into this trick, I think this issue is the most complete compendium of knowledge currently available: <a rel="nofollow" href="https://github.com/python-trio/trio/issues/52">https://github.com/python-trio/trio/issues/52</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor864652"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 30, 2021 10:40 UTC (Fri)
                               by <b>da4089</b> (subscriber, #1195)
                              [<a href="/Articles/864652/">Link</a>] 
      </p>
      
      </div>
      </summary>
      In fact, Microsoft has just announced that they're copying the io_uring design for Windows: see <a href="https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/">https://windows-internals.com/i-o-rings-when-one-i-o-operation-is-not-enough/</a>


      
          <div class="CommentReplyButton">
            <form action="/Articles/864652/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor863556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring - lsof interaction?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 10:02 UTC (Tue)
                               by <b>darmengod</b> (subscriber, #130659)
                              [<a href="/Articles/863556/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would &quot;lsof&quot; be able to list a process&#x27; references to files which only remain as &quot;fixed files&quot; within io_uring?<br>
<p>
Will this have any major implications with regards to telling which files a program is referencing at any given time using standard tools?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863559"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring - lsof interaction?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 10:54 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/863559/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah ... more specifically will there be a /proc interface to expose data about these open descriptors?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863559/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor863713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring - lsof interaction?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2021 7:44 UTC (Wed)
                               by <b>colo</b> (guest, #45564)
                              [<a href="/Articles/863713/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is my #1 concern for innovations like this. Also, about the emerging trend of implementing application features via eBPF code loaded into the kernel - will I lose the ability to trace all these applications&#x27; activities via bpftrace (and friends) as a consequence?<br>
<p>
It certainly is a future I am a tad afraid of.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor864236"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring - lsof interaction?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2021 6:59 UTC (Sun)
                               by <b>gulsef073</b> (guest, #123117)
                              [<a href="/Articles/864236/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s increasingly possible to observe BPF programs these days. We can surely profile them: <a href="https://linuxplumbersconf.org/event/4/contributions/294/">https://linuxplumbersconf.org/event/4/contributions/294/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864236/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor863656"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 20, 2021 18:37 UTC (Tue)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/863656/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Were does it go from here? Well, the instructions to uring look a lot like a programming language, as a way to construct entire IO pipelines. So obviously the next step is a JIT for that language!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863656/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863702"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2021 3:44 UTC (Wed)
                               by <b>liam</b> (guest, #84133)
                              [<a href="/Articles/863702/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      I think you mean <a href="https://lore.kernel.org/io-uring/4a553a51-50ff-e986-acf0-da9e266d97cd@gmail.com/">this</a>?



      
          <div class="CommentReplyButton">
            <form action="/Articles/863702/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863879"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2021 18:34 UTC (Wed)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/863879/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Haha, and here I thought I would have an original though on the internet! ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863879/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863897"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2021 23:19 UTC (Wed)
                               by <b>liam</b> (guest, #84133)
                              [<a href="/Articles/863897/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We&#x27;ll not tolerate any who harbor such ambitions here! We&#x27;re not slashdot :)<br>
BTW, lwn produced an article on this topic a few months ago: <a href="https://lwn.net/Articles/847951/">https://lwn.net/Articles/847951/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863897/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor874664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 1, 2021 19:34 UTC (Mon)
                               by <b>Deleted user 129183</b> (guest, #129183)
                              [<a href="/Articles/874664/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Haha, and here I thought I would have an original though on the internet! ;)</font><br>
<p>
Ah yeah, the good old phenomenon of retroactive plagiarism – that’s when you think you finally have an original, sometimes revolutionary thought, then you learn that some obscure German philosopher wrote a book about it already 200 years ago. Or in this case, a post on a mailing list six months ago.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor864001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Quick question for those in the know:  Use for computational offload engines?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2021 15:15 UTC (Thu)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/864001/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is anyone currently looking at io_uring to manage data transfers from a host to computational offload engines (OpenCL-ish queues via OpenACC-, OpenMP-, or OneAPI-level-zero interfaces)?<br>
<p>
Quick searching gives me a sense that it&#x27;s an &quot;oh cool idea!&quot; response.  I&#x27;d be interesting in finding active projects rather than starting from scratch.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor864002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2021 15:32 UTC (Thu)
                               by <b>wtarreau</b> (subscriber, #51152)
                              [<a href="/Articles/864002/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m interested in seeing how this evolves. FDs in modern programs are a real pain. Seeing close() take 30% of the CPU sometimes is a nightmare. And not being able to prevent some FDs from being reused too early between threads requires a huge amount of trickery, where quite frankly, sometimes I&#x27;d prefer to call accept() with *my* expected FD and let it use it instead of having the bad surprise that it uses the one that was just enumerated by epoll_wait() the nanosecond before close() kicked.<br>
<p>
And some outdated rules such as &quot;allocate the lowest one&quot; cost a lot for no benefit in highly loaded network programs. Picking any from a recycled pool would be way better.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865093"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2021 20:25 UTC (Tue)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865093/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The paper &quot;The Scalable Commutativity Rule&quot; (<a href="https://people.csail.mit.edu/nickolai/papers/clements-sc-tocs.pdf">https://people.csail.mit.edu/nickolai/papers/clements-sc-...</a>) specifically calls out the lowest-available-number-reused guarantee as an example of how POSIX makes some system calls inherently unscalable by not allowing them to commute (for no really good reason in this case).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865093/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor962928"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2024 19:35 UTC (Tue)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/962928/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; And some outdated rules such as "allocate the lowest one" cost a lot for no benefit in highly loaded network programs. Picking any from a recycled pool would be way better.</span><br>
<p>
open(O_WHAT_IS_POSIX) ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/962928/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor962950"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2024 0:35 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/962950/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can't add new flags to open() :(<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/962950/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor865092"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2021 20:20 UTC (Tue)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865092/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is how epoll should have been designed from the beginning. How anyone thought it was reasonable to allow passing an epoll fd between processes, but then require a registered fd to be deregistered using its *original integer value* (thus making it impossible to deregister an fd in a different process than the one that created it) is utterly beyond me, and says a lot about the lack of rigorous (or even elementary) design review in Linux kernel development. If epoll had allowed referencing registered fds by an offset like io_uring does, I think that would have been a fine solution to this (now unfixable) problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865092/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865151"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 4, 2021 11:39 UTC (Wed)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/865151/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would also fix the crazy issue where epoll can return notifications for a closed FD.<br>
<p>
<font class="QuotedText">&gt; Q6  Will closing a file descriptor cause it to be removed from all epoll sets automatically?</font><br>
<p>
<font class="QuotedText">&gt; A6  Yes, but be aware of the following point.  A file descriptor is a reference to an open file description (see open(2)).  Whenever a file descriptor is  duplicated via dup(2), dup2(2), fcntl(2) F_DUPFD, or fork(2), a new file descriptor referring to the same open file description is created.  An open file description continues to exist until all file descriptors referring to it have been closed.  A file descriptor is removed from an epoll set only after all the  file descriptors  referring  to  the  underlying open file description have been closed (or before if the file descriptor is explicitly removed using epoll_ctl(2) EPOLL_CTL_DEL).  This means that even after a file descriptor that is part of an epoll set has been closed, events may be reported for that  file  descriptor if other file descriptors referring to the same underlying file description remain open.</font><br>
<p>
So if you have a descriptor in epoll that gets passed to a child then you will continue getting notifications from that descriptor and you can&#x27;t do anything about it. If you close it yourself and open another file that gets the same FD, you get maximum confusion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865151/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865220"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 4, 2021 18:07 UTC (Wed)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865220/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Bottom line: the epoll interface was designed by someone who didn&#x27;t understand the difference between a file descriptor and an open file description. Sure, he was basically just copying Linus&#x27;s offhand back-of-a-napkin design sketch from LKML, but he had plenty of time to think it through (as I think Linus would have done), and see where the naive design fell over. If nothing else, he could have just copied a design that actually works from FreeBSD (see what a difference an actual design review process makes, as opposed to &quot;we only look at working code&quot;?).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865220/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor865403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 6, 2021 14:59 UTC (Fri)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/865403/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yea. That epoll uses the pair {fd-number, file-description-pointer} for modification/deregistration -- where the latter is looked up via the former, and BOTH must match the original registration ... is really quite unfortunate. If you open a file on FD 5, register it with epoll, then dup2(5, 6); close(5), you cannot unregister it anymore. Neither passing 5 OR 6 to epoll_ctl will work. (Of course, you can dup fd 6 back onto 5. THEN you can pass 5 to epoll_ctl to unregister it...) It really is just a broken API.<br>
<p>
But the fix would&#x27;ve been super-simple, it didn&#x27;t need to invent any new &quot;offset&quot; mechanisms, or descriptorless files, or prohibit inheritance of the epoll configuration across fork(). There&#x27;s a perfectly good piece of data that should&#x27;ve bee used as a unique key: the user-provided &quot;epoll_data_t data;&quot; field! That is an arbitrary 64-bit value provided by the caller during registration, which, most importantly, is the (only) identifier passed BACK to the caller on every epoll_wait event report. If epoll had used that as a unique key, then de-registering an unwanted registration would be as simple as passing the same &quot;data&quot; you received from epoll_wait back in to epoll_ctl(EPOLL_CTL_DEL). Oh well.<br>
<p>
At the cost of maintaining a second rb-tree indexed by &quot;data&quot; to the epoll structure, this could possibly even be fixed. Add two new operations, EPOLL_CTL_MOD2 and EPOLL_CTL_DEL2, which ignore the &quot;fd&quot; parameter, and instead look up the epoll entry to delete/modify using &quot;data&quot;. Ideally, there would be a requirement that &quot;data&quot; be unique, but that would be an incompatible change, so we can&#x27;t do that. However, these APIs can just use the first entry with a given &quot;data&quot; key, if there are multiple. Not ideal, but should suffice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor865500"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Descriptorless files for io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 6, 2021 17:48 UTC (Fri)
                               by <b>tobin_baker</b> (subscriber, #139557)
                              [<a href="/Articles/865500/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s a great point: all epoll needed to do was pass a unique cookie for each registration back to the caller. It would be interesting to review the LKML discussion on the original epoll patches and see if this issue was ever brought up.<br>
<p>
Sadly, this design flaw prevents me from passing epoll descriptors over Unix sockets (for an unusual but legit use case). Obviously, it also prevents using an inherited epoll descriptor across fork() as well. It should go without saying that no fd-based interface that doesn&#x27;t allow freely passing its fds between processes should ever be accepted (because that violates the fundamental semantics of fds), but somehow Linus has failed to enforce that in this and other cases (mostly involving Davide Libenzi, btw).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/865500/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
