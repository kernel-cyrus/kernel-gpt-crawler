        <!DOCTYPE html>
        <html lang="en">
        <head><title>Checkpoint/restart: it's complicated [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/414264/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/413521/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/414264/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Checkpoint/restart: it's complicated</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 9, 2010</br>
           </div>
At the recent <a href="/Articles/412749/">Kernel Summit checkpoint/restart
discussion</a>, developer Oren Laadan was asked to submit a trimmed-down
version of the patch which would just show the modifications to existing
core kernel code.  Oren duly responded with a "<a
href="/Articles/412887/">naked patch</a>" which, as one might have
expected, kicked off a new round of discussion.  What many observers may
not have expected was the appearance of an alternative approach to the
problem which has seemingly been under development for years.  Now we have
two clearly different ways of solving this problem but no apparent increase
in clarity; the checkpoint/restart problem, it seems, is simply
complicated.
<p>
The responses to Oren's patch will not have been surprising to anybody who
has been following the discussion.  Kernel developers are nervous about the
broad range of core code which is changed by this patch.  They don't like
the idea of spreading serialization hooks around the kernel which, the
authors' claims to the contrary notwithstanding, look like they could be a
significant maintenance burden over time.  It is clear that kernel
checkpoint/restart can never handle all processes; kernel developers wonder
where the real-world limits are and how useful the capability will be in
the end.  The idea of moving checkpointed processes between kernel versions
by rewriting the checkpoint image with a user-space tool causes kernel
hackers to shiver.  And so on; none of these worries are new.
<p>
Tejun Heo <a href="/Articles/414268/">raised all these issues</a> and
more.  He also called out an interesting alternative checkpoint/restart
implementation called <a href="http://dmtcp.sourceforge.net/">DMTCP</a>,
which solves the problem entirely in user space.  With DMTCP in mind, Tejun
concluded:
<p>
<div class="BigQuote">
	I think in-kernel checkpointing is in awkward place in terms of
	tradeoff between its benefits and the added complexities to
	implement it.  If you give up coverage slightly, userland
	checkpointing is there.  If you need reliable coverage, proper
	virtualization isn't too far away.  As such, FWIW, I fail to see
	enough justification for the added complexity.
</div>
<p>
As one might imagine, this post was followed by an extended conversation
between the in-kernel checkpoint/restart developers and the DMTCP
developers, who had previously not put in an appearance on the kernel
mailing lists.  It seems that the two projects were each surprised to learn
of the other's existence.
<p>
The idea behind DMTCP is to checkpoint a distributed set of processes
without any special support from the kernel.  Doing so requires support
from the processes themselves; a checkpointing tool is injected into their
address spaces using the <tt>LD_PRELOAD</tt> mechanism.  DMTCP is able to
checkpoint (and, importantly, restart) a wide variety of programs,
including those running in the Python or Perl interpreters and those using
GNU Screen.  DMTCP is also used to support the <a
href="http://urdb.sourceforge.net/">universal reversible debugger
project</a>.  It is, in other words, a capable tool with real-world uses.
<p>
Kernel developers naturally like the idea of eliminating a bunch of
in-kernel complexity and solving a problem in user space, where things are
always simpler.  The only problem is that, in this case, it's not
necessarily simpler.  There is a surprising amount that DMTCP can do with
the available interfaces, but there are also some real obstacles.  Quite a
bit of information about a process's history is not readily available from
user space, but that history is often needed for checkpoint/restart;
consider tracking whether two file descriptors are shared as the result of
a <tt>fork()</tt> call or not.  To keep the requisite information around,
DMTCP must place wrappers around a number of system calls.  Those wrappers
interpose significant new functionality and may change semantics in
unpredictable ways.

<p>
Pipes are hard for DMTCP to handle, so the <tt>pipe()</tt> wrapper has to
turn them into full Unix-domain sockets.  There is also an interesting
dance required to get those sockets into the proper state at restart time.
The handling of signals - not always straightforward even in the simplest
of applications - is made more complicated by DMTCP, which also must
reserve one signal (<tt>SIGUSR2</tt> by default) for its own uses.  The
system call wrappers try to hide that signal handler from the application;
there is also the little problem that signals which are pending at checkpoint time may be lost.
Checkpointing will interrupt system calls, leading to unexpected
<tt>EINTR</tt> returns; the wrappers try to compensate by automatically
redoing the call when this happens.  A second VDSO page must be introduced
into a restarted process because it's not possible to control where the
kernel places that page.  There's a "virtual PID" layer which
tries to fool restarted processes into thinking that they are still running
with the same process ID they had when they were checkpointed.
<p>
There is an interesting plan for restarting programs which have a
connection to an X server: they will wrap Xlib (not a small interface) and
use those wrappers to obtain the state of the window(s) maintained by the
application.  That state can then be recreated at restart time before
reconnecting the application with the server.  Meanwhile, applications
talking to an xterm are forced to reinitialize themselves at restart time
by sending two <tt>SIGWINCH</tt> signals to them.  And so on.
<p>
Given all of that, it is not surprising that the kernel checkpoint/restart
developers see their approach as being a simpler, more robust, and more
general solution to the problem.  To them, DMTCP looks like a shaky attempt
to reimplement a great deal of kernel functionality in user space.  Matt
Helsley <a href="/Articles/414278/">summarized</a> it this way:
<p>
<div class="BigQuote">
	Frankly it sounds like we're being asked to pin our hopes on a
	house of cards -- weird userspace hacks involving extra processes,
	hodge-podge combinations of ptrace, LD_PRELOAD, signal hijacking,
	brk hacks, scanning passes in /proc (possibly at numerous times
	which begs for races), etc....
<p>
	In contrast, kernel-based cr is rather straight forward when you
	bother to read the patches. It doesn't require using combinations
	of obscure userspace interfaces to intercept and emulate those very
	same interfaces.  It doesn't add a scattered set of new ABIs.
</div>
<p>
Seasoned LWN readers will be shocked to learn that few minds appear to have
been changed by this discussion.  Most developers seem to agree that some
sort of checkpoint/restart functionality would be a useful addition to
Linux, but they differ on how it should be done.  Some see a kernel-side
implementation as the only way to get even close to a full solution to the
problem and as the simplest and most maintainable option.  Others think
that the user-space approach makes more sense, and that, if necessary, a
small number of system calls can be added to simplify the implementation.
It has the look of the sort of standoff that can keep a project like this
out of the kernel indefinitely.
<p>

That said, something interesting may happen here.  One thing that became
reasonably clear in the discussion is that a complete, performant, and
robust checkpoint/restart implementation will almost certainly require
components in both kernel and user space.  And it seems that the developers
behind the two implementations <a href="/Articles/414285/">will be getting
together</a> to talk about the problem in a less public setting.  With
luck, determination, and enough beer, they might just figure out a way to
solve the problem using the best parts of both approaches.  That would be a
worthy outcome by any measure.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Checkpointing">Checkpointing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#DMTCP">DMTCP</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/414264/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor414772"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 11:18 UTC (Thu)
                               by <b>ebirdie</b> (guest, #512)
                              [<a href="/Articles/414772/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      There also exists this <a href=http://wiki.openvz.org/Checkpointing_and_live_migration>http://wiki.openvz.org/Checkpointing_and_live_migration</a>, a working implementation, although it is for an container. One just wonders, isn't it worth to look at this as well?
      
          <div class="CommentReplyButton">
            <form action="/Articles/414772/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415480"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 16:59 UTC (Mon)
                               by <b>orenl</b> (guest, #21050)
                              [<a href="/Articles/415480/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OpenVZ is a nice working implementation. Unfortunately, it is for specific (older) kernels only. It is an out-of-tree implementation and seems to intend to remain as such.<br>
<p>
Linux-CR builds on the experience garnered through the previous out-of-mainstream projects such as OpenVZ and Zap. In developing it we aim to improve the design and extend the range of of supported features. Not less important, Linux-CR aims for inclusion in mainline. <br>
<p>
(OpenVZ developer contributed to our effort in the past and we hope for more :)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415480/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415632"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2010 3:18 UTC (Tue)
                               by <b>mfedyk</b> (guest, #55303)
                              [<a href="/Articles/415632/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
why not take openvz cr, get it into mergable state and then morph/improve it in mainline like perf, o1 scheduler, cfs scheduler.... hmm, maybe it's because ingo molnar isn't developing this patch? ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415632/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor414841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 15:20 UTC (Thu)
                               by <b>sean.hunter</b> (guest, #7920)
                              [<a href="/Articles/414841/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hehe.  "Seasoned LWN readers will be shocked to learn".<br>
<p>
At my workplace there is a similarly sarcastic saying "Imagine my huge surprise".  It has been said so often now that it has its own well-known abbreviation (IMHFS).<br>
<p>
I can't imagine what the "F" stands for.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/414841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor414889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 17:34 UTC (Thu)
                               by <b>Quazatron</b> (guest, #4368)
                              [<a href="/Articles/414889/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The value of beer in software development is vastly underrated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/414889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 15:36 UTC (Fri)
                               by <b>jschrod</b> (subscriber, #1646)
                              [<a href="/Articles/415141/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't forget the wine, too. There are those of us who prefer it to beer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415543"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 19:56 UTC (Mon)
                               by <b>knobunc</b> (subscriber, #4678)
                              [<a href="/Articles/415543/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, a symposium (in the original Greek sense).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415543/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 21:06 UTC (Mon)
                               by <b>Trelane</b> (subscriber, #56877)
                              [<a href="/Articles/415570/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Although free women of status did not attend symposia, female prostitutes (hetairai) and entertainers were hired to perform, consort, and converse with the guests." (<a href="http://en.wikipedia.org/wiki/Symposium">http://en.wikipedia.org/wiki/Symposium</a>)<br>
<p>
Not *quite* the original, I'd wager....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor415147"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 17:32 UTC (Fri)
                               by <b>Np237</b> (guest, #69585)
                              [<a href="/Articles/415147/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One of the primary users for checkpoint/restart is high-performance computing. You dont want to waste CPU cycles just because a node needs maintenance, so you want to checkpoint your whole computation. For very large clusters, you even want to checkpoint at regular intervals, since the probability for a node failure is just way too high.<br>
<p>
In this situation, pure userland checkpointing is a joke. It will never be able to store the state of network communications and of the various funny things that scientific code developers can imagine.<br>
<p>
Virtualization is not a solution either. The performance impact is too high, and youd have to plug in the hosts anyway for things like RDMA support.<br>
<p>
This is where in-kernel checkpointing comes handy. Its not sufficient either: you need to have support in the MPI library as well, so that all processes put themselves in a consistent state to be checkpointed together.<br>
<p>
I used to be a SuperUX sysadmin; I doubt many of you here have even heard the name, but seamless checkpoint/restart in the whole stack gives very impressive results, and in the end saves a lot of CPU cycles. There are not many systems where you can change a kernel setting and reboot, at 6PM on a Friday evening, all without the users noticing and without any doubt about causing problems during the weekend. HPC on Linux is still very, very far from this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415147/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415197"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 19:55 UTC (Fri)
                               by <b>daglwn</b> (guest, #65432)
                              [<a href="/Articles/415197/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <p><blockquote>One of the primary users for checkpoint/restart is high-performance computing.</blockquote></p>

<p>Not for much longer.  CR does not scale.  Given that DoD wants an exascale computer by 2018 with millions of cores and the associated MTBF, there's no way a CR system could possibly keep up.  At best it would completely saturate the network.</p>

<p>We're going to have to get a <em>lot</em> smarter about resiliency.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415197/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415201"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 20:15 UTC (Fri)
                               by <b>Np237</b> (guest, #69585)
                              [<a href="/Articles/415201/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You dont need to checkpoint every minute. It would already saturate the filesystem on current clusters. But you can do that every now and then, and if your filesystem cannot handle storing all the RAM of your compute nodes in a small time, it means it is already not up to the task.<br>
<p>
I expect an exascale computer to come with an exascale filesystem. If the CR is correctly implemented, it means exabytes of data being written to it simultaneously, with no other bottleneck than a barrier to halt all processes in a consistent state. In the end its the same amount of data that the computation would write when it ends to store the result. If the cluster cannot handle that, its just an entry in the Top500 dick size contest, not something to do serious work.<br>
<p>
The network speed should definitely not be a problem. It should be able to transfer all your node memorys contents in less than a second. Otherwise it will just not be able to run computations that exchange a lot of data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415201/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 20:17 UTC (Fri)
                               by <b>Np237</b> (guest, #69585)
                              [<a href="/Articles/415205/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
§2: I meant petabytes, of course. Its hard enough without needing petabytes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor415233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 22:36 UTC (Fri)
                               by <b>daglwn</b> (guest, #65432)
                              [<a href="/Articles/415233/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Your are seriously underestimating the complexity of these systems.  We're going to have node failures on the order of hours, at best.  We really need something much better than CR.  No matter how CR is implemented, it won't scale.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415234"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 22:40 UTC (Fri)
                               by <b>daglwn</b> (guest, #65432)
                              [<a href="/Articles/415234/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All IMHO, of course.  I am far from an OS, filesystem or CR expert, but I am aware of the trends.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415234/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor415495"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 17:44 UTC (Mon)
                               by <b>orenl</b> (guest, #21050)
                              [<a href="/Articles/415495/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
There are serious challenges to make large HPC environments resilient, and C/R functionality is an essential component in getting there.<br>
<p>
The main scalability bottleneck IMHO is that most distribute-C/R approaches require a barrier point for all participating processes across the cluster (the alternative - asynchronous C/R with message logging - has many issues).<br>
<p>
However, write-back of data to disk is not necessarily the biggest concern. First, you could write the checkpoints to _local_ disks (rather than flood the NAS). Second, you can write the checkpoints to "memory servers" which is faster than disks. Such servers need a lot of memory, but don't care about CPUs and core. You could speed things up using RDMA. For both methods, it's useful also to keep some redundancy so data can be recovered should a node (or more) disappear.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415495/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor415203"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 20:17 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/415203/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
much of the HPC software is custom written, and implements checkpointing on it's own, so adding c/r at the OS level doesn't actually buy you that much.<br>
<p>
the HPC software does it's own checkpointing anyway so that if the system crashes it can pick up at a reasonable point and not loose all the work that was done.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415203/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415207"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 20:22 UTC (Fri)
                               by <b>Np237</b> (guest, #69585)
                              [<a href="/Articles/415207/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It really depends on the software. You cant easily add C/R to a large piece of code that was written in the 70s and evolved organically since that time.<br>
<p>
For a dedicated cluster, it makes sense to adapt your code, but on general-purpose clusters you have hundreds of different codes running; it is much less expensive to implement system C/R if possible, instead of porting all the codes to be resilient.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415207/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415211"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 20:39 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/415211/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the problem is that just dong c/r on the process isn't good enough, it also has to do c/r on every other thing that the process talks to.<br>
<p>
for example, <br>
<p>
saving tcp connection info does you no good unless the other end of the tcp connection gets checkpointed at the same instant.<br>
<p>
saving pending disk writes does no good if the file you are writing to is off on some other system and will contain writes after the checkpoint<br>
<p>
system level c/r is useful for planned outages, but when you are in HPC environments, you have enough nodes that this is really not good enough, you will have unplanned outages, and unless your c/r can back out all these other side effects, it's not going to be able to be used for these outages.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415211/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 21:52 UTC (Fri)
                               by <b>Np237</b> (guest, #69585)
                              [<a href="/Articles/415227/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is precisely why you need the help of the MPI library and the resource manager: so that all processes related to a given job can be handled at the same time.<br>
<p>
Most of the things you describe are already handled by BLCR, although still in an imperfect way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2010 6:37 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/415270/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
you miss my point.<br>
<p>
doing checkpointing of the apps on any one system isn't good enough.<br>
<p>
you need to checkpoint the app and everything that it talks to on _every_ system at once (and make sure that you do it at the same instant so that there's no chance of data being in flight between systems to make it inconsistant)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415273"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2010 8:44 UTC (Sat)
                               by <b>Np237</b> (guest, #69585)
                              [<a href="/Articles/415273/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, you are missing my point. When I wrote all processes related to a given job, I really mean all processes, on all cluster nodes.<br>
<p>
Yes, its complicated. But with the help of the MPI library you can close all connections (since all inter-nodes connections are supposed to go through MPI) in a synchronized way. This is what BLCR + OpenMPI already do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415273/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor415501"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 17:51 UTC (Mon)
                               by <b>orenl</b> (guest, #21050)
                              [<a href="/Articles/415501/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are two types of checkpoints here:<br>
<p>
1) Coordinated checkpoint of all participating processes (across the cluster) so that the entire jobs can be restarted later from this checkpoint. This is useful for fault-tolerance.<br>
<p>
2) Checkpoint of processes on one (or more) nodes and then restart on a different node (or set of nodes). This is useful for load-balancing, but also for maintenance, e.g. by vacating an over-heating node.<br>
<p>
The former is usually done combining a C/R mechanism with a C/R-aware implementation of e.g. MPI. The latter is more tricky if one would like to do seamless live migration.<br>
<p>
Linux-CR supports both.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415501/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor415508"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 17:55 UTC (Mon)
                               by <b>orenl</b> (guest, #21050)
                              [<a href="/Articles/415508/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The Blue Waters people (<a href="http://www.ncsa.illinois.edu/BlueWaters/">http://www.ncsa.illinois.edu/BlueWaters/</a>) think that integrated checkpoint-restart is a worthy goal (see computing system / software configuration there). Linux-CR is being proposed for it.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415508/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor415553"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2010 20:28 UTC (Mon)
                               by <b>mhelsley</b> (guest, #11324)
                              [<a href="/Articles/415553/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which is why you need a c/r implementation that aggressively avoids checkpointing shared data multiple times and avoids unnecessary IO as much as possible.<br>
<p>
linux-cr does the former using its objhash so that we don't checkpoint shared state more than once. It avoids doing disk IO by, whenever possible. not bundling file/directory contents into the checkpoint image (generic_file_checkpoint()). Instead it relies on userspace to do IO-bandwidth friendly optimizations like using filesystem snapshots.<br>
<p>
That said, file "contents" are necessary for anon_inode-based interfaces such as eventfd, epoll, signalfd, and timerfd because those can't be "backed up" and restored like normal files.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/415553/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor416398"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Enhancing kernel API for user-space CR?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2010 13:45 UTC (Sat)
                               by <b>slashdot</b> (guest, #22014)
                              [<a href="/Articles/416398/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Instead of directly implementing checkpoint/restore in the kernel, wouldn't it be better to enhance the kernel API to allow perfect checkpoint/restore in userspace?<br>
<p>
You could still put the tool in the kernel repository, but as an userspace tool like perf.<br>
<p>
This would allow other uses of such an API, like "saving" a specific file descriptor.<br>
<p>
Basically, what you need to add is:<br>
1. A way to access process-specific data of other processes, by splitting the notion of current fd/signal/mm/etc. table from the notion of the one accessed by system calls<br>
2. A way to query all kernel state from userspace (with separate calls for each state type)<br>
3. A way to recreate single kernel objects<br>
4. Maybe a way to lock subsystems so that a consistent view can be saved<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/416398/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor417138"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Checkpoint/restart: it's complicated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2010 3:20 UTC (Thu)
                               by <b>karya</b> (guest, #71446)
                              [<a href="/Articles/417138/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As two of the DMTCP developers, we thought we would add some small comments.<br>
<p>
We should first add that we have the highest respect for Linux C/R, and are continuing to talk with them and exchange information.<br>
<p>
1) In response to Np237, DMTCP does directly handle distributed processes in a pure userland fashion.  For example, it can checkpoint OpenMPI as if it were just one more black box distributed computation.  It handles the network communication through a strategy of draining sockets.  In one phase, each host sends a special cookie through each socket.  In the next phase, each host reads from all sockets until seeing the cookie.  The data drained from the network can be re-inserted upon restart or resume from checkpoint.  We do indeed use barriers, as mentioned by orenl.  If anyone encounters a bug in using DMTCP for distributed processes, please do let us know so that we can fix it.<br>
<p>
2) Np237 also points out:<br>
<font class="QuotedText">&gt; Most of the things you describe are already handled by BLCR, although still in an imperfect way.</font><br>
This is a good point, and we agree.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/417138/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
