        <!DOCTYPE html>
        <html lang="en">
        <head><title>Namespaces in operation, part 4: more on PID namespaces [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/532748/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/533540/">Return to the Development page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/532748/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Namespaces in operation, part 4: more on PID namespaces</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Michael Kerrisk</b><br>January 23, 2013</br>
           </div>
<p> In this article, we continue <a href="/Articles/532271/">last week's
discussion</a> of PID namespaces (and extend our ongoing <a
href="/Articles/531114/#series_index">series</a> on namespaces). One use of
PID namespaces is to implement a package of processes (a container) that
behaves like a self-contained Linux system.  A key part of a traditional
system&mdash;and likewise a PID namespace container&mdash;is the
<tt>init</tt> process.  Thus, we'll look at the special role of the
<tt>init</tt> process and note one or two areas where it differs from the
traditional <tt>init</tt> process. In addition, we'll look at some other
details of the namespaces API as it applies to PID namespaces.



<h4>The PID namespace <tt>init</tt> process</h4>


<p> The first process created inside a PID namespace gets a process ID of 1
within the namespace. This process has a similar role to the <tt>init</tt>
process on traditional Linux systems. In particular, the <tt>init</tt>
process can perform initializations required for the PID namespace as whole
(e.g., perhaps starting other processes that should be a standard part of
the namespace) and becomes the parent for processes in the namespace that
become orphaned.

<p> In order to explain the operation of PID namespaces, we'll make use of
a few purpose-built example programs. The first of these programs,
<a
href="/Articles/533492/"><tt>ns_child_exec.c</tt></a>, has the following command-line syntax:

<pre>
    <b>ns_child_exec [options] command [arguments]</b>
</pre>

<p> The <tt>ns_child_exec</tt> program uses the <tt>clone()</tt> system
call to create a child process; the child then executes the given
<tt>command</tt> with the optional <tt>arguments</tt>.  The main purpose of
the <tt>options</tt> is to specify new namespaces that should be created as
part of the <tt>clone()</tt> call. For example, the <tt>-p</tt> option
causes the child to be created in a new PID namespace, as in the following
example:

<pre>
    $ <b>su</b>                  # Need privilege to create a PID namespace
    Password:
    # <b>./ns_child_exec -p sh -c 'echo $$'</b>
    1
</pre>

<p> That command line creates a child in a new PID namespace to execute a
shell <tt>echo</tt> command that displays the shell's PID. With a PID of 1,
the shell was the <tt>init</tt> process for the PID namespace that
(briefly) existed while the shell was running.

<p> Our next example program, <a
href="/Articles/533493/"><tt>simple_init.c</tt></a>, is a program that
we'll execute as the <tt>init</tt> process of a PID namespace. This program
is designed to allow us to demonstrate some features of PID namespaces and
the <tt>init</tt> process.

<p> The <tt>simple_init</tt> program performs the two main functions of
<tt>init</tt>. One of these functions is "system initialization". Most
<tt>init</tt> systems are more complex programs that take a table-driven
approach to system initialization. Our (much simpler) <tt>simple_init</tt>
program provides a simple shell facility that allows the user to manually
execute any shell commands that might be needed to initialize the
namespace; this approach also allows us to freely execute shell commands in
order to conduct experiments in the namespace.  The other function
performed by <tt>simple_init</tt> is to reap the status of its terminated
children using <tt>waitpid()</tt>.

<p> Thus, for example, we can use the <tt>ns_child_exec</tt> program in
conjunction with <tt>simple_init</tt> to fire up an <tt>init</tt> process
that runs in a new PID namespace:

<pre>
    # <b>./ns_child_exec -p ./simple_init</b>
    init$
</pre>

<p> The <tt>init$</tt> prompt indicates that the <tt>simple_init</tt>
program is ready to read and execute a shell command.

<p> We'll now use the two programs we've presented so far in conjunction
with another small program, <a
href="/Articles/533494/"><tt>orphan.c</tt></a>, to demonstrate that
processes that become orphaned inside a PID namespace are adopted by the
PID namespace <tt>init</tt> process, rather than the system-wide
<tt>init</tt> process.

<p> The <tt>orphan</tt> program performs a <tt>fork()</tt> to create a
child process. The parent process then exits while the child continues to
run; when the parent exits, the child becomes an orphan.  The child
executes a loop that continues until it becomes an orphan (i.e.,
<tt>getppid()</tt> returns 1); once the child becomes an orphan, it
terminates.  The parent and the child print messages so that we can see
when the two processes terminate and when the child becomes an orphan.

<p> In order to see what that our <tt>simple_init</tt> program reaps the
orphaned child process,  we'll employ that program's <tt>-v</tt> option, which
causes it to produce verbose messages about the children
that it creates and the terminated children whose status it reaps:

<pre>
    # <b>./ns_child_exec -p ./simple_init -v</b>
            init: my PID is 1
    init$ <b>./orphan</b>
            init: created child 2
    Parent (PID=2) created child with PID 3
    Parent (PID=2; PPID=1) terminating
            init: SIGCHLD handler: PID 2 terminated
    init$                   <i># simple_init prompt interleaved with output from child</i>
    Child  (PID=3) now an orphan (parent PID=1)
    Child  (PID=3) terminating
            init: SIGCHLD handler: PID 3 terminated
</pre>

<p> In the above output, the indented messages prefixed with <tt>init:</tt>
are printed by the <tt>simple_init</tt> program's verbose mode. All of the
other messages (other than the <tt>init$</tt> prompts) are produced by the
<tt>orphan</tt> program. From the output, we can see that the child process
(PID 3) becomes an orphan when its parent (PID 2) terminates.
At that point, the child is adopted by the PID namespace <tt>init</tt>
process (PID 1), which reaps the child when it terminates.



<h4>Signals and the <tt>init</tt> process</h4>


<p> The traditional Linux <tt>init</tt> process is treated specially with
respect to signals. The only signals that can be delivered to <tt>init</tt>
are those for which the process has established a signal handler; all other
signals are ignored. This prevents the <tt>init</tt> process&mdash;whose
presence is essential for the stable operation of the system&mdash;from
being accidentally killed, even by the superuser.

<p> PID namespaces implement some analogous behavior for the
namespace-specific <tt>init</tt> process. Other processes in the
namespace (even privileged processes) can send only those signals for which
the <tt>init</tt> process has established a handler.  This prevents
members of the namespace from inadvertently killing a process that has
an essential role in the namespace. Note, however, that (as for the
traditional <tt>init</tt> process) the kernel can still generate signals
for the PID namespace <tt>init</tt> process in all of the usual circumstances (e.g.,
hardware exceptions, terminal-generated signals such as <tt>SIGTTOU</tt>,
and expiration of a timer).

<p> Signals can also (subject to <a
href="http://man7.org/linux/man-pages/man2/kill.2.html#DESCRIPTION">the
usual permission checks</a>) be sent to the PID namespace <tt>init</tt>
process by processes in ancestor PID namespaces. Again, only the signals
for which the <tt>init</tt> process has established a handler can be sent,
with two exceptions: <tt>SIGKILL</tt> and <tt>SIGSTOP</tt>. When a process in
an ancestor PID namespace sends these two signals to the <tt>init</tt>
process, they are forcibly delivered (and can't be caught). The
<tt>SIGSTOP</tt> signal stops the <tt>init</tt> process; <tt>SIGKILL</tt>
terminates it.  Since the <tt>init</tt> process is essential to the
functioning of the PID namespace, if the <tt>init</tt> process is
terminated by <tt>SIGKILL</tt> (or it terminates for any other reason), the
kernel terminates all other processes in the namespace by sending them a
<tt>SIGKILL</tt> signal.

<p> Normally, a PID namespace will also be destroyed when its <tt>init</tt>
process terminates.  However, there is an unusual corner case: the
namespace won't be destroyed as long as a
<tt>/proc/</tt><i>PID</i><tt>/ns/pid</tt> file for one of the processes in
that namespaces is bind mounted or held open. However, it is not possible to
create new processes in the namespace (via <tt>setns()</tt> plus
<tt>fork()</tt>): the lack of an <tt>init</tt> process is detected
during the <tt>fork()</tt> call, which fails with an <tt>ENOMEM</tt>
error (the traditional error indicating that a PID cannot be allocated). In
other words, the PID namespace continues to exist, but is no longer usable.



<h4>Mounting a procfs filesystem (revisited)</h4>


<p> In the previous article in this series, the <tt>/proc</tt> filesystems
(procfs) for the PID namespaces were mounted at various locations other
than the traditional <tt>/proc</tt> mount point. This allowed us to use
shell commands to look at the contents of the <tt>/proc/</tt><i>PID</i>
directories that corresponded to each of the new PID namespace while at the
same time using the <tt>ps</tt> command to look at the processes visible in
the root PID namespace.

<p> However, tools such as <tt>ps</tt> rely on the contents of the procfs
mounted at <tt>/proc</tt> to obtain the information that they
require. Therefore, if we want <tt>ps</tt> to operate correctly inside a
PID namespace, we need to mount a procfs for that namespace. Since the
<tt>simple_init</tt> program permits us to execute shell commands, we can
perform this task from the command line, using the <tt>mount</tt> command:

<pre>
    # <b>./ns_child_exec -p -m ./simple_init</b>
    init$ <b>mount -t proc proc /proc</b>
    init$ <b>ps a</b>
      PID TTY      STAT   TIME COMMAND
        1 pts/8    S      0:00 ./simple_init
        3 pts/8    R+     0:00 ps a
</pre>

<p>
The <tt>ps&nbsp;a</tt> command lists all processes accessible via
<tt>/proc</tt>. In this case, we see only two processes, reflecting the fact
that there are only two processes running in the namespace.

<p> When running the <tt>ns_child_exec</tt> command above, we employed that
program's <tt>-m</tt> option, which places the child that it creates (i.e.,
the process running <tt>simple_init</tt>) inside a separate <i>mount</i>
namespace.  As a consequence, the <tt>mount</tt> command does not affect the
<tt>/proc</tt> mount seen by processes outside the namespace.



<h4><tt>unshare()</tt> and <tt>setns()</tt></h4>


<p> In <a href="/Articles/531381/">the second article</a> in this series,
we described two system calls that are part of the namespaces API:
<tt>unshare()</tt> and <tt>setns()</tt>. Since Linux 3.8, these system
calls can be employed with PID namespaces, but they have some
idiosyncrasies when used with those namespaces.


<p> Specifying the <tt>CLONE_NEWPID</tt> flag in a call to <a
href="http://man7.org/linux/man-pages/man2/unshare.2.html"><tt>unshare()</tt></a>
creates a new PID namespace, but does <i>not</i> place the caller in the
new namespace. Rather, any children created by the caller will be placed in
the new namespace; the first such child will become the <tt>init</tt>
process for the namespace.

<p> The <a
href="http://man7.org/linux/man-pages/man2/setns.2.html"><tt>setns()</tt></a>
system call now supports PID namespaces:

<pre>
    setns(fd, 0);   /* Second argument can be CLONE_NEWPID to force a
                       check that 'fd' refers to a PID namespace */
</pre>

<p> The <tt>fd</tt> argument is a file descriptor that identifies a PID
namespace that is a descendant of the PID namespace of the caller; that
file descriptor is obtained by opening the
<tt>/proc/</tt><i>PID</i><tt>/ns/pid</tt> file for one of the processes in
the target namespace.  As with <tt>unshare()</tt>, <tt>setns()</tt> does
<i>not</i> move the caller to the PID namespace; instead, children that are
subsequently created by the caller will be placed in the namespace.

<p> We can use an enhanced version of the <a
href="/Articles/531271/"><tt>ns_exec.c</tt></a> program that we presented
in the second article in this series to demonstrate some aspects of using
<tt>setns()</tt> with PID namespaces that appear surprising until we
understand what is going on.  The new program, <a
href="/Articles/533495/"><tt>ns_run.c</tt></a>, has the following syntax:

<pre>
    <b>ns_run [-f] [-n /proc/PID/ns/FILE]... command [arguments]</b>
</pre>

<p> The program uses <tt>setns()</tt> to join the namespaces specified by
the <tt>/proc/</tt><i>PID</i><tt>/ns</tt> files contained within
<tt>-n</tt> options. It then goes on to execute the given <tt>command</tt>
with optional <tt>arguments</tt>. If the <tt>-f</tt> option is specified,
it uses <tt>fork()</tt> to create a child process that is used to execute
the command.

<p> Suppose that, in one terminal window, we fire up our
<tt>simple_init</tt> program in a new PID namespace in the usual manner,
with verbose logging so that we are informed when it reaps child processes:

<pre>
    # <b>./ns_child_exec -p ./simple_init -v</b>
            init: my PID is 1
    init$ 
</pre>

<p> Then we switch to a second terminal window where we use the
<tt>ns_run</tt> program to execute our <tt>orphan</tt> program. This
will have the effect of creating two processes in the PID namespace
governed by <tt>simple_init</tt>:

<pre>
    # <b>ps -C sleep -C simple_init</b>
      PID TTY          TIME CMD
     9147 pts/8    00:00:00 simple_init
     # <b>./ns_run -f -n /proc/9147/ns/pid ./orphan</b>
     Parent (PID=2) created child with PID 3
     Parent (PID=2; PPID=0) terminating
     # 
     Child  (PID=3) now an orphan (parent PID=1)
     Child  (PID=3) terminating
</pre>

<p> Looking at the output from the "Parent" process (PID 2) created when
the <tt>orphan</tt> program is executed, we see that its parent process ID
is 0. This reflects the fact that the process that started the
<tt>orphan</tt> process (<tt>ns_run</tt>) is in a different
namespace&mdash;one whose members are invisible to the "Parent" process.  As <a
href="/Articles/531419/#getppid_0">already noted in the previous
article</a>, <tt>getppid()</tt> returns 0 in this case. 

<p>
The following
diagram shows the relationships of the various processes before the
<tt>orphan</tt> "Parent" process terminates. The arrows indicate
parent-child relationships between processes.

<blockquote>
<img src="https://static.lwn.net/images/2013/namespaces/pidns_orphan_1.png" alt="[Relationship of
    processes inside PID namespaces]">
</blockquote>


<p> Returning to the window running the <tt>simple_init</tt> program, we
see the following output:

<pre>
    init: SIGCHLD handler: PID 3 terminated
</pre>

<p> The "Child" process (PID 3) created by the <tt>orphan</tt> program was
reaped by <tt>simple_init</tt>, but the "Parent" process (PID 2) was
not. This is because the "Parent" process was reaped by its parent
(<tt>ns_run</tt>) in a different namespace. The following diagram shows the
processes and their relationships after the <tt>orphan</tt> "Parent" process
has terminated and before the "Child" terminates.

<blockquote>
<img src="https://static.lwn.net/images/2013/namespaces/pidns_orphan_2.png" alt="[Relationship of
    processes inside PID namespaces]">
</blockquote>

<p> It's worth emphasizing that <tt>setns()</tt> and <tt>unshare()</tt>
treat PID namespaces specially. For other types of namespaces, these system
calls <i>do</i> change the namespace of the caller. The reason that these
system calls do not change the PID namespace of the calling process is
because becoming a member of another PID namespace would cause the
process's idea of its own PID to change, since <tt>getpid()</tt> reports
the process's PID with respect to the PID namespace in which the process
resides. Many user-space programs and libraries rely on the assumption that
a process's PID (as reported by <tt>getpid()</tt>) is constant (in fact,
the GNU C library <tt>getpid()</tt> wrapper function <a
href="http://thread.gmane.org/gmane.linux.kernel/209103/focus=209130"><i>caches</i></a>
the PID); those programs would break if a process's PID changed. To put
things another way: a process's PID namespace membership is determined when
the process is created, and (unlike other types of namespace membership)
cannot be changed thereafter.



<h4>Concluding remarks</h4>

<p> In this article we've looked at the special role of the PID namespace
<tt>init</tt> process, shown how to mount a procfs for a PID namespace so
that it can be used by tools such as <tt>ps</tt>, and looked at some of the
peculiarities of <tt>unshare()</tt> and <tt>setns()</tt> when employed with
PID namespaces.  This completes our discussion of PID namespaces; in the
next article, we'll turn to look at user namespaces.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Namespaces-PID_namespaces">Namespaces/PID namespaces</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/532748/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor533762"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2013 19:09 UTC (Wed)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/533762/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wrote a little tool awhile ago to play with this stuff.  It's here:<br>
<p>
<a href="http://web.mit.edu/luto/www/linux/nnp/newns.c">http://web.mit.edu/luto/www/linux/nnp/newns.c</a><br>
<p>
Have fun!  If any of you find it useful, let me know -- I can probably polish it a bit and send it to util-linux or something.<br>
<p>
Also, on very new kernels (3.8+), a lot of this stuff can be done without privilege if you're willing to accept a few restrictions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/533762/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor533942"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2013 16:56 UTC (Thu)
                               by <b>dashesy</b> (guest, #74652)
                              [<a href="/Articles/533942/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Integrating these nice utilities in the util-linux is an excellent idea. A few different simple utilities, along with some simple SysV-init scripts (that go in /etc/init.d of ns for convenience) and a generic init suitable for namespace(polished simple_init.c) is all needed to experiment with ns.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/533942/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534044"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2013 16:44 UTC (Fri)
                               by <b>fishface60</b> (subscriber, #88700)
                              [<a href="/Articles/534044/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Util-Linux already has such tools in git, unshare works with all the name spaces and nsenter let's you create a new process in an existing namespace.<br>
<p>
I'm quite looking forward to being able to launch a container in shell. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534044/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor533806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2013 21:44 UTC (Wed)
                               by <b>dashesy</b> (guest, #74652)
                              [<a href="/Articles/533806/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks, I have become quite fond of these excellent series! <br>
<p>
Is there a way I can bookmark the entire series rather than individual articles?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/533806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor533809"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bookmarkig the series</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2013 21:50 UTC (Wed)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/533809/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      The <a rel="nofollow" href="/Articles/531114/#series_index">initial article</a> is gaining links to the rest as we go along.  The <a rel="nofollow" href="/Kernel/Index/#Namespaces">namespaces section in the Kernel Index</a> might also prove useful.
      
          <div class="CommentReplyButton">
            <form action="/Articles/533809/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor533824"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bookmarkig the series</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2013 23:31 UTC (Wed)
                               by <b>dashesy</b> (guest, #74652)
                              [<a href="/Articles/533824/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks, yes the index is better than I could imagine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/533824/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor533842"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bookmarkig the series</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2013 4:44 UTC (Thu)
                               by <b>xxiao</b> (guest, #9631)
                              [<a href="/Articles/533842/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was thinking about the same question today, it will be _great_ if I can somehow bookmark interesting lwn articles that associates with my account for future references, how hard is it to implement that?<br>
<p>
Thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/533842/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bookmarkig the series</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2013 15:03 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/534019/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You've already got it. A web browser with sync support (FF or Chrome) and, um, ordinary bookmarks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534212"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bookmarkig the series</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2013 0:23 UTC (Sun)
                               by <b>xxiao</b> (guest, #9631)
                              [<a href="/Articles/534212/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that's not very useful when I'm on the go, even with xmarks' help.<br>
it's much better to login to lwn then see all my favourite links booked on this site.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534212/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534377"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bookmarkig the series</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2013 18:06 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/534377/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So... you want every single website you use to implement its own implementation of bookmarks (all different), because you have web browsers that don't implement syncing? (What web browser would that be? Chrome does it, Firefox does it... Epiphany, perhaps?)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534377/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor534001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2013 10:00 UTC (Fri)
                               by <b>sorokin</b> (guest, #88478)
                              [<a href="/Articles/534001/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"The only signals that can be delivered to init are those for which the process has established a signal handler; all other signals are ignored"<br>
<p>
Looks like some dirty hack. Why init process can not disable signals itself?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2013 10:27 UTC (Fri)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/534005/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can think of three reasons, the first being that establishing the signal handlers takes some time. the second is that the list of signals you know might not be exhaustive, especially some time later. The third I am not sure about and I am too lazy to check the code right now but does that perhaps include signal handlers you can't block yourself?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534008"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2013 10:35 UTC (Fri)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/534008/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I would hope so. (The easy way to check is to sit in front of a machine you don't mind having crash, and try sending SIGKILL to PID 1.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/534008/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor534061"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2013 18:07 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/534061/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes SIGKILL and SIGSTOP are the biggies.<br>
<p>
The reason for ignoring the others is that is the way things have worked for "init" processes as far back in the linux history as I have looked, and maintaining backwards compatibility is important.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/534061/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor535430"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2013 16:26 UTC (Thu)
                               by <b>alex2</b> (guest, #73934)
                              [<a href="/Articles/535430/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can the network namespace be used to restrict a program so it can't phone home? Sometimes I'd like to test some commercial demo version but I really don't want it to report an unknown amount information back to the company.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/535430/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor536207"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2013 12:50 UTC (Tue)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/536207/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can setup iptables inside the network namespace, if you trust the program not to change it, you'll be fine.<br>
<p>
This is because I'm not sure how well you can control what packets can and can not be send from the network namespace from the parent namespace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/536207/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor536244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2013 16:18 UTC (Tue)
                               by <b>bjencks</b> (subscriber, #80303)
                              [<a href="/Articles/536244/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A fresh network namespace only has a loopback interface. If you don't add any other interfaces, it's totally isolated network-wise.<br>
<p>
(Note that you can still connect to filesystem-namespace unix sockets if you can access them as files -- you need to chroot or use mount namespaces if you want to hide them as well. I believe abstract namespace unix sockets are isolated per-namespace.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/536244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor556625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2013 20:00 UTC (Thu)
                               by <b>Urhixidur</b> (guest, #91620)
                              [<a href="/Articles/556625/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Creating a mount namespace at the same time that a PID namespace is created is an elegant solution, but seems fallible. Noting prevents new processes from being created into the new PID namespace without simultaneously joining the mount namespace. This seems error-prone. Or am I missing something?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/556625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor635550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2015 2:04 UTC (Thu)
                               by <b>apollock</b> (subscriber, #14629)
                              [<a href="/Articles/635550/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi, I'm messing around with your utilities, as well as unshare and the first commentator's newns, and I can't seem to get mount namespaces to work as I'd expect.<br>
<p>
I'm creating a new everything, i.e.<br>
sudo unshare --mount --uts --net --pid --fork --mount-proc /bin/bash<br>
sudo /tmp/newns --uts --mount --pid --init --net /bin/bash<br>
sudo /tmp/ns_child_exec -p -m /tmp/simple_init<br>
<p>
and then unmounting a filesystem from that shell, and it's getting unmounted in another shell that hasn't been interacting with the namespace, which isn't what I would have expected? Similarly, if I mount /proc in the last two example invocations above, it clobbers the systemwide /proc mount with what's going on inside my new PID namespace. Also not what I would have expected?<br>
<p>
I'm using 3.19.0<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/635550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor635563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2015 9:25 UTC (Thu)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/635563/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      @apollock: yes, I recently <a href="https://lwn.net/Articles/635251/">commented on this</a> in another article in this series. Basically, some distros (e.g., Fedora) these days enable mount propagation by default, which means that when you mount <tt>/proc</tt> in the new mount namespace, you do indeed clobber <tt>/proc</tt> in the initial mount namespace.

<p>
So, in the new namespace, you need to disable propagation of mount events on <tt>/</tt>, either by making it a private mount (prevents propagation in both directions) or by making it a slave mount (allows propagation of mounts events under <tt>/</tt> into the new namespace, but doesn't propagate events outside the new namespace.  So, for example, in the shell session under the heading <strong>Mounting a procfs filesystem (revisited)</strong>, we should add one further shell command:

<pre>
# <strong>./ns_child_exec -p -m ./simple_init</strong>
init$ <font color="red"><strong>mount --make-slave /</strong></font>            # &lt;== NEW
init$ <strong>mount -t proc proc /proc</strong>
init$ <strong>ps a</strong>
</pre>

<p>
For more info about mount propagation, see the kernel source file <tt>Documentation/filesystems/sharedsubtree.txt</tt> and the <a href="http://man7.org/linux/man-pages/man8/mount.8.html">mount(8) man page</a>. 
      
          <div class="CommentReplyButton">
            <form action="/Articles/635563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor635660"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2015 23:55 UTC (Thu)
                               by <b>apollock</b> (subscriber, #14629)
                              [<a href="/Articles/635660/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the quick response. <br>
<p>
It looks like I have to do the same thing to /proc prior to mounting it<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/635660/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor635676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2015 9:19 UTC (Fri)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/635676/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Thanks for the quick response.</font><br>
<p>
Actually, it was quite by chance. I happened to be checking some details in these articles myself.<br>
<p>
<font class="QuotedText">&gt; It looks like I have to do the same thing to /proc prior to mounting it</font><br>
<p>
I don't believe that should be necessary. What makes you think that it is?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/635676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor635818"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2015 7:53 UTC (Sat)
                               by <b>apollock</b> (subscriber, #14629)
                              [<a href="/Articles/635818/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because /proc was still getting clobbered outside of my namespace without it when I mounted it inside my namespace.<br>
<p>
I was basically testing two scenarios:<br>
<p>
1) Unmounting a filesystem that was mounted inside and outside the new namespace. Expected behaviour: it was only unmounted inside the new namespace<br>
<p>
2) Mounting /proc inside the new namespace. Expected behaviour: only seeing the process entries for processes inside the new namespace inside the namespace, and there being no impact outside this namespace<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/635818/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor635825"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2015 10:04 UTC (Sat)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/635825/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      So, going back to your earlier comment:

<p>
&gt; It looks like I have to do the same thing to /proc prior to mounting it

<p>
Yes, you're right. I was getting confused with another case, where if we mount a procfs at a location other than the usual <tt>/proc</tt>, then we need to make <tt>/</tt> a private or slave mount in order not to have that mount appear in the initial mount namespace.
<p>
So, in fact all that's needed if we're mounting at /proc inside the <tt>simple_init</tt> program is

<pre>
# <strong>./ns_child_exec -p -m ./simple_init</strong>
init$ <strong><font color="red">mount --make-slave /proc</font></strong>            # &lt;== NEW
init$ <strong>mount -t proc proc /proc</strong>
init$ <strong>ps a</strong>
</pre>

Nothing needs to be done to <tt>/</tt>, as far as I can tell.
      
          <div class="CommentReplyButton">
            <form action="/Articles/635825/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor735918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can't get mount namespaces to behave as expected</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 10, 2017 1:54 UTC (Tue)
                               by <b>marcosps</b> (subscriber, #115562)
                              [<a href="/Articles/735918/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hello Michael,<br>
<p>
what do you think about changing the article adding the --make-slave parameter mount? It made me turn off my computer twice, as the system gets unstable (at least n my fedora 26)...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/735918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor709231"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2016 2:26 UTC (Thu)
                               by <b>orbisvicis</b> (guest, #113024)
                              [<a href="/Articles/709231/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The final example isn't working properly. Orphan's child does nothing after the parent successfully exits - no "Child ..." lines. Also, orphan's child is rarely reparented to ns_child_exec: the line "init: SIGCHLD handler: PID ... terminated" rarely happens.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/709231/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779642"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2019 9:48 UTC (Wed)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/779642/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just noticed this comment now. I've just retested this example, using the code supplied with article, and I consistently see the "init: SIGCHLD handler: PID xxx terminated" messages. Maybe you missed a step/option somewhere along the way while performing the experiment?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779642/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor779508"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2019 6:30 UTC (Tue)
                               by <b>ywchang</b> (guest, #130070)
                              [<a href="/Articles/779508/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can get expected results from codes and commands covered in the post.<br>
<p>
However, for the last part, I am thinking, it probably also should work if there is no `-f` option for the `ns_run` command.<br>
<p>
If there is no `-f`, that means, the `ns_run` process itself will first update pid namespace, and then run the `./orphan` itself. Then the forked child will show up in the new pid namespace, while `ns_run` will die. The forked child process should also be reaped by the init process in the new pid namespace, right?<br>
<p>
I tried and it didn't work as I described. Anyone shed some light please? Thanks in advance. <br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779508/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779643"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2019 10:02 UTC (Wed)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/779643/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>As described in the article, the <em>setns()</em> and <em>unshare()</em> system calls treat PID namespaces specially. For other types of namespaces, these system calls do change the namespace of the caller. For PID namespaces, these system calls do not change the PID namespace of the calling process. Instead, any subsequently created children of the caller will be created in the target/new namespace.</p>
<p>
If the <em>-f</em> option was omitted, the <em>ns_run</em> command would execute the <em>orphan</em> program in the PID namespace where <em>ns_run</em> resides, rather than the namespace specified by the <em>-n</em> option.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/779643/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779775"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2019 9:58 UTC (Thu)
                               by <b>ywchang</b> (guest, #130070)
                              [<a href="/Articles/779775/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks so much for your reply.<br>
<p>
I get your point that PID namespace is special, that using `setns()` the calling process itself will not join the new namespace, while the children forked will be joining the new namespace.<br>
<p>
I raised the question that if we can drop the `-f`, is because if looking at the implementation of  `orphan` codes, the orphan process is actually forked out from the `ns_run`, which has called `setns()` before. That means if  `ns_run` serve as the parent, fork the orphan, and then exit. Then the orphan process should in theory be in the new namespace.<br>
<p>
I did the experiment, drop the `-f` option, and then I found the orphan did show up in the new namespace. Because I use the readlink against the orphan process outside PID namespace,  same with PID namespace `init` process.<br>
<p>
I mounted the proc to /proc2, and run `ls -d /proc2/[1-9]*`<br>
<p>
The results is like <br>
<p>
/proc2/1  /proc2/2<br>
<p>
And I run this command to explore /proc2/2, `cat /proc2/2/status | egrep '^(Name|PP*id)'`<br>
<p>
it shows me this,<br>
<p>
Name:	orphan<br>
Pid:	2<br>
PPid:	0<br>
<p>
At this moment, I'm confused. Why the orphan process is not reaped by `init` process? And why the PPid is becoming 0? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779775/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779881"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2019 7:59 UTC (Fri)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/779881/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Why the orphan process is not reaped by `init` process? </font><br>
<font class="QuotedText">&gt; And why the PPid is becoming 0?</font><br>
<p>
When a process becomes orphaned it is reparented to the init process *in the PID namespace of its parent*. <br>
<p>
When you run the 'orphan' program without the '-f' option, then the child is in the new PID namespace, but its parent is still in the initial PID NS. Thus the orphan gets reparented to init in the initial PID namespace.<br>
<p>
PPid == 0 is the system's way of telling the child process that it has no visible parent (because the parent is in another PID namespace).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779881/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 4: more on PID namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2019 7:04 UTC (Sat)
                               by <b>ywchang</b> (guest, #130070)
                              [<a href="/Articles/779974/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This clears my doubt! Thanks so much for your explanation!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
