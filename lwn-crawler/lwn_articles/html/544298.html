        <!DOCTYPE html>
        <html lang="en">
        <head><title>A kernel change breaks GlusterFS [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/544298/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/543794/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/544298/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A kernel change breaks GlusterFS</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Michael Kerrisk</b><br>March 27, 2013</br>
           </div>
<p> Linus Torvalds has railed frequently and loudly against kernel
developers breaking user space. But that rule is not ironclad; there
are exceptions. As Linus once <a
href="http://thread.gmane.org/gmane.linux.kernel/1063039/focus=1065522">noted</a>:

<div class="BigQuote">

     But the "out" to that rule is that "if nobody notices, it's not
     broken" [&hellip;] So breaking user space is a bit like trees falling
     in the forest. If there's nobody around to see it, did it really
     break?

</div>

<p> The story of how a kernel change caused a GlusterFS breakage shows
that there are sometimes unfortunate twists to those exceptions.






<h4>The kernel change and its consequences</h4>


<p> <a href="http://www.gluster.org/">GlusterFS</a> is a widely-used, free,
<a href="http://en.wikipedia.org/wiki/Scalability#scale_out">scale-out</a>,
distributed filesystem that is available on Linux and a number of other
UNIX-like systems.  GlusterFS was initially developed by Gluster, Inc., but
since Red Hat acquired that company in 2011, it has mainly driven work on
the filesystem.

<p> GlusterFS's problems sprang from an ext4 filesystem <a
href="http://git.kernel.org/cgit/linux/kernel/git/stable/linux-stable.git/commit/?id=d1f5273e9adb40724a85272f248f210dc4ce919a">patch</a>
by Fan Yong that addressed a long-standing issue in ext4's support for the
<tt>readdir()</tt> API by widening the "directory offset" values used by
the API from 32 to 64 bits. That change was needed to reliably support
<tt>readdir()</tt> traversals in large directories; we'll discuss those
changes and the reasons for making them in <a href="/Articles/544520/">a
companion article</a>. One point from that discussion is worth making here:
these "offset" values are in truth a kind of cookie, rather than a true
offset within a directory. Thus, for the remainder of this article, we'll
generally refer to them as "cookies". Fan's patch made its way into the
mainline 3.4 kernel (released in May 2012), but appears also to have been
ported into the 3.3.x kernel that was released with Fedora 17 (also
released in May 2012).

<p> Fan's patch solved a problem for ext4, but inadvertently created one
for GlusterFS servers that use ext4 as their underlying storage
mechanism. However, nobody reported problems in time to cause the patch to
be reconsidered. The symptom on affected systems, as noted in a July 2012
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=838784">Red Hat bug
report</a>, was that using <tt>readdir()</tt> to scan a directory on a
GlusterFS system would end up in an infinite loop in some cases.

<p> The cause of the problem&mdash;as <a href="/Articles/544254/">detailed</a>
by Anand Avati in a recent (March 2013) discussion on the ext4 mailing
list&mdash;is that GlusterFS makes some assumptions about the "cookies"
used by the <tt>readdir()</tt> API. In particular, although these values
are 64 bits long, the GlusterFS developers noted that only the lower 32
bits were used, and so decided to encode some additional
information&mdash;namely the index of the Gluster server holding the
file&mdash;inside their own internal version of the cookie, according to
this formula:

<pre>
     final_d_off = (ext4_d_off * MAX_SERVERS) + server_idx
</pre>

<p> This GlusterFS internal cookie is exchanged in the 64-bit cookie that
is passed in NFSv3 <tt>readdir()</tt> requests between GlusterFS clients and
front-end servers. (An <a href="/Articles/544389/">ASCII art diagram</a>
posted in the mailing list thread by J.&nbsp;Bruce Fields clarifies the
relationship of the various GlusterFS components.) The GlusterFS internal
cookie allows the server to easily encode the identify of the GlusterFS
storage server that holds a particular directory.

This scheme worked fine as long as only 32 bits were used in the ext4
<tt>readdir()</tt> cookies (<tt>ext4_d_off</tt>), but promptly blew up when
the cookies switched to using 64 bits, since the multiplication caused some
bits to be lost from the top end of <tt>ext4_d_off</tt>.


<p> An August 2012 gluster.org <a
href="http://www.gluster.org/2012/08/glusterfs-bit-by-ext4-structure-change/">blog
post</a> by Joe Julian pointed out that the problem affected not only
Fedora 17's 3.3 kernel, but also the kernel in Red Hat's Enterprise Linux
distribution, because the kernel change had been backported into the much
older 2.6.32 distribution kernel supplied in RHEL 6.3 and later.

The recommended workaround was either to downgrade
to an earlier kernel version that did not include the patch or
to reformat the GlusterFS bricks (the fundamental storage unit on a
GlusterFS node) to use XFS instead of ext4. (Using XFS rather than ext4 had
already been recommended practice when using GlusterFS.) Needless to say,
neither of these solutions was easily practicable for some GlusterFS users.





<h4>Mitigating GlusterFS's problem</h4>


<p> In his March 2013 mail, Anand bemoaned the fact that the manual pages
gave no indication that the <tt>readdir()</tt> API "offsets" were cookies
rather than something like a conventional file offset whose range might
bounded. Indeed, the manual pages rather hinted towards the latter
interpretation. (That, at least, is a problem that is now <a
href="http://git.kernel.org/cgit/docs/man-pages/man-pages.git/commit/?id=73f4bf1eab4b4bd2adf9a37908b6e14a0a02fb6c">addressed</a>.)
Anand went on to request a fix to the problem:

<div class="BigQuote">
  
        You can always say "this is your fault" for interpreting the man
        pages differently and punish us by leaving things as they are (and
        unfortunately a big chunk of users who want both ext4 and gluster
        jeopardized). Or you can be kind, generous and be considerate to
        the legacy apps and users (of which gluster is only a subset) and
        only provide a mount option to control the large d_off behavior.

</div>

<p> But, as the ext4 maintainer, Ted Ts'o, <a
href="/Articles/544257/">noted</a>, Fan's patch addressed a real problem
that affected well-behaved applications that did not make mistaken
assumptions about the value returned by <tt>telldir()</tt>.  Adding a mount
option that nullified the effect of that patch would affect all programs
using a filesystem and penalize those well-behaved applications by
exposing them to the problem that the patch was designed to fix.

<p> Ted instead proposed another approach: a per-process setting that
allowed an application to request the older <tt>readdir()</tt> cookie
semantics. The advantage of that approach is that it provides a solution
for applications that misuse the cookie without penalizing applications
that do the right thing. This solution could, <a
href="/Articles/544259/">he said</a>, take the form of an ext4-specific
<tt>ioctl()</tt> operation employed immediately after calling
<tt>opendir()</tt>. Anand <a href="/Articles/544260/">thought</a> that
should be a workable solution for GlusterFS. The requisite patch does not
yet seem to have appeared, but one supposes that it will be written and
submitted during the 3.10 merge window, and possibly backported into
earlier stable kernels.

<p> So, a year after the ext4 kernel change broke GlusterFS, it seems that
a (kernel) solution will be found to address GlusterFS's difficulties. In
passing, it's probably fair to mention that one reason that the (proposed)
fix took so long in coming was that the GlusterFS developers initially
thought they might be able to work around the kernel change by making
changes in GlusterFS.  However, it ultimately <a
href="https://bugzilla.redhat.com/show_bug.cgi?id=838784#c11">turned
out</a> to be impossible to exchange both a full 64-bit <tt>readdir()</tt>
cookie and a GlusterFS storage server ID in the NFS <tt>readdir()</tt>
requests exchanged between GlusterFS clients and front-end servers.



<h4>Summary: the meta-problem</h4>

<p> In the end, the GlusterFS breakage might have been
avoided. Ted's proposed fix could have been rolled out at the same time
as Fan's patch, so as to minimize any disruptions for GlusterFS
users. Returning to Linus's quote at the beginning of this article puts us
on the trail of a deeper problem.

<p> "<q>If there's nobody around to see it, did it really break?</q>"
was Linus's rhetorical question. The problem is that this is a test whose
results can be rather arbitrary. Sometimes, <a
href="/Articles/520198/#EPOLLWAKEUP">as was the case in the implementation
of <tt>EPOLLWAKEUP</tt></a>, a kernel change that causes a minor breakage
in a user-space application that is doing strange things will be reverted
or modified because it is fortuitously spotted by someone close to the
development scene&mdash;namely, a kernel developer who notices a
misbehavior on their desktop system.

<p> However, other users may be so far from the scene of change that it can
be a considerable time before they see a problem. By the time those users
detect a user-space breakage, the corresponding stable kernel may already
be several release cycles in the past. One can easily imagine that few
kernel developers are running a GlusterFS node on their development
systems. Conversely, one can imagine that most users of GlusterFS are
running production environments where stability and uptime are critical,
and testing an -rc kernel is neither practical nor a high priority.

<p> Thus, a rather important user-space breakage was missed&mdash;one that,
if it had been detected, would almost certainly have triggered modification
or reversion of the relevant patches, or stern words from Linus in the face
of any resistance to making such changes.  And, certainly, this is not a
one-off case. Your editor did not need to look too far to find another
example, where <a href="/Articles/544264/">a change in the way that POSIX
message queue limits are enforced</a> in Linux 3.5 led to a <a
href="https://bugs.launchpad.net/ubuntu/+source/manpages/+bug/1155695">report</a>
of breakage in a database engine nine months later.

<p> The "if there's nobody around to see it" metric requires that someone
is looking. That is of course a strong argument that the developers of
user-space applications such as GlusterFS who want to ensure that their
applications keep working on newer kernels must vigilantly and thoroughly
test -rc kernels. Clearly that did not happen.

<p> However, it seems a little unfair to place the blame solely on user
space. The ext4 modifications that affected GlusterFS clearly represented a
change to the kernel-user-space ABI (and for reasons that we describe in
our follow-up article, that change was clearly necessary). In cases such as
this (and the POSIX message queue change), perhaps even more caution was
warranted when making the change. At the very least, a loud announcement in
the commit message that the kernel changes represented a change to the ABI
would have been helpful; that might have jogged some reviewers to think
about the possible implications and resulted in the ext4 changes
being made in a way that minimized problems for GlusterFS. A greater
commitment on both sides to improving the documentation would also be
helpful. It's notable that even after deficiencies in the documentation
were mentioned as a contributing factor to GlusterFS problem, no-one sent a
patch to improve said documentation. All in all, it seems that parties on
both sides of the ABI could be doing a better job.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ext4">Filesystems/ext4</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#User-space_API">User-space API</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/544298/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor544720"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 21:14 UTC (Wed)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/544720/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      There's a proposed solution for glusterfs (with an excellent changelog) at <a href="http://review.gluster.org/#change,4711">http://review.gluster.org/#change,4711</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/544720/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544739"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 22:25 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/544739/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given Jeff Darcy's last review comment... I don't think it's going in until that bug is fixed. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544739/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor544747"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 23:37 UTC (Wed)
                               by <b>rvolgers</b> (guest, #63218)
                              [<a href="/Articles/544747/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wow, talk about piling ugly hacks upon ugly hacks. A well-explained hack is still a hack!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544747/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor544726"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 21:38 UTC (Wed)
                               by <b>dvdeug</b> (guest, #10998)
                              [<a href="/Articles/544726/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I see their problem, but isn't it quite problematic to assume a 64-bit index only stores data in the bottom 32 bits? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544726/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor545096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 29, 2013 5:19 UTC (Fri)
                               by <b>alankila</b> (guest, #47141)
                              [<a href="/Articles/545096/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, but apparently there is no space in the NFSv3 protocol used to encode the information anywhere else. This is based on the words of the article, not knowledge. Even after the problem is known, the extra bits still go somewhere into the readdir() cookie, only now they're stored in some different way. Eww.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor545126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 29, 2013 9:48 UTC (Fri)
                               by <b>dvdeug</b> (guest, #10998)
                              [<a href="/Articles/545126/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, I get that. But if you get an opaque id that takes 64 bits, and you don't preserve all 64 bits, you've broken the API, not the kernel. Don't mumble things about offsets and your constraints; it's your fault. At the very least, it never would have got into an infinite loop if they'd checked their assumption on every offset they got from the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor544734"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 22:06 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/544734/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If glusterfs has no problem with 64-bit cookies that XFS uses, why would gluster suddenly have an issue with 64-bit cookies from ext4? Or is it that the gluster on-disk format is dependent upon the fstype?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544734/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544746"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 23:32 UTC (Wed)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/544746/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was wondering that myself.  What singles ext4 out for breakage?  Hoping someone knows.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544746/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544749"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 23:43 UTC (Wed)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/544749/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ha, I read the articles in the wrong order.  Last paragraph of the companion article: <a href="https://lwn.net/Articles/544520/">https://lwn.net/Articles/544520/</a><br>
<p>
Sounds like XFS also uses 32 bit cookies but uses some additional memory to ensure it doesn't suffer the collision problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544749/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor544759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 0:35 UTC (Thu)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/544759/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Traditionally the cookie is a byte-offset into some linear representation of the directory.  If you do that, then in practice a "64 bit" cookie in practice probably isn't going to exceed 2^32 until you have millions of entries.

<p>ext4 is unusual in that it uses a hash of the filename as the cookie--so the 64-bit cookies are effectively random 64-bit sequences, and really do use the high bits.

<p>(Well, OK, actually they're limited to 63 bits, but you get the idea.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/544759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544835"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 9:20 UTC (Thu)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/544835/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So really it'd be much better (ignoring legacy constraints) to use the filename as the handle for any readdir-like directory iteration operation?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544835/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 9:52 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/544845/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, except that there are those pesky legacy constraints.<br>
<p>
The latest NFS protocol specifies that the token passed over the wire is a 64 bit value (earlier versions specified a 32 bit value)<br>
<p>
Other network filesystems have similar specifications.<br>
<p>
In fact, from a little googling, it looks like the POSIX spec says that these cookies are of type 'long'. this makes changing it to something like a variable length string like you would need to use the filename extremely hard.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 10:32 UTC (Thu)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/544855/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure. There's 2 trains of thought going through my head:<br>
<p>
a) How to get a stable order over fixed-length IDs (dir size limited to the ID space then).<br>
<p>
b) Assuming you can't get that, how would you design sane APIs that still allowed iteration of directories?<br>
<p>
For b, it's names. However, I still don't understand why 'a' isn't possible. See my comment on the companion ext4 article about using a ring for the ID space.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544965"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 16:29 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/544965/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Use "last returned filename" as a cookie. Easy and simple - Amazon does this for S3 and it works splendidly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544965/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor544743"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 27, 2013 23:06 UTC (Wed)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/544743/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But there *was* no ABI change. A 64-bit value continued to hold 64 bits.<br>
<p>
This is exactly like C programmers who complain when their undefined behavior changes. Like reading a[-1] or depending on signed integer wrap or reading a double through an integer pointer.<br>
<p>
It never should have worked. It never did work except on your one compiler and machine combination. And changing it isn't the compiler's problem.<br>
<p>
Back to kernel examples, if some user space program begins relying on the number of columns when parsing the proc files is that the kernel's problem? No. That is just a badly written program.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544743/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544762"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 0:57 UTC (Thu)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/544762/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I must agree there. Relying on certain parts of a field being unset when they're not explicitly documented as available for use is unwise. You can do it, but if it breaks you get to keep the pieces.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544762/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor544850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 10:55 UTC (Thu)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/544850/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
<font color="purple">
But there *was* no ABI change. A 64-bit value continued to hold 64 bits.
</font>
</blockquote>

<p>
The question is where you consider the definition of the ABI to be. Is
it some documented standard ("this is a 64-bit field"), or is it "the behavior as (it appears to be) implemented" ("only 32 bits are ever used in this field")? The GlusterFS folks clearly took it to be the latter. One can argue that it was a questionable decision, but given the problem they were trying to solve, and the constraints on how much information they could pass in the cookie sent over NFSv3, it wasn't a completely insane thing to do, given the observed kernel behavior.

<blockquote>
<font color="purple">
This is exactly like C programmers who complain when their undefined behavior changes.
</font>
</blockquote>

<p>
The analogy doesn't really hold. For C, there is a very carefully defined standard that thoroughly specifies behavior and notes the cases where behavior is undefined. For much of the kernel API, there is nothing like such precise documentation/specification. This leaves user-space programmers trying to make guesses about what is or is not permissible, and that is exactly the hole that the Gluster folk fell into. And as noted by another commenter, the Samba folk fell into the same hole. The fact that <i>two</i> independent groups fell into the same hole is quite telling, in my view.

<blockquote>
<font color="purple">
Back to kernel examples, if some user space program begins 
relying on the number of columns when parsing the proc 
files is that the kernel's problem? No. That is just 
a badly written program.
</font>
</blockquote>


<p>
I think that's a weak example to support your argument, because the advice that one should parse /proc defensively is reasonably well known. And don't get me wrong, your argument is reasonable, but I think it's far from definitive.

<p>
Returning to my point about documented standards versus "the behavior as (it appears to be) implemented"... The Linux kernel violates standards in a number of
places, and when it comes down to contradictions between documented
behavior (man pages and standards) versus existing implementation, Linus
always firmly plumps for the latter (unless the existing behavior is
causing actual pain to user space). 

<p>
And take a look at the EPOLLWAKEUP example referred to in the article. In that case, the problem was that a program was setting random bits in the epoll API that formerly had no meaning. The application had *no* good reason to set those bits, because they had absolutely no effect (and unfortunately there was no kernel check to give an error when that was done). When someone tried to give those bits a meaning, the application broke. The response was not to say: user-space, go fix your stupid application; that would just inflict pain on thousands of users as their binaries break. Instead the response was: we'll need to modify this kernel patch in such a way that it does not break user-space (and that changed _decreased_ the usability of the kernel feature that was added). The argument in that case that the kernel should change was much weaker than the argument would have been for accommodating GlusterFS, if the GlusterFS problem had actually been detected in time

<p>
You can't have it both ways. Linus pretty consistently goes one way, and I can see his point (though I've disagreed with some specific cases in the past).
      
          <div class="CommentReplyButton">
            <form action="/Articles/544850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544996"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 17:54 UTC (Thu)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/544996/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The question is where you consider the definition of the ABI to be. Is it some documented standard ("this is a 64-bit field"), or is it "the behavior as (it appears to be) implemented" ("only 32 bits are ever used in this field")? The GlusterFS folks clearly took it to be the latter. One can argue that it was a questionable decision, but given the problem they were trying to solve, and the constraints on how much information they could pass in the cookie sent over NFSv3, it wasn't a completely insane thing to do, given the observed kernel behavior.</font><br>
<p>
There are two things they could have done that would have made it less insane:<br>
<p>
- Ask the kernel developers if it's OK to assume high bits are zero<br>
<p>
- Verify the assumption with an assert (instead of missing files and going into infinite loops)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544996/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor545222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 29, 2013 17:24 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/545222/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
The question is where you consider the definition of the ABI to be. Is it some documented standard ("this is a 64-bit field"), or is it "the behavior as (it appears to be) implemented" ("only 32 bits are ever used in this field")? The GlusterFS folks clearly took it to be the latter.
</blockquote>
<p>
According to what you wrote, they did more than that.  They looked at the man page, which is the closest Linux comes to an ABI specification.  They noted the language in there, which could have said "continuation cookie" or something, but actually uses the word "offset."  This suggests that it is a very old interface from days before we understood layering the way we do now and that it is (or at least has to emulate) a byte offset within the stored representation of the directory.  They probably noticed that the C type of the member is the one used for file offsets.  That means only in a huge directory could it have nonzero upper bits.
<p>
It's not clear to me how they disposed of the possibility of a huge directory, but that's probably beside the point.
<p>
But I have to say I assume the developers knew they were taking a risk.  Common sense would have told them that modern filesystems, especially the ones that haven't been invented yet, don't have such simple implementations of directories and their developers might well use the upper 32 bits freely.  They decided to trade the future breakage for all the present benefits truncating the offset gave them .  We tend to remember those tradeoffs differently after payment becomes due.

      
          <div class="CommentReplyButton">
            <form action="/Articles/545222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor546273"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2013 16:56 UTC (Sat)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/546273/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For Samba at least it's certainly just a bug in our code.<br>
<p>
It's interesting how it happened though. The cookie returned from telldir() is defined as a 'long', not a fixed length type. Back in the day on simpler filesystems, this used to be the index into the directory.<br>
<p>
We were lazy and just naturally assumed it would always be such, and back in the 32-bit days a long fit into a 32-bit DOS protocol search directory field, so we just stuffed it in there.<br>
<p>
Modern CIFS/SMB/SMB[2|3] use a last-filename character string to restart a search, not an integer index, so newer clients never run into this problem. It's only old DOS clients that use the 32-bit index protocol request. So when the underlying systems went from 32-bit to 64-bit, we mostly didn't notice (everyone was running Windows rather than DOS, plus the kernel still didn't use the top 32-bits of the now 64-bit long return from telldir()).<br>
<p>
Then the kernel changed, the top 32-bit started to be used and old DOS clients broke. Oops. As it's old DOS clients we still haven't fixed this (there really aren't that many still out there, if there were the NAS vendors would have been screaming for a fix long before now).<br>
<p>
So what happened ? Ignorance, lazyness and errors on our part - mostly. However, if the telldir() interface had returned a deliberately opaque struct as a cookie instead of an integer that was expected to be an index, then we probably wouldn't have made this error.<br>
<p>
So I'd argue internal semantics of telldir() changed (from index to cookie), but the ABI didn't (the cookie was just hidden inside what used to be the index).<br>
<p>
Still, I don't think the kernel should change. We just need to fix our crappy userspace code and learn our lesson in future :-).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/546273/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor547143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 12, 2013 13:07 UTC (Fri)
                               by <b>meuh</b> (guest, #22042)
                              [<a href="/Articles/547143/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>For Samba at least it's certainly just a bug in our code.</blockquote>

<p>Or it's a bug in the API: why not using an <tt>off_t</tt> type ?</p>

<blockquote>
It's interesting how it happened though. The cookie returned from telldir() is defined as a 'long', not a fixed length type. Back in the day on simpler filesystems, this used to be the index into the directory.
</blockquote>

<p><tt><a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/telldir.html">telldir()</a></tt> returns a <tt>long</tt>, but <tt><a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/readdir.html">readdir()</a></tt> returns a <tt>struct dirent</tt> that, under Linux (see <tt><a href="http://man7.org/linux/man-pages/man3/readdir.3.html">readdir(3)</a></tt>) hold an <tt>off_t</tt> <tt>d_off</tt> field. <tt>d_off</tt> might be 64bits wide even on a 32bits system with support for <a href="http://opengroup.org/platform/lfs.html">Large File Support (LFS)</a> (compiled with <tt><a href="http://users.suse.com/~aj/linux_lfs.html">-D_FILE_OFFSET_BITS=64 -D_LARGE_FILE_SOURCE=1</a></tt>), while <tt>long</tt> is still 32bits wide. So after the <i>ext4 cookie extension</i> one would be afraid to see that <tt>d_off</tt> could hold a value bigger than the one returned by <tt><a href=http://man7.org/linux/man-pages/man3/telldir.3.html>telldir(3)</a></tt>.</p>

<p>Hopefully <tt><a href="http://man7.org/linux/man-pages/man3/readdir.3.html">readdir(3)</a></tt> is implemented using <tt><a href="http://man7.org/linux/man-pages/man2/getdents.2.html">getdents(2)</a></tt> which returns an <tt>unsigned long</tt> on all configurations.</p>


<p>You might want to read my <a href="https://lwn.net/Articles/544856/">other comment</a> regarding extending to 64bits something that's going to be a 32bits value anyway.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/547143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor544772"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The ext4 change 'breaks' Samba too</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 2:43 UTC (Thu)
                               by <b>abartlet</b> (subscriber, #3928)
                              [<a href="/Articles/544772/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is interesting to see this article, because this same change (from the description) also 'breaks' Samba.<br>
<p>
We see the same thing, and have had to blacklist a number of our testsuites from our automated testing, because when an older diretory searching/enumeration protocol is used, we mapped the readdir() cookie onto a 4 byte element in that protocol.  These tests in turn started spinning in an infinite loop due to the truncation.<br>
<p>
Now, the fix for us is presumably to have some other in-memory mapping from 64-bit back to 32-bit for the cookies Samba clients have obtained.  Naturally we also would need to avoid a DoS by allocation of an infinite number of mapped cookies, and other challenges, which along with the real-world use case for the interface being old DOS clients, means we haven't got around to it yet. <br>
<p>
I only mention this to indicate that this was noticed beyond GlusterFS. <br>
<p>
Andrew Bartlett<br>
Samba Team<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544772/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544816"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The ext4 change 'breaks' Samba too</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 7:54 UTC (Thu)
                               by <b>Lumag</b> (subscriber, #22579)
                              [<a href="/Articles/544816/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why can't GlusterFS also have an internal mapping between new cookies and some random bitstring given as a part of NFS' readdir() ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544816/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544896"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The ext4 change 'breaks' Samba too</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 13:34 UTC (Thu)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/544896/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Once handed out to an NFS client, you don't know when the client may use a cookie; could be much later, could be after we've rebooted.  So that internal mapping would have to be kept forever, on disk (to survive reboots).

<p>You could do it, but I think you'd quickly start feeling like you were doing a ton of work that the filesystem should really be doing for you.

<p>SMB might make this easier, I don't know.

<p>It might be possible to extend the NFS protocol to use some kind of directory-read pointer with a more limited lifetime.  But that won't solve anybody's problem today, at least not until we get the IETF a time machine.  (Four days left for someone to publish an RFC addressing the paradoxes inherent to time-travelling standards processes.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/544896/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor545312"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The tree makes noise, but we need a test to listen for it</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2013 17:30 UTC (Sat)
                               by <b>davecb</b> (subscriber, #1574)
                              [<a href="/Articles/545312/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Many years ago I was on the ABI stability team at Sun, and we actively tried to test all the "must be true" assertions in library interfaces like this.  The easiest were changes in the nature of parameters: the hardest were changes in the meanings of otherwise unchanged parameters.<br>
<p>
Ones like this we would have considered either "uninterpreted opaque cookie" (good) or "must be zero" (bad). Finding the latter usually resulted in version-number changes, weird backward-compatibility tests to see if anyone had stolen the upper half for anything and debates about how to change the documentation.<br>
<p>
As a side effect, we tried to write a static test or shared-library test we could run against any apps that were being compatibility-tested by their vendors, and we recorded the difference in our porting database, so that if another vendor or an old SunOS system used it, it would get fixed in a port.  <br>
<p>
The latter, IMHO, was the really valuable part: if Hockey-PUX had the bug, we'd refrain from reproducing it on applications ported to Solaris. Linux rarely has such bugs: other vendors (including ourselves) weren't as fortunate.<br>
<p>
--dave<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545312/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor545023"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 19:35 UTC (Thu)
                               by <b>xorbe</b> (guest, #3165)
                              [<a href="/Articles/545023/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This whole mess is one big hack.  Sounds like NFS should have a defined spare field just for cookie usage.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545023/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor545028"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 19:52 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/545028/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why, it already has a field for the cookie, what benefit would a second field provide?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545028/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor545039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2013 21:02 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/545039/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Larger cookie size. 64 bits are not really enough for a lots of uses.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor546019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 4, 2013 19:23 UTC (Thu)
                               by <b>aakef</b> (subscriber, #38030)
                              [<a href="/Articles/546019/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Btw, the patch has a "Patch-updated-by" and "blame me" description. So Fan Yong shouldn't be blamed alone...<br>
<p>
<p>
Bernd<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/546019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor546080"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel change breaks GlusterFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2013 6:20 UTC (Fri)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/546080/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Btw, the patch has a "Patch-updated-by" and "blame me" description. So Fan Yong shouldn't be blamed alone...</font><br>
<p>
Bernd,<br>
<p>
It was not my intention to assign blame, and I'm sorry if the article gave that impression. The change that Fan Yong (or something like it) made was obviously needed. And, at some level, I could imagine that the FS developers didn't see this as an ABI change. My point was a general one: even things that may not look like ABI changes may in fact be so, and developers as a group perhaps need to be even more vigilant about that possibility. (The message queue change is a similar kind of case. One could easily have thought of it as *not* being an ABI change, but it was.)<br>
<p>
Thanks,<br>
<p>
Michael<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/546080/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
