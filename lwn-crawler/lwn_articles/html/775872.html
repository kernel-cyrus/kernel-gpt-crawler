        <!DOCTYPE html>
        <html lang="en">
        <head><title>A setback for fs-verity [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/775872/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/775923/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/775872/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A setback for fs-verity</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 3, 2019</br>
           </div>
The <a href="/Articles/763729/">fs-verity mechanism</a>, created to protect
files on Android devices from hostile modification by attackers, seemed to
be on track for inclusion into the mainline kernel during the current merge
window when <a
href="/ml/linux-kernel/20181101225230.88058-1-ebiggers@kernel.org/">the
patch set</a> was posted at the beginning of November.  Indeed, it wasn't
until mid-December that some other developers started to raise objections.
The resulting conversation has revealed a deep difference of opinion regarding
what makes a good filesystem-related API and may have implications for how
similar features are implemented in the future.
<p>
The core idea behind fs-verity is the use of a <a
href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree</a> to record
a hash 
value associated with every block in a file.  Whenever data from a
protected file is read, the kernel first verifies the relevant block(s)
against the hashes, and only allows the operation to proceed if there is a
match.  An attacker may find a way to change a critical file, but there is
no way to change the Merkle tree after its creation, so any changes made
would be immediately detected.  In this way, it is hoped, Android systems
can be protected against certain kinds of persistent malware attacks.
<p>
There is no opposition to the idea of adding functionality to the kernel to
detect hostile modifications to files.  It turns out, though, there there
is indeed some opposition to how this functionality has been implemented in
the current patch set.  See the above-linked article and <a
href="/ml/linux-kernel/20181101225230.88058-2-ebiggers@kernel.org/">this
documentation patch</a> for details of how fs-verity is meant to work.  In
short, user space is responsible 
for the creation of the Merkle tree, which must be surrounded by header
structures and carefully placed at the beginning of a block after the end
of the file data.  An <tt>ioctl()</tt> call tells the kernel that fs-verity
is to be invoked on the file; after that, the location of the end of the
file (from a user-space point of view) is changed to hide the Merkle tree
from user space, and the file itself becomes read-only.
<p>
Christoph Hellwig was the first <a
href="/ml/linux-kernel/20181212091406.GA31723@infradead.org/">to oppose the
work</a>, less than two weeks before the opening of the merge window.  The
storage of the Merkle tree inline was, he said, "<q>simply not
acceptable</q>" and the interface should not require a specific way of
storing this data.  He later <a
href="/ml/linux-kernel/20181213202249.GA3797@infradead.org/">suggested</a>
that the hash data should be passed separately to the <tt>ioctl()</tt>
call, rather than being placed after the file data.  Darrick Wong <a
href="/ml/linux-kernel/20181217200039.GD8111@magnolia/">suggested</a> a
similar interface, noting that it would give the filesystem a lot of
flexibility in terms of how the hash data would be stored.
<p>

Dave Chinner <a
href="/ml/linux-kernel/20181219021953.GD31274@dastard/">complained</a> that
storing the Merkle tree after the end of the file was incompatible with how
some filesystems (XFS in particular) use that space.  He <a
href="/ml/linux-kernel/20181219213552.GO6311@dastard/">described</a> the
approach as being "<q>gross</q>", arguing that it "<q>bleeds
implementation details all over the API</q>" and creates problems far
beyond the filesystems that actually implement fs-verity:
<p>
<div class="BigQuote">
	That's the problem here - fsverity completely redefines the layout
	of user data files for everyone, not just fsverity, and not just
	the filesystems that implement fsverity. You've taken an ext4
	fsverity implementation feature and promoted it to being a
	linux-wide file data layout standard that is encoded into the
	kernel/user ABI/API forever more.
</div>
<p>
Chinner, too, argued that the Merkle-tree data should be provided
separately to the kernel, rather than being stored in the file itself using
a specific format.  Filesystem implementations could still put the data
after the end of the existing data, but that is a detail that should,
according to Chinner be hidden from user space.
<p>
Eric Biggers, the developer of fs-verity, <a
href="/ml/linux-kernel/20181212202609.GA193967@gmail.com/">responded</a>
that, while the API requires user space to place the Merkle tree after
the end of user data,
there is no actual need for filesystems to keep it there:
<p>
<div class="BigQuote">
	As explained in the documentation, the core code uses the "metadata
	after EOF" format for the API, but not necessarily the on-disk
	format.  I.e., FS_IOC_ENABLE_VERITY requires it, but during the
	ioctl the filesystem can choose to move the metadata into a
	different location, such as a file stream.
</div>
<p>
He also <a
href="/ml/linux-kernel/20181214044802.GA681@sol.localdomain/">said</a> that
passing the Merkle tree in as a memory buffer is problematic, since it
could be too large to fit into memory on a small system.  (The size of this
data also prevents it from being stored as an extended attribute as some
have suggested.)  Generating the hash data in the kernel was also
considered, Biggers said, but it was concluded that this task was better
handled in user space.
<p>
Ted Ts'o <a href="/ml/linux-kernel/20181219001603.GD25775@mit.edu/">claimed</a> repeatedly that there
would be no value to be had by changing the API for creating protected
files; he described the complaints as "<q>really more of a philosophical
objection than anything else</q>".  The requested API, he said, could be
added later (in addition to the proposed API, which would have to be
maintained indefinitely) if it turned out to be necessary.  
After the discussion continued for
a while, he <a
href="/ml/linux-kernel/20181221154714.GA26547@mit.edu/">escalated the
discussion</a> to Linus Torvalds, asking for a decision:
<p>
<div class="BigQuote">
	Linus --- we're going round and round, and I don't think this is
	really a technical dispute at this point, but rather an aesthetics
	one.  Will you be willing to accept my pull request for a feature
	which is being shipped on millions of Android phones, has been out
	for review for months, and for which, if we *really* need to add
	uselessly complicated interface later, we can do that?
</div>
<p>
<div class="tlr">
<b>Correction</b>: I've been reminded that there was <a
href="https://marc.info/?l=linux-fsdevel&m=151752635314843">an extensive
discussion</a> of this work in early 2018 where many of the same objections
were raised.
</div>
Complaining that the code had been out for review makes some sense; it is
true that the objections surfaced at something close to the last minute.
But that often happens in kernel development; the imminent merging of
controversial code can concentrate developers' minds in that direction.
Arguing that the API is already being shipped is definitely not a way to
win favor.  That notwithstanding, Ts'o had clearly hoped for a ruling from
Torvalds that the current API was good enough and that the code could be
merged.
<p>
What came back might well have failed to please anybody in the discussion,
though.  It <a
href="/ml/linux-kernel/CAHk-=wgdzWgoPSuHeVcqmGE1hB3Gan72r2_AhtC14e60=z45yg@mail.gmail.com/">turns
out</a> that Torvalds has no real objection to the model of storing the
hash data at the end of the file itself:
<P>
<div class="BigQuote">
	So honestly, I personally *like* the model of "the file contains
	its own validation data" model. I think that's the right model, so
	that you can then basically just do "enable verification on this
	file, and verify that the root hash is this".
<p>
	So that part I like. I think the people who argue for "let's have a
	separate interface that writes the merkle tree data" are completely
	wrong.
</div>
<p>
From there, though, he made it clear that he was not happy with the current
implementation.  This model, he said, should be independent of any
specific filesystem, so it should be entirely implemented in the virtual
filesystem layer.  At that point, filesystems like XFS would never even see
the fs-verity layer, so its implementation could not be a problem for
them.  A generic implementation would require no filesystem-specific code
and would just work universally.  He also disliked the trick that hides the
Merkle tree after the fs-verity mode has been set; the validation data for
the file should just be a part of the file itself, he said.
<p>
As Ts'o <a href="/ml/linux-kernel/20181222041712.GC26547@mit.edu/">pointed
out</a>, keeping the hash data visible in the file would create confusion
for higher-level software that has its own ideas about the format of any
given file.  He also provided <a
href="/ml/linux-kernel/20181223043449.GF26547@mit.edu/">some reasons</a>
for why he thinks filesystems need to be aware of fs-verity; they include
ensuring that the right thing happens if a filesystem containing protected
files is mounted by an older version of the filesystem code.  Making
fs-verity fully generic would, he said, have forced low-level API changes
that would have affected "<q>dozens of filesystems</q>", a cost that
he doesn't think is justified by the benefits.
<p>
The last message from Ts'o was sent on December 22; Torvalds has not
responded to it.  <strike>There has not, however, been a pull request for
fs-verity 
sent, and it is getting late in the merge window for such a thing to show
up.</strike> [<b>Correction</b>: <a
href="https://patchwork.kernel.org/patch/10745561/">a pull request</a> was
sent copied only to the
linux-fscrypt mailing list; it has not received a response as of this
writing.]  It seems likely that fs-verity is going to have to skip this 
development cycle while the patches are reworked to address some of the
objections that have been raised — those from Torvalds, at least.  Even
then, the work might be controversial; it is rare for the kernel to
interpret the contents of files, rather than just serving as a container
for them, and some developers are likely to dislike an implementation that
depends on that sort of interpretation.  But if Torvalds remains in favor
of such an approach, it is likely to find its way into the kernel
eventually.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-fs-verity">Filesystems/fs-verity</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Integrity_verification">Security/Integrity verification</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Integrity_management">Integrity management</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/775872/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor775965"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 20:13 UTC (Thu)
                               by <b>simcop2387</b> (subscriber, #101710)
                              [<a href="/Articles/775965/">Link</a>] (30 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder if this would do better to store it in part of the xattr data instead?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775965/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 20:37 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/775966/">Link</a>] (29 responses)
      </p>
      
      </div>
      </summary>
      As noted in the article, extended attributes (at least as implemented in Linux) won't work.  The Merkle-tree data is simply too large to be stored that way.
      
          <div class="CommentReplyButton">
            <form action="/Articles/775966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775973"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 22:13 UTC (Thu)
                               by <b>TheGopher</b> (subscriber, #59256)
                              [<a href="/Articles/775973/">Link</a>] (28 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just to iterate a bit on this: Why aren't xattr's changed then to support this size of data? This seems to be a case of "The current mechanism doesn't support storing metadata of this size, so let's create a new one..." instead of the general way of Linux, which is to fix things.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775973/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775977"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 22:35 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/775977/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Alternate data streams were suggested but shot down.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775977/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor775974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 22:38 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/775974/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A generic mechanism would seem to be a better idea...<br>
<p>
But, to make xattrs support large data would effectively also require creating a brand new mechanism. It's not quite simple. As the tip of the iceberg,  "getxattr" and "setxattr" can only deal with the entire value at once -- not a good idea for a large data stream.<br>
<p>
However, other OSes do support this sort of thing, allowing "forks" of the file to be opened for reading/writing just as a normal file. E.g., Windows NTFS has "alternate data streams", and Solaris has "fsattr". (<a href="https://docs.oracle.com/cd/E19253-01/816-5175/6mbba7f02/">https://docs.oracle.com/cd/E19253-01/816-5175/6mbba7f02/</a>)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775994"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 8:43 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/775994/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That doesn’t really help, since the alternate data streams can be used by applications, so the fs-verity Merkle tree needs to be for the whole file, including all its forks?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775994/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 9:01 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/775995/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Merkle tree is self-verifying, so it doesn't need to be further checksummed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776064"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2019 21:22 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/776064/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I mean is that since the alternate data streams are exposed to user space, each one needs its Merkle tree. So it would appear you need to implement the verifying at some lower level of filesystem code where you are dealing with a single piece of data. Either that or generalize it to add one extra steam for each stream that exists - and then arrange to hide these extra ones from user space. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776064/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776095"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 2:40 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/776095/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; or generalize it to add one extra steam for each stream that exists </font><br>
<p>
Sounds good.<br>
<p>
<font class="QuotedText">&gt; and then arrange to hide these extra ones from user space. </font><br>
 <br>
Why? Aren't stream typed on some way?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776095/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor776005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 12:20 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/776005/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about defining a special xattr that just points (via path, like a symlink) to a separate file containing the validation data? This way, you obviate the xattr size restriction. VFS, when it opened a file protected by this symlink-to-validation-blob xattr, would just transparently open the pointed-to file as well. You could even arrange for unlink(2) to delete the pointed-to validation file as well, if you wanted to remain compatible with today's file management code. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776008"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 14:20 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/776008/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>I like this idea, but on the other hand, you now used up two file descriptors each time you open a file, and something has to manage the hidden descriptor.  You could also run into weird issues if the second open fails, but then I guess you'd just fail everything.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776008/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776038"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 19:02 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/776038/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not two file descriptors --- from userspace's POV, there's just one file and its descriptor. That VFS internally would maintain an internal pointer to a different struct file is just an implementation detail. And yes, VFS could just fail the open if the authentication blob file couldn't be opened.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776038/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776040"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 20:26 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/776040/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>You could generalize this idea to allow multiple data forks.  The fs-verity Merkle tree would be a special data fork that could be set once only and then never changed.  I think this is a much nicer approach than shoving the verification data at the end of the file.

      
          <div class="CommentReplyButton">
            <form action="/Articles/776040/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776041"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 20:34 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/776041/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
generalization is the enemy of LKML patch acceptance though. :-) I think starting simple might be a good approach. I'll send an LKML email.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776041/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776042"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 20:40 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/776042/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Haha. :)  I'm not a kernel developer and have only recently started a job that requires looking deeply into the kernel, so I'm a newbie at this.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776042/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor776047"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2019 1:44 UTC (Sat)
                               by <b>himi</b> (subscriber, #340)
                              [<a href="/Articles/776047/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another option for generalising xttrs to support larger data sizes would be to allow for an xattr that pointed to an inode which would contain the extra data, with an extension to the API that allowed the inode (which would otherwise not have any path associated) to be opened to give a regular file descriptor that could be treated the same as any other open file. Voila - "multiple file streams" in a way that's completely transparent to the rest of the filesystem . . .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776047/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2019 7:46 UTC (Sat)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/776050/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      It can't be 100% transparent: you need the various integrity-validation mechanisms (<tt>fsck</tt> and its online brethren) to be aware, so they won't consider these inodes to be orphaned.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2019 8:08 UTC (Sat)
                               by <b>bof</b> (subscriber, #110741)
                              [<a href="/Articles/776051/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm.<br>
<p>
Keeping the extra streams could be as easy as putting them in a hidden directory of the same filesystem, e.g. ..forx at the root (each stream named after the original inode plus some discriminator for multiple streams of a given file). That should be transparent to any existing fsck.<br>
<p>
Instead of xattrs, these /..forx/inum things could even just be directories by themselves, with each (named or whatever) fork getting a regular inode inside. Which would even allow for nested forks, a specific fork being a symlink, device node, have special ownership and permissions, times, .....<br>
<p>
A special mount option to ignore the magic, would make the filesystem wholly-copyable/clonable using the usual tools, too. <br>
<p>
However, whatever the exact approach, there's the little issue of stuff like "du" reporting underestimated sizes, the bigger issue of teaching any kind of "cp" like command to cope with the forks (including changes to archiver file formats....) - and all of that would only just simply work out for local filesystems, not NFS + friends.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2019 9:18 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/776052/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Instead of xattrs, these /..forx/inum things could even just be directories by themselves, with each (named or whatever) fork getting a regular inode inside. Which would even allow for nested forks, a specific fork being a symlink, device node, have special ownership and permissions, times, .....</font><br>
There were several attempts to make "file-as-directory" thingies (I remember one in Reiser4). Whatever happened to them?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776065"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2019 22:21 UTC (Sat)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/776065/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; There were several attempts to make "file-as-directory" thingies (I remember one in Reiser4). Whatever happened to them?</font><br>
<p>
They all hit the cold hard wall of practicality.  You cannot create semantics that do what you want.<br>
<p>
If you want a file to start acting like a directory, it has to stop acting like a file.  One way to achieve this is to "-o loop" mount it somewhere else with an appropriate filesystem driver.  You could come up with other approaches, such as an overlay filesystem which presents select files as directories.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776065/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 2:48 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/776096/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If you want a file to start acting like a directory, it has to stop acting like a file.</font><br>
<p>
Mac OS X plays tricks like this but I guess they're just directories from its filesystem perspective, all magic in userspace?<br>
<p>
<a href="https://www.oreilly.com/library/view/mac-os-x/0596004605/ch01s12.html">https://www.oreilly.com/library/view/mac-os-x/0596004605/...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776168"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource Forks, Bundles, etc.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 19:32 UTC (Mon)
                               by <b>jccleaver</b> (subscriber, #127418)
                              [<a href="/Articles/776168/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, yes and no.<br>
<p>
HFS (and HFS+, and MFS) all have a native understanding of dual-forked files. It's been a part of the Mac OS world ever since the original 128k Mac in 1984. The problem is that the rest of the computing world mostly had adopted the "a file is a data stream and that's it" model of unix. This is what led to years of problems transferring Mac files around via FTP on the internet and the creation and adoption of formats like MacBinary and BinHex. For MIME purposes, AppleSingle and AppleDouble were used. From RFC1740 <a href="https://www.ietf.org/rfc/rfc1740.txt">https://www.ietf.org/rfc/rfc1740.txt</a> <br>
<p>
<font class="QuotedText">&gt;    Files on the Macintosh consists of two parts, called forks:</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    Data fork:       The actual data included in the file.  The Data</font><br>
<font class="QuotedText">&gt;                     fork is typically the only meaningful part of a</font><br>
<font class="QuotedText">&gt;                     Macintosh file on a non-Macintosh computer system.</font><br>
<font class="QuotedText">&gt;                     For example, if a Macintosh user wants to send a</font><br>
<font class="QuotedText">&gt;                     file of data to a user on an IBM-PC, she would only</font><br>
<font class="QuotedText">&gt;                     send the Data fork.</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    Resource fork:   Contains a collection of arbitrary attribute/value</font><br>
<font class="QuotedText">&gt;                     pairs, including program segments, icon bitmaps,</font><br>
<font class="QuotedText">&gt;                     and parametric values.</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    Additional information regarding Macintosh files is stored by the</font><br>
<font class="QuotedText">&gt;    Finder in a hidden file, called the "Desktop Database".</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    Because of the complications in storing different parts of a</font><br>
<font class="QuotedText">&gt;    Macintosh file in a non-Macintosh filesystem that only handles</font><br>
<font class="QuotedText">&gt;    consecutive data in one part, it is common to convert the Macintosh</font><br>
<font class="QuotedText">&gt;    file into some other format before transferring it over the network.</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    The two styles of use are [APPL90]:</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    AppleSingle:   Apple's standard format for encoding Macintosh files</font><br>
<font class="QuotedText">&gt;                   as one byte stream.</font><br>
<font class="QuotedText">&gt;    AppleDouble:   Similar to AppleSingle except that the Data fork is</font><br>
<font class="QuotedText">&gt;                   separated from the Macintosh-specific parts by the</font><br>
<font class="QuotedText">&gt;                   AppleDouble encoding.</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    AppleDouble is the preferred format for a Macintosh file that is to</font><br>
<font class="QuotedText">&gt;    be included in an Internet mail message, because it provides</font><br>
<font class="QuotedText">&gt;    recipients with Macintosh computers the entire document, including</font><br>
<font class="QuotedText">&gt;    Icons and other Macintosh specific information, while other users</font><br>
<font class="QuotedText">&gt;    easily can extract the Data fork (the actual data) as it is separated</font><br>
<font class="QuotedText">&gt;    from the AppleDouble encoding.</font><br>
<p>
It was not uncommon for some files to be entirely resource forks and with empty data forks. <br>
<p>
In fact, before the PowerPC era and the increasing complexity of shared libraries and apps generally, it was not uncommon for application programs in the System 6 era to consist entirely of a single file, which could be located where-ever you wanted to. (Imagine if, on the *nix side, all your gettext files and support directories and other miscellaneous crap even console programs might have strewn about the file system were all in a single file on the system.)<br>
<p>
Eventually, things got more and more complicated (especially once shared libraries became A Thing on the Mac). Office 6 was a notable monstrosity of filesystem complexity, which made Office 98 a thing of beauty -- you could simply drag the entire Office folder over and that was it.<br>
<p>
Note: All of this below is spelled out in Apple technote: <a href="https://developer.apple.com/library/archive/technotes/tn/tn1188.html">https://developer.apple.com/library/archive/technotes/tn/...</a><br>
<p>
By the Mac OS 9 timeframe, a solution was wanted. What ended up being used was a "bundle" bit being set in the fs metadata on certain folders to make them look like files. This hid most of the unnecessary complexity from the user and let them drag things around and manipulate the application as a single entity. If the app didn't need to install something into the System Folder, this meant you could once again think of the app as a single item and treat it accordingly.<br>
<p>
It should be pointed out, though that resource forks were still being used here. The bundle-as-single-icon was more for associating multiple *files*, all of which could have both resource and data forks (and other named forks, but this was rarely used). That said, PPC code was located in the data fork now instead of the resource fork, so it was loaded as more or less an unstructured blob rather than structure CODE blocks handled by the Resource Manager.<br>
<p>
When Mac OS became Mac OS X, the de-emphasis of resource folks continued. UFS didn't know what to do with them, more and more file transfer on the internet was happening, which meant lots of inefficient BinHex encoding, and command line tools had barely any concept of the closest parallel: Windows NTFS "streams", which were barely used as well. The solution eventually developed was to treat Resource Forks on filesystems that didn't support them the same way as had been done on FS. <br>
<p>
The NeXT-ization of Apple had many benefits, but IMO this was a step backwards. Rich metadata like resources provided something few other OS's had, but made things actually *simpler* on disk as long as the tools and apps knew what to expect. Sadly, Apple didn't even patch the low-level BSD cp/mv commands to understand multiple fork files until 10.4, so it's clear this was the direction things were going to go toward. Thus we end up in a world where Bundles and Packages exist and native multiple-fork files are rare. See <a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/AboutBundles/AboutBundles.html">https://developer.apple.com/library/archive/documentation...</a> for details on how it looks from an OS X perspective.<br>
<p>
<font class="QuotedText">&gt; Mac OS X plays tricks like this but I guess they're just directories from its filesystem perspective, all magic in userspace?</font><br>
<p>
TL;DR: Folders that appear as a single file, but can be drilled down into in some places (including the Finder).<br>
<p>
Hope that helped.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776168/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776194"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource Forks, Bundles, etc.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2019 3:13 UTC (Tue)
                               by <b>ghane</b> (guest, #1805)
                              [<a href="/Articles/776194/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah ...<br>
<p>
So AppImage as done by Apple many years earlier?  :-)<br>
<p>
--<br>
Sanjeev<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776194/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776198"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource Forks, Bundles, etc.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2019 8:38 UTC (Tue)
                               by <b>jccleaver</b> (subscriber, #127418)
                              [<a href="/Articles/776198/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; So AppImage as done by Apple many years earlier? :-)</font><br>
<p>
Well, more or less. Apple obviously didn't have the true chaos of distros and *nix variants to deal with, just the (brilliant) 68k-&gt;PPC transition and the (very well done) PPC-&gt;Intel transition, so packaging was never *truly* horrible on the Mac compared to pretty much any other system (especially Windows). OS X application bundles handled multiple architectures with universal binaries almost as a trivial after-thought compared to all the other stuff that was now existing as a separate (hidden) file.<br>
<p>
Having complex (eg, multi-stream, "Resource Manager"-accessed) files but far fewer of them made for a much more grokable operating system than what others have had to deal with. The classic Mac system software had no command line, and while graphical linux environments try to get by with that, *nix systems are still dealing with thousands or 10's of thousands of files on a fresh install. That's a lot of complexity to try to paper back over. Even at the worst "7.5.3 Update 2" era Mac OS complexity, you were still only dealing with a couple of hundred files on a new install, max. And if it weren't for System Enablers (basically hardware support files for each released Apple computer family model) it would have been far less.<br>
<p>
The Mac OS -&gt; OS X transition was rued by many a classic Mac fan for the interface changes, but more fundamental was the knowledge that we were going from a fundamentally *more simple* system to a complex one that would have to sort of simulate a simple one. FlatPacks, AppImage, and containers generally are all ways to try to get back to that sort of mental simplicity (at the expense of system-management issues such as duplicated libraries or fully static binaries). But there's a place for all kinds of paradigms out there, and smashing them together because Devs can't grok *nix can't really ever achieve the best of either world: the fine-tuning of professional system administration of a complex system, or the ease-of-use and only-a-certain-number-of-things-that-could-be-going-wrongness of a system with fewer parts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776198/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor777035"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource Forks, Bundles, etc.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2019 19:21 UTC (Thu)
                               by <b>kevinkrouse</b> (guest, #86616)
                              [<a href="/Articles/777035/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I grew up with a Macintosh II in the '90s and your post brought me much nostalgia.  I fondly recall changing the resource fork of games with ResEdit to swap out the built-in sounds and sprites with my own.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/777035/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor776216"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2019 15:41 UTC (Tue)
                               by <b>mina86</b> (guest, #68442)
                              [<a href="/Articles/776216/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      If I understand you correctly, you’re suggesting a <code>iopen(int inode, int flags, mode_t mode)</code> syscall. If that’s the case, the problem is that it would allow bypassing filesystem permissions. Namely, it would render execution bit of a directory useless since user would be able to read a world-readable file even if it resides in directory they have no access to.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776216/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776241"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2019 20:55 UTC (Tue)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/776241/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>I'm envisioning something more like <code>openxattrat(int dirfd, const char *path, const char *name, int flags, mode_t mode)</code>—the link to the internal xattr inode would be hidden in the filesystem and you would need at least search access to the file to open the linked xattr inode. User-mode software would never handle the raw inode numbers.</p>

<p>The resulting FD could then be passed as dirfd to openxattrat() (with an empty path) or to flistxattr()/fgetxattr()/fsetxattr() to access the xattrs of the resulting inode, recursively.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/776241/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776256"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2019 1:26 UTC (Wed)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/776256/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It sounds like you're reinventing the same design Solaris already created, but with a needleesly different API.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776256/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2019 4:05 UTC (Thu)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/776360/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wouldn't say *needlessly* different, since in the Solaris version openat(O_XATTR) can only open attributes for files which are already open, while attropen() lacks a dirfd argument and thus can only use the current working directory for relative paths. My proposed openxattrat() function would basically be attropen() + dirfd. (Perhaps attropenat() would be more fitting?) In general, though, I agree that the concepts are very similar and there is no reason not to adopt the Solaris interface.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor776218"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2019 15:45 UTC (Tue)
                               by <b>mina86</b> (guest, #68442)
                              [<a href="/Articles/776218/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Changes to <code>unlink(2)</code> would break <code>rm *</code> though. E.g. if I run <code>rm file file.xattr</code> I’ll get an error deleting the second file since it got deleted transparently.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776218/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776320"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Extended attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2019 17:16 UTC (Wed)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/776320/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was imagining that we'd keep the validation blobs in a separate hidden directory where normal user activity (e.g., "rm *") wouldn't find them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776320/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor775981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 23:23 UTC (Thu)
                               by <b>ohrn</b> (subscriber, #5509)
                              [<a href="/Articles/775981/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Dumb question. What is the purpose of using a hash tree?<br>
<p>
Seems to me a single level list of hashes for the data blocks would be enough?<br>
<p>
If someone malicious can modify a hash in the list they can surely modify the entire tree, so hashing the hashes doesn't seem to give much of a benefit?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775983"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 23:29 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/775983/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If someone malicious can modify a hash in the list they can surely modify the entire tree, so hashing the hashes doesn't seem to give much of a benefit?</font><br>
<p>
A benefit is that you can crypto-sign the root hash.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775983/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor776365"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2019 4:51 UTC (Thu)
                               by <b>thestinger</b> (guest, #91827)
                              [<a href="/Articles/776365/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The hashes of the blocks need to be verified too. The information on the disk isn't trusted. The hashes/signatures aren't generated locally but rather are shipped with the updates for those components. The fs-verity code is only used for dynamically updated components outside the base OS partitions, which are verified via a signature (vbmeta), hashes in vbmeta (boot/dtbo) and dm-verity (bootstrapped from vbmeta). Their fs-verity approach lets them extend the verification to components in the userdata partition.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776365/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor775982"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 23:26 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/775982/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; it is rare for the kernel to interpret the contents of files, rather than just serving as a container for them</font><br>
<p>
???<br>
- Directorties<br>
- symlinks<br>
- device-files<br>
- ELF files<br>
Thanks to "-o loop" mounts, filesystems images in files could almost be seen as the kernel interpreting the contents of a file too.<br>
<p>
I quite like Linus' idea that the integrity info should be part of the file (I never liked xattrs or streams).<br>
Maybe if we had a filesystem full of files with integrity info, then an overlay filesystem on top of that which rejected writes, and performed integrity check on all reads.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775982/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775984"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2019 23:38 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/775984/">Link</a>] 
      </p>
      
      </div>
      </summary>
      OK, so I could have written that as "it is rare for the kernel to interpret the contents of <b>plain</b> files" - but I think the meaning was already somewhat clear...
      
          <div class="CommentReplyButton">
            <form action="/Articles/775984/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor775988"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 1:49 UTC (Fri)
                               by <b>doublez13</b> (guest, #122213)
                              [<a href="/Articles/775988/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ted did indeed send a pull request on 12/31/18 for fsverify.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775988/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775989"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pull request</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 2:34 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/775989/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Do you have a link?  I'm not able to find that pull request.
      
          <div class="CommentReplyButton">
            <form action="/Articles/775989/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775990"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pull request</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 3:45 UTC (Fri)
                               by <b>doublez13</b> (guest, #122213)
                              [<a href="/Articles/775990/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://patchwork.kernel.org/patch/10745561/">https://patchwork.kernel.org/patch/10745561/</a><br>
:)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775990/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pull request</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 15:44 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/776024/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Ah...so the only CC was sent to the linux-fscrypt mailing list — a good destination if you want to avoid inconvenient discussion, but one that makes it hard for LWN editors to find the request!  Thanks for the correction.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor776098"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 2:51 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/776098/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; send a pull request on 12/31/18</font><br>
<p>
I'm sure you meant 18-12-31 or 31/12/18 :-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776098/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor775996"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 9:47 UTC (Fri)
                               by <b>corsac</b> (subscriber, #49696)
                              [<a href="/Articles/775996/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have to admit it's a bit confusing to me what's the difference between dm-verity and fs-verity (besides the fact that one is at the device-mapper level and the other at the filesystem-level). Is there some information on this somewhere?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775996/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776022"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vs. dm-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2019 15:08 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/776022/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      dm-verity protects an entire block device, while fs-verity protects single files.  In the Android use case, they don't want to make the entire block device read-only; they just want to keep specific files from being messed with.
      
          <div class="CommentReplyButton">
            <form action="/Articles/776022/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776099"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vs. dm-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 2:56 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/776099/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please correct me; I believe the focus of *both* is on executables: think 1. dm-verity for the entirely immutable partition part of the "OS image" that all users get exactly the same; 2. fs-verity for the partially writable partition where users download and install their own choice of applications from a trusted source like the Play Store.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776099/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776362"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vs. dm-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2019 4:45 UTC (Thu)
                               by <b>thestinger</b> (guest, #91827)
                              [<a href="/Articles/776362/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, that's correct. The early firmware is fully verified from a hardware root of trust, followed by vbmeta being verified by the late stage bootloader which then verifies the hashes of boot (and dtbo if present) from there. The system and vendor partitions are verified via dm-verity, bootstrapped from hashes in vbmeta. That's all read-only at boot, and is never directly written. Updates write to the alternate partition set (for firmware and the OS partitions), and then a reboot into the new version is done by switching to the new partition set, which has already been verified by the updater before marking it as usable (in case a write error occurred) and then gets verified again by verified boot. The fs-verity support is used to verify dynamically updated components in the rw userdata partition.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776362/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor776364"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vs. dm-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2019 4:47 UTC (Thu)
                               by <b>thestinger</b> (guest, #91827)
                              [<a href="/Articles/776364/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
fs-verity is used to implement ro.apk_verity.mode for the rw userdata partition. The OS itself is fully verified via dm-verity (system/vendor), hashes (boot/dtbo) and a signature (vbmeta). Those are all read-only at runtime, and updated by writing to the alternate partition set.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776364/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor776097"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 2:51 UTC (Mon)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/776097/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"it is true that the objections surfaced at something close to the last minute."<br>
<p>
Did they really?  I thought that at the very least similar objections had been raised at LSFMM.  My memories are vague, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776097/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776370"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2019 7:47 UTC (Thu)
                               by <b>dgc</b> (subscriber, #6611)
                              [<a href="/Articles/776370/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, they were raised at LSFMM. The LWN report doesn't really convey the "hell no" response that some of us had at LSFMM to putting special data beyond EOF in user files and adding special mechanisms to manage and then read beyond EOF....<br>
<p>
<a href="https://lwn.net/Articles/752614/">https://lwn.net/Articles/752614/</a><br>
<p>
-Dave.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776370/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor776100"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 3:00 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/776100/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder if *any* discussion about meta-data has ever seen some consensus :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776100/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor776103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A setback for fs-verity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2019 4:09 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/776103/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I wonder if *any* discussion about meta-data has ever seen some consensus :-)</font><br>
<p>
I'm fairly sure the only way to achieve consensus, is to only have one voice.<br>
(There is no "metadata" - there is only data, some of which you haven't met yet).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/776103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
