        <!DOCTYPE html>
        <html lang="en">
        <head><title>Block-device snapshots with blksnap [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/914031/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/914360/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/914031/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Block-device snapshots with blksnap</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 14, 2022</br>
           </div>
As a general rule, one need not have worked in the technology industry for
long before the value of good data backups becomes clear.  Creating a
backup that is truly good, though, can be a challenge if the filesystem in
question is actively being changed while the backup process runs.  Over the
years, various ways of addressing this problem have been developed, ranging
from simply shutting down the system while backups run to a variety of
snapshotting mechanisms.  The kernel may be about to get another approach
to snapshots should <a
href="/ml/linux-kernel/20221102155101.4550-1-sergei.shtepa@veeam.com/">the blksnap
patch set</a> from Sergei Shtepa find its way into the mainline.
<p>
The blksnap patches are rigorously undocumented, so much of what follows
comes from reverse-engineering the code.  Blksnap performs snapshotting at
the block-device level, meaning that it is entirely transparent to any
filesystems that may be stored on the devices in question.  It is able to
create snapshots of a set of multiple block devices, so it should be
suitable for RAID arrays and such.  The targeted use case appears to be
automated backup systems; the snapshots that blksnap creates are described
as "non-persistent" and are meant to be discarded once a real backup has
been made.
<p>
Since blksnap works at the block level, it must be given space to store
snapshots that is separate from the devices being snapshotted.
Specifically, there are <tt>ioctl()</tt> operations to assign ranges of
sectors on a separate device for the storage of "difference
blocks" and to change those assignments over time.  There is a notification
mechanism whereby a user-space process can be told when a given
difference area is running low on space so that it can assign more blocks to
that area.
<p>
The algorithm used by blksnap is simple enough: once a snapshot has been
created for a set of block devices (using another <tt>ioctl()</tt>
operation), blksnap will intercept every 
block-write operation to those devices.  If a given block is being written
to for the first time after the snapshot was taken, the previous contents
of that
block will be copied to the difference area, and a note will be made that
the block has been changed since the snapshot was created.  Once that
is done, the write operation can continue normally.  The block devices thus
always reflect the most recent writes, while the difference area contains
the older data needed to recreate the state of those devices at the time
the snapshot was created.
<p>
In order to be able to intercept writes to the block devices, Shtepa has
had to add <a
href="/ml/linux-kernel/20221102155101.4550-2-sergei.shtepa@veeam.com/">a
new "device filter" mechanism</a> to the block layer.  A filter can be
attached to a specific device that will be called prior to the execution of
each operation on that device, with the BIO structure representing that
operation as a parameter.  If the filter function returns false, the
operation will not be executed.  An <a
href="/ml/linux-kernel/1655135593-1900-1-git-send-email-sergei.shtepa@veeam.com/">earlier
version of the patch set</a> provided the ability to attach multiple
filters to a block device at different "altitudes", but that was removed
since there are no other uses for filters currently.
<p>
Blksnap uses the filter function to catch writes to the snapshotted
device(s).  When a write is found, the operation is put on hold while the
original contents of the blocks to be written are copied to the difference
area; once that is complete, the write is submitted normally.
<p>
Interestingly, nothing in the patch set describes how one might gain access
to a snapshot once it has been created.  A look at <a
href="/ml/linux-kernel/20221102155101.4550-3-sergei.shtepa@veeam.com/">the
<tt>ioctl()</tt> interface</a> shows a couple of possibilities, though.
One is an operation to obtain the list of changed blocks associated with a
snapshot, which might be useful for certain types of incremental backups.
But blksnap also creates a new, read-only device for each snapshot taken.
Reading a block from that device causes blksnap to consult its map of
changed blocks; if the block in question has been changed, it is read from
the difference area.  Otherwise, it can be read from the original block
device.  The major and minor numbers of the snapshot devices can be obtained
with another <tt>ioctl()</tt> operation; there is also an undocumented
sysfs file that apparently can be consulted.
<p>
The kernel does not lack for the ability to make snapshots now, so one might
logically wonder why blksnap is needed.  It clearly differs from the
snapshot feature offered by filesystems like Btrfs, since blksnap operates
at the block-device level.  Among other things, blktrace can be used with
filesystems that do not, themselves, have a snapshot feature.  Btrfs
snapshots are stored on the same block device as the filesystem itself,
meaning that the two can compete for space, and the space used by snapshots
could prevent the writing of data to the live filesystem.  Since blksnap
stores its snapshot data on a separate device, that data won't get in the
way of ongoing operations.  If the difference area runs out of space the
snapshot will be corrupted, but the device being snapshotted will be
unaffected. 
<p>
An existing alternative at the block level is the <a
href="https://docs.kernel.org/next/admin-guide/device-mapper/snapshot.html">device
mapper snapshot target</a>.  The functionality provided by blksnap is, in
many ways, similar to the device mapper; both work by intercepting writes
and copying the old data to a separate device.  Blksnap can be used without
needing to set up the device mapper for the devices to be snapshotted,
though.  It also claims to have more flexible management of its difference
area, especially when multiple devices are being snapshotted together.
<p>
These differences appear to be interesting enough that nobody has, so far,
questioned whether blksnap is a useful addition to the kernel.  The patch
set (despite being marked "v1") is on its second revision, having seen a
number of fixes from its first posting in July.  With luck, the next
revision will incorporate some documentation; then perhaps it will be
nearing readiness for inclusion into the mainline.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer">Block layer</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/914031/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor914852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2022 17:46 UTC (Mon)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/914852/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; With luck, the next revision will incorporate some documentation</span><br>
<p>
It's way past time to throw "with luck" into the bin of not-so-ancient kernel history, and replace it with "write the freakin' docs or your patches won't go into the kernel. Period end of discussion".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2022 18:30 UTC (Mon)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/914858/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fortunately this is already the case for several subsystems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914865"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2022 22:41 UTC (Mon)
                               by <b>Fantu</b> (guest, #162182)
                              [<a href="/Articles/914865/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi, I don't see the initial message and I saw this messages from google search result.<br>
If blksnap patch serie have some lack (from the messages I see it seems like this) why don't reply and make it known to the developers? I don't see any answers at the moment that talk about a "big" lack of documentation<br>
<a rel="nofollow" href="https://lore.kernel.org/lkml/20221102155101.4550-1-sergei.shtepa@veeam.com/">https://lore.kernel.org/lkml/20221102155101.4550-1-sergei...</a><br>
that would be the v2 revision (seems to have written v1 by mistake)<br>
but also in v1 it doesn't seem to me that there have been messages that speak of major lacks of documentation that prevented a possible acceptance but specific things on which changes have been made in v2<br>
or maybe I'm wrong?<br>
<a rel="nofollow" href="https://lore.kernel.org/linux-block/1655135593-1900-1-git-send-email-sergei.shtepa@veeam.com/">https://lore.kernel.org/linux-block/1655135593-1900-1-git...</a><br>
<p>
thanks for any reply and sorry for my bad english<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914865/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor915000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 22:39 UTC (Tue)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915000/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi everyone.<br>
Unfortunately, this is the first time I hear that the disadvantage of the patch is a lack of documentation. I would be glad to see any feedback e-mail.<br>
Until the I/O init filtering mechanism itself is approved, it makes no sense to take time away from people who check the documentation.<br>
I have already written documentation on blk-interposer. I'm sorry that the efforts of the reviewers were scrapped.<br>
<p>
I have prepared the documentation on the filtering mechanism here <a href="https://github.com/veeam/blksnap/blob/master/doc/bdev_filter.md">https://github.com/veeam/blksnap/blob/master/doc/bdev_fil...</a> .<br>
I have described my thoughts about the blksnap module and its support from the user-space here <a href="https://github.com/veeam/blksnap/blob/master/doc/blksnap.md">https://github.com/veeam/blksnap/blob/master/doc/blksnap.md</a> .<br>
<p>
And I have a draft article for lwn. Maybe it's time to publish it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2022 16:26 UTC (Wed)
                               by <b>daneturner</b> (subscriber, #61385)
                              [<a href="/Articles/915128/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for this. Super helpful docs<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915297"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 18:07 UTC (Thu)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915297/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks. I'm afraid the description of the filter is somewhat outdated and corresponds to the previous version. It will need to be updated. <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915297/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor915173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 6:18 UTC (Thu)
                               by <b>davidbarton</b> (subscriber, #67985)
                              [<a href="/Articles/915173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd love to read the article @sshtepa<br>
<p>
Backup of block devices is a tough problem.  I'm interested in a use case for blksnap where the filter layer tracks changed blocks for a period, and then the snapshotting is done for a short window where the changes are backed up.<br>
<p>
snapshots / COW systems tend to have an overhead.  For my case we really only need to track which blocks have changed and then snapshot while synchronising to a backup (which might be COW on zfs or lvm).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor914884"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 6:03 UTC (Tue)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/914884/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn't feel right to have a second complex  system to redirect block i/o into.<br>
<p>
Why not build on the dm system? Instead of the new system,  we'd only need the ability to attach a dm device to an existing block device. And we'd need to allow a mounted block device as a dm target, which, I think, is currently prevented without the option to override.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914884/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 13:03 UTC (Tue)
                               by <b>Conan_Kudo</b> (subscriber, #103240)
                              [<a href="/Articles/914908/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <p>This is something that I've explored before when talking to the DM folks before and after <a href="https://github.com/datto/dattobd">dattobd</a> was written. The plain and simple truth is that they don't want to. The DM folks believe that the users should just redo their storage from scratch if they want the capabilities of DM and any other way is foolhardy at best. After a bunch of circular discussions, I gave up.</p>
<p>Sometimes I wonder if some of the Linux subsystem maintainers have actually worked in real-world situations before, because I get some pretty asinine suggestions sometimes...</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/914908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 15:41 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/914970/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If they've never worked outside of a computer department, if they've never lived in the end-user world, then they're like politicians - they know how things SHOULD be done, they've just never tried to do it, and they're surprised when the "should" is totally impractical or counter-productive.<br>
<p>
The mainframe culture writ large in the IT department ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor914964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 16:04 UTC (Tue)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/914964/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; dattobd</span><br>
<p>
Oh, wow, impressive  work.<br>
<p>
I can see, you'd rather have a more stable interface for you hooks than ftrace. <br>
<p>
 &gt; blk_qc_t (*dattobd_submit_bio_noacct_passthrough)(struct bio *) =<br>
 &gt; 	 (blk_qc_t(*)(struct bio *))((unsigned long)(submit_bio_noacct) +<br>
 &gt;        FENTRY_CALL_INSTR_BYTES);<br>
<p>
Another idea to avoid ftrace patch recursion, thanks :-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914977"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 16:22 UTC (Tue)
                               by <b>Conan_Kudo</b> (subscriber, #103240)
                              [<a href="/Articles/914977/">Link</a>] 
      </p>
      
      </div>
      </summary>
      There was a hot minute where I was aggressively trying to push for upstreaming dattobd into Linux (we even had the generic name for it picked out: "volsnap"), but the amount of negative feedback we got about it in 2017 killed that stone cold. It was pretty depressing...


      
          <div class="CommentReplyButton">
            <form action="/Articles/914977/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor915007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 23:51 UTC (Tue)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915007/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One problem is that it only works on Intel/AMD architecture.<br>
I haven't been able to do something similar for ARM or POWER yet.<br>
If you have any ideas how to fix it, let me know :).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2022 7:35 UTC (Wed)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/915018/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; If you have any ideas how to fix it, let me know :).</span><br>
<p>
This is not my idea, but one method is to accept and detect the recursion [1]. But the additional stack frame and overhead is something you possibly don't want to have in the submit_bio path.<br>
<p>
[1]: <a href="https://github.molgen.mpg.de/mariux64/fix-lpp/blob/e4c41a4b32c4266c61b929e1814591c2a96fcd47/fix-lpp/fix-lpp.c#L67">https://github.molgen.mpg.de/mariux64/fix-lpp/blob/e4c41a...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 16:30 UTC (Thu)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915283/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unfortunately, in order to be able to work on existing Linux kernels, I have to use such disgusting crutches.<br>
Offering a module to the upstream is a solution to this problem. And many other problems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor920245"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2023 18:39 UTC (Tue)
                               by <b>msnitzer</b> (subscriber, #57232)
                              [<a href="/Articles/920245/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As the DM subsystem maintainer I don't recall you ever directly or indirectly contacting me (famous last words).  But I've _never_ been opposed to devising a way to make all block devices capable of being remapped without first needing to have created the DM device at the dawn of time.<br>
<p>
The need for such a capability is quite niche... but I don't dispute that those who would like it exist (and might jump to false accusations about others :/ ).<br>
<p>
The coding of such an advance just hasn't been a priority _for me or my broader team within Red Hat_.  That doesn't mean "DM folks" reject the idea.  It means others need to do the work.  Implementing it in terms of yet another way to remap IO (blkfilter) speaks to inherent lack of understanding on how to make a general purpose advance that doesn't further splinter the block core's capabilities.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920245/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor915019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2022 8:04 UTC (Wed)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/915019/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My criticism was unjustified. The patch series contains a new general mechanism to hook into the i/o path of an existing block device and such a mechanism doesn't currently exist. blksnap would just be one potential user of it. And the article says so.<br>
<p>
But then I wonder if it would possible to add a filter module which redirects into a dm stack.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915293"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 17:33 UTC (Thu)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915293/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Technically, this is certainly possible. Moreover, I tried to make just such a blk-interposer for DM. I even had a working code (verified by the developer ;-).<br>
But interaction with Mike on this work turned out to be ... mmmmm, not effective. Сan be many reasons for this. Perhaps the DM team is busy with higher priority tasks. I think that in order to add a filter to the existing DM architecture we will have to redo quite a lot of code. This requires the will of the DM developers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915293/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920249"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2023 19:23 UTC (Tue)
                               by <b>msnitzer</b> (subscriber, #57232)
                              [<a href="/Articles/920249/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As I just stated elsewhere in this LWN thread.  I haven't had a need for this capability. The blkinterposer work seemed on its way. I guess you felt my lack of direct ownership personal. But iterating on things is how Linux is developed.<br>
<p>
Working around the removal of a key export that the veeam team was (ab)using to hijack IO for their commerical backup product by introducing yet another mechanism to remap IO is certainly one way to proceed -- but it sure isn't the most productive way to advance Linux's existing capabilities without splintering our collective efforts.<br>
<p>
I suppose I should've taken on working on something for some other company's benefit simply because I happen to work on and maintain DM?  Pretty specious logic there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920249/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor915004"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2022 23:43 UTC (Tue)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915004/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks Jonathan for the article.<br>
I am glad that someone is interested in my work.<br>
<p>
The blksnap module is an improved version of the veeamsnap module, which takes care of backups of thousands of servers around the world, and includes seven years of experience in the field of backup.<br>
<p>
Seven years ago, when I was analyzing alternative solutions, I saw that almost everyone who offers backup services at the enterprise level has their own implementation of a module for creating snapshots. And there are reasons for this. Obviously, the tools available in the kernel have their drawbacks. DM snapshots and Btrfs snapshots are a pain. I think they were not created for backup. I know this because we support their use.<br>
<p>
So, I had to create my "own bike". I won't bother you with listing the whole heap of problems associated with using the out-of-tree module. I want to stop this absurd.<br>
I am sure that the presence of the blksnap module in the upstream will please all vendors of backup tools and will improve the quality of service for Linux users.<br>
Backup tools will become easier and more reliable, and Linux system administrators will be happier.<br>
-<br>
Any feedback is welcome.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915004/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2022 1:32 UTC (Wed)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/915011/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Have the vendors of all of the out-of-tree modules taken a look at the new module?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915182"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 9:50 UTC (Thu)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915182/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's a good question.<br>
<p>
The blksnap module has been developed openly for more than a year. See <a href="https://github.com/veeam/blksnap/graphs/contributors">https://github.com/veeam/blksnap/graphs/contributors</a> . Prior to that, the veeamsnap module (the prototype of the blksnap module) has been publicly available since 2016 (<a href="https://github.com/veeam/veeamsnap/graphs/contributors">https://github.com/veeam/veeamsnap/graphs/contributors</a>). Of course, the developers of backup tools should have paid attention to what competitors are doing.<br>
<p>
I would really like the backup tool developers to be able to unite and at least express their opinion. But don't expect that.<br>
In my opinion, the problem is in the corporate culture of these organizations. Some try to present their module as a unique technology, use a proprietary license, and try to hide the source code. They are not ready for dialogue with the community. With the advent of the module as part of the kernel, games with proprietary modules will become of no interest to anyone, and everyone will use what is in the kernel.<br>
<p>
Functionally, the modules of other developers differ from each other slightly. The principles are about the same. Personally, I think that the blksnap module surpasses them in functionality. Of course, I will be glad to read the criticism of other developers about this.<br>
<p>
I tried very hard to create as simple code as possible that would be easy to read. Comparing the code of the veeamsnap and blksnap module, I see that I have achieved some success in this. And in order to facilitate the development of new code by other developers, tools, libraries and tests were created in C++ and bash. Anyone can collect packages (<a href="https://github.com/veeam/blksnap/tree/master/pkg/deb">https://github.com/veeam/blksnap/tree/master/pkg/deb</a>), run the tests and see how it works. In the future, I plan to offer the blksnap tool to Linux distributors. This will allow to create snapshots from the console. In this case, it will be possible to make consistent backups using simple scripts on "dd", "tar", "gzip" and "rsync", abandoning the backup tools.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915182/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915300"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 18:38 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/915300/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is this mostly relevant to VM backup tools or can something like `restic` also benefit from this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915300/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor915314"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2022 21:26 UTC (Thu)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/915314/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Backups of virtual machines on ESX and Hyper-V are better performed by other solutions that use "external" snapshots of virtual machines.<br>
This solution allows to create snapshots for physical machines and virtual machines in the cloud. Backup of virtual machines is of course also possible. Containers cannot be backed up.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/915314/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor915844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2022 18:42 UTC (Wed)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/915844/">Link</a>] 
      </p>
      
      </div>
      </summary>
      We use btrfs and ZFS, and the main reason we use them is their snapshotting abilities that we use for backups.  And I also use nilfs2 for the same reason (and because it is the only Linux file system that gives a sensible consistency guarantee, at least when I last looked).

<p>I don't know why you consider btrfs snapshots a pain.  What's a bit painful is that these three file systems have different interfaces for creating, destroying, and accessing snapshots, so the backup scripts have to be different for the different file system types.  But that's a one-time expense.

<p>What I am wondering about your backups of thousands of servers is how you achieve file system consistency.  If you snapshot the block device of a file system without cooperation from the file system, the snapshot may have an inconsistent state of the file system (as we all know from the O_PONIES discussion, some Linux file system developers don't want to make sure that the on-disk state is always consistent, and the only file system that gave better guarantees last I looked was nilfs2; and we don't need blksnap for nilfs2). Even if you make the block device snapshot right after a sync of the file system, a write between the sync and making the snapshot could have destroyed the consistency.  Do you have a way to sync, and to prevent writes until after you have created the snapshot?





      
          <div class="CommentReplyButton">
            <form action="/Articles/915844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor917121"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2022 16:43 UTC (Tue)
                               by <b>Fantu</b> (guest, #162182)
                              [<a href="/Articles/917121/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi, Sergei Shtepa prepared documentation files that will add to next patch for upstream:<br>
<a rel="nofollow" href="https://github.com/veeam/blksnap/blob/master/doc/blkfilter.rst">https://github.com/veeam/blksnap/blob/master/doc/blkfilte...</a><br>
<a rel="nofollow" href="https://github.com/veeam/blksnap/blob/master/doc/blksnap.rst">https://github.com/veeam/blksnap/blob/master/doc/blksnap.rst</a><br>
What do you think about them?<br>
I was sad to see numerous sites quoting this article and highlighting "The blksnap patches are rigorously undocumented...", although there was a documentation on github also before and it was written in the patch cover <a rel="nofollow" href="https://lore.kernel.org/lkml/20221102155101.4550-1-sergei.shtepa@veeam.com/">https://lore.kernel.org/lkml/20221102155101.4550-1-sergei...</a><br>
I hope this will be good enough and if it's not good enough there will be suggestions and contributions to improve it and I hope that there will no longer "missing documentation" as an impediment to the review of blksnap for upstream<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/917121/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor917123"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Documentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2022 17:09 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/917123/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      The available documentation does appear to be an improvement, in that it provides at least superficial coverage of the interface to blksnap — something that was completely absent before.


      
          <div class="CommentReplyButton">
            <form action="/Articles/917123/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor917482"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Documentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2022 22:36 UTC (Thu)
                               by <b>Fantu</b> (guest, #162182)
                              [<a href="/Articles/917482/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
thanks for reply, other additions, improvements and corrections have been made:<br>
<a rel="nofollow" href="https://github.com/SergeiShtepa/linux/blob/blksnap_lk6.1-rc8_v2/Documentation/block/blkfilter.rst">https://github.com/SergeiShtepa/linux/blob/blksnap_lk6.1-...</a><br>
<a rel="nofollow" href="https://github.com/SergeiShtepa/linux/blob/blksnap_lk6.1-rc8_v2/Documentation/block/blksnap.rst">https://github.com/SergeiShtepa/linux/blob/blksnap_lk6.1-...</a><br>
plus to many kernel-doc comments in code (visible from generated output)<br>
what do you think now?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/917482/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor917654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2022 10:46 UTC (Mon)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/917654/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi!<br>
<p>
Many thanks to everyone for the feedback, in the comments to the article.<br>
I tried to fix the shortcomings of my patch that you indicated and made a v2 version of the patch.<br>
See: <a href="https://lore.kernel.org/linux-block/20221209142331.26395-1-sergei.shtepa@veeam.com/">https://lore.kernel.org/linux-block/20221209142331.26395-...</a><br>
<p>
Thanks to Bagas Sanjaya, I already know about a number of shortcomings in the documentation.<br>
I still have a lot of work to do in order for my documentation writing skill to reach the required perfection.<br>
<p>
In the documentation, I tried to describe why the Linux kernel needs new mechanisms for creating snapshots.<br>
Believe me, the developers of backup tools absolutely do not want to create and maintain out-of-tree modules for Linux for snapshots.<br>
This is a significant cost, but it is the only way now to provide a sufficiently high quality of services for users.<br>
The module for snapshots of block devices in the kernel will allow to raise the level of service quality even higher for users of backup tools on Linux.<br>
<p>
In the meantime, I'm feeling sad because of the problems associated with out-of-tree modules.<br>
See: <a href="https://access.redhat.com/solutions/6985596">https://access.redhat.com/solutions/6985596</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/917654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor928417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2023 16:53 UTC (Wed)
                               by <b>sshtepa</b> (guest, #158959)
                              [<a href="/Articles/928417/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi.<br>
Little update about v3.<br>
<a href="https://lore.kernel.org/linux-block/20230404140835.25166-1-sergei.shtepa@veeam.com/">https://lore.kernel.org/linux-block/20230404140835.25166-...</a><br>
<a href="https://patchwork.kernel.org/project/linux-block/list/?series=737222">https://patchwork.kernel.org/project/linux-block/list/?se...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/928417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor952649"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2023 9:07 UTC (Sat)
                               by <b>Fantu</b> (guest, #162182)
                              [<a href="/Articles/952649/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another update, v6 was posted:<br>
<a rel="nofollow" href="https://lore.kernel.org/linux-block/14d5d31e-0dbe-8d04-91a6-82a886f8e92a@veeam.com/T/#t">https://lore.kernel.org/linux-block/14d5d31e-0dbe-8d04-91...</a><br>
<a rel="nofollow" href="https://patchwork.kernel.org/project/linux-block/list/?series=804089">https://patchwork.kernel.org/project/linux-block/list/?se...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/952649/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor962079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Block-device snapshots with blksnap</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2024 14:13 UTC (Wed)
                               by <b>Fantu</b> (guest, #162182)
                              [<a href="/Articles/962079/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another update, v7 was posted:<br>
<a rel="nofollow" href="https://lore.kernel.org/all/20240209160204.1471421-1-sergei.shtepa@linux.dev/">https://lore.kernel.org/all/20240209160204.1471421-1-serg...</a><br>
<a rel="nofollow" href="https://patchwork.kernel.org/project/linux-block/list/?series=824711&amp;archive=both">https://patchwork.kernel.org/project/linux-block/list/?se...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/962079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
