        <!DOCTYPE html>
        <html lang="en">
        <head><title>The shrinking role of ETXTBSY [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/866493/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/866757/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/866493/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The shrinking role of ETXTBSY</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 19, 2021</br>
           </div>
Unix-like systems abound with ways to confuse new users, many of which have
been present since long before Linux entered the scene.  One consistent
source of befuddlement is the "text file is busy" (<tt>ETXTBSY</tt>) error
message that is delivered in response to an attempt to overwrite an
executable image file.  Linux is far less likely to deliver
<tt>ETXTBSY</tt> results than it once was, but they do still happen on
occasion.  Recent work to simplify the mechanism behind <tt>ETXTBSY</tt>
has raised a more fundamental question: does this error check have any
value at all?

<p>
The "text" that is busy in this case refers to a program's executable code
— it's text that 
is read by the CPU rather than by humans.  When a program is run, its
executable text is mapped into the running process's address space.  When
this happens, Unix systems have traditionally prevented the file containing
that text from being modified; the alternative is to allow the code being
run to be changed arbitrarily, which rarely leads to happy outcomes.
For extra fun, the changed code will only be read if it is faulted into
RAM, meaning that said unhappy outcomes might not happen until hours (or
days) after the file has been overwritten.
Rather than repeatedly explain to users why their programs have crashed in
mysterious ways, Unix kernel developers chose many years ago to freeze the
underlying file while those programs run — leading to the need to explain
<tt>ETXTBSY</tt> errors instead.
<p>
Perhaps the easiest way to generate such an error is to try to rebuild a
program while some process is still running it.  Developers (those working
in compiled languages, anyway) tend to learn early on to respond to "text
file busy" errors by killing off the program they are debugging and
rerunning <tt>make</tt>.
<p>

<h4>How it works</h4>
<p>
Deep within the kernel, the <a
href="https://elixir.bootlin.com/linux/v5.13.10/source/include/linux/fs.h#L606"><tt>inode</tt>
structure</a> is used to represent files; one field within that structure
is an <tt>atomic_t</tt> called <tt>i_writecount</tt>.  Normally, this field
can be thought of as a count of the number of times that the file is held open
for writing.  If, however, <tt>i_writecount</tt> is <i>less</i> than zero, it is
interpreted instead as a count of the number of times that the writing of this
file is being blocked.  If 
the file is an executable file, then each process that runs it will
decrement <tt>i_writecount</tt> for the duration of that execution.  This
field thus functions as a sort of simple lock.  If its value is negative,
the file cannot be opened for write access; if, instead, its value is
positive, attempts to block write access will fail.  (Similarly, an attempt
to execute a file that is currently open for writing will fail with
<tt>ETXTBSY</tt>).
<p>
In current kernels, it is possible to attempt to block write access with a
call to <a
href="https://elixir.bootlin.com/linux/v5.13.10/source/include/linux/fs.h#L3072"><tt>deny_write_access()</tt></a>,
but the more common way is to create a memory mapping with the
<tt>VM_DENYWRITE</tt> flag set.  So, for example, the <a
href="https://man7.org/linux/man-pages/man2/execve.2.html"><tt>execve()</tt></a>
system call will map the code sections of the executable file into memory with
<tt>VM_DENYWRITE</tt>; that mapping causes <tt>i_writecount</tt> to be
decremented (this will fail if the file is open for writing, of course).
When the mapping goes away (the running program exits or 
calls <tt>execve()</tt>), <tt>i_writecount</tt> will be incremented again;
if it reaches zero, the file will once again become writable.
<p>
Back in the early days of Linux, prior to the Git era, the <a
href="https://man7.org/linux/man-pages/man2/mmap.2.html"><tt>mmap()</tt></a>
system call supported a flag called <tt>MAP_DENYWRITE</tt> that would cause
<tt>VM_DENYWRITE</tt> to be set within the kernel and thus block write
access to the mapped 
file for the duration of the mapping.  There was a problem with this
option, though: any process that could open a file for read access could
map it with <tt>MAP_DENYWRITE</tt> and prevent any other process on the
system from writing that file.  That is, at best, an invitation to
denial-of-service attacks, so it was removed long ago.  Calls to
<tt>mmap()</tt> with that flag set will succeed, but the flag is simply
ignored.
<p>
<h4>Shared libraries</h4>
<p>
The removal of <tt>MAP_DENYWRITE</tt> had an interesting, if obscure, side
effect.  One may think of a file, such as <tt>/usr/bin/cat</tt>, as
containing an executable program.  In truth, though, much of the code that
will be executed when somebody runs <tt>cat</tt> is not found in that file;
instead, it is in a vast number of shared libraries.  Those files contain
executable code just like the nominal executable file, so one would think
that they, too, would be protected from writing while in use.
<p>
Once upon a time, that was indeed the case; the ancient <a
href="https://man7.org/linux/man-pages/man2/uselib.2.html"><tt>uselib()</tt></a>
system call will map libraries with writing blocked.  It may well be,
though, that there are no systems still using <tt>uselib()</tt>; instead,
on current systems, shared libraries are mapped from user space with
<tt>mmap()</tt>.  The <tt>MAP_DENYWRITE</tt> flag was created for just this
use case, so that shared libraries could not be written while in use.  When
<tt>MAP_DENYWRITE</tt> went away, so did that protection; current Linux
systems will happily allow a suitably privileged user to overwrite in-use,
shared libraries.
<p>
The end result of this history is that the memory-management subsystem has
a bunch of leftover code, in the form of the support for
<tt>MAP_DENYWRITE</tt> and <tt>VM_DENYWRITE</tt>, that no 
longer has any real purpose.  So David Hildenbrand <a
href="/ml/linux-kernel/20210812084348.6521-1-david@redhat.com/">decided to
take it out</a>.  With this patch set installed, <tt>execve()</tt> will
simply call <tt>deny_write_access()</tt> directly, and <tt>mmap()</tt> no
longer has to consider that case at all.  This results in a user-space API
change: <tt>uselib()</tt> no longer blocks write access to shared
libraries.  Nobody expects anybody to notice.
<p>
<h4>An idea whose time has passed?</h4>
<p>
In response to Hildenbrand's patch set, GNU C library developer Florian
Weimer <a 
href="/ml/linux-kernel/87r1eyg8h6.fsf@oldenburg.str.redhat.com/">pointed
out</a> that the library has "<q>a persistent issue with people using cp
(or similar tools) to replace system libraries</q>".  He did not say
that library developers have long since tired of explaining to those users
why their applications crashed in mysterious ways, but there was no need
to.  It would be nice, he said, to provide a way to prevent this sort of
error or, at least, a way to deterministically tell that a crash was caused
by an overwritten library.  There are a number of ways that could be
established without bringing back <tt>MAP_DENYWRITE</tt>, he said.
<p>
The discussion wandered into other ways to protect shared libraries from
being overwritten while in use; Eric Biederman <a
href="/ml/linux-kernel/87o8a2d0wf.fsf@disp2133/">suggested</a> installing
them with the immutable bit set, for example.  But Linus Torvalds <a
href="/ml/linux-kernel/CAHk-=wgru1UAm3kAKSOdnbewPXQMOxYkq9PnAsRadAC6pXCCMQ@mail.gmail.com/">made
it clear</a> that he thought the problem was elsewhere:
<p>
<blockquote class="bq">
	The kernel ETXTBUSY thing is purely a courtesy feature, and as
	people have noticed it only really works for the main executable
	because of various reasons. It's not something user space should
	even rely on, it's more of a "ok, you're doing something incredibly
	stupid, and we'll help you avoid shooting yourself in the foot when
	we notice".
</blockquote>
<p>
After Torvalds repeated that point a couple of times, Andy Lutomirski <a
href="/ml/linux-kernel/b629cda1-becd-4725-b16c-13208ff478d3@www.fastmail.com/">suggested</a>
just removing the write-blocking mechanism altogether:
<p>
<blockquote class="bq">
	It’s at best erratic — it only applies for static binaries, and it
	has never once saved me from a problem I care about. If the program
	I’m recompiling crashes, I don’t care — it’s probably already part
	way through dying from an unrelated fatal signal.  What actually
	happens is that I see -ETXTBUSY, think “wait, this isn’t Windows,
	why are there file sharing rules,” then think “wait, Linux has
	*one* half baked file sharing rule,” and go on with my life.
</blockquote>
<p>
Torvalds <a
href="/ml/linux-kernel/CAHk-=wiJ0u33h2CXAO4b271Diik=z4jRt64=Gt6YV2jV4ef27g@mail.gmail.com/">was
amenable to the idea</a>, though he worried that some application somewhere
might depend on the <tt>ETXTBSY</tt> behavior.  But he noted that it has been
steadily weakened over time, and nobody has complained so far.  Removing it
could be tried, he <a
href="/ml/linux-kernel/CAHk-=wgi2+OSk2_uYwhL56NGzN8t2To8hm+c0BdBEbuBuzhg6g@mail.gmail.com/">continued</a>:
"<q>Worst comes to worst, we'll have to put it back, but at least we'd
know what crazy thing still wants it</q>".
<p>
Al Viro <a
href="/ml/linux-kernel/YRcjCwfHvUZhcKf3@zeniv-ca.linux.org.uk/">worried</a>,
though, that some installation scripts might depend on this behavior;
Christian Brauner <a
href="/ml/linux-kernel/20210814075333.7333bxduk4tei57i@wittgenstein/">added</a>
that allowing busy executable files to be written could make some security
exploits easier.  Hildenbrand <a
href="/ml/linux-kernel/f65e3462-a5aa-0c77-494b-916eb832ebe1@redhat.com/">said</a>
that his patch set already makes the write-blocking behavior much simpler,
and that he would be in favor of leaving it in place for now.  The <a
href="/ml/linux-kernel/20210816194840.42769-1-david@redhat.com/">second
version of the patch set</a>, posted on August&nbsp;16, retains the
<tt>ETXTBSY</tt> behavior for the main executable file.
<p>
Hildenbrand's simplification work seems sure to land during the 5.15 merge
window; whether <tt>ETXTBSY</tt> will disappear entirely is rather less certain.
Getting rid of it strikes some developers as a nice cleanup, but there is
nothing forcing that removal to happen at this time.  Meanwhile, the
potential for user-space regressions always exists when behavior is changed
in this way.  The safe approach is thus to leave <tt>ETXTBSY</tt> in place for now.
<p>
[<b>Postscript</b>: Lutomirski pointed to mandatory locks as the one other
place in the kernel that implements unwelcome file-sharing rules.  That
feature is indeed unpopular; the <a
href="https://www.kernel.org/doc/html/latest/filesystems/mandatory-locking.html">kernel
document on mandatory locks</a> starts with a section on why they should
not be used.  In 2015, <a href="/Articles/667210/">a configuration
option</a> was added to make mandatory locks optional, and some
distributors have duly disabled them.  One potential outcome of the
<tt>ETXTBSY</tt> discussion looks likely to be <a
href="/ml/linux-kernel/87k0kkxbjn.fsf_-_@disp2133/">an effort</a> to get
other distributors 
to do the same until it becomes clear that mandatory locks can safely be
removed.  Stay tuned.]<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-mmap">System calls/mmap()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/866493/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor866789"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 15:49 UTC (Thu)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/866789/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can we make cp actually DTRT (create a new file, atomically rename) instead of overwriting the file? :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866789/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866790"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 16:05 UTC (Thu)
                               by <b>chris_se</b> (subscriber, #99706)
                              [<a href="/Articles/866790/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem with that is that you might have write permissions on the file, but not necessarily the containing directory.<br>
<p>
It would be great if the kernel had an open flag that could be combined with O_TRUNC that atomically replaces the file (assuming you would be able to open it without that flag), but keeps the old file&#x27;s permissions / creation date / etc. -- and if the old file was still open it would be treated as if the old file had been deleted. (Similar in effect to how the create new file + atomic rename would work.) cp could then use that flag, same thing with compilers/linkers, which would also avoid the issues described in the article. And on platforms / older kernels that don&#x27;t provide the flag the same tools could behave the same as before, as if the flag hadn&#x27;t been set.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866790/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866813"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 18:40 UTC (Thu)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/866813/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And without the flag the kernel should return ETXTBSY as before. This way tools can be gradually updated with a new option to support this flag that can be even default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866813/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867743"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">File version numbers à la OpenVMS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2021 23:55 UTC (Sun)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/867743/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
File version numbers, as found in OpenVMS (and a bunch of other DEC family operating systems before it) would be a cool solution to this. If an inode can contain multiple data versions, overwriting an in-use executable could create a new data version for the inode. Existing file descriptors would point to the old data version but newly opened file descriptors would point to the new one. The old data version could be automatically deleted when its last open file descriptor closed.<br>
<p>
More generally, one could use this to enable what I&#x27;ve heard some people call &quot;unit files&quot;. (I don&#x27;t know if that is standard terminology at all, I heard it from some commenter on HN.) Basically, a unit file acts atomically – when you open it, you get a read snapshot of the file at the time you opened it. When you write to it, your changes aren&#x27;t visible to other readers until you close the file (or call some kind of &quot;commit&quot; system call). (This would likely imply only one process can have the file open for writing at a time). Many apps would really benefit from these kind of transactional semantics, right now they have to use something like SQLite to get them, but with unit files they could get those semantics directly from the OS.<br>
<p>
Of course, I doubt Linux is going to any such features. It is complicated, probably wouldn&#x27;t be used that much, doesn&#x27;t fit well with POSIX, could not be supported by existing filesystems without substantial changes (although a few do have some existing COW support, and they might be able to leverage that to implement this feature with only modest effort). But one can daydream about a parallel universe in which UNIX never really took off, and we are all using some open-source clone of VMS. In some ways no doubt an uglier universe, but in other ways a prettier one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867743/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">File version numbers à la OpenVMS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2021 13:20 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/867848/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Many apps would really benefit from these kind of transactional semantics, right now they have to use something like SQLite to get them, but with unit files they could get those semantics directly from the OS.</font><br>
<p>
Again harping on Pr1mos, and I don&#x27;t know how easy it would be to retrofit to Linux, but files had reader/writer access controls. I don&#x27;t know whether it was set by the first application to open it, or more likely set in the file system, but you had a choice of &quot;multiple readers (or one writer)&quot;, &quot;multiple readers and one writer&quot;, and &quot;multiple readers and multiple writers&quot;.<br>
<p>
So, as it implies, the first person to open the file got it, any other attempts were checked against this lock and the open succeeded or failed depending. When I wrote an accounts package, everything was configured NR&amp;1W, all files were opened read-only unless actually updating the data, and all files were opened in a defined order to prevent deadlocks. (Still didn&#x27;t prevent one user changing the data underneath another, but the program made sure this didn&#x27;t matter...)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor990500"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">File version numbers à la OpenVMS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2024 17:38 UTC (Mon)
                               by <b>jch</b> (guest, #51929)
                              [<a href="/Articles/990500/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Again harping on Pr1mos, and I don't know how easy it would be to retrofit to Linux, but files had reader/writer access controls. I don't know whether it was set by the first application to open it, or more likely set in the file system, but you had a choice of "multiple readers (or one writer)", "multiple readers and one writer", and "multiple readers and multiple writers".</span><br>
<p>
Aren't those just mandatory file locks taken at open time?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/990500/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor990506"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">File version numbers à la OpenVMS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2024 19:12 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/990506/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Reading that again, I'm not sure if I made myself clear, but these were file system attributes. So you had "NR-1W" (either readers OR writer), "NR&amp;1W" (as many readers as you liked, only one writer), and "NR&amp;NW" (as many readers and writers as you liked).<br>
<p>
So my accounts system had "NR&amp;1W" set on all files, and only ever opened a file to write when it was doing a commit. There was also always an explicit open hierarchy (as in I only ever opened individual clients after opening the client summary, so I couldn't get a deadlock, same for other ledgers).<br>
<p>
So it relied on programming discipline, but could be proven to work if the rules were followed.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/990506/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor866832"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 22:21 UTC (Thu)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/866832/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; and if the old file was still open it would be treated as if the old file had been deleted</font><br>
<p>
I would think that this would require assigning a new inode number to keep the content separate. Even in your description you refer to &quot;old file&quot; and &quot;new file&quot;, not &quot;old content&quot; and &quot;new content&quot;. If you change the inode number, however, then you need to update the directory entry, which involves writing to the directory, so we&#x27;re back to the original permission issue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866832/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 23:15 UTC (Thu)
                               by <b>SLi</b> (subscriber, #53131)
                              [<a href="/Articles/866837/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would it cause problems if such an operation by a user with write permission to the file but not the directory could patch the new node number to the directory entry?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 5:57 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/866850/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Updating the directory entry would be a user-visible change since getdents(2), readdir(3), and stat(2) all report the inode number; more importantly it could result in breaking hardlinks (as the atomic rename approach would) which is something that normally requires write access to the containing directory. Beyond that I&#x27;m not sure how much trouble would result from allowing just the inode number to be updated in an otherwise read-only directory entry… it&#x27;s not something that&#x27;s seen much testing.<br>
<p>
Atomically swapping the *content* of two files (one of which could be temporary/unlinked) could be a useful operation for some cases which currently rely on atomic rename, and wouldn&#x27;t have any issue with read-only directories, but it wouldn&#x27;t help in this particular situation since any existing open file descriptions or mapped memory would immediately see the new content just as if the file had been modified with ftruncate(2) and write(2).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 17:47 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/866935/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, but you could extend the atomic swap to *also* swap the file descriptor of A to point to B instead.<br>
<p>
This will cause all kinds of interesting race conditions unless handled carefully … but it could work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867023"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2021 8:35 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/867023/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Truncating a file already causes all kinds of interesting race conditions. But they&#x27;re in userspace, so we all collectively pretend that they&#x27;re not a problem.<br>
<p>
(Because, well, what&#x27;s the alternative? Any global mutable state will inevitably race, at some level of abstraction, and global mutable state is literally the whole point of a filesystem.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867023/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor866853"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 6:42 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/866853/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, the operation would break hard links. Not having write permissions for the directory implies not being able to break hard links.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866853/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866862"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 10:55 UTC (Fri)
                               by <b>runekock</b> (subscriber, #50229)
                              [<a href="/Articles/866862/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would it be possible to assign the new inode number to the old contents instead?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866862/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor867267"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2021 19:21 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/867267/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m imagining a hypothetical O_REPLACE flag here, which gives the opening process a filehandle that shadows the existing file, and its effects won&#x27;t become visible to the outside world until the opener explicitly invokes fsync() or close(). Similar atomicity semantics to the tempfile-write-sync-rename pattern, but without the tempfile juggling and the extra problems that causes.<br>
<p>
Admittedly it doesn&#x27;t sound all that easy to implement something like this, even to a kernel layperson.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867267/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 16:37 UTC (Thu)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/866793/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You might not have enough space on the device for that, and checking whether or not that&#x27;s the case beforehand is impossible to do reliably (what about file holes: are there any, does the FS support them; or simply that other processes might write to the same FS at the same time).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 16:41 UTC (Thu)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/866796/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, but that also goes when overwriting the file.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 17:38 UTC (Thu)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/866803/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I should have been clearer on what I mean. Of course I&#x27;m not talking about new_file being bigger than (old_file + free_before_copying). That wouldn&#x27;t fit either way.<br>
<p>
I&#x27;m talking about new_file being smaller than (old_file + free_before_copying) but being larger than free_before_copying. If you copy-to-temporary with atomic-rename you&#x27;ll run out of space whereas directly opening the target file for writing will work.<br>
<p>
Take this dummy 1MB file system with one 800KB file occupying it, trying to overwrite the 800KB file with a 400KB file:<br>
<p>
[0 root@sweet-chili /home/mosu/tmp/mp] df .<br>
Filesystem     1K-blocks  Used Available Use% Mounted on<br>
/dev/loop0           996   797       128  87% /home/mosu/tmp/mp<br>
[0 root@sweet-chili /home/mosu/tmp/mp] ls -l<br>
total 796<br>
-rw-r--r-- 1 root root 800000 2021-08-19 19:30 800KB<br>
[0 root@sweet-chili /home/mosu/tmp/mp] ls -l ../*KB<br>
-rw-r--r-- 1 root root 400000 2021-08-19 19:30 ../400KB<br>
-rw-r--r-- 1 root root 800000 2021-08-19 19:30 ../800KB<br>
[0 root@sweet-chili /home/mosu/tmp/mp] cp ../400KB .<br>
cp: error writing &#x27;./400KB&#x27;: No space left on device<br>
[1 root@sweet-chili /home/mosu/tmp/mp] rm 400KB<br>
[0 root@sweet-chili /home/mosu/tmp/mp] cp ../400KB 800KB<br>
[0 root@sweet-chili /home/mosu/tmp/mp] ls -l<br>
total 404<br>
-rw-r--r-- 1 root root 400000 2021-08-19 19:33 800KB<br>
[0 root@sweet-chili /home/mosu/tmp/mp]<br>
<p>
rsync does the copy-to-temporary with atomic-rename, but it has always done so &amp; is therefore fine. Of course it does have options to deal with low-space file systems the user can turn on, notably &quot;--delete-before&quot;.<br>
<p>
For cp it would be a huge change in semantics.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866936"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 17:49 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/866936/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can tell rsync to do the writing in place, though. This vastly speeds up some sync jobs, particularly databases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866936/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866940"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 18:19 UTC (Fri)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/866940/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yep, rsync wasn&#x27;t the best additional example here, in fact efficient in-place updates is what rsync is most known for.<br>
<p>
My main point was that such a change would change cp&#x27;s semantics. I shouldn&#x27;t have brought rsync up.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866940/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor866984"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2021 7:15 UTC (Sat)
                               by <b>Homer512</b> (subscriber, #85295)
                              [<a href="/Articles/866984/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unfortunately, that would break existing setups that rely on the default being overwriting and expect the new content to show up in the old file descriptor.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866984/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor867796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2021 16:03 UTC (Mon)
                               by <b>nivedita76</b> (guest, #121790)
                              [<a href="/Articles/867796/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does any installer use cp, though? They should already be doing the right thing, no?<br>
<p>
What’s the use case for doing cp overwriting an existing executable or shared library?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866792"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 16:34 UTC (Thu)
                               by <b>david.a.wheeler</b> (subscriber, #72896)
                              [<a href="/Articles/866792/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is an interesting discussion on trade-offs.<br>
<p>
Clearly there&#x27;s value in making the implementation code simpler (easier to maintain, more likely to be correct, etc.).<br>
<p>
However, while it may be &quot;purely a courtesy feature&quot;, courtesy is nice. Humans make an incredible number of mistakes; detecting &amp; countering some ongoing footguns *can* be helpful, even if the detection only works in some cases. Especially since it&#x27;s been that way &quot;from the beginning&quot;; applications might depends on it. It&#x27;s not a security mechanism, so it doesn&#x27;t need to counter &quot;all cases&quot; to be useful. I think this is best left in. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866792/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867013"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2021 23:28 UTC (Sat)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/867013/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I think this is best left in. </font><br>
<p>
I tend to agree.  Further, I think it would be good to make it even more useful. <br>
Currently only executables benefit from ETXTBSY.  What if we added an O_DENYWRITE open flag.<br>
Then shared-library loaders could set this, as could script interpreters.<br>
<p>
With a bit of work, we could make O_DENYWRITE | O_RDWR work so that the opener can write but nothing else can. <br>
This would be great for swap files.<br>
<p>
Obviously O_DENYWRITE would require write-permission to the file, thus avoiding the DOS problems of MAY_DENYWRITE.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867013/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2021 21:53 UTC (Sun)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/867051/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Obviously O_DENYWRITE would require write-permission to the file, </font><br>
<p>
and obviously that would make it useless for shared-library loaders and script interpreters.<br>
<p>
So I&#x27;ve completely changed my mind.  Only permissions should be effective at preventing a process from writing to a file.  A correctly written program should choose not to write to a file that is in-use.<br>
This would require a way to find out if a file is in use.  If there are needs in this area, that is the direction that we should innovate.<br>
<p>
Maybe shared-library loaders and script interpreters should take a LOCK_SH flock on the file, and &#x27;cp&#x27; should replace-instead-of-overwrite if it cannot get a LOCK_EX flock.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 0:40 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/867063/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No. A thousand times no.<br>
<p>
I do not want my tools doing two completely different things depending on some entirely unrelated state. A given cp invocation should always overwrite, or it should always replace. It must not inspect the phase of the moon to decide which code path to use. That&#x27;s just an outage waiting to happen. If you want it to support both use cases, add a flag and require the user to be explicit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867065"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 1:03 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/867065/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I do not want my tools doing two completely different things depending on some entirely unrelated state.</font><br>
<p>
And yet .... they already do.<br>
<p>
&quot;mv&quot; will prefer the rename() systemcall, but if that returns EXDEV, it will fall back to copy-and-remove-original.<br>
<p>
But maybe EXDEV not as &quot;unrelated&quot; as a flock?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867065/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867068"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 1:26 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/867068/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And so, very annoyingly, does cp.<br>
<p>
If the target is a pre-existing directory, it copies into it. If the target is a pre-existing file it overwrites it. And if the target doesn&#x27;t exist, it makes a copy called the target.<br>
<p>
In other words, if you are copying directories in a script, you need a whole bunch of wrapper code if you want the results to be reproducible.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867068/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867074"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 5:01 UTC (Mon)
                               by <b>mchapman</b> (subscriber, #66589)
                              [<a href="/Articles/867074/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p><font class="QuotedText">In other words, if you are copying directories in a script, you need a whole bunch of wrapper code if you want the results to be reproducible.</font></p>

<p>
You can use <code>cp -R source/. dest/</code>, which will do the right thing whether or not <code>dest</code> is an existing directory.
</p>

<p>
With GNU <code>cp</code>, you can also do <code>cp -R --no-target-directory source/ dest/</code>.
</p>




      
          <div class="CommentReplyButton">
            <form action="/Articles/867074/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor867154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 15:40 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/867154/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; And yet .... they already do.</font><br>
<p>
I find it baffling that you seem to tacitly assume the existing design is perfect. It&#x27;s obviously not. The -T flag, for example, only needs to exist because cp and mv &quot;helpfully&quot; default to interpreting the last argument as -t if it is possible to do so. If you had to explicitly pass -t, then -T would not need to exist, and a whole class of bugs would have been eliminated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867184"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 22:19 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/867184/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I find it baffling that you seem to tacitly assume the existing design is perfect. </font><br>
<p>
I did not mean to imply that, and am sorry that it came across that way.<br>
What I was trying to highlight was that your stated desire about behaviour of tools was already thwarted by reality.  The desire came across as a bit naive.<br>
<p>
I certainly see the attraction of having simple tools with simple semantics - &quot;Do one thing and do it well&quot;.  However I know from experience that such tools are usually *too* simple.  Different people have different opinions about what the &quot;one thing&quot; should be, and about what it means to do it &quot;well&quot;.<br>
<p>
There is, and should be, a tension between adding functionality and maintaining simplicity.  Both have value and there is no perfect balance.  Rather we iteratively find a dynamic balance through robust &quot;conversation&quot; (which involves sharing both opinions and code).<br>
<p>
I didn&#x27;t imagine my proposal about how &#x27;cp&#x27; could handle locking would be the final word on the subject, just another contribution to an ongoing conversation.  Thanks for adding to the conversation!<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867184/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor867252"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2021 16:23 UTC (Tue)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/867252/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then the kernel should do it instead. Mapping an executable or library file should be a copy-on-write operation. When the underlying file is replaced the kernel should use the old pages for the existing mappings and the new pages for new mappings.<br>
<p>
Of course, that&#x27;s probably impossible in current Linux.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867252/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor868994"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 12, 2021 18:45 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/868994/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Currently only executables benefit from ETXTBSY. What if we added an O_DENYWRITE open flag.</font><br>
<p>
What if we arranged for ETXTBSY to be emitted by default for files which have pages mapped executable in some process&#x27;s address space? (The flag would obviously be flipped by the first mmap(MAP_EXEC) of that file, and flipped off by munmap). This is, obviously, a change in semantics, but surely not even jitters rely on writing to executable file-backed pages (differing cache coherency semantics make this operation intrinsically nonportable in any case).<br>
<p>
This prevents the &quot;easy DoS&quot; of open-with-a-flag-to-deny-overwriting -- the only DoS vector now available is the one we already have, &quot;execute something and nobody else can overwrite it while you&#x27;re executing from it&quot;, which seems entirely, y&#x27;know, desirable.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/868994/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor867026"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting discussion on ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2021 8:42 UTC (Sun)
                               by <b>niner</b> (subscriber, #26151)
                              [<a href="/Articles/867026/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For what it&#x27;s worth, that &quot;courtesy&quot; has not helped me even once in 25 years. On the contrary, I regularily run into it when debugging and it has me hunting through my open terminal windows looking for that gdb session that&#x27;s still running. Like many other cases where the computer thinks it&#x27;s smarter than me, I could do very well without this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867026/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 16:44 UTC (Thu)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/866794/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How do the major package managers (deb/rpm) update (executable-) files?<br>
<p>
I would have expected them to use some kind of atomic-rename to avoid in-between states. As far as I understand it, this would avoid ETXTBSY (and also be crash-safe).<br>
<p>
And what about install (1)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866829"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 20:56 UTC (Thu)
                               by <b>andyc</b> (subscriber, #1130)
                              [<a href="/Articles/866829/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With rpm at least, you will generally use the install(1) command.<br>
<p>
install(1) by default will do an unlink(2) then a copy. Thus the old executables inode remains in place until the program exits.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866829/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 0:41 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/866841/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
During the `%install` step, sure. But I can&#x27;t imagine `librpm` is forking off thousands of `install(1)` processes during *package* installation rather than going through some more direct syscall dance route.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866839"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 23:50 UTC (Thu)
                               by <b>smcv</b> (subscriber, #53363)
                              [<a href="/Articles/866839/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
dpkg writes all the new content to new files (foo.dpkg-new, I think), then does an atomic-overwrite via rename. I would expect any package manager that modifies the system in-place to have to do the same.<br>
<p>
I think dpkg actually goes further than that, by hard-linking all the old content to a backup name (foo.dpkg-old), then renaming all the new files so foo.dpkg-new replaces foo, and finally deleting all the foo.dpkg-old - so that if it gets an error halfway through unpacking a package, it can use all the foo.dpkg-old files to roll back to the old version in a consistent state.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866839/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 6:04 UTC (Fri)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/866852/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cool, thanks to all of you. Now I understand where dpkg-{new,old} come from. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor866856"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 8:04 UTC (Fri)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/866856/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even more, it also writes the information to a journal (redo log) of its own, which is fsync()-ed to disk, so if there&#x27;s a power loss, it can roll forward on next run. This is one of several reasons why dpkg unpacking takes longer than just unpacking a tarball. (It is my opinion that there are needlessly many fsync-s in this process and that it can be improved upon, but that&#x27;s a different story.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866856/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 17:52 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/866937/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;eatmydata dpkg …&quot; / &quot;eatmydata apt …&quot; to the rescue.<br>
<p>
Yes this means that a power failure / kernel crash halfway through your update is likely to kill your system, but when that is sufficiently unlikely …<br>
<p>
NB: WARNING: do not use this command for anything that triggers a reboot. Ever.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866990"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2021 11:51 UTC (Sat)
                               by <b>Jonno</b> (subscriber, #49613)
                              [<a href="/Articles/866990/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; &quot;eatmydata dpkg …&quot; / &quot;eatmydata apt …&quot; to the rescue.</font><br>
<p>
Or you could use `dpkg --force-unsafe-io ...` / `apt --option DPkg::options::=--force-unsafe-io ...`.<br>
<p>
That will only remove the fsync before renaming file X.dpkg-new to X, which gives you about 99% of the speed boost from eatmydata, without risking the apt and dpkg databases and logs.<br>
<p>
(Meaning that if something does break you can inspect the logs and simply reinstall any packages that was unpacked since your last system-wide sync to fix your installation. If the broken package is essential it might be a bit tricky to do, but you can always boot from a different boot media, such as the Debian installer CD, and run `dpkg --instdir=/mnt/target ...` to get going again).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866990/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor990427"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2024 9:15 UTC (Mon)
                               by <b>MarcB</b> (subscriber, #101804)
                              [<a href="/Articles/990427/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Reboot should be fine, the kernel will flush all buffers before unmount. It is only crashes or power losses that would be a problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/990427/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor867510"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unix atomic actions, or how to replace an executable or library</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 26, 2021 16:00 UTC (Thu)
                               by <b>davecb</b> (subscriber, #1574)
                              [<a href="/Articles/867510/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unix was designed with a minimum number of ways to do anything, and a pair of &#x27;atomics&#x27;.  From as far back as v6,<br>
* open had the O_CREAT flag, which would atomically create a file, or fail if it existed<br>
* mv atomically replaced the inode under a filename, allowing new openers of the file to get the new version, and everyone with an open copy to continue using the old one.<br>
<p>
If you think the latter sounds like the read-copy-update Linux uses inside the kernel, you&#x27;d be right: it comes from the same seminal papers.<br>
<p>
The latter is the canonical way to update a file or library: I used it heavily on Unix and Solaris (I was part of the shared library team), update apparently uses it and I considered it one of the really impressive things about Unix-derived systems. And it fits in nicely as part of the &quot;everything is a file&quot; metaphor.<br>
<p>
--dave<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867510/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867511"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unix atomic actions, or how to replace an executable or library</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 26, 2021 16:05 UTC (Thu)
                               by <b>davecb</b> (subscriber, #1574)
                              [<a href="/Articles/867511/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just out of curiosity, does the Linux run-time linker decrement the i_writecount in the library inode? Solaris did...<br>
<p>
If so, that suggests that Linux could have the same &quot;you&#x27;re about to mess up one of your processes&quot; warning if someone inadvertently attempted to use cp or rsync to update an in-use library, just like an in-use program.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867511/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor868995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unix atomic actions, or how to replace an executable or library</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 12, 2021 18:51 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/868995/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Just out of curiosity, does the Linux run-time linker decrement the i_writecount in the library inode? Solaris did...</font><br>
<p>
No. I&#x27;m fairly sure there is no way to do so: there was, but that was MAP_DENYWRITE, which, well, see this article... glibc is still careful to mmap its libraries with MAP_DENYWRITE, which the kernel then ignores :(<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/868995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor866810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 18:32 UTC (Thu)
                               by <b>evgeny</b> (subscriber, #774)
                              [<a href="/Articles/866810/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Developers (those working in compiled languages, anyway) tend to learn early on to respond to &quot;text file busy&quot; errors by killing off the program they are debugging and rerunning make.</font><br>
<p>
Weird. I&#x27;ve never encountered such an error, though certainly many times recompiled a program while it was running - either directly or under gdb. I feel like living in a parallel universe...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866816"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 18:51 UTC (Thu)
                               by <b>Tomasu</b> (guest, #39889)
                              [<a href="/Articles/866816/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve seen it but not much lately. Maybe newer linkers do the move and replace trick these days? So you&#x27;d be most likely to see it if your build steps include a manual cp of the executable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866816/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 19:10 UTC (Thu)
                               by <b>evgeny</b> (subscriber, #774)
                              [<a href="/Articles/866820/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, I see. Interesting, so indeed the linker (or is it make itself?) is smart to first remove the old file...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866836"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 23:13 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/866836/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Make doesn&#x27;t know anything about removing or copying files. It only knows how to:<br>
<p>
0. Parse a Makefile and do file-level* dependency resolution based on the contents.<br>
1. Check the modification times of the input and output files, and identify what needs to be rebuilt.<br>
2. Run the commands you tell it to run in order to rebuild something.<br>
<p>
All other aspects of the build process are the responsibility of the specific commands you tell Make to run. Technically, you don&#x27;t even need to use it to compile software, if you have some other process that can automatically transform input files into output files in a similar fashion to compilation.<br>
<p>
* i.e. it has no integration with package managers etc., and instead it just knows things like &quot;file X.o &#x27;depends on&#x27; file X.c, because you told me that *.o files are made from *.c files of the same name.&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866836/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866851"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 6:26 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/866851/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Make doesn&#x27;t know anything about removing or copying files.</font><br>
<p>
That isn&#x27;t strictly true, at least with respect to GNU make. There are a number of built-in patterns. For example, in a directory containing only a source file &quot;test.c&quot; (and no makefile) if you run &quot;make &#x27;libtest.a(test.o)&#x27;&quot; the GNU make will invoke the following commands automatically:<br>
<p>
  cc    -c -o test.o test.c<br>
  ar rv libtest.a test.o<br>
  rm test.o<br>
<p>
So without being told it knows at least how to compile .c files into .o files, add .o files to a static library, and remove the temporary .o files afterward. There is also at least one built-in implicit rule (%.out: %) which involves copying files: if you run &quot;make test.c.out&quot; it will invoke &quot;cp test.c test.c.out&quot;. And if you have a file &quot;script.sh&quot; and run &quot;make script&quot; it will copy &quot;script.sh&quot; to &quot;script&quot;—using cat(1) and redirection rather than cp(1)—and then mark the resulting file as executable.<br>
<p>
Besides the built-in rules, GNU make also removes any intermediate files generated when multiple implicit rules are chained to build a target: &lt;<a href="https://www.gnu.org/software/make/manual/html_node/Chained-Rules.html">https://www.gnu.org/software/make/manual/html_node/Chaine...</a>&gt;.<br>
<p>
You can list all the built-in rules available on your system with &quot;make -f /dev/null -p&quot;. There is also a partial list in the manual: &lt;<a href="https://www.gnu.org/software/make/manual/html_node/Catalogue-of-Rules.html">https://www.gnu.org/software/make/manual/html_node/Catalo...</a>&gt;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866851/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867064"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 1:02 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/867064/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OK, I suppose I was a bit vague, so let me be more precise:<br>
<p>
Make doesn&#x27;t have any code which directly calls rename(2), unlink(2), etc. for the purposes of executing a recipe.* Recipes are (effectively) very small shell scripts, and it is rm(1) or cp(1) (or in the case of open(2) for a redirection, the shell) which actually makes those syscalls on make&#x27;s behalf. Make doesn&#x27;t &quot;know&quot; anything about how to copy a file, it just &quot;knows&quot; to run cp(1) and check the exit code.<br>
<p>
* I have not looked, but I suppose it is theoretically possible that there is some code path where make creates a temporary file or something like that. That&#x27;s not what I&#x27;m talking about here. I&#x27;m talking about the files that the user cares about, i.e. the ones that actually appear on the command line or in a recipe, whether explicit or implicit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867064/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor867116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 14:11 UTC (Mon)
                               by <b>skitt</b> (subscriber, #5367)
                              [<a href="/Articles/867116/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This isn’t specific to GNU Make, it’s been a feature of Make ever since Stuart Feldman’s first version (see <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.39.7058">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.3...</a>) and is part of POSIX (<a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/make.html">http://pubs.opengroup.org/onlinepubs/9699919799/utilities...</a>).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor866817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 19:03 UTC (Thu)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/866817/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, if you build on one machine and test on another (which you should do - the code working on the development machine isn&#x27;t good testing procedure), you&#x27;ll see this when you &quot;scp&quot; to the test machine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866822"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 19:28 UTC (Thu)
                               by <b>evgeny</b> (subscriber, #774)
                              [<a href="/Articles/866822/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I do frequently test on a different machine. But the catch is I use a shared NFS partition, which eliminates the need to (s)cp and hence I&#x27;ve never seen this error.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866822/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor867696"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2021 18:38 UTC (Sat)
                               by <b>gnu_lorien</b> (subscriber, #44036)
                              [<a href="/Articles/867696/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;I feel like living in a parallel universe...&quot;<br>
<p>
I had the same feeling when reading this article.<br>
<p>
I had an experience in a university class around 2006 where the professor claimed that you couldn&#x27;t overwrite in-use files. I used Gentoo at the time and had never needed to shut down anything to recompile and update my system. The professor insisted this could happen but I couldn&#x27;t find any scenario from the userspace tools I had available where I couldn&#x27;t update in-use files.<br>
<p>
I&#x27;ve also worked at companies that do cross-platform work for at least 15 years. It&#x27;s a regular occurrence that things break for the Windows toolchain that don&#x27;t break for GNU/Linux toolchain because Linux toolchains will happily update in-use binaries. It&#x27;s one of the things I consider a huge misfeature of Windows that you have to go hunting down whoever is locking a file in order to finish a build. From a user perspective I would be shocked and annoyed if I started seeing ETXTBSY show up. I say good riddance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867696/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867822"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2021 21:20 UTC (Mon)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/867822/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, the Windows way to do things is the right one. You shouldn&#x27;t be able to mess up a running program by mucking with its binary from underneath. On Windows, you can *move* the old file out of the way and then create a new file, which is what you should be doing on a Unix system too. Windows just enforces good hygiene.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867822/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867834"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2021 4:33 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/867834/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can rewrite the running file on Windows. You can&#x27;t truncate or delete it, though.<br>
<p>
This has more to do with the way the memory mapping is managed on Windows than with anything else.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867834/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor867847"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2021 12:59 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/867847/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Pr1mos added the ability to rename an open file.<br>
<p>
Dunno exactly how it worked, but it was something like the - if the linker hit an open file - it knew the magic sauce to rename it to move it out the way, then write a new one.<br>
<p>
Same idea as *nix&#x27;s ability to delete an open file then put a new one in its place - anything which has the old file open will continue to use that until it closes it.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867847/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor866819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 19:07 UTC (Thu)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/866819/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With all the security paranoia of late, I&#x27;d expected that everyone would be clamoring to have the shared libraries locked while they are being executed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866825"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 20:15 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/866825/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Programs that can write to a shared library can generally already do worse (or just replace it with one that will compromise new runs of setuid programs), whereas programs that are securely (or just robustly) written and intend to update shared libraries replace the inode.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866825/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 19:22 UTC (Thu)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/866823/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What&#x27;s truly fun here is that none of this applies to interpreters; in particular, because e.g. `bash` actually interprets the file as it&#x27;s reading it, if you do &quot;truncate and overwrite in place&quot; as e.g. `cp` does, you can get *totally arbitrary* behavior: <a href="https://thomask.sdf.org/blog/2019/11/09/take-care-editing-bash-scripts.html">https://thomask.sdf.org/blog/2019/11/09/take-care-editing...</a><br>
<p>
I tried hard to argue for O_OBJECT a while ago: <a href="https://marc.info/?l=linux-fsdevel&amp;m=139963046823575&amp;w=2">https://marc.info/?l=linux-fsdevel&amp;m=139963046823575&amp;...</a>  I still think it makes sense.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor866828"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 20:47 UTC (Thu)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/866828/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; For extra fun, the changed code will only be read if it is faulted into RAM, meaning that said unhappy outcomes might not happen until hours (or days) after the file has been overwritten.</font><br>
<p>
Well, hmm, no?<br>
<p>
Assuming we&#x27;re on a local filesystem (ie not NFSv3 or something), the write() goes directly into the page cache. Even if the application has used MAP_PRIVATE, that covers how to handle a store from the mmapper, not a write() from somebody else.<br>
<p>
So the code does change under you. Now, I don&#x27;t think we necessarily flush the CPU instruction cache at that point, so you might continue to execute some old instructions for a while, but at some point the CPU is going to notice that the i$ is out of date.<br>
<p>
Unless you O_TRUNC, of course. Then, umm ... we get rid of all those pages immediately and your program segfaults straight away.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866828/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 19, 2021 23:20 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/866838/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Unless you O_TRUNC, of course. Then, umm ... we get rid of all those pages immediately and your program segfaults straight away.</font><br>
<p>
You mean to tell me that I can instantly segfault an entire system by just running sudo truncate libc.so?<br>
<p>
I mean, I&#x27;m not that surprised, there are loads of ways a malicious or stupid root can break the system. I&#x27;m just impressed by the &quot;segfault every userspace process at the same time&quot; angle.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 0:33 UTC (Fri)
                               by <b>Karellen</b> (subscriber, #67644)
                              [<a href="/Articles/866840/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>Well, you can instantly kill every userspace process <em>and</em> panic the kernel at the same time on a system with <tt>sudo kill -9 -1 1</tt></p>

<p>* Probably. I have not just tried this.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/866840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 12:17 UTC (Mon)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/867089/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
You can't <tt>kill -9 1</tt>; the init process is protected from signals for which it doesn't have an explicitly installed signal handler.
</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/867089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor866858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 8:32 UTC (Fri)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/866858/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Technically statically compiled programs and those written in languages that do not use libc (e.g. Go) would not be affected.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor867052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2021 22:02 UTC (Sun)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/867052/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you’re missing a step here.<br>
<p>
So, the interpreter doesn’t read in a copy or anything?  Unless it’s mmaping it’s going to have a copy of at least part of the file.  That’s how read() works.<br>
<p>
User space doesn’t work from the page cache unless it’s mmaping.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2021 22:49 UTC (Sun)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/867055/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Run `cat /proc/self/maps`.<br>
<p>
My system shows the &#x27;cat&#x27; binary mapped five times. One is executable.<br>
<p>
But thanks for explaining to me how the read() system call and the page cache works.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor867081"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 9:06 UTC (Mon)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/867081/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
Even if the application has used MAP_PRIVATE, that covers how to handle a store from the mmapper, not a write() from somebody else.
</blockquote>

That's disturbing.  Still, if a MAP_PRIVATE page is written to (e.g., with its original content) in one place, it is copied on that write, and later changes to the original don't affect it.

<p>So that is what could be done on writing to an executed text file: in every affected process, make private copies of the pages of the whole original text (as if on copy-on-write) and populate the mapping with them.  There is an opportunity for sharing between several processes that run the same changed binary, but I guess that the benefit is too small and too rare to make that effort.  OTOH, the benefit of not having ETXTBSY and not having processes crash when their binary changes is more substantial IMO.

<p>Actually, I would like that also for interpreters (a have had a number of shell scripts crash when I edited them while they were running), maybe by making  MAP_PRIVATE|MAP_POPULATE behave that way, or with an additional flag to mmap().


      
          <div class="CommentReplyButton">
            <form action="/Articles/867081/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 20:18 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/867175/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What would be the benefit of doing that with mmap(MAP_PRIVATE|MAP_POPULATE) vs. just reading the entire file into the process&#x27;s anonymous private memory? Of course even if you do that the file could change while you&#x27;re reading it, so it would reduce the window where the data could be corrupted but not eliminate it altogether.<br>
<p>
For that matter, any process that could rewrite or truncate a file while it&#x27;s in use could also corrupt the data beforehand. ETXTBUSY only protects against *accidentally* corrupting a file by updating it while it&#x27;s in use, by forcing the update to fail. However, since we don&#x27;t want the update to fail anyway, the solution which doesn&#x27;t risk data corruption *or* an ETXTBUSY error is to write the new data to a temporary file and rename it over the original. This does require write access to the parent directory, but that doesn&#x27;t seem unreasonable to me since logically you are modifying the directory to point to a new file. Any attempt to atomically update the content without replacing the file will run into the issue that mapping follow the file, not the content.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867180"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 21:28 UTC (Mon)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/867180/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
What would be the benefit of doing that with mmap(MAP_PRIVATE|MAP_POPULATE) vs. just reading the entire file into the process's anonymous private memory?
</blockquote>

Zero-copy unless someone tries to write to the file.  The way I imagine it, the write would block until the copying is completed, so this race condition would not exist.

<p>The approach to write new file and rename over the old one would a good one, but despite the inconvenience of ETXTBSY linkers don't use this approach, so maybe the problem with the unwritable directories is more relevant than we think.



      
          <div class="CommentReplyButton">
            <form action="/Articles/867180/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor866859"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 9:31 UTC (Fri)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/866859/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Instead of blocking writes, just before the first write is detected, could Linux load a snapshot of the entire file into RAM and adjust the process structures to use the RAM instead of the file on disk?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866859/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 14:08 UTC (Fri)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/866907/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
An executable main program or one shared library can exceed the total size of RAM plus swap space (thus tmpfs).  This occurs frequently on &quot;default&quot; VMs that have only 2GB of RAM and no swap space.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor866957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2021 23:39 UTC (Fri)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/866957/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess during normal use only a fraction of the executable/libraries are loaded into RAM, but it surprises me that a single program could have more than 2GB of storage backing it, most of the graphical ones on my system don&#x27;t seem to be more than 500MB according to:<br>
<p>
du -L -c $(ldd `which foo` | sed &#x27;s/.*=&gt;//;s/ (.*//&#x27; | grep -v linux-vdso.so.1)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor866959"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2021 0:02 UTC (Sat)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/866959/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps instead of loading into RAM, Linux could just do the atomic rename dance behind the back of the process.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866959/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2021 18:14 UTC (Sat)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/867007/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This seems like a much saner thing to do and I&#x27;m surprised nobody figured it out in the 80&#x27;s.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867015"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2021 2:00 UTC (Sun)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/867015/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Based on some of the discussion early in this thread, it sounds like doing that would be very complicated or impossible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867015/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor867079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 8:47 UTC (Mon)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/867079/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      On my Debian system, all binaries in /usr/bin combined have a total text size of 285MB (as reported by size -t) and all libraries in /usr/lib combined have a text size of 295MB, so keeping the whole text of a few binaries or libraries is unlikely to lead to problems that the system would not soon have otherwise.  Assuming that you have the ETXTBSY problem on such default VMs at all (what are you using these VMs for where you get ETXTBSY?), I still think that most users prefer the remote change to run out of memory to a certain ETXTBSY or, as seems to be in the works, a crash from having the binary changed during execution.


      
          <div class="CommentReplyButton">
            <form action="/Articles/867079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867087"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2021 11:06 UTC (Mon)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/867087/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; On my Debian system, all binaries in /usr/bin combined have a total text size of 285MB (as reported by size -t) and all libraries in /usr/lib combined have a text size of 295MB, so keeping the whole text of a few binaries or libraries is unlikely to lead to problems that the system would not soon have otherwise.</font><br>
<p>
Sometimes people run code that isn&#x27;t shipped with Debian. Back in 2012, Facebook&#x27;s page requests were handled by a single 1.5GB executable, generated from PHP code transpiled to C++. (<a href="https://arstechnica.com/information-technology/2012/04/exclusive-a-behind-the-scenes-look-at-facebook-release-engineering/">https://arstechnica.com/information-technology/2012/04/ex...</a>). I think they switched to a PHP JIT shortly after that, but I imagine other people had (or still have) even larger executables for similar reasons.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/867087/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor867248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2021 15:48 UTC (Tue)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/867248/">Link</a>] 
      </p>
      
      </div>
      </summary>
      So someone who uses such a binary, runs it in a 2GB VM, and tries to overwrite this binary gets an out-of-memory condition in a VM rather than ETXTBSY or a crashing binary.  So even this unlikely scenario is not really worse off, and in more usual scenarios things just work as intended.


      
          <div class="CommentReplyButton">
            <form action="/Articles/867248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor866985"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The shrinking role of ETXTBSY</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2021 7:21 UTC (Sat)
                               by <b>Homer512</b> (subscriber, #85295)
                              [<a href="/Articles/866985/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess a copy-on-write filesystem could support a version of memory-mapping that keeps the old content around while it is mapped, even if it&#x27;s not yet in the page-cache. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/866985/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
