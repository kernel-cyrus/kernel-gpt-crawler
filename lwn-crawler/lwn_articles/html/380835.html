        <!DOCTYPE html>
        <html lang="en">
        <head><title>Evolutionary development of a semantic patch using Coccinelle [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/380835/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/380201/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/380835/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Evolutionary development of a semantic patch using Coccinelle</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="GAByline">
           <p>March 30, 2010</p>
           <p>This article was contributed by Wolfram Sang</p>
           </div>
<p> Creating patches is usually handwork; fixing one specific issue at a time.
Once in a while though, there is janitorial work to be done or some
infrastructure to change. Then, a larger number of issues have to be taken care
of simultaneously, yet all of them are following the same basic pattern, e.g. a
replacement. Such tasks are often addressed at the source-code level using scripts
in sed, perl, and the like. This article examines the usage of <a href="http://coccinelle.lip6.fr/">Coccinelle</a>, a
tool targeted at exactly those kinds of repetitive patching jobs.
Because Coccinelle understands C syntax, though, it can handle those jobs
much more easily.
</p>

<p>
The major drawback of using scripts for code transformation is that they use non-trivial
regular expressions in order to match previously unknown names, parse
structures, and so forth. 
To simplify such tasks, "semantic patches"&mdash;patches that describe the
<i>kinds</i> of changes to be made, rather than the specific line and
difference that come in normal patches&mdash;have been
introduced along with Coccinelle to process them. Coccinelle
translates the source files to an abstract representation, making it easier
to deal with 
C expressions, isomorphisms, code paths and so on. For an introduction,
refer to Valerie Aurora's <a href="http://lwn.net/Articles/315686/">LWN article</a> or the
Coccinelle web site. This article will provide a step-by-step description
how a semantic patch came into existence once a certain problem was identified.
<p>
Learning Coccinelle is still a bit challenging as
information is scattered and, like with all languages, just listing the
abilities is not even half of the story. Studying other semantic patches
(in addition to asking on the mailing list) worked best for me, so in return this
article describes the creation of a semantic patch from scratch. I would
like to thank Julia Lawall for her immediate responses to my questions and
bug reports.
</p>

<h4>The problem</h4>

<p>An issue was pointed out while developing an I2C driver for hardware
monitoring: the driver serving an I2C slave device
(called client) uses <tt>i2c_set_clientdata()</tt> to store a pointer to its private
data structure, usually somewhere in the probe function. In the remove function,
the driver was then supposed to clear the pointer to the data structure before
freeing it, because clients are not really removed but are just unbound from the
driver. To prevent a dangling pointer in the still existing client, a typical
fix looks like:
</p>

<pre>
    +   i2c_set_clientdata(client, NULL);
        /* clientdata pointed to data before */
        kfree(data);
</pre>

<p> As this dangling pointer looks quite easy to miss, checking all drivers is
a job perfectly suited for Coccinelle. The goal is a patch series fixing
this flaw in I2C drivers all over the kernel tree. While the <a
href="http://thread.gmane.org/gmane.linux.drivers.i2c/5674">patch series</a>
Coccinelle successfully created will probably not be merged directly, it helped in finding
<a href="http://thread.gmane.org/gmane.linux.drivers.i2c/5674/focus=5729">a more
generic solution</a>. It was agreed that the i2c-core should
clear the pointer to the private data structure as there is no guarantee for
such pointers after the remove. A follow-up patch series will likely be based on
the semantic patch presented below. In any case, the creation process will be
useful for similar tasks in the future. </p>

<p>
The task can be further divided into two sub-problems:
</p>

<ol>
<li> Find relevant <tt>kfree()</tt> calls, which have the private data structure as an argument
<li> Check if clientdata is <tt>NULL</tt> already
</ol>

<p>
If the latter is not the case, a fix is needed. For the following examples,
Coccinelle 0.2.2 and a 2.6.34-rc1 kernel were used. Older kernels can also
be used
to get the idea, of course.
</p>

<h4>Find relevant kfree() calls</h4>

<p>
A typical remove() routine for an I2C driver looks like this
(from <tt><a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=blob;f=drivers/rtc/rtc-pcf8563.c;h=65f346b2fbaebfcf73b58759e6622d6e9ababefd;hb=57d54889cd00db2752994b389ba714138652e60c">drivers/rtc/rtc-pcf8563.c</a></tt>):
</p>

<pre>
    static int pcf8563_remove(struct i2c_client *client)
    {
        struct pcf8563 *pcf8563 = i2c_get_clientdata(client);

        if (pcf8563-&gt;rtc)
            rtc_device_unregister(pcf8563-&gt;rtc);

        kfree(pcf8563);

        return 0;
    }
</pre>

<p>
The pointer to the data structure of interest was obtained using
<tt>i2c_get_clientdata()</tt>. When the structure itself gets freed, then a
check for the call setting clientdata to <tt>NULL</tt> is needed. So this
combination of <tt>i2c_get_clientdata()</tt> and <tt>kfree()</tt> is of
interest, keeping in mind that the name of the pointer and its type can be
anything. As Coccinelle parses the C source on an abstract level, this is
easily possible using a few so-called metavariables in the header of our
matching rule. Those can then carry the actual naming as used in the source
file. Always remember that Coccinelle works on an abstract level. It is quite
easy to forget as most of us are used to standard patches on source-code level.
A first attempt of our semantic patch having one rule may look like this:
</p>

<pre>
    @@
    // This is the rule header; metavariables must be declared here
    type T;
    identifier client, data;
    @@
        // The matching rule itself:
        // Catch the clientdata
        T data = i2c_get_clientdata(client);

        // then anything in between is allowed
        ...

        // prepend the fix if kfree() is found
    +	i2c_set_clientdata(client, NULL);
        kfree(data);
</pre>

<p>
For the pcf8563 example above, this patch matches. That means, after the first
line of the rule, the metavariable <tt>T</tt> will carry the type <tt>struct pcf8563 *</tt>,
<tt>data</tt> will carry the identifier <tt>pcf8563</tt> and <tt>client</tt> will carry the identifier
<tt>client</tt>. Later use of these metavariables will, of course, be accordingly
replaced. So, <tt>kfree(data)</tt> will in fact look for <tt>kfree(pcf8563)</tt>. As this is also
found, the match is complete and the line containing the fix will be added.
</p>

<p>
But the patch did not find all relevant places. The
<tt>probe()</tt> function also has a dangling pointer in the error path. It
wasn't matched as it uses <tt>i2c_set_clientdata()</tt> instead of
<tt>i2c_get_clientdata()</tt>. So there should be an alternation in the
semantic patch handling both cases. And to make it short, a third variant is
necessary because other drivers use <tt>i2c_get_clientdata()</tt>
without declaring the type on the same line. It is usually a good idea to do a
little bit of grepping first to get an idea in what ways functions are called.
Here is the patch including all alternations marked by "<tt>(</tt>", "<tt>|</tt>", and "<tt>)</tt>" in the
first column:
</p>

<pre>
    @@
    type T;
    identifier client, data;
    @@
    // Check if function uses clientdata
    (
        i2c_set_clientdata(client, data);
    |
        data = i2c_get_clientdata(client);
    |
        T data = i2c_get_clientdata(client);
    )
        // anything in between is allowed
        ...
    +	i2c_set_clientdata(client, NULL);
        kfree(data);
</pre>

<p>
Surprisingly, there is still no fixup for the <tt>probe()</tt> function. Why is
that? The "..." operator in Coccinelle matches if and only if it matches for
all code paths taken. This is to ensure consistency of the modifications. It
usually makes a lot of sense, however, this case is an exception. As it is
written now, the lower block of the patch says "anything in between is allowed,
but then a <tt>kfree(data)</tt> must follow on all paths". Of course, the
<tt>probe()</tt> routine does not free the structure if all went well because
the driver is going to use it. So, the above rule will not match on this path
and thus will fail entirely. What is needed here is a "may exist or may not
exist" operator. This is, similar to regular expressions, "?". After changing
the <tt>kfree()</tt> line to the following
</p>

<pre>
    ? 	kfree(data);
</pre>

<p>
the meaning of the lower block changes to "anything in between is allowed and
<tt>kfree(data)</tt> <i>may</i> occur later". That implies that, if it occurs, the fix
connected to <tt>kfree(data)</tt> will be applied as well, so finally there is
the second match.
</p>


<h4>Check if clientdata is freed already</h4>

<p>
When applying this semantic patch to the whole <tt>rtc</tt> subdirectory, there
are a number of fixes, but also false positives, i.e. the pointer has correctly
been cleared already by the driver, which is now done twice. To fix this, an
alternation can be used again. Like in many languages, an alternation is
short-cut if one condition is already met. So the replacing part can be done
like this:
</p>

<pre>
    (
        // If this pattern is found, clientdata is set to NULL before data is freed.
        // Do nothing and skip the rest of the alternation
        i2c_set_clientdata(client, NULL);
        ...
        kfree(data);
    |
        // Otherwise apply a fix if kfree() has been found in some code path
        // (doesn't need to be in all paths).
    +	i2c_set_clientdata(client, NULL);
    ? 	kfree(data);
    )
</pre>

<p>
If the first block is met, the driver does the right thing. There still is a
match, but no output is produced because no lines are added or removed. If this
is not the case, the fix is applied (if needed). While being here, a few drivers
clear the pointer after they free the structure. The other way around would be
cleaner, so the following snippet is the third alternation:
</p>

<pre>
    +	i2c_set_clientdata(client, NULL);
        kfree(data);
        ...
    -	i2c_set_clientdata(client, NULL);
</pre>

<p>
The final version of the semantic
patch is hopefully less frightening:
</p>

<pre>
    @@
    type T;
    identifier client, data;
    @@

    // Check if function uses clientdata
    (
        i2c_set_clientdata(client, data);
    |
        data = i2c_get_clientdata(client);
    |
        T data = i2c_get_clientdata(client);
    )
        // Anything in between is OK
        ...
    (
        // If this pattern is found, clientdata is set to NULL before data is freed.
        // Do nothing and skip the rest of the alternation
        i2c_set_clientdata(client, NULL);
        ...
        kfree(data);
    |
        // If this pattern is found, clientdata is set to NULL after data is freed.
        // Move it to the front and skip the rest of the alternation
    +	i2c_set_clientdata(client, NULL);
        kfree(data);
        ...
    -	i2c_set_clientdata(client, NULL);
    |
        // Otherwise apply a fix if kfree() has been found in some code path
        // (doesn't need to be in all paths).
    +	i2c_set_clientdata(client, NULL);
    ? 	kfree(data);
    )
</pre>

<p>
This matched 96 drivers in 23 directories, changing 213 lines. Note that one
really should review those patches afterward. There might be issues which lead
to further improvement of the semantic patch. Or there are problematic
parts in the source code, but they need to be handled manually. For
example, in this
patch series, there was once a <tt>kfree()</tt> missing, so a memory leak was
discovered. Also check the Coccinelle output for anomalies. In this case,
there are some exceptions regarding "inconsistent control-flow paths". That
means, the source code was modified in such a way that  code paths outside our
match would also be affected. An example is a simple error path in a probe function
(excerpt from <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=blob;f=drivers/gpio/pcf857x.c;h=29f19ce3e80f192b071277a69bf1da9b67b8627f;hb=57d54889cd00db2752994b389ba714138652e60c">drivers/gpio/pcf857x.c</a>):
</p>

<pre>
        gpio = kzalloc(sizeof *gpio, GFP_KERNEL);
        if (!gpio)
            return -ENOMEM;

        ... /* set 'status' according to initialization */

        if (status &lt; 0)
            goto fail;  /* clientdata not used yet! */

        ...

        i2c_set_clientdata(client, gpio);

        ...

        status = gpiochip_add(&amp;gpio-&gt;chip);
        if (status &lt; 0)
            goto fail;  /* clientdata was modified */

        ...

    fail:
        dev_dbg(...)
        /* 'i2c_set_clientdata(client, NULL)' placed here would be executed for all jumps to 'fail'! */
        kfree(gpio);
        return status;
</pre>

<p>
As seen, a jump to <tt>fail</tt> can happen after or before clientdata was set to the
private data structure. The latter case is outside the scope of the above
semantic patch and would still modify its code path. In this example, the
change is harmless as clientdata is still <tt>NULL</tt> and will be set to <tt>NULL</tt> again,
but Coccinelle cannot know and outputs a warning. It is possible to enforce
inconsistent changes using the command-line option <tt>-allow_inconsistent_paths</tt>,
but it is marked as dangerous in the help text for a reason. Either
triple-check the outcome or just handle the exceptions manually.
</p>

<h4>Conclusion</h4>

<p>
The article is meant to incrementally describe the creation of a semantic patch
using Coccinelle. While the result is working and the patch series was submitted,
be aware that the semantic patch here is primarily meant for educational
purposes; more
advanced features available in Coccinelle have been left out.
</p>

<p>
One has to get used to a slightly different way of thinking regarding
patches along with learning 
some new syntax when getting started with Coccinelle. The intention of this article
was to demonstrate that it is no major task, though. Once the basic
stuff is familiar, semantic patches are easier to understand than scripts with loads of regular
expressions. Coccinelle has also been around for some time now and produced a number
of useful patch series (available via kernel-janitors), so it is not in
alpha stage anymore.
In the future, being able to read semantic patches will become increasingly
important. Larger tasks, like API changes, might start being
<a href="http://thread.gmane.org/gmane.linux.kernel/957411/focus=957657">done in an automatic fashion</a>.
Coccinelle is a handy tool, and trying it out is likely to pay off.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_tools-Coccinelle">Development tools/Coccinelle</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Sang_Wolfram">Sang, Wolfram</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/380835/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor381127"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 20:38 UTC (Tue)
                               by <b>Frej</b> (guest, #4165)
                              [<a href="/Articles/381127/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is also spdiff. A tool that generates semantic patches based previous on changes. Useful if <br>
library api changes or some internal kernel api does. Also as noted in the article, just helpful for <br>
finding better solutions.<br>
<p>
Spdiff was presented here at diku (www.diku.dk) at a phd. defence i went to a few weeks ago. <br>
Spdiff was stated as quite hard to use though (even for cochinelle folks), but it's also very young <br>
so improvements are likely possible ;). <br>
<p>
<a href="http://www.diku.dk/hjemmesider/ansatte/jespera/">http://www.diku.dk/hjemmesider/ansatte/jespera/</a><br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381127/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381147"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 21:51 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/381147/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This reminds me of something I would really like to have - a semantic 'grep'.<br>
<p>
e.g. 'find all times the field 'next' of structure 'struct foo' is used'<br>
<p>
You cannot do this with a regexp as lots of structures have a 'next' and<br>
lots of variables are of type 'struct foo'.<br>
<p>
I usually rename 'next' to 'nextX' and recompile, but there must be a faster way.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381147/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381156"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 22:28 UTC (Tue)
                               by <b>ccshan</b> (guest, #2723)
                              [<a href="/Articles/381156/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Coccinelle does it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381156/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381157"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 22:29 UTC (Tue)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/381157/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      You could look at <a href="http://scottmcpeak.com/elkhound/sources/elsa">Elsa</a>, written 
by Scott McPeak. It is a C/C++ parser, one of its sample applications is a <a 
href="http://scottmcpeak.com/elkhound/sources/elsa/semgrep.cc">semantic grep</a>. 
<p>
Have fun. ;-)
      
          <div class="CommentReplyButton">
            <form action="/Articles/381157/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381161"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 22:44 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/381161/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ooooh, thanks for that. Not only does Elsa look nice, but Elkhound looks <br>
like a seriously nice-looking parser generator.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381161/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381354"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2010 0:21 UTC (Thu)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/381354/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>
Looks dead to me. No updates for 5 years, the site "it moved to" doesn't have the announced SVN repos, ...
      
          <div class="CommentReplyButton">
            <form action="/Articles/381354/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381388"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2010 7:25 UTC (Thu)
                               by <b>ajb</b> (guest, #9694)
                              [<a href="/Articles/381388/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mozilla are maintaining a fork of it: <a href="https://wiki.mozilla.org/Pork">https://wiki.mozilla.org/Pork</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381388/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381383"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2010 7:42 UTC (Thu)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/381383/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The original Elsa page shows quite nicely and concisely how to implement a semantic grep. It is now used (and lives on) as a frontend for <a href="http://www.cubewano.org/oink/">Oink</a>, which has a Git repository <a href="http://github.com/dsw/oink-stack">here</a>. It is also used by <a href="https://developer.mozilla.org/En/Pork">Pork</a>, an Oink fork used by the Mozilla project. Both of these toolchains do static source code analysis and code rewriting.
      
          <div class="CommentReplyButton">
            <form action="/Articles/381383/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor381189"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 4:06 UTC (Wed)
                               by <b>wsa</b> (guest, #52415)
                              [<a href="/Articles/381189/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Grepping is possible, too. You can use '*' in the first column to just display a match. So, a general approach would be:

<pre>
@@
// This metavariable has a defined type
struct foo *var;
@@
*   var->next
</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381189/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381198"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 5:18 UTC (Wed)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/381198/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Thanks... that is quite close to what I wanted.
<p>
I really wanted to know if "(struct device_driver *)->groups" was ever set and the following pattern doesn't find any.  It wouldn't find a static initialisation though..
<p>
<pre>

struct device_driver *var;
@@
* var->groups

</pre>

A similar search for struct device->groups does find a few hits.

      
          <div class="CommentReplyButton">
            <form action="/Articles/381198/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381210"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 7:50 UTC (Wed)
                               by <b>wsa</b> (guest, #52415)
                              [<a href="/Articles/381210/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Unleashing another feature (regexp), you could do this for static ones:

<pre>
@@
// Match identifiers starting with "device" for "device_type", "device_driver"...
identifier S ~= "device.*";
identifier name;
expression E;
@@
        static struct S name = {
*               .groups = E,
        };
</pre>

which matched just a few device_types here.
      
          <div class="CommentReplyButton">
            <form action="/Articles/381210/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381239"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 12:34 UTC (Wed)
                               by <b>lawall</b> (guest, #56234)
                              [<a href="/Articles/381239/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The following semantic patch:<br>
<p>
@r@<br>
struct device_driver var;<br>
expression E;<br>
@@<br>
* var.groups = E;<br>
<p>
Expands into essentially the following, via a user-configurable notion of "isomorphisms", which describe code patterns that are considered to be the same:<br>
<p>
@@<br>
struct device_driver var;<br>
struct device_driver *_E1_1;<br>
identifier _I_0;<br>
@@<br>
<p>
(<br>
*var.groups = E;<br>
|<br>
*_E1_1-&gt;groups = E;<br>
|<br>
*struct device_driver _I_0 = {.groups = E,<br>
                                    };<br>
)<br>
<p>
This, however, doesn't match cases where the assignment is a subexpression of another expression.  For that you could have to do:<br>
<p>
@r@<br>
struct device_driver var;<br>
expression E;<br>
@@<br>
* var.groups = E<br>
<p>
which would match both the . and the -&gt; case, again via an isomorphism.<br>
<p>
julia<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381239/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2010 16:53 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/381682/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Coccinelle doesn't seem to be all that semantic.  It works on C syntax.  A semantic matching rule would be something like "a statement that references the 'next' field of a 'device_driver' struct," as opposed to a rule that matches particular C syntax that happens to do that.

      
          <div class="CommentReplyButton">
            <form action="/Articles/381682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor381221"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Finding all uses of a structure member</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 9:12 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/381221/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>e.g. 'find all times the field 'next' of structure 'struct foo' is used'</blockquote>In fact, any decent IDE will do this.  (The C preprocessor makes it almost impossible for any automated system to be 100% correct for C and C++, but for languages like Java and C# it's straightforward.  An IDE might allow a simple right-click and 'find references' from the menu).
      
          <div class="CommentReplyButton">
            <form action="/Articles/381221/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 14:16 UTC (Wed)
                               by <b>idle</b> (guest, #5017)
                              [<a href="/Articles/381255/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
sparse can do this. In fact it can do more, say,<br>
find all times the field 'next' of structure 'struct foo'<br>
is dereferenced (but not read/modified).<br>
<p>
test-dissect is example.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor381173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 23:16 UTC (Tue)
                               by <b>xnox</b> (guest, #63320)
                              [<a href="/Articles/381173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are there semantic patches for GSeal available? =)))))) Would help a lot to move to Gtk3. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381179"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2010 23:58 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/381179/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In summary, Coccinelle is trying to make C become LISP?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381179/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381213"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 7:53 UTC (Wed)
                               by <b>wsa</b> (guest, #52415)
                              [<a href="/Articles/381213/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As in "programmable programming language"? That is still quite different, I think.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381213/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 10:42 UTC (Wed)
                               by <b>wingo</b> (guest, #26929)
                              [<a href="/Articles/381232/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Though I wonder what the applications of coccinelle are to Lisp. I thought about it a little, then decided to put it off until when/if Guile gets into Emacs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor381222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 9:12 UTC (Wed)
                               by <b>wingo</b> (guest, #26929)
                              [<a href="/Articles/381222/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Related, Val Aurora's article "Semantic patching with Coccinelle":<br>
<p>
<a href="http://lwn.net/Articles/315686/">http://lwn.net/Articles/315686/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381223"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 9:18 UTC (Wed)
                               by <b>wingo</b> (guest, #26929)
                              [<a href="/Articles/381223/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, I didn't see the link in the article at first. Sorry for the noise :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381223/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor381244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">a slightly more concise version</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 13:27 UTC (Wed)
                               by <b>lawall</b> (guest, #56234)
                              [<a href="/Articles/381244/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The following pattern:

<pre>
(
        i2c_set_clientdata(client, data);
    |
        data = i2c_get_clientdata(client);
    |
        T data = i2c_get_clientdata(client);
)
</pre>

could probably be more concise as:

<pre>
(
i2c_set_clientdata(client, data)
|
data = i2c_get_clientdata(client)
)
</pre>

Note the lack of semicolons.  The pattern data = i2c_get_clientdata(client) will also match the case of a variable declaration.

<p>

julia

      
          <div class="CommentReplyButton">
            <form action="/Articles/381244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381347"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2010 23:08 UTC (Wed)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/381347/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Coccinelle means Beetle. I guess it's a pun on "CTL-VW"? (Computation Tree Logic with Variables and Witnesses)

      
          <div class="CommentReplyButton">
            <form action="/Articles/381347/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381428"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Evolutionary development of a semantic patch using Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2010 14:00 UTC (Thu)
                               by <b>lawall</b> (guest, #56234)
                              [<a href="/Articles/381428/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually a coccinelle is a ladybug, which is a carniverous insect, ie it eats other bugs.<br>
<p>
CTL-VW was a unintentional pun on Coccinelle.<br>
<p>
julia<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381428/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
