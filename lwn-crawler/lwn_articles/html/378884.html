        <!DOCTYPE html>
        <html lang="en">
        <head><title>A critical look at sysfs attribute values [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/378884/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/378219/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/378884/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A critical look at sysfs attribute values</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="GAByline">
           <p>March 17, 2010</p>
           <p>This article was contributed by Neil&nbsp;Brown</p>
           </div>
One of the many memorable lines from Douglas Adams's famous work <i>The
Hitchhiker's Guide to the Galaxy</i> was the accusation, probably leveled by
supporters of the Encyclopedia Galactica, that the Hitchhiker's Guide
was "unevenly edited" and "contains many passages which simply seemed
to its editors like a good idea at the time."  With small
modifications, such as replacing "edited" with "reviewed", this
description seems very relevant to the Linux kernel, and undoubtedly
many other bodies of software, whether open or closed, free or
proprietary.  Review is at best "uneven".
<p>
It isn't hard to find complaints that the code in the Linux kernel
isn't being reviewed enough, or that we need more reviewers.  The
creation of tags like "Reviewed-by" for patches was in part an
attempt to address this by giving more credit to reviewers and there
by encouraging more people to get involved in that role.
<p>
However one can equally well find complaints about too much review,
where developers cannot make progress with some feature because,
every time they post a revision, someone new complains about something
else and so, in the pursuit of perfection, the good is lost.
Similarly, though it does not seem to be a problem lately, there have
been times when lots of review would simply result in complaints about
white-space inconsistency and spelling mistakes -- things that are
worth correcting, but not worth burying a valuable contribution under.
<p>
Finding the right topic, the right level, and the right forum for
review is not easy (and finding the time can be even harder).  This
article doesn't propose to address those questions directly, but rather
to present a sample of review - a particular topic at a particular
level on a particular forum, in the hope that it will be useful.

The topic chosen, largely because it is something that your author has
needed to work with lately without completely understanding, is
"sysfs", the virtual filesystem that provides access to some of the
internals of the Linux kernel.  And in particular, the attribute files
that expose the fine detail of that access.
<p>
The level chosen is a high-level or holistic view, asking whether the
implementation matches the goals, and at the same time asking whether
the goals are appropriate.
And the forum is clearly the present publication.

<h4>Sysfs and attribute files</h4>
<p>
Sysfs has an interesting history and a number of design goals, both
of which are worth understanding, but neither of which will be
examined here except in as much as they reflect specifically the
chosen topic: attribute files.

The key design goal relating to attribute files is the stipulation -
almost a mantra - of "one file, one value" or sometimes "one item per
file".  The idea here is that each attribute file should contain
precisely one value.  If multiple values are needed, then multiple
files should be used.
<p>
A significant part of the history behind this stipulation is the
experience of "procfs" or <tt>/proc</tt>.  <tt>/proc</tt> is a
beautiful idea that unfortunately grew in an almost cancerous way to
become widely despised.  It is a virtual filesystem that originally
had one directory for each process that was running, and that
directory contained useful information about the running process in
various files.
<p>
There is clearly more that just processes that
could usefully be put in a virtual filesystem, and, with no clear
reason to the contrary, things started being added to procfs.
With no real design or structure, more and more information was shoe-horned into
procfs until it became an unorganised mess.  Even inside the
per-process directories procfs isn't a pretty sight.  Some files
(e.g. <tt>limits</tt>) contain tables with column headers, others
(e.g. <tt>mounts</tt>) have tables without headers, and still others
(e.g. <tt>status</tt>) have rows labeled rather than columns.  Some
files have single values (e.g. <tt>wchan</tt>) while others have lots
of assorted and inconsistently formatted values
(e.g. <tt>mountstats</tt>).
<p>
Against this background of disorganisation and the attendant
difficulty of adding new fields without breaking applications, sysfs
was declared to have a new policy - one item per file.  In fact, in
his excellent (though now somewhat out-dated) <a
href="http://www.linuxjournal.com/article/6717">article on the Driver Model
Core</a>, Greg Kroah-Hartman even asserted that this rule was "enforced" (see
the side bar on "sysfs").
<p>
It would not be fair to hold Greg accountable to what could have been
a throw-away line from years ago, and I don't wish to do that.
However that comment serves well in providing a starting point and a
focus for reviewing the usage of attribute files in sysfs.  We can ask
if the rule really is being enforced, whether the rule is sufficient
to avoid past mistakes, and whether the rule even makes sense in all
cases. 
<p>
As you might guess the answers will be "no", "no" and "no", but the
explanation is far more enlightening than the answer.

<h4>Is it enforced?</h4>
<p>
The best way to test if the rule has been enforced is to survey the
contents of sysfs - do files contain simple values, or something more?
As a very rough assessment of the complexity of
the contents of sysfs attribute file, we can issue a simple command:
<p>
<pre>
 find /sys -mount -type f | xargs wc -w | grep -v ' total$'
</pre>
<p>
to get a count of the number of words in each attribute file (the
"-mount" is important if you have <tt>/sys/kernel/debug</tt> mounted,
as reading things in there can cause problems).
<p>
Processing these results from your author's (Linux 2.6.32) notebook
shows that of the 9254 files, 1189 are empty and 7168 have only one
word.  It seems reasonable to assume these represent only one value
(though many of the empty files are probably write-only and this
mechanism gives no information about what value or values can be
written).  This leaves 897 (nearly 10%) which need further
examination.  They range from two words (487 cases) to 297 words (one
case).
<p>
While there are nearly 900 files, there are less than 100 base names.
If we filter out some common patterns (e.g. <tt>gpe</tt><i>%X</i>),
the number of distinct attributes is closer to 62, which is a number
that can reasonably be examined manually (with a little help from some
scripting).

Several of these multi-word attribute files contain non-ASCII data and
so are almost certainly single values in some reasonable sense.
Others contain strings for which a space is a legal character, such as
"Dell Inc.", "i8042 KBD port" or "write back".  So they clearly are
not aberrations from the rule.
<p>
There is a small class of files were the single item stored in the
file is of an enumerated type.  It is common for the file in these
cases to contain all of the possible values listed which still seems
to hold true to the "one item per file" rule.  However there are three
variations on this theme:
<p>
<ul>

<li> In some cases, such as the "<tt>queue/scheduler</tt>" attribute of a
     block device, or the "<tt>trigger</tt>" attribute of an LED device,
     all of the possible options are listed, and the currently active one
     is enclosed in brackets, thus:
<pre>
   noop anticipatory deadline [cfq]
</pre>
<p>
<li> In the second variation there are two files, one which contains the
list of possibilities, as with "<tt>cpufreq/scaling_available_governors</tt>"
and one which contains the currently-selected value,
"<tt>cpufreq/scaling_governor</tt>".
<p>
<li> Finally, and this could be just a special case of one of the above, we
have "<tt>/sys/power/state</tt>" for which there is no current
value, so it just contains a list of the possible values.
</ul>
<p>
These are all examples of attribute files that do clearly contain just
one value or item, but happen to use multiple words is various ways to
describe those values.  They are false-positives of our simplistic
tool for finding complex attribute values.
<p>
However there are other multi-word attribute files that are not so
easily explained away.  <tt>/sys/class/bluetooth</tt> contains some
class attributes such as <tt>rfcomm</tt>, <tt>l2cap</tt> and
<tt>sco</tt>.  Each of these contains structured data, one record
per line with 3 to 9 different datums per record (depending on the
particular file), the first datum looking rather like the BD address
of a local blue-tooth interface.
<p>
This appears to be a clear violation of the "one item per file"
policy.  The files do appear to be very well structured and so easy to
parse, so it is tempting to think that they should be safe enough.
However sysfs attribute files are limited in size to one page -
typically 4KB.  If the number of entries in these files ever
gets too large (about 70 lines in the <tt>l2cap</tt> file), accesses
to the file will start corrupting memory, or crashing.  Hopefully that
will never happen, but "hope" is not normally an acceptable basis for
good engineering.  From a conversation with the bluetooth maintainer it appears
that there are plans to move these files to "debugfs" where they can
benefit from the "seq_file" implementation, also used widely in
<tt>/proc</tt>, which allows arbitrarily large files.


<p>
Some other examples include
"<tt>/sys/devices/system/node/node0/meminfo</tt>" which appears to be
a per-node version of "<tt>/proc/meminfo</tt>" and is clearly multiple
values, and the "<tt>options</tt>" attributes in
<tt>/sys/devices/pnp*/*</tt> which appear to contain
exactly the sort of <i>ad hoc</i> formatting of multiple values of
multiple types that people find so unacceptable in <tt>/proc</tt>.
The pnp "<tt>resources</tt>" files are similarly
multi-valued, though to a lesser extent.
<p>
As a final example of a lack of enforcement, the PCI device directory
for the (Intel 3945) wireless network in this notebook contains a file
called "<tt>statistics</tt>" which contains a hex dump of 240 bytes of data,
complete with ASCII decoding at the end of each line such as:
<blockquote>
<pre>
02 00 03 00 d9 05 00 00 28 03 00 00 45 02 00 00  ........(...E...
0d 00 00 00 00 00 00 00 00 00 00 00 d6 00 00 00  ................
b1 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
00 00 00 00 00 00 00 00 67 00 00 00 00 00 00 00  ........g.......
</pre>
</blockquote>
This is surely not the sort of thing that sysfs was intended to
report.  If anything, this looks like it should be a binary
attribute, not a doubly-encoded ASCII file.
<p>
So to answer our opening question, "no", the one item per file rule is
not enforced in any meaningful way.  Certainly the vast majority of
attribute files do contain just one item and that is good.  But there
are a number which contain multiple values in a variety of different
ways.  And this number is only likely to grow as people either copy
the current bad examples, or find new use cases that don't seem to fit
the existing patterns, so invent new approaches which don't take the
holistic view into account.

<h4>Is the rule sufficient?</h4>
<p>
Our next question to ask is whether the stated rule for sysfs
attributes is sufficient to avoid an increasingly unorganised and
<i>ad&nbsp;hoc</i> sysfs following the unfortunate path of procfs.

We have already seen at least one case where it isn't.  We do not have
a standardised way of representing an enumerated type in a sysfs
attribute, and so we have at least two implementations as already
mentioned.  There is at least one more implementation (exposed in the
"<tt>md/level</tt>" attribute of md/raid devices) where just the
current value is visible and the various options are not.  Having a
standard here would be good for consistency and encourage optimal
functionality.  But we have no standard.
<p>
A similar issue arises with simple numerical values that represent
measurable items such as storage size or time.  It would be nice if these were
reported using standard units, probably bytes and seconds.  But we
find that this is not the case.  Amounts of storage are sometimes
reported as bytes (<tt>/sys/devices/system/memory/block_size_bytes</tt>),
sometimes as sectors (<tt>/sys/class/block/*/size</tt>), and sometimes as
kilobytes (<tt>block/<i>*</i>/queue/read_ahead_kb</tt>).
<p>
As these particular examples show, one way to avoid ambiguity is to
include the name of the units (<i>bytes</i> or <i>kb</i> here) as part
of the attribute name, a practice known as Hungarian notation.
However this is far from uniformly applied with the examples given
above being more the exception than the rule.
<p>
Measures of duration face the same problem.  Many times that the
kernel needs to know about are substantially less than one second.
However rather than use the tried-and-true decimal point notation for
sub-unit values, some attribute files report in milliseconds
(<tt>unload_heads</tt> in libata devices), some in microseconds
(<tt>cpuide/state<i>*</i>/time</tt>), and some are even in seconds
(<tt>/sys/class/firmware/timeout</tt>).  As an extra confusion there are some
(...<tt>/bridge/hello_time</tt>) which use a unit that varies depending on
architecture, from centiseconds to mibiseconds (if that is a valid
name for 1-1024th part of a second).  It is probably fortunate that
there is no metric/imperial difference in units for time else we would
probably find both of those represented too.
<p>
And then there are truth values: On, on, 1, Off, off, 0.
<p>
So it would seem that the answer to our second question is "no" too,
though it is harder to be positive about this as there is no clearly
stated goal that we can measure against.  If the goal is to have a
high degree of uniformity in the representation of values in
attributes, then we clearly don't meet that goal.

<h4>Does the requirement always make sense?</h4>
<p>
So the guiding principle of one item per file is not uniformly
enforced, and it isn't really enough to avoid needless
inconsistencies, but were it to be uniformly applied, would it really
give us what we want, or is it too simplistic or too vague to be
useful as a strict rule?
<p>
A good place to start exploring this question is the
"<tt>capabilities/key</tt>" attribute of "input" devices.
The content of this file is a bitmap listing which key-press events the
input device can possibly generate.  The bitmap is presented in
hexadecimal with a space every 64&nbsp;bits.  Clearly this is a single
value - a bitmap - but it is also an array of bits.  Or maybe an array
of "long"s.  Does that make is multiple values in a single attribute?
<p>
While that is a trivial example which we surely would all accept as
being a single value despite being many bits long, it isn't hard to
find examples that aren't quite as clear cut.  Every block device has an
attribute called "<tt>inflight</tt>" which contains two numbers, the number of
read requests that are in-flight (have been submitted, but not yet
completed) and the number of write requests that are in-flight.  Is
this a single array, like the bitmap, or two separate values?  There
would be little cost to have implemented "<tt>inflight</tt>" as two separate
attributes thus clearly following the rule, but maybe there would be
little value either.
<p>
The "<tt>cpufreq/stats/time_in_state</tt>" attribute goes one step further.
It contains pairs, one per line, of CPU frequencies (pleasingly in HZ)
and the total time spent at that frequency (unfortunately in microseconds).
This it is more of a dictionary than an array.
On reflection, this is really the same as the previous two examples.
For both "<tt>key</tt>" and "<tt>inflight</tt>" the key is an
enumerated type that just happens to be mapped to a zero-based
sequence of integers.  So in each case we see a dictionary.  In this
last case the keys are explicit rather than implicit.
<p>
If we contrast this last example with the "<tt>statistics</tt>"
directory in any "net" device (<tt>net/<i>*</i>/statistics</tt>) we
see that it is quite possible to put individual statistics in
individual files.  Were these 23 different values put into one file,
one per line with labels, it is unlikely that anyone would accept that
there was just one item in that file.
<p>
So the question here is: where do we draw the line?  In each of these
4 cases (<tt>capabilities/key</tt>, <tt>inflight</tt>,
<tt>time_in_state</tt>, <tt>statistics</tt>) we have a 'dictionary'
mapping from an enumerated type to a scalar value.  In the first case
the scalar value is a truth value represented by a single bit, in the
others the scalar is an integer.  The size of the dictionary ranges
from 2 to 23 to several hundred for "<tt>capabilities/key</tt>".  Is it
rational to draw a line based on the size of the dictionary, or on the
size of the value?  Or should it be left to the developer - a
direction that usually produces disastrous results for uniformity.
<p>
The implication of these explorations seems to be that we must allow
structured data to be stored in attributes, as there is no clear line
between structured and non-structured data.  "One item per file" is a
great heuristic that guides us well most of the time, but as we have
seen there are numerous times where developers find that it is not
suitable and so deviate from the rules with a disheartening lack of
consistency.
<p>
It could even be that the firmly stated rule has a negative effect
here.  Faced with a strong belief that a collection of numbers really
forms a single attribute, and the strongly stated rule that
multi-valued attributes are not allowed, the path of least resistance
is often to quietly implement a multi-valued attribute without telling
anyone.  There is a reasonable chance that such code will not get
reviewed until it is too late to make a change.  This can lead
multiple developers to solve the same problem in different ways, thus
exacerbating a problem that the rule was intended to avoid.
<p>
So to answer our third question, "no", the "one item per file" doesn't
always make sense because it isn't always clear what "one item" is,
and those places of uncertainty are holes for chaos to creep in to
our kernel.

<h4>Can we do better?</h4>
A review that finds problems without even suggesting a fix is a poor
review indeed.  The above identifies a number of problems, here we at
least discuss solutions.
<p>
The problem of existing attributes that are inappropriately complex or
inconsistent in their formatting does not permit a quick fix.  We
cannot just change the format.  At best we could provide new ways to
access the same information, and then deprecate the old attributes.
It is often stated that once something enters the kernel-userspace
interface (which includes all of sysfs) it cannot be changed.  However
the existence of CONFIG_SYSFS_DEPRECATED_V2 disproves this claim.  A
policy that permits and supports deprecation and removal of sysfs
attributes on an on-going basis may cause some pain but would be of
long-term benefit to the kernel, especially if we expect our
grandchildren to continue developing Linux.
<p>
The problem that there is a clear need for structured data in sysfs
attributes is probably best addressed by providing for it rather than
ignoring or refuting it.  Creating a format for representing
arbitrarily structured data is not hard.  Agreeing on one is much more
of a challenge.  XML has been enthusiastically suggested and
vehemently opposed.  Something more akin to the structure
initialisations in C might be more pleasing to kernel developers (who
already know C).
<p>
Your author is currently pondering how best to communicate a list of
"known bad blocks" on devices in a RAID between kernel and userspace.
sysfs is the obvious place to manage the data, but one file per block
would be silly, and a single file listing all bad blocks would hit the
one-page maximum at about 300-400 entries, which is many fewer than we
want to support.  Having support for structured sysfs attributes would help
a lot here.
<p>
The final problem is how to enforce whatever rules we do come up
with.  Even with a very simple rule that is easily and often repeated and
is heard by many, knowing the rule is not enough to cause people to
follow the rule.  This we have just seen.
<p>
The implementation of sysfs attribute files allows each developer to
provide an arbitrary text string which is then included in the sysfs
file for them.  This incredible flexibility is a great temptation to
variety rather than uniformity.  While it may not be possible to
remove that implementation, it could be beneficial to make it a lot
easier to build sysfs attributes of particular well supported types.
For example duration, temperature, switch, enum, storage-size, brightness,
dictionary etc.  We already have a pattern for this in that module
parameters are much easier to define when they are of a particular
type - as can be seen when exploring
<tt>include/linux/moduleparam.h</tt>.
The moduleparam implementation focuses more on basic types such as
int, short, long etc.  For sysfs we are more interested in higher
level types, however the concept is the same.
<p>
If most of sysfs were converted over to using an interface that
enforces standardised appearance, it would become fairly easy to find
non-standard attributes and then either challenge them, or enhance the
standard interface to support them.
 
<h4>In Closing</h4>
<p>
It must be said that hindsight gives much clearer vision than
foresight.   It is easy to see these issues in retrospect, but would
have been harder to be ready to guard against them from the start.
While sysfs could possibly have had a better design, it could
certainly have had a worse one.  Creating imperfect solutions and then
needing to fix them is an acknowledged part of the continuous
development approach we use in the Linux kernel.
<p>
For entirely internal subsystems, we can and do fix things regularly
without any concern for legacy support.  For external interfaces,
fixing things isn't as easy.  We need to either carry unsightly
baggage around indefinitely or work to remove that which doesn't work,
and encourage the creation only of that which does.

Is it wrong to dream that our grandchild might work with a
uniform and consistent <tt>/sys</tt> and maybe even a 
<tt>/proc</tt> which only contains processes?<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-Code_review">Development model/Code review</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Brown_Neil">Brown, Neil</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/378884/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor379017"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 16:35 UTC (Wed)
                               by <b>fjpop</b> (guest, #30115)
                              [<a href="/Articles/379017/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another thing that's inconsistent is how input is accepted. In a lot of <br>
cases a new value can be set by simply doing 'echo 1 &gt;file', but in other <br>
cases you need to suppress the newline and do 'echo -n 1 &gt;file'.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379017/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379197"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 4:01 UTC (Thu)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/379197/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's considered a bug.  You're supposed to eat all whitespace before AND after whatever you want to parse in a write to a sysfs attribute, and error out if there is any crap at the end.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379197/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379033"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 17:26 UTC (Wed)
                               by <b>adamgundy</b> (subscriber, #5418)
                              [<a href="/Articles/379033/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
there's another issue with 'one value per file', which is consistency.<br>
<p>
if you're trying to read for example the state of a device, having to read multiple files for different attributes is going to spread your 'snapshot' of the information across time - whereas having all the data in a single file allows for a consistent view of the data.<br>
<p>
I'd guess that's the reason for the block device 'inflight' file having two numbers for read and write requests in it..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379033/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 7:47 UTC (Thu)
                               by <b>ptman</b> (subscriber, #57271)
                              [<a href="/Articles/379232/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
POSIX filesystems are not transactional (ACID) like many databases, but it <br>
could probably be done if the user is willing to jump through some hoops. <br>
<p>
For example, a sysfs directory might contain the separate files for separate <br>
values and a file called "snapshot" which, when written to, would create a <br>
subdirectory (which probably would need a unique name, and reading the <br>
unique name from the snapshot-file would probably require file locking...) <br>
with the separate files frozen to a specific point in time.<br>
<p>
I'm probably missing something here and the idea is too complicated to <br>
actually be used in the real world, I'm just trying to say that it might be <br>
solved, but the solution wouldn't be very nice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379338"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 14:47 UTC (Thu)
                               by <b>adamgundy</b> (subscriber, #5418)
                              [<a href="/Articles/379338/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would think that's an easy denial of service, unless you only allow root to take snapshots (which isn't very helpful). for example, just write a shell script that loops asking for as many snapshots as it can in as many sysfs directories as it can find.. chew up all the kernel memory.<br>
<p>
it would probably be better to automatically provide a 'snapshot' file in every directory which can be read to get a consistent view of all files in the directory in some 'well known' format, eg 'key: value' per line like HTTP/SMTP etc.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379338/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">inter-value consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 21:45 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379803/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While this is certainly a theoretical limitation of the one-item-per-file approach, I'm not convinced that it is a practical limitation.  That is, I'm not aware of any actual situations where the inability to read two attribute files at the same moment causes a real problem.<br>
I don't think the 'inflight' numbers really need to be read concurrently, though I guess the total number in flight might be interesting...<br>
<p>
Do you (or anyone) know of a clear example where lack of atomic consistency is a real issue?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">inter-value consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 22:01 UTC (Mon)
                               by <b>adamgundy</b> (subscriber, #5418)
                              [<a href="/Articles/379806/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suspect all the cases of 'required consistency' have been shoved elsewhere (ie /proc or /debug) because of the 'one value per file' requirement of sysfs.<br>
<p>
for example, /proc/interrupts, /proc/slabinfo etc etc.<br>
<p>
without a sensible way of handling consistency, there will always be a demand for putting stuff in /proc or inventing new syscalls/ioctls etc to get the information...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379814"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">inter-value consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 22:39 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379814/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You may well be right.  That is unfortunate as it is hard to solve problems when they are invisible.<br>
<p>
As for your examples, I think both of those files (interrupts and slabinfo) pre-date /sys so they cannot have been put in /proc to avoid /sys rules.<br>
Also I cannot see any atomic-consistency issues that might arise when accessing any of this information.  In fact the contents of /proc/slabinfo appear to also exist in /sys/kernel/slab/*/* which does seem to suggest independent access to the values is OK.<br>
<p>
If there are genuine cases where consistency is needed it would be really helpful to have them documented so we can work towards making sysfs receptive to such need.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379814/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor379084"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 19:19 UTC (Wed)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/379084/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why do you say that putting every block in one file is inefficient? It makes a lot of sense to me. Create a directory called bad_blocks or whatever and put the n-th bad block in a file called n-1. Voila, problem solved. Or is that too inefficient?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379084/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379174"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 2:00 UTC (Thu)
                               by <b>glikely</b> (subscriber, #39601)
                              [<a href="/Articles/379174/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not inefficient.  A sufficiently large number of bad blocks would cause an overrun of the 4k limit for sysfs attributes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379174/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 7:49 UTC (Thu)
                               by <b>ptman</b> (subscriber, #57271)
                              [<a href="/Articles/379233/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think he actually meant separate files, otherwise, why the directory?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 9:49 UTC (Thu)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/379262/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes indeed. The first bad block goes in a file named 0, the second goes in a file called 1, ... the n-th bad block goes in a file called n-1. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379301"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 13:10 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/379301/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... or have a bunch of empty files whose names are block numbers.<br>
<p>
Still, this would definitely have to be dynamically-generated at lookup time: one kobject/dentry for every bad block throughout the lifetime of the /sys mountpoint would be madness.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379301/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379406"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 20:10 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/379406/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So if you have 1000 bad blocks, you need 3000+ system calls to read the list.<br>
<p>
Sorry, but I don't think that this makes much sense.<br>
<p>
Where does that silly 4k limit come from, anyway? debugfs does much better. So provide a symlink to the "real" list which lives somewhere else?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379406/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;one file per block would be silly&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2010 14:00 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/379513/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Uh, the syscall underlying readdir() (getdents()) reads a whole bunch of entries at once, so you don't need 3000 syscalls to readdir() through 3000 names. If you want to stat() them, then you're right: but all you need to do in this case is get their names, which is much faster.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor379091"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 19:25 UTC (Wed)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/379091/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This article identifies more problems with sysfs, mainly that it's beginning to suffer from the kind of cancer that afflicted procfs. Between the inconsistent formatting, atomicity problems, and awkward shell use*, can we finally concede that sysfs was a Bad Idea, and that something like sysctl works just as well while being safer, more consistent, and more elegant?<br>
<p>
<p>
* Try using sudo to modify a sysctl value: you have to use something like sudo sh -c 'echo foo &gt; /sys/bar' instead of a nice simple sudo sysctl bar=5'<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379091/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 20:27 UTC (Wed)
                               by <b>daniel</b> (guest, #3181)
                              [<a href="/Articles/379110/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Try using sudo to modify a sysctl value: you have to use something like sudo sh -c 'echo foo &gt; /sys/bar' instead of a nice simple sudo sysctl bar=5'"<br>
<p>
maybe try: echo foo | sudo tee /sys/bar<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379111"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 20:29 UTC (Wed)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/379111/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>FWIW (and this isn't a disagreement), I use <tt>echo foo | sudo tee
/sys/bar</tt> to do that job. It's still not elegant, but it's a little
easier to type than <tt>sudo sh -c 'echo foo > /sys/bar'</tt>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/379111/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379161"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 0:05 UTC (Thu)
                               by <b>mpee</b> (subscriber, #37530)
                              [<a href="/Articles/379161/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No. It's a pretty good idea, with a few warts.<br>
<p>
If typing all those extra characters is really causing you pain, you can <br>
write yourself a "sysfssyctl" script in about 4 lines.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379161/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 2:39 UTC (Thu)
                               by <b>glikely</b> (subscriber, #39601)
                              [<a href="/Articles/379181/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is another aspect to sysfs which this article doesn't address, and that is the purpose of sysfs in the first place.  Sysfs' primary job is to provide a user space readable representation of the Linux object model, and methods to manipulate it.  udev in particular uses it to make decisions about what to do when new device are registered into the system (ie. add device files).  The sysfs design reflects the boundaries of the problem it is intended to solve.<br>
<p>
Sysfs is not intended to be the primary interface to a device.  Nor is it intended to be a kernel configuration mechanism. A fair few drivers do use it in that capacity and a lot of the time there isn't anything strictly evil about that, but that usage is peripheral to the primary purpose.  It certainly doesn't replace sysctl.<br>
<p>
If questions about access atomicity or formatting of large data arise then I strongly suspect that the sysfs interface is being abused and that a char device or debugfs file would be a more appropriate choice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379274"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 11:13 UTC (Thu)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/379274/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It certainly doesn't replace sysctl.</font><br>
<p>
Well, according to Wikipedia it does indeed. sysctl is implemented on top of sysfs and procfs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379274/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 22:02 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379807/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The wikipedia article is wrong in several respects.  "sysctl" and "sysfs" are independent concepts that attempt to address somewhat similar goals.  sysctl is a "mangement information base" to which access is provided through the /proc filesystem.  It may be that some values accessible through sysctl (i.e. /proc/sys) are also accessible through /sys, but that is certainly not the norm.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379277"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 11:16 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/379277/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Sysfs is not intended to be the primary interface to a device. Nor is it intended to be a kernel </font><br>
<font class="QuotedText">&gt;configuration mechanism.</font><br>
[snip]<br>
<font class="QuotedText">&gt;If questions about access atomicity or formatting of large data arise then I strongly suspect </font><br>
<font class="QuotedText">&gt;that the sysfs interface is being abused and that a char device or debugfs file would be a </font><br>
<font class="QuotedText">&gt;more appropriate choice.</font><br>
As someone who has had to fiddle with sysfs in userspace recently I can only second that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379277/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379809"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 22:08 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379809/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would genuinely like to hear more about the problems and issues you experienced.  My own belief is that, independent of any intentions to the contrary, sysfs is the de-facto primary interface to devices for configuration (though not for data transfer), and we would be well served by making it fit that role well.  To do that we need to understand the problems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379809/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor380230"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2010 4:34 UTC (Thu)
                               by <b>glikely</b> (subscriber, #39601)
                              [<a href="/Articles/380230/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Heh.  I was writing a driver a few years back (not mainlined) and completely ignored all the good advice I got about using a normal char dev to control my simple device.  Instead I implemented a novel set of sysfs files for obtaining the state of the device.  One file was written to chose the channel to read, and another file to read the measurement back.  Nice and simple to manipulate from the shell for debug, but a complete disaster in real-world use cases.  (ie. two processes cannot read from the device at the same time).<br>
<p>
I completely abused sysfs in my driver.  It was the wrong interface for actually interacting with the device, and I ended up rewriting the interface in the end.  In this case the problems and issues were very much of my own making.  :-)<br>
<p>
Anytime I hear complaints about sysfs atomicity it raises a red flag for me and I wonder if it is a similar situation of using sysfs for IO instead of mere configuration.  Using sysfs for IO is in a lot of cases broken.<br>
<p>
I spoke to quickly in my earlier comment.  Yes, you're right.  sysfs has become the natural configuration interface for a lot of devices, and it suits that job very well.  However, I still say that it doesn't replace sysctl for the non-device-centric configuration knobs (ie. the ip stack).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/380230/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor380274"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2010 10:03 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/380274/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suppose my usage case was a bit special - I had to write code that would<br>
enumerate and get information on devices that would run on as wide a<br>
range of Linux-based systems as possible.  Getting information out of sysfs<br>
in a way that is fully backwards-compatible while still being future-proof<br>
proved to be rather hard.  In the end, by minimising the use I made of sysfs<br>
to just the most basic device enumeration - the original purpose of sysfs<br>
after all - I was able to write code that worked from early single-digit 2.6<br>
kernels up to current ones, and with some slightly hacky extensions even<br>
worked on all 2.4 series kernels I tried.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/380274/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor379804"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we admit that sysfs was a really bad idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 21:54 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379804/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think that it is a very big step to go from "it has some problems" to "it is a bad idea".  To my mind sysfs has a lot of strengths.<br>
<p>
And sysctl really isn't measurably better.  check out dev/cdrom/info (in /proc/sys).  If sysctl has fewer problems it is only because it has substantially less content.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379804/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379117"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 20:38 UTC (Wed)
                               by <b>Gollum</b> (guest, #25237)
                              [<a href="/Articles/379117/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about using JSON instead of XML for structured values? <br>
<p>
Still self-documenting (to a certain extent), and easy to parse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379117/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379152"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 23:17 UTC (Wed)
                               by <b>vomlehn</b> (guest, #45588)
                              [<a href="/Articles/379152/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unmentioned, but implied, was issue of inconsistency between text and binary data. You can set text values with echo, but binary data is rather less convenient. Supporting structured data, whether it's done with an XML, C, or other syntax makes good sense. It allows a consistent snapshot to be taken and reduces the number of system calls that must be done to open, read, and close sysfs multiple one-per-attribute files. It should be mandatory that names and types of attributes mustn't change, though allowing attributes to be added, deleted or even reordered should also be supported.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379152/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379299"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 13:06 UTC (Thu)
                               by <b>bcopeland</b> (subscriber, #51750)
                              [<a href="/Articles/379299/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If only there were some way to get structured binary data out of the kernel in an agreed-upon format... hrm, I know, let's call it ioctl!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379299/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379744"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 15:36 UTC (Mon)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/379744/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Hmmm... yes, because ioctl() has always been self-documenting and never problematic, particularly on dual-ABI machines such as x86-64.  ;-)  (Not to mention <A HREF="http://en.wikipedia.org/wiki/Time-of-check-to-time-of-use">TOCTTOU issues</A> with multithreaded programs.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/379744/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor379154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2010 23:25 UTC (Wed)
                               by <b>yanfali</b> (subscriber, #2949)
                              [<a href="/Articles/379154/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <a href="http://www.yaml.org/">YAML</a> is also a nice simple structured text format, with a lot of available libraries.
      
          <div class="CommentReplyButton">
            <form action="/Articles/379154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379234"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 7:55 UTC (Thu)
                               by <b>ptman</b> (subscriber, #57271)
                              [<a href="/Articles/379234/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
YAML (at least the latest revision of the spec) is a superset of JSON. <br>
Better start simple and add complexity only if it is needed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379234/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379484"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2010 11:19 UTC (Fri)
                               by <b>mgedmin</b> (subscriber, #34497)
                              [<a href="/Articles/379484/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've read the YAML spec.  I can never understand people who proclaim it to <br>
be "simple".  Even XML is simpler!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379484/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379708"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2010 21:08 UTC (Sun)
                               by <b>gerdesj</b> (subscriber, #5446)
                              [<a href="/Articles/379708/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'll take your YAML or XML or whatever and raise you ASN.1.  Heck, you could mount sysmibfs and make it legible - hilarious! <br>
<p>
The latest modish markup thingie isn't going to solve the design goals of sysfs, let alone anything else. <br>
<p>
I personally like the simple text file with a value in it approach -  I don't have to learn Yet Another Markup Language (and I don't just mean YAML 8)<br>
<p>
Re evaluating the goals and perhaps filling in the missing ones and then someone enforcing the end design decisions will give a chance for the grandkids to see this thing.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379708/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 12:29 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/379285/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You want to submit that as an April Fool's patch :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379345"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 15:33 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/379345/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;And then there are truth values: On, on, 1, Off, off, 0.</font><br>
<p>
You have to add Y and N to that list (this is what sysfs btw returns back on reading the boolean attribtue).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379345/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379502"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2010 12:22 UTC (Fri)
                               by <b>ranmachan</b> (guest, #21283)
                              [<a href="/Articles/379502/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One option to handle the bad block list would be to have 3 files:<br>
Say, badblock_count badblock_number and badblock.<br>
Then you read it using<br>
for (i=0; i&lt;badblock_count;) {<br>
   write i to badblock_number<br>
   read badblock from badblock<br>
}<br>
Might be quite slow though since it involves lots of context switches. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379502/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2010 0:37 UTC (Sun)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/379676/">Link</a>] 
      </p>
      
      </div>
      </summary>
      That suffers seriously from the issue mentioned in other comments of cross-file consistency.  After you read the number of bad blocks, the number of them changes, and so does the identity of the 35th one.

      
          <div class="CommentReplyButton">
            <form action="/Articles/379676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379811"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 22:32 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379811/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Apart from any consistency problems mentioned elsewhere, this approach really just hides the problem rather than solving it.<br>
<p>
It still has many values behind 1 (or 3) attribute files.  If the "one value per file" policy stands, it is the wrong thing to do.  If the "one value per file" policy can be extended to support arbitrarily large values, then implementing that policy extension through seqfile or similar would be a much more sensible resolution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379811/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor379597"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2010 20:41 UTC (Fri)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/379597/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It really seems like getting bad blocks information would best be done with Netlink, rather than sysfs.<br>
<p>
With sysfs, if you follow the "one value per file" philsophy, you could create a potentially unlimited number of files, in view of how many blocks hard drives have these days. If you don't follow the philsophy, you end up with something that's probably both ugly and buggy.<br>
<p>
With netlink, you don't pay the cost unless someone actually asks for the data. With sysfs, you have to create the inodes, whether or not anyone actually uses them. And of course, there are the atomicity issues. With netlink, it's a lot easier for the application to ask only for the data it wants. Userspace can do something reasonable like reading only part of the data at a time.<br>
<p>
It also makes operations on these bad blocks a lot more natural. You can do something like query which blocks are bad, and then run operations on these blocks, as part of your send/receive netlink session. <br>
<p>
You'd have to ask upstream if they'd be willing to accept a netlink solution first, of course. But I think this is a situation where sysfs is just a square peg in a round hole.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379597/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Netlink??</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2010 22:27 UTC (Mon)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/379810/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I fail to understand the general fascination with netlink.<br>
<p>
My guess is that it is a bit like debugfs "the only rule is that there are no rules".  With netlink you can do whatever you like - it is like ioctl but without the guilt.<br>
<p>
I would always use files in a filesystem for any interaction between kernel and user-space.  You can easily do large files (using seqfile). You can easily to query-response transactions using simple_transaction_* (see the nfsd filesystem).<br>
<p>
But I don't think we should make these choices 'because it is easy' or 'because we can' but rather 'because it is right'.  Determining what is 'right' is a challenge.  In a lot of cases I think 'one item per file' is 'right.  But I don't think it is always right.  Hence the desire to explore how sysfs is actually used in order to find a new interpretation of "right" that both acknowledges everything that currently works well, but also includes those cases that currently aren't supported well.<br>
<p>
Just using netlink (or debugfs) because it doesn't impose rules sounds too much like taking the broad road with the wide gate - I hope you know where that leads.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor380262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Netlink??</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2010 7:02 UTC (Thu)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/380262/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For a lot of reasons netlink is a very good fit for the working with the networking stack.  But note the networking stack has /proc/sys/net also.<br>
<p>
Netlink isn't too bad for general event based things.<br>
<p>
Beyond that I would not encourage use of netlink.<br>
<p>
<p>
I'm not certain what to do with bad blocks.  They seem like part of an abstraction leaking through so I'm not certain we want an interface that we have to maintain for all time describing them for dealing with them.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/380262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor379860"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 23, 2010 13:43 UTC (Tue)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/379860/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's also awful that the USB subsystem encodes hexadecimal values without the 0x prefix, but the PCI subsystem includes it:<br>
<p>
$ cat /sys/devices/pci0000\:00/0000\:00\:1a.7/vendor <br>
0x8086<br>
$ cat /sys/devices/pci0000\:00/0000\:00\:1a.7/usb1/idVendor <br>
1d6b<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379860/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A critical look at sysfs attribute values</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 12, 2010 21:46 UTC (Mon)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/383143/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems a bit sad that you can't get the text representation of either of these.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
