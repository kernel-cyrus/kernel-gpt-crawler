        <!DOCTYPE html>
        <html lang="en">
        <head><title>Building header files into the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/783578/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/783636/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/783578/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Building header files into the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 21, 2019</br>
           </div>
Kernel developers learn, one way or another, to be careful about memory
use; any memory taken by the kernel is not available for use by the actual
applications that people keep the computer around to run.  So it is
unsurprising that eyebrows went up when Joel Fernandes proposed building
the source for all of the kernel's headers files into the
kernel itself, at a cost of nearly 4MB of unswappable, kernel-space memory.
The discussion is 
ongoing, but it has already highlighted some pain points felt by Android
developers in particular.
<p>
Fernandes first <a
href="/ml/linux-kernel/20190118225543.86996-1-joel@joelfernandes.org/">posted
this work</a> in January; <a
href="/ml/linux-kernel/20190320163116.39275-1-joel@joelfernandes.org/">version&nbsp;5</a>
was posted on March&nbsp;20.  As part of the build process, it gathers up all
of the kernel's headers (the "<tt>.h</tt>" files) and a few other artifacts
into a compressed tar file; that file is then built into a kernel module.
If that module is loaded into the running kernel, the tar file containing
the headers can be
read from <tt>/proc/kheaders.tgz</tt>.  This is, thus, a way of allowing
applications to access the header files that were used to build whatever
kernel is running at the moment.
<p>
The purpose of this mechanism is to make those header files available in
situations where they are otherwise unavailable.  In particular,
developers building kernel modules need access to this
information, as do those who are building BPF programs to analyze a
system's behavior.  In some systems, notably Android-based devices, those
header files are almost certainly not easily available.  Fernandes has
tried other solutions to this problem, such as <a
href="/Articles/744522/">BPFd</a>, in the past, but all have fallen short.
Providing headers with the kernel itself is the solution he has settled on.
<p>
Some of the initial reviews were less than entirely favorable; Christoph
Hellwig <a
href="/ml/linux-kernel/20190119102800.GB17723@infradead.org/">described
it</a> as "<q>a pretty horrible idea and waste of kernel memory</q>"
while Alexey Dobriyan <a
href="/ml/linux-kernel/20190219060531.GA3263@avx2/">said</a> that it was
"<q>gross</q>". 
H. Peter Anvin also <a
href="/ml/linux-kernel/78AACAF1-8EBF-4DF3-BE94-5B14E78BA791@zytor.com/">questioned</a>
the memory use and suggested that the data should, at a minimum, be stored
in a swappable filesystem.  Numerous others chimed in as well, describing
the work as a "hack" and saying that, rather than building the tar file
into a kernel module, it would be far more straightforward to just place
that file in the module directory where it could be read directly.
At the same time, a number of other developers have indicated that this feature
would be useful; Daniel Colascione even <a
href="/ml/linux-kernel/CAKOZuet+7a4jdox6rebMN=kJtDn5RUYzvNjFh+Pzn2UkuP0Y8Q@mail.gmail.com/">asked</a>
whether it could be expanded to hold <i>all</i> of the kernel source.
<p>
Nobody seems to disagree with the overall objective of this work.  There
are times when the kernel headers are needed for development, but those
headers tend to be absent on systems like Android.  The disagreement is
over the idea of building those headers into the kernel itself.  This
opposition is easy enough to understand; the kernel itself does not need
that information to function, so there would have to be a strong reason
indeed to sacrifice that much system memory to hold it in kernel space.

<p>
There are indeed reasons for doing so, many of which seem to come down to
how Android systems are built rather than something more technical.  It would
be nice if Android simply had a "kernel headers" package but, as Fernandes
<a
href="/ml/linux-kernel/20190219172550.GB239374@google.com/">explained</a>,
that is not really practical:
<p>
<div class="BigQuote">
	In the Android ecosystem, the Android teams only provide a
	"userspace system image" which goes on the system partition of the
	flash. This image is not GPL and doesn't contain anything GPL. It
	is thus not possible to put kernel headers on the system image and
	I already had many discussions on the subject with the teams, it is
	something that is just not done. Now for kernel modules, there's
	another image called the "vendor image" which is flashed onto the
	vendor partition, this is where kernel modules go. This vendor image
	is not provided by Google for non-Pixel devices. So we have no
	control over what goes there.
</div>
<p>
The seeming aversion to putting anything GPL-licensed into the system image
rubs some developers the wrong way, but it is consistent with the GPL
avoidance practiced in most of the Android system.  There is another reason
why putting the kernel headers there is not a complete solution, though:
developers will often cross-build a kernel and ship it to a device for
direct booting
with the <tt>fastboot</tt> command.  Any headers stored on the device
itself will not match that new kernel, so they are useless at best.  If the
headers are built into the kernel itself, though, they will transfer to the
device with that kernel and always be correct.
<p>
Even for kernels shipped with devices, though, the "store the headers in
the filesystem" solution is problematic.  As Fernandes noted, the Android
project does not have much control over what vendors put onto their devices
or where it goes, so it would be difficult (if not impossible) to mandate
the presence of the 
kernel headers in any sort of standard location.  Android <i>can</i>,
though, mandate that specific kernel configuration options must be set;
with this patch merged, vendors could be made to ship the headers for their
kernels in a place where they could always be found.  Even if vendors tend
to hide their kernel modules in strange places (and they are vendors, so of
course they do), the user space code on any given device knows how to find
and load them.
<p>
In other words, building this information into the kernel is, among other
things, a technical solution to the social problem of getting vendors to
provide that information in a consistent way.  Sometimes such solutions can
be what is needed.  As Colascione <a
href="/ml/linux-kernel/CAKOZuetOePf89cXRkvmWeGnvG7zYN=SW1yyrZibuyOqZQFTGkg@mail.gmail.com/">put
it</a>: "<q>here's the bottom line: without this work, doing certain
kinds of system tracing is a nightmare, and with this patch, it Just
Works</q>".  Or, as Karim Yaghmour <a
href="/ml/linux-kernel/b7296377-9e0c-aed7-61f0-93d24d1ceddd@opersys.com/">described
it</a>:
<p>
<div class="BigQuote">
	That, in my view, is a big part of the problem Joel's patch solves:
	in a system whose functionality requires multiple *independent*
	parties to work together, I can still get the necessary kernel
	headers for user-space tools to properly operate regardless of
	which part of the system is being substituted or replaced.
</div>
<p>
Proponents argue that, since the information is built into a kernel module,
it can be configured out (or simply not loaded) when it is not needed.
Anvin <a
href="/ml/linux-kernel/754146f0-8b57-8644-81c1-528b5ca7dba1@zytor.com/">worried</a>,
though, that mechanisms like this tend to grow into a mandatory role over
time. 
<p>
One associated question is whether providing kernel header files is the
best way to provide the needed information to user space.  Steve Rostedt <a
href="/ml/linux-kernel/20190311193612.4f09bf11@oasis.local.home/">said</a>
that he would rather have a table describing the kernel's structures,
including the offset, size, and type of each field.  That is the information
that is actually needed much of the time, and it could be more compact than
the source code is.  Colascione <a
href="/ml/linux-kernel/CAKOZuetHG0O-CiO6h5tD7aht_MT70ebwWMMSPkRUHdiM3wVq0Q@mail.gmail.com/">sympathized</a>
with the desire for a cleaner format, but argued that it would be better to
go with what works now: "<q>Think of the headers as encoding this
information and more and the C compiler as a magical decoder ring</q>".
Header files also include macros, constant definitions, and other
information needed to build BPF programs.
<p>
The discussion has gone on at length, provoked anew by each new posting of
the patch set.  It does not appear to have changed a lot of minds on either
side of the debate.  Sooner or later, presumably as the 5.2 merge window
approaches, somebody (most likely <a
href="/ml/linux-kernel/20190320113111.d68a7c71c2c163bbc7d5f6aa@linux-foundation.org/">Andrew
Morton</a>) will have to make a decision.  Given the evident
advantages from this patch set, it seems likely that Android kernels may
ship it regardless, so it may be mostly a matter of whether the mainline
follows suit.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Build_system">Build system</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Modules">Modules</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/783578/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor783679"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2019 22:26 UTC (Thu)
                               by <b>xorbe</b> (guest, #3165)
                              [<a href="/Articles/783679/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn't xz be far preferable for this use case? I've seen some impressive gains on text files.  I suppose that requires an xz binary though ... but it's on storage not memory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783679/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compression formats</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2019 23:28 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/783682/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      There were a couple of side discussions on the best compression format; I'll freely admit to having mostly glossed over them as being a secondary issue.
      
          <div class="CommentReplyButton">
            <form action="/Articles/783682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compression formats</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2019 23:34 UTC (Thu)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/783683/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the size is the core of the issue, I guess you could also remove all whitespace and comments…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783694"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Allow me to add to the bike-shedding...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 1:55 UTC (Fri)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/783694/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote><font class="QuotedText">I guess you could also remove all whitespace and comments…</font></blockquote>

<p>You'd probably want to keep the comments.  After all, there's a wealth of information in what the *human* programmer wanted when writing the header file that's not usually obvious in the code itself.  I mean, if we're going to shove all this extra data into a kernel module anyway...</p>

<p>As for the various compression formats, why not give users a choice?  I propose gzip, bz2, lzma, xz, and lzma at a minimum.  After all, open source is all about choice, right?</p>

<p>&lt;/sarcastic humor&gt;</p>

<p>Seriously, though, if this whole feature is limited to a loadable module, and optional at build time, then perhaps this isn't a bad idea.  If this <font class="QuotedText">[grows] into a mandatory role over time</font>, then perhaps its use (or over-use) is a sign that this is a badly needed feature that should remain.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/783694/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783777"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Compression formats</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 22:41 UTC (Fri)
                               by <b>jsmith45</b> (guest, #125263)
                              [<a href="/Articles/783777/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Later versions of the patch are indeed using .tar.xz as the file format. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783777/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783688"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 0:37 UTC (Fri)
                               by <b>Tov</b> (subscriber, #61080)
                              [<a href="/Articles/783688/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe using a SquashFS file instead of a tar file would be beneficial?<br>
Squashfs supports several compression formats and can be mounted in-place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783688/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 22:48 UTC (Fri)
                               by <b>jsmith45</b> (guest, #125263)
                              [<a href="/Articles/783779/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Squashfs was ruled out by the patch author because it requires squashfs-tools, which is neither provided with the kernel, nor otherwise required to build it, and is not installed by default on most systems. On the other hand GNU tar does xz compression itself, and is installed by default on most Linux systems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor783691"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 1:42 UTC (Fri)
                               by <b>IanKelling</b> (subscriber, #89418)
                              [<a href="/Articles/783691/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"This vendor image is not provided by Google for non-Pixel devices. So we have no control over what goes there."<br>
...<br>
"Android can, though, mandate that specific kernel configuration options must be set" <br>
<p>
So, they have no control over what goes there, except they control the modules that go there, which means they do control what goes there.<br>
<p>
"In a system whose functionality requires multiple *independent* parties to work together." <br>
<p>
Except one party forces the others to build their kernels in a certain way through some contract, so they aren't independent.<br>
<p>
What is going on with these unexplained contradictions?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783691/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 3:05 UTC (Fri)
                               by <b>ndesaulniers</b> (subscriber, #110768)
                              [<a href="/Articles/783697/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can't stop vendors from putting whatever in Android; you can make it so their additions go in their own partition.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor783719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 12:29 UTC (Fri)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/783719/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's already one part of the vendor image that Google controls: <a href="https://source.android.com/compatibility/9/android-9-cdd.html">https://source.android.com/compatibility/9/android-9-cdd....</a> has a requirement on /vendor/etc/public.libraries.txt. So I don't understand the "we have no control" argument - Google can assert control over whatever they want, simply by writing it in the CDD and CTS.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783776"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 22:11 UTC (Fri)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/783776/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And as the kernel is GPL, those header files should be a downloadable anyway, shouldn't they?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783776/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784509"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 1, 2019 15:37 UTC (Mon)
                               by <b>neuland</b> (guest, #126936)
                              [<a href="/Articles/784509/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My understanding is that despite being required to by GPL, many vendors don't comply or make it difficult to get the source. And Linus Torvalds (and maybe other leadership people, idk) doesn't like the idea of suing these vendors over violations, because it will hurt the community (as well as the possibility they could lose and be worse off): <a href="https://lists.linuxfoundation.org/pipermail/ksummit-discuss/2016-August/003580.html">https://lists.linuxfoundation.org/pipermail/ksummit-discu...</a><br>
<p>
He also talks negatively in the same message about individual contributors who attempt to sue based on their copyright and organizations that facilitate that, such as the Software Freedom Conservancy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784509/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783781"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 23:01 UTC (Fri)
                               by <b>jsmith45</b> (guest, #125263)
                              [<a href="/Articles/783781/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, but it does not handle the case of a development kernel loaded with fastboot. In that case there is no opportunity to add any files to the system, so the corresponding headers must be included in the kernel in order to ensure the corresponding headers are available. But this proposal lets you compile this as a non-module for that scenario, which would ensure the headers are available. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783781/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784614"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2019 9:26 UTC (Tue)
                               by <b>robbe</b> (guest, #16131)
                              [<a href="/Articles/784614/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don’t get this scenario. If you are running a one-off kernel with „fastboot boot …“ you would have the headers on your controlling computer.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784614/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783833"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 24, 2019 1:37 UTC (Sun)
                               by <b>_joel_</b> (subscriber, #112763)
                              [<a href="/Articles/783833/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is arguably much harder to enforce vendors to have kernel headers tar balls for their kernels on the vendor partition. However, we have more control over which kernel modules are built into the vendor partition and which CONFIG options are enabled. We can enforce certain CONFIG options to be built since a sufficient kernel functionality is needed for Android userspace to work correctly. This is what I was trying to say. This is more of a social problem than a technical problem, and is only one of the many advantages of having this, that I was sighting<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783833/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor784193"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2019 5:48 UTC (Thu)
                               by <b>thestinger</b> (guest, #91827)
                              [<a href="/Articles/784193/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The real answer is that independent updates of the 3 standard OS partitions are supported where the others are left untouched: boot (kernel), vendor  (userspace driver components / HALs for the hardware) and system (with Treble ensuring compatibility with an unmodified AOSP system image, but not actually requiring vendors ship that). These can be updated independently including major updates between OS versions with many changes. The vbmeta image is the only OS level image that actually has to be signed and verified via the signature by the bootloader and has a rollback index enforced, with the other partitions all verified via vbmeta.<br>
<p>
They could come up with a scheme where they stick the headers elsewhere in the boot image, and have something like init expose access to it. The main advantage I can see with the kernel approach is that it wouldn't be only available for Android and is probably the simplest approach.<br>
<p>
<a href="https://source.android.com/devices/bootloader/boot-image-header">https://source.android.com/devices/bootloader/boot-image-...</a><br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784193/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784194"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2019 5:59 UTC (Thu)
                               by <b>thestinger</b> (guest, #91827)
                              [<a href="/Articles/784194/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A more complex setup can have multiple vbmetas, but in practice there's one. There can also be more OS partitions, but the only additional one for Pixels is dtbo, rather than having it in boot.<br>
<p>
<a href="https://source.android.com/devices/architecture/dto/partitions">https://source.android.com/devices/architecture/dto/parti...</a><br>
<p>
Unless they made a new partition with a filesystem mounted in userspace that's shipped with the boot image, there's not really great a place to put the kernel headers other than the kernel. I think that may be a better solution, although it'd be Android specific and not portable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784194/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor783695"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 2:07 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/783695/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not move it to swapable memory?<br>
Store the compressed image in the __init section (which is discarded somewhere in the boot sequence) and have code to copy it into a tmpfs filesystem (which can be paged out).<br>
Maybe put /proc/config.gz there too.<br>
(and maybe a "cowsay" binary too, just it case it is ever needed).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783695/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783712"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 10:02 UTC (Fri)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/783712/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Why not move it to swapable memory?</font><br>
<font class="QuotedText">&gt; Store the compressed image in the __init section (which is discarded somewhere in the boot sequence) and have code to copy it into a tmpfs filesystem (which can be paged out).</font><br>
<font class="QuotedText">&gt; Maybe put /proc/config.gz there too.</font><br>
<p>
Glad to see someone else had the same idea.  Might it make sense to reduce the in-kernel policy a bit by letting user-space handle the tmpfs?  One possible (!) implementation would be to have a device which a) lets you read out the archive and b) lets you free the in-kernel memory holding the archive after you have done with it.  (Maybe that could mean putting it into __init first and copying it from there to free-able kernel memory.)<br>
<p>
Then again, perhaps the same thing could be achieved without it ever being in kernel memory.  Tagged onto the end of the kernel binary?  Something similar to initramfs?  I was going to write "put into initramfs", which would avoid kernel changes altogether, but the thought of bloating that even more is not appealing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783712/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783822"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 23, 2019 22:12 UTC (Sat)
                               by <b>Mattimo</b> (subscriber, #129903)
                              [<a href="/Articles/783822/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually you could use a compressed cpio archive of the headers and just present it as a subtree in procfs because initramfs already has all the primitives available for that. Maybe that would even allow something like /proc/include that just contains the headers in plain sight.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783822/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783720"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 12:33 UTC (Fri)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/783720/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Why not move it to swapable memory?</font><br>
<p>
I think most Android devices don't have swap. They prefer to just kill background apps whenever RAM gets low.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783720/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 15:20 UTC (Fri)
                               by <b>dezgeg</b> (subscriber, #92243)
                              [<a href="/Articles/783758/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Plenty of devices use zram, I think.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 17:45 UTC (Fri)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/783767/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, true, I suppose that technically is swap. But moving a gz file from RAM into tmpfs that gets swapped to zram that is stored in RAM, doesn't sound especially useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor783831"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 24, 2019 1:29 UTC (Sun)
                               by <b>_joel_</b> (subscriber, #112763)
                              [<a href="/Articles/783831/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Neil, thanks for the suggestion. How do you create an invisible tmpfs mount in the kernel and later mount it in userspace though? I am not aware of any such thing. Any existing code or examples would be appreciated.<br>
<p>
Also note that on Android, we don't use disk-based swap. We have a memory based compressed swap called ZRAM, but the archive is already compressed so the suggested idea would provide no benefit (to us).<br>
<p>
One thing I have thought of doing in the future is to make the /proc entry of the archive writeable and write an empty string into it thus freeing the archive's allocated memory and requiring a reboot. However at the moment, I am considering only building this as a module for production Android, and as a built-in when debugging. After the patches can make it, and if others want to free that memory, we can cross that bridge there IMO - such as by writing an empty string into the proc entry.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783831/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783834"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 24, 2019 1:38 UTC (Sun)
                               by <b>_joel_</b> (subscriber, #112763)
                              [<a href="/Articles/783834/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
About requiring a reboot, I meant "requiring a reboot if headers are needed again"<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783834/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor783837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 24, 2019 4:28 UTC (Sun)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/783837/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can create an invisible tmpfs mount with kern_mount(). mm/shmem.c does this.<br>
I don't think there is an existing way to mount this into a mount namespace, but I suspect you could add a mount option to tmpfs to say "use pre-exist superblock named foo".<br>
<p>
If you don't have real swap, this doesn't help you, but it might be a useful answer to people who complain about a waste of kernel memory, or who emphasize that it is non-swapable memory (the article mentions both).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor783839"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 24, 2019 5:39 UTC (Sun)
                               by <b>jsmith45</b> (guest, #125263)
                              [<a href="/Articles/783839/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>Joel, why even bother remounting? You can just directly use the pre-existing internal kernel mount as if it was a special form of swappable kernel memory. CONFIG_BIG_KEYS actually does that, and the the bpfilter user mode helper module copies data that is baked into its module (as discardable init data) into the main internal tmpfs mount, so there is precedent for most of this.</p>

<p>I'll be showing code as if making the file swappable was unconditional, but it should be very obvious how to add a config option that hybridizes what patch V5 has, and the below.</p>

<p>One word of warning: This basically requires CONFIG_TMPFS. It will also work if !CONFIG_SHMEM, because then it uses tiny-shmem (which is ramfs). However using CONFIG_SHMEM without CONFIG_TMPFS yields a tmpfs that is excessively limited.  </p>

<p>Now lets create the file in tmpfs, and copy the data into it:</p>

<pre><code>
static struct path *mem_path;

static int __init ikheaders_init(void)
{
	struct proc_dir_entry *entry;
        size_t kernel_headers_data_size = &amp;kernel_headers_data_end - &amp;kernel_headers_data;
        int err;

        ssize_t written;
	loff_t pos = 0;

        /* copy data to a new tmpfs file, so it can be swapped out */
        mem_file = shmem_kernel_file_setup("", kernel_headers_data_size, 0);
        if (IS_ERR(mem_file)) {
		err = PTR_ERR(mem_file);
		goto err_no_fput;
	}

        written = kernel_write(mem_file, kernel_headers_data, kernel_headers_data_size, &amp;pos);
        if (written != kernel_headers_data_size) {
		err = written;
		if (err &gt;= 0)
			err = -ENOMEM;
		goto error;
	}

	/* create the current headers file */
	entry = proc_create("kheaders.tar.xz", S_IRUGO, NULL,
			    &amp;ikheaders_file_ops);
	if (!entry) {
		err = -ENOMEM;
		goto error;
	}
	
	proc_set_size(entry,
		      kernel_headers_data_size);
	return 0;
error:
	fput(mem_file);
error_no_fput:
	return ret;
}

static void __exit ikheaders_cleanup(void)
{
	remove_proc_entry("kheaders.tar.xz", NULL);
	path_put(mem_path);
}

</code></pre>

<p>OK. Next up, we need to change the section the baked-in data is stored in to be .init.data so it gets discarded after init.</p>

<pre><code>
asm (
"	.pushsection .init.data, \"a\"	\n"
/*...*/
);
</code></pre>

<p>Almost done. All that is left is to make reads of the proc file return data from the in memory file. There are actually several ways to approach this. We could use a magic symlink to the internal file, similar to how the proc file descriptor symlinks work. But to make this act as much like a normal file as possible, the following might be easiest. It is definitely a bit odd to have the read delegate back to vfs_read, but as far as I can tell it should work. I'd bet one of VFS guys can come up with some improvements to this approach.</p>

<pre><code>
static int ikheaders_open_current(struct inode *inode, struct file *file)
{
	struct file *mem_file
	file = dentry_open(path, O_RDONLY, current_cred());

	if (IS_ERR(file)) 
		return PTR_ERR(file);

	file-&gt;private_data = mem_file;
	return 0;
}
static ssize_t
ikheaders_read_current(struct file *file, char __user *buf,
		      size_t len, loff_t *offset)
{
        struct file *mem_file = file-&gt;private_data;
	return vfs_read(mem_file, buf, len, offset);
}
static int ikheaders_release_current(struct inode *inode, struct file *file)
{
        struct file *mem_file = file-&gt;private_data;
	fput(mem_file);
	return 0;
}

static const struct file_operations ikheaders_file_ops = {
        .open = ikheaders_open_current,
        .release = ikheaders_release_current,
	.read = ikheaders_read_current,
	.llseek = default_llseek,
};
</code></pre>

<p>Please note that all this code is untested, and is intended to a show the basic approach, although it probably works as-is, modulo any typos (since most of it was copy-pasted from existing parts of the kernel or your patch).</p>

<p>Hope you find this helpful, or at least interesting</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783839/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784053"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 26, 2019 23:53 UTC (Tue)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/784053/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One word of warning: This basically requires CONFIG_TMPFS. It will also work if !CONFIG_SHMEM, because then it uses tiny-shmem (which is ramfs). However using CONFIG_SHMEM without CONFIG_TMPFS yields a tmpfs that is excessively limited.</font><br>
<p>
It occurs to me that we shouldn't even have these options. The kernel would be simpler to reason about if basic, fundamental, and cheap things like tmpfs and shmem (and procfs!) were hardwired to =y. I've never understood the rationale for extreme configurability. Fundamental things should always be available.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784053/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783998"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 26, 2019 7:34 UTC (Tue)
                               by <b>minchan</b> (subscriber, #61813)
                              [<a href="/Articles/783998/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; Also note that on Android, we don't use disk-based swap. We have a memory based compressed swap called ZRAM, but the archive is already compressed so the suggested idea would provide no benefit (to us).</font><br>
<p>
zRAM supports idle and/or incompressible page writeback once admin configures backing store.<br>
If the data is used rarely or incompressible, it will be written back to the storage from the memory of zram.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783998/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor783698"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 3:54 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/783698/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sun invented a minimalist debug symbol format for use by DTrace called CTF (Compact C Type Format). It's also been adopted by FreeBSD. You can read more about it here: <a href="http://www.smnd.sk/lovasko/paper.pdf">http://www.smnd.sk/lovasko/paper.pdf</a><br>
<p>
CTF is lightweight enough (cf DWARF) that GCC and clang could emit CTF data by default without too much hemming and hawing; we could rely on its presence and enjoy a world where we could not only statically analyze compiled objects, but also generate FFI accessors dynamically at runtime with strong type safety.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783698/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783718"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 12:21 UTC (Fri)
                               by <b>adirat</b> (subscriber, #86623)
                              [<a href="/Articles/783718/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Isn't that what BTF is for?<br>
<p>
<a href="https://facebookmicrosites.github.io/bpf/blog/2018/11/14/btf-enhancement.html">https://facebookmicrosites.github.io/bpf/blog/2018/11/14/...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783718/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 18:37 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/783769/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed! Thanks for sharing.<br>
<p>
Apparently they got it down to 1.5MB. Why are people still talking about shipping header tarballs? Is the BTF work just not well known? Since the motivating use case is BPF, which already requires a specialized tool chain, I don't see the downside.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 23:07 UTC (Fri)
                               by <b>adirat</b> (subscriber, #86623)
                              [<a href="/Articles/783780/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it's just a matter of the left hand not talking to the right hand: Google "bleeding-edge" devs not talking to Facebook's "bleeding edge". :) Also BTF is quite new to the kernel itself and it was added to BCC literally weeks ago.<br>
<p>
Wake up people!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor783771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 18:58 UTC (Fri)
                               by <b>dezgeg</b> (subscriber, #92243)
                              [<a href="/Articles/783771/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does BTF record any #defines that the BPF code might want to use? Or is that out of its' scope?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783789"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2019 23:31 UTC (Fri)
                               by <b>ay</b> (subscriber, #79347)
                              [<a href="/Articles/783789/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn't look like #define and other preprocessor stuff is covered so BTF is probably not usable for that they're trying to achieve here. I imagine things like ioctls would be a deal breaker here...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783789/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor783791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 23, 2019 0:36 UTC (Sat)
                               by <b>adirat</b> (subscriber, #86623)
                              [<a href="/Articles/783791/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All this is really bleeding edge development and I'm not one of the few experts, but I can point you to this presentation from the last LPC microconf which talks about #defines in BTF a little. The consensus among the experts seems to be that, at least for the time beeing, BTF can't replace kernel headers, while the Android devs need a solution yesterday, so here we are at this kernel-headers patch instead of waiting and investing more time to do research :)<br>
<p>
<a href="http://vger.kernel.org/lpc-bpf2018.html#session-2">http://vger.kernel.org/lpc-bpf2018.html#session-2</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783832"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 24, 2019 1:32 UTC (Sun)
                               by <b>_joel_</b> (subscriber, #112763)
                              [<a href="/Articles/783832/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We already know about BTF and this was already discussed in the patch postings. Please read the threads in v4 of the posting. BTF is insufficient for this usecase.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783832/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783890"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2019 13:34 UTC (Mon)
                               by <b>adirat</b> (subscriber, #86623)
                              [<a href="/Articles/783890/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've read the v4 discussion and honestly it only strengthens my assessment: Google engineers are really rushing this patchset instead of exploring alternative solutions. It seems like you just want something ready to use now with minimum effort. Please take a timeout, go back to the drawing board and come back in 1 year with a BTF extension or something similar based on ORC/DWARF.<br>
<p>
I get it that some people are afraid of hard work or telling their managers/marketing they need more time, but you guys are burning a lot of credibility here by saying some very silly things, for example let me quote from the v4 thread exchange [1]:<br>
<p>
               &gt; Think of the headers as encoding this information and more and the C<br>
               &gt; compiler as a magical decoder ring. :-) I totally get the desire for a<br>
               &gt; metadata format a little less messy than C code, but as a practical<br>
               &gt; matter, a rich C-compilation pipeline already exists, and the<br>
               &gt; debuginfo you're proposing doesn't, (...)<br>
<p>
The C compiler as magical decoder ring? Really? It never crossed your mind to actually develop that debug info which you need? :) What's next, including GCC/LLVM itself in the kernel as a module because eBPF also needs them to compile its "restricted-C"? Then BCC and python/lua? Again: wake up, do the proper work and stop pushing bad solutions.<br>
<p>
[1] <a href="https://lkml.org/lkml/2019/3/11/1352">https://lkml.org/lkml/2019/3/11/1352</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783890/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 26, 2019 23:46 UTC (Tue)
                               by <b>jsmith45</b> (guest, #125263)
                              [<a href="/Articles/784052/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, with the right flags you can get macro definitions in the DWARF data, and extract them. But apparently compiling the kernel even with the normal debug flags can cause compilation to be quite a bit slower, and generate an enormous amount of data, and this would need even more data. <br>
<p>
And parsing out the correct set of macros from that debug info may not be entirely trivial. (Some macros may have multiple values in different spots in the kernel.) Even if those issues were solved, and we had the macro data to combine with BTF it is not equivalent to headers. One thing that does not get captured is inline functions defined in the headers. I've no idea if those ever get used in BPF programs, but I could certainly imagine that at least some of them may work (e.g. if they are just abstracting over a struct access). And those are impossible to extract from any form of debugging information.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor869152"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2021 1:13 UTC (Tue)
                               by <b>nickodell</b> (subscriber, #125165)
                              [<a href="/Articles/869152/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I get it that some people are afraid of hard work or telling their managers/marketing they need more time, but you guys are burning a lot of credibility here by saying some very silly things, for example let me quote from the v4 thread exchange [1]:</font><br>
<font class="QuotedText">&gt;[...]</font><br>
<font class="QuotedText">&gt;The C compiler as magical decoder ring? Really? It never crossed your mind to actually develop that debug info which you need? :) </font><br>
<p>
I think you&#x27;re underestimating the work involved in getting a C compiler to both emit and understand the new debug info. E.g. the preprocessor must know how to use macros from the debug info for substitution. The typechecker must know how to use function prototypes to check that a function is being called with the appropriate types. The compiler must know how to load structure definitions so that it knows what offset to access data from within a struct.<br>
<p>
The only current data format that carries all that information is a C header file. Could you develop a new format which does not carry extraneous information like comments? Sure. But you&#x27;d be introducing an unknown number of bugs. The payoff for doing that is at most 4MB of freed memory. Approaches which load the tar file on demand, or that allow it to be paged in and out, seem much more promising.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/869152/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor869262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2021 12:42 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/869262/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well... both CTF and BTF carry all that information, and weigh in at a few megabytes for a full monster enterprise kernel (complete with, in the CTF case, all types used by in-tree modules as well). They&#x27;re certainly both a lot smaller than the header files that were the source for a lot of their content would be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/869262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor869264"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2021 13:30 UTC (Wed)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/869264/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What&#x27;s the difference between CTF and BTF and do we need both? I couldn&#x27;t find a succinct summary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/869264/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor869307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2021 16:49 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/869307/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They are distinct things these days and can both be present at the same time without conflict. BTF is created from DWARF by pahole (in dwarves) and has no plans to work for anything but the kernel (not that this matters for this use case): CTF is generated by trunk GCC and linked and dedupped by recent-enough GNU ld, but you cannot yet generate header files from CTF (not because it&#x27;s impossible, but just because I haven&#x27;t written the code to do that yet: I will do it soon, and add it as an objdump option).<br>
<p>
They are both derived from the same ancestor (Solaris CTF) but have a significant number of differences by now, mostly reflecting their kernel-only versus userspace focuses (e.g. CTF supports symbol -&gt; type lookup using the ELF symtab, which obviously makes little sense for BTF; BTF has a whole elaborate pile of relocation machinery for CO-RE, tightly tied to LLVM at present, that isn&#x27;t in CTF).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/869307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor783954"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2019 15:17 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/783954/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See also <a href="http://github.com/oracle/libdtrace-ctf.git">http://github.com/oracle/libdtrace-ctf.git</a> for an evolution of the same file format (and indeed code) with a (much) larger range, GPLv2 and UPL-licensed. It's under active development: further improvements are planned in the near future.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783954/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor784197"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Building header files into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2019 7:23 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/784197/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; developers will often cross-build a kernel and ship it to a device for direct booting with the fastboot command. Any headers stored on the device itself will not match that new kernel, so they are useless at best. If the headers are built into the kernel itself, though, they will transfer to the device with that kernel and always be correct.</font><br>
<p>
Déjà vu: what about  kernel *modules*? Typical deployment problem on any Linux-based OS. For Android how does fastboot deploy kernel modules and where to ? I mean the mainline &amp; GPL drivers, not vendor modules.<br>
<p>
This page seems to refer to vendor modules only: <a href="https://source.android.com/devices/architecture/kernel/modular-kernels">https://source.android.com/devices/architecture/kernel/mo...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784197/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784220"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Modules</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2019 13:09 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/784220/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      If modules really turn out to be a problem, one can, of course, just build them directly into the kernel image.
      
          <div class="CommentReplyButton">
            <form action="/Articles/784220/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor784264"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Modules</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2019 16:36 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/784264/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You almost answered my question except for the first word "If".<br>
<p>
Do Android/fastboot/etc. support compiling mailine drivers as modules or not really?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/784264/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
