        <!DOCTYPE html>
        <html lang="en">
        <head><title>Standards, the kernel, and Postfix [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/294667/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/293903/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/294667/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Standards, the kernel, and Postfix</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>August 20, 2008</br>
           </div>
<p>
Standards like POSIX are meant to make life easier for application developers
by providing rules on the semantics of system calls for multiple different
platforms.  Sometimes, though, operating system developers decide to change
the behavior of their platform&mdash;with full knowledge that it breaks
compatibility&mdash;for various reasons.  This requires
application developers to notice the change and take appropriate action;
not doing so can lead to a security hole like the one found in the Postfix 
mail transfer agent (MTA) recently.  
</p>

<p>
The behavior of links, created using the <tt>link()</tt> system call&mdash;on
Linux, Solaris, and IRIX&mdash;is what tripped up Postfix.  In particular, what
happens when a hard link is made to a symbolic link.  Many long-time UNIX
hackers don't realize that you can even do that, nor what to expect if you
do.  Postfix relied on a particular, standard-specified behavior that many
operating systems, including early versions of Linux, follow.
</p>

<p>
Links can be a somewhat confusing, or possibly unknown, part of UNIX-like
filesystems, so a bit of explanation is in order.  A link created with
<tt>link()</tt>&mdash;also known as a hard link&mdash;is an alias for a
particular file.  It simply gives an additional name by which a particular
chunk of bytes on the disk can be referenced.  For example:
<pre>
    link("/path/to/foo", "/link/to/foo");
</pre>
creates a second entry in the filesystem (called <tt>/link/to/foo</tt>)
which points to the same file as
<tt>/path/to/foo</tt>.  The file being linked to must exist and reside on
the same filesystem as the link.
</p>

<p>
Symbolic links, on the other hand, are aliases of a different sort.  A
symbolic link creates a new entry (e.g. inode) in the filesystem which
contains the path of the linked-to file as a string.  There is no
requirement that the file exist or be on the same filesystem&mdash;the only
real requirement is that the path conform to standard pathname rules.
The <tt>symlink()</tt> system call is used to create them:
<pre>
    symlink("/path/to/foo", "/symlink/to/foo");
</pre>
Both symbolic links and hard links can also be created from the command line
using the <tt>ln</tt> command (adding a <tt>-s</tt> option for symbolic
links).
</p>

<p>
So, when making a hard link to a symbolic link, there are two choices:
either follow the symbolic link to its, possibly nonexistent, target and
link to that or
link to the symbolic link inode itself.  POSIX requires that the symbolic
link be fully resolved to an actual existing file, which is the behavior
that Postfix relies upon.
</p>

<p>
The exact
sequence of events is lost in the mists of time, but Linux changed to
non-standard behavior&mdash;at least partially for compatibility with
Solaris&mdash;in kernel version 1.3.56 (which was released in January
1996).  Some <a href="
http://groups.google.com/group/comp.os.linux.development.system/msg/7b3eadf132e67190?">discussion</a>
prior to that change adds an additional reason for it: user space has no
way to make a link to a symbolic link without it.  Some saw that as a flaw
in the interface and proposed the change.  An application developer that
wanted the 
original behavior would be able to implement it by resolving any symbolic
links before making the hard link.
</p>

<p>
To further complicate things, it appears that the POSIX behavior was
restored in the 2.1 development series, only to be <a
href="http://lkml.org/lkml/1998/9/10/4">changed back</a> in late 1998.
This change led to the comments currently in <tt>fs/namei.c</tt> for
the function implementing <tt>link()</tt>: 
<pre>
    /*
     * Hardlinks are often used in delicate situations.  We avoid
     * security-related surprises by not following symlinks on the
     * newname.  --KAB
     *
     * We don't follow them on the oldname either to be compatible
     * with linux 2.0, and to avoid hard-linking to directories
     * and other special files.  --ADM
     */
</pre>
Where <tt>oldname</tt> is the file being linked to and <tt>newname</tt>
is the name being 
created.  For the curious, KAB is Kevin Buhr and ADM is Alan Modra.
</p>

<p>
Unfortunately, according to Postfix author Wietse Venema, the
<tt>link(2)</tt> man page 
didn't change until sometime in 2006. This makes it fairly difficult for
application developers to learn about the change, especially because they
may not follow kernel development closely.
</p>

<p>
Postfix allows root-owned symbolic links to be used as the target for local
mail delivery, specifically to handle things like <tt>/dev/null</tt> on
Solaris, which is a symbolic link.
Because an attacker can make a link to a root-owned symbolic link on
vulnerable systems, Postfix can get confused and deliver mail to files that
it shouldn't.
This can lead to privilege escalation (via executing code as root)
by making a hard link to
a symbolic link of an init script (<a
href="http://nvd.nist.gov/nvd.cfm?cvename=CVE-2008-2936">CVE-2008-2936</a>). 

</p>

<p>
As Venema outlines in the <a
href="http://archives.neohapsis.com/archives/postfix/2008-08/0392.html">Postfix
security advisory</a>, the problem can be resolved by requiring that
symbolic links used for local delivery reside in a directory that is only
writeable by root. 
It is not a perfect solution, though: "<q>This change will break
legitimate configurations that deliver mail 
to a symbolic link in a directory with less restrictive
permissions.</q>" 
There are other workarounds for people who don't want to use the provided
patch to Postfix.  Protecting the mail spool directory is one solution;
Venema provides a script to use to do that.  Some systems can be configured
to disallow links to files owned by others, which is another way to avoid
the problem. 
</p>

<p>
This issue has given Postfix a bit of a black eye, but that
is rather unfair. 
The problem was found by a SUSE code inspection, but it has existed in
certain kinds of Linux installations of Postfix for a long time.  It could
be argued that testing should have found it&mdash;there is a simple test for
vulnerable systems&mdash;but relying on documented behavior that is part of
an important standard that Linux is said to support is not completely
unreasonable either.  It is likely that the full implications of not
supporting the standard were not completely understood until recently.
</p>

<p>
Linux was still in its infancy when the original change went in.  One would
like to think that a change of that type today would be nearly impossible
because it breaks the kernel's user-space interface.  If it were to happen,
somehow, the resulting hue and cry would be loud enough that application
developers would hear.  But that's for intentional changes; a bug
introduced into a dark corner of the kernel's API might go unnoticed for
quite some time.  Hopefully, none of those lingers for ten years before
being discovered.
</p>

<p>
<b>Update:</b> The original article referred to <a
href="http://nvd.nist.gov/nvd.cfm?cvename=CVE-2008-2937">CVE-2008-2937</a>
as also being a consequence of the link issue, which it is not.  It is an
unrelated issue that was found during the same code review.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Symbolic_links">Symbolic links</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Vulnerabilities-Privilege_escalation">Vulnerabilities/Privilege escalation</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/294667/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor294836"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">System calls vs. library functions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 19:38 UTC (Wed)
                               by <b>johnkarp</b> (guest, #39285)
                              [<a href="/Articles/294836/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
POSIX describes C library functions, not the actual system calls, right? So isn't this more of
a glibc issue, since its role is to provide library functions which invoke the proper system
calls?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294836/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">System calls vs. library functions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 20:06 UTC (Wed)
                               by <b>asamardzic</b> (guest, #27161)
                              [<a href="/Articles/294848/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      POSIX (actualy <a href="http://www.unix.org/what_is_unix/single_unix_specification.html">SUS</a> nowadays) describes "system interfaces", which are exposed as C functions, usually directly mapping to actual system calls. As the links behavior is tightly coupled with file system implementation, related code is usually part of the kernel, thus link() has not much to do in userspace, and this particular issue probably has to be resolved within the kernel code.
      
          <div class="CommentReplyButton">
            <form action="/Articles/294848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">System calls vs. library functions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 20:35 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/294858/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Pedant point: POSIX incorporated all of SuS some years back; the result is 
called POSIX. (Confusing, I know.)

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">System calls vs. library functions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 3:50 UTC (Thu)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/294917/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
<em>Pedant point: POSIX incorporated all of SuS some years back; the result is called POSIX. (Confusing, I know.)</em>
</blockquote>
<p>
Well, to be extrememly pedantic, the work of the Austin group consolidated earlier POSIX standards and SUSv2, to create a new standard that defines two levels of conformance: base conformance (aka POSIX.1-2001), and XSI (X/Open System Interface) conformance (aka SUSv3).  So the result is called both POSIX <strong>and</strong> SUS.
      
          <div class="CommentReplyButton">
            <form action="/Articles/294917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">System calls vs. library functions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 3:52 UTC (Thu)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/294918/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      See also <a href="http://www.kernel.org/doc/man-pages/online/pages/man7/standards.7.html">http://www.kernel.org/doc/man-pages/online/pages/man7/standards.7.html</a>
      
          <div class="CommentReplyButton">
            <form action="/Articles/294918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294938"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">System calls vs. library functions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 9:06 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/294938/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
That manpage, and the posixoptions manpage it links to, are excellently done. (It is a tad
unclear, though, whether posixoptions describes the meaning of the options or whether it
instead describes what values those options have got on a Linux (glibc?) system...)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294938/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor294845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 20:09 UTC (Wed)
                               by <b>Thalience</b> (subscriber, #4217)
                              [<a href="/Articles/294845/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I understand how linux's behavior differs from the standard, but I don't see how this can fool
postfix into into doing something it wouldn't otherwise do.

If you have a root owned symlink to an init script (as in the example), can't you just mv that
symlink into /var/mail and get the same effect?

I'm sure I'm missing something here but as the article points out, this is a subtle area.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294864"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 21:21 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/294864/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <P>Here's the scenario, as I understand it:</P>
<UL><LI>Suppose <TT>/etc/inittab</TT> is a symlink to <TT>/etc/inittab.thishost</TT>.</LI>
<LI>Now suppose an attacker hard-links <TT>/etc/inittab</TT> to <TT>/home/attacker/maildir/somefile</TT>.</LI>
<LI>Next, the attacker mails himself a specially formatted email containing inittab records.</LI>
</UL>
<P>The attacker can't modify the symlink in <TT>/etc</TT> because that directory is not owned or writable by the attacker.  The attacker <I>can</I> make a hard link<A HREF="#foot1"><SUP>1</SUP></A>, though, and that's where the hole is.</P>
<P>To my eyes, the real problem is that it's possible to deliver mail for user $FOO to a file that user $FOO doesn't have write permission on.  If you're reading mail via a local mail spool, and the user has control over where it's written, it seems as though some <TT>setfsuid</TT> is in order when writing it?</P>
<HR>
<A NAME="foot1"><SUP>1</SUP></A><SMALL> Hard links tend not to be able to span filesystem boundaries, though, so if <TT>/etc</TT> and <TT>/home</TT> are in different filesystems, you may be ok.  I don't think anything guarantees or requires that, but it's a common feature of all the *nix filesystems I've worked with, which is admittedly a narrow set.</SMALL>
      
          <div class="CommentReplyButton">
            <form action="/Articles/294864/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 21:41 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/294871/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt;The attacker can make a hard link, though, and that's where the hole is.</font>

And grsec has had a kernel patch that addresses exactly this problem for a long time  denying
hardlinks to files in directories not owned or writable (one or the other, don't remember) by
the actor.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294877"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 21:58 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/294877/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Hmmm...  Seems like "not writable by" might be more likely than "not owned by."  While I can't
think of a specific instance, I imagine that disallowing hard links in /tmp might confuse a
couple things.  

(But think of all the race conditions we might close!  Oh, wait, that's mostly symlinks.)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294877/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294885"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 20, 2008 22:29 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/294885/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Yes it does confuse a few things. Not in /tmp, but surprisingly, in /var/spool/atjobs! I
solved it by augmenting the batch to allow an exception for system UIDs (uid &lt; 1000, or
whatever you specified as an exception).
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294885/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor294910"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 1:50 UTC (Thu)
                               by <b>Thalience</b> (subscriber, #4217)
                              [<a href="/Articles/294910/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Ah. Because you can't unlink the original name of the root-owned symlink (in the case of an
important file in /etc at leats), you can't get the same effect.

And I can't think of a root-owned file that would live in a dir a regular user can write to...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294910/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor295005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 15:28 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/295005/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I don't think it's possible for hard links to span filesystems. The point of a hard link is
that the two names have the same inode, and a dentry pointing to an inode on a different
filesystem either wouldn't work at all (since the dentry doesn't include enough information to
specify the inode completely) or wouldn't be really a separate filesystem.

I suppose, however, you could have a single filesystem that you'd carved up and arranged with
bind mounts to look like multiple filesystems, and the OS wouldn't necessarily block creating
the hard links (although, IIRC, Linux presently does).
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295087"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 23:19 UTC (Thu)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/295087/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
That's my understanding as well.  I was pretty sure traditional *nix filesystems worked this
way.  What I wasn't sure of is whether union mounts, or one of the newer filesystems supported
something fancier.  

I know if I state unequivocally that it can't be done, the odds are against me someone will
demonstrate I'm wrong.  ;-)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295087/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor295226"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2008 0:23 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/295226/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
<ul>
<li>Suppose /etc/inittab is a symlink to /etc/inittab.thishost.
<li>Now suppose an attacker hard-links /etc/inittab to /home/attacker/maildir/somefile.
<li>Next, the attacker mails himself a specially formatted email containing inittab records.
</ul>
</blockquote>
<p>
I'm guessing from the clues in the article that there's more to it: The above would ordinarily fail because Postfix sets the process permissions to attacker's before writing the mail file and attacker doesn't have write permission to /etc/inittab.thishost.  But Postfix, I'm guessing, notices that /home/atacker/maildir/somefile is a symbolic link owned by root, assumes that the only way that could get there is that root created it there, and therefore feels safe in using root's permissions or even DAC_OVERRIDE privilege to write through it.  I can see that might be a useful feature.

      
          <div class="CommentReplyButton">
            <form action="/Articles/295226/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor295453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 25, 2008 20:54 UTC (Mon)
                               by <b>ceplm</b> (subscriber, #41334)
                              [<a href="/Articles/295453/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is this case covered by SELinux?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor294922"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 5:11 UTC (Thu)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/294922/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Some minor details...
The man page documentation of the Linux behavior went into <a href=" http://www.kernel.org/doc/man-pages/changelog.html#release_2.02">man-pages-2.02</a> in 2005 (not 2006), indeed long after the changes to the kernel.
<p>
As the article hints, Linux is not the only system where <em>link()</em> doesn't follow symlinks in <em>oldpath</em>: Solaris also does this, when programs are compiled with the default compiler options (Solaris can also deliver the POSIX.1-2001 compliant behavior with appropriate compilation options), and I've read that some other SVR4 implementations may also have done this.  POSIX.1-2008 addresses this variation across systems by changing the specification of <em>link()</em> to say that it is unspecified whether it follows symbolic links in <em>oldpath</em>.  (See <a href="http://www.opengroup.org/austin/mailarchives/ag/msg08152.html">http://www.opengroup.org/austin/mailarchives/ag/msg08152.html</a>.)

      
          <div class="CommentReplyButton">
            <form action="/Articles/294922/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor294928"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 6:37 UTC (Thu)
                               by <b>magnus</b> (subscriber, #34778)
                              [<a href="/Articles/294928/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I find it a bit odd that a normal user can do things like this:
ln /etc/shadow ~/myfile
and control where system files show up in the file system. 

Would something break if hardlinking to files not owned by yourself would be forbidden?

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294928/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 8:58 UTC (Thu)
                               by <b>adegert</b> (guest, #5503)
                              [<a href="/Articles/294935/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
its even more odd if you create the link in a directory which has the sticky bit set:

ln /etc/shadow /tmp/myfile

you can create that link, but you can't delete it afterwards (only root can do that)

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295014"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 15:43 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/295014/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; ln /etc/shadow /tmp/myfile</font>
<font class="QuotedText">&gt; you can create that link, but you can't delete it afterwards (only root can do that)</font>

Wow, that's insane!

I'd never thought about this issue of hardlinks...but it kinda seems bad that
you can create a file  owned by another user.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295014/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2008 23:44 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/295222/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
it kinda seems bad that
you can create a file  owned by another user.
</blockquote>
<p>
You can't create a file owned by another user.  But you can create a directory entry that points to a file owned by another user.
<p>
It all seems strange compared to what you can do with symbolic links, but if you think about the early systems that didn't have symbolic links, you can see how useful it is.
<p>
I think what would have given me pause in the pre-symbolic-link days was not that I could keep a pointer to your file in my directory, but that I could prevent you from deleting that file.  So while I can't create a file owned by you, I can force you to keep owning one that only I am using.  If the system does accounting, you have to pay for the space.
<p>
Altogether, I think Unix should have either made files and their names completely separate, like VMS, or completely merged, like NTFS.  The intermediate thing has too many surprises.

      
          <div class="CommentReplyButton">
            <form action="/Articles/295222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor296283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2008 14:37 UTC (Sat)
                               by <b>abpsoft</b> (guest, #53672)
                              [<a href="/Articles/296283/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi,<br>
<p>
<font class="QuotedText">&gt; its even more odd if you create the link in a directory which has the sticky bit set:</font><br>
<font class="QuotedText">&gt; ln /etc/shadow /tmp/myfile</font><br>
<font class="QuotedText">&gt; you can create that link, but you can't delete it afterwards (only root can do that)</font><br>
<p>
Hmpf.<br>
<p>
Actually I consider this to be an implementation bug of the directory sticky bit semantics. It should prevent from happening *any* changes to the directory involving names to inodes the subject process doesn't own. Most users just think about unlink(2)ing files, but it also prevents rename(2) from succeeding. Not blocking directory entry creation through link(2) in the first place thus should be considered incomplete implementation, or is there explicit standard language stating otherwise? I haven't read much beyond XPG4 ;)<br>
<p>
Andre.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/296283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor294955"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 10:27 UTC (Thu)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/294955/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <p><i>
I find it a bit odd that a normal user can do things like this:
ln /etc/shadow ~/myfile
and control where system files show up in the file system. 
</i></p>

<p>
Not just odd, but a security problem too.  A user can
do <code>ln /usr/sbin/sendmail ~/sendmail </code>
then wait for a security bug to be reported in sendmail.
Even though the administrator upgrades <code>/usr/sbin/sendmail</code>
the buggy setuid sendmail is still available in the user's home directory.
</p>

<p>
This is one reason to have separate root and /usr partitions,
because hardlinking across filesystems isn't possible.
</p>

<p>Rich.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/294955/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 12:08 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/294970/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
By golly, you're right!

% su
# cp /bin/true /test
# chmod u+s /test
# exit
% ln /test ~/suid_program
% su
# rm /test
# exit
% ls -l ~/suid_program
-rwsr-xr-x 1 root root 26468 2008-08-21 13:06 suid_program

Yikes!

Perhaps this indicates the need for a 'delete' system call which makes sure a file is really
gone, rather than merely 'unlink'ing one of the names which points to it.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 13:59 UTC (Thu)
                               by <b>Los__D</b> (guest, #15263)
                              [<a href="/Articles/294991/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I guess it would also be a (small) improvement for package managers to overwrite existing
files, instead of removing the old one first.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 14:20 UTC (Thu)
                               by <b>djpig</b> (guest, #18768)
                              [<a href="/Articles/294995/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><em>I guess it would also be a (small) improvement for package managers to overwrite existing
files, instead of removing the old one first.</em></blockquote>

<p>Uh, you better not have any programs running during the update then...</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294997"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 14:28 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/294997/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Exactly.  The relatively smooth upgrading of software on Unix-like systems is because you can
unlink the old file and create a new file with the same name.  The old one will continue to
exist, with its old data, as long as a process has it open.  If you try to fix the suid binary
problem by forcibly removing a file, or overwriting its contents, then you risk breaking
running code.

(Since writing bytes to a file is not atomic, you could theoretically introduce new security
holes by overwriting the contents of a suid binary.  What if someone runs it halfway through
the update, when it contains a mixture of old and new code?)

One answer would be to move the suid flag out of the inode and put it in the directory entry.
Then you could make as many links to a file as you wanted, but you wouldn't be able to get the
suid magic (unless, of course, you have permission to set the suid bit anyway).  But given the
conservatism of Unix-like systems and the large amount of filesystem code that would have to
change, I can't see this happening soon.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294997/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 14:44 UTC (Thu)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/295001/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>No, package managers should just remove the setuid bit before unlinking the file.</p>

<p>This doesn't affect running programs.  It does affect someone who starts to run the program at 
the 
moment that the suid bit is removed, but this is already a problem during package upgrades (the 
file is temporarily removed, so attempts to run it can fail briefly).
</p>
<p>
It's actually possible that package managers do this correctly already, since this problem is very old 
and well-known.
</p>
<p>
Rich.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/295001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295047"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 18:48 UTC (Thu)
                               by <b>vmole</b> (guest, #111)
                              [<a href="/Articles/295047/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>No, package managers should put the file in the proper directory with a unique name (e.g. foo.package_new) with proper permissions and ownership, and then rename(2) the proper name to the unique name. This way there's never a time when '/bin/foo' is anything but the proper old entry or the proper new entry, since rename(2) is atomic. Exisiting users of the file won't see the change - they've got an open descriptor to the old file, which remains on disk until the last open descriptor is closed.
      
          <div class="CommentReplyButton">
            <form action="/Articles/295047/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295111"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How to replace an executable...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2008 6:08 UTC (Fri)
                               by <b>faramir</b> (subscriber, #2327)
                              [<a href="/Articles/295111/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
There seem to be three issues:

1. Atomic replacement of an executable (by name)
2. Removing permissions from potentially hard linked old copies (by inode)
3. Reporting possible nefarious activities by hard linkers.

I think this sequence deals with them all:

1. Hard link canonical name of old executable to first temporary name.
2. Create new executable with second temporary name and appropriate privs.
3. rename() second temporary name to canonical name (this is atomic).
4. Chown/chmod first temporary name to remove any special privileges, execute bits, etc.
5. stat() first temporary name and report if there is more then one link
(Should be just one from first temporary name at this point).
6. Unlink first temporary name.

At the end of the sequence, you will have atomically replaced the executable, removed any
special privileges from any links people may have hidden away, and reported (to the extent
possible without a full search of the filesystem) that somebody has been linking to
executables.

Of course, the sendmail example is a bad one as typically there is more then one valid link.
'sendmail' and 'newaliases were traditionally the same program.  I know of no way to atomically
make a bunch of links to one
program so the best I can think of would be to make a bunch of temporary names for the new
execuable and then rename() them all into place sequentially in steps 2 and 3.  Steps 4-6
could remain the same and would still be able to accurately report improper links while at the
same time making them useless.





</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295111/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor295009"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 15:12 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/295009/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Here is a handy tool to make a collection of hard links to suid or sgid binaries and keep the
collection up to date.  Use as

% mkdir suid_collection
% suid_harvester /sbin /bin /usr/sbin /usr/bin /usr/local/bin suid_collection

#!/usr/bin/perl
use warnings;
use strict;
use 5.010;
use File::Find;
use File::stat;
use Fcntl qw(:mode);
use File::Spec;

sub interesting {
    my $sb = shift;
    my $mode = $sb-&gt;mode;
    my $suid = $mode &amp; S_ISUID;
    my $sgid = $mode &amp; S_ISGID;
    my $uid = $sb-&gt;uid;
    my $gid = $sb-&gt;gid;
    my $xusr = $mode &amp; S_IXUSR;
    my $xgrp = $mode &amp; S_IXGRP;
    my $xoth = $mode &amp; S_IXOTH;

    if ($suid) {
	if ($xoth) {
	    # suid, executable by all.
	    return 1;
	}
	elsif ($xgrp) {
	    # suid, executable by some group.
	    return 1;
	}
    }
    elsif ($sgid) {
	if ($xoth) {
	    # sgid, executable by all.
	    return 1;
	}
	elsif ($uid != 0 and $xusr) {
	    # suid, executable by someone non-root.
	    return 1;
	}
    }
    return 0;
}

die "usage: $0 source... dest\n"
  if @ARGV &lt; 2;
my $dest = pop @ARGV;
my @source = @ARGV;
my $dest_abs = File::Spec-&gt;rel2abs($dest);
chdir $dest or die "cannot chdir to $dest: $!";
my %already;
foreach (glob '*') {
    if (/\A([0-9]+)[.].+\z/) {
	my $ino = $1;
	$already{$ino}++ &amp;&amp; warn "two files in $dest beginning $ino.\n";
	my $sb = lstat $_;
	warn("cannot lstat $dest/$_, skipping\n"), next if not $sb;
	if (not interesting $sb) {
	    warn "sadly, $_ no longer has useful permissions\n";
	}
    }
}
sub for_each_file {
    my $sb = lstat $_;
    warn("cannot lstat $File::Find::name, skipping\n"), return if not $sb;
    my $ino = $sb-&gt;ino;
    $already{$ino}++ &amp;&amp; return;
    return if not interesting $sb;
    my $link_to = "$ino.$_";
    say "$File::Find::name -&gt; $link_to";
    link $File::Find::name, "$dest_abs/$link_to"
      or warn "cannot link to $link_to: $!\n";
}
find \&amp;for_each_file, @source;

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295009/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor295066"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;delete()&quot; system call unnecessary ... for this case</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 20:59 UTC (Thu)
                               by <b>AnswerGuy</b> (guest, #1256)
                              [<a href="/Articles/295066/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>

 Actually the really savvy admin, or patch/fix script author, would perform  a sanity check on
files to be removed by the patch, opening it, fstat()ing  it, chmod() it to remove SUID/SGID
bits, unlink()ing it, and checking to ensure that the next fstat() returns a  link count of
zero.  If that fails (someone else has a hard link to it) then  over-write the file contents
with an program which does the following:

  * syslog()s the user and the command argument
  * optionally warns the user that they are attempting to use an out-dated version of the
program (and advising them against using hard links to system binaries in general?)
  * optionally wraps the new binary (execve()'s it) or exits


</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295066/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor295223"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2008 0:04 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/295223/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
Perhaps this indicates the need for a 'delete' system call which makes sure a file is really
gone
</blockquote>
<p>
You're talking about a fundamentally different file model, then.  Something like VMS, where directories are an independent layer above the flat filesytem.  Or like NTFS where files actually have names so you don't have a somewhat separate lookup facility (directory tree) for them.
<p>
Or even just a world where only one link to a file is allowed.
<p>
I think those would all be preferable to what we have, but if you're interested in something that can be compatibly glued on to what exists, then some kind of "delete" system call probably isn't better than just truncating the file to nothing.

      
          <div class="CommentReplyButton">
            <form action="/Articles/295223/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor295012"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 15:34 UTC (Thu)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/295012/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt;&gt;I find it a bit odd that a normal user can do things like this: ln /etc/shadow ~/myfile and
control where system files show up in the file system.</font>
&gt;
<font class="QuotedText">&gt; Not just odd, but a security problem too. </font>

This is why the package manager tool, that replaces the application, should first remove all
read/write/exec permissions from the file before unlinking it. This way the hardlink won't be
usable by the attacker anymore, as he can't execute it anymore.
A call to revoke() might be needed, too, to close all currently open mmap(). I'm not sure on
that for regular files...

I don't know whether apt/rpm actually do this.

But udev, for example, uses this to avoid attacks on /dev files.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295012/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor294930"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 7:20 UTC (Thu)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/294930/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
So how do other mail servers (qmail, for example) handle this situation? It seems like an
issue that is very difficult to pinpoint, but perhaps could have been avoided altogether by
more cautious design.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294930/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor294939"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 9:10 UTC (Thu)
                               by <b>tomgj</b> (guest, #50537)
                              [<a href="/Articles/294939/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      The examples for <tt>link(2)</tt> and <tt>symlink(2)</tt> currently both 
have 
the arguments the wrong 
way round.  You have 
<blockquote><pre>link("/link/to/foo", "/path/to/foo");</pre></blockquote> 
but it should be 
<blockquote><pre>link("/path/to/foo", "/link/to/foo")</pre></blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/294939/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor294946"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 9:17 UTC (Thu)
                               by <b>liljencrantz</b> (guest, #28458)
                              [<a href="/Articles/294946/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Interesting. I always though the ln command had the argument in the wrong order, and it turns
out that the link function switches the order...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294946/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor295882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2008 6:05 UTC (Thu)
                               by <b>SEMW</b> (guest, #52697)
                              [<a href="/Articles/295882/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Huh?  They both have the same order: the first argument is the target, and the second, the name of the new link being created, for both ln and link.<br>
<p>
(That said, I've always had a bit of a liking for dd-style syntax; means you don't have to remember the order at all.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/295882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor294975"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2008 12:21 UTC (Thu)
                               by <b>jake</b> (editor, #205)
                              [<a href="/Articles/294975/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; The examples for link(2) and symlink(2) currently both have the arguments</font>
<font class="QuotedText">&gt; the wrong way round.</font>

Gah!  Fixed now, thanks!

jake
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/294975/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor296575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Standards, the kernel, and Postfix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2008 18:35 UTC (Tue)
                               by <b>marm</b> (guest, #53705)
                              [<a href="/Articles/296575/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, the problem does not seem to be related to the behavior of the link() system call, but to the sole fact that it is possible to create a hard-link to a symlink. I do not see any verse of SUSv2 which would forbid that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/296575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2008, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
