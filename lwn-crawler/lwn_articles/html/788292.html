        <!DOCTYPE html>
        <html lang="en">
        <head><title>NFS topics [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/788292/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/787960/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/788292/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>NFS topics</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 14, 2019</br>
           <hr>
<a href="/Articles/lsfmm2019/">LSFMM</a>
</div>
<p>
Trond Myklebust and Bruce Fields led a session on some topics of interest
in the NFS world at the 2019 Linux Storage, Filesystem, and
Memory-Management Summit.  Myklebust discussed the intersection of NFS and
containers, as well adding TLS support to NFS.  Fields also had some
container changes to discuss, along with a grab bag of other areas that
need attention.
</p>

<p>
Myklebust began with TLS support for the RPC layer that underlies NFS.  One
of the main issues is how to do the upcall from the RPC layer to a
user-space daemon that would handle the TLS handshake.  There is <a
href="/Articles/666509/">kernel 
support for doing TLS</a> once the handshake is complete; hardware acceleration
of TLS was added in the last year based on code from Intel and Mellanox, he
said.  RPC will use that code, but there is still the question of handling
the handshake. 
</p>

<a href="/Articles/788295/">
<img src="https://static.lwn.net/images/2019/lsf-myklebust-sm.jpg" border=0 hspace=5
align="right" alt="[Trond Myklebust]" title="Trond Myklebust" width=191
height=300>
</a>

<p>
There are a few different options for the handshake.  It could use the same
kind of upcall that <a
href="http://man7.org/linux/man-pages/man8/rpc.gssd.8.html"><tt>rpc.gssd</tt></a>
does. That would require a daemon listening for handshake requests; once
the handshake is complete it would hand the connection back to the kernel
to use for the RPC traffic.
</p>

<p>
Another option would be to do something based on <a
href="http://man7.org/linux/man-pages/man7/netlink.7.html">netlink</a>. That
would be more generic, but is more appropriate to discuss with the
networking developers.  He plans to determine if those developers are
interested in using netlink for that and will fall back to using the
<tt>rpc.gssd</tt> approach if not.  He knows the latter works well with
containers and the types of applications in use.
</p>

<p>
For containers, he said that there are a fair number of patches going into
the kernel recently; more are queued up in Fields's and Anna Schumaker's
trees.
The main issue that still needs to be dealt with is how to handle user
namespaces, he said.  There are two problems there, the first is that the
NFSv4 ID mapper (<a
href="http://man7.org/linux/man-pages/man8/rpc.idmapd.8.html"><tt>rpc.idmapd</tt></a>)
has been using the keyring upcall interface, which does not support
user namespaces at all. The kernel has not been able to map the kernel user ID
(kuid) to the user ID inside the user namespace where <tt>rpc.idmapd</tt>
is running.  There are patches queued up to rectify that.
</p>

<p>
The other issue is which IDs get put on the wire. When using NFSv3 and some
configurations of NFSv4, raw user and group IDs are sent by clients to the
server.  Should those be the kernel user/group ID or those of the
container?  The plan is to use the IDs from inside the namespace, as there
is "no real point" in hiding them or translating them to something other
than what is seen in the container.
</p>

<p>
Fields asked if there were other container gaps that Myklebust knew of.  He
said that there is still an issue with DNS lookups from within a container,
because that also uses the keyring upcall interface.  That should be fixed,
but is 
not critical because it is not used for a lot of things.
</p>

<p>
The NFSv4 state in different containers should be different so tenants on
the same system don't share the same client ID, Fields said, and wondered
if that problem had been solved.  Myklebust said that many containers do
not set a hostname, which makes it difficult to determine what ID to use to
set up a lease when talking to the NFS server.  He has
looked into a way to create an ID in a generic way so that other
filesystems could also use it rather than doing something in an
NFS-specific daemon.
</p>

<p>
Chuck Lever asked if he was referring to "clientid4" (which is part of the
<a href="https://tools.ietf.org/html/rfc5661">NFSv4 protocol</a>).
Myklebust said that he was; he has something working using a udev upcall
into the container namespace, but hasn't yet published the patches.  It
will also be used for non-containerized NFS clients because there are a
number of Linux distributions that do not require setting a hostname.  That
leads to a lot of "localhost.localdomain" leases, which is not desirable.
The patches will require some cleanup, so it will be Linux&nbsp;5.3 or
later before they will be upstream.
</p>

<p>
At that point, Fields stepped up to the lectern.  There is some amount of
state that the server needs to store to track clients across server reboots
so that clients can reclaim their locks, he said.  The way that was being
done did not work well for containers, but that has been fixed, though
there are both kernel and user-space parts, so it may take a little while
for it all to roll out.
</p>

<a href="/Articles/788296/">
<img src="https://static.lwn.net/images/2019/lsf-fields-sm.jpg" border=0 hspace=5
align="right" alt="[Bruce Fields]" title="Bruce Fields" width=206
height=300>
</a>

<p>
He is concerned that the duplicate reply cache is global to the server,
which means that it is shared with all containers.  He is fairly certain
that malicious clients could snoop the cache, but it could also be a source
of bugs since clients could get the wrong cache entry.  Either creating
separate caches for each client or keying the cache entries using the
network namespace should take care of that problem.
</p>

<p>
Lever asked about containerizing the performance metrics for the server.
That does need to be looked at, Fields said.  Some of the metrics should be
global, but others may not.  What is needed is for more people to be
using NFS from containers because there may be more corner cases that need
to be handled, he said.
</p>

<p>
Server-to-server copy offload is something that is being worked on.  When
those patches were posted, Dave Chinner noticed some problems in the
filesystem and VFS layers; Chinner sent out patches to fix those problems,
but has not pushed them 
further, possibly due to lack of time.  It requires someone picking them
up and getting them upstream, Fields said.
</p>

<p>
Next up was delegations, which are a mechanism where the server can grant
exclusive read or write access to a client for a file.  Multiple clients
can have read delegation for a file, but if another client opens the file
for write the server needs to revoke any read delegations.  But if there is
only one client that has a read delegation and it is the one that writes to
the file, there is no need to revoke the delegation.
</p>

<p>
In order to
implement that, there is a need to track the client ID all the way through
the VFS. 
Trying to plumb that through all of the VFS was not realistic. The
second 
attempt, which was to put something in the task structure, was not popular
with other developers.  The latest
attempt is to use the thread-group ID (tgid).  In order to do that, he had
to make some small modifications to the kernel thread daemon (kthreadd) so
that the NFS daemon could run a private version to get all of its threads
into the same thread group.  Nobody seemed to have objections to that
approach, but he is not sure who is supposed to review code in that area.
</p>

<p>
Steve French asked about adding file attributes, such as those now
available using the <a
href="http://man7.org/linux/man-pages/man2/statx.2.html"><tt>statx()</tt></a>
system call, to the protocol.  There are some attributes that are being
considered as part of
the internet
draft, such as the archive bit, Lever said.  Others, like birth time,
have already been added to the specification, Myklebust said, so they could
be added 
to the Linux NFS implementation.
</p>

<p>
Ted Ts'o referred to the <a href="/Articles/784041/">support
for case insensitivity</a> that has recently been added for ext4.  He asked
if there is anything that needs to be done so that NFS can also use it.
Myklebust said there is work needed on both the NFS client and server in
order to support that.  He is waiting to see what lands in the kernel (the
feature was <a href="/Articles/787963/">merged for Linux&nbsp;5.2</a> after
LSFMM) before looking into all that needs to be done.  He said that there
will at least be 
changes needed for file name lookups and in managing the directory entry
cache (dcache). 
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-NFS">Filesystems/NFS</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2019">Storage, Filesystem, and Memory-Management Summit/2019</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/788292/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
