        <!DOCTYPE html>
        <html lang="en">
        <head><title>How useful should copy_file_range() be? [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/846403/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/846636/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/846403/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>How useful should copy_file_range() be?</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 18, 2021</br>
           </div>
The <a
href="https://man7.org/linux/man-pages/man2/copy_file_range.2.html"><tt>copy_file_range()</tt>
system call</a> looks like a relatively straightforward feature; it allows
user space to ask the kernel to copy a range of data from one file to
another, hopefully applying some optimizations along the way.  In truth,
this call has never been as generic as it seems, though some changes made
during 5.3 helped in that regard.  When the developers of the Go language
ran into problems with <tt>copy_file_range()</tt>, there ensued a lengthy
discussion on how this system call should work and whether the kernel needs
to do more to make it useful.
<p>
The definition of <tt>copy_file_range()</tt> is:
<p>
<pre>
    ssize_t copy_file_range(int fd_in, loff_t *off_in,
                            int fd_out, loff_t *off_out,
                            size_t len, unsigned int flags);
</pre>
<p>
Its job is to copy <tt>len</tt> bytes of data from the file represented by
<tt>fd_in</tt> to <tt>fd_out</tt>, observing the requested offsets at both
ends.  The <tt>flags</tt> argument must be zero.  This call first <a
href="/Articles/659523/">appeared</a> in the 4.5 release.  Over time it
turned out to have a number of unpleasant bugs, leading to a long series of
fixes and <a href="/Articles/774114/">some significant grumbling</a> along
the way.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
In 2019 Amir Goldstein <a href="/Articles/789527/">fixed more
issues</a> and, in the process, removed a significant limitation: until
then, <tt>copy_file_range()</tt> refused to copy between files that were
not located on the same filesystem.  After this patch was merged (for 5.3),
it could copy between any two files, falling back on <a
href="https://man7.org/linux/man-pages/man2/splice.2.html"><tt>splice()</tt></a>
for the cross-filesystem case.  It appeared that <tt>copy_file_range()</tt>
was finally settling into a solid and useful system call.
<p>
Indeed, it seemed useful enough that the Go developers decided to use it
for the <a href="https://golang.org/pkg/io/#Copy"><tt>io.Copy()</tt>
function</a> in their standard library.  Then they ran into a problem:
<tt>copy_file_range()</tt> will, when given a kernel-generated file as
input, copy zero bytes of data and claim success.  These files, which
include files in <tt>/proc</tt>, tracefs, and a large range of other virtual
filesystems, generally indicate a length of zero when queried with a system
call like <a
href="https://man7.org/linux/man-pages/man2/stat.2.html"><tt>stat()</tt></a>. 
<tt>copy_file_range()</tt>, seeing that zero length, concludes that there
is no data to copy and the job is already done; it then returns success.
<p>
But there is actually data to be read from this kind of file, it just doesn't
show in the 
advertised length of the file; the real length often cannot be known before
the file is actually read.
Before 5.3, the prohibition on cross-filesystem copies would have caused
most such attempts to return an error code; afterward, they fail but appear
to work.  The kernel is happy, but some users can be surprisingly stubborn
about actually wanting to copy the data they asked to be copied; they were
rather less happy.
<p>
<h4>Marking virtual filesystems</h4>
<p>
Nicolas Boichat tried to mollify those users with <a
href="/ml/linux-kernel/20210212044405.4120619-1-drinkcat@chromium.org/">this
patch set</a> to <tt>copy_file_range()</tt>.  It added a flag
(<tt>FS_GENERATED_CONTENT</tt>) to the <tt>file_system_type</tt> structure
for virtual filesystems where the length of the files cannot be known in
advance.  <tt>copy_file_range()</tt> would then look for that flag and
return an error code when it was found; the error return would cause
<tt>io.Copy()</tt> to fall back to a manual copy operation.  This change
appeared to solve the immediate problem, but it is not destined to be
merged into the mainline.
<p>
There were a few objections, starting with the fact that it requires all
virtual filesystems to be specially marked.  The patch set did not mark
them all, and this mechanism would require that developers be sure to mark
all future filesystems as they were added.  As Greg Kroah-Hartman <a
href="/ml/linux-kernel/YCY+Ytr2J2R5Vh0+@kroah.com/">put it</a>: "<q>That
way lies madness and constant auditing that I do not see anyone signing up
for for the next 20 years</q>".
<p>
The bigger question, though, was whether this behavior should be seen as a
bug at all.  Boichat described it as a regression; code that would fall
back to a normal copy before 5.3 would silently fail to copy data
thereafter.   Kroah-Hartman was unsure, though; he continued:
<p>
<div class="BigQuote">
	Why are people trying to use copy_file_range on simple /proc and
	/sys files in the first place?  They can not seek (well most can
	not), so that feels like a "oh look, a new syscall, let's use it
	everywhere!"  problem that userspace should not do.
</div>
<p>
Dave Chinner was, if anything, <a
href="/ml/linux-kernel/20210212230346.GU4626@dread.disaster.area/">less
sympathetic</a>:
<p>
<div class="BigQuote">
	It is a targeted solution for *regular files only* on filesystems
	that store persistent data and can accelerate the data copy in some
	way (e.g.  clone, server side offload, hardware offload, etc). It
	is not intended as a copy mechanism for copying data from one
	random file descriptor to another.
<p>
	The use of it as a general file copy mechanism in the Go system
	library is incorrect and wrong. It is a userspace bug.  Userspace
	has done the wrong thing, userspace needs to be fixed.
</div>
<p>
The problem with this attitude, as described
by Go developer Ian Lance Taylor, is that figuring out when
<tt>copy_file_range()</tt> can be used is not easy; he <a
href="/ml/linux-kernel/CAKOQZ8zPFM29DYPwbnUJEhf+a8kPSJ5E_W06JLFjn-5Fy-ZWWw@mail.gmail.com/">pointed
out</a> that these limitations are not mentioned in the
<tt>copy_file_range()</tt> man page, and
<a
href="/ml/linux-kernel/CAOyqgcVTYhozM-mwc400qt+fabmUuBQTsjqbcA03xDooYXXcMA@mail.gmail.com/">argued</a> that this behavior reduces the
utility of the system call considerably:

<p>
<div class="BigQuote">
	From my perspective, as a kernel user rather than a kernel
	developer, a system call that silently fails for certain files and
	that provides no way to determine either 1) ahead of time that the
	system call will fail, or 2) after the call that the system call
	did fail, is a useless system call.  I can never use that system
	call, because I don't know whether or not it will work.
</div>
<p>
Chinner <a
href="/ml/linux-kernel/20210212232726.GW4626@dread.disaster.area/">said</a>
that the test is whether it is possible to tell whether a file has data in
it without calling <tt>read()</tt> on it.  But Darrick Wong, hardly a
filesystem amateur, <a
href="/ml/linux-kernel/20210212235448.GH7187@magnolia/">replied</a>:
"<q>I don't know how to do that, Dave.&nbsp;:)</q>"  There is another fun
twist, as Boichat <a
href="/ml/linux-kernel/CANMq1KDv-brWeKOTt3aUUi_1SOXSpEFo5pS5A6mpRT8k-O88nA@mail.gmail.com/">pointed
out</a>: files in sysfs, rather than indicating a zero length, claim to be
4,096 bytes long — regardless of their true length, which may be larger or
smaller than that.  Chinner's test will fail on those files, even if it can
be reliably carried out.
<p>
<h4>Toward a real fix</h4>
<p>
Wong went on to express agreement with the Go developers:
<tt>copy_file_range()</tt> should either work as expected or return an
error so that user space can know to fall back to copying the old-fashioned
way.  He also suggested a couple of ways to possibly fix the problem, the
first of which was to go back to the previous state of affairs, where
cross-filesystem copies were explicitly disallowed.  Failing that, one
could restrict such copies to a single filesystem type that has explicit
support for them.  Luis Henriques <a
href="/ml/linux-kernel/20210215154317.8590-1-lhenriques@suse.de/">implemented
a variant of that idea</a>, where copies across filesystems would still be
allowed if the two filesystems were of the same type, and if the filesystem
involved explicitly implements the <tt>copy_file_range()</tt> operation.
<p>
That patch was stopped in its tracks, though, after Trond Myklebust <a
href="/ml/linux-kernel/92d27397479984b95883197d90318ee76995b42e.camel@hammerspace.com/">pointed
out</a> that the kernel's NFS daemon uses the <tt>copy_file_range()</tt>
mechanism to copy files between filesystems of different types.  Blocking
that would break some important functionality; this usage pattern exists in
other filesystems, such as Ceph and FUSE, as well.  In
response to that, Henriques <a
href="/ml/linux-kernel/87r1lgjm7l.fsf@suse.de/">added a new flag</a>
(<tt>COPY_FILE_SPLICE</tt>) that could be used within the kernel to
indicate that a cross-filesystem-type copy should be performed.  There was
some question of whether this flag should be made available to user space
for cases when it somehow knows that the operation would succeed, but it
seems that will not happen.
<p>
A final version of this patch has not been posted as of this writing, but
the eventual shape of the fix seems clear.  When called from user space,
<tt>copy_file_range()</tt> will only try to copy a file across filesystems
if the two are of the same type, and if that filesystem has explicit
support for the system call (and, thus, is presumably written with all of
the possible cases in mind).  Otherwise, the call will fail with an
explicit error, so user space will know that it must copy the data some
other way.  So <tt>copy_file_range()</tt> will never be a generic file-copy
mechanism, but it will at least be possible to use robustly in code that is
prepared for it to fail.
<p>
There is still one more trap lurking within <tt>copy_file_range()</tt>,
though.  Like most I/O-related system calls, <tt>copy_file_range()</tt> can
copy fewer bytes than requested; user space needs to check the return value
to see how much work was actually done.  There is currently no way to
distinguish between copies that were cut short on the read side (by hitting
the end of the file, perhaps) and those that were stopped on the write side
(which may well indicate a write error).  Nobody has come up with a real
solution to that problem yet.
<p>
All of this goes to show how a seemingly simple interface can quickly
become complex.  <tt>copy_file_range()</tt> has revealed a number of sharp
edges over its relatively short existence; there may well be more yet to be
found.  It is thus perhaps unsurprising that the kernel developers, having
been burned more than once, feel a strong desire to keep its implementation
as simple as possible.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-copy_file_range">System calls/copy_file_range()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/846403/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor846642"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 15:44 UTC (Thu)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/846642/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m not sure adding the ability to report if the sort copy was due to the read or the write is really worth while.<br>
<p>
However if that was really desired: I  imagine a fairly simple way to do that is: add a flag, something like CFR_UPDATE_OFF_SIZE. Setting it would make the kernel update the loff_t&#x27;s (pointed to  by off_in and off_out) with the bytes read/written correspondingly. Userspace can easily tell which side failed then. If the two sides are equal, it was a  read size failure, if the read side is greater, it was a write failure. Note that it is a logic error is the write size were to be greater than the read size.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846642/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846643"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 15:48 UTC (Thu)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/846643/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Never mind, failed to re-read the man page before commenting. Seems the kernel already does this.<br>
<p>
So either the author was mistaken and it&#x27;s not actually an issue, or the kernel doesn&#x27;t update the read-size loff_t when there is a write failure, in which case the flag would just change this behavior<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846643/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846655"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 16:43 UTC (Thu)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/846655/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As I understand the man page, the offsets are adjusted by the number of bytes copied. So if you read n bytes and only write m&lt;n bytes, then both offsets are adjusted by m.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846655/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor846648"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 16:36 UTC (Thu)
                               by <b>zuzzurro</b> (subscriber, #61118)
                              [<a href="/Articles/846648/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Isn&#x27;t the problem caused by the fact that we have in the systems files that pretend to be files but don&#x27;t really behave like ones? If that&#x27;s the case, in the good old days people would create a new file type and flag them as such (p for named pipes, m for multiplexed files, s for sockets). So that useland would not assume that the normal file behaviour was available.<br>
I guess it&#x27;s too late to do the same anymore...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846648/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 16:41 UTC (Thu)
                               by <b>zuzzurro</b> (subscriber, #61118)
                              [<a href="/Articles/846654/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What if these &quot;non seekable&quot; files were simply flagged as named pipes?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 18:38 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/846672/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Some of these /proc files are quasi-seekable IIRC, in that they return an offset which indicates your read position but which does not correspond to the character count from beginning-of-file to wherever you were when you called lseek(fd,SEEK_CUR).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846878"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2021 12:16 UTC (Sat)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/846878/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looking at the POSIX description for the lseek(2) POSIX-C function, it is required to operate in terms of bytes.<br>
<p>
I am not getting that with the /proc/self/sched file (uses `seq_lseek`, which operates in terms of records). Is sys_llseek *meant* to be POSIX-compatible?<br>
If yes, it&#x27;s a kernel bug.<br>
If no, then it&#x27;s a libc bug because it failed to provide/emulate POSIX semantics on top of an (unposixy) kernel interface.<br>
So, which is it, where should I file a bug?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846878/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2021 14:45 UTC (Sat)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/846888/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Those fake kernel files don&#x27;t have POSIX semantics, period. Their reported size doesn&#x27;t correspond to the number of readable bytes, if they&#x27;re writeable you can&#x27;t just write &#x27;1&#x27; and then &#x27;23&#x27; when you intend to write &#x27;123&#x27;, and so on.<br>
<p>
So the bug is on the user. If you treat these things like ordinary files and expect all the posicky corner cases to work &quot;correctly&quot;, you&#x27;re SOL. These files will never have POSIX semantics. No, you can&#x27;t use libc to emulate it. Deal.<br>
<p>
Yes there should be a way to ask the kernel whether a file conforms to 100% posix. Well, we don&#x27;t have that. Deal.<br>
<p>
One possible workaround is to check the file size. If it&#x27;s smaller than pagesize*4 or so then it&#x27;s probably cheaper to copy its data the old-fashioned way anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor846894"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2021 17:01 UTC (Sat)
                               by <b>markh</b> (subscriber, #33984)
                              [<a href="/Articles/846894/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The bug is that the kernel is reporting it as a regular file (in st_mode), but then does not satisfy the requirements for regular files.  If the kernel does not want to satisfy those requirements, all that is needed is to report it as a type of file that does not have the requirements that it cannot satisfy.  It is not reasonable to expect userspace programs to somehow guess that a file reported as a regular file cannot be relied upon to behave as such.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846894/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor847179"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2021 19:02 UTC (Tue)
                               by <b>jsmith45</b> (guest, #125263)
                              [<a href="/Articles/847179/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Very true. The problem is that there is almost certainly a bunch of programs out there that will break if the file types of /proc pseudofiles changes to be anything but a normal file. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/847179/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor847320"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2021 11:12 UTC (Thu)
                               by <b>zuzzurro</b> (subscriber, #61118)
                              [<a href="/Articles/847320/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given the amount of confusion that is visible in the thread where kernel programmers are trying to find the best way to fix this I find it sad that people have tried to just throw the issue off to the userland.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/847320/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor846799"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 17:33 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/846799/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If they are unwilling to flag the filesystem as a whole as FS_GENERATED_CONTENT, I can&#x27;t imagine they will be eager to flag *each individual file* with something else.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846799/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor846662"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 17:31 UTC (Thu)
                               by <b>dezgeg</b> (subscriber, #92243)
                              [<a href="/Articles/846662/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There were objections to the FS_GENERATED_CONTENT flag due to &quot;madness and constant auditing&quot;... but how many such virtual filesystem types that need the flag actually exist, besides the 4 touched in the patchset? Is that really a number that one cannot count with fingers?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846662/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor846670"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 18:24 UTC (Thu)
                               by <b>Deewiant</b> (subscriber, #97394)
                              [<a href="/Articles/846670/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Rust&#x27;s standard library has been using copy_file_range for years. Though apparently a fix for these kinds of issues landed only six months ago: <a href="https://github.com/rust-lang/rust/commit/4ddedd521418d67e845ecb43dc02c09b0af53022">https://github.com/rust-lang/rust/commit/4ddedd521418d67e...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846670/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846678"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 19:21 UTC (Thu)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/846678/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looks like others can just port the Rust fix.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846678/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 22:37 UTC (Thu)
                               by <b>drinkcat</b> (subscriber, #106553)
                              [<a href="/Articles/846713/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That workaround should work in most cases. But another tricky thing with copy_file_range is that in case of partial writes, it&#x27;s supposed to be able to seek in the input file (which is not usually possible on generated files).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846723"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 23:49 UTC (Thu)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/846723/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps I&#x27;m missing something, but I thought that for the generated files, the call always transfers 0 bytes, and the Rust patch immediately falls back when it sees this.  So how is seeking an issue?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846723/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846727"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 0:17 UTC (Fri)
                               by <b>drinkcat</b> (subscriber, #106553)
                              [<a href="/Articles/846727/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah... except for sysfs files that report a size of 4096 bytes, copy_file_range would appear to work on these.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846727/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor846739"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 7:14 UTC (Fri)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/846739/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      The Go implementation works on file descriptors, not files. Full userspace emulation of <code>copy_file_range</code> is very hard: append-only output files, non-seekable input files that cannot restore the correct input read position after an output failure, other error conditions that are not recoverable because system calls fail during rollback. If it's difficult for the kernel, it's probably hard for userspace, too.

<p>If you can just close the descriptors and report an error (because the function opened them locally), these issues do not apply.
      
          <div class="CommentReplyButton">
            <form action="/Articles/846739/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846741"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 7:32 UTC (Fri)
                               by <b>Deewiant</b> (subscriber, #97394)
                              [<a href="/Articles/846741/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The current code in Rust does seem to handle arbitrary fds too. It&#x27;s all here, but there&#x27;s a lot of code to read through (which supports your point that it&#x27;s difficult): <a href="https://github.com/rust-lang/rust/blob/7647d03c33339bd85a1665047b22ae7e800fee98/library/std/src/sys/unix/kernel_copy.rs">https://github.com/rust-lang/rust/blob/7647d03c33339bd85a...</a><br>
<p>
Looks like it starts by checking the underlying file type (with a stat() if necessary) and only tries copy_file_range on regular files of nonzero size (lines 122 and 168; and 284 and 469 for the logic leading to the stat() itself), while still falling back to other methods if copy_file_range only copied zero bytes (lines 175 and 563). Overall there seems to be a lot of logic around keeping track of what was actually written vs. what was reported by the syscalls.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846741/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846816"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 18:55 UTC (Fri)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/846816/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I see, there is a different code path that reaches the <code>copy_file_range</code> system call.

<p>On the other hand, it is still deeply nested within the library, and it is not immediately obvious whether the callers of the universal copy routines expect consistent file offsets on errors. For a function that is directly modeled on the system call (which seems to be the case for Go), predictable file offset behavior seems quite important.
      
          <div class="CommentReplyButton">
            <form action="/Articles/846816/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor846813"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 20:29 UTC (Fri)
                               by <b>the8472</b> (guest, #144969)
                              [<a href="/Articles/846813/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>You're looking at the linux implementation for <a rel="nofollow" href="https://doc.rust-lang.org/std/io/fn.copy.html">io::copy</a> which can copy arbitrary readers to writers but specializes to various syscalls when types wrapping file descriptors of unknown type are passed, hence the complexity.</p>

<p>There also is <a rel="nofollow" href="https://doc.rust-lang.org/std/fs/fn.copy.html">fs::copy</a> which shares some code but has fewer cases to cover and does fewer checks before invoking <code>copy_file_range</code> since it's only meant to copy entire regular files.</p>

<p>The relevant parts are <a rel="nofollow" href="https://github.com/rust-lang/rust/blob/7647d03c33339bd85a1665047b22ae7e800fee98/library/std/src/sys/unix/fs.rs#L1205-L1221">here</a> and <a rel="nofollow" href="https://github.com/rust-lang/rust/blob/7647d03c33339bd85a1665047b22ae7e800fee98/library/std/src/sys/unix/kernel_copy.rs#L549-L597">here</a></p>. Note that it doesn't use stat information to decide what to do in the <code>fs::copy</code> case, it just tries <code>copy_file_range</code> and then falls back in various cases, including 0 byte reads.
      
          <div class="CommentReplyButton">
            <form action="/Articles/846813/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor862375"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2021 12:57 UTC (Sat)
                               by <b>jaykrell</b> (guest, #153190)
                              [<a href="/Articles/862375/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The bug is that /proc exists at all.<br>
This data should be retrieved through strongly typed special purpose function calls.<br>
Or at least, perhaps, allow open, for a hierarchical namespace, but not read, and reveal all information via ioctl.<br>
<p>
Not everything is a file!<br>
<p>
In fact, most things are not a file.<br>
Is the screen a file?<br>
Is the keyboard a file?<br>
Are sockets files? They have read/write, but how about seek and mmap?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/862375/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor862387"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2021 13:54 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/862387/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Those things are not files, but allowing userspace to treat them as file-like for the simplest common use case (sequential I/O) is one of the things that contributed to Unix eating most of the rest of the server operating system industry&#x27;s breakfast, lunch, dinner, and face.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/862387/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor862414"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2021 21:48 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/862414/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Or at least, perhaps, allow open, for a hierarchical namespace, but not read, and reveal all information via ioctl.</font><br>
Windows NT tried that. It failed miserably.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/862414/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor862418"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How useful should copy_file_range() be?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2021 23:16 UTC (Sat)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/862418/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Is the screen a file?</font><br>
<font class="QuotedText">&gt;Is the keyboard a file?</font><br>
<p>
You&#x27;re being facetious, but it&#x27;s occasionally very useful to be able to do things like check which port a monitor is plugged in on or framedump the console on a server using only ssh.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/862418/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
