        <!DOCTYPE html>
        <html lang="en">
        <head><title>Handling ARM architecture changes [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/606238/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/605743/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/606238/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Handling ARM architecture changes</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 23, 2014</br>
           </div>
Current Linux systems running on x86 processors will run binary programs
created in the 1990s.  A strong focus on not breaking the user-space ABI
deserves much of the credit for this state of affairs, but there is another
factor at play: the x86 hardware architecture has also been managed with an
eye toward keeping old executables working.  The ARM architecture is
different, though; it evolves in ways that will prevent some older
applications from running properly (or at all).  That presents a challenge
for kernel developers, who do not want to break applications but who also
want to keep the kernel maintainable in the long term.
<p>
Recently, Colin Cross (of Google) <a href="/Articles/606240/">raised an
issue</a> for consideration.  The ARM architecture is occasionally put
through a major revision, the latest of which is ARMv8.  This version adds
64-bit support, 
among other things; it also provides compatibility support for applications
built for older versions of the architecture. But that compatibility only
goes so far; it lacks, in particular, support for the <tt>SWP</tt>
instruction (which performed an atomic read-modify-write operation), the
<tt>SETEND</tt> instruction (used for changing the endianness of data
accesses), and certain types of
barriers.  This lack of support is not surprising; these features were all
deprecated in v6 or v7 of the ARM architecture.  ARM is following a
well-established schedule in its removal of these instructions.
<p>
The problem, of course, is that there are applications out there that are
still using those instructions.  Any application that is built today should
be free of deprecated instructions, but there are plenty of applications
sitting in the dustier corners of the Google Play Store that have not been
built recently, and which, perhaps, will never be rebuilt again.  As things
stand, if a user loads such an application onto an ARMv8 device, it will
fail to run.  That runs counter to the plan that ARMv8-based Android
devices are expected to be compatible with existing applications.
<p>
The solution to the problem seems straightforward enough: the kernel can trap
attempts to use the deprecated instructions and emulate them.
Applications using those instructions will then continue to run, though
they will run more slowly than they otherwise would.  Colin asked if the kernel community
would be willing to accept a set of patches implementing this emulation.
The alternative, he said, was for Google to maintain the patches in a
separate tree that all Android vendors would use; in this case, the
mainline kernel would fail the Android compatibility test suite.
<p>
Given the importance of Android in the ARM world, one would think that
there would be little opposition to keeping the kernel compatible in this
way.  But ARM developer Will Deacon <a href="/Articles/606244/">expressed
his opposition</a> to the idea, complaining that, once emulation for
instructions like <tt>SWP</tt> goes in, it will have to be maintained for a
long time.  He also argued that use of <tt>SWP</tt>, in particular, almost
certainly indicates a bug in the application.  It would be better, he said,
to keep this code out of the kernel and to simply fix the affected
applications.
<p>
Catalin Marinas <a href="/Articles/606246/">added</a> that anybody moving
to an ARMv8 device is going to have to download all their applications from
the store anyway.  In his mind, Google should push to get older
applications rebuilt so that, when users download them on their shiny new
ARMv8 devices, they will simply work.  But Grant Likely <a
href="/Articles/606247/">objected</a> to this reasoning, saying that
forcing developers to rebuild applications makes the platform as a whole
more hostile.  Also, he said, many of those older applications may no
longer have a functioning company or developer behind them; getting them
rebuilt may simply not be possible.  But they work well enough now, and
should not be broken.
<p>
After some back-and-forth, the conversation seemed to reach a point where
most developers agreed that breaking existing applications is not a good
thing.  How that will translate into patches going into the mainline kernel
is not yet entirely clear, though.  The developers also reiterated the
usual rule about backward compatibility: it is, in fact, perfectly fine to
remove support for deprecated features as long as nobody is actually using
that support.  Given that ARM is likely to continue deprecating hardware
features in the future, kernel developers are going to have to find a way
to minimize support for deprecated features going forward.  Nobody wants to
turn the kernel into an emulator for all older versions of the ARM
architecture.
<p>
To that end, Catalin put forward <a href="/Articles/606249/">a proposed
timeline</a> for how to deal with deprecated features in general.  The
first step happens as soon as a feature has been deprecated in the
hardware, but while current hardware still supports it.  That is
when the kernel community needs to find ways of calling attention to the
deprecated 
feature and encouraging developers to move away from it.  In particular,
the right way to replace the deprecated feature should be worked out and
publicized. 
<p>
Step two comes about in the next hardware version, where, by ARM's normal
practice, the deprecated 
feature is still available but can be explicitly disabled.  At this point,
the kernel will disable 
such features and emulate them in software; warnings will be emitted when
the deprecated features are used by applications.  Everything will continue
to work (though maybe more slowly).  There is one challenge here, in that
it can be hard to get anybody to see kernel warnings on a mobile device;
users tend not to read the log files often, if, indeed, they have access to
the logs at all.  For this type of device, warnings may have to be
implemented at other levels; in the Play Store, for example.
<p>
In the third phase, another hardware revision has removed the feature
entirely.  At this point, Catalin says, the kernel should stop emulating
the instruction and, instead, deliver an illegal-instruction signal
(<tt>SIGILL</tt>) to the offending process.  The emulation code might
still be in the kernel, he said, but it should not be enabled by default.
Finally, in the fourth stage, the emulation support would be removed
altogether.
<p>
There appears to be widespread agreement in the ARM kernel community around
this set of rules for dealing with hardware deprecations.  There may,
however,  still
be some dissent over the issues at hand today.  It can be argued that the
<tt>SWP</tt> instruction, deprecated in ARMv6, should not yet be at stage
three because the effort to move users away from it was not made at an
appropriate level.  So, while some developers would still like to see
applications rewarded with <tt>SIGILL</tt> for using <tt>SWP</tt> on ARMv8,
it may be necessary to carry emulation for that instruction for a while
yet.
<p>
For ARM hardware features that are deprecated in the future, though, the
above timeline seems likely to be followed.  As long as the word gets out
to developers in time, there should, with luck, not be users of the
deprecated features remaining by the time the support is removed entirely.
That should help to keep the kernel maintainable as the hardware
architecture evolves.  But it will be disappointing to those who wish they
could carry forward applications from their old G1 phone and have them run
properly on future devices.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Architectures-Arm">Architectures/Arm</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-User-space_ABI">Development model/User-space ABI</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/606238/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor606402"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 5:15 UTC (Thu)
                               by <b>alkbyby</b> (subscriber, #61687)
                              [<a href="/Articles/606402/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps ARM should consider stopping practice of removing user-level features completely. What they are doing might be fine for mostly embedded uses of ARM's past. But with ARM moving into desktop and server they might want to keep more or less perfect backwards compat. Similar to what Intel and AMD do. IMHO.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606402/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor606403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 5:17 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/606403/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the problem is that developers are not consulting the kernel when they compile their code, this is something you need to get into the compilers, and since a lot of developers use old compilers (they think it's needed to be compatible with old systems), they aren't going to see the warnings.<br>
<p>
So the proposed schedule is no better than doing nothing, when hardware comes out that doesn't have the command, the application will die with an illegal instruction fault, that's actually better than the kernel killing it because the application will continue to run on older hardware even with new kernels.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606423"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 7:32 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/606423/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; and since a lot of developers use old compilers (they think it's needed to be compatible with old systems), they aren't going to see the warnings.</font><br>
<p>
So how do they support new systems?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606423/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606573"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 18:21 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/606573/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
they rely on backwards compatibility of those new systems<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606573/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor606557"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 16:28 UTC (Thu)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/606557/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You pretty much DO need to use older compilers to build compatible code.<br>
<p>
Do you have any idea how much of a pain it is to get new versions of GCC to build against old system libraries?<br>
<p>
I guess I am thinking specifically about C++ and libstdc++ support. It is possible plain old C works perfectly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606557/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606892"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2014 17:03 UTC (Mon)
                               by <b>eean</b> (subscriber, #50420)
                              [<a href="/Articles/606892/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
err, is using a new G++ with an older libstdc++ even supposed to work? I thought that wasn't supported. Or do you mean other C++ system libraries... like what?<br>
<p>
OTOH shipping a newer libstdc++ seems pretty painless.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606892/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606894"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2014 17:20 UTC (Mon)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/606894/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think it IS supported which is why it is so much of a pain to make it work.<br>
<p>
Say you want to build using a newer G++ that has working profile-generate / profile-use support but you don't want to require a new libstdc++. You have to hack stuff to get g++ to link the right libraries in its build script.<br>
<p>
You could ship a new libstdc++ but that is only good if you are shipping an entire application. If you are doing a library or a plugin then you have to work with the system libraries as they are.<br>
<p>
Plus, shipping all your own .so or DLL files is a waste of space and makes a mockery of the whole idea of shared libraries.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606894/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor607025"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 29, 2014 19:34 UTC (Tue)
                               by <b>jwakely</b> (subscriber, #60262)
                              [<a href="/Articles/607025/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; err, is using a new G++ with an older libstdc++ even supposed to work?</font><br>
<p>
No.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/607025/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor606405"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 5:50 UTC (Thu)
                               by <b>ttonino</b> (guest, #4073)
                              [<a href="/Articles/606405/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The behavior described here delivers no value to the user, compared to ignoring the problem. However, an 'deprecated instruction set' module gets created and maintained, and extensively tested. Which can then be more widely used for devices which lack the deprecated instructions.<br>
<p>
But I wonder: instruction sets being what they are, aren't they rather maintenance free, being hidden behind the trap handler?<br>
<p>
If the number of instructions does not matter, and only the trap handler will need updating, carrying around a long list of legacy instructions is not really a maintenance burden.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606405/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606723"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2014 21:21 UTC (Fri)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/606723/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I'm reading here is that the instructions are related to atomic instructions and memory barriers. This is probably related to the C memory model developed around 2011 where after much discussion they figured out the most relaxed model that still allowed useful programs.<br>
<p>
This talk discusses this: <a href="http://herbsutter.com/2013/02/11/atomic-weapons-the-c-memory-model-and-modern-hardware/">http://herbsutter.com/2013/02/11/atomic-weapons-the-c-mem...</a><br>
<p>
At this point ARM decided to toss all the broken/slow/incorrect instructions and just implement the standard C model.<br>
<p>
So I think the maintenance cost for the CPU is probably high since atomic instructions tend involve interaction with cache lines and memory, especially in SMP. That's not something you just tack on.<br>
<p>
Also, you could emulate it, but ISTM that if your spinlock code is going to trap to the kernel every spin, that's not going to be great for performance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606723/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606744"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2014 3:04 UTC (Sat)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/606744/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It was deprecated because it was too slow on embedded hardware and replaced by an LL/SC primitive. See <a href="http://www.doulos.com/knowhow/arm/Hints_and_Tips/Implementing_Semaphores/">http://www.doulos.com/knowhow/arm/Hints_and_Tips/Implemen...</a><br>
<p>
Interestingly LL/SC is a much stronger primitive than a simple atomic swap or even cmpxchg (x86 only has cmpxchg). Although I'm not sure how weak their LL/SC ops are (most LL/SC are pretty weak).<br>
<p>
This is all consistent with taking another look at their atomic support after the C11 and C++11 standards where released, but I'm pretty sure SWP was more than sufficient. It really just looks like it was a performance issue regarding memory latency. It's also a bonus that you can probably implement some lock-free algorithms using LDREX/STREX.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606744/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor606409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 6:00 UTC (Thu)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/606409/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's worth noting that instructions aren't arbitrarily removed from any instruction set. This only happens when a deprecation plan exists, and usually only affects infrequently used instructions. The transition to ARMv8 was a little different. v8 is very carefully designed for implementation efficiency. It would be wrong to think, though, that ARM would ever do something they hadn't carefully considered. Their architecture team are some of the most informed, most intelligent, and most wonderful people one is likely to meet anywhere.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor606417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 6:50 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/606417/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder whether it wouldn't make more sense to intercept and interpret the illegal instructions in user rather than kernel space?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606434"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 9:37 UTC (Thu)
                               by <b>cmarinas</b> (subscriber, #39468)
                              [<a href="/Articles/606434/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I tried suggesting user space handling (SIGILL is delivered with all the information needed) and it's suitable for Android's application launching model but the discussions were rather fundamental about whether the kernel should cover up deprecated/removed architecture features. I'm still strongly opposed to considering this an ABI breakage, especially in the SWP case where HWCAP_SWP is no longer advertised (but never checked by user code anyway).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606434/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor606550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 16:07 UTC (Thu)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/606550/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This emulatioon could happily appear when processing the apk with  Dalvik or ART -- especially if you're going to reprocess every apk from working with a Java-esque VM to native code when installing it (I'm looking at you, ART). It doesn't need to be a kernel thing and can be marked deprecated in the Android compat suite and then removed when the last app triggering the warming leaves the Play Store.<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor606421"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 7:26 UTC (Thu)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/606421/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How would one emulate the SETEND instruction? Wouldn't that also entail trapping all loads and stores larger than 1 byte, to do the endianness conversion?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606421/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606425"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 7:56 UTC (Thu)
                               by <b>arnd</b> (subscriber, #8866)
                              [<a href="/Articles/606425/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This one is not that hard: the kernel can normally change endianess of a user process, but it requires to trap into the kernel mode, whereas current architecture versions allow changing endianess without going into a higher privilege level.<br>
<p>
The ARMv8 architecture also allows implementations to be fixed-endian, so if anybody does that, those processors will not have an easy way to emulate setend.<br>
<p>
The other really hard feature to emulate is the "if-then" instructions that allows multiple following instructions to be executed conditionally.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606425/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606436"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 9:40 UTC (Thu)
                               by <b>cmarinas</b> (subscriber, #39468)
                              [<a href="/Articles/606436/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But note that big endian support is optional, so what do we do on a CPU that chose not to implement it at all?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606436/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 10:46 UTC (Thu)
                               by <b>arnd</b> (subscriber, #8866)
                              [<a href="/Articles/606440/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I mentioned that case above, and I think it's reasonable to hope we don't have to deal with it. Emulating setend on bi-endian armv8 hardware is obscure already, and we'd only do that if there are actual users that are impacted by it.<br>
<p>
I'm not aware of applications that actually run as big-endian user space with a little-endian kernel, because that's very hard to do (syscall ABI and all). If this exists in theory, that would be the same thing as running a hardfloat binary on an FPU-less CPU, or an iWMMX (xscale) binary on a standard ARM core.<br>
<p>
The only use case I know for calling setend otherwise is ARMv6-optimized code (memcmp in raspbian), but there is extremely little ARMv6-optimized code that is meant to be portable -- all general-purpose distros are either built for ARMv5 or ARMv7, and ARMv6 optimized builds tend to be made for a particular SoC. There is also a workaround that you can use for memcmp, using LD_PRELOAD.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor606422"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">not Java?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 7:31 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/606422/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I thought native code was the exception on Android?<br>
<p>
Anyway, trying to run binaries that were *compiled* in the 1990s and that no one can merely recompile today (!) does not sound like a very good idea in this Internet+malware day and age.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606422/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606427"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">not Java?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 7:59 UTC (Thu)
                               by <b>arnd</b> (subscriber, #8866)
                              [<a href="/Articles/606427/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Native code is common enough in Android apps that it's a significant problem for the adoption of MIPS and x86 Android devices, to the extent that they often ship with an ARM emulator.<br>
<p>
Compatibility with arm32 Android apps is seen as a major feature for arm64 CPUs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606427/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor606450"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">old libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 11:16 UTC (Thu)
                               by <b>nhippi</b> (subscriber, #34640)
                              [<a href="/Articles/606450/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
People only started seriously getting rid of swp around ~2010 when gas started emitting a warning about it (and compiling to thumb2 become more common). People using old libraries (like boost 1.49*) in their projects are still hitting it:<br>
<p>
<a href="http://www.rtsoft.com/forums/showthread.php?16636-Warning-swp-b-in-armabi-v7a-android-and-solve-it">http://www.rtsoft.com/forums/showthread.php?16636-Warning...</a><br>
<p>
Take an ignorant developer who uses and old copy of a library and doesn't care about warnings... they might still be uploading new packages to play store with swp. <br>
<p>
This needs to be attacked from multiple fronts:<br>
<p>
- change gas to emit an error instead of warning on swp from armv7+<br>
- get the gas patch into android NDK<br>
- error on deprecated instructions on play store uploads<br>
- spam developers of existing apps in play store about their use of deprecated instructions?<br>
- emulate swp until google reports that there is less than X apps in play store without swp.<br>
<p>
Just emulating in kernel won't solve the issue, but it still needs to be done - OEM's will do it anyways, and not having it mainline will be seen from OEM's a message that their needs are not taken seriously by mainline community.<br>
<p>
* I suspect game developers using boost are major source of swp as boost upgrades are often API incompatible so sticking to old version is tempting...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606450/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor606424"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 7:35 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/606424/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; There is one challenge here, in that it can be hard to get anybody to see kernel warnings on a mobile device; users tend not to read the log files often, if, indeed, they have access to the logs at all. For this type of device, warnings may have to be implemented at other levels; in the Play Store, for example.</font><br>
<p>
Indeed, the Play Store is already able to prevent the installation of new applications on old devices. Surely it could do the same thing, just the other way round?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606424/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606431"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 9:09 UTC (Thu)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/606431/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not all applications come through the Play Store. Users routinely pass .apk files around. Just read some of the forums at xda-developers.com and you will see. There are also applications that backup your installed applications as .apk files. They are very handy when switching phones.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606431/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606432"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 9:14 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/606432/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Not all applications come through the Play Store. Users routinely pass .apk files around. Just read some of the forums at xda-developers.com and you will see. </font><br>
<p>
I know that but: it's "xda-developers", not "xda-users".<br>
<p>
You cannot have your cake and eat it: if you pass .apk files around you are supposed to know what you are doing - everything is fine.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606432/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606653"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2014 9:29 UTC (Fri)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/606653/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Only the vast majority of people on xda-developers are NOT developers. Sorry, but nothing is fine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606653/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606711"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 25, 2014 19:01 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/606711/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Who is installing does not really matter. This is about installing something:<br>
- from a site which has "developers" in the name<br>
- with quite often a warning next to the .apk<br>
- off the official market / store =&gt; far away from the usual "incompatible with your device" warnings.<br>
<p>
This also requires going and finding in the security settings the box called "Unknown Sources".<br>
<p>
Not sure how many more signs you think are needed.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606711/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606824"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2014 13:37 UTC (Mon)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/606824/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I need none, of course. Just try not to get very upset when users say your stuff is "utter crap".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606824/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor606540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 15:29 UTC (Thu)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/606540/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Surely it could do the same thing, just the other way round?</font><br>
<p>
Of course. But to do so is' a unacceptable thing to do to people when it can be easily avoided. <br>
<p>
The sole purpose for any operating system or hardware is to run software. By forcing people to do things like rebuild binaries for OS upgrades diminishes the value of the OS. <br>
<p>
The more you do that the worse the OS is. <br>
<p>
----------<br>
<p>
Personally I think that they should be looking more at using something like a Qemu-based solution rather then attacking the problem at the OS kernel level. <br>
<p>
Qemu has various modes of launching applications. It is typically used for a 'full VM' with emulated hardware and such things, but it doesn't have to be like that. <br>
<p>
I expect, especially with a OS like android that does a sandboxed approach by default, that a sort of hybrid container approach is possible... that the application gets executed in the context of the main android OS, but the actual code for the app is executed via a thinly emulated cpu. That would accomplish the same sort of thing as emulating the instructions at the kernel level, but without having to place a permanent maintenance burden on the kernel developers. <br>
<p>
This sounds complicated, but I don't think it's really super weird or anything.  The kernel would detect that it's not native binary format and instead of treating it like a binary format it treats it like a interpreted program and uses qemu as the interpreter. That way the machine code just becomes another VM language like java or anything else that isn't 'native'.<br>
<p>
After all, differences in architectures is why we have VM stuff in the first place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606547"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 15:49 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/606547/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The sole purpose for any operating system or hardware is to run software. By forcing people to do things like rebuild binaries for OS upgrades diminishes the value of the OS. </font><br>
<font class="QuotedText">&gt; The more you do that the worse the OS is. </font><br>
<p>
The purpose of an OS is also to be a _sane base for modern, secure and maintained_ applications. Backward compatibility at all costs can be short-sighted; look for instance at the mess that Windows has become. Compare it to how MacOS very successfully migrated from one kernel to another, completely different one, and then again from one CPU architecture to another, every time maintaining backward compatibility *limited in time*.<br>
<p>
So there is a balance, nothing's ever black and white. Looks like the final solution is effectively a trade-off with different phases; neither one back compatibility extreme nor the other. Sounds about right - except the devil is always in the details.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606547/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor607224"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Play Store and compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 31, 2014 8:12 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/607224/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds a bit like IBM mainframes, if I understand them correctly ...<br>
<p>
Each new revision comes with an emulator for the previous one. To the extent that there are some very old apps that run on an emulator stack about 6 deep ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/607224/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor606455"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2014 12:21 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/606455/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can understand the position of not wanting to add these sort of hacks to the kernel, but there's already a pretty large (both figuratively and literally) precedent for doing so: the 387 emulator. Given the lack of outcry to remove that over the last 20 years or so, maybe emulating 3 instructions isn't as much of a maintenance burden as it's made out to be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606455/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor606738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2014 1:01 UTC (Sat)
                               by <b>jwarnica</b> (subscriber, #27492)
                              [<a href="/Articles/606738/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Especially when Google is essentially offering to do that work. There is going to be some infrastructure bits, trap handler, instruction loaders... They want this done in a way acceptable to the general kernel, but at least as I read this article would go it their own, if the stock kernel didn't want to do it.<br>
<p>
... and then the instructions. As someone else has pointed out, CPU instructions are pretty well defined things, so only ever touching that code once is not impossible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/606738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor622051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling ARM architecture changes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 19, 2014 19:32 UTC (Wed)
                               by <b>rob.rdj</b> (guest, #99872)
                              [<a href="/Articles/622051/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know this is very late to contribute but I think it is worth pointing out that the emulation overhead incurred will often be completely invisible because each generation tends to run significantly faster than the previous one. Meaning that performance will not normally be a issue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2014, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
