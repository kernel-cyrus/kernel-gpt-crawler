        <!DOCTYPE html>
        <html lang="en">
        <head><title>Introducing maple trees [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/845507/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/845782/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/845507/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Introducing maple trees</h1>
</div>
<div class="ArticleText">
<div class="GAByline">
           <p>February 12, 2021</p>
           <p>This article was contributed by Marta Rybczyńska</p>
           </div>
<p>Seen from outside, the internals of the Linux kernel appear to be stable,
especially in subsystems like the memory-management subsystem. However,
from time to time, developers need to  replace an internal
interface to solve a longstanding problem. One such
issue is contention on the lock used to protect essential
memory-management structures, including the page tables and virtual memory areas
(VMAs). Liam Howlett and Matthew Wilcox have been developing a new
data structure, called a "maple tree", to replace the data structures
currently used for VMAs. This potentially big change in internal kernel
structures has been recently <a
href="https://lwn.net/ml/linux-mm/20210112161240.2024684-1-Liam.Howlett@Oracle.com/#t">posted</a>
for a review in a massive patch set.</p>

<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>Linux is a virtual-memory system. The address space for each process contains multiple
virtual memory areas represented by <a
href="https://elixir.bootlin.com/linux/v5.10.13/source/include/linux/mm_types.h#L306"><tt>vm_area_struct</tt></a>
structures. 
Each VMA represents a contiguous block of address space and represents a
range of memory of the same type, which may be anonymous memory (not
backed by a file), a memory-mapped file, or even device memory. A
virtual memory area, as seen from the process, is contiguous, while the
supporting physical memory may not be. In addition, the address
space contains holes between the VMAs; the
kernel fills those empty blocks (leaving space for unmapped "guard"
pages to catch buffer overflows) when it needs to add a new mapped
area, for example when loading a library or in a response to an <a
href="https://man7.org/linux/man-pages/man2/mmap.2.html"><tt>mmap()</tt></a>
call.</p>

<p>Almost anything one can do in the system involves memory, so the
operations 
on the structures representing the VMAs must be fast.  These
operations include lookups
(finding out which VMA corresponds to a given virtual address, finding
out if the memory is mapped, or locating an empty gap for a new memory
area), and modifications (growing a stack, for example).</p>

<p>VMAs are currently stored in a modified <a
href="/Articles/184495/">red-black
tree (rbtree)</a> with an additional, doubly-linked list that allows the
kernel to
traverse all of the VMAs in a process's address space. Kernel developers have been unhappy with this
data structure for some time, for a
number of reasons: rbtrees do not support ranges well, 
they are difficult to handle 
in a lockless manner (the balancing operation of the rbtree affects
multiple items at the same time), and rbtree traversal is
inefficient, which is why the additional linked list exists.</p>

<p>Operations on VMAs are protected by a lock
(specifically a reader/writer semaphore), which is
contained in <a
href="https://elixir.bootlin.com/linux/v5.10.12/source/include/linux/mm_types.h#L389"><tt>struct&nbsp;mm_struct</tt></a>. 
This lock was called <tt>mmap_sem</tt> until it was
<a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/include/linux/mm_types.h?h=v5.11-rc6&id=da1c55f1b272f4bd54671d459b39ea7b54944ef9">renamed</a>
to <tt>mmap_lock</tt>
for the 5.8 release in June 2020. This renaming was a part of an effort to wrap the lock
in an API, hoping to ease its replacement in the
future.</p>

<p>Users, especially those with threaded
applications in large systems, often experience contention on this
lock. The problem has been
discussed by kernel developers numerous times, with at least <a
href="/Articles/787629/">three sessions discussing it</a> at the
2019 Linux Storage, Filesystem, and Memory-Management 
Summit (LFSMM). The core of the problem is that the lock is required
for many operations, including almost anything involving page tables and VMAs.
There are other related structures that are effectively
protected by <tt>mmap_lock</tt>
(with the additional difficulty of lack of documentation of this
fact). In addition to splitting the unrelated
structures out from under <tt>mmap_lock</tt>, the developers were considering either
using a structure that would allow lockless access to the VMAs or
using some type of range lock. The maple tree was proposed as one of the
solutions at that time, but at that time it was in an early state of development and
the code was not available yet.</p>

<h4>Introducing maple trees</h4>

<p>Maple trees (the name might refer to the shape of the maple leaf,
leading in multiple directions)
differ in important aspects from rbtrees. They
belong to the <a
href="https://en.wikipedia.org/wiki/B-tree">B-tree</a> family, so
their nodes can contain more than two elements —
up to 16 elements in leaf nodes, or ten
elements in internal nodes. The use of B-trees also means that there
is less need to create new nodes, as nodes may include empty
slots that can be filled over time without additional allocations. 
Each node requires at most 256&nbsp;bytes, which is a multiple of popular cache line
sizes. The increased number of elements in a node and the
cache-aligned size means fewer cache misses when
traversing the tree.</p>

<p>The improved support for searching in maple trees also comes from the B-tree
structure. In a B-tree, each node holds keys, called "pivots",
that separate the node into subtrees. A subtree before a given key
contains only values lower or equal to the key, while subtree after the
key contains only values higher than the key (and lower than the next
key).</p>

<p>Of course, maple trees were designed to work in a lockless
manner, using read-copy-update (RCU). The maple tree is a generic structure
that can be used in different kernel subsystems; the first usage is
replacing the rbtrees and linked lists to manage VMAs. One of the 
authors, Liam Howlett, <a
href="https://blogs.oracle.com/linux/the-maple-tree">explained</a> the
reasons for the design in a blog post.</p>

<p>Maple trees offer two APIs: the simple one and the advanced one.
The simple API uses the <tt>mtree_</tt> prefix for its functions, with
the main structure, <tt>struct&nbsp;maple_tree</tt>, defined as follows:</p>
<p>
<pre>
    struct maple_tree {
	spinlock_t    ma_lock;
	unsigned int  ma_flags;
	void __rcu    *ma_root;
    };
</pre>
</p>

<p>The static initializers are <tt>DEFINE_MTREE(name)</tt> and
<tt>MTREE_INIT(name, flags)</tt>, with the latter taking a bitmask of flags from the
two defined currently. <tt>MAPLE_ALLOC_RANGE</tt>  indicates that the tree
will be used to allocate ranges and that it should manage gaps between the
allocations;  <tt>MAPLE_USE_RCU</tt> activates the RCU mode
for the case of multiple readers. Dynamic initialization is
possible with the same flags using <tt>mtree_init()</tt>: </p>
<p>
<pre>
    void mtree_init(struct maple_tree *mt, unsigned int ma_flags);
</pre>
</p>

<p>Developers can free the whole tree with:
<p>
<pre>
    void mtree_destroy(struct maple_tree *mt);
</pre>
</p>

<p>Three functions exist to add entries to the tree;
<tt>mtree_insert()</tt>, <tt>mtree_insert_range()</tt>, and
<tt>mtree_store_range()</tt>.  The first two functions only add an
entry if it does not previously exist, while the third function can overwrite
an existing entry. They are defined as follows:</p>
<p>
<pre>
    int mtree_insert(struct maple_tree *mt, unsigned long index,
	void *entry, gfp_t gfp);
    int mtree_insert_range(struct maple_tree *mt, unsigned long first,
	unsigned long last, void *entry, gfp_t gfp);
    int mtree_store_range(struct maple_tree *mt, unsigned long first,
	unsigned long last, void *entry, gfp_t gfp);
</pre>
</p>

<p><tt>mtree_insert()</tt> takes a pointer to
the tree <tt>mt</tt>, the integer key of the entry <tt>index</tt>, the
pointer to the entry <tt>entry</tt>, and the <a
href="https://elixir.bootlin.com/linux/v5.10.14/source/include/linux/gfp.h#L230">memory
allocation flags</a> 
<tt>gfp</tt> for new tree nodes (if needed).
<tt>mtree_insert_range()</tt> inserts a range from <tt>first</tt> to
<tt>last</tt> with the given data <tt>entry</tt>.
These functions
return zero on success, and a negative value otherwise, including
<tt>-EEXIST</tt> if the key already exists.
Finally, <tt>mtree_store_range()</tt> takes the same
arguments as <tt>mtree_insert_range()</tt>; the difference is that it
replaces any existing entries for the corresponding keys.</p>

<p>Two functions exist to get an entry from the tree or
remove an entry:</p>
<p>
<pre>
    void *mtree_load(struct maple_tree *mt, unsigned long index);
    void *mtree_erase(struct maple_tree *mt, unsigned long index);
</pre>
</p>

<p>To read an entry, the developer should use
<tt>mtree_load()</tt>, which takes a pointer to the tree <tt>mt</tt> and
the key of the requested value <tt>index</tt>. The function returns
a pointer to the entry, or NULL if the key was not found in the tree. The
same syntax is used to remove an entry from the tree using
<tt>mtree_erase()</tt>. It removes the given key from the tree and
returns the associated entry, returning NULL if no such value was
found.</p>

<p>There is more to the simple API than the above, including
<tt>mtree_alloc_range()</tt> to allocate a range from the key space.
The advanced API (which uses the <tt>mas_</tt> prefix) adds
iterator functions for the traversal of the whole tree, or
to access next
and previous elements using a state variable. With this fine-grained
control, developers can resume a search as needed. The API also
allows developers to find empty areas or duplicate the tree.</p>

<h4>Replacing the VMA rbtree (and more)</h4>

<p>The patch set contains more than just the introduction of maple
trees. It is worth noting that a big part of the set adds
and updates tests, a welcome addition given the impact
of the changes and the future importance of the new data
structure.</p>

<p>In the 70 patches in this set, maple trees are used to replace rbtrees in
all operations on VMAs, and one of the patches removes the usage
of rbtrees from VMAs. Another part of the patch set leads to the
removal of the VMA linked list. This removal requires modifications in
various places in the kernel code that were using the VMA list
directly: the architecture code, core dump and program loading
routines, some device drivers, and of course the memory-management
code. The patch set also <a
href="https://lwn.net/ml/linux-mm/20210112161240.2024684-20-Liam.Howlett@Oracle.com/">removes
the VMA cache</a> (which tracks the VMAs that are most recently accessed by
each process to speed lookup), as the implementation with maple trees is faster
and the cache is no longer needed.</p>

<p>The cover letter includes some performance results, which are somewhat hard
to interpret.  Some microbenchmarks show a performance increase,
and some (a
smaller number) a decrease. Kernel compilation time is 
similar to that with the vanilla 5.10
kernel, with a few more instructions executed (probably linked to
the added code). Howlett requested insights from developers into the
results.</p>

<h4>Current status and next steps</h4>

<p>Maple trees are currently at the RFC stage, with limitations; the
implementation does not support  32-bit systems or non-MMU
platforms, for example. However, the code is functional and kernel developers may
look into it to decide if it is the direction they want to go on the
quest of removing <tt>mmap_lock</tt> (as the lock was not removed in
this patch set). Based on the size of the patch set, it may
take time until the review is finished.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Maple_trees">Maple trees</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Rybczynska_Marta">Rybczynska, Marta</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/845507/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor846040"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2021 20:41 UTC (Fri)
                               by <b>zev</b> (subscriber, #88455)
                              [<a href="/Articles/846040/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
<pre>
struct maple_tree {
	spinlock_t    ma_lock;
	unsigned int  ma_flags;
	void __rcu    *ma_root;
};
</pre>
</blockquote>

I've been under the impression that this style of struct-member naming (with a common prefix specific to the containing struct type) was an artifact of coding around the limitations of prehistoric C compilers that didn't put struct members in a separate namespace.  Is there a particular reason to keep carrying the extra verbosity around in newly written code like this?
      
          <div class="CommentReplyButton">
            <form action="/Articles/846040/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2021 22:20 UTC (Fri)
                               by <b>Funcan</b> (subscriber, #44209)
                              [<a href="/Articles/846055/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve seen it justified as so that you don&#x27;t have to remember the type of the pointer when you&#x27;re reading code in some style guides<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2021 9:08 UTC (Mon)
                               by <b>metan</b> (subscriber, #74107)
                              [<a href="/Articles/846250/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve been avoiding such prefixes in my code but then I realized that prefixing members in certain cases makes the code easier to read. For example if you loop over a link list of structures the code is more readable when members are prefixed. Hence I do not frown upon prefixed structure members in generic structures and syscall API anymore.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor846058"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2021 22:35 UTC (Fri)
                               by <b>dave_malcolm</b> (subscriber, #15013)
                              [<a href="/Articles/846058/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW it&#x27;s used in CPython, where I find it useful for distinguishing what part of an object is what type for implementing inheritance in C.  See e.g. <a href="https://docs.python.org/3.10/c-api/typeobj.htmlwhere">https://docs.python.org/3.10/c-api/typeobj.htmlwhere</a> some fields are &quot;ob_&quot;-prefixed, some are &quot;tp_&quot;-prefixed, etc<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846058/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor846085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 4:56 UTC (Sat)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/846085/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The preprocessor doesn&#x27;t have any concept of namespaces. This form allows definition of compatibility macros when fields change shape, particularly useful to preserve userspace APIs. Separately, it&#x27;s juts a hell of a lot easier to grep. Sure there are semantic greps, but nothing as usable as grep itself.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 14:11 UTC (Sat)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/846103/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
grepability is such underrated feature. At work I deal with full Chromium code  and I often wished that C++ would not support function name overloading. Surely there are various indexer that supposed to help, but so far I have not find the one that works just as reliably with huge source trees as grep/grep/git grep, but grep is not particularly useful when everybody uses common short names.<br>
<p>
My ideal language will be one where within package/module all names should be unique including fields and methods and outside that all names should use a package prefix. Sadly modern language trends go to the opposite direction trying to minimize the number of keystrokes programmers use at the price of increased maintainability cost. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846109"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 14:48 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/846109/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Barring glob imports, don&#x27;t most module-using languages have this property (no, C++ won&#x27;t gain it; the module namespace is completely disjoint from the symbol namespace)? At least to the effect of putting you at the import statement of the file where package names can be factored out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846109/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846121"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 16:57 UTC (Sat)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/846121/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not if the language has object methods/properties.  If you have two unrelated classes Foo and Bar, and both define a &quot;to_string&quot; method, there&#x27;s no way for grep to know whether &quot;x.to_string()&quot; is referring to Foo::to_string or Bar::to_string.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846121/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846158"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 23:08 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/846158/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why would I care about uses of a trait/interface method on a given type using grep or something as naive as it? Given something like `print&lt;T&gt;()`&#x27;s implementation (which doesn&#x27;t care whether it is Foo or Bar being given to it), grep is already at a loss. You&#x27;d need to 1) know that print&lt;T&gt; uses to_string, 2) find callers of it, 3) match the caller type on your query, and 4) return the result *in* print&lt;T&gt; with a reference to the instantiator. Doing this across some external library&#x27;s API is just going to be untenable without something which *understands* the language. Or are you proposing that things like templated code, common interfaces, or the like are not supported by such a language?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846158/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2021 18:58 UTC (Sun)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/846205/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Common interfaces are OK since in practical cases I do not look for implementations of a a particular method for implementations of a particular interface. And those can be searched with grep by searching for the name of interface/abstract class. Plus any sensible code base would not use well-known names like to_string() to mean unrelated things.<br>
<p>
What is problematic is things like x.size() versus, say hypothetical x.vector::size() or even x.std::size() where size() is not a part of any interface. I have no troubles with a few classes named Settings as long as all usages is like namespace::Settings or at least the source file containing &quot;using namespace::Setting&quot; without opening the whole namespace. And that can be enforced with a linter. Sadly C++ method/field names are heavily overloaded and there is no good way to namespace them except by using explicit prefixes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846220"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2021 22:26 UTC (Sun)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/846220/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, this sounds more like a knock on C++&#x27;s decidedly weird ADL or other strange name lookup rules. Yes, for C++, one is just stuck with some kind of smarter, C++-aware querying engine. I have no idea what one does for code that is not in the current build (either via configure options or platform checks) with such a thing though. Luckily, I don&#x27;t know of any other language which has adopted such lookup rules (other than those importing C++ like Objective-C++).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846220/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2021 8:15 UTC (Mon)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/846240/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hm, I suppose in most languages with a notion of an object calling a method does not require a namespace prefix and typically there is no way to use one even if one wants to. And yes, ADL made the problem with C++ even worse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846275"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2021 14:31 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/846275/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW, Rust has the (awkward) `&lt;foo as Trait&gt;::conflated_name()` syntax for explicitly using a given trait&#x27;s method. This is only necessary if `foo` implements two traits (that are both &quot;visible&quot; within the scope) with the same method name. AFAIK, Rust won&#x27;t even try to use the signature to disambiguate, but instead error on the ambiguity of the name itself. I think such an approach avoids SFINAE from sneaking into the language, which I can only see as a good thing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846275/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor910226"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2022 22:51 UTC (Mon)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/910226/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Other languages do have the &quot;dead code not found&quot; problem. This tends to be resolved by having some kind of conditional compilation facility that still parses code, even in the &quot;dead&quot; branch.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/910226/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor846410"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2021 22:03 UTC (Tue)
                               by <b>JohnVonNeumann</b> (guest, #131609)
                              [<a href="/Articles/846410/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a funny comment, I&#x27;m about to start a new C++ course at Uni and was reading through the textbook and ran across function name overloading, I thought it sounded like a neat idea but figured it probably had a few issues. For you, is it just grepability that is the issue with FNO?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846410/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor846704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2021 22:17 UTC (Thu)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/846704/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I often wished that C++ would not support function name overloading.</font><br>
<p>
Function name overloading is essential for writing generic template functions. In a template function I can call DoSomething(var) where the type of var depends on the template parameters. How should I do this without function name overloading? If one considers operator overloading as a kind of function name overloading, template functions simply can&#x27;t work without it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846751"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2021 13:38 UTC (Fri)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/846751/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>There are more principled ways to support overloading than C++ uses; for example, Haskell has typeclasses, and Rust has traits, which provide the same functionality, but restrict the name lookup problem.
      
          <div class="CommentReplyButton">
            <form action="/Articles/846751/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor847464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2021 22:05 UTC (Thu)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/847464/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Creating a programming language based on the &quot;it&#x27;s turtles all the way down&quot; idiom.....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/847464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor910227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2022 22:55 UTC (Mon)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/910227/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
you can be more explicit about how names are resolved in various ways. The biggest problem c++ has here is some of the rules are _extremely_ surprising, such as pulling names from the scope of any type parameters of the function parameter list.<br>
<p>
Just getting rid of this helps, and some languages also let you &quot;open&quot; or &quot;close&quot; symbols to control if they are looked up in the definition or instantiation context.<br>
<p>
The other way people do this is to just group potential overloads under some named object (like rust traits).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/910227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor846161"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 23:25 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/846161/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It’s not just greppability, it’s general searchability period.  Without some full scale IDE, it’s pretty hard to find all the uses of “lock” when you mean specifically the lock in the maple tree structure.  But all the uses of ma_lock?  Oh, thank God, that’s easy with any tool, cscope, grep, vim, whatever.<br>
<p>
This is very much considered good practice in at least large C code bases in my experience.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846161/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846166"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2021 1:14 UTC (Sun)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/846166/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, for C yes. This makes complete sense. It&#x27;s the desire for a &quot;no two distinct things use the same name ever&quot; in a language I was more questioning.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846166/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor846969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 22, 2021 1:51 UTC (Mon)
                               by <b>ras</b> (subscriber, #33059)
                              [<a href="/Articles/846969/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Is there a particular reason to keep carrying the extra verbosity around in newly written code like this? </font><br>
<p>
grep.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor846088"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 7:48 UTC (Sat)
                               by <b>Otus</b> (subscriber, #67685)
                              [<a href="/Articles/846088/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; up to ten elements in leaf nodes, or 16 elements in internal nodes</font><br>
<p>
The cover letter has these the other way around:<br>
<p>
<font class="QuotedText">&gt; has a branching factor of 16 for leaf/non-alloc nodes and 10 for internal alloc nodes</font><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846088/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 19:34 UTC (Sat)
                               by <b>jake</b> (editor, #205)
                              [<a href="/Articles/846130/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The cover letter has these the other way around:</font><br>
<p>
indeed it does, fixed now, thanks.<br>
<p>
jake<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2021 9:49 UTC (Mon)
                               by <b>weberm</b> (guest, #131630)
                              [<a href="/Articles/846255/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm, the blog post ( <a href="https://blogs.oracle.com/linux/the-maple-tree">https://blogs.oracle.com/linux/the-maple-tree</a> section &#x27;the path forward&#x27; ) says the following:<br>
<p>
&quot;Leaves store up to 31 entries, which means the next/prev are almost always in the same node.<br>
<p>
Non-leaves have a branching factor of 10 when tracking gaps and 16 when not tracking gaps, while leaves have a branching factor of 31.&quot;<br>
<p>
Given the VMA use case would track gaps, that would mean 10 at non-leaves and .. 31 at leaves?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846265"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2021 12:43 UTC (Mon)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/846265/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The &#x27;31&#x27; is incorrect in that blog post.  We use 256-byte nodes and each entry uses an 8-byte pointer and an 8-byte pivot.  One 8-byte entry points to the parent so we can walk up the tree, leaving 31 entries for use.  The start index and end index of the node are implied by the parent&#x27;s pivots, meaning we can store 15 pivots and 16 pointers in each leaf entry.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846265/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor846122"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2021 17:10 UTC (Sat)
                               by <b>dougg</b> (guest, #1894)
                              [<a href="/Articles/846122/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is this the team that gave us xarray? If so, this follow-up effort deserves fast tracking.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846122/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2021 3:17 UTC (Sun)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/846175/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Very kind of you to say so!<br>
<p>
XArray was primarily a one-man effort while the Maple Tree is a collaboration (with Liam doing the majority of the work).<br>
The Maple Tree trades off a more complex implementation for a denser and more featureful representation than the XArray.<br>
The APIs are deliberately similar, and I hope to merge the two eventually.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor846975"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 22, 2021 4:18 UTC (Mon)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/846975/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I kept reading this, and the linked article, trying to figure out what sets a maple tree apart from an ordinary B-tree, that warrants the new (and more difficult to search for information on..) name. Did I miss something, or are the developers just having a little fun with this one? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846975/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor846979"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 22, 2021 8:15 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/846979/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe the maple-tree trade-offs are different to the btree tradeoffs. Feed pathological data to a btree and you end up with a linked list that is expensive to re-balance. And that&#x27;s the last thing you want to have to do in the middle of a critical section :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/846979/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor847411"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2021 16:58 UTC (Thu)
                               by <b>jch</b> (guest, #51929)
                              [<a href="/Articles/847411/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think ssmith32 was speaking about B-trees, while you seem to refer to binary search trees, which, as you justly note, are not rebalanced and have pathological worst-case behaviour.<br>
<p>
I too would like to know whether &quot;Maple trees&quot; improve upon B-trees, and in what way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/847411/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848351"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Introducing maple trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2021 7:51 UTC (Fri)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/848351/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly B-trees, not Binary trees. The description of Maple trees matched my memory of B-trees (a throwback to spinning rust, now returns cache-sized, instead of page-sized!). <br>
<p>
On the upside, thus article prodded me to pull my CLRS off the floor, where it had sat after my last interview forced me to revive my dynamic programming skills (as limited as they ever were)<br>
<p>
<a href="https://en.m.wikipedia.org/wiki/B-tree">https://en.m.wikipedia.org/wiki/B-tree</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848351/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
