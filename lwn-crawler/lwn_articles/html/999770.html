        <!DOCTYPE html>
        <html lang="en">
        <head><title>The kernel's command-line commotion [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/999770/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/998951/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/999770/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The kernel's command-line commotion</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 27, 2024</br>
           </div>
For the most part, the 6.13 merge window has gone smoothly, with relatively
few problems or disagreements — other than <a href="/Articles/999197/">this
one</a>, of course.  There is one other exception, though, relating to the
kernel's presentation of a process's command line to interested user-space
observers when a relatively new system call is used.  A pull request with a
simple change to make that information more user-friendly ran afoul of
Linus Torvalds, who has his own view of how it should be managed.
<p>
When one looks at a running process, often the first item of interest is
which program that process is running.  The kernel makes that information
available in two different places, both found within a process's
<tt>/proc</tt> directory:
<p>
<ul class="spacylist">
<li> <a
     href="https://man7.org/linux/man-pages/man5/proc_pid_comm.5.html"><tt>comm</tt></a>
     holds the "command" that the process is 
     running.  When a program is launched with <a
     href="https://man7.org/linux/man-pages/man2/execve.2.html"><tt>execve()</tt></a>,
     the base name of the executable file is placed in <tt>comm</tt>.  So
     if the user runs <tt>/usr/bin/rogue</tt>, <tt>comm</tt> will contain
     "<tt>rogue</tt>".

<li> <a
     href="https://man7.org/linux/man-pages/man5/proc_pid_cmdline.5.html"><tt>cmdline</tt></a>
     contains the entire command line passed to the running program via the
     <tt>argv</tt> array given to <tt>execve()</tt>; it traditionally holds 
     the program name, which is passed as the first argument in the
     command line.

</ul>
<p>
The two files contain similar but different information, and have different
access characteristics.  <tt>comm</tt> will contain the actual file name
that was passed to <tt>execve()</tt> (but keep on reading); it is also
stored in a kernel data structure and can be accessed quickly.  Instead, the
command name in <tt>cmdline</tt> is whatever was passed to
<tt>execve()</tt> as <tt>argv[0]</tt>, which may or may not be the actual
name of the command.  It is stored in the relevant process's address space,
meaning that the process itself can change it, and accessing it from
another process is a relatively expensive operation.  For these reasons,
programs like <tt>ps</tt> or <tt>top</tt> will use <tt>comm</tt> instead of
<tt>cmdline</tt> when possible.
<p>
As it happens, <tt>execve()</tt> is not the only way to launch a new
program within a process on Linux.  There is a library function called <a
href="https://man7.org/linux/man-pages/man3/fexecve.3.html"><tt>fexecve()</tt></a>
that takes an open file descriptor for the program to execute rather than
its path name; under the hood, it is implemented with <a
href="https://man7.org/linux/man-pages/man2/execveat.2.html"><tt>execveat()</tt></a>.
There is interest in using <tt>fexecve()</tt> because it allows the target
program to be opened and checked (looking for a signature, for example),
then executed in a race-free way.  Tools like systemd have support for
running programs this way, and its developers would prefer to use that
mode.
<p>
There is just one little problem.  While <tt>execve()</tt> can initialize
<tt>comm</tt> from the name of the file passed to it, <tt>fexecve()</tt>
only has an open file descriptor that no longer has any path-name
information associated with it.  That file descriptor may be marked "close
on exec", meaning that even any information that may have been found in
<tt>/proc/<i>PID</i>/fd</tt> will be lost.  The result, in current kernels,
is that, when a program is run with <tt>fexecve()</tt>, the <tt>comm</tt>
is simply set to the file-descriptor number of the program.  If
<tt>rogue</tt> is run with <tt>fexecve()</tt> from file descriptor five,
<tt>comm</tt> will contain&nbsp;"<tt>5</tt>" rather than "<tt>rogue</tt>".
<p>
Users, being the irascible creatures that they are, have expressed the
unreasonable opinion that replacing the command names of processes in their
system-management tools with small integers is an unwelcome change.  They
have been spoiled by being able to see which program each process is
running and feel entitled to that ability in the future.  Kernel
programming would be so much easier without users, but that is not the
world we live in.  So the search for a better way to set <tt>comm</tt> when
<tt>fexecve()</tt> is used was begun.
<p>
In <a href="/ml/all/202411190900.FE40FA5@keescook">a mid-November pull
request</a>, Kees Cook included <a
href="/ml/all/20241030203732.248767-1-tycho@tycho.pizza/">a patch from
Tycho Andersen</a> that tried to restore some useful information to
<tt>/proc/<i>PID</i>/comm</tt> in the <tt>fexecve()</tt> case.  In the
absence of the file name, the kernel would simply use the information from
<tt>argv[0]</tt> instead, causing the information from <tt>comm</tt> and
<tt>cmdline</tt> to be essentially the same.  That patch had been through a
few iterations, and seemed like a good solution to everybody involved.
<p>
Torvalds, though, <a
href="/ml/all/CAHk-=wgB1L75+C89AU62n4jBEiwKs=e4dvBDOoLQ13rUwJLFXQ@mail.gmail.com">disagreed</a>,
saying that "<q>this horrible hack is too broken to live</q>".  Over the
course of an extended and not always courteous discussion, he <a
href="/ml/all/CAHk-=wiJZDxO+Wgmg8f=Cio9AgmJ85V7do4kxroKejHNsS80hQ@mail.gmail.com/">argued</a>
that <tt>argv[0]</tt> is under user-space control and can contain any sort
of information; the <a
href="/ml/all/CAHk-=whzKjzbZQ9a-ZvRFwj6X_wsQvNjiizyCzTryEQnZc_47A@mail.gmail.com/">kernel
uses <tt>comm</tt></a> for its own purposes, and letting user space control
it could help attackers to hide the actual executable being run.  Copying
<tt>argv[0]</tt> into <tt>comm</tt> will slow program start, he said.  The
right solution, according to Torvalds, is to use the file name stored in
the directory entry ("dentry") associated with the file to be executed.
That information is always present and is reliably under the kernel's
control.
<p>
The problem with the dentry-based approach, as explained by <a
href="/ml/all/87jzcxv227.fsf@email.froward.int.ebiederm.org/">Eric
Biederman</a>, <a
href="/ml/all/Zz9sTFBQQSe1P8AI@kawka3.in.waw.pl/">Zbigniew
Jędrzejewski-Szmek</a>, and <a
href="/ml/all/202411211011.C2E3ABEAB@keescook/">Cook</a>, is that it would
change the name of the executable as seen by user space.  As an example,
a user may run <tt>rogue</tt>, but some helpful distributor may have long
since turned <tt>/usr/bin/rogue</tt> into a symbolic link to
<tt>/usr/bin/nethack</tt>.  On current systems, a tool like <tt>ps</tt>
will show this user, busily at work, running <tt>rogue</tt>, but a
<tt>comm</tt> value derived from the dentry would use the actual file being
executed, so it would show as <tt>nethack</tt> instead.  On some systems,
like Debian with its "alternatives" mechanism, the visible names of quite a
few commands would change.  That could break programs that are looking for
specific command names.  Setting <tt>comm</tt> from <tt>argv[0]</tt>,
instead, would preserve the original name.
<p>
Torvalds, though, <a
href="/ml/all/CAHk-=whF03ueoCM7M0vbcTy7fRvv+g9h_rnafurNJ1OEj71cEA@mail.gmail.com/">was
unmoved</a> by this argument.  The dentry-based name, he said, is "<q>THE
TRUTH</q>", and any program that wants to see <tt>argv[0]</tt> should just
be using <tt>cmdline</tt> instead.  Anybody who wants the behavior of
<tt>execve()</tt> should just not use <tt>fexecve()</tt>, he added.  The
patch, as written, would not be pulled into the mainline.

Cook <a href="/ml/all/202411211302.08EEE6D395@keescook/">tried one more
time</a> to explain why using <tt>argv[0]</tt> was desirable.  It is the
"<q>friendlier</q>" choice, he said, but if Torvalds was adamant that the
dentry-based name must be used, that was going to be the result of the
discussion.  Torvalds <a
href="/ml/all/CAHk-=wjRE5S_vpQdRH-ZH2Q6SU1cmX0HhwzmfpjgYtoQAtok=Q@mail.gmail.com/">responded</a>:
"<q>no. THERE IS NO WAY I WILL ACCEPT THE GARBAGE THAT IS ARGV[0]</q>".
<p>
This response seemed to indeed be somewhat adamant, so Cook has
subsequently <a href="/ml/all/202411210651.CD8B5A3B98@keescook/">resent his
pull request</a> without the controversial patch, saying that the
dentry-based approach would be implemented for the 6.14 merge window.
Jędrzejewski-Szmek <a
href="/ml/all/Z0A3EkxZZg19Dp9Q@kawka3.in.waw.pl/">said</a> that this
approach could be worked with, "<q>but we'll need to make an effort to warn
users and do it much more visibly</q>".  There will, he said, inevitably be
complaints from users whose scripts have broken.
<p>
In the end, this disagreement comes down to a small piece of the kernel's
user-space interface that has existed almost since the beginning, but which
has never been precisely specified.  As with any user-visible behavior,
programs have developed a reliance on the way things have traditionally
worked, making newer approaches (such as <tt>execve()</tt> from a file
descriptor) hard to implement without breaking things.  There may be no
ideal solution in this case, but it would have been nice if a workable
solution could have been found with less shouting.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#proc">/proc</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-execveat">System calls/execveat()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/999770/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor999900"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 15:10 UTC (Wed)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/999900/">Link</a>] (31 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Frankly this means it's going to be quite hard for systemd to ever switch to fexecve() for things, because if we cannot control comm reasonably then any symlinked binary will show up with the wrong comm[], and there are many of those unfortunately. There are so many multicall binaries after all... tpm2-tss for example is pretty much a single multi-call binary, so are binaries in systemd, util-linux and elsewhere. Sure most of these hopefully check argv[0] rather than comm[], but this is not universally true, and "top" would still be very confusing...<br>
<p>
If we ever wanted to support fexecve() for this, we'd have to manually follow any symlinks and then revert back to old execve() support in case we see symlinked binaries, and accept racefulness there again. But uh, that really sucks...<br>
<p>
I am kinda looking forward to a future where we pin our files by fds when we are about to use them, and remove all races around TOCTTOU these ways, but it really sucks that this is not a possibility for the most fundamental operation systemd actually does: executing binaries...<br>
<p>
Maybe a way out is if the kernel would learn a new fexecve2() syscall or so which takes some additional structure or so with additional parameters for the execution, and some flags, and then one field could be for explicit comm[] control. (And another one could be for explicit selinux execution label control, in place of this super ugly /proc/self/attr/exec interface^Hhack...)<br>
<p>
Lennart<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999900/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999909"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 15:53 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/999909/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do symbolic links have dentries? Is there any way to store that in eg comm2, so what the user typed and the system looked up can be retrieved?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999909/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999948"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 19:55 UTC (Wed)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/999948/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, but all lookup info gets tossed once final inode has been located.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999948/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999955"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 20:26 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/999955/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then don't toss it?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999955/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1000027"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 14:42 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/1000027/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When exactly does it get tossed? Suppose we construct a file descriptor with open(..., O_NOFOLLOW|O_PATH) (or openat or what have you). Then it probably can't get tossed until after we're in execveat, at which point the kernel should be able to preserve it if it so desires.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000027/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000090"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 16:40 UTC (Thu)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/1000090/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See terminate_walk() in path_lookupat().<br>
<p>
Descriptor pins "struct file" which pins dentry which pins inode.<br>
You can walk upwards to the root and get _some_ name, that's what readlink(/proc/*/fd/*) does.<br>
<p>
Now _some_ history must kept for loop detection purposes and too-deep-recursion detection but it surely won't exist once system call exits.<br>
<p>
In theory, the name of the first symlink which started last pathname resolution chain could be kept to use as argv[0] but I don't want to be the one sending such patch. :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000090/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000092"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 16:54 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/1000092/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But if we pass O_NOFOLLOW, then we should end up with a path fd that refers to the symlink, not an fd that refers to the executable. Given that (as you say) the fd pins the dentry of the requested file, and the requested file is a symlink and not its target, I don't understand how the kernel would avoid pinning the symlink dentry in that case.<br>
<p>
Is the problem that execveat fails to dereference the symlink afterwards?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000092/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 18:50 UTC (Thu)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/1000096/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Apparently you can't start lookup from a symlink.<br>
<p>
readlink("symlink", "/bin/false", 4096) = 10<br>
openat(AT_FDCWD, "symlink", O_RDONLY|O_NOFOLLOW|O_PATH) = 3<br>
execveat(3, "", NULL, NULL, AT_EMPTY_PATH) = -1 ELOOP<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000100"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 19:54 UTC (Thu)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/1000100/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>The first argument of <code>execveat</code> needs to be a directory file descriptor.  Unless <code>/bin/false</code> is a directory on your system, this shouldn't work even without O_NOFOLLOW.
<p>As to why you get an ELOOP error return, I guess that's just a strange detail of the implementation.  I would have thought ENOTDIR would be the appropriate error return.


      
          <div class="CommentReplyButton">
            <form action="/Articles/1000100/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 20:15 UTC (Thu)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/1000104/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">
&gt; The first argument of execveat needs to be a directory file descriptor. Unless /bin/false is a directory on your system, this shouldn't work even without O_NOFOLLOW. 
</font>

<p><code>AT_EMPTY_PATH</code> was used, though.



      
          <div class="CommentReplyButton">
            <form action="/Articles/1000104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 22:24 UTC (Thu)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/1000113/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Ah, ok, missed that... sorry.


      
          <div class="CommentReplyButton">
            <form action="/Articles/1000113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor1000200"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 29, 2024 15:46 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/1000200/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would tend to assume that there is no existing userspace reliance on this behavior (it would be quite insane to use execveat to test whether a path is a symlink, when fstat is right there). Perhaps there are security issues, but OTOH execveat already supports AT_SYMLINK_NOFOLLOW for non-null pathname, and it would (presumably) be trivial to extend that to the AT_EMPTY_PATH case.<br>
<p>
Unfortunately, this whole discussion is probably moot for fexecve(3), considering this passage in the man page:<br>
<p>
<span class="QuotedText">&gt;  The idea behind fexecve() is to allow the caller to verify (checksum) the contents of an executable before executing it. Simply opening the file, checksumming the contents, and then doing an execve(2) would not suffice, since, between the two steps, the filename, or a directory prefix of the pathname, could have been exchanged (by, for example, modifying the target of a symbolic link).</span><br>
<p>
If the whole point of the function is to disallow symlink shenanigans, then it is obviously a non-starter to deliberately reintroduce those semantics, so libc would presumably just start passing AT_SYMLINK_NOFOLLOW (if it does not already), and we would be right back where we started.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000200/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2024 15:14 UTC (Tue)
                               by <b>stevie-oh</b> (subscriber, #130795)
                              [<a href="/Articles/1000593/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; If the whole point of the function is to disallow symlink shenanigans</span><br>
<p>
Note that symlinks aren't necessary to this. The operative word here is _shenanigans_: fexecve is designed to prevent this sort of scenario:<br>
<p>
1. Guard launcher opens path "/bin/foo"<br>
2. Guard launcher proceeds to read the file contents and verifies the checksum.  (It probably also verifies the checksum on all SOs that are /usr/bin/foo are linked to)<br>
3. While #2 is happening, rogue user with sufficient access deletes "/bin/foo" and replaces it with a modified version.<br>
4. Guard launcher finishes verifying checksum on /bin/foo and the checksum passes, so it execve's "/bin/foo".  Since that path now refers to a different file/inode, the guard launcher executes the wrong program. Whoops!<br>
<p>
By using fexecve instead of execve in step 4, the guard launcher can guarantee that the executable it launches is the _exact same file that it originally opened_.<br>
<p>
I see three primary goals here, which currently don't work well together:<br>
<p>
1. Some people want/need to be able to prevent certain kinds of shenanigans, which can only be done by using fexecve<br>
2. Other people who aren't as concerned about those shenanigans want the utility of /proc/fd/comm<br>
3. Developers writing launchers such as systemd don't want to have to write separate code paths to satisfy both groups.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2024 15:29 UTC (Tue)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/1000602/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  1. Some people want/need to be able to prevent certain kinds of shenanigans, which can only be done by using fexecve</span><br>
<span class="QuotedText">&gt; 2. Other people who aren't as concerned about those shenanigans want the utility of /proc/fd/comm</span><br>
<span class="QuotedText">&gt; 3. Developers writing launchers such as systemd don't want to have to write separate code paths to satisfy both groups.</span><br>
<p>
I'd have rather said that everyone wants the utility of /proc/fd/comm. However, while people that specifically have a goal of preventing shenanigans (i.e. those operating secure environments), are probably willing to pay the cost of reduced convenience for security, the people in charge of systemd have a goal of "security by default". And security by default only works if it does not inflict misery elsewhere.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor999913"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 16:05 UTC (Wed)
                               by <b>mgedmin</b> (subscriber, #34497)
                              [<a href="/Articles/999913/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What if you use hardlinks instead of symlinks?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999913/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999934"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 19:00 UTC (Wed)
                               by <b>nowster</b> (subscriber, #67)
                              [<a href="/Articles/999934/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>For the Debian alternatives scenario there are two symlinks: one into <tt>/etc/alternatives</tt> and another to the actual executable in <tt>/bin</tt>. There are sometimes good reasons for local configuration in <tt>/etc</tt> to be on a different filesystem to <tt>/bin</tt>.</p>

<p>For example:</p>

<blockquote>
<pre>
/bin/editor → /etc/alternatives/editor
/etc/alternatives/editor → /bin/nano
</pre>
</blockquote>




      
          <div class="CommentReplyButton">
            <form action="/Articles/999934/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor999945"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 19:46 UTC (Wed)
                               by <b>tych0</b> (subscriber, #105844)
                              [<a href="/Articles/999945/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's not just systemd here. Things like Alpine's default docker image use a symlinked busybox. They could switch to hard links of course, but asking everyone to switch (ignoring the sibling's point r.e. people who can't switch because they're on different fses) is annoying.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999945/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999965"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 21:43 UTC (Wed)
                               by <b>fman</b> (subscriber, #121579)
                              [<a href="/Articles/999965/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Uh oh. That essentially means, when using fexecve() that is, everything running on an embedded system would essentially be "busybox" :-O<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999965/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor1000002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 8:28 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/1000002/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's not really up to us to decide what people use. People use what people use. Some people use hardlinks, some people use symlinks, some people look at comm[], others at argv[0] to implement multi-call binaries. <br>
<p>
As a systemd maintainer I certainly can give people guidelines, and I can maybe be strict on not supporting completley broken behaviour, but frankly in this case, we don't have that luxury: I don't think using hardlinks or softlinks or comm[] or argv[0] could constitute "clearly broken behaviour", I think all of it is fine in a world where execve() is the law of the land. The whole mess just starts because fexecve() became a thing and it's such a incomplete (to not use the word "broken") interface. And I seriously doubt the right approach is to tell a myriad of projects and distributions to rearrange their stuff to make fexecve() workable, but instead maybe it is to just fix that broken interface.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 16:14 UTC (Wed)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/999914/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm currently working with someone to revive io_uring_spawn; perhaps you'll be able to use that instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor999928"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 17:54 UTC (Wed)
                               by <b>cschaufler</b> (subscriber, #126555)
                              [<a href="/Articles/999928/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The SELinux (Smack, AppArmor, ...) /proc/self/attr interfaces have been addressed with the lsm_[gs]et_self_attr() system calls.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999928/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 8:21 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/1000001/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One of the reasons I dislike  /proc/self/attr/exec that it maintains process/state-wide state: if somebody uses this they first have to set up the label, and then do the execve() in a 2nd step. If for some reason the abort the whole thing, and they don't end up doing an execve() (or the execve() fails, maybe due to ENOENT) they have to undo the label preparation, but that takes care to do right.<br>
<p>
I really hate logic like that that establishes some hidden state, for a secondary operation, that if for some reason fails or is not executed for some reason needs to be manually rolled back. A much better interface would be if this data would be passed to the actual execve() so that it's very clear what this is intended for and that it has no other lifecycle, cannot be applied to the wrong execve(), isn't sticky and so on.<br>
<p>
Hence lsm_set_self_attr() might be slightly better as it doesn't require procfs anymore, but the fundamental ugliness doesn't really go away, im my PoV.<br>
<p>
Lennart<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999931"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 18:05 UTC (Wed)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/999931/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The comm can't be set just before exec, for example?<br>
<p>
Although if it uses a syscall for setting it, you need to do it before the seccomp policies and all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999931/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor999933"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It doesn't make sense to worry about multicall binaries.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 18:25 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/999933/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For a multicall binary to check anything other than argv (to decide it's behavior) is against unix convention, it is impossible on other unices, and reading task comm is slower than reading argv0.<br>
<p>
AKA that would be a stupid bug.<br>
<p>
Plus for a multicall binary can reasonably be hardlinked, instead of symlinked.  Which would be fewer resources in the filesystem and faster to start up.<br>
<p>
The only case worth worrying about are process management things like ps that naturally read task-&gt;comm.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999933/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000669"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It doesn't make sense to worry about multicall binaries.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2024 9:57 UTC (Wed)
                               by <b>maxfragg</b> (subscriber, #122266)
                              [<a href="/Articles/1000669/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
all true, but the output of ps and co suddenly becomes a lot less useful, when half of you system shows up as toybox/busybox instead of sh, sleep, cat, ....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000669/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1001991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It doesn't make sense to worry about multicall binaries.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 13, 2024 12:17 UTC (Fri)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/1001991/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmmmm, less useful unless you're interested in the truth of it ..<br>
execve(2) behaviour was not changing, in the fexecve(2) case if you're not willing to pay some cost as you are wanting to see a file with a verified signature why are you bothering with the file descriptor?  If say you have written a shell with fexecve(2) support as a feature, surely you can set up an environment variable and do more smoke &amp; mirrors processing on ps(1)/top(1) via builtin to protect users from their illusions being shattered.<br>
Scripts have trace features to help debugging, couldn't you just turn off the use of fexecve when developing if necessary?<br>
As somebody said allowing obfuscation of what you are really running seems to be to the benefit the "shenanigans" use case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1001991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor999995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 4:15 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/999995/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree that an fexecve2() that takes a "comm" argument would be a good thing.  But it isn't necessary.<br>
<p>
Just find some private directory, create a symlink from my_comm to /proc/self/fd/NN, make sure NN is CLOSE-ON-EXEC,<br>
and <br>
  execveat(private-dir-fd,  "my_comm",  argv, envp, 0);<br>
<p>
As close-on-exec is processed after the target file is opened, this gives you all you need.<br>
<p>
Having to find a private directory isn't ideal, but shouldn't be too hard.  /run/fexec/$UID/$PID/ ??<br>
Cleaning up might be awkward.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000004"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 8:32 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/1000004/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure I can also copy the binary and rename it, and then glue a floppy disk to my forehead. It's a bit ridiculous to suggest this was a suitable method of operation for *all* service binary invocations while at the same time saying that initializing comm[] from argv[0] was not an option because doing such a memcpy() would be "too slow".<br>
<p>
I mean, come on.<br>
<p>
(Yes, I know it wasn't you who who said copying argv[0] → comm[] was too slow, that was Linus.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000004/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1001992"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 13, 2024 12:40 UTC (Fri)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/1001992/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The difference is the cost is only paid by those debugging, not expose every user unwittingly to potential hostile shenanigans by relying on mutable user space variables.  The people changing to use fexecve(2) for the security benefits should perhaps add a logging option saying what they're calling and what the child pid was.<br>
<p>
I developed many years, then later ran a lot of server machines distributed over many sites including network centersw and kernel level smoke &amp; mirrors undermines the whole point of switching to the fd based call.  Developers have a tendency to pick the easy option and if you're worried about exploits to race conditions, giving them shell access gets your hosts remotely cracked.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1001992/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor1000229"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Systemd has bug</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 29, 2024 20:01 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/1000229/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just read through the systemd code to see why people desire to use fexecve in the systemd code <br>
<p>
Once the file descriptor for the binary is open systemd makes some sanity checks, that are redundant with the checks execve makes in the kernel.<br>
<p>
Other then those sanity there is the only user of executable_fd in systemd, setup_smack.<br>
<p>
As I read setup_smack, it reads the xattr that holds the label, smack will apply during exec.  If the xattr is present systemd applies the label before smack does.  Which is silly, but fine except the systemd code skips the checks the smack kernel code makes before applying the label.<br>
<p>
Once smack_setup is fixed to not do unnecessary and buggy work there is no reason for systemd to open the file before exec, and thus no reason to call fexecve.<br>
<p>
So all of that work can be removed from systemd and the code can become faster and more reliable.  As well as making the entire issue of symlinks to binaries a nonissue, because fexecve is unnecessary.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000229/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000396"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Systemd has bug</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2024 9:25 UTC (Mon)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/1000396/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are mixing up things: we are not making use of the executable fd so far much, because we don't actually use execveat() unless you set ENABLE_FEXECVE macro, which nobody does. The code to use this was added a while back, in hopeful preparation that some day we could use execveat() properly, but that future never came, so nothing else was moved over to using only the executable fd, because that would be dead code.<br>
<p>
It's like arguing: we don't need washing machines, because everyone washes their clothes by hand. Of course they do, if they have no washing machine!<br>
<p>
In systemd we are moving the codebase bit by bit over to reference things by fds rather than by paths, i.e. for new stuff we generally only use O_PATH, openat() and friends. For old code we port things over, but we'll never be able to do that properly for execveat(), since it's so unusable right now.<br>
<p>
I am not going to comment on the SMACK stuff, it's contributed code by SMACK folks, I have no comprehensive understanding of that. <br>
<p>
Lennart<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000396/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor1000323"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sad outcome</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2024 21:08 UTC (Sat)
                               by <b>geuder</b> (guest, #62854)
                              [<a href="/Articles/1000323/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What would systemd have offered us if they could have switched to fexecve()?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000323/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999904"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The proposed patch was agreed during session at LPC 2024</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 15:25 UTC (Wed)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/999904/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Note that the rejected patch came out of a discussion at LPC 2024, where this was discussed at length: <a href="https://www.youtube.com/watch?v=hA2UJ5C_UGw">https://www.youtube.com/watch?v=hA2UJ5C_UGw</a><br>
<p>
At this point I do have to wonder why we bother with taking the time and effort to organize these MCs and sessions at the conference, if they are effectively pointless?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999904/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999920"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The proposed patch was agreed during session at LPC 2024</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 16:50 UTC (Wed)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/999920/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems to me the answer is that the Linux kernel is not governed by a committee it is ultimately governed by Linus Torvalds.  In a reversal of the usual democratic scheme it is a committee that proposes and Linus disposes.  And if there are any objections the answer of course is to fork the kernel and rename it after yourself instead.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999920/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1002102"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The proposed patch was agreed during session at LPC 2024</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 13, 2024 21:18 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/1002102/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Like it or not, the BDFL model is very successful.<br>
<p>
As is "he who pays the piper calls the tune" or, in FLOSS terms, "he who puts in the work makes the rules".<br>
<p>
I'm not saying all of them are, but many calls for "democracy" in FLOSS projects are "we want to control the committee that tells you where to direct your efforts". That usually is a dead flop as far as volunteers are concerned. And as we've seen - with Firefox amongst others - all too often a foundation intended to support a project has great difficulty paying developers, for whatever reason ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1002102/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999953"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The proposed patch was agreed during session at LPC 2024</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 20:27 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/999953/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It has never been the case in the linux kernel that you have to be in the one specific physical room at one specific time to get your opinion heard.<br>
<p>
With a community as large as the linux kernel it is unreasonable to expect that.<br>
<p>
At best you can conclude is that you didn't have everyone whose opinion mattered in the room.<br>
<p>
I honestly find it scary someone would expect that being in a physical room would do more than help get the empathy and attention of the people who care.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999953/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">only for fexecve?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 15:33 UTC (Wed)
                               by <b>shironeko</b> (subscriber, #159952)
                              [<a href="/Articles/999906/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This change is only for fexecve right? since the current behavior is just a number (not even unique), I'm not sure how going with either of the approaches will break any users, or subvert user expectation?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999947"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">only for fexecve?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 20:17 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/999947/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, only for the case where no filename is supplied to execveat.<br>
<p>
There are cases like login shells where argv[0] must take a value that is not really appropriate for use as task-&gt;comm.<br>
<p>
So no.  Userspace won't be broken.  There are just cases where slowing down user space using open followed by extra followed by execveat will have a different task-&gt;comm.<br>
<p>
The silliness of using the ascii string representing the file descriptor number is going away, and that is good.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999947/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor999961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">only for fexecve?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 21:25 UTC (Wed)
                               by <b>jkingweb</b> (subscriber, #113039)
                              [<a href="/Articles/999961/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In short, systemd wants to use fexecve to cleanly avoid data races, but the lack of reliable comm data makes this impractical. The change in the kernel doesn't break anything, but systemd switching to fexecve even with this change would break things. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 18:51 UTC (Wed)
                               by <b>carlosrodfern</b> (subscriber, #166486)
                              [<a href="/Articles/999935/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus brought up a security concern that it is valid. What do others supporting the `argv[0]` approach think about that?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999939"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 19:18 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/999939/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What security concern?<br>
<p>
Linus went on about "comm" being "THE TRUTH" but it's actually not that useful as a source of truth because a process can call prctl(PR_SET_NAME) to set its "comm" to whatever it wants. I hope someone pointed that out in the email discussion; it was tangentially alluded to in a later message, at least.<br>
<p>
It's also a bit rich for Linus to rant about other developers being idiots in the same messages where he was completely wrong about the default behaviour of "ps". He ought to have apologised for that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999939/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 19:24 UTC (Wed)
                               by <b>carlosrodfern</b> (subscriber, #166486)
                              [<a href="/Articles/999941/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was referring to this:<br>
<p>
<span class="QuotedText">&gt; the kernel uses comm for its own purposes, and letting user space control it could help attackers to hide the actual executable being run. Copying argv[0] into comm will slow program start, he said. The right solution, according to Torvalds, is to use the file name stored in the directory entry ("dentry") associated with the file to be executed. That information is always present and is reliably under the kernel's control. </span><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 20:22 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/999951/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  That information is always present and is reliably under the kernel's control. </span><br>
<p>
But it's "lying" to the user - it's not the executable they "asked for" ...<br>
<p>
That said, I'm a bit surprised that systemd doesn't want to use the secure fexecv or whatever it was - the usual attitude is "do it right and if buggy code breaks, tough". Probably what they should do is implement it as an option, off by default to start with, then on, then only choice. If buggy code isn't fixed, it'll just have to deal with the consequences.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor999959"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 21:20 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/999959/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, I think that's incorrect. Userspace can already control "comm" via PR_SET_NAME. Seems like Linus forgot about that... while ranting about what idiots other developers are.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999959/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999963"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 21:35 UTC (Wed)
                               by <b>carlosrodfern</b> (subscriber, #166486)
                              [<a href="/Articles/999963/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps he was referring to hiding processes the attacker didn't provide the binary for? For example, using some existing sftp, httpd, etc... program and hiding it with some `comm` looking like something else? <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999963/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999980"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 23:20 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/999980/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The attacker can create a hard link to get the same effect. Or they can use ptrace to inject a prctl call after exec.<br>
<p>
There are some situations where a restricted attacker could manipulate argv[0] but not comm. But they're very narrow. Just ranting that "comm is THE TRUTH" is totally misleading.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999980/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor999964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 21:40 UTC (Wed)
                               by <b>carlosrodfern</b> (subscriber, #166486)
                              [<a href="/Articles/999964/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
He may not be referring to programs that change their name programmatically, but attackers reusing existing binaries and hiding their attack with links.<br>
<p>
For example,<br>
<p>
$ ln -s /usr/bin/sleep ./bash<br>
./bash 60<br>
<p>
<p>
$ ps -e -o comm,cmd | grep bash<br>
bash            ./bash 60<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor999976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 22:44 UTC (Wed)
                               by <b>kees</b> (subscriber, #27264)
                              [<a href="/Articles/999976/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; He ought to have apologised for that</span><br>
<p>
Yes, he should have. Especially after directly insulting all the other participants in the discussion. I thought we were supposed to have a sane CoC?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999993"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The security concern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 2:22 UTC (Thu)
                               by <b>npws</b> (subscriber, #168248)
                              [<a href="/Articles/999993/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The entire discussion is a complete train wreck. Linus keeps ranting on and on, making incorrect claims left and right, while shouting and insulting  people. Apparently neither CoC nor userspace matter when he doesn't like it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999993/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor999937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Irascible</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 18:55 UTC (Wed)
                               by <b>jheiss</b> (subscriber, #62556)
                              [<a href="/Articles/999937/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I read that paragraph to my wife and my eyes are watering. Great writeup.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999950"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Irascible</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 20:15 UTC (Wed)
                               by <b>MrWim</b> (subscriber, #47432)
                              [<a href="/Articles/999950/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which paragraph made your eyes water?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999950/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Irascible</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 20:45 UTC (Wed)
                               by <b>carlosrodfern</b> (subscriber, #166486)
                              [<a href="/Articles/999956/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The hilarious one, lol:<br>
<p>
<span class="QuotedText">&gt; Users, being the irascible creatures that they are, have expressed the unreasonable opinion that replacing the command names of processes in their system-management tools with small integers is an unwelcome change. They have been spoiled by being able to see which program each process is running and feel entitled to that ability in the future. Kernel programming would be so much easier without users, but that is not the world we live in.</span><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor999969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Add a execveat flag?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 27, 2024 22:15 UTC (Wed)
                               by <b>aszs</b> (subscriber, #50252)
                              [<a href="/Articles/999969/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Why not just add a flag to <i>execveat</i> so that it uses <i>pathname</i>  to set comm (and treats <i>dirfd</i> as the executable's fd)?






      
          <div class="CommentReplyButton">
            <form action="/Articles/999969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Add a execveat flag?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 8:35 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/1000005/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That would make sense to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor999999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Simple solution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 8:04 UTC (Thu)
                               by <b>rrolls</b> (subscriber, #151126)
                              [<a href="/Articles/999999/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Add a new version of fexecve/execveat which takes an arbitrary string to be placed on `comm` in addition to the file descriptor.<br>
<p>
Programs wishing to use this instead of execve, when the original path is a symlink, can get the basename of the original path themselves, do whatever opening and checking they like of the contents of the file, then pass that basename to be stored in `comm`.<br>
<p>
Everyone wins.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/999999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Simple solution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 11:27 UTC (Thu)
                               by <b>lkundrak</b> (subscriber, #43452)
                              [<a href="/Articles/1000018/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes. Or even use the existing call, with a flag not to touch the comm altogether. That way the calling process could just: fork(); prctl(PR_SET_NAME, "lalala"); execveat(..., AT_KEEP_PR_NAME); and be done with it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000153"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Simple solution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 29, 2024 14:04 UTC (Fri)
                               by <b>vbabka</b> (subscriber, #91706)
                              [<a href="/Articles/1000153/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe even the pathname argument could be repurposed to become comm with AT_EMPTY_PATH (plus/or another new flag to control this new behavior), because normally it's an empty string with AT_EMPTY_PATH? That would avoid the need for prctl().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000153/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor1000099"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Simple solution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 20:22 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/1000099/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's basically the same idea as copying *argv, just a bit more complicated. /proc/self/comm is one of two things:<br>
<p>
1. The (first 16 characters of the) file which was actually executed by the kernel.<br>
2. A string the program which was executed passed as argument to PR_SET_NAME.<br>
<p>
This means that it's not under control of the code which executed the exec system call. In contrast to this, *argv is the first string of the argument vector. By convention, this is also the filename of the executed file but that's really just a convention. It can be any string the executing process desired to use as first argument and it may even not exist at all, ie *argv may be NULL.<br>
<p>
Copying *argv (or, for that matter, any other string the executing process can either chose freely or omit at all) thus doesn't solve the problem that, for programs executed via file descriptor,  the correct comm value is useless for determining information about the actually running program.<br>
<p>
There's no correct solution for setting comm to the value it would have had had execve with a filename been used instead of execveat/ fexecve because the name which was used to open the file descriptor may no longer refer to the same file by the time it's executed. Using the name from the dentry is probably the best approximation as that's at least a name referring to the file which is being executed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000099/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor1000015"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">execv is weird for not resolving symlinks for comm</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 11:34 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/1000015/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given { symlink("/bin/sleep", "slp"); execl("./slp", "sla", "3600", NULL); } or e.g. `less -S slp`, and ignoring base filesystem symlinks like /bin -&gt; /usr/bin under some distros, tell me who the oddball is without telling me who the oddball is:<br>
<p>
* Sun lsof: /bin/sleep<br>
* Sun ps -o args: sla 3600<br>
* Sun ps -o comm: sla<br>
* FreeBSD lsof: /bin/sleep<br>
* FreeBSD ps -o args: sla 3600<br>
* FreeBSD ps -o comm: sleep<br>
* Linux lsof (/proc/N/fd/,/proc/N/maps): /bin/sleep<br>
* Linux ps -o args: sla 3600<br>
* Linux ps -o comm: slp<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000015/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1000019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Neither the dentry nor the argv[0] seems a good solution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 12:26 UTC (Thu)
                               by <b>THALES</b> (subscriber, #134787)
                              [<a href="/Articles/1000019/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is a reason the user cannot access the comm when a process has been executed with fexecve(). That is because the kernel has no guarantees that the file being executed is the same as the one on the disk. A process could open an executable file, tamper with it, then execute it. The real safe behavior is the existing one, neither the dentry nor the argv[0] seems a good solution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1000085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What if there is no dentry?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 28, 2024 14:54 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/1000085/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What happens if you open an executable file, unlink it from the directory, and then run it with fexecve()?<br>
Or if the file has two links?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1000253"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That will be very confusing when using extreme multicall binaries like busybox and gzip, combined with debian style alternatives!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2024 8:24 UTC (Sat)
                               by <b>koenkooi</b> (subscriber, #71861)
                              [<a href="/Articles/1000253/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
$ ps <br>
busybox<br>
busybox<br>
busybox<br>
gzip<br>
busybox<br>
<p>
This seems to be one of the rare cases where you can, in good faith, ask "which truth"? The user types in ls, tar, wget, zgrep but under the hood it's either busybox or gzip. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000253/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1000348"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That will be very confusing when using extreme multicall binaries like busybox and gzip, combined with debian style alternatives!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 1, 2024 14:19 UTC (Sun)
                               by <b>cplaplante</b> (subscriber, #107196)
                              [<a href="/Articles/1000348/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's a shame we can't enhance `ps` to report the symlinks, like `ls`. E.g.:<br>
<p>
$ ps<br>
ls -&gt; /bin/busybox <br>
tar -&gt; /bin/busybox <br>
<p>
etc.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1000348/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor1002201"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we record comm in fdtable at open()?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2024 7:35 UTC (Sun)
                               by <b>consend</b> (guest, #132320)
                              [<a href="/Articles/1002201/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I understand that the only accurate information fexecve() can use is the file descriptor (fd). So how about selectively storing comm in the fdtable during open? This would allow fexecve() to read it. However, this might bring some issues, such as increasing the burden of open(), requiring more memory, etc., or there might be some obvious problems that I haven't thought of?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1002201/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1002230"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we record comm in fdtable at open()?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2024 16:48 UTC (Sun)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/1002230/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
First of all, fdtable is obviously wrong place for anything of that sort - you'd have to copy that on dup(), fork(), etc.; if anything, it's a property of open file, not of a descriptor.  Putting the last component of pathname that had been used to open a file into resulting struct file...  Theoretically doable, but that would cost quite a bit, with no clear benefit - you'd have to do that to all files, just for the sake of vanishingly small subset that would be involved  in fexecve(), and usefulness of fexecve() itself is not obvious.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1002230/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1002614"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Can we record comm in fdtable at open()?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2024 12:22 UTC (Wed)
                               by <b>consend</b> (guest, #132320)
                              [<a href="/Articles/1002614/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you for your reply! I realized that putting it in the fdtable was indeed a wrong idea. Intuitively, the same file instance should share the same name, and placing it in the fdtable is semantically unclear and violates the lightweight design of descriptors. Just like you said, it's a property of open file, not of a descriptor. Additionally, you mentioned saving filenames for all files. I have simply thought about adding a flag to control whether to save through the open function, but indeed, adding a flag for an extremely small number of special cases may not be a good choice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1002614/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
