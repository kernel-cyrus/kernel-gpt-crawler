        <!DOCTYPE html>
        <html lang="en">
        <head><title>Dueling performance monitors [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/310260/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/309666/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/310260/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Dueling performance monitors</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 9, 2008</br>
           </div>
Low-level optimization of performance-critical code can be a challenging
task.  At this point, one assumes, the potential for algorithmic
improvements in the targeted code has been realized; what is left is trying
to locate and address problems 
like cache misses, mis-predicted branches, and so on.  Such problems can be
impossible to find by just looking at the code; one needs support from the
hardware.  The good news is that contemporary hardware provides that
support; most processors can collect a wide range of performance data for
analysis.  The bad news is that, despite the fact that processors have been
able to collect that data for many years, there has never been support for
this kind of performance monitoring in the mainline kernel.  That situation
may be about to change, but, first, the development community will have to
make a choice between a venerable out-of-tree implementation and an
unexpected competitor.
<p>
The "perfmon" patch set has been under development for some years, but, for
a number of reasons, it has never found its way into the mainline kernel.
The most recent version of the patch was <a
href="http://lwn.net/Articles/309008/">posted for review</a> by
St&eacute;phane Eranian in late
November.  The perfmon patches show the signs of all those years of
development work and
usage experience; they offer a wide set of features and extensive user-space
support.  The full perfmon patch adds twelve system calls to the kernel;
the posted version, though, trims that count back to five in the hope that
a narrower interface will have a better chance of getting into the
mainline.  The additional system calls, one assumes, will be proposed for
inclusion sometime after the perfmon core is merged.
The reduced interface is described <a href="/Articles/310263/">in the
patch set</a>; briefly, an application hooks into the performance
monitoring subsystem with a call to:
<p>
<pre>
    int pfm_create(int flags, pfarg_sinfo_t *regs);
</pre>
<p>
This system call returns a file descriptor to identify the performance
monitoring session.  The <tt>regs</tt> parameter is used to return a list
of performance monitoring registers available on the current system;
<tt>flags</tt> is currently unused.
<p>
Specific performance counter registers can be manipulated with:
<p>
<pre>
    int pfm_write(int fd, int flags, int type, void *d, size_t sz);
    int pfm_read(int fd, int flags, int type, void *d, size_t sz);
</pre>
<p>
These system calls can be used to write values into registers (thus
programming the performance monitoring hardware) and to read counter and
configuration information from those registers.
<p>
Actually doing some performance monitoring requires a couple more calls:
<p>
<pre>
    int pfm_attach(int fd, int flags, int target);
    int pfm_set_state(int fd, int flags, int state);
</pre>
<p>
A call to <tt>pfm_attach()</tt> specifies which process is to be monitored;
<tt>pfm_set_state()</tt> then turns monitoring on and off.
<p>
There are a couple of distinctive aspects to the perfmon interface.  One is
that it knows almost nothing about the specific performance monitoring
registers; that information, instead, is expected to live in user space.
As a result, the bare perfmon system call interface is probably not
something that most monitoring applications would use; instead, those
system calls are hidden behind a user-space library which knows how to
program different types of processors for the desired results.  Beyond
that, perfmon uses the <tt>ptrace()</tt> mechanism to stop the monitored
process while performance counters are being queried; as a result, the
monitoring process must have the right to trace the target process.
<p>
On December 4, Thomas Gleixner and Ingo Molnar posted <a
href="http://lwn.net/Articles/310176/">a surprise announcement</a> of a new
performance counter subsystem.  The announcement states:
<p>
<div class="BigQuote">
	We are aware of the perfmon3 patchset that has been submitted to
	lkml recently. Our patchset tries to achieve a similar end result,
	with a fundamentally different (and we believe, superior :-)
	design.
</div>
<p>
This is not the first time that these developers have shown up with an
out-of-the-blue reimplementation of somebody else's subsystem; other
examples include the CFS scheduler, high-resolution timers, dynamic tick,
and realtime preemption.  Most of the time, the new code quickly supplants
the older version - an occurrence which is not always pleasing to the
original developers - but the situation does not seem quite as
straightforward this time.
<p>
The <a href="/Articles/310269/">proposed interface</a> is much simpler,
adding a single system call:
<p>
<pre>
    int perf_counter_open(u32 hw_event_type, u32 hw_event_period,
                          u32 record_type, pid_t pid, int cpu);
</pre>
<p>
This call will return a file descriptor corresponding to a single hardware
counter.  A call to <tt>read()</tt> will then return the current value of
the counter.  The <tt>hw_event_period</tt> can be used to block reads until
the counter overflows the given value, allowing, for example, events to be
queried in batches of 1000.  The <tt>pid</tt> parameter can be used to
target a specific process, and <tt>cpu</tt> can restrict monitoring to a
specific processor.
<p>
There are a few advantages claimed for the new implementation.  The
simplicity of the system call interface is one of those; it is possible to
write a very simple application to perform monitoring tasks, with no
additional libraries required.  The <a
href="http://lwn.net/Articles/310150/">second version of the patch</a>
includes a simple "kerneltop" utility which can display a
constantly-updated profile of anything the performance counting hardware
can monitor.  Another advantage is the avoidance of <tt>ptrace()</tt>; this
reduces the amount of privilege needed by the monitoring process and avoids
perturbing the monitored process by stopping and restarting it.  The
management of counters is said to be more flexible, with facilities for
sharing counters between processes and reserving them for administrative
access.  The low-level hardware interface is said to be simpler as well.
<p>
Those claimed advantages notwithstanding, a
number of complaints have been raised with regard to the new performance
monitoring code.  Two of those seem to be at the top of the list: the
single counter per file descriptor API, and programming the hardware
performance monitoring unit inside the kernel.  On the API side, the
biggest concern is that putting each counter behind its own file descriptor
makes it very hard to correlate two or more counters.  Reading two counters
requires two independent <tt>read()</tt> system calls; as is always the
case, just about anything could happen between those two calls.  So it's
hard to tell how two different counter values relate to each other.  But
that sort of correlation is exactly what developers doing performance
optimization want to do.  Paul Mackerras <a
href="/Articles/310273/">says</a>:
<p>
<div class="BigQuote">
	Your API has as its central abstraction the "counter".  I am saying
	that that is the wrong abstraction.  The abstraction really needs
	to be a set of counters that are all active over precisely the same
	interval, so that their values can be meaningfully compared and
	related to each other.
</div>
<p>
In response, Ingo <a href="/Articles/310274/">argues</a> that the loss of
precision caused by independent <tt>read()</tt> calls is small - much
smaller than the muddying of the results caused by stopping the target
process so that all of the counters can be read at the same time.  That
argument does not appear to have convinced the detractors, though.
<p>
The other complaint is that moving the counter programming task into the
kernel requires that the kernel know about the complexities of every
possible performance monitoring unit it may encounter.  This hardware sits
at the core of the most performance-critical CPU subsystems, so its design
parameters value non-interference above features or a straightforward
programming interface.  So programming it can be a complex business,
involving sizeable tables describing how various operations interact with
each other.  The perfmon code keeps those tables in a user-space library,
but the alternative implementation won't allow that.  Quoting Paul again:
<p>
<div class="BigQuote">
	Now, the tables in perfmon's user-land libpfm that describe the
	mapping from abstract events to event-selector values and the
	constraints on what events can be counted together come to nearly
	29,000 lines of code just for the IBM 64-bit powerpc processors.
<p>
	Your API condemns us to adding all that bloat to the kernel, plus
	the code to use those tables.
</div>
<p>
Paul (and others) argue that this information - which can add up to
hundreds of kilobytes - is better kept in user
space.
<p>
There also seems to be a bit of concern over the fact that  St&eacute;phane had clearly <a
href="/Articles/310276/">never heard about this work</a> before it was
posted for review.  It must, indeed, be a shock to work on a subsystem for
years, then find a proposed replacement sitting in one's mailbox.  As David
Miller <a href="/Articles/310277/">put it</a>:
<p>
<div class="BigQuote">
	And also, another part of the backlash is that the poor perfmon3
	person was completely blindsided by this new stuff.  Which to be
	honest was pretty unfair.  He might have had great ideas about the
	requirements (even if you don't give a crap about his approach to
	achieving those requirements) and thus could have helped avoid the
	past few days of churn.
</div>
<p>
So, at this point, what will happen with performance monitoring is unclear
at best.  Perhaps, though, this discussion will have the effect of raising
the profile of performance monitoring, which has been without proper kernel
support for many years.  The merging of either solution - or, perhaps, a
combination of both - seems like it has to be an improvement over having no
support at all.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Performance_monitoring">Performance monitoring</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/310260/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor310409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">perfctr?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2008 18:38 UTC (Tue)
                               by <b>SiliconSlick</b> (guest, #39955)
                              [<a href="/Articles/310409/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm assuming Mikael's Pettersson "perfctr" wasn't mentioned due to it's lack of likelihood to make it into the main-line kernel in the near future.  Is that the case?<br>
 <br>
  <a href="http://user.it.uu.se/~mikpe/linux/perfctr/">http://user.it.uu.se/~mikpe/linux/perfctr/</a><br>
<p>
It's still a very useful performance monitoring API and utilized quite extensively by UT Knoxville's Performance API (PAPI), even if it never makes the big time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310414"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">perfctr?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2008 18:48 UTC (Tue)
                               by <b>BrucePerens</b> (guest, #2510)
                              [<a href="/Articles/310414/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      You mean the code in <a href="http://user.it.uu.se/~mikpe/linux/perfctr/2.7/UNSUPPORTED/BUG_REPORTS_FOR_ANYTHING_BUT_PPC64_WILL_BE_IGNORED/">http://user.it.uu.se/~mikpe/linux/perfctr/2.7/UNSUPPORTED/BUG_REPORTS_FOR_ANYTHING_BUT_PPC64_WILL_BE_IGNORED/</a>?<p>:-)
      
          <div class="CommentReplyButton">
            <form action="/Articles/310414/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310418"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">perfctr?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2008 19:10 UTC (Tue)
                               by <b>SiliconSlick</b> (guest, #39955)
                              [<a href="/Articles/310418/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
2.6 is his x86 release... 2.7 is PPC only... his link for "current" points to 2.6. ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310418/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor310423"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2008 19:33 UTC (Tue)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/310423/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just hope *something* manages to make it into the upstream kernel. It's really a huge PITA to have <br>
to patch something into your kernel, just to do performance testing.<br>
<p>
FWIW, last time I tried, perfmon2 seemed to be way too slow to be usable for fine-grained testing, <br>
so I'm not too unhappy if it doesn't win. Perfctr w/PAPI seems the way to go at the moment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310423/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2008 22:32 UTC (Tue)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/310451/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In what way is perfmon2 slow?<br>
<p>
I find it to be easier to use and generate much better results than the alternatives.<br>
<p>
Though I agree, as long as *some* performance monitor implementation gets merged I'll be happy.  I'd prefer that it were perfmon, as I've spent a lot of work getting MIPS r10k, SPARC, Pentium Pro, Pentium II, and Athlon wokring and it would be a shame to have to go through and get yet another performance counter infrastructure up to speed with all of the platforms I need.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 14:52 UTC (Wed)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/310534/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Both the Eranian scheme (perfmon) and the Gleixner-Molnar scheme require a system call for each read of a counter from user mode.  In contrast, the Pettersson scheme (perfctr) does not require a system call for each read of a counter from user mode on x86.  Perfctr usually has much less overhead, so it is easier to obtain very fine-grained measurements.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310558"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 15:59 UTC (Wed)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/310558/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How fine-grained are you looking?  If you are getting so fine-grained that an extra syscall makes a difference, then you are probably starting to run into issues with skid.  Not to mention if you are trying to read multiple counters at the exact same time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310558/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310667"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 21:02 UTC (Wed)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/310667/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As fine grain as every subroutine call and return.  Some routines do encounter issues with variance due to in-flight instructions and overhead due to shortness.  Usually the issues are visible and specific, and can be handled.  Sometimes the profile is the proof that inlining is appropriate.  A subroutine whose execution is as short as a few dozen ticks can be measured meaningfully using an automated tool based on perfctr.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310667/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor310500"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 8:18 UTC (Wed)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/310500/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;The bad news is that, despite the fact that processors have been able to collect that data for many years, there has never been support for this kind of performance monitoring in the mainline kernel.</font><br>
<p>
So, uh... why doesn't oprofile qualify?  And generally, does anyone feel like explaining the relationship between oprofile and the new API(s) proposed here?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310500/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor310507"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[OT] Article Width</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 9:38 UTC (Wed)
                               by <b>mlawren</b> (guest, #10136)
                              [<a href="/Articles/310507/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Anyone else having issues with the fixed width of this article? Broader than my display size.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310507/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[OT] Article Width</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 15:07 UTC (Wed)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/310540/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No problems here.  Sometimes when I see what (I think) you describe, it's because the article includes a URL or quoted test which is wider than my display and the browser makes everything else fit that artificial width.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor310714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[OT] Article Width</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 22:50 UTC (Wed)
                               by <b>roelofs</b> (guest, #2599)
                              [<a href="/Articles/310714/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <FONT COLOR="#884400"><I>Anyone else having issues with the fixed width of this article? Broader than my display size.</I></FONT>

<P>
Yes, Perens' long URL (upstream comment) horked it up.

<P>
Greg
      
          <div class="CommentReplyButton">
            <form action="/Articles/310714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[OT] Article Width</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2008 23:06 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/310966/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
firefox3 automatically splits these. But of course it would have been better to use LWN's HTML formatting capabilites, or a tinyurl.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311195"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[OT] Article Width</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2008 21:57 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/311195/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
Well, in this case a tinyurl would have defeated the purpose of the posting.
<p>
My Opera 8 splits the URL too.

      
          <div class="CommentReplyButton">
            <form action="/Articles/311195/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor311363"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[OT] Article Width</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2008 2:35 UTC (Mon)
                               by <b>roelofs</b> (guest, #2599)
                              [<a href="/Articles/311363/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I supposed I should upgrade to FF3 one of these years...

<P>
A (reasonably) browser-independent approach would be to auto-insert &lt;wbr&gt; pseudo-tags either before or after slashes, commas, ampersands, etc., in "words" that exceed, say, 30 or 40 characters.  Most browsers treat those as optional break locations, but they're not otherwise displayed and don't insert whitespace into cut-and-pasted copies.

<P>
Greg
      
          <div class="CommentReplyButton">
            <form action="/Articles/311363/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor310520"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 11:56 UTC (Wed)
                               by <b>tnoo</b> (subscriber, #20427)
                              [<a href="/Articles/310520/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
so they monitor each other's performance?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310520/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor310527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 13:33 UTC (Wed)
                               by <b>zooko</b> (guest, #2589)
                              [<a href="/Articles/310527/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How is this "performance monitor" stuff different from oprofile?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310530"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Oprofile</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 14:13 UTC (Wed)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/310530/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Oprofile is a profiler - it tells you where your program is running.  Performance monitors tell you more about <i>why</i> it's running in a particular area.  With a performance monitor, you can, for example, determine whether a reorganization of a data structure reduces cache misses or not.  It's a different level of information.
      
          <div class="CommentReplyButton">
            <form action="/Articles/310530/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310535"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Oprofile</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 14:49 UTC (Wed)
                               by <b>zooko</b> (guest, #2589)
                              [<a href="/Articles/310535/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Could you tell me more?  I still don't understand what a performance monitor tells you that oprofile doesn't.  I've been thinking of implementing a high-performance data structure, and I always figured that to measure such things as cache misses I would use oprofile and tell oprofile to report which instructions were executing just before cache misses.<br>
<p>
Maybe I just need to read the documentation of these here "performance monitor" thingies.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310535/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310552"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Oprofile</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 16:16 UTC (Wed)
                               by <b>graydon</b> (guest, #5009)
                              [<a href="/Articles/310552/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>The original article is incorrect when it says "there has never been support for this kind of performance monitoring in the mainline kernel". Oprofile provides access to these performance counters already, and has since mid-2.5 development. I use it every few days on stock 2.6 distro kernels. It doesn't provide, say, <a href="http://lwn.net/Articles/277199/">the BTS and PEBS buffers</a>; but you usually don't have to go <em>quite</em> that far down. If you're looking for hotspots in terms of CPI, bus traffic, unusual FPU conditions, cache miss or branch mispredict counters, you're just fine with oprofile.</p>

<p>Perfmon is a separated "drivers and API only" layer that you can run various profilers and tools on top of. It also gets you a little further into the really hairy monitoring hardware (PEBS/BTS), beyond the event counters. Essentially it's the layer of very machine-dependent guts that (proprietary) vtune and (free) oprofile both duplicate parts of, along with a rich programmatic interface. You can run oprofile on top of perfmon if you like. Or the two can simply co-ordinate their access to the same performance counters.</p>

<p>For normal developers, this is mostly all plumbing. If you want to work with hardware performance counters, you've been able to via oprofile on normal linux machines for the past 5 years or so (IIRC it landed early 2003). Current oprofiles have all sorts of additional higher-level machinery (call graph profiling, a JIT API, the ability to work with xen domains, etc.)</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/310552/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor310585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Oprofile</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2008 17:14 UTC (Wed)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/310585/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If anything, the ingo/gleixner scheme seems to be solely a sampling-oriented tool, and thus in reality more of a competitor to oprofile than to perfmon.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/310585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor310889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">V3 patch</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2008 17:11 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/310889/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      For those still paying attention, the <a rel="nofollow" href="http://lwn.net/Articles/310888/">V3 patch</a> is worth a look.  Among other things, it adds a "counter group" concept which is clearly meant to address the concerns of developers who want to control and query multiple counters in an atomic manner.
      
          <div class="CommentReplyButton">
            <form action="/Articles/310889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor312142"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">V3 patch</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 19, 2008 1:36 UTC (Fri)
                               by <b>huaz</b> (guest, #10168)
                              [<a href="/Articles/312142/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am sure Ingo is very good at tuning his code so it could go in. Poor perfmon3 guy indeed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312142/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor311197"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2008 22:04 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/311197/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>
This article would have been easier to follow with some detail as to what information these facilities extract from the hardware.  Something more detailed than "support for low-level optimization of critical code."
I get particularly lost trying to understand counters overflowing and reading batches of something, which is given as a feature of the Gleixner/Molnar scheme.
<p>
Anybody?

      
          <div class="CommentReplyButton">
            <form action="/Articles/311197/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311241"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Dueling performance monitors</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 13, 2008 14:19 UTC (Sat)
                               by <b>saffroy</b> (guest, #43999)
                              [<a href="/Articles/311241/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sometimes you want to go beyond algorithmic optimization in your program, and want to know if and how a particular piece of code could run any faster. There can be many reasons why the current code is not optimal yet: it could be causing frequent cache misses, or TLB misses, or branch prediction would not work well enough, etc. But without the hardware telling you exactly what is happening, all you can do is guess.<br>
<p>
It's an easier game when the hardware helps you: that's why modern processors can be programmed to keep counters of events relating to performance issues, such as cache misses, or TLB misses, or branch prediction issues... Processors can also be programmed to generate an interrupt when a counter reaches a certain threshold (ie. when it "overflows"): at this point, the operating system can record which exact piece of code was running when this event occurred. Over time, you can thus accumulate statistics telling you how often your particular piece of code encounters one of the aforementioned performance problems.<br>
<p>
Given these statistics, you can make a more educated guess as to how your code could be improved (eg. re-arrange some structure to reduce cache misses, etc).<br>
<p>
A classic paper from Digital (1997) explains how they implemented it on their Alpha platforms:<br>
<a href="http://www-plan.cs.colorado.edu/diwan/7135/p357-anderson.pdf">http://www-plan.cs.colorado.edu/diwan/7135/p357-anderson.pdf</a><br>
<p>
The "batches" mentioned in the article relates to the number of performance registers (counters) that can be read in one shot.<br>
<p>
HTH<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311241/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2008, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
