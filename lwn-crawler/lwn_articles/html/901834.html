        <!DOCTYPE html>
        <html lang="en">
        <head><title>Stuffing the return stack buffer [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/901834/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/901998/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/901834/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Stuffing the return stack buffer</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 22, 2022</br>
           </div>
"<a
href="https://comsec.ethz.ch/research/microarch/retbleed/">Retbleed</a>"
is the name given to a class of speculative-execution vulnerabilities
involving return instructions.  Mitigations for Retbleed have found their
way into the mainline kernel but, as of this writing, some remaining
problems have kept them from the stable update releases.  Mitigating
Retbleed can impede performance severely, especially on some Intel
processors.  Thomas Gleixner and Peter Zijlstra think they have found <a
href="/ml/linux-kernel/20220716230344.239749011@linutronix.de/">a better
way</a> that bypasses the existing mitigations and misleads the processor's
speculative-execution mechanisms instead.
<p>
If a CPU is to speculate past a return instruction, it
must have some idea of where the code will return to.  In recent Intel
processors, there is a special hidden data structure called the "return
stack buffer" (RSB) that caches return addresses for speculation.  The RSB
can hold 16&nbsp;entries, so it must drop the oldest entries if a call
chain goes deeper than that.  As that deep call chain returns, the RSB can
underflow.  One might think that speculation would just stop at that
point but, instead, the CPU resorts to other heuristics, including
predicting from the
branch history buffer.  Alas, techniques for mistraining the branch history
buffer are well understood at this point.
<p>
As a result, long call chains in the kernel are susceptible to
speculative-execution attacks.  On Intel processors starting with the
Skylake generation, the only way to prevent such attacks is to turn on the
indirect branch restricted speculation (IBRS) CPU "feature", which was
added by Intel early in the Spectre era.  IBRS works, but it has the
unwelcome side effect of reducing performance by as much as&nbsp;30%.  For
some reason, users lack enthusiasm for this solution.
<p>
<h4>Another way</h4>
<p>
Gleixner and Zijlstra decided to try a different approach.  Speculative
execution of return calls on these processors can only be abused if the
RSB underflows.  So, if RSB underflow can be prevented, this particular
problem will go away.  And that, it seems, can be achieved by "stuffing"
the RSB whenever it is at risk of running out of entries.
<p>
That immediately leads to two new challenges: knowing when the RSB is
running low, and finding a way to fill it back up.  The first piece is
handled by tracking the current call-chain depth — in an approximate way.
The build system is modified to create a couple of new sections in the
executable kernel image to hold entry and exit thunks for kernel functions
and to track them.  When RSB stuffing is enabled, the entry thunk will be
invoked on entry to each function, and the exit thunk will be run on the
way out.
<p>
The state of the RSB is tracked with a per-CPU, 64-bit value that is
originally set to:
<p>
<pre>
    0x8000 0000 0000 0000
</pre>
<p>
The function entry thunk "increments" this counter by right-shifting it by
five bits.  The processor will sign-extend the value, so the counter will,
after the first call, look like:
<p>
<pre>
    0xfc00 0000 0000 0000
</pre>
<p>
If twelve more calls happen in succession, the sign bit will have been
extended all the way to the right and the counter will contain all ones,
with bits beginning to fall off the right end; this counter thus cannot
reliably count above twelve.  In this way it mimics the RSB, which cannot
hold more than 16&nbsp;entries, with a safety margin of four calls; the use
of shifts achieves that behavior without the need to introduce a branch.
Whenever a return thunk is executed, the
opposite happens: the counter is left-shifted by five bits.  After twelve
returns, the next shift will clear the remaining bits, and the counter will
have a value of zero, which is the indication that something must be done
to prevent the RSB from underflowing.  
<p>
That "something" is a quick series of function calls (coded in assembly and
found at the end of <a
href="/ml/linux-kernel/20220716230954.334016834@linutronix.de/">this
patch</a>) that adds 16&nbsp;entries to the call stack, and thus to the RSB
as well.  Each of those calls, if ever returned from, will immediately
execute an <tt>int3</tt> instruction; that will stop speculation if those
return calls are ever executed speculatively.  The actual kernel does not
want to execute those instructions (or all of those returns), of course, so
the RSB-stuffing code increments the real stack pointer past the just-added
call frames.
<p>
The end result is an RSB that no longer matches the actual call stack, but
which is full of entries that will do no harm if speculated into.  At this
point, the call-depth counter can be set to <tt>-1</tt> (all ones in the <a
href="https://en.wikipedia.org/wiki/Two%27s_complement">two's
complement</a> representation) to reflect the fact that the RSB is full.
The kernel is now safe against Retbleed exploitation — until and unless
another chain of twelve returns happens, in which case the RSB will need to
be stuffed again.
<p>
<h4>Costs</h4>
<p>
Quite a bit of work has been put into minimizing the overhead of this
solution, especially on systems where it is not needed.  The kernel is
built with direct calls to its functions as usual; at boot time, if the
<tt>retbleed=stuff</tt> option is selected, all of those calls will be
patched to go through the accounting thunks instead.  The thunks themselves
are placed in a huge-page mapping to minimize the translation lookaside
buffer overhead.  Even so, as the cover letter comments, there are costs:
"<q>We both unsurprisingly hate the result with a passion</q>".
<p>
Those costs come in a few forms.  An "<q>impressive</q>" amount of memory
is required to hold the thunks and associated housekeeping.  The bloating
of the kernel has a performance impact of its own, even on systems where
RSB stuffing is not enabled.  The extra instructions add to pressure on the
instruction cache, slowing execution.  That last problem could be mitigated
somewhat, the cover letter says, by allocating the thunks at the beginning
of each function rather than in a separate section.  Gleixner has prepared
a GCC patch to make that possible, and reports that some of the performance
loss is gained back when it is used.
<p>
The cover letter contains a long list of benchmark results comparing the
performance of RSB stuffing against that of disabling mitigations entirely
and of using IBRS.  The numbers for RSB stuffing are eye-opening, including a 382%
performance regression for one microbenchmark.  In all cases, though, RSB
stuffing performs better than IBRS.
<p>
Better performance than IBRS is only interesting, though, if the primary
goal of blocking Retbleed attacks has been achieved.  The cover letter says
this:
<p>
<blockquote class="bq">
	The assumption is that stuffing at the 12th return is sufficient to
	break the speculation before it hits the underflow and the fallback
	to the other predictors. Testing confirms that it works. Johannes [Wikner],
	one of the retbleed researchers, tried to attack this approach and
	confirmed that it brings the signal to noise ratio down to the
	crystal ball level.
<p>
	There is obviously no scientific proof that this will withstand
	future research progress, but all we can do right now is to
	speculate about that.
</blockquote>
<p>
So RSB stuffing seems to work — for now, at least.  That should make it
attractive in situations where defending against Retbleed attacks is
considered to be necessary; hosting providers with untrusted users would be
one obvious example.  But nobody will be happy with the overhead, even if
it is better than IBRS.  For a lot of users, RSB stuffing will be seen as a
clever hack that, happily, they do not need to actually use.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Meltdown_and_Spectre">Security/Meltdown and Spectre</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/901834/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor902227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2022 18:27 UTC (Fri)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/902227/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I like that last sentence ("all we can do right now is to speculate about that"). Yeah, look where speculation has brought us&mldr;



      
          <div class="CommentReplyButton">
            <form action="/Articles/902227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902880"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 29, 2022 13:48 UTC (Fri)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/902880/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://www.hyrumslaw.com/">https://www.hyrumslaw.com/</a> tells us that someone, somewhere, is making use off all of these behavioral aspects of the chip.<br>
<p>
And that is disquieting.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902880/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor902235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2022 22:11 UTC (Fri)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/902235/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That T430 thinkpad is feeling like a really great investment right about now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902263"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 13:23 UTC (Sat)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/902263/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Current CPUs are far faster than an Ivy Bridge CPU from a decade ago, even when the necessary mitigations for speculative execution vulnerabilities are enabled.<br>
<p>
And these mitigations can always be disabled if not applicable to one&#x27;s threat model.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902263/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902292"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 21:42 UTC (Sat)
                               by <b>kenmoffat</b> (subscriber, #4807)
                              [<a href="/Articles/902292/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My understanding is that on intel (AMD retbleed is a different vulnerability), anything before Skylake is not affected. Certainly, my haswell claims to be not vulnerable. And recent intel (gen 10 and later) are apparently also ok, so this seems to be only for generations 6 to 9.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902292/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902313"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 11:45 UTC (Sun)
                               by <b>kenmoffat</b> (subscriber, #4807)
                              [<a href="/Articles/902313/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I've been told that Ice Lake and later, except Alder Lake are vulnerable, and that the mitigation will also run on Alder Lake until new firmware is applied.

See INTEL-SA-00702 


      
          <div class="CommentReplyButton">
            <form action="/Articles/902313/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902323"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 14:13 UTC (Sun)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/902323/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      The <a href="https://www.intel.com/content/www/us/en/developer/topic-technology/software-security-guidance/processors-affected-consolidated-product-cpu-model.html">Intel affected CPU model page</a> says that Ice Lake models are not affected by INTEL-SA-00702.<br>
<br>
eIBRS parts had <a href="https://lwn.net/Articles/887326/">their own vulnerability in March</a> (the relevant paper is <a href="https://www.usenix.org/system/files/sec22fall_barberis.pdf">here</a>), which apparently can also be used to mount Retbleed-style attacks.










      
          <div class="CommentReplyButton">
            <form action="/Articles/902323/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902346"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 20:24 UTC (Sun)
                               by <b>kenmoffat</b> (subscriber, #4807)
                              [<a href="/Articles/902346/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So yes, not exactly the same vulnerability, but the same mitigation.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902346/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor902248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 0:40 UTC (Sat)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/902248/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      The real <b>another way</b> is to have the time dimension part of the ISA:
<br></br><br></br>

<a href="https://arxiv.org/pdf/2005.02193.pdf">Prevention of Microarchitectural Covert Channels on an
Open-Source 64-bit RISC-V Core</a>
<br></br><br></br>

Such as with this suggested new instruction, part of seL4 development.




      
          <div class="CommentReplyButton">
            <form action="/Articles/902248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902269"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 14:41 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/902269/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
“ We show that the addition of a single-instruction extension to the RISC-V ISA, that flushes microarchitectural state,”<br>
<p>
That doesn’t sound like including the time domain…?  It’s just flushing all state at certain transitions?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902269/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902272"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 14:47 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/902272/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Specifically, at context switches.  So this looks to be only truly applicable on a system where cores are entirely independent or there’s just one core.  This looks like a very limited mitigation and not much applicable to the larger cores we work with.  It also relies on knowing what “all micro architecture state” is - part of the steady march of these issues has been people finding things that weren’t previously recognized as “state” worthy of protecting.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902272/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902278"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 16:26 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/902278/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
...or somehow you arrange for all the cores sharing a cache to be running code from the same protection domain at the same time.  When one context switches to a different user or to the kernel, they all must.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902278/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor902347"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 20:19 UTC (Sun)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/902347/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So all your syscalls are now basically as expensive as you can possibly make them?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902347/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902351"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 23:03 UTC (Sun)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/902351/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I mean, they talk about how to make that specific operation more efficient and it could be worse, but …….. yes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902351/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor903579"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2022 17:13 UTC (Tue)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/903579/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;have the time dimension part of the ISA&quot; is a rather pretentious way of saying &quot;add an instruction to flush cached microarchitectural state&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/903579/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor902253"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 3:39 UTC (Sat)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/902253/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Holy mackerel!  There is nothing new under the sun!<br>
<p>
Waaaay back when, late 1970s, I worked on Datapoint 2200/5500/6600 8 bit computers, Datapoint&#x27;s extension of the basic 8008 into Z80 level, but different: no IX IY regs, had system/user modes, other differences.<br>
<p>
It also had a 16 level hardware stack with no overflow or underflow detection or warning.<br>
<p>
Its only interrupt was every millisecond whether you wanted it or not.  Everything was polled.<br>
<p>
We threw in a push, push, pop, pop, to force always using 3 levels of stack, because none of our interrupt code was supposed to use more than two levels, and user code was expected to never use more than 13 levels.<br>
<p>
Deja vu all over again!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902253/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor902268"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 14:15 UTC (Sat)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/902268/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What are the odds that a microcode update could disable falling back on &quot;other heuristics&quot; when the RSB is exhausted?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902268/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 14:42 UTC (Sat)
                               by <b>tglx</b> (subscriber, #31301)
                              [<a href="/Articles/902270/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly zero. If that would be feasible we would not discuss such a workaround at all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 23, 2022 19:13 UTC (Sat)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/902285/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That isn&#x27;t surprising... even if a heroic microcode fix was possible, there is obviously a strong financial incentive to push customers towards purchasing new chips (which already have a, presumably, well validated mitigation).<br>
<p>
I genuinely appreciate the effort and wizardry going into this problem. I suspect many are in the position of considering risk and evaluating which hosts need retbleed mitigation... and which subset of those can&#x27;t afford a 1/3 loss of capacity. <br>
<p>
It is looking like the ultimate solution is either to buy more hardware to compensate for increased kernel overhead or to upgrade to Intel &quot;12th&quot; gen or newer cpus with eIBRS support? Either option is difficult with the current unprecedented lead times on IT equipment. <br>
<p>
Of course, I accepted delivery of 5 pallets of zen3 based servers immediately prior to the public retbleed disclosure.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902665"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2022 15:01 UTC (Wed)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/902665/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Actually it is somewhat surprising.  CPU designer often put in "chicken bits" for disabling new microarchitectural features, in case they turn out to be buggy.    You can then still sell the CPU instead of having to scrap it.  And some of these chicken bits have been known to be used over the years (and probably many more were used before the CPUs were released, and the public never heard of them).

<p>But when they designed this fallback from the return stack buffer to the history-based indirect branch predictor into Skylake, they apparently did not put a chicken bit for that in, probably because history-based indirect branch prediction had been present in Intel CPUs for many generations.


      
          <div class="CommentReplyButton">
            <form action="/Articles/902665/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902685"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2022 20:53 UTC (Wed)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/902685/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; CPU designer often put in "chicken bits" for disabling new microarchitectural features, in case they turn out to be buggy.
</font>
<p>
Yeah, like <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?h=linux-5.18.y&id=80f8a9e9d530fec6094641b96fe3e5b5acb44830">this one</a> :)





      
          <div class="CommentReplyButton">
            <form action="/Articles/902685/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor902296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 0:32 UTC (Sun)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/902296/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Microcode is not all-powerful. Certain key mechanisms must be hardwired for performance reasons.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor902304"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 6:33 UTC (Sun)
                               by <b>petkan</b> (subscriber, #54713)
                              [<a href="/Articles/902304/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you need _real_ security it just better to not use _any_ sort of computer. ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902304/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 6:42 UTC (Sun)
                               by <b>petkan</b> (subscriber, #54713)
                              [<a href="/Articles/902307/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... and of course big &quot;F*** you, Intel&quot; for making 3/4 of all machines that i own a rather expensive paperweight.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor902312"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 10:56 UTC (Sun)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/902312/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      Huh. Why doesn't the CPU execute the conditional branch in <code>shlq $5, PER_CPU_VAR(__x86_call_depth); jz 1f</code> speculatively, defeating the mitigation?




      
          <div class="CommentReplyButton">
            <form action="/Articles/902312/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902334"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 14:36 UTC (Sun)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/902334/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess it does, and that&#x27;s why &quot;safety margin of four calls&quot; mentioned in the article is needed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902334/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor902336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 16:06 UTC (Sun)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/902336/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <code>jz 1f</code> is not an indirect branch.




      
          <div class="CommentReplyButton">
            <form action="/Articles/902336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902337"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 17:12 UTC (Sun)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/902337/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      But it's directly followed by <code>ret</code> on the fallthrough path. If the speculation window could be arbitrarily large, I don't see what would prevent CPU from simply bypassing the RSB stuffing code by taking the fallthrough path N times where N is the size of the RSB, and then still using the attacker-controlled indirect branch predictor. So it seems that this mitigation relies on a certain upper bound on the size of the speculation window.




      
          <div class="CommentReplyButton">
            <form action="/Articles/902337/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902339"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 17:18 UTC (Sun)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/902339/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      And indeed, quoting the patch:
<pre>
+ * The shift count might cause this to be off by one in either direction,
+ * but there is still a cushion vs. the RSB depth. The algorithm does not
+ * claim to be perfect and it can be speculated around by the CPU, but it
+ * is considered that it obfuscates the problem enough to make exploitation
+ * extremly difficult.
</pre>




      
          <div class="CommentReplyButton">
            <form action="/Articles/902339/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902340"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 17:44 UTC (Sun)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/902340/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which seems fine, since if the CPU designers were involved, it’s probably ok for existing CPUs and fixed in future, right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902340/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902341"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2022 18:14 UTC (Sun)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/902341/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can&#x27;t find any indications of Intel CPU designers being involved in this mitigation, but from what I could understand, the newest CPUs are not affected, so, indeed, the mitigation has to work only on a known set of CPUs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902341/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor902488"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2022 0:24 UTC (Tue)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/902488/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In other words, &quot;it&#x27;s fixed until we discover otherwise&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902488/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902548"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2022 13:47 UTC (Tue)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/902548/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Some knowledgeable people <a href="https://lore.kernel.org/kvm/02ff6ca4-7878-e848-cb3d-af880b1bbb58@citrix.com/">already say</a> that:
<blockquote>
Retpoline <b>is not safe</b> on Skylake-era CPUs, and we knew this before the Spectre/Meltdown embargo broke in Jan '18. 
</blockquote>
<br>
RSB stuffing relies on retpolines for Spectre v2 mitigation.




      
          <div class="CommentReplyButton">
            <form action="/Articles/902548/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor902549"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Stuffing the return stack buffer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2022 14:47 UTC (Tue)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/902549/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; RSB stuffing relies on retpolines for Spectre v2 mitigation. </font><br>
<p>
FWIW, it&#x27;s vice versa: retpolines rely on RSB stuffing to make them less broken on Skylake.<br>
<p>
But yeah, the general sentiment of that email is that apparently retpolines would be unsafe on Skylake even if RSB stuffing were added in all cases when the RSB might become empty.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/902549/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
