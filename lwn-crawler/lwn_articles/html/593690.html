        <!DOCTYPE html>
        <html lang="en">
        <head><title>Lots of new perf features [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/593690/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/592957/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/593690/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Lots of new perf features</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>April 9, 2014</br>
           <hr>
<a 
href="/Archives/ConferenceByYear/#2014-Collaboration_Summit">Collaboration 
Summit</a>
</div>
<p>
New features for  the perf tracing tool and its infrastructure were
the topic of two talks squeezed into one slot at the 2014 Linux Foundation
Collaboration Summit.  Red Hat's Jiri Olsa and LG Electronics's Namhyung
Kim looked at both recent changes that have gone into perf as well as those
that are still pending.  Each looked at a different set of improvements to
perf, including those they created themselves and those that came from other
developers. 
</p>

<a href="/Articles/593909/">
<img src="https://static.lwn.net/images/2014/lfcs-olsa-sm.jpg" border=0 hspace=5 align="right"
alt="[Jiri Olsa]" title="Jiri Olsa" width=147 height=200>
</a>

<p>
Olsa started things off by describing the <tt>libtraceevent</tt> plugins that will
help in parsing the tracepoint format lines.  <tt>libtraceevent</tt> itself
was written by Steven Rostedt as part of the trace-cmd front-end for ftrace, but is now
used by perf as well.  Each kernel tracepoint has formatting information in its
<tt>format</tt> file ("print fmt") that
describes the format used by the kernel to output the data from the
tracepoint, but that line is difficult for user space code to use, he said.
Plugins will allow user space to easily parse that information to produce
the same output as the kernel.
</p>

<h4>Intel processor feature support</h4>
<p>
Support for the "running average power limit" (RAPL) feature in Intel
processors was next up.  It allows administrators to set and monitor power
consumption limits for various hardware domains in the system.  With this
addition, authored by Stephane Eranian, perf can sample and report on power
consumption in several different categories: all physical cores, the
processor package, the DRAM, or the built-in GPU.
</p>

<p>
Another Intel-only feature allows perf to do memory profiling on those
systems.  Recent Intel CPUs provide a way to see the individual loads and
stores of memory.  Each of those events has additional information
associated with it, including the instruction address, data address,
location of access (L1 cache, local RAM, or remote cache, for example), and
type of translation lookaside buffer (TLB) access (hit, miss, L1, ...).
There is also information on the "weight" of the access, which is the
amount of work in cycles that the processor spent on the memory access.
The weight values are not particularly reliable, Olsa said, but are getting
better with each new processor.
</p>

<p>
Perf itself only records the memory access information, it does not try to
analyze it.  Another tool, c2c (for "cache to cache"), tries to detect
cache-line sharing between processors, which is a good thing to avoid, he
said.  It will report on each cache line, giving the address of the line,
the type of access (load/store), the offset of the access, and the
instruction that caused the access.  With that information, developers
should be able to spot cache-line bouncing in their systems. 
</p>

<h4>Better backtrace</h4>
<p>
Improvements to the backtrace output from ftrace was next on Olsa's list.
The idea is to be able to see the call chain that led up to a particular
sample.  That is currently done using frame pointers. If frame pointers are not
available, the newly added <tt>libdw</tt> can use the DWARF debugging data
format to unwind the stack and produce a backtrace.  Perf can record the
user stack and registers, then use <tt>libdw</tt> to provide a backtrace at
report time, which is faster than using <tt>libunwind</tt> as was done
previously. 
</p>

<p>
An even faster mechanism to produce backtraces uses the "last branches
record" (LBR) information.  Enabling LBR will store a list of the last
branches taken by the code each time a sample is taken. Both the from and
to addresses are stored and that information can be used to produce a
backtrace. 
</p>

<h4>Future changes</h4>

<p>
All of the preceding changes have gone into perf relatively recently;
Olsa then turned to some features that can be expected in the future.  There is
a plan to support the <a href="http://www.efficios.com/ctf">common trace
format</a> (CTF) in perf; the other user of CTF currently is the Linux
trace toolkit next generation (LTTng).  Making "perf record" multi-threaded
is also on the drawing board.  That will require per-CPU storage for perf
data.  Supporting multiple output data files (with a maximum size per file)
is planned as well.
</p>

<p>
Some bigger features that are coming include a mechanism to allow events to
toggle other events on or off to help narrow down the measured area.  The
original code was from Frédéric Weisbecker, but it is missing a suitable
user interface, Olsa said.  Currently it has an "ugly" command-line interface.
</p>

<p>
Currently running "perf record" requires an open file for each CPU for each
event. For traces with lots of events on systems with lots of CPUs, the
maximum open file descriptor limit will be hit.  So there are plans to
allow for "event groups" that would share a single file descriptor.  This
idea has only been discussed, Olsa said, no code has been posted.
</p>

<p>
Generic code will be moved out of perf itself and into the kernel
<tt>tools/lib</tt> directory so that other tools have access to it.  In
closing, Olsa mentioned that there are 26 or so automated tests for perf
that get run each time a commit is made.  That test suite is getting bigger
over time.
</p>

<h4>Output changes</h4>
<p>
<a href="/Articles/593910/">
<img src="https://static.lwn.net/images/2014/lfcs-kim-sm.jpg" border=0 hspace=5 align="left"
alt="[Namhyung Kim]" title="Namhyung Kim" width=170 height=150>
</a>

With that, Kim took over to discuss even more perf enhancements.  A change
to "perf report" will allow users to see the caller information more
clearly, he said.  The <tt>--children</tt> option will show the full call
chain and report each member of the call chain's impact on the measured
quantity.  It adds "Children" and "Self" columns to the perf output showing
the cumulative contribution at each step of the call chain.
</p>

<p>
Another output change is the <tt>--fields</tt> option, which specifies a
comma-separated list of the
columns that will be in the
output.  It works with the existing <tt>--sort</tt> option, allowing
users to specify which columns to sort and which to output.
</p>

<h4>Ftrace support</h4>
<p>
Integrating ftrace support into perf is another new feature.  The idea is
to integrate the tool side of ftrace into perf, Kim said.  Currently, only
the function and function_graph tracers are supported.  The feature is using the
<tt>libtraceevents</tt> kbuffer API to access the events. Providing
perf-like behavior using ftrace events is the goal.
</p>

<p>
To use it, one does a <tt>perf&nbsp;ftrace&nbsp;record</tt>.  After the
recording, one can get ftrace-like output using
<tt>perf&nbsp;ftrace&nbsp;show</tt> or perf-like output using
<tt>perf&nbsp;ftrace&nbsp;report</tt>.  It essentially allows the user to
access the ftrace ring buffer and its events from perf.  More tracers will
be added over time.
</p>

<p>
DWARF support has been added to uprobes, which allows perf to place dynamic
tracepoints 
using symbolic names and line numbers.  That work was done by Masami
Hiramatsu and is already upstream, Kim said.  Using the <tt>--line</tt> and
<tt>--vars</tt> options will use the debug information in a binary to
create uprobe tracepoints that perf can sample for those locations.
</p>

<h4>Statically defined tracepoints</h4>
<p>
The final new feature that Kim covered was statically defined tracepoints
(SDTs), which are similar to the kernel's tracepoints, but specified for
user-space applications.  SDT is the same format used by DTrace and
multiple applications have already added tracepoints  in that format. With
the addition of SDT support, perf can access 
and sample these SDTs.  There is support for listing which SDTs are
available in a 
program and support for processing them using uprobes.  Support for SDT
arguments and 
for treating SDTs like normal perf events is coming, Kim said.
</p>

<p>
As can be seen, there is a lot of activity going on in the perf world.
Much of it is straightforward improvements as well as support for new processor
features, but the ftrace integration and event toggling will be fairly
substantial new pieces.  Making it all work with user-space programs and
DTrace tracepoints are also nice benefits.  For Linux tracing, most of the
facilities are now in place, 
but the interfaces are 
still geared toward advanced developers and kernel hackers—simpler
interfaces would seem to be an area that needs more attention in the future.
</p>

<p>
[ Thanks to the Linux Foundation for supporting my travel to the Collaboration Summit. ]<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Performance_monitoring">Performance monitoring</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Collaboration_Summit-2014">Collaboration Summit/2014</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/593690/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor594178"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Lots of new perf features</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2014 2:08 UTC (Thu)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/594178/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm curious where the out-of-fds "event groups" discussion happened, as I don't recall seeing it on linux-kernel.<br>
<p>
I think the file descriptor limit was one of the complaints made about the perf_event interface when it was first introduced, it's nice they're finally getting around to looking into the issue, as it's fairly easy to run into the problem on a moderately sized system.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/594178/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2014, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
