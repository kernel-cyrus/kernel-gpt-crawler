        <!DOCTYPE html>
        <html lang="en">
        <head><title>Kernel runtime security instrumentation [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/798157/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/797799/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/798157/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Kernel runtime security instrumentation</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>September 4, 2019</br>
           <hr>
<a href="/Archives/ConferenceByYear/#2019-Linux_Security_Summit_North_America">LSS-NA</a>
</div>
<p>
Finding ways to make it easier and faster to mitigate an ongoing attack
against a Linux system at runtime is part of the motivation behind the
kernel runtime security instrumentation (KRSI) project.  Its developer, KP
Singh, gave a presentation about the project at the 
<a
href="https://events.linuxfoundation.org/events/linux-security-summit-north-america-2019/">2019
Linux
Security Summit North America</a> (LSS-NA), which was held in late August
in San Diego.  A prototype of KRSI is implemented as a Linux security
module (LSM) that allows eBPF programs to be attached to the kernel's
security hooks.
</p>

<p>
Singh began by laying out the motivation for KRSI. When looking at the
security of a system, there are two sides to the coin: signals and
mitigations.  The signals are events that might, but do not always,
indicate some kind of malicious activity is taking place; the mitigations
are what is done to thwart the malicious activity once it has been
detected.  The two "go hand in hand", he said.
</p>

<p>
For example, the audit subsystem can provide signals of activity that might
be malicious.  If you have a program that determines that the activity
actually is problematic, then you might want it to update the policy for an
LSM to restrict or prevent that behavior.  Audit may also need to be configured
to log the events in question.  He would like to see a unified mechanism
for specifying both the signals and mitigations so that the two work better
together.  That is what KRSI is meant to provide.
</p>

<p>
He gave a few examples of different types of signals.  For one, a process
that executes and then deletes its executable might well be malicious.  A
kernel module that loads and then hides itself is also suspect.  A process
that executes with suspicious environment variables
(e.g. <tt>LD_PRELOAD</tt>) might indicate something has gone awry as well.
</p>

<p>
On the mitigation side, an administrator might want to prevent mounting USB
drives on a server, perhaps after a certain point during the startup.
There could be dynamic whitelists or blacklists of various sorts, for kernel modules that
can be loaded, for instance, to prevent known vulnerable binaries from
executing, or stopping binaries from loading a core library that is
vulnerable to ensure that updates are done.  Adding any of these signals or
mitigations requires reconfiguration of various parts of the kernel, which
takes time and/or operator intervention.  He wondered if there was a way to
make it easy to add them in a unified way.
</p>

<h4>eBPF + LSM</h4>

<p>
He has created a new eBPF program type that can be used by the KRSI LSM.
There is a set of eBPF helpers that provide a "unified policy API" for
signals and mitigations.  They are security-focused helpers that can be
built up to create the behavior required.
</p>

<a href="/Articles/798172/">
<img src="https://static.lwn.net/images/2019/lssna-singh-sm.jpg" border=0 hspace=5 align="left"
alt="[KP Singh]" title="KP Singh" width=229 height=270>
</a>

<p>
Singh is frequently asked why he chose to use an LSM, rather than other
options.  Security behaviors map better to LSMs, he said, than to things
like seccomp filters, which are based on system call interception.  Various
security-relevant behaviors can be accomplished via multiple system calls,
so it would be easy to miss one or more, whereas the LSM hooks intercept
the behaviors of interest. He also hopes this work will benefit the overall LSM
ecosystem, he said.
</p>

<p>
He talked with some security engineers about their needs and one mentioned
logging <tt>LD_PRELOAD</tt> values on process execution.  The way that
could be done with KRSI would be to add a BPF program to to the
<a
href="https://elixir.bootlin.com/linux/v5.2.11/source/include/linux/lsm_hooks.h#L51"><tt>bprm_check_security()</tt></a>
LSM hook that gets executed when a process 
is run.  So KRSI registers a function for that hook, which gets called
along with any other LSM's hooks for <tt>bprm_check_security()</tt>.  When
the KRSI hook is run, it calls out to the BPF program, which will
communicate to user space (e.g. a daemon that makes decisions to add
further restrictions) via an output buffer.
</p>

<p> The intent is that the helpers are "precise and granular".  Unlike the
BPF tracing API, they will not have general access to internal kernel data
structures.  His <a
href="https://static.sched.com/hosted_files/lssna19/03/Kernel%20Runtime%20Security%20Instrumentation.pdf">slides
[PDF]</a> had <a
href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md#1-bpf_probe_read"><tt>bpf_probe_read()</tt></a>
in a circle with a slash through it as an indication of what he was trying
to avoid.  The idea is to maintain backward
compatibility by not tying the helpers to the internals of a given kernel.
</p>

<p>
He then went through various alternatives for implementing this scheme and
described the problems he saw with them.  To start with, why not use audit?
One problem is that the mitigations have to be handled separately.  But
there is also a fair amount of performance overhead when adding more things
to be audited; he would back that up with some numbers later in the
presentation.  Also, audit messages have rigid formatting that must be parsed,
which might delay how quickly a daemon could react.
</p>

<p>
Seccomp with BPF was up next.  As he said earlier, security behaviors map
more directly into LSM hooks than to system-call interception.  He is also
concerned about time-of-check-to-time-of-use (TOCTTOU) races when
handling the system call parameters from user space, though he said he is
not sure that problem actually exists.
</p>

<p>
Using kernel probes (kprobes) and eBPF was another possibility. It is a
"very flexible" solution, but it depends on the layout of internal kernel
data structures.  That makes deployment hard as things need to be
recompiled for each kernel that is targeted.  In addition, kprobes is not a
stable API; functions can be added and removed from the kernel, which may
necessitate changes.
</p>

<p>
The final alternative was the <a href="/Articles/703876/">Landlock
LSM</a>.  It is geared toward providing a security sandbox for unprivileged
processes, Singh said.  KRSI, on the other hand, is focused on detecting
and reacting to security-relevant behaviors.  While Landlock is meant to be
used by
unprivileged processes, KRSI requires <tt>CAP_SYS_ADMIN</tt> to do its
job. 
</p>

<h4>Case study</h4>

<p>
He then described a case study: auditing the environment variables set when
executing programs on a system.  It sounds like something that should be
easy to do, but it turns out not to be.  For one thing, there can be up to
32 pages of environment variables, which he found surprising.
</p>

<p>
He looked at two different designs for an eBPF helper, one that would
return all of the environment variables or one that just returned the
variable of interest.  The latter has less overhead, so it might be better,
especially if there is a small set of variables to be audited.  But either
of those helpers could end up sleeping because of a page fault, which is
something that eBPF programs are not allowed to do.
</p>

<p>
Singh did some rough performance testing in order to ensure that KRSI was
not completely unworkable, but the actual numbers need to be taken with a
few grains of salt, he said.  He ran a no-op binary 100
times and compared the average execution time (over N iterations of
the test) of that on a few different systems: a
kernel with audit configured out, a kernel with audit but no audit rules,
one where audit was used to record <tt>execve()</tt> calls, and one where
KRSI recorded the value of <tt>LD_PRELOAD</tt>.  The first two were
measured at a bit
over 500µs (518 and 522), while the audit test with rules came in at 663µs
(with a much wider distribution of values than any of the other tests).
The rudimentary KRSI test clocked in at 543µs, which gave him reason to
continue on; had it been a lot higher, he would have shelved the whole idea.
</p>

<p>
There are plenty of things that are up for discussion, he said.  Right now,
KRSI uses the perf ring buffer to communicate with user space; it is fast
and eBPF already has a helper to access it.  But that ring buffer is a
per-CPU buffer, so it uses more memory than required, especially for
systems with a lot of CPUs.
There is already talk of allowing eBPF programs to sleep, which would
simplify KRSI and allow it to use less memory.  Right now, the LSM hook
needs to pin the memory for use by the eBPF program.  He is
hopeful that discussions in the <a
href="https://linuxplumbersconf.org/event/4/sessions/62/#20190911">BPF
microconference</a> at the <a href="https://linuxplumbersconf.org">Linux
Plumbers Conference</a> will make some progress on that.
</p>

<p>
As part of the Q&amp;A, Landlock developer  Mickaël Salaün spoke up to
suggest working together.
He went through the same thinking about alternative kernel facilities that
Singh presented and
believes that Landlock would integrate well with KRSI.
Singh
said that he was not fully up-to-speed on Landlock but was amenable to
joining forces if the two are headed toward the same goals. 
</p>

<p>
[I would like to thank LWN's travel sponsor, the Linux Foundation, for
funding to travel to San Diego for LSS-NA.]<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#BPF-Security">BPF/Security</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Security_modules">Security/Security modules</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-BPF">Linux kernel/BPF</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_Security_Modules_LSM">Linux Security Modules (LSM)</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Linux_Security_Summit_North_America-2019">Linux Security Summit North America/2019</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/798157/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor798393"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 4, 2019 20:40 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798393/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
eBPF and LSM to create what is essentially an antivirus. Mmm... What could possibly go wrong?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798393/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798400"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 4, 2019 22:41 UTC (Wed)
                               by <b>kpsingh</b> (subscriber, #112411)
                              [<a href="/Articles/798400/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would you consider audit and SELinux to be antiviruses? What KRSI intends to do is provide a unified API to flexibly configure auditing and (mitigation based on the audited data) very similar to what Linux does today but in multiple different places.  <br>
<p>
Also "antivirus" is an overloaded term, I guess you mean it as something that detects and prevents malicious activity based on known signals?<br>
<p>
As to what could go wrong? We will find out when we try it :)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798400/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798402"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 4, 2019 23:23 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798402/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I consider SELinux to be an anti-feature and auditing a giant slowdown and a waste of time.<br>
<p>
<font class="QuotedText">&gt; mitigation based on the audited data</font><br>
The only valid mitigation for a detected intrusion is to bring down or isolate the host.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798402/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 13:40 UTC (Fri)
                               by <b>cpitrat</b> (subscriber, #116459)
                              [<a href="/Articles/798602/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can easily imagine cases where isolating the host could have worse consequences than anything the attacker could do. Having ways to react automatically and limit attacker's possibilities is still useful.<br>
<p>
This could also be useful in honeypots.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798630"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 16:24 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798630/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You can easily imagine cases where isolating the host could have worse consequences than anything the attacker could do.</font><br>
For example?<br>
<p>
<font class="QuotedText">&gt; Having ways to react automatically and limit attacker's possibilities is still useful.</font><br>
Then why not do it from the start?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798630/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798633"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 16:53 UTC (Fri)
                               by <b>cpitrat</b> (subscriber, #116459)
                              [<a href="/Articles/798633/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For example if the host is supporting a critical service, then switching to a highly protected mode (think read-only, potentially degraded mode) allows to continue serving while investigating rather than having a DoS caused by a script kiddy doing a prank.<br>
<p>
This is just one scenario. This seems like a flexible solution that allows for some interesting tools.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798633/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798634"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 16:54 UTC (Fri)
                               by <b>cpitrat</b> (subscriber, #116459)
                              [<a href="/Articles/798634/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For a more concrete example, the degraded mode could be a self driving car pulling over or giving back control to the driver.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798634/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798660"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 20:33 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798660/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is actually an example where isolation is the best policy. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798660/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor798635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 16:58 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798635/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are so many things wrong with this picture:<br>
1) A single critical server.<br>
2) Accessible through the Internet.<br>
3) To a script kiddie.<br>
<p>
<font class="QuotedText">&gt; This is just one scenario. This seems like a flexible solution that allows for some interesting tools.</font><br>
This seems like an overengineered solution for a non-problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798649"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 18:19 UTC (Fri)
                               by <b>cpitrat</b> (subscriber, #116459)
                              [<a href="/Articles/798649/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
1) A single critical server.<br>
I didn't say there was a single one. There can be multiple one and they all get compromised at (more or less) the same time by the same person.<br>
2) Accessible through the Internet.<br>
If the service is available through the Internet, that's unavoidable. The server could have been exploited through the service it provides.<br>
3) To a script kiddie.<br>
See 2)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798649/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798661"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2019 20:35 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798661/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So isolate all of them. The "active countermeasures" nonsense is just crap. There's not much you can do once an attacker is in and you have to let them continue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798661/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 16:47 UTC (Sat)
                               by <b>kpsingh</b> (subscriber, #112411)
                              [<a href="/Articles/798684/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You say that once you find out you are attacked, the host should be completely isolated. (While I do not agree with this). Even if one was to agree with you, the detection cannot simply happen without effective monitoring of security signals. <br>
<p>
Whether you chose to block the specific malicious activity or the host itself is a decision you can make.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798689"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 18:44 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798689/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You say that once you find out you are attacked, the host should be completely isolated. (While I do not agree with this). Even if one was to agree with you, the detection cannot simply happen without effective monitoring of security signals. </font><br>
And so why does this need yet even more eBPF crap?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798689/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798692"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 18:58 UTC (Sat)
                               by <b>kpsingh</b> (subscriber, #112411)
                              [<a href="/Articles/798692/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because you can create signals dynamically with the krsi eBPF<br>
<p>
PS: I don't intend to reply further if your communication stays unprofessional.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798692/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798693"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 19:07 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798693/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What signals? Seriously, where is an example of use with an example of mitigated damage and that can't be done with existing audit infrastructure?<br>
<p>
All I see is handwaving like:<br>
<p>
<font class="QuotedText">&gt; There could be dynamic whitelists or blacklists of various sorts, for kernel modules that can be loaded, for instance, to prevent known vulnerable binaries from executing, or stopping binaries from loading a core library that is vulnerable to ensure that updates are done.</font><br>
If you have a "vulnerable binary" then why the hell it's not deleted?<br>
<p>
For me personally the last thing I want is more of SELinux-style security theater that _will_ inevitably break in various exciting ways.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798693/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798698"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 19:21 UTC (Sat)
                               by <b>kpsingh</b> (subscriber, #112411)
                              [<a href="/Articles/798698/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You yourself mentioned auditing is a giant slowdown. So, you are now contradicting yourself! <br>
<p>
Patching / deleting a binary on a really huge number of servers cannot be done in seconds.<br>
<p>
Can you audit environment variables with audit? No you cannot! <br>
<p>
What do you need to do to add support? Change a lot of stuff, the policy language, auditd, parsers etc.<br>
<p>
The development cycle for adding a new signal and then some new policy based on the signal, e.g. a permission error if you set the same environment variable twice, touches many components and this is an attempt to fix that.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798698/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798700"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 20:26 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798700/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You yourself mentioned auditing is a giant slowdown. So, you are now contradicting yourself! </font><br>
And so will be eBPF. There's also a low-hanging fruit of using BPF to JIT-compile the audit rules.<br>
<p>
<font class="QuotedText">&gt; Patching / deleting a binary on a really huge number of servers cannot be done in seconds.</font><br>
What does it have to do with audit slowness?<br>
<p>
<font class="QuotedText">&gt; Can you audit environment variables with audit? No you cannot!</font><br>
<font class="QuotedText">&gt; What do you need to do to add support? Change a lot of stuff, the policy language, auditd, parsers etc.</font><br>
Do environment variables actually pose a significant threat to warrant a new full-blown, user-controlled arbitrary code injection facility on the critical paths? Can it itself be abused to create livelocks/deadlocks? Can an adversary use it to frustrate efforts to recover? ....<br>
<p>
<font class="QuotedText">&gt; The development cycle for adding a new signal and then some new policy based on the signal, e.g. a permission error if you set the same environment variable twice, touches many components and this is an attempt to fix that.</font><br>
I contend that none of this is even needed, as it's going to be useless and trivial to bypass.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798700/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 20:52 UTC (Sat)
                               by <b>kpsingh</b> (subscriber, #112411)
                              [<a href="/Articles/798701/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;And so will be eBPF. There's also a low-hanging fruit of using BPF to JIT-compile the audit rules.</font><br>
^^^^^^^^^^^^^^^^^^^<br>
We are doing performance comparisons and it's not.<br>
<p>
<font class="QuotedText">&gt;&gt; Patching / deleting a binary on a really huge number of servers cannot be done in seconds.</font><br>
<font class="QuotedText">&gt; What does it have to do with audit slowness?</font><br>
<p>
It's got to do with your statement: "If you have a "vulnerable binary" then why the hell it's not deleted?"<br>
<p>
<font class="QuotedText">&gt; Do environment variables actually pose a significant threat to warrant a new full-blown, user-controlled arbitrary code injection facility on the critical paths? Can it itself be abused to create livelocks/deadlocks? Can an adversary use it to frustrate efforts to recover? ....</font><br>
<p>
Environment variables is one use case where one needs to use a signal that audit does not currently provide. We are **not** talking about unprivileged eBPF here, it needs CAP_SYS_ADMIN and CAP_MAC_ADMIN. If privileged users want to shoot themselves in their feet, they have plenty other opportunities. <br>
<p>
<font class="QuotedText">&gt; The development cycle for adding a new signal and then some new policy based on the signal, e.g. a permission error if you set the same environment variable twice, touches many components and this is an attempt to fix that.</font><br>
<font class="QuotedText">&gt; I contend that none of this is even needed, as it's going to be useless and trivial to bypass.</font><br>
<p>
I disagree. It's about building defense in depth. The more hoops an attacker has to jump to attack you, the slower and harder it gets for them. Anyways, I am happy to hear if you have a constructive solution. Otherwise, this discussion is simply leading nowhere.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798705"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 22:04 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798705/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; We are doing performance comparisons and it's not.</font><br>
Then improve it. Translate audit rules into BPF and run them.<br>
<p>
<font class="QuotedText">&gt; It's got to do with your statement: "If you have a "vulnerable binary" then why the hell it's not deleted?"</font><br>
How do you recognize that a binary was used for nefarious purposes?<br>
<p>
<font class="QuotedText">&gt; Environment variables is one use case where one needs to use a signal that audit does not currently provide.</font><br>
Then extend it, rather than create a completely new system. Is there anything else that is not covered by audit subsystem and that is not a trivial addition?<br>
<p>
<font class="QuotedText">&gt; I disagree. It's about building defense in depth. The more hoops an attacker has to jump to attack you, the slower and harder it gets for them. Anyways, I am happy to hear if you have a constructive solution. Otherwise, this discussion is simply leading nowhere.</font><br>
The constructive solution is simple - improve audit subsystem instead of adding more eBPF.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798705/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798706"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 22:17 UTC (Sat)
                               by <b>kpsingh</b> (subscriber, #112411)
                              [<a href="/Articles/798706/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; We are doing performance comparisons and it's not.</font><br>
<font class="QuotedText">&gt; Then improve it. Translate audit rules into BPF and run them.</font><br>
<p>
Feel free to go that route and suggest / make improvements to audit. Audit does not meet our other key requirement of having the MAC and signaling (auditing) possible with a single API, which is something that you are not constrained by (based on your comments)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798706/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor798907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2019 5:17 UTC (Wed)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/798907/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you don't isolate the host, even ignoring security concerns, you're just kinda being a jerk, because you're knowingly providing connected resources to a bad actor. Yes, caveats may apply, but, in general, you should isolate it. Note that trying to justify not isolating it by wanting to gather more info for a more for an exciting security blog/research paper does not qualify as a caveat.. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2019 5:48 UTC (Wed)
                               by <b>cpitrat</b> (subscriber, #116459)
                              [<a href="/Articles/798908/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd expect some kind of justification when you call jerks a significant number of security researchers who use honeypots.<br>
<p>
 Otherwise, I can do it too:<br>
If you don't isolate the host, you're not being a jerk. <br>
<p>
Ok you said: "because you're knowingly providing connected resources to a bad actor." But anybody can have connected resources and it's very cheap. Look, I'm using one to answer you.<br>
<p>
If you think about a botnet of honeypots, I think your either overestimating the number of honeypots, their lifespan or underestimating the number of hosts required for a useful botnet.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor798905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2019 4:54 UTC (Wed)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/798905/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sooo... a "Safe Mode". Just hold insert while it boots!<br>
<p>
Yeah, cheap shot, but toooo easy. I'll be quiet now. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor798711"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 8, 2019 6:48 UTC (Sun)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/798711/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, my thought was that you would investigate while limiting potential damage so that you don't alert the attackers so that you have some more time to identify them. But I'm not a security expert and this sounds dangerous even to me so I don't expect this to be a plausible scenario.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798711/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798712"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 8, 2019 7:08 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798712/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's pretty clear that the idea here is to create something like Windows antiviruses, an automatic tool to detect malicious patterns and try to counteract them.<br>
<p>
Unfortunately, the patch authors don't seem to have nearly enough experience with that kind of stuff. Modern Windows antiviruses have multiple layers or defenses, they intrude into the very heart of the OS. Windows itself scans and checksums its internal control structures (PatchGuard, CodeIntegrity), and antiviruses tune it up to 11. Which is kinda awe inspiring - it's like watching CoreWar.<br>
<p>
Yet it's still not enough. All the OS protections have been bypassed ( <a href="https://www.symantec.com/content/dam/symantec/docs/security-center/white-papers/assessment-windows-vista-kernel-mode-06-en.pdf">https://www.symantec.com/content/dam/symantec/docs/securi...</a> ) and malware now routinely bypasses antiviruses. This is because attacks don't get worse, they always keep getting better.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798712/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2019 5:05 UTC (Wed)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/798906/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ok, I'm not sure how relevant it is, but that paper was from over 10 years, when Symantec was all bent out of shape that Microsoft's drivers were going to be able to do things it's drivers - written largely without code review and QA - couldn't.<br>
<p>
Some rumblings about anti trust later, an API was provided, Symantec realized windows was a dying revenue stream, and you haven't seen much work in the area since. So it's a bit of an unknown. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor798903"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2019 4:51 UTC (Wed)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/798903/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, in the defense of Cyberax, the only other software that I've ever seen that attempts the same goal (detecting and reacting to actions that violate a security policy), in the same manner (a kernel level vm running a limited language that allows hooks to be dynamically added over time), was commercially marketed as antivirus software.<br>
<p>
{rant}<br>
On the other hand, KRSI is not attempting to call out to central servers, nor is it maintaining a large and ever-growing blacklist in something referred to as a "memory-mapped" file, which actually refers to home brewed code designed to swap memory contents to disk. A list from which nothing can be removed, even if designed to detect old DOS floppy malware, out of fear of failing some dog &amp; pony show that putatively somehow relates to how effective it is. Nor does it incorporate code from a wide variety of engineers that is completely unreviewed and never QA'd. Nor does it attempt to do whatever it can to insert itself wherever it can in kernel memory. And, oh yeah, is produced and managed solely for profit.<br>
{\rant}<br>
<p>
In other words, there are a few differences too... ;)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798903/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor798914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel runtime security instrumentation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2019 7:51 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/798914/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; a kernel level vm running a limited language</font><br>
In case of Kaspersky Antivirus this VM actually is (or used to be as of ~5 years ago) position-independent x86 code that is checked to not include loops or external calls. Kinda like JIT-compiled eBPF :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
