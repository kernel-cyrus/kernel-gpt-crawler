        <!DOCTYPE html>
        <html lang="en">
        <head><title>Some notes from the BFS discussion [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/351499/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/350463/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/351499/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Some notes from the BFS discussion</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 9, 2009</br>
           </div>
As was recently <a href="http://lwn.net/Articles/350100/">reported</a>
here, Con Kolivas recently resurfaced with <a
href="http://ck.kolivas.org/patches/bfs/bfs-faq.txt">a new CPU
scheduler</a> called "BFS".  This scheduler, he said, addresses the
problems which ail the mainline CFS scheduler; the biggest of these, it
seems, is the prioritization of "scalability" over use on normal desktop
systems.  BFS was meant to put the focus back on user-level systems and,
perhaps, make the case for supporting multiple schedulers in the kernel.
<p>
<a href="http://people.redhat.com/mingo/misc/bfs-vs-tip-pipe.jpg"><img
src="https://static.lwn.net/images/ns/kernel/bfs-vs-tip-pipe.jpg" width=169 height=116 alt="[Pipe
benchmark results]" align="right" border=0 hspace=3></a>

Since then, CFS creator Ingo Molnar has <a
href="http://lwn.net/Articles/351058/">responded</a> with a series of
benchmark results comparing the two schedulers.  Tests included kernel
build times, pipe performance, messaging performance, and an online
transaction processing test; graphs were posted showing how each scheduler
performed on each test.  Ingo's conclusion: "<q>Alas, as it can be seen
in the graphs, i can not see any BFS performance improvements, on this
box.</q>"  In fact, the opposite was true: BFS generally performed
worse than the mainline scheduler.
<p>
Con's <a href="/Articles/351504/">answer</a> was best described as
"dismissive":
<p>
<div class="BigQuote">
	/me sees Ingo run off to find the right combination of hardware and
	benchmark to prove his point.
<p>
	[snip lots of bullshit meaningless benchmarks showing how great cfs
	is and/or how bad bfs is, along with telling people they should use
	these artificial benchmarks to determine how good it is,
	demonstrating yet again why benchmarks fail the desktop]
</div>
<p>
As far as your editor can tell, Con's objections to the results mirror
those heard elsewhere: Ingo chose an atypical machine for his tests, and
those tests, in any case, do not really measure the performance of a
scheduler in a desktop situation.  The more cynical observers seem to
believe that Ingo is more interested in defending the current scheduler
than improving the desktop experience for "normal" users.

<p>
The machine chosen was certainly at the high end of the "desktop" scale:
<p>
<div class="BigQuote">
	So the testbox i picked fits into the upper portion of what i
	consider a sane range of systems to tune for - and should still fit
	into BFS's design bracket as well according to your description:
	it's a dual quad core system with hyperthreading. It has twice as
	many cores as the quad you tested on but it's not excessive and
	certainly does not have 4096 CPUs.
</div>
<p>
A number of people thought that this box is not a typical desktop Linux
system.  That may indeed be true - today.  But, as Ingo (among others) has
<a href="http://lwn.net/Articles/351193/">pointed out</a>, it's important to be a little
ahead of the curve when designing kernel subsystems:
<p>
<div class="BigQuote">
	But when it comes to scheduler design and merge decisions that will
	trickle down and affect users 1-2 years down the line (once it gets
	upstream, once distros use the new kernels, once users install the
	new distros, etc.), i have to "look ahead" quite a bit (1-2 years)
	in terms of the hardware spectrum.
<p>
	Btw., that's why the Linux scheduler performs so well on quad core
	systems today - the groundwork for that was laid two years ago when
	scheduler developers were testing on a quads. If we discovered
	fundamental problems on quads _today_ it would be way too late to
	help Linux users. 
</div>
<p>
Partly in response to the criticisms, though, Ingo <a
href="/Articles/351509/">reran his tests</a> on a single quad-core system,
the same type of system as Con's box.  The end results were just about the
same.
<p>
The hardware used is irrelevant, though, if the benchmarks are not testing
performance characteristics that desktop users care about.  The concern
here is latency: how long it takes before a runnable process can get its
work done.  If latencies are too high, audio or video streams will skip,
the pointer will lag the mouse, scrolling will be jerky, and Maelstrom
players will lose their ships.  A number of Ingo's original tests were
latency-related, and he added a couple more in the second round.  So it
looks like the benchmarks at least tried to measure the relevant quantity.
<p>
Benchmark results are not the same as a better desktop experience, though,
and a number of users are reporting a "smoother" desktop when running with
BFS.  On the other hand, making significant scheduler changes in response
to reports of subjective "feel" is a sure recipe for trouble: if one cannot
measure improvement, one not only risks failing to fix any problems, one is
also at significant risk of introducing performance regressions for other
users.  There has to be some sort of relatively objective way to judge
scheduler improvements.
<p>
The way preferred by the current scheduler maintainers is to identify
causes of latencies and fix them.  The kernel's infrastructure for the
identification of latency problems has improved considerably over the last
year or two.  One useful tool is <a
href="http://www.latencytop.org/">latencytop</a>, which collects data on
what is delaying applications and presents the results to the user.  The
ftrace tracing framework is also able to create data on the delay between
when a process is awakened and when it actually gets into the CPU; see <a
href="/Articles/351513/">this post from  Frederic Weisbecker</a> for an
overview of how these measurements can be taken.
<p>
If there are real latency problems remaining in the Linux scheduler - and
there are enough "BFS is better" reports to suggest that there are - then
using the available tools to describe them seems like the right direction
to take.  Once the problem is better understood, it will be possible to
consider possible remedies.  It may well be that the mainline scheduler can
be adjusted to make those problems go away.  Or, possibly, a more radical
sort of approach is necessary.  But, without some understanding of the
problem - and associated ability to measure it - attempted fixes seem a bit
like a risky shot in the dark.
<p>
Ingo welcomed Con back to the development community and invited him to help
improve the Linux scheduler.  This seems unlikely to happen, though.  Con's
way of working has never meshed well with the kernel development community,
and he is showing little sign of wanting to change that situation.  That is
unfortunate; he is a talented developer who could do a lot to improve Linux
for an important user community.  The adoption of the current CFS scheduler
is a direct result of his earlier work, even if he did not write the code
which was actually merged.  In general, though, improving Linux requires
working with the Linux development community; in the absence of a desire to
do that effectively, there will be severe limits on what a developer will
be able to accomplish.
<p>
(See also: <a href="/Articles/351636/">Frans Pop's benchmark tests</a>,
which show decidedly mixed results.)<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Latency">Latency</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Scheduler">Scheduler</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/351499/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor351806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">benchmarks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 2:34 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/351806/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It sounds as if Con could have much greater effect by posting benchmarks that mimic what he and those who agree with him consider typical use cases, and that do poorly under the current scheduler.  The kernel people seem to be pretty good at hitting numeric targets they can reproduce.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351967"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">benchmarks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 16:10 UTC (Thu)
                               by <b>mingo</b> (guest, #31122)
                              [<a href="/Articles/351967/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
<i>
It sounds as if Con could have much greater effect by posting benchmarks that mimic what he and those who agree with him consider typical use cases, and that do poorly under the current scheduler. The kernel people seem to be pretty good at hitting numeric targets they can reproduce.
</i>
<p>
Note that Con did write a tool that measures various latency aspects of the kernel scheduler: InterBench.
<p>
Interestingly, the BFS vs. mainline numbers Con posted are showing a <a href="http://ck.kolivas.org/patches/bfs/interbench-bfs-cfs.txt">mainline desktop latency advantage</a> (also <a href="http://marc.info/?l=linux-kernel&m=125240476527775&w=2">here</a>).
<p>
(Caveat emptor: i have not done those measurements so i dont know how reliable they are - the standard deviation seems very high.)
<p>
Note that you dont 'have to' come up with a numeric result - a deterministic result that is described well and can be reproduced by a kernel developer is useful too.
<p>
Obviously numeric results have the not to be under-estimated advantage of removing subjective bias from tests. It turns a subjective impression into a hard number that cannot be ignored by either side of an argument. On the flip side, it's harder to obtain. latencytop should help out there for example.
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/351967/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor351832"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 6:12 UTC (Thu)
                               by <b>fredrik</b> (subscriber, #232)
                              [<a href="/Articles/351832/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To Con Kolivas' defense he actually came back with what I think is a very reasonable response later in the thread.<br>
<p>
 <a href="http://thread.gmane.org/gmane.linux.kernel/886319/focus=887636">http://thread.gmane.org/gmane.linux.kernel/886319/focus=8...</a><br>
<p>
And if I interpret the thread correctly it seems like Ingo Molnar and Jens Axboe actually managed to pinpoint and fix a latency related issue in the CFS. An issue that maybe would have gone undetected if it hadn't been for the BFS.<br>
<p>
Yay for "trolls" that spur kernel improvement. ;)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351832/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351842"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 6:26 UTC (Thu)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/351842/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It was critical that Con actually has code to show for his ideas and eats his own dogfood.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351842/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 11:21 UTC (Thu)
                               by <b>Tracey</b> (guest, #30515)
                              [<a href="/Articles/351889/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
After reading(or trying to keep up with all of the messages on LWN) I went through it and noted a few of Ingo's scheduler tuning parameters.<br>
<p>
I wasn't sure when I'd have the time to try them, but later into the night I was tuning up a fedora 11 system for audio work.  After I had set it up and was testing audio latency via the jack-audio system I decided to start tuning(err, poking things into) some of the scheduler stuff in /proc/sys/kernel.<br>
<p>
This was on a older dual core with 4 gig ram running fedora 11.  I tried the scheduler tweaks on the kernels 2.6.30.5-43.fc11.x86_64(stock fedora) and kernel-rt-2.6.29.6-1.rt23.4.fc11.ccrma.x86_64(Fernando at CCRMA's real time patched kernel).<br>
<p>
What I was looking for was how low I could get the audio latency down to without getting xruns in the audio system.  I noticed that when tweaking  sched_latency_ns, sched_wakeup_granularity_ns, and sched_min_granularity_ns that I could get better latency on both the fedora and ccrma kernels.<br>
<p>
The testing mostly consisted of starting jack from qjackctl, starting the hydrogen drum machine and sometimes another soft-synth;  the starting glxgears and dragging it or something else quickly around the screen.  I also opened firefox and other things, just to try to harass the audio session.<br>
<p>
I could get the fedora kernel down to about 5msec latency and the ccrma-rt just above 1msec latency while using the scheduler tweaks.  That was an improvement of 30-50% from using the kernel defaults.  So, I did prove to myself at least, that the cfs scheduler can be tweaked.  Of course, the system load took a hit somewhat(just as was told it would).<br>
<p>
Anyway, here's the real funny part:  After I would set the scheduler parameters lower I "noticed" that the screen was smoother and more responsive.  Totally subjective on my part.  Of course, it was very late and I needed sleep.<br>
<p>
This whole BFS versus CFS things seems to be a black hole that likes to tear the folks up who get to close to it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351965"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 15:54 UTC (Thu)
                               by <b>mingo</b> (guest, #31122)
                              [<a href="/Articles/351965/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>
<i>
Anyway, here's the real funny part: After I would set the scheduler parameters lower I "noticed" that the screen was smoother and more responsive. Totally subjective on my part. Of course, it was very late and I needed sleep.
</i>
<p>
That's very much possible. The upstream scheduler is a deadline scheduler in essence, and /proc/sys/kernel/sched_latency_ns sets the latency target. The scheduler tries to schedules tasks so that no task ever gets a longer delay than this latency target. (i.e. no task misses its deadline)
<p>
The defaults on 2.6.31 are 20 msecs for 1-CPU systems, 40 msecs for 2-CPU systems and 60 msecs for 4-CPU systems (etc. - growing logarithmically by CPU count).
<p>
Smaller value there means more scheduling - but also faster reaction and 'smoother' mixing of workloads. So if you lower your 40 msecs down to 20 msecs, you could get a "two times smoother" visual experience for certain GUI workloads.
<p>
You can think of it as if your 50 Hz flickering screen went to 100 Hz by halving its latency target. Such changes can affect the subjective end result rather spectacularly.
<p>
It would be nice if you documented your latency parameter changes so that we could consider them for the mainline scheduler. Those parameters were always meant to be (and were regularly) tweaked and its effects were re-measured.
<p>
The latest scheduler tree (the 2.6.32 scheduler bits) also has them lowered - you can test it by booting the <a href="http://people.redhat.com/mingo/tip.git/README">-tip kernel</a>.
<p>
Does the -tip tree feel more interactive to you, or do you still need to lower the latency targets there too?
<p>
(Feel free to report it in email or here on LWN.net.)
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/351965/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor353161"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2009 6:34 UTC (Thu)
                               by <b>eduperez</b> (guest, #11232)
                              [<a href="/Articles/353161/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p><i>The defaults on 2.6.31 are 20 msecs for 1-CPU systems, 40 msecs for 2-CPU systems and 60 msecs for 4-CPU systems (etc. - growing logarithmically by CPU count).</i></p>
<p>From my complete ignorance of how it works, may I ask why? This seems counter-intuitive to me: as the number of CPU's increase, users expect to feel a lower latency; and having more CPU's means the scheduler has it easier to find and empty CPU where the delayed task can execute. Thanks.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/353161/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor353248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2009 16:44 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/353248/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
shorter time slices are inefficient (remember cache is many times faster than ram) so with more CPUs you can let the per-cpu latency creep higher and get equivalent or better overall responsiveness due to the additional CPUs being available to do the work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/353248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor353575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 21, 2009 12:56 UTC (Mon)
                               by <b>eduperez</b> (guest, #11232)
                              [<a href="/Articles/353575/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
per-cpu!!!<br>
I did not notice that those latencies where _per-cpu_, and (wrongly) assumed they where _global_...; it makes a lot more sense, now; thanks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/353575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor351892"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 10:45 UTC (Thu)
                               by <b>ctg</b> (guest, #3459)
                              [<a href="/Articles/351892/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for pointing that out.  It is a critical piece of the story - enough to warrant our editor updating the article, IMHO!<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351892/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor352072"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion - and Con Kolivas responded...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 22:21 UTC (Thu)
                               by <b>Velmont</b> (guest, #46433)
                              [<a href="/Articles/352072/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Yes, that email should really be read. It gives me a warm fuzzy feeling all over. Just a quote from <a href="http://thread.gmane.org/gmane.linux.kernel/886319/focus=887636">the mail Con Kolivas sent</a></p>

<blockquote>What does please me now, though, is that this message thread is finally 
concentrating on what BFS was all about. The fact that it doesn't scale is no 
mystery whatsoever. The fact that that throughput and lack of scaling was 
what was given attention was missing the point entirely. To point that out I 
used the bluntest response possible, because I know that works on lkml (does 
it not?). Unfortunately I was so blunt that I ended up writing it in another 
language; Troll. So for that, I apologise.</blockquote>
<p>[snip]</p>
<blockquote>
It pleases me immensely to see that it has alreadyIt pleases me immensely to see that it has already spurred on a flood of 
changes to the interactivity side of mainline development in its few days of 
existence, including some ideas that BFS uses itself. That in itself, to me, 
means it has already started to accomplish its goal, spurred on a flood of 
changes to the interactivity side of mainline development in its few days of 
existence, including some ideas that BFS uses itself. That in itself, to me, 
means it has already started to accomplish its goal,</p>
</blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/352072/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor351903"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Benchmarking the scheduler on desktop machine</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 11:58 UTC (Thu)
                               by <b>liw</b> (subscriber, #6379)
                              [<a href="/Articles/351903/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Until someone comes up with good, generally accepted objective benchmarks for schdulers with good coverage, perhaps it would make sense to benchmark things using double-blind tests and real people.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351903/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor351911"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 13:08 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/351911/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This has actually made me wonder - what benefit is there to trying adjusting a processes scheduling based on how much time it got in the past?  It seems to me that unless you are giving very hard QoS guarantees, or something is wrong with your scheduler algorithm, any deviations from what the time the process should have had will be blips which can be ignored in the longer run, and trying to compensate for them is likely to introduce unnecessary complexity.<br>
<p>
(That is, the blips should be irrelevant for throughput once you average things out over a period of time, and as far as the responsiveness is concerned, they have already happened and you can no longer take them back.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351911/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351958"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 15:22 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/351958/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>what benefit is there to trying adjusting a processes
scheduling based on how much time it got in the past?</blockquote>

If a process is I/O bound (e.g., waiting for the user most of the time
rather than computing), it can be useful to prefer it, because it will
give a faster response to the user (or, for disk-bound processes, it
will come up faster with the next request for the disk, increasing disk utilization and hopefully total run-time), whereas a
CPU-bound process usually does not benefit from getting its timeslice
now rather than later.

      
          <div class="CommentReplyButton">
            <form action="/Articles/351958/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351978"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 16:18 UTC (Thu)
                               by <b>mingo</b> (guest, #31122)
                              [<a href="/Articles/351978/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p>
Beyond IO bound tasks, there's also a general quality argument behind rewarding sleepers:
<p>
<i>Lighter</i>, leaner tasks get an advantage. They run less and subsequently sleep more.
<p>
Tasks that do <i>intelligent multi-threading</i> with a nice, parallel set of tasks get an advantage too.
<p>
CPU hogs that slow down the desktop and eat battery like the end of the world is nigh should take a back seat compared to ligher, friendlier, 'more interactive' tasks.
<p>
So the Linux scheduler always tried to reward tasks that are more judicious with CPU resources. An app can get 10% snappier by using 5% less CPU time.
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/351978/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor352019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 19:08 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/352019/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hm, I'm not sure if either of those arguments quite convince me :)  As far as the "CPU bound processes don't need good latencies" is concerned, well, it is a heuristic, and heuristics are only as good as the set of usage cases that the author thought of.  Does a process rendering animation, or mixing music which was played back as it is rendered/mixed fare well enough here?  You are of course much better qualified than me to think of the possible edge cases of the heuristic...<br>
<p>
And regarding the rewarding of processes, it sounds a bit like the scheduler wanting to know better than the user what the user wants.  It would be much less heavy handed to just let the user know that a thread was not behaving nicely, and to let the user deal with it.  They might have a good reason for running it after all.<br>
<p>
Just my thoughts, not to be given more weight than they deserve.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/352019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor352026"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 19:20 UTC (Thu)
                               by <b>mingo</b> (guest, #31122)
                              [<a href="/Articles/352026/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
I agree with your observations - these are the basic tradeoffs to consider.
<p>
Note that the reward for tasks is limited. (unlimited would open up a starvation hole)
<p>
But you are right to suggest that the scheduler should not be guessing about the purpose of tasks.
<p>
So this capability was always kept optional, and was turned on/off during the fair scheduler's evolution, mainly driven by user feedback and by benchmarks. We might turn it off again - there are indications that it's causing problems.
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/352026/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor352049"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 21:11 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/352049/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote> Does a process rendering animation, or mixing music which
was played back as it is rendered/mixed fare well enough here?
</blockquote>

Such processes normally won't use all of the CPU (unless the CPU is
too slow for them), because they are limited by the speed in which
they want to play back the content, so a scheduler prefering sleepers
over CPU hogs will prefer them over, say, oggenc.  Of course, a
browser might get even more preferred treatment, which you may not
want; and clock scaling will tend to make stuff that consumes a
significant mostly-constant amount of CPU look almost CPU-bound if
they are alone on the CPU (but then it does not really matter).

<blockquote>It would be much less heavy handed to just let the user
know that a thread was not behaving nicely, and to let the user deal
with it.</blockquote>

Traditionally Unix had <code>nice</code> for that.  I'm not sure that
this still works properly with current Linux schedulers.  <a
href="http://groups.google.com/group/comp.arch/browse_thread/thread/3bdd9b476a00c0ab/f3f33cdd7c00bd2c#f3f33cdd7c00bd2c">The
last time I tried</a> it did not work well.

      
          <div class="CommentReplyButton">
            <form action="/Articles/352049/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor352103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2009 5:18 UTC (Fri)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/352103/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A process like gcc, which alternates between I/O and CPU bound, may also get more than its share under this algorithm - perhaps that is why people always give build processes as examples of what negatively affects their interactivity?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/352103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor352104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2009 5:20 UTC (Fri)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/352104/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
s/algorithm/heuristic/.  And of course, since CFS considers the behaviour of the process over a long period of time, this effect should be somewhat limited.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/352104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor351917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 13:10 UTC (Thu)
                               by <b>busterb</b> (subscriber, #560)
                              [<a href="/Articles/351917/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One of the hacked Android firmwares has switched to BFS in its experimental branch. Early <br>
reactions appear to be a noticable increase in responsiveness and decrease in stability.<br>
<p>
<a href="http://www.cyanogenmod.com/home/4-1-6-is-here-with-100-more-jet-fuel">http://www.cyanogenmod.com/home/4-1-6-is-here-with-100-mo...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2009 14:58 UTC (Thu)
                               by <b>kirkengaard</b> (guest, #15022)
                              [<a href="/Articles/351941/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cum grano salis -- while this has multiple anecdotes behind it, I'm not sure you can safely chalk instability in a development Android firmware image up to a BFS problem without isolating that change and doing real testing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor352184"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2009 18:03 UTC (Fri)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/352184/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think one issue is that a lot of interactivity issues probably come down to the X server not using its share of the CPU time to process the thing that the user is actually watching. I have the sneaking suspicion that Maelstrom is getting the CPU time to generate plenty of frames each second, and sending them off to X, which is not quite keeping up. Once the X server is sufficiently behind, there's back pressure on Maelstrom making requests, at which point it seems to be I/O-bound, and therefore gets all the CPU it can use to generate more frames, ensuring plenty of lag between the time that Maelstrom generates a frame and the time that the user sees it. And, of course, the benchmarks all look really good, because the game never has to wait for processor before generating a frame and the X server is drawing lots of frames. And, of course, the game is effectively trying to benchmark the system, in order to determine how closely-spaced frames should be, and our efficient system has hidden the work that it's trying to measure.<br>
<p>
BFS may give better interactivity by not giving X clients as low latency in their attempts to generate work for the server. Also, disabling the "new fair sleepers" feature helps some people, which also suggests that this is actually effectively a priority inversion problem between the task that seems to be slow and tasks that are doing work on behalf of that task and are actually slow.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/352184/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor352358"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 12, 2009 18:04 UTC (Sat)
                               by <b>Thalience</b> (subscriber, #4217)
                              [<a href="/Articles/352358/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As much as we find it frustrating that there will always be some people who insist that they perceive a subjective improvement that is not measured by any benchmark you care to name, it is human nature.<br>
<p>
I think the best response we can give to this assertion is the same one used in the audiophile community: Blind A/B tests. Have someone else switch between the two systems while doing the subjective evaluation. Don't tell the user which one is which. If they consistently prefer one over the other, perhaps there is a real effect. Otherwise....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/352358/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor353251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some notes from the BFS discussion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2009 16:55 UTC (Thu)
                               by <b>realnc</b> (guest, #60393)
                              [<a href="/Articles/353251/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p><i>As much as we find it frustrating that there will always be some people who insist that they perceive a subjective improvement that is not measured by any benchmark you care to name, it is human nature.</i></p>

<p><i>I think the best response we can give to this assertion is the same one used in the audiophile community: Blind A/B tests.</i></p>

<p>I don't need an ABX test to tell that sound stops with CFS if I start alt+tabbing while the sound continues playing when doing the same with BFS. Unless you think that some psychosomatic effect exists within BFS that makes me hear stuff that isn't there :)</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/353251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
