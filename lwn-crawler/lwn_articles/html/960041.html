        <!DOCTYPE html>
        <html lang="en">
        <head><title>The end of tasklets [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/960041/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/960457/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/960041/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The end of tasklets</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 5, 2024</br>
           </div>
A common problem in kernel development is controlling <i>when</i> a
specific task should be done.  Kernel code often executes in contexts where
some actions (sleeping, for example, or calling into filesystems) are not
possible.  Other actions, while possible, may prevent the kernel from
taking care of a more important task in a timely manner.  The kernel
community has developed a number of deferred-execution mechanisms designed
to ensure that every task is handled at the right time.  One of those
mechanisms, tasklets, has been eyed for removal for years; that removal
might just happen in the near future.
<p>
One context where deferred execution is often needed is interrupt handlers.
An interrupt diverts a CPU from whatever it was doing at the time and must
be handled as quickly as possible; sleeping in an interrupt handler is not
even remotely an option.  So interrupt handlers typically just make a note
of what needs to be done, then arrange for the actual work to be done in a
more forgiving context.  There are several options for this deferral:
<p>
<ul class="spacylist">
<li> Threaded interrupt handlers.  This mechanism, which originated in
     the realtime tree, was merged into the 2.6.30 release in 2009; it
     causes the bulk of a driver's interrupt handler to be run in a
     separate kernel thread.  Threaded handlers, since they are running in
     process context, are allowed to sleep; the system administrator can
     also adjust their priority if need be.
<li> <a
     href="https://docs.kernel.org/core-api/workqueue.html">Workqueues</a>
     were first <a href="/Articles/23634/">added</a> during the 2.5
     development series and have been extensively enhanced since then.  A
     driver can create a work item, containing a function pointer and some
     data, and submit it to a workqueue.  At some future time, that
     function will be called with the provided data; again, this call will
     happen in process context.  There are various types of workqueues with
     different performance characteristics, and subsystems can create their
     own private workqueues if need be.
<li> Software interrupts (or "bottom halves").  This mechanism is among
     the oldest in the kernel; it takes its inspiration from earlier Unix
     systems.  A software interrupt is a dedicated handler that runs,
     usually immediately after completion of a hardware interrupt or before
     a return to user space, in atomic context.  There has been a desire to
     remove this mechanism for years, since it can create surprising
     latencies in the kernel, but it persists; adding a new (direct) user of
     software interrupts would encounter significant opposition.  See <a
     href="/Articles/779738/">this article</a> for more information on
     software interrupts.
<li> Tasklets.  Like workqueues, tasklets are a way to arrange for a
     function to be called at a future time.  In this case, though, the
     tasklet function is called from a software interrupt, and it runs in
     atomic context.  Tasklets have been around since the 2.3 development
     series; they, too, have been on the chopping block <a
     href="/Articles/239633/">for many years</a>, but no such effort has
     succeeded to date.  </ul>
<p>
Threaded interrupt handlers and workqueues are seen as the preferred
mechanisms for deferred work in modern kernel code, but the other APIs have
proved hard to phase out.  Tasklets, in particular, remain because they
offer lower latency than workqueues which, since they must go through the
CPU scheduler, can take longer to execute a deferred-work item.
<p>
Mikulas Patocka recently <a
href="/ml/linux-kernel/82b964f0-c2c8-a2c6-5b1f-f3145dc2c8e5@redhat.com/">encountered
a problem</a> with the tasklet API.  A tasklet is defined by <a
href="https://elixir.bootlin.com/linux/v6.7.2/source/include/linux/interrupt.h#L619"><tt>struct
tasklet_struct</tt></a>, which contains the address of the callback
function and related information.  The tasklet subsystem needs to be able
to manipulate that structure, and may do so after the tasklet function has
completed its execution and returned.  This can be a problem if the tasklet
function itself wants to free that structure, as might happen for a
one-shot tasklet that will not be called again.  The tasklet subsystem
could end up writing to a structure that has been freed and allocated for
another use, with predictably unpleasant consequences.
<p>
Patocka sought to fix this problem by adding a new "one-shot" tasklet
variant, where the tasklet subsystem would promise to not touch the
<tt>tasklet_struct</tt> structure after the tasklet itself runs.  Linus
Torvalds, though, <a
href="/ml/linux-kernel/CAHk-=wjDW53w4-YcSmgKC5RruiRLHmJ1sXeYdp_ZgVoBw=5byA@mail.gmail.com/">did
not like that patch</a>; he said that tasklets just should not be used in
that way.  Workqueues are better designed, he said, and are better for that
use case â€” except for the extra latency they can impose.  So, he suggested,
the right approach might be a new type of workqueue:
<p>
<blockquote class="bq">
	I think if we introduced a workqueue that worked more like a
	tasklet - in that it's run in softirq context - but doesn't have
	the interface mistakes of tasklets, a number of existing workqueue
	users might decide that that is exactly what they want.
</blockquote>
<p>
Tejun Heo, the workqueue maintainer, ran with that idea; the result was <a
href="/ml/linux-kernel/20240130091300.2968534-1-tj@kernel.org/">this patch
series</a> adding a new workqueue type, <tt>WQ_BH</tt>, with the semantics
that Torvalds described.  A work item submitted to a <tt>WQ_BH</tt>
workqueue will be run quickly, in atomic context, on the same CPU.
<p>
Interestingly, these work items are run out of a tasklet â€” for now.
Fearing priority-inversion problems between <tt>WQ_BH</tt> work items and
existing tasklets, Heo chose to leave the tasklet subsystem in control.  The
patch series converts a number of tasklet users over to the new workqueue
type, though, and the plan is clearly to convert the rest over time.  That
may take a while; there are well over 500 tasklet users in the kernel.
Once that conversion is complete, though, it will be possible to run
<tt>WQ_BH</tt> workqueues directly from a software interrupt and remove the
tasklet API entirely.
<p>
This implementation, of course, still leaves software interrupts in place;
removing that subsystem will be a job for another day.  Using software
interrupts led to <a
href="/ml/linux-kernel/20240130102011.rX9Qjnp1@linutronix.de/">a
complaint</a> from Sebastian Andrzej Siewior, who would rather see tasklet
users moved to threaded interrupt handlers or regular workqueues.  But, as
Heo <a
href="/ml/linux-kernel/ZbkayGEYJNJx3ohw@slm.duckdns.org/">answered</a>,
that doesn't help the cases where the shortest latency is required.  It
seems there may always be a place for a deferred-work mechanism that does
not require scheduling, as much as the realtime developers would like to
avoid it.
<p>
Heo has the patch series <a
href="/ml/linux-kernel/ZcACvVz83QFuSLR6@slm.duckdns.org/">marked</a> as
targeted at the 6.9 kernel release, meaning that it would need to be ready
for the merge window in mid-March.  That is relatively quick for a
significant new feature like this, but it is using a well-established
kernel API to edge out a subsystem that developers have wanted to get rid
of for years.  So there a is a reasonable chance that this particular work
may not be deferred past the next kernel cycle.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-6.9">Releases/6.9</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Tasklets">Tasklets</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Workqueues">Workqueues</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/960041/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor960973"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2024 15:43 UTC (Mon)
                               by <b>kees</b> (subscriber, #27264)
                              [<a href="/Articles/960973/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We've been trying to get rid of tasklets for more than 5 years...<br>
<a href="https://github.com/KSPP/linux/issues/94">https://github.com/KSPP/linux/issues/94</a><br>
I hope it gets completed this time! :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/960973/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor960997"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2024 17:56 UTC (Mon)
                               by <b>kees</b> (subscriber, #27264)
                              [<a href="/Articles/960997/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually way earlier than that...<br>
<a href="https://lwn.net/Articles/239633/">https://lwn.net/Articles/239633/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/960997/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961035"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 7:36 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/961035/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So you mean the work keeps getting deferred?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961035/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961053"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 13:24 UTC (Tue)
                               by <b>syang</b> (subscriber, #141053)
                              [<a href="/Articles/961053/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess we're, uh... deferring their execution from the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961053/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor960998"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2024 17:58 UTC (Mon)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/960998/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You missed timers! IIRC one of the proposals for killing tasklets was to make them a timer that expired immediately.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/960998/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961008"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2024 20:33 UTC (Mon)
                               by <b>rgb</b> (subscriber, #57129)
                              [<a href="/Articles/961008/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why did that idea not get anywhere?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961008/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961030"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 2:33 UTC (Tue)
                               by <b>chexo4</b> (subscriber, #169500)
                              [<a href="/Articles/961030/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wait, so how exactly would that have worked?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961030/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961006"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2024 22:04 UTC (Mon)
                               by <b>klossner</b> (subscriber, #30046)
                              [<a href="/Articles/961006/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      Linus inverted the bottle. In classic BSD Unix and its successors, the bottom half is the interrupt handler and the top half is the thread to which work is deferred. I have to look up the terms to avoid confusion. See e.g. <a href="http://www.bitsavers.org/pdf/isi/bsd/490147A_4.3_PS2_Programmers_Supplimentary_Documents_Vol2_198707.pdf">UNIX Programmer's Supplementary Documents Volume 2 (PS2) 4.3 Berkeley Software Distribution</a>



      
          <div class="CommentReplyButton">
            <form action="/Articles/961006/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961027"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 0:14 UTC (Tue)
                               by <b>bertschingert</b> (subscriber, #160729)
                              [<a href="/Articles/961027/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I always thought the Linux usage of top/bottom half was confusing and counterintuitive. It's nice to know I'm maybe not the only one who thought the other way around makes more sense.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961027/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961038"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 8:36 UTC (Tue)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/961038/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; I always thought the Linux usage of top/bottom half was confusing and counterintuitive</span><br>
<p>
How so, though? If you imagine the work that needs to be done in response to an interrupt as a function written in an imperative language, with control flow from top to down, then the "top half" is the part that is executed first â€” in the actual interrupt handler â€” and the bottom half is executed second (using some sort of a deferred execution mechanism).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961038/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961045"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 10:05 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/961045/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another way to think about it is that interrupts are "closer to the hardware" which is "lower level". Once you come back "up" from there, you can do that deferred work.<br>
<p>
Not saying that this is right, but I've never found mnemonics like these easier to remember than the raw fact itself. For example, the I vs O in the power symbol is actually better remembered as 1 for "on" and 0 for "off" but I kept getting it mixed up with | is an open wire ("off") and a O is a closed circuit ("on").<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961045/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 15:24 UTC (Tue)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/961085/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hm, that's curious. I wonder if this is due to me not being a native speaker â€” for me, top/bottom and higher/lower (level) are completely disparate pairs of words, with little to no semantic overlap.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 18:03 UTC (Tue)
                               by <b>antiphase</b> (subscriber, #111993)
                              [<a href="/Articles/961113/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
top is synonymous with highest or uppermost, as in they are superlative-like; similarly (but reversed) for bottom/lowest/lowermost.<br>
<p>
higher/lower are comparative and don't indicate an absolute position, although you can argue that top and bottom are relative to one another as well.<br>
<p>
Ah, English.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961122"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 21:41 UTC (Tue)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/961122/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That seems correct, but I was rather making a different point. I learned these words in different contexts, and so it simply doesn't "click" in my brain that top/bottom is "almost like higher/lower". These words are "in different parts of my brain", that's why I never experienced the confusion described in the sibling thread.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961122/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2024 6:32 UTC (Sun)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/961735/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The top is the highest level?<br>
Like taking an elevator to the top.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor961055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 14:12 UTC (Tue)
                               by <b>bertschingert</b> (subscriber, #160729)
                              [<a href="/Articles/961055/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That actually does make sense, and I hadn't thought about it that way before. But my brain landed on and stuck with the "closer to the hardware = lower level" approach. After all, in OS diagrams, the hardware is usually at the bottom of the diagram, not the top.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961084"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 15:24 UTC (Tue)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/961084/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In fact, I believe this is actually the original intention behind this naming. (Also, see my reply to @mathstuf regarding higher/lower level.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961084/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor961114"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 18:10 UTC (Tue)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/961114/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hm, I thought in Linux the "top half" was the part that submitted work, and the "bottom half" was the deferred interrupt processing. I've been around Linux over 25 years, and I've never seen anyone call the interrupt handler the "top half". I've seen plenty of code call it the "DPC" (Windows terminology, I believe)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961114/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961123"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Upside-down halves</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 21:51 UTC (Tue)
                               by <b>amarao</b> (subscriber, #87073)
                              [<a href="/Articles/961123/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's very easy to understand where up and down is. Up is the same as the left-most, or the same as the front. Everyone can look on the byte and day where it begins and where it ends.<br>
<p>
... (Missing xkcd about using intuitive 4d navigation abstractions here)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961123/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961031"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 3:38 UTC (Tue)
                               by <b>shemminger</b> (subscriber, #5739)
                              [<a href="/Articles/961031/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The rational for tasklets (and softirq) goes all the way back to the networking overhaul that took place in 2.4 development. Back in 1999, there was a Microsoft sponsored web benchmark from Mindcraft that showed that Windows NT and IIS were faster than Linux and Apache. This was fixed by DavidM by tuning and fixing the networking stack.<br>
<p>
It was before my involvement in Linux, so don't know the exact details but heard that was the motivation to add softirq so that network SYN packets would get processed without expensive context switch to application.<br>
<p>
CPU vs network speeds have changed in 25 years, so tradeoffs made then maybe different.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961031/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961033"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 4:59 UTC (Tue)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/961033/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It looks like they're not changing how it runs, just how you write the code and how it's tracked in memory. If anything, context switches have gotten more expensive relative to everything else since 1999, but that doesn't mean that the method for avoiding them can't benefit from more recent API design lessons.<br>
<p>
Also, it's now possible to have other user space tasks that are more important and urgent than your web server performance, so it's worth being technically able to preempt it if necessary even if you normally wouldn't.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961033/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 15:40 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/961089/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Back in 1999, there was a Microsoft sponsored web benchmark from Mindcraft that showed that Windows NT and IIS were faster than Linux and Apache. This was fixed by DavidM by tuning and fixing the networking stack.</span><br>
<p>
MS had noticed that the linux stack bottle-necked on a single CPU, even on a multi-CPU machine. So they improved their stack to use all four CPUs on some monster machine, and successfully flooded 4 Gigabit network cards.<br>
<p>
They rapidly learnt not to try that sort of stunt. I can't remember how quick the community responded but, as with any perceived bugs in linux, there were fixes for the bottleneck within a day or so, and a proper solution went live within about a week. MS was left trailing in the dust ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961112"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 18:07 UTC (Tue)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/961112/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, muffin. It was 4x100Mbit. If you used a more natural 1Gbit card, Linux came out on top.<br>
<p>
But this is, was and always has been the game. I was part of it when I worked for Intel on Linux in the mid-2000s. Team A would work on Benchmark B and produce a result that beat Linux. So we'd take a look at what bottlenecks Benchmark B had on Linux, eliminate one, rerun the benchmark. Repeat until we beat Team A. Send patches upstream. Team A would typically come back to us a month or two later with an improved result and we'd repeat until either we or Team A lost interest.<br>
<p>
Competition is healthy, and as long as Benchmark B represents a real customer workload (and you're actually eliminating bottlenecks, not putting in special hacks for Benchmark B), this is a win for everybody. The downside of Linux basically making every other kernel irrelevant is that we've lost that impetus.<br>
<p>
See also LLVM vs GCC, Firefox vs Chrome, etc, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961112/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961150"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 7, 2024 10:54 UTC (Wed)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/961150/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>To some extent, the old thing of multiple competing forks of Linux provided the competition; if you have a choice between Torvalds, Cox, Kolivas and other kernels, where the Torvalds fork is the blessed version, and the Cox, Kolivas and other forks make different compromises to Torvalds. And then, the fact that for some workloads, Cox or Kolivas is "better" than Torvalds (but not for others) provides the impetus to work out whether there's a way to do better than all the forks include Torvalds' fork.
<p>To a limited degree, we've seen this with EEVDF; there were the latency-nice patches floating around (and efforts made to get latency-nice to fit in with the design of the CFS scheduler), which triggered investigation into alternatives to CFS, and then inspired Zijlstra to implement EEVDF in a way that matched or beat CFS while also providing latency-nice.



      
          <div class="CommentReplyButton">
            <form action="/Articles/961150/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961157"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 7, 2024 11:04 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/961157/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; which triggered investigation into alternatives to CFS, and then inspired Zijlstra to implement EEVDF in a way that matched or beat CFS while also providing latency-nice.</span><br>
<p>
And this is why Torvalds is such a good manager (and steward). He's not attached to his version, and he actively encourages these short-lived forks precisely to find the best way to do things. Which he then shamelessly appropriates :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961157/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor961034"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The end of tasklets</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2024 5:38 UTC (Tue)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/961034/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The threaded sysfs attributes take NET_RX handling mostly away from softirqs.   The rcu_nocbs kernel cmdline parameter takes RCU handling out of softirqs.   In the last year, as previously noted by LWN, Frederic Weisbecker tried and failed (again) to pull out timer softirqs.   If tasklets (and presumably also HI) softirqs could come out, that would leave ksoftirqd truly diminished.   Getting rid of softirqs altogether is still a dream, but not as implausible as it once seemed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961034/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
