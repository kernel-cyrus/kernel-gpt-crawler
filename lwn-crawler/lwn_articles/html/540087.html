        <!DOCTYPE html>
        <html lang="en">
        <head><title>Namespaces in operation, part 6: more on user namespaces [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/540087/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/540427/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/540087/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Namespaces in operation, part 6: more on user namespaces</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Michael Kerrisk</b><br>March 6, 2013</br>
           </div>
<p> In this article, we continue <a href="/Articles/532593/">last week's
discussion</a> of user namespaces.  In particular, we look in more detail
at the interaction of user namespaces and capabilities as well as the
combination of user namespaces with other types of namespaces. For the
moment at least, this article will conclude our <a
href="/Articles/531114/#series_index">series</a> on namespaces.




<h4>User namespaces and capabilities</h4>

<p> Each process is associated with a particular user namespace. A process
created by a call to <tt>fork()</tt> or a call to <tt>clone()</tt> without
the <tt>CLONE_NEWUSER</tt> flag is placed in the same user namespace as its
parent process. A process can change its user-namespace membership using
<tt>setns()</tt>, if it has the <tt>CAP_SYS_ADMIN</tt> capability in the
target namespace; in that case, it obtains a full set of capabilities upon
entering the target namespace.

<p>
On the other hand, a <tt>clone(CLONE_NEWUSER)</tt> call creates a new user
namespace and places the new child process in that namespace. This
call also establishes a parental relationship between the two
namespaces: each user namespace (other than the initial namespace) has a
parent&mdash;the user namespace of the process that created it using
<tt>clone(CLONE_NEWUSER)</tt>. A parental relationship between user namespaces
is also established when a process calls
<tt>unshare(CLONE_NEWUSER)</tt>. The difference is that <tt>unshare()</tt>
places the caller in the new user namespace, and the parent of that
namespace is the caller's previous user namespace. As we'll see in a
moment, the parental relationship between user
namespaces is important because it defines the capabilities that a process
may have in a child namespace.

<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p> Each process also has three associated sets of capabilities: permitted,
effective, and inheritable. The <a
href="http://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities(7)</a>
manual page describes these three sets in some detail. In this article, it
is mainly the effective capability set that is of interest to us. This set
determines a process's ability to perform privileged operations.

<p> User namespaces change the way in which (effective) capabilities are
interpreted. First, having a capability inside a particular user namespace
allows a process to perform operations only on resources governed by that
namespace; we say more on this point below, when we talk about the
interaction of user namespaces with other types of namespaces.  In
addition, whether or not a process has capabilities in a particular
user namespace depends on its namespace membership and the parental relationship
between user namespaces.  The rules are as follows:

<ol>

<li> 

A process has a capability inside a user namespace if it is a member
of the namespace and that capability is present in its effective capability
set.  A process may obtain capabilities in its effective set in a number
of ways. The most common reasons are that it executed a program that
conferred capabilities (a set-user-ID program or a program that has
associated file capabilities) or it is the child of a call to
<tt>clone(CLONE_NEWUSER)</tt>, which automatically obtains a full set of
capabilities.

</li>

<p>

<li>

If a process has a capability in a user namespace, then it has that
capability in all child (and further removed descendant) namespaces as
well. Put another way: creating a new user namespace does not isolate the
members of that namespace from the effects of privileged processes in a
parent namespace.

</li>

<p>

<li>

When a user namespace is created, the kernel records the
effective user ID of the creating process as being the "owner" of the
namespace.  A process whose effective user ID matches that of the owner of
a user namespace and which is a member of the parent namespace has all
capabilities in the namespace. By virtue of the previous rule, those
capabilities propagate down into all descendant namespaces as well. This
means that after creation of a new user namespace, other processes owned by
the same user in the parent namespace have all capabilities in the new
namespace.

</li>

</ol>

<p> We can demonstrate the third rule with the help of a small program, <a
href="/Articles/541230/"><tt>userns_setns_test.c</tt></a>. This program
takes one command-line argument: the pathname of a <a
href="/Articles/531381/#proc_pid_ns"><tt>/proc/PID/ns/user</tt></a> file
that identifies a user namespace. It creates a child in a new user
namespace and then both the parent (which remains in the same user
namespace as the shell that was used to invoke the program) and the child
attempt to join the namespace specified on the command line using
<tt>setns()</tt>; as noted above, <tt>setns()</tt> requires that the caller
have the <tt>CAP_SYS_ADMIN</tt> capability in the target namespace.

<p>For our demonstration, we use this program in conjunction with the <a
href="/Articles/539940/"><tt>userns_child_exec.c</tt></a> program developed
in the previous article in this series. First, we use that program to start
a shell (we use <tt>ksh</tt>, simply to create a distinctively named
process) running in a new user namespace:

<pre>
    $ <b>id -u</b>
    1000
    $ <b>readlink /proc/$$/ns/user</b>       # Obtain ID for initial namespace
    user:[4026531837]
    $ <b>./userns_child_exec -U -M '0 1000 1' -G '0 1000 1' ksh</b>
    ksh$ <b>echo $$</b>                      # Obtain PID of shell
    528
    ksh$ <b>readlink /proc/$$/ns/user</b>    # This shell is in a new namespace
    user:[4026532318]
</pre>

<p>
Now, we switch to a separate terminal window, to a shell running in the
initial namespace, and run our test program:

<pre>
    $ <b>readlink /proc/$$/ns/user</b>       # Verify that we are in parent namespace
    user:[4026531837]
    $ <b>./userns_setns_test /proc/528/ns/user</b>
    parent: readlink("/proc/self/ns/user") ==> user:[4026531837]
    parent: setns() succeeded

    child:  readlink("/proc/self/ns/user") ==> user:[4026532319]
    child:  setns() failed: Operation not permitted
</pre>

<p> The following program shows the parental relationships between the
various processes (black arrows) and namespaces (blue arrows) that have
been created:

<blockquote>
<img src="https://static.lwn.net/images/2013/namespaces/userns_hierarchy.png" alt="[A user namespace hierarchy]">
</blockquote>


<p> Looking at the output of the <tt>readlink</tt> commands at the start of
each shell session, we can see that the parent process created when the
<tt>userns_setns_test</tt> program was run is in the initial user namespace
(4026531837). (As noted in <a href="/Articles/531381/#proc_pid_ns">an
earlier article</a> in this series, these numbers are i-node numbers for
symbolic links in the <tt>/proc/</tt><i>PID</i><tt>/ns</tt> directory.) As
such, by rule three above, since the parent process had the same effective
user ID (1000) as the process that created the new user namespace
(4026532318), it had all capabilities in that namespace, including
<tt>CAP_SYS_ADMIN</tt>; thus the <tt>setns()</tt> call in the parent
succeeds.

<p> On the other hand, the child process created by
<tt>userns_setns_test</tt> is in a different namespace
(4026532319)&mdash;in effect, a sibling namespace of the namespace where
the <tt>ksh</tt> process is running. As such, the second of the rules
described above does not apply, because that namespace is not an ancestor
of namespace 4026532318. Thus, the child process does not have the
<tt>CAP_SYS_ADMIN</tt> capability in that namespace and the
<tt>setns()</tt> call fails.



<h4>Combining user namespaces with other types of namespaces</h4>

<p> Creating namespaces other than user namespaces requires the
<tt>CAP_SYS_ADMIN</tt> capability. On the other hand, creating a user
namespace requires (since Linux 3.8) no capabilities, and the first process
in the namespace gains a full set of capabilities (in the new user
namespace). This means that that process can now create any other type of
namespace using a second call to <tt>clone()</tt>.

<p> However, this two-step process is not necessary. It is also possible to
include additional <tt>CLONE_NEW*</tt> flags in the <i>same</i>
<tt>clone()</tt> (or <tt>unshare()</tt>) call that employs
<tt>CLONE_NEWUSER</tt> to create the new user namespace. In this case, the
kernel guarantees that the <tt>CLONE_NEWUSER</tt> flag is acted upon first,
creating a new user namespace in which the to-be-created child has all
capabilities.  The kernel then acts on all of the remaining
<tt>CLONE_NEW*</tt> flags, creating corresponding new namespaces and making
the child a member of all of those namespaces. 

<p> Thus, for example, an unprivileged process can make a call of the
following form to create a child process that is a member of both a new
user namespace and a new UTS namespace:

<pre>
    clone(child_func, stackp, CLONE_NEWUSER | CLONE_NEWUTS, arg);
</pre>

<p> We can use our <tt>userns_child_exec</tt>
program to perform a
<tt>clone()</tt> call equivalent to the above and execute a shell in the child
process. The following command specifies the creation of a new UTS
namespace (<tt>-u</tt>), and a new user namespace (<tt>-U</tt>) in which
both user and group ID 1000 are mapped to 0:

<pre>
    $ <b>uname -n</b>           # Display hostname for later reference
    antero
    $ <b>./userns_child_exec -u -U -M '0 1000 1' -G '0 1000 1' bash</b>
</pre>

<p>
As expected, the shell process has a full set of
permitted and effective capabilities:

<pre>
    $ <b>id -u</b>              # Show effective user and group ID of shell
    0
    $ <b>id -g</b>
    0
    $ <b>cat /proc/$$/status | egrep 'Cap(Inh|Prm|Eff)'</b>
    CapInh: 0000000000000000
    CapPrm: 0000001fffffffff
    CapEff: 0000001fffffffff
</pre>

<p> In the above output, the hexadecimal value 1fffffffff represents a
capability set in which all 37 of the currently available Linux
capabilities are enabled.

<p> We can now go on to modify the hostname&mdash;one of the global resources
isolated by UTS namespaces&mdash;using the standard <tt>hostname</tt>
command; that operation requires the <tt>CAP_SYS_ADMIN</tt> capability. First, we
set the hostname to a new value, and then we review that value with the
<tt>uname</tt> command:

<pre>
    $ <b>hostname bizarro</b>     # Update hostname in this UTS namespace
    $ <b>uname -n</b>             # Verify the change
    bizarro
</pre>

<p> Switching to another terminal window&mdash;one that is running in the
initial UTS namespace&mdash;we then check the hostname in that UTS
namespace:

<pre>
    $ <b>uname -n</b>             # Hostname in original UTS namespace is unchanged
    antero
</pre>

<p> From the above output, we can see that the change of hostname in the
child UTS namespace is not visible in the parent UTS namespace.



<h4>Capabilities revisited</h4>

<p> Although the kernel grants all capabilities to the initial process in a
user namespace, this does not mean that process then has superuser
privileges within the wider system. (It may, however, mean that
unprivileged users now have access to exploits in kernel code that was
formerly accessible only to root, as <a href="/Articles/540083/">this
mail</a> on a vulnerability in tmpfs mounts notes.)  When a new IPC, mount,
network, PID, or UTS namespace is created via <tt>clone()</tt> or
<tt>unshare()</tt>, the kernel records the user namespace of the creating
process against the new namespace.  Whenever a process operates on global
resources governed by a namespace, permission checks are performed
according to the process's capabilities in the user namespace that the
kernel associated with the that namespace.

<p> For example, suppose that we create a new user namespace using
<tt>clone(CLONE_NEWUSER)</tt>. The resulting child process will have a full
set of capabilities in the new user namespace, which means that it will,
for example, be able to create other types of namespaces and be able to
change its user and group IDs to other IDs that are mapped in the
namespace. (In the previous article in this series, we saw that only a
privileged process in the <i>parent</i> user namespace can create mappings
to IDs other than the effective user and group ID of the process that
created the namespace, so there is no security loophole here.)

<p> On the other hand, the child process would not be able to mount a
filesystem. The child process is still in the initial mount namespace, and
in order to mount a filesystem in that namespace, it would need to have
capabilities in the user namespace associated with that mount namespace
(i.e., it would need capabilities in the initial user namespace), which it
does not have. Analogous statements apply for the global resources isolated
by IPC, network, PID, and UTS namespaces.

<p> Furthermore, the child process would not be able to perform privileged
operations that require capabilities that are not (currently) governed by
namespaces. Thus, for example, the child could not do things such as
raising its hard resource limits, setting the system time, setting process
priorities, or loading kernel modules<strike>, or rebooting the
system</strike>. All of those operations require capabilities that sit
outside the user namespace hierarchy; in effect, those operations require
that the caller have capabilities in the initial user namespace.

<p> By isolating the effect of capabilities to namespaces, user namespaces
thus deliver on the promise of safely allowing unprivileged users access to
functionality that was formerly limited to the root user. This in turn
creates interesting possibilities for new kinds of user-space
applications. For example, it now becomes possible for unprivileged users
to run Linux containers without root privileges, to construct <a
href="http://dev.chromium.org/developers/design-documents/sandbox">Chrome-style
sandboxes</a> without the use of set-user-ID-root helpers, to implement <a
href="http://fakeroot.alioth.debian.org/">fakeroot</a>-type applications
without employing dynamic-linking tricks, and to implement <a
href="/Articles/252794/"><tt>chroot()</tt>-based applications</a> for
process isolation. Barring kernel bugs, applications that employ user
namespaces to access privileged kernel functionality are more secure than
traditional applications based on set-user-ID-root: with a
user-namespace-based approach, even if an applications is compromised, it
does not have any privileges that can be used to do damage in the wider
system.

<p>
<i> The author would like to thank Eric Biederman for answering many questions
that came up as he experimented with namespaces during the course of
writing this article series. </i><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Namespaces-User_namespaces">Namespaces/User namespaces</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/540087/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor541600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 18:04 UTC (Wed)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/541600/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm, what are those namespace IDs (4026531837 and 4026532318)? Those numbers are "prettier" in hex (0xeffffffd and 0xf00001de respectively) but it's not obvious (to me) where they come from. Did I miss that in an earlier article?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor541628"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 20:06 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/541628/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They're inode numbers of /proc/$pid/ns/user. (This is an identity for the namespace because all members of a given namespace have, in effect, all their "ns/user"s hardlinked together.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541628/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor541627"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 20:09 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/541627/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe you did miss it in an earlier article.<br>
<p>
Those numbers are proc inode numbers, which happen to be recorded in the symlink.<br>
<p>
If you need persistent names for any kind of namespace it is recommended that you do mount --bind /proc/PID/ns/user /a/filesystem/path.<br>
<p>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541627/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor541612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 18:45 UTC (Wed)
                               by <b>justincormack</b> (subscriber, #70439)
                              [<a href="/Articles/541612/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
reboot is actually a special case now (though not apparently documented in the man pages). The reboot syscall in a pid namespace just sends a SIGHUP to the namespaces init process, not a real reboot, so in this sense it is also a namespace capability.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor541689"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 23:41 UTC (Wed)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/541689/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>
<font color="purple">> reboot is actually a special case now
</font>

<p>
Thanks for that pointer; I'd missed that 3.9 change. I've added a strikethrough in the article. And something will make its way into the man page soonish.
      
          <div class="CommentReplyButton">
            <form action="/Articles/541689/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor541766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2013 11:33 UTC (Thu)
                               by <b>lyda</b> (subscriber, #7429)
                              [<a href="/Articles/541766/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As an aside, this is why the LWN comment section is the best comment section online. In a short exchange a missing piece of info was noted, an explanation of what happens was offered, the author of the article addressed the concern and a project gets a patch that makes it better.<br>
<p>
Not only was everything "civil," everything was positive and productive.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor541631"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Filesystems and security.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 20:21 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/541631/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is true that user namespaces allow userspace to interact with more code, and thus somewhat increases the surface one has to worry about for kernel exploits.<br>
<p>
However, most filesystems can not be mounted with just user namespace permissions.  Even for the filesystems you can mount with user namespace permissions remount is not supported.  So while the cited tmpfs issue could have been a problem it it occurred elsewhere in tmpfs, it was not exploitable with user namespaces.<br>
<p>
The recent work on converting all of the filesystems for user namespace support is essentially a constructive compiler checked proof that shows that all of the uids and gids that come from userspace are properly converted into kuids.  Making it safe to use existing filesystems in the presence of multiple user namespaces.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541631/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542933"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Filesystems and security.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 15:38 UTC (Thu)
                               by <b>impossible7</b> (guest, #89863)
                              [<a href="/Articles/542933/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; However, most filesystems can not be mounted with just user namespace permissions.</font><br>
<p>
Are there any plans to change this? If not, is there a reason for that?<br>
<p>
It would be nice if an ordinary user could create a user and mount namespaces and then e.g. mount an ext4 fs from a block device that they own.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542933/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor541635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource limits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2013 20:39 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/541635/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I expect there are some system administrators out there looking at this and asking: What resources limits are in place that can be used to limit user namespaces?<br>
<p>
The only answer at this point are memory control groups.  Everything takes up memory and limiting the amount of memory used limits everything else.  Unfortunately for the classic unix rlimit based resource limits fall down when multiple processes are involved.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor541767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource limits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2013 11:36 UTC (Thu)
                               by <b>lyda</b> (subscriber, #7429)
                              [<a href="/Articles/541767/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What options exist or interact with this? I worked on a system that doled out memory, cpu and disk usage to a subtree of processes in a container. That was mainly handled in userland; is there work being done to manage this within the kernel or is the feeling that userland is the correct place for this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor541961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource limits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2013 0:52 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/541961/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At a very basic level I don't see anything in any of the namespaces really being any different from any other process.  The big differences are is that it is now possible to allocate kinds of resources that no one has added rlimits for, and that if /etc/subuid is setup and your users have multiple uids per user limits go from mostly useless to totally useless.<br>
<p>
To my knowledge there is not much in the control groups that is namespace or container specific.  Although I seem to remember a network memory controller that had a connection with the network namespace.<br>
<p>
<p>
Beyond that it all depends on how heavy a sandbox you want to run.  Certainly with ptrace and a firm hand you can implement very fine control on processes.<br>
<p>
When done well I think the lightest weight solutions will live in the kernel.  Certainly the cpu controller seems to live up to that notion.<br>
<p>
But honestly whatever works and whatever is easiest.<br>
<p>
<p>
If there is any consensus of feeling on the matter it is that cgroups are ugly but they are the best general solution we have to the problem so far.<br>
<p>
Beyond that it looks like most of the time resource consumption is not a problem for most people.  With the result that technology to implement and enforce resource limits are frequently neglected.<br>
<p>
I hope that helps a little.<br>
<p>
Eric<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor542454"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource limits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2013 18:05 UTC (Mon)
                               by <b>BernardB</b> (subscriber, #47903)
                              [<a href="/Articles/542454/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm also interested in having cgroup management supported within namespaces. I've seen a couple of patchsets posted to LKML to attempt to achieve this - most recently from Gao Feng. It seemed to get strong opposition from Tejun Heo though, who was pushing for a userland solution: <a href="http://article.gmane.org/gmane.linux.kernel.containers/24825">http://article.gmane.org/gmane.linux.kernel.containers/24825</a><br>
<p>
I haven't seen anything more recent though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542454/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542481"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Resource limits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2013 21:05 UTC (Mon)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/542481/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't know if userland vs kernel is the appropriate way to characterize the debate.<br>
<p>
But yes there is a question of how unprivileged users can take advantage of the facilities cgroups offer, and how we can integrate cgroup support cleanly into containers.<br>
<p>
Last I heard mount --bind /cgroupfs/my/group /path/to/container/cgroupfs<br>
worked as a good approximation to what many people want.<br>
<p>
I have not had a chance to look at it in any detail beyond that.  It is nothing fundamentally hard it is just something that someone familiar with all the details needs to spend some time and to iron out.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542481/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor541794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2013 13:57 UTC (Thu)
                               by <b>rfrancoise</b> (subscriber, #15508)
                              [<a href="/Articles/541794/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you Michael for this fantastic article series!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/541794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2013 15:19 UTC (Sun)
                               by <b>cstanhop</b> (subscriber, #4740)
                              [<a href="/Articles/542251/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes. Thank you! This has been a great, comprehensive introduction to the namespace features.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor542102"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2013 17:07 UTC (Fri)
                               by <b>alexl</b> (subscriber, #19068)
                              [<a href="/Articles/542102/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I tried this in the latest Fedora kernel (3.8.1-201.fc18.x86_64), but it seems the user namespaces doesn't work:<br>
<p>
./userns_child_exec -U<br>
clone: Invalid argument<br>
<p>
strace says:<br>
clone(child_stack=0x7020f0, flags=CLONE_NEWUSER|SIGCHLD) = -1 EINVAL (Invalid argument)<br>
<p>
Isn't this supposed to work in 3.8.1?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542102/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2013 19:47 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/542128/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
cat /proc/config.gz | grep USER_NS<br>
<p>
Were user namespaces enabled?<br>
<p>
I expect the generic fedora build enables one of the filesystems that has not had a kuid/kgid conversion in 3.8 and thus can not enable user namespaces.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor542136"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2013 20:58 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/542136/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looking at the config in the kernel srpm, the user namespace isn't supported even in Rawhide yet (3.9.0-rc1).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542136/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2013 22:28 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/542154/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suspect it will have to wait until 3.10 when XFS stops turning off user namespaces.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542162"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2013 23:07 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/542162/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was actually planning on building my own kernel RPM with user namespaces this weekend. I don't use XFS anywhere, so I'm fine with the tradeoff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542162/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor557969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 7, 2013 12:58 UTC (Sun)
                               by <b>Tobu</b> (subscriber, #24111)
                              [<a href="/Articles/557969/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The XFS work isn't merged yet…

Does the same sort of <a href="https://lwn.net/Articles/540345/">complexity</a> exist for Btrfs, which exposes low-level structures through the search ioctl?
      
          <div class="CommentReplyButton">
            <form action="/Articles/557969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor542337"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2013 14:44 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/542337/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there going to be a tool to help manage namespaces (I'd guess from util-linux)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542337/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542473"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2013 20:56 UTC (Mon)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/542473/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the latest git of util-linux there is nsenter and unshare.<br>
<p>
There is code in lxc.<br>
<p>
Just for network namespaces there is code in iproute.<br>
<p>
There is work underway to get support for multiple uids and gids per user into shadow-utils.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542473/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor543243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2013 9:51 UTC (Mon)
                               by <b>Da_Blitz</b> (guest, #50583)
                              [<a href="/Articles/543243/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If none of the other options out there float your boat (LXC, unshare command or others) then you may want to try a tool i wrote to play with this from python called asylum. its available at <a rel="nofollow" href="http://code.pocketnix.org/asylum">http://code.pocketnix.org/asylum</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor556619"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 27, 2013 19:35 UTC (Thu)
                               by <b>Urhixidur</b> (guest, #91620)
                              [<a href="/Articles/556619/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What happens to the user ID mappings of a process when it switches user namespaces?  Are they zapped?<br>
<p>
I also presume the owner IDs of files are translated just like the owner IDs of processes? If a process in a user namespace tries to run an executable whose owner ID has not been mapped, will it be denied access?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/556619/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor779641"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Namespaces in operation, part 6: more on user namespaces</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2019 9:40 UTC (Wed)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/779641/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When a process switches user namespaces, its UID map will be the UID map of the user namespace that it moved to.<br>
<p>
Running an executable whose UID and GID have not been mapped is fine: since the file notionally has the "overflow IDs", the this means that the executing process will need o+x permission on the file to do the exec.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/779641/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
