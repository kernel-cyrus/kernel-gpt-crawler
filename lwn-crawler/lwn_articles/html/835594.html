        <!DOCTYPE html>
        <html lang="en">
        <head><title>Kernel support for processor undervolting [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/835594/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/835554/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/835594/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Kernel support for processor undervolting</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="GAByline">
           <p>November 2, 2020</p>
           <p>This article was contributed by Marta Rybczyńska</p>
           </div>
<p>Overclocking the processor — running it above its specified maximum
frequency to increase performance — is a familiar operation for many 
readers. Sometimes, however, it is necessary to go the other direction and 
<i>decrease</i> a processor's operating power point by lowering its voltage
to avoid overheating. Recently, Jason Donenfeld submitted a <a
href="/ml/linux-kernel/20200907094843.1949-1-Jason@zx2c4.com/">short
patch</a> removing a warning emitted by the kernel when user space accesses
special processor registers that allow this "undervolting" on x86
processors. It caused a long discussion that might result in a kernel
interface to allow users to safely control their processor's voltage.</p>

<h4>Voltage, frequency, and undervolting</h4>

<p>Current processors can run with any of a number of
combinations of frequency and voltage, which can change
dynamically in a process called <a
href="https://en.wikipedia.org/wiki/Dynamic_frequency_scaling">dynamic  
frequency scaling</a>. Different combinations of frequency and voltage
will naturally vary in terms of both the number of instructions executed
per second and power
consumption.  It is possible to place a CPU into a configuration outside of
its specified operational envelope; when this is done, the processor may
malfunction in a number of ways, from occasional false results from some instructions to a
complete crash.</p>

<p>For some users, lowering the operating voltage is a necessity. Their
chips, especially recent Intel laptop models, can overheat while running
under high load, for example when compiling a kernel.  One solution is to
undervolt the processors, making them run at the lower voltage to decrease
power consumption (and thus heat generation). As the frequency does not
change, the performance of the system stays about the same. Fortunately for
those users, tools like <a
href="https://github.com/kitsunyan/intel-undervolt"><tt>intel-undervolt</tt></a>
exist to help them in this task. However, they face two difficulties: the
values to use are undocumented and vary from one processor to the next, and
the kernel prints a worrisome warning every time the tool changes the configuration.

<p>In the case of Intel chips, the voltage settings are controlled by
<a href="https://en.wikipedia.org/wiki/Model-specific_register">Model
Specific Registers (MSRs)</a>, which do not just serve to change the
voltage, as MSRs are an interface to many processor settings.

On Linux, access to the MSRs from user space is possible using <tt><a
href="https://man7.org/linux/man-pages/man4/msr.4.html">/dev/cpu/CPUID/msr</a></tt>
special files.  Write access can be disabled, however, via the
<tt>msr.allow_writes</tt> boot-time option or if the kernel is running in
<a href="/Articles/791863/">lockdown mode</a>.  Within the kernel, MSR
access requires specific processor instructions and is handled by the <a
href="https://elixir.bootlin.com/linux/latest/source/arch/x86/kernel/msr.c">msr</a>
platform-specific driver. This driver emits a warning when an
attempt is made to write to a MSR that is not explicitly listed as being
safe to change; it still allows the write to happen, however, if writes are
enabled in general.
<p>
Donenfeld's
patch silences that warning by adding an entry to the list of safe MSRs.
That entry, named <tt>MSR_IA32_OC_MAILBOX</tt> by the patch,
allows changing the processor voltage; it is the register used by
<tt>intel-undervolt</tt> and other similar tools. Interested readers can
refer to a <a
href="https://github.com/mihic/linux-intel-undervolt">background paper</a>
on how those registers are configured. Apparently, this work is based on
partial documentation and a significant amount of reverse engineering with
trial and error.</p>

<h4>Undervolting as an essential feature</h4>

<p>Donenfeld's patch sparked a discussion about why direct access to MSRs from
user space is necessary. Borislav Petkov <a
href="/ml/linux-kernel/20200907100647.GB10657@zn.tnic/">suggested</a> that
it would be better to provide controlled access to specific registers via
sysfs and remove the ability to write directly to registers.  He later went further, <a
href="/ml/linux-kernel/20200908172558.GG25236@zn.tnic/">suggesting</a>
disabling user-space access to MSRs altogether by default. That provoked a number of
reactions from users who feel that this capability is essential. Donenfeld <a
href="/ml/linux-kernel/CAHmME9pKfvPGf97BM1=VdUL1uU_8aOoc4+QOu6b51XnPz3SkRA@mail.gmail.com/">explained</a>
that his system requires undervolting to remain usable and there are many
other users in the same situation:</p>

<div class="BigQuote">
    Well that's not cool. And it's sure to really upset the fairly sizable
    crowd of people who rely on undervolting and related things to make
    their laptops remotely usable, especially in light of the crazy
    thermal designs for late-era 14nm intel cpus. [...]
    I know that my laptop, at least, would suffer.
</div>

<p>Another example came from Sultan Alsawaf, who <a
href="https://lwn.net/ml/linux-kernel/20200908191838.GA2014@sultan-box.localdomain/">described
his experiences</a> with a number of laptop processors. Undervolting is
necessary on all of them when performing tasks like compiling the kernel;
it results in a 22-30% power use reduction and improved
performance. "<q>I'd like to point out that on Intel's recent 14nm
parts, undervolting is not so much for squeezing every last drop of
performance out of the SoC as it is for necessity</q>", he said.  Petkov
<a
href="https://lwn.net/ml/linux-kernel/20200908193029.GM25236@zn.tnic/">acknowledged</a>
this use case, saying that it should be better supported: "<q>Sounds to me
that this undervolting functionality should be part of the kernel and
happen automatically</q>".  Donenfeld <a
href="/ml/linux-kernel/CAHmME9pVO01mj8vgKPEX7a6pZDRSfX62e2Ow8R=L79hLSJoaMA@mail.gmail.com/">noted</a>
that doing it automatically could be hard, though, since the correct value
varies from one chip to the next depending on the "<q>silicon
lottery</q>". 
<p>

If this functionality is to be properly supported by the kernel, there are
some other questions to answer as well.  Donenfeld <a
href="/ml/linux-kernel/CAHmME9o_Odo97K7QXKO=konVE-UxR7iBCE5S8uAJgc=kJ2EgsA@mail.gmail.com/">asked</a>
where the right place to do such operations is: whether it belongs in
the kernel or user space. Petkov <a
href="/ml/linux-kernel/20200907111109.GB16029@zn.tnic/">then responded</a>
strongly in favor of the creation of "<q>a proper interface</q>" in
the kernel.  He also mentioned the in-tree <a
href="https://elixir.bootlin.com/linux/latest/source/tools/power/x86/x86_energy_perf_policy/x86_energy_perf_policy.c">x86_energy_perf_policy
tool</a> that uses a different MSR; that MSR too, he said, can be taken off
the allowlist once a real kernel interface to that functionality
exists. Donenfeld <a
href="https://lwn.net/ml/linux-kernel/CAHmME9pR5Z+G5Z-+-11Hr2gO+SXY6oVoDF+p0Ox7V1oHNVsBvg@mail.gmail.com/">agreed</a>
with this goal, but said it might be hard to achieve in practice because the
MSRs are not all publicly documented and differ in their semantics.</p>

<p>Srinivas Pandruvada, maintainer of Intel power-related drivers, <a
href="https://lwn.net/ml/linux-kernel/22617e57e541e460fac09db04fdb370f8e96e8ef.camel@linux.intel.com/">responded</a>
that overclocking (along with undervolting, presumably) is not an
architectural interface. There is also no public documentation of the
commands to be passed to this specific MSR. He promised to look for that
documentation internally.  A proper sysfs interface, he said,
would have to perform checks of the passed values to prevent
users from crashing their systems.</p>


<p>
<h4>Toward a solution</h4>

<p>At that point, Andy Lutomirski, maintainer of many x86-related
subsystems, <a
href="/ml/linux-kernel/025308CD-6E1A-41E1-8B3D-E9842CE00794@amacapital.net/">commented</a>
that MSR access and undervolting are two separate topics.  According to
him, MSR access should be allowed (with warnings emitted) only if
restrictions are off, but the undervolting feature should be supported by
the 
kernel.  He did point out a potential problem with lockdown, though, noting
that this feature could destabilize the system and perhaps enable privilege
escalation. He proposed a separate lockdown bit for this feature. Matthew
Garrett <a
href="/ml/linux-kernel/CACdnJusOJVb0xpecFgPQB4N2WhUORikv_1eXAcGfJ3xwBVTo9Q@mail.gmail.com/">pointed
out</a> the <a
href="https://www.plundervolt.com/doc/plundervolt.pdf">Plundervolt
[PDF]</a> attack, which allows the corruption of <a
href="https://software.intel.com/content/www/us/en/develop/topics/software-guard-extensions.html">Software
Guard Extensions (SGX)</a> enclaves using undervolting.  He also noted that
a sysfs interface would allow adding an SELinux or AppArmor rule and thus
protect the interface if needed.</p>

<p>About then, Pandruvada <a
href="/ml/linux-kernel/fa447f6b7c7f03cc0c55573d5736889cee81a1e6.camel@linux.intel.com/">returned</a>
with the answers from Intel. It turns out that the correct values come
from experimentation and <a
href="https://www.intel.com/content/www/us/en/gaming/resources/how-to-overclock.html">Intel's
guide</a> warns about possible stability issues.  There is kernel code that
uses the MSR in question now (the <a
href="https://elixir.bootlin.com/linux/latest/source/drivers/platform/x86/intel_turbo_max_3.c">intel_turbo_max_3
driver</a>), so the operation of that MSR is public, but there is no way to
validate the commands written to it, he said.</p>

<p>The discussion about where to put the functionality continued for
some time until Dave Hansen <a
href="/ml/linux-kernel/1188ee0f-f3cb-988f-474d-618bd5a5b879@intel.com/">proposed</a>
that Intel developers look into the documentation of the MSRs of as many
models as possible and create a separate driver, perhaps for only one
model at first. Petkov <a
href="/ml/linux-kernel/20201022192829.GG29222@zn.tnic/">agreed</a>, and the
discussion stopped at that point.</p>

<p>Kernel developers have thus come to an agreement that the undervolting
feature is essential for some users, who require it to keep their CPU
in reasonable thermal conditions. The path toward providing this feature
has also been laid out. One blocking point may be the lack of official
documentation, but it looks like there is a will from
Intel to solve this problem. The work still needs to be done, but we
can hope that the new interface is going to appear  soon.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Architectures-x86">Architectures/x86</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Rybczynska_Marta">Rybczynska, Marta</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/835594/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor835874"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2020 18:08 UTC (Mon)
                               by <b>darwi</b> (subscriber, #131202)
                              [<a href="/Articles/835874/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I have an i9-9880H laptop which, at 4000 MHz on all CPUs while compiling a kernel, uses 107W with the stock configuration. Upon undervolting, this figure goes down to 88W, a ~22% reduction in power consumption at the maximum pstate. The point of this is not primarily to reduce the power footprint of my machine, but to get the thermals of this CPU under control. Without undervolting, my i9-9880H is quite useless, and quickly reaches 100 degC with the fans at max speed when placed under load.</font><br>
<p>
<font class="QuotedText">&gt;  Donenfeld noted that doing it automatically could be hard, though, since the correct value varies from one chip to the next depending on the &quot;silicon lottery&quot;. </font><br>
<p>
TL;DR late-era 14nm Intel cpus, or at least the manufactures putting them inside laptops without proper thermal packaging, suck.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835874/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835913"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 12:22 UTC (Tue)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/835913/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s more that there is no proper thermal packaging for these chips at all. Their TDW ratings are almost all averages under some unspecified benchmarks instead of true peak TDW&#x27;s. So for average browsing? The thermals are fine. But if you actually try to load down the CPU fully (and who would buy a top-flight CPU in a laptop unless they&#x27;re going to load it down fully) the &quot;rated&quot; TDW gets defenestrated with extreme prejudice.<br>
<p>
Some generations of Surface laptops are infamous for this: You get WORSE performance if you got the models with &quot;upgraded&quot; CPUs because the higher CPU&#x27;s hit thermal throttle near-instantly under full load.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835913/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor835879"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2020 19:10 UTC (Mon)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/835879/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is undervolting still relevant at all in light of Plundervolt, which is commonly “mitigated” by unconditionally disabling undervolting on firmware level?<br>
<p>
I assumed Plundervolt killed undervolting, at least en masse. Is this not true? Or are we talking strictly about old generations of laptops, carefully kept off the relevant firmware patches by a handful of enthusiasts?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835879/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 12:24 UTC (Tue)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/835914/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Plundervolt can be entirely ignored if you&#x27;re not using SGX. It&#x27;s only a way to circumvent the SGX mechanisms. Hint: You&#x27;re very likely not using SGX.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 13:37 UTC (Tue)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/835918/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, but tell that to laptop vendors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor835896"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2020 23:28 UTC (Mon)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/835896/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would greatly appreciate this on an old AMD (btver1) I have, so that I don&#x27;t have to run it permanently underclocked. Chances of anything AMD getting decent Linux support these days seem to be nil though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835896/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor835905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 3:56 UTC (Tue)
                               by <b>magila</b> (guest, #49627)
                              [<a href="/Articles/835905/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The proper (at least if you ask Intel) way to deal with an overheating processor is to lower the power limit settings to a level that the cooling solution can handle. You give up some frequency doing this of course, but you&#x27;ll still be operating within the envelope which has been validated at the factory.<br>
<p>
While undervolting doesn&#x27;t carry the risk of degrading the silicon like overclocking, it does still involve operating outside of what the manufacturer has validated as stable. Most overlockers don&#x27;t do adequate validation that their overclocks are stable (firing up Prime95 or IntelBurnTest is often enough to crash their systems) and I doubt these undervolters are either. There&#x27;s a reason why Intel treats messing with these MSRs as &quot;overclocking&quot; regardless and doesn&#x27;t support it.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835912"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 11:37 UTC (Tue)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/835912/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While operating an electronic component out of spec is certainly something no manufacturer would ever support (so don&#x27;t complain to Intel if your CPU crashes or produces incorrect results when undervolted), I don&#x27;t think the kernel should actively try to prevent it. If it&#x27;s *my* system, then *I* want to decide how I use it and what risks I&#x27;m willing to take. Perhaps a taint flag would be adequate?<br>
<p>
<font class="QuotedText">&gt; Most overlockers don&#x27;t do adequate validation that their overclocks are stable (firing up Prime95 or IntelBurnTest is often enough to crash their systems) and I doubt these undervolters are either.</font><br>
<p>
People who overclock or undervolt without adequate testing are idiots, probably looking for nothing more than (dubious) bragging rights. Of course idiots exist, but at the same time there&#x27;s no shortage of people painstakingly documenting their (often very thorough) testing procedures when performing such experiments. I know I spent many hours running Prime95 and other tools when I undervolted my Pentium M laptop some 15 years or so ago, and (after finding the lowest stable voltage) I never had any problems whatsoever with it.<br>
<p>
Obviously I didn&#x27;t test at the extremes of the manufacturer supported environmental conditions, but for non-critical usage, &quot;works for me&quot; is fine by me. And for anything critical, relying on a single implementation of a single algorithm running on a single machine (an out of spec one at that) is stupid anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835912/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835915"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 12:37 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/835915/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; While operating an electronic component out of spec is certainly something no manufacturer would ever support (so don&#x27;t complain to Intel if your CPU crashes or produces incorrect results when undervolted)</font><br>
<p>
The problem is, AS SUPPLIED TO THE CUSTOMER, normal operation results in the processor going out of spec! If the processor cannot be used within spec without problems, then the customer is bound to be upset and want to do something about it.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835915/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor835931"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 15:53 UTC (Tue)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/835931/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I don&#x27;t think the kernel should actively try to prevent it. If it&#x27;s *my* system, then *I* want to decide how I use it and what risks I&#x27;m willing to take. Perhaps a taint flag would be adequate?</font><br>
<p>
The kernel doesn’t particularly care if you run your CPU out of spec, although a taint flag might make sense. The kernel cares about using the wildly unsafe userspace MSR interface to do so.  As it stands, poking at the MSRs used for undervolting may race against other uses of those MSRs, resulting in unpredictable behavior.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835931/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor835991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 4, 2020 6:42 UTC (Wed)
                               by <b>fulke</b> (guest, #140430)
                              [<a href="/Articles/835991/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agreed. Proper solution should be setting PL1/PL2 value to limit watt usage. Of course then the CPU downclocked but it&#x27;s trade-off. (Blame Intel&#x27;s process or Manufacturer&#x27;s poor heat design)<br>
<p>
BTW support for undervolting is great! It&#x27;s hacky feature like overclocking rather than proper solution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor837282"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2020 17:37 UTC (Sun)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/837282/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s extremely unfair characterisation, dies vary and under-volting is merely reducing the V below the worst case required for the skew when passing validation testing.<br>
If the die functions correctly it is wasting less power and running cooler.<br>
It is the same binning done by manufacturers in providing power efficient skews they sell operating at lower voltage.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837282/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor836613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 9, 2020 16:01 UTC (Mon)
                               by <b>abufrejoval</b> (guest, #100159)
                              [<a href="/Articles/836613/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And I am doing this for i7 NUC8 and NUC10 variants, which have fine grained controls for PL1/2 and their timings in their BIOS, which I use mostly to ensure that their fans never get annoying. <br>
<p>
The problem is that regrettably notebooks don&#x27;t tend to expose these options and I&#x27;m afraid I&#x27;ve already overcooked a battery in an otherwise rather nice Lenovo Yoga S730 with an i7-8565U, because it&#x27;s lost 30% of its capacity after a year, when that battery was practically never used.<br>
<p>
But I had the machine run as a CentOS7/oVirt server when I wasn&#x27;t on the road with it (not since the start of Covid-19), where the default power management profile is set to &#x27;virtual host&#x27; by default. With the lid closed it did get rather warmer than it should for the sake of the battery, while the cooling fan actually stayed nicely unobtrusive.<br>
<p>
From the sound of it, the ability to set the PL1/2 parameters and their timings via a kernel boot flag would cover a lot of ground already, while full control typically comes with plenty of opportunities for additional mistakes or loopholes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/836613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor836687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 9, 2020 20:38 UTC (Mon)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/836687/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the firmware hasn&#x27;t locked them then PL1/PL2 can be modified using the intel_rapl driver and the nodes under /sys/class/powercap. If the firmware /has/ locked them, the kernel can&#x27;t override them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/836687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor835907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 5:00 UTC (Tue)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/835907/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indefensible:<br>
&quot;Srinivas Pandruvada, maintainer of Intel power-related drivers, responded that overclocking (along with undervolting, presumably) is not an architectural interface. There is also no public documentation of the commands to be passed to this specific MSR. He promised to look for that documentation internally.&quot;<br>
<p>
In a sane world, the processor-specific MSR registers and their interface would be made visible via ACPI so that sysfs could be properly set up.    It&#x27;s hard to understand how Intel&#x27;s customers let them get away with this lack of documentation.<br>
<p>
Thanks to Marta Rybczyńska for another fine article.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835959"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 17:54 UTC (Tue)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/835959/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suspect that those of Intel’s big customers who care enough manage to get NDA docs.<br>
<p>
Part of the problem here is that Intel takes “architectural” features quite seriously. When Intel commits to an architectural feature, they are promising to retain compatibility for a long long time. With things like the frequency and voltage control in recent CPUs, the underlying way that they’re managed changes dramatically on a regular basis. Intel probably doesn’t want to guarantee that the knob that undervolting currently turns will continue to make any sense on future CPUs.<br>
<p>
Unfortunately, Intel seems to be pretty bad as documenting details like “this is how it works *now*; no promises that it will continue to work this way.”  It’s also worth noting that documentation is expensive. For docs to be any good, not only do they need to be written, but someone needs to verify that the docs match the hardware and the software implementations.  In contrast, it’s easier to hack together something that works under the exact parameters under which it’s shipped.<br>
<p>
Skipping the engineering involved in making a real spec cuts both ways, of course. Take a look at the series of bugs and unfortunate behavior in the interactions between various flavors of AVX and thermal / power management. Building something that appears to work without exploring the nasty corners means that it could very well be possible that the corners are wrong in a way that actually matters.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835959/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor835967"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 19:55 UTC (Tue)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/835967/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Building something that appears to work without exploring the nasty corners means that it could very well be possible that the corners are wrong in a way that actually matters.</font><br>
<p>
Violently agree!    Code review and unit tests are your friends.   Intel would benefit too from providing this data via ACPI.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835967/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor836001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 4, 2020 10:47 UTC (Wed)
                               by <b>nilsmeyer</b> (guest, #122604)
                              [<a href="/Articles/836001/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
May be interesting to look at this for AVX2 and AVX512 (though those CPUs are rare) workloads where the power draw is usually higher. I think most of those prime / cpu burn things do not use any vector instructions. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/836001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor836152"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel support for processor undervolting</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 4, 2020 20:53 UTC (Wed)
                               by <b>nivedita76</b> (guest, #121790)
                              [<a href="/Articles/836152/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
prime95 does use AVX. It&#x27;s core algorithm uses a multiplication implemented via fast Fourier transforms.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/836152/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
