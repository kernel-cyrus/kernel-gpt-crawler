        <!DOCTYPE html>
        <html lang="en">
        <head><title>A weak cryptoloop implementation in Linux? [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/67216/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/66288/">Return to the Security page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/67216/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A weak cryptoloop implementation in Linux?</h1>
<div class="Byline">[Posted January 21, 2004 by corbet]
               <p>
               </div>
</div>
<div class="ArticleText">
The "cryptoloop" code in the Linux kernel allows "loopback" mounts of
filesystems.  Essentially, cryptoloop looks like a block driver which
encrypts data on its way through.  It can thus be used to add encryption to
any of the standard Linux filesystems without changing the filesystem code
itself. 
<p>
Recently, in response to a bug report with the 2.6.1-mm3 cryptoloop
implementation, Jari Ruusu made <a href="/Articles/67217/">a disturbing
claim</a>: 
<p>
<div class="BigQuote">
	If you want your data secure, you need to re-encrypt your data
	anyway.  Mainline loop crypto implementation has exploitable
	vulnerability that is equivalent to back door. Kerneli.org folks
	have always shipped back-doored loop crypto, and now mainline folks
	are shipping back-doored loop crypto.  Kerneli.org derivatives such
	as Debian, SuSE, and others are also back-doored.
</div>
<p>
It will come as no surprise that this message was followed by requests for
more details on the "back-doored" cryptoloop.  Jari <a
href="/Articles/67223/">obliged</a> with a clear, technical explanation of
what is going on.  If you are using (or considering) cryptoloop. it is
worth a look, even if there may be no need for immediate panic.
<p>
The problem, it seems, is that cryptoloop is susceptible to a certain kind
of known plaintext attack.  For any given filesystem type, the contents of
certain sectors will be easy to predict.  Given some time and an idle
processor, an attacker can generate an exhaustive dictionary of likely
passwords and the resulting ciphertext that will appear on disk.  With
access to the actual, encrypted disk, a quick lookup in the dictionary will
yield the password and enable decryption of the entire filesystem.  This
attack is not practical for casual snoopers, but it would not be entirely
surprising if government agencies and other, relatively organized groups
had this sort of dictionary handy.
<p>
There are two ways of getting around this sort of problem.  One is to
choose a lengthy, non-obvious password.  The other is to use salted
passwords, where the password is modified by a randomly-chosen value before
the data is encrypted.  The salt value has to be retrievable, but it has
the effect of requiring an attacker to create a separate dictionary for
every possible number.  If the range of salt values is large enough,
salting the password will render the dictionary attack impractical.
<p>
The end result is that most cryptoloop users need not go into an immediate
panic, but this weakness is worth being aware of.  It would also be a good
idea to get a stronger mechanism into the mainline kernel.  There is little
to be gained and much to be lost by shipping crypto code with known
weaknesses.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer-Loopback_device">Block layer/Loopback device</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Cryptoloop">Cryptoloop</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security">Security</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/67216/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor67271"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 8:32 UTC (Thu)
                               by <b>error27</b> (subscriber, #8346)
                              [<a href="/Articles/67271/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      &gt; Kerneli.org loop crypto implementation (and derived versions such as <br>&gt; Debian, SuSE and others) are vulnerable to optimized dictionary attacks <br>&gt; because they use unseeded (unsalted) and uniterated key setup.<p>This is a flaw, but it's not a back-door.  &quot;Back-door&quot; implies malice and deliberate deceit.  It's a bad word to use unless you want to offend someone.<p>The article explains salting, but the other part of the solution is in the &quot;uniterated&quot;.  Basically, you take the password and the salt and you hash them.  Take that hash and hash it.  Repeat the process as many times as you can in .2 seconds.  Save the salt and the number of times you hashed the password and salt so you can check the password later.<p>If you use a 128 bit salt the attacker can't use a dictionary attack directly, but he can still test thousands of possible passwords in a second.  With the extra hash iterations the attacker can only test 5 possible passwords in a second.<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/67271/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67392"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 16:23 UTC (Thu)
                               by <b>freethinker</b> (guest, #4397)
                              [<a href="/Articles/67392/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Well, multiplied by the number of processors and cycles the attacker has, with their large budget, compared to the number you have, with your single machine. But it's still a good idea, as long as the hash algorithm doesn't tend to converge or something.<p>In any case, while salt is good and should be used in any implementation, real security comes from a good passphrase.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/67392/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor72741"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2004 21:38 UTC (Tue)
                               by <b>quantus</b> (guest, #19763)
                              [<a href="/Articles/72741/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Wouldn't aplying an offset to losetup significanly increase the dificulty of finding the location of <br>the encrypted &quot;plain&quot; text of which to launch the dictionary attack?<p>&gt;On popular file systems<br>&gt;such as ext2, ext3, reiserfs and not so popular minix, first 16 bytes of<br>&gt;fourth 512 byte sector is such good known plaintext. Byte offset 0x600 to<br>&gt;0x60F of plaintext contain all zero bits. File system itself does not use<br>&gt;that data at all, but mkfs for file system in question puts that known<br>&gt;plaintext there.
      
          <div class="CommentReplyButton">
            <form action="/Articles/72741/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor67276"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 11:00 UTC (Thu)
                               by <b>ekj</b> (guest, #1524)
                              [<a href="/Articles/67276/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      This is a quite strange claim. First, as is pointed out here, at worst it's a bug, not a back-door. A back-door is something deliberate.&lt;p&gt;<p>Secondly, this does nothing at all for the attacker who wants to crack a single encrypted filesystem. It &lt;b&gt;is&lt;/b&gt; true that because of the lack of salt, an attacker who wants to crack a large number of encrypted filesystems has an advantage as he can calculate the encrypted version of the &quot;likely&quot; passwords only once instead of once for each filesystem as would be required with a salt.&lt;p&gt;<p>However, this ain't *that* horrible a vulnerability. First, it only helps by a factor of how many encrypted filesystems (of the same type) you want to crack. Secondly, it only helps for those passwords that are simple enough that they'll appear in a list of &quot;likely&quot; passwords. With current storage it's not reasonable to create dictionaries much larger than a terabyte. So, loosely, if your password is not among the most common billion passwords, you're in the clear. Choosing a good password is required for security anyways.&lt;p&gt;<p>All this means is, if you need real security, choose a password with more than 40 bits of real entropy in it, or a dictionary like this could be constructed and help crack it. Dictionaries with much more than 2^40 entries are unlikely to be practical at the moment. &lt;p&gt;<p>Offcourse 2^40 possible keys kan reasonably be brute-forced even without a dictionary as a one-off crack. So to guard against this you'd want a better password than this anyway.&lt;p&gt;<p>It's true that the set of passwords that can a) Be reasonably memorized and b) cannot reasonably be brute-forced is rapidly approaching zero. But that's a fundamental problem and has nothing in particular to do with the crypto-loop implementation.
      
          <div class="CommentReplyButton">
            <form action="/Articles/67276/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67346"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 13:29 UTC (Thu)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/67346/">Link</a>] 
      </p>
      
      </div>
      </summary>
      [ I agree it is not a backdoor since it requires a dictionnary attack. ]  <br>  <br>&gt; Secondly, this does nothing at all for the attacker who wants to crack a  <br>&gt; single encrypted filesystem.  <br>  <br>That's not true. This weakness allows to precompute the table without  <br>more knowledge of the targeted system. At this point, the part of  <br>the exploit that require access to the crypto-loop device can be carried  <br>out very quickly.   <br>  <br>The second problem: if someone is able to have a quick access to the  <br>device, he just need to read a known plain-text sector. With that  <br>knowledge he can try a dictionnary attack to recover the password without  <br>more access.  <br> <br>Suppose you keep password-less SSH keys on a crypto-loop on a USB stick:  <br>with the attack above, the crypto-loop will be broken in before you notice  <br>the USB stick was stolen so you may not have time to disabled them before  <br>they get used.  
      
          <div class="CommentReplyButton">
            <form action="/Articles/67346/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor67357"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 13:26 UTC (Thu)
                               by <b>macc</b> (guest, #510)
                              [<a href="/Articles/67357/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      What about replacing the known<br>plaintext strings with (random) <br>text?
      
          <div class="CommentReplyButton">
            <form action="/Articles/67357/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67358"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 13:45 UTC (Thu)
                               by <b>gyles</b> (guest, #1600)
                              [<a href="/Articles/67358/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <br>I imagine the known plaintext refers to known features of the file system - partition tables, inode/FAT tables, root directory structures etc.
      
          <div class="CommentReplyButton">
            <form action="/Articles/67358/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 15:28 UTC (Thu)
                               by <b>IkeTo</b> (subscriber, #2122)
                              [<a href="/Articles/67380/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      But the alternative to just XOR every disk block with a 4096-byte random string (and store that string somewhere, in plaintext) before passing it to the loopback device will work to stop the attack described here.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/67380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2004 20:50 UTC (Fri)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/67715/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Better would be to generate that random string through a pseudorandom<br>number generator given a seed like the position of that block.  I thought<br>this was already done?  I mean this is basically the initialization<br>vector and without it identical blocks on disk would be identical after<br>they were encypted... leaking all kinds of information.  If this is not<br>done it is a very serious bug.  If it is done, why is this other attack<br>a problem?  Is the seeds for the generator the same for every filesystem?<br>If so, a simple fix would be to store a single value to XOR with the<br>offset before calculating the IV.
      
          <div class="CommentReplyButton">
            <form action="/Articles/67715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor67605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2004 13:47 UTC (Fri)
                               by <b>bockman</b> (guest, #3650)
                              [<a href="/Articles/67605/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I wonder if it is would be possible to store such 'known plaintext' as real plaintext, thus making it useless for an attacker. But maybe this
would make the cryptoloop not transparent to the above file system code.
<p>
The conclusion seems to be that it is more secure to encrypt each single file that the whole filesystem. 
      
          <div class="CommentReplyButton">
            <form action="/Articles/67605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor67456"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2004 20:32 UTC (Thu)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/67456/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Why not just calculate a number based on the password in range of:<br>0 - [number of sectors in the loopfile]<br>And then offset the sectors on the loopfile by that number (and doing modulo when the sector index goes over number of sectors) when accessing the files?<p>That should be pretty easy to implement...
      
          <div class="CommentReplyButton">
            <form action="/Articles/67456/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor67545"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What about 20 characters?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2004 11:27 UTC (Fri)
                               by <b>paulsheer</b> (guest, #3925)
                              [<a href="/Articles/67545/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <br>When you run losetup, it does not let you proceed unless<br>the password is more than 20 characters:<p>  /sbin/losetup -e AES128 /dev/loop0 FILE<br>  Password: xxxx<br>  Error: Password string must be at least 20 characters.<p>20 ascii characters is a 130 bit key.<br>if they are lower case only, and composed of whole<br>words (and, say, there are 10000 words to choose from)<br>then we have (10000^5) ~= 66 bits.<p>- this is a worst case, but long enough to be secure IMO.<p>My question is: was the loopback device ever MEANT to<br>be secure against a chosen plaintext attack? Surely not.<br>I believe it should be dead obvious to users <br>that a long key is essential because there is<br>no protocol protection.<p>Further the other vulnerabilities should<br>also be obvious: key snooping + memory snooping<br>during setup, etc. these are all *obvious* attacks that<br>the user ought to be aware of. Also you can't really be<br>protected against such attacks within the scope of what<br>such software is trying to provide.<p>the loopback device is possibly the best way of securing<br>your data because its simple and clean and basically as<br>as secure the block cipher you are using.<p>-paul<p><br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/67545/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What about 20 characters?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2004 6:23 UTC (Sat)
                               by <b>obobo</b> (guest, #684)
                              [<a href="/Articles/67759/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Typical entropy for text is about one bit per character, IIRC.  That is taking into account correlations between adjacent words, etc.  Granted that it is probably somewhat higher for short text fragments, but still... a dictionary of 2^40 passphrases would be rather potent for cracking 20 character text-fragment based passwords.
      
          <div class="CommentReplyButton">
            <form action="/Articles/67759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor69150"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What about 20 characters?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 2, 2004 15:47 UTC (Mon)
                               by <b>lars_stefan_axelsson</b> (guest, #10660)
                              [<a href="/Articles/69150/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>Typical entropy for text is about one bit per character, IIRC. That is taking into account correlations between adjacent words, etc. Granted that it is probably somewhat higher for short text fragments, but still... a dictionary of 2^40 passphrases would be rather potent for cracking 20 character text-fragment based passwords. </blockquote>

<p>Well, the estimates of the entropy of 'typical' English texts range from anywhere between 1.0 and 2.63 (One of Shannon's estimates), and 2.0 would give you 40 bits. However, and that's a big 'however' IMHO, we're not talking typical English text, but a passphrase. Password entropy can easily be 4 bits per character without having to remember a 'random' password, and there's no reason not to choose a passphrase consisting of several 'password like' words strung together.</p>

<p>That ought to give you a decent passphrase with sufficient entropy in 20 characters.</p>

<p>I'm ignoring the general hopelessness of the entire subject of passwords, of course. But if you're savy enough to be able to use loopback encryption, and sufficiently bothered by secrecy issues to bother, you ought to be able to come up with a decent passphrase and commit it to memory.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/69150/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor67637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2004 16:21 UTC (Fri)
                               by <b>spudbeach</b> (guest, #5837)
                              [<a href="/Articles/67637/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      One other way around the problem is Cipher Block Chaining (CBC), where the output of each block is dependent on all prior blocks, as well as a randomly chosen initial vector (IV).  That basically makes known plaintext / dictionary attacks such as this one useless, unless they are on the first block encrypted.  All at very little cost to decrypt, too.<p>Oh, and should anybody not trust Juri, note that he has been the big guy in the loop-AES project for a couple of years, doing loop mounted crypto outside of the kernel.  Yes, he does know what he's doing.  And yes, I'm sticking with loop-AES, for at least a couple of years. [And BTW:  loop-AES is by design free from this attack:  rather than using a passphrase directly, a true random key is used, which is then encrypted with a passphrase -- hence, one more step between the passphrase and known plaintext.]<p>Steve Beach<br>GPG key ID 7675D05E<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/67637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor67717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2004 20:52 UTC (Fri)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/67717/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Wouldn't that cause severe problem for a random-access read/write block<br>device?  A change to a block would require reading, decrypting,<br>reencrypting, and finally re-writing every block that came after it!
      
          <div class="CommentReplyButton">
            <form action="/Articles/67717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor154582"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 5, 2005 18:05 UTC (Wed)
                               by <b>kokopelli</b> (guest, #11341)
                              [<a href="/Articles/154582/">Link</a>] 
      </p>
      
      </div>
      </summary>
      You always have to read and write a complete disk page.  Each page should be handled independently for various reasons.  The only information that should "leak" into the encryption process is the absolute or relative block offset - as others mentioned it's used to set up a different 'initialization vector' for each page.  (Global or per-page salt would also end up in the IV.)<br>
<p>
Block ciphers will typically encrypt 8 to 32 bytes as a unit.  If they're run independently you get a 'codebook' cipher - vulnerable to known-text attack anywhere within the disk page.  If they're chained you're only vulnerable for the first cipher block of each page.  There's no real cost to chaining as long as it doesn't extend beyond the disk page.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/154582/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor68932"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2004 20:57 UTC (Fri)
                               by <b>jmason</b> (guest, #13586)
                              [<a href="/Articles/68932/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Surely lack of salting is a really basic issue?  I'm surprised it took so long for someone to notice this, to be honest. <p>A good implementation, actually, would be to reserve a few bytes at the start of every block for a per-block salt value; along with a per-volume salt, that should cause quite a bit of difficulty for prospective attackers. ;)<p>But I definitely would agree with other posters, and not call this issue a &quot;back door&quot;.
      
          <div class="CommentReplyButton">
            <form action="/Articles/68932/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor71989"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 14:56 UTC (Thu)
                               by <b>raegis</b> (guest, #19594)
                              [<a href="/Articles/71989/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I think people have been ignoring the problem for a long time.
      
          <div class="CommentReplyButton">
            <form action="/Articles/71989/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor76755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 23, 2004 2:53 UTC (Tue)
                               by <b>sproket</b> (guest, #20386)
                              [<a href="/Articles/76755/">Link</a>] 
      </p>
      
      </div>
      </summary>
      This is just silly. Cryptoloop is not broken if you use it right, and there's no good reason to change the way it works. Especially now that the hashing has rightfully been pulled out of the kernel layer. All you have to do is copy a few bytes of random data into a file as a salt. Save it in clear form to your disk. Then when you want to setup encrypted swap, hash your salt file with your password and pipe that to losetup as your key. Voila!<br>It would be terribly stupid to try and store the salt on the block device you were encrypting, it would either force you to overwrite block data, or shift it.
      
          <div class="CommentReplyButton">
            <form action="/Articles/76755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor90337"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A Solution to the Known Plain Text Problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 20, 2004 19:23 UTC (Sun)
                               by <b>nj</b> (guest, #22465)
                              [<a href="/Articles/90337/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Here is a proposed solution to known plain text vulnerability.  I am optimistic but not confident of it's cryptographic worth and would like feedback.<p>The procedure:<br>	Create and store a segment of random data equal in size to the data being encrypted.<br>	XOR the user data with stored random data.<br>	Encrypt both the random segment and the user data with conventional block cipher methods.<p>Since the user data was XORed with randomness, reminiscent of OTP, this would prevent usage of a precomputed dictionary against known plain text.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/90337/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor101788"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2004 13:38 UTC (Mon)
                               by <b>schander</b> (guest, #24686)
                              [<a href="/Articles/101788/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      The known-plaintext attack that is described is not specific to cryptoloop, but to just about any encrypted filesystem that does not pre-whiten the plaintext before encryption. Under no circumstance can this be called a backdoor in cryptoloop.<br>
<p>
In any event, there are very simple existing userland fixes that make cryptoloop invulnerable to this kind of dictionary attack:<br>
<p>
1) The simplest method involves the use of true cryptographically-random strings (from /dev/random, for example) as the first-level passphrase; encrypt them with a hashed, second-level salted passphrase as the key, and store the encrypted first-level passphrase with the salt. To setup the cryptoloop, just decrypt the encrypted first-level passphrase and use it. <br>
<p>
(This is the approach that is taken by both pam_mount, as well as pam_losetup from my project, qryptix. In both cases, the main goal is to use the standard Linux login password (even with insufficient entropy) as the second-level passphrase. But the lack of entropy in the second-level passphrase is compensated for by salting and hashing it, and using it to encrypt a truly-random first-level passphrase. Any dictionary attacks on the second-level passphrase cannot be precomputed, because of the salt. Computing it on the fly will require calculating the hash, which is designed to be very slow.)  <br>
<p>
It also helped that util-linux-2.11 had another layer of ripemd160 hashing on the passphrase supplied to it, allowing for further whitening (just in case the entropy in /dev/random was inadequate).<br>
<p>
2) Cryptoloop is also modular - this also us to iterate it two or more times with independent first-level keys, effectively multiplying the length of the key by the number of iterations. This is also easily supported in userland; qryptix, for instance, supports the use of multiple-iterated cryptoloops fairly trivially (e.g. /dev/hda9&lt;-&gt;/dev/loop0&lt;-&gt;/dev/loop1...).<br>
<p>
With either of these two existing precautions, dictionary-based known-plaintext attacks on the filesystem, of the kind that Jari Ruusu describes, are a complete non-starter.<br>
<p>
I fervently hope that Andrew Morton doesn't drop cryptoloop support in 2.6 because of this FUD. Cryptoloop just works, simply and reliably. I haven't ever lost a single bit of data using HVR's 2.4 kerneli patches.<br>
  <br>
<p>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101788/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor115311"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A weak cryptoloop implementation in Linux?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2004 22:56 UTC (Sun)
                               by <b>markus76</b> (guest, #26625)
                              [<a href="/Articles/115311/">Link</a>] 
      </p>
      
      </div>
      </summary>
      first of all, really "true cryptographically-random strings" would be directly derived from radioactive decay (which is purely random by nature), not from something inside a computer which is pseudo-random at best.<br>
<p>
setting up several layers of encrypted block-devices is not the idea of cryptoloop both from a plain user's point of view and the ppl who introduced it into mainline kernels. it may work, but it is clumsy and unefficient. <br>
<p>
nobody said one could lose data when using mainline cryptoloop, it's just a Bad Idea to do so. at least for data you want to be secure, anyway, and what is the point of using cryptoloop if your data is not secure? btw, when jari speaks of _equivalent_ to back door he means _equivalent_ to back door and not back door itself. should be obvious, but i got the impression that ppl increasingly start reacting to some kind of pavlov's bell instead of using their brain in the first place (no offense intended, just venting needed).<br>
<p>
mainline cryptoloop is just not to be recommended if you want your data secure. a certain researcher in cryptography (whom i won't mention here, since he's got too much public attention already about just the same "trivial" topic we speak about) also points out these disadvantages of cryptoloop when it comes to security, he's given talks about it on security conferences, wrote articles, ....  - what more info do you need?<br>
<p>
if you want your data secure and want to stick with cryptoloop for the fun of it, that's fine with me. but don't try to evangelise mere users to believe cryptoloop is subject to some kind of bashing contest! it is not! let ppl make up their own minds, their data is their stuff, and turf.<br>
 <br>
cryptoloop is not a bad idea basically speaking, but it really needs to be fixed if it is to be used for the stuff is was made for: securing your data and not giving crypto(loop) a bad name.<br>
<p>
/amen :-)<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/115311/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2004, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
