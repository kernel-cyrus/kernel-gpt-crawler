        <!DOCTYPE html>
        <html lang="en">
        <head><title>Hibernation in the cloud [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/821158/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/821117/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/821158/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Hibernation in the cloud</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 25, 2020</br>
           <hr>
<a href="/Articles/820337/">OSPM</a>
</div>
Hibernation is normally thought of as a laptop feature â€” and 
an old and obsolete laptop feature at that.  One does not normally consider it
to be relevant in cloud settings.  But, at the 2020 <a
href="http://retis.sssup.it/ospm-summit/">Power Management and Scheduling
in the Linux Kernel summit</a> (OSPM), Andrea Righi argued that there may
actually be a place for hibernation on cloud-based systems if it can be
made to work reliably.
<p>
The core idea behind hibernation is powering the system down entirely, but
restoring it to its previous state, including any running processes, when
the system is powered up.  To do that, the contents of memory, which will
not survive loss of power, must be written to persistent storage before
turning things off.  The advantage of hibernation is that the system can
retain its state indefinitely without power; the cost is a great deal of
I/O at both hibernation and resume times.
<p>
Hibernation was a hot topic back in 2004, when it was usually known as
"software suspend"; see <a href="/Kernel/Index/#Software_suspend">the LWN
kernel index entry for software suspend</a> to understand just how hot.
Work in this area slowed around 2008, though, when suspend-to-RAM
functionality (often just called "suspend") became widely available.
Support for hibernation was dropped entirely in Ubuntu 12.04.  The
Fedora&nbsp;29 release included an experiment with suspend-then-hibernate
functionality, but that "didn't go well" and was dropped.  Hibernation
mostly seems like a dead topic, he said.
<p>
So it is interesting that Amazon <a
href="https://aws.amazon.com/blogs/aws/new-hibernate-your-ec2-instances/">added
support for hibernating EC2 instances</a> at the end of 2018.  Hibernation
has suddenly arrived in the cloud, which is a rather different use case
than has been seen before.  The value there is to be able to pause a
workload to save money.  For example, Amazon's "spot instances" run at low
priority when there are spare resources available; they can be shut down
with ten minutes notice at any time.  That is "not nice", but "you get what
you pay for".  This is a setting where hibernation can help; rather than
just losing state when the instance is shut down, it can hibernate and
resume working when resources are again available.
<p>
<h4>How it works</h4>
<p>
Hibernation works by writing memory contents to a "hibernation image" on
disk; that image is somewhat smaller than the RAM in the system.  Data can
be compressed on its way to the image, and recoverable pages (clean,
file-backed data in the page cache primarily) can simply be dropped.
Rafael Wysocki added that hibernation was designed with the assumption that
the bulk of user data will be swapped out at any given time; the amount
that is left will be less than 50% of RAM.  On the next boot, Righi
continued, the kernel will look at the specified resume image; if a valid
signature is found, the image will be restored back into memory.  Then some
tricky, architecture-specific code jumps back into the old kernel state and
the system resumes where it left off.
<p>
The biggest issue with hibernation, he said, is whether it is reliable.
That can't always be counted on; any device in the system can prevent
hibernation if something isn't in the right state.  That is not a huge
problem for hibernation itself, since no data is lost, though it can be an
issue if you are relying on it working.  But any device can mess up the
resume process as well, and that is a much bigger problem.  It is also
possible for the kernel to run out of memory while hibernating or resuming,
which will kill the whole thing.
<p>
Beyond that, there are still bugs present in this code, despite its long
history; Righi mention one that <a
href="https://lore.kernel.org/linux-pm/2167643.HFCj9E3NaD@kreacher/t/">was
fixed</a> in late 2019.  There are security implications, since the
hibernation image holds sensitive data in persistent storage.  Memory and
disk speed can be a problem; he dealt with one customer who was reporting
that hibernation was timing out; it turns out that they were running on an

<a href="/Articles/821160/"><img
src="https://static.lwn.net/images/conf/2020/ospm/AndreaRighi-sm.png" alt="[Andrea Righi]"
title="Andrea Righi" width=200 height=170 hspace=3 vspace=3 border=0
align="right"></a> 

instance with slower storage, and that the timeout period had not been
wisely chosen.  It is also possible that the memory needing to be saved
won't fit into the hibernation image.
<p>
Debugging hibernation problems is a special challenge in any setting, he
said, and it can be worse in cloud settings, especially if you do not have
access to the hypervisor.
<p>
Improving the reliability of hibernation depends a lot on better hardware
support.  Here cloud settings may have an advantage, because the "hardware"
tends to be uniform regardless of where an instance is running.  It can be
helpful 
to reduce memory usage when the image is being stored, which argues
against the use of stacked block devices; kernel code should avoid large
allocations in the hibernation and resume paths.
<p>
Performance (as measured in hibernation time) can be improved
by decreasing the size of the hibernation image; that can be done by
tweaking <tt>/sys/power/image_size</tt>.  A smaller size will cause more
recoverable memory to be dropped, cutting down on the amount of I/O
required at the cost of colder caches on resume.  A larger image size has
the opposite effect; hibernation takes longer, but the system will run
faster after it resumes.
<p>
Then, there is the trick of running <tt>swapoff</tt> after resuming the
system as a way of forcing all data from the swap area back into RAM.  It
can reduce the time required for the system to stop paging and get back to
full speed.  But using <tt>swapoff</tt> turns out to be slow because the
swap code does not properly use readahead when bringing the data back into
RAM.  There is <a href="/ml/linux-kernel/20200418084705.GA147642@xps-13/">a
fix for this problem</a> in linux-next now.  Wysocki said that the kernel
could just do this swapping-in at resume time automatically, which would be
a nicer solution to the problem.
<p>
For the future, Righi said, the kernel could perform opportunistic swapping
during idle times; that would put more data into persistent storage and
speed up hibernation.  He has tried some hacks in this area; they work, but
he would like a better solution.  In conclusion, he said, hibernation can
bring some real benefits for cloud-based systems, but the reliability
issues need to be addressed first.
<p>
<h4>Rafael responds</h4>
<p>
Once Righi finished, Wysocki essentially took over with a talk of his own,
saying that he wanted to respond to a few of Righi's points.  He agreed
that hibernation is not used much currently, but he uses it himself for
desktop systems that don't have a battery.  He has not seen a single
failure since 2016.  That said, the whole system was designed around the
assumption that hibernation and resume would happen on the same machine;
it's surprising that it works for cloud instances at all.
<p>
He acknowledged that there were plenty of nasty bugs in x86 hibernation
support, but most of those were fixed in 2016.  Support in the architecture
code is solid, but there are still problems with some drivers. Most
drivers support suspend these days, though, and the hibernation support
generally 
derives from that, so device-level support for hibernation is broad.  Most
laptops he has tried work out of the box without problems, though he
admitted he hasn't done huge amounts of testing.
<p>
He repeated that there could be problems where the resume happens on a
different machine from where hibernation took place.  Given the hardware
emulation provided by the hypervisor, the system should be essentially the
same, but he stressed that there are "no warranties".
<p>
The real problem with hibernation support is that it places huge stresses
on the memory-management subsystem.  It forces data out to swap by
allocating all of the memory in the system, with the out-of-memory killer
disabled.  Strange things can happen when you do that but, from the point
of view of the memory-management developers, it's an obscure corner case
and they never find the time to improve it.
<p>
With regard to security, he said, if a cloud provider makes hibernation
available, it's up to them to take care of encrypting the hibernation image
and such.  Attempts to add encryption support to the kernel have run afoul
of "security people", who didn't like the duplication of functionality.
Somehow, the key used to encrypt the image has to be passed to the resume
kernel, which is not easy.  So there are some challenges to face there.
<p>
On that note, the session wound down, and the 2020 edition of OSPM came to
a close.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Software_suspend">Software suspend</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#OS-Directed_Power-Management_Summit-2020">OS-Directed Power-Management Summit/2020</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/821158/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor821360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2020 18:34 UTC (Mon)
                               by <b>mrecho</b> (guest, #53167)
                              [<a href="/Articles/821360/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe have different modes of Hibernation?<br>
Hypervisor/VM mode, Laptop mode, Desktop mode.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor821361"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2020 18:47 UTC (Mon)
                               by <b>joib</b> (subscriber, #8541)
                              [<a href="/Articles/821361/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If one were a cloud provider implementing hibernation for customers, wouldn't the logical way to go about it to piggyback on the guest live migration code; just dump the data onto disk instead of setting up a target guest?<br>
<p>
(Assuming that live migration works well, which I've understood it generally does these days, and hibernation doesn't which apparently Wysocki disagrees with)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821361/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821362"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2020 18:52 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/821362/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, I was responsible for AWS Spot hibernation :)<br>
<p>
The problem with live migration is that cloud providers pass through actual hardware (GPUs and fast network cards) to guests. And it's generally impossible to save their hardware state without cooperation from the guest. As a result, live migration is reserved only for lower-tier instance types that use completely virtual hardware.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821362/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821370"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2020 21:21 UTC (Mon)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/821370/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could use suspend to RAM to ensure devices are shut down orderly, and only save the content RAM to disk while it is paused/suspended. You don't need to store device state at all because a machine wakes up from S3 at the usual reset vector (RIP=0xFFFFFFF0) with all devices in their reset state.<br>
<p>
This sidesteps the memory management issues that hibernation has, though you still have to cross fingers that the drivers behave. Windows has an edge here since the Microsoft driver certifications stress test the D0-&gt;D3-&gt;D0 transitions quite a bit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821370/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor821364"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2020 19:35 UTC (Mon)
                               by <b>righiandr</b> (subscriber, #34187)
                              [<a href="/Articles/821364/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another nice aspect of using the hibernation code is that the guest kernel has a better understanding of the memory layout and what needs to be saved to disk, instead of dumping everything as a blob. So we can decide for example if we want to save as much as possible and have a faster system on resume, or drop some caches (i.e. clean page cache pages) and reduce some I/O during hibernate/resume.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821364/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor821378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2020 22:37 UTC (Mon)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/821378/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW the AWS spot instance interruption notification happens two minutes before shutdown, not ten minutes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 0:17 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/821380/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  FWIW the AWS spot instance interruption notification happens two minutes before shutdown, not ten minutes.</font><br>
Technically, AWS document that there's _at_ _least_ a 2 minute guarantee. Hint, hint :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor821391"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 10:10 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/821391/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Erm, wait what? Hibernation is considered obsolete?<br>
<p>
I always use hibernation. I never shut down the laptop. There's only the occasional reboot, if something has been updated.<br>
<p>
And it works great. In the past, like 12 years ago or so, when I started to use it, I had the occasional hibernation or resume failure. Like 1 in 20 times or so. That's gone. I can't remember my last hibernation failure.<br>
I use an encrypted swap volume on an SSD for the hibernation image. It only takes a couple of seconds to hibernate and resume. For me that's a perfect solution. I don't want to re-establish my work setup every time I power up the machine. With hibernation I can continue to work exactly from where I left off.<br>
<p>
So what's the alternative to hibernation, if it's obsolete?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821391/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821395"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 11:20 UTC (Tue)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/821395/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Suspend (suspend to RAM) is widely used. Hibernation is suspend to disk.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821395/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821772"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2020 12:30 UTC (Fri)
                               by <b>jschrod</b> (subscriber, #1646)
                              [<a href="/Articles/821772/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Suspend to RAM lasts only a few days; Hibernate to disk will last a week or so.<br>
<p>
These are completely different use cases, if one doesn't use the laptop every day.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821772/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2020 8:09 UTC (Sat)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/821837/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it depends how much RAM you have. I have a Dynabook X30 with 8 GiB of RAM that seems to last about a week, and an X40 with 32 GiB that lasts a couple of days. Which makes sense since it takes more power to keep more RAM refreshed.<br>
<p>
I don't use hibernate at all any more because it's disabled by Secure Boot. :/<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor821394"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 11:56 UTC (Tue)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/821394/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suppose the alternative for your use case is suspend to RAM. I also used to use hibernation a lot, much like you describe. And it worked very well for me too. But at some point, I switched to STR because it's just faster and essentially provides the same experience, with modern laptops lasting many days in standby (as opposed to something like half a day when I started using hibernation in the early 2000s). I guess the turning point was when RAM sizes exploded some 10-15 years ago, but SSDs weren't yet widespread - so hibernation took longer and longer. With NVMe SSDs being mainstream now, it would probably be as fast as it used to be, but for me personally, it's just not worth the effort to set up and try. On most machines, it will always be noticeably slower than STR because of firmware startup delays (POST etc.).<br>
<p>
I guess most 'normal' people treat their laptop more like a phone these days and just close the lid, using whatever the OS does by default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821394/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821398"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 12:17 UTC (Tue)
                               by <b>dsommers</b> (subscriber, #55274)
                              [<a href="/Articles/821398/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There was at some point a hybrid solution, which I liked to use at conferences.  I see that 'systemd' provides 'hybrid-sleep'. which might be this feature.  It basically wrote everything to disk (hibernate) and then suspended to RAM.  The idea was, if your laptop goes out of battery while being in sleep - it would restore from disk; otherwise it would restore from normal suspend to RAM.  This actually saved me from a few annoying "out-of-battery" situations back in the day.<br>
<p>
That said, in today's day and age where encrypted disks are much more important, hibernation is also much safer than sleep/suspend *when* the hibernation "partition" is also encrypted.  When you just unsuspend a laptop, the disks are already in a "decrypted state" which makes it easier to access data (where issues around Thunderbolt can even make it easier too, due to the DMA possibility).  While an encrypted hibernation partition will need to be decrypted through some user input at restore boot time.  The cost of disk based hibernation is that the restore/start-up time is longer than suspend-to-RAM, but the security is higher with hibernate-to-disk.<br>
<p>
As I've not had any successful "hibernation" experiences lately, I've usually resorted to normal shutdown - especially during traveling.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821398/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821402"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 13:23 UTC (Tue)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/821402/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know about the security implications. If I had any really sensitive data, or suspected that I could realistically be the target of targetted surveillance, I wouldn't use STR. Since I'm mostly boring, I worry more about dragnet type surveillance than targetted attacks. That said, air travel is one of the very few times I deliberately shut down my laptop. But again, if I had anything really sensitive, I wouldn't try bringing it along with me, encrypted or not. Much safer to just download it onto a different machine at the destination if it's not too much, or even to mail an encrypted drive - less potential for rubber-hose cryptanalysis there.<br>
<p>
I wonder if it would be feasible to purge the disk encryption key from RAM before suspending after freezing most processes, and require it to be unlocked again before unfreezing them. Whatever handles this unlock procedure would need to have its working set pinned in RAM, so it would probably be hard to use fancy X/Wayland based lock screens - maybe with a second single-purpose instance?<br>
<p>
That would still leave open the possibility of an active attacker planting a backdoor in RAM via e.g. some Thunderbolt vulnerability, or physical access to the RAM. But at least the latter seems decidedly non-trivial to pull off while keeping the system running. RAM encryption could mitigate out-of-band attacks, but that obviously requires hardware support, and in the end it can only move the bar for successful attacks somewhat higher, not elminate the threat completely. I guess if you have sufficiently sensitive data, you definitely want proper physical security.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821402/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821406"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 13:48 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/821406/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;if I had anything really sensitive</font><br>
<p>
I consider all my data sensitive, because whether something is sensitive depends on a lot of environmental circumstances, too. e.g. laws that I don't know of. And it might also change without my immediate knowledge.<br>
<p>
So my default is encrypt everything. I actively decide whether information is non-sensitive on a case by case basis, rather than the other way around. That's much easier and much safer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821406/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821411"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 14:28 UTC (Tue)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/821411/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Encrypting everything by default is certailny a good idea, I do that too. Hibernation (to an encrypted disk) is of course a good way to protect the state of a running system while at rest, and I've used it as such in the past.<br>
<p>
But treating my vacation photos like I'm the next Snowden on my way to a safe place to leak a huge cache of data seems a little inconvenient. Like I said, if that were the case, I wouldn't try to bring this data along with me. But for more mundane things, an encrypted drive (whether the laptop is hibernated or turned off) seems good enough for me.<br>
<p>
And for taking my laptop around in my backpack, the convenience of STR is hard to beat - even if I do give up a little security for that convenience. Reading a few GB of data from an SSD is fast, but GRUB still takes several seconds to unlock a LUKS container for me. And if I mistype my (long) passphrase, it takes even longer to error out and then it won't let me try again, and I have to reboot - again taking several seconds just to get to the prompt.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821411/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 17:18 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/821467/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But treating my vacation photos like I'm the next Snowden on my way to a safe place to leak a huge cache of data seems a little inconvenient.</font><br>
<p>
<a href="https://www.rspb.org.uk/reserves-and-events/events-dates-and-inspiration/puffarazzi/">https://www.rspb.org.uk/reserves-and-events/events-dates-...</a><br>
<p>
Your holiday photos could be a treasure trove of information to any interested bystander. If an attacker knew you were in a location they were interested in.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor821476"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 18:43 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/821476/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;the convenience of STR is hard to beat </font><br>
<p>
As I said, hibernation is not a replacement for STR.<br>
I also use STR a lot, if I just want to conserve energy for a short time.<br>
<p>
<font class="QuotedText">&gt; And if I mistype my (long) passphrase, it takes even longer to error out and then it won't let me try again, and I have to reboot</font><br>
<p>
That's just misconfigured then.<br>
There's nothing wrong with allowing a couple of password attempts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821476/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821479"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 19:08 UTC (Tue)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/821479/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; That's just misconfigured then.</font><br>
<font class="QuotedText">&gt; There's nothing wrong with allowing a couple of password attempts.</font><br>
<p>
I checked a few years ago when I set this up and back then, I didn't find any config option I could change to allow multiple attempts. Of course that's an implementation issue that's easily fixed, as is the slow unlock speed (cryptsetup is a lot faster) - though depending on what's causing the slowness, fixing it might not be as easy in a bootloader.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821479/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor821475"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 18:37 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/821475/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I wonder if it would be feasible to purge the disk encryption key from RAM before suspending after freezing most processes, and require it to be unlocked again before unfreezing them. Whatever handles this unlock procedure would need to have its working set pinned in RAM, so it would probably be hard to use fancy X/Wayland based lock screens - maybe with a second single-purpose instance?</font><br>
<p>
systemd-homed aims to support this. <a href="https://wiki.archlinux.org/index.php/Systemd-homed">https://wiki.archlinux.org/index.php/Systemd-homed</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821475/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2020 11:18 UTC (Wed)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/821513/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The concept seems interesting, but I suppose it can only do this locking magic for the LUKS containers it manages itself. Which is kind of a pity for two reasons:<br>
<p>
1. File-backed loop devices aren't completely free in terms of performance, as there's at least another file system involved, which might be fragmented, etc. I'd prefer the directory-backed storage option if I were to use systemd-homed, both so I can choose my own file system and to remove the loop overhead, but then I'd lose the crypto locking feature.<br>
2. More importantly, if the root fs isn't encrypted, or encrypted with a key that remains in RAM during suspend, wouldn't an obvious attack vector be to place a backdoor there which leaks the key or data as soon as the user unlocks /home/user again?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor821405"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2020 13:43 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/821405/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think STR is an alternative to hibernation. That's a completely different usage scenario.<br>
<p>
I rather see hibernation as an alternative to shutdown. With hibernation I get the "features" of shutdown (e.g. no power consumption. No unlocked crypto-drives) and at the same time I don't loose my work setup state.<br>
<p>
Let's ask this question: Why shutdown, if you can hibernate?<br>
I don't see a benefit in shutdown, except for a very small speed advantage (Writing/reading a couple of gigabytes takes seconds on SSDs).<br>
<p>
STR on the other hand is unsafe w.r.t. disk encryption. So that's not an option.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821405/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor821510"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2020 10:44 UTC (Wed)
                               by <b>Fowl</b> (subscriber, #65667)
                              [<a href="/Articles/821510/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Why not <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/distinguishing-fast-startup-from-wake-from-hibernation">hibernate the kernel and just restart user space</a>? ;p
      
          <div class="CommentReplyButton">
            <form action="/Articles/821510/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor821611"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation in the cloud</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2020 5:29 UTC (Thu)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/821611/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's how you know you're getting old: you suddenly learn that things you took for granted are considered obsolete :) I have an old beat-up laptop which I still very occasionally use (like, once or twice a year). The kicker: it has no battery. It would be a shame if I couldn't use hibernate on it...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/821611/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
