        <!DOCTYPE html>
        <html lang="en">
        <head><title>A generic hash table [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/510202/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/509412/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/510202/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A generic hash table</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>August 8, 2012</br>
           </div>
<p>
A data structure implementation that is more or less replicated in 50 or
more places in the kernel seems like some nice low-hanging fruit to pick.
That is just what Sasha Levin is trying to do with his <a
href="/Articles/510270/">generic hash table patch set</a>.  It implements a 
simple fixed-size hash table and starts the process of changing various
existing hash table implementations to use this new infrastructure.
</p>

<p>
The interface to Levin's hash table is fairly straightforward.  The API is
<a href="/Articles/510271/">defined</a> in 
<tt>linux/hashtable.h</tt> and one declares a hash table as follows:
<pre>
    DEFINE_HASHTABLE(name, bits)
</pre>
This creates a table with the given <tt>name</tt> and a power-of-2 size
based on <tt>bits</tt>.  The table is implemented using buckets containing
a kernel 
<tt>struct hlist_head</tt> type. It implements a chaining hash, where hash
collisions are simply added to the head of the <tt>hlist</tt>.

One then calls:
<pre>
    hash_init(name, bits);
</pre>
to initialize the buckets.
</p>

<p>
Once that's done, a structure containing a <tt>struct hlist_node</tt>
pointer can be constructed to hold
the data to be inserted, which is done with:
<pre>
    hash_add(name, bits, node, key);
</pre>
where <tt>node</tt> is a pointer to the <tt>hlist_node</tt> and
<tt>key</tt> is the key that is hashed  
into the table.  There are also two mechanisms to iterate over the table.
The first iterates through the entire hash table, returning the entries in
each bucket:
<pre>
    hash_for_each(name, bits, bkt, node, obj, member)
</pre>
The second returns only the entries that correspond to the <tt>key</tt>'s
hash bucket:
<pre>
    hash_for_each_possible(name, obj, bits, node, member, key)
</pre>
In each case, <tt>obj</tt> is the type of the underlying data,
<tt>node</tt> is a <tt>struct hlist_head</tt> pointer to use as a loop
cursor, and 
<tt>member</tt> is the name of the <tt>struct hlist_node</tt> member
in the stored data type.  In addition, <tt>hash_for_each()</tt> needs an
integer loop cursor, <tt>bkt</tt>.  Beyond that, one can remove an entry
from the table with:
<pre>
    hash_del(node);
</pre>
</p>

<p>
Levin has also converted six different hash table uses in the kernel as
examples in the patch set.  While the code savings aren't huge (a net loss
of 16 lines), they could be reasonably significant after converting the 50+
different fixed-size hash tables that Levin <a
href="/Articles/510277/">found</a> in the kernel.  There is also the
obvious advantage of restricting all of the hash table implementation bugs
to one place. 
</p>

<p>
There has been a fair amount of discussion of the patches over the three
revisions that Levin has posted so far.  Much of it concerned
implementation details, but there was another more global concern as
well. Eric W. Biederman was <a href="/Articles/510279/">not convinced</a>
that replacing the existing simple hash tables was desirable:
<div class="BigQuote">
For a trivial hash table I don't know if the abstraction is worth it.
For a hash table that starts off small and grows as big as you need it
the [incentive] to use a hash table abstraction seems a lot stronger.
</div>
</p>

<p>
But, Linus Torvalds <a href="/Articles/510280/">disagreed</a>.  He
mentioned that he had been "<q>playing around</q>" with a directory
cache (dcache) patch that uses a fixed-size hash table as an L1 cache for
directory entries that provided a noticeable performance boost.  If a
lookup in that 
first hash table fails, the code then falls back to the existing
dynamically sized hash table.  The reason that the code hasn't been
committed yet is because
"<q>filling of the 
small L1 hash is racy for me right now</q>" and he has not yet found a
lockless and race-free way to do so.  So:
<div class="BigQuote">
[...] what I really wanted to bring up was the fact that static hash
tables of a fixed size are really quite noticeably faster. So I would
say that Sasha's patch to make *that* case easy actually sounds nice,
rather than making some more complicated case that is fundamentally
slower and more complicated.
</div>
</p>

<p>
Torvalds <a href="/Articles/510283/">posted his patch</a> (dropped  <a
href="/Articles/510313/">diff attachment</a>) after a request
from Josh Triplett.  The
race condition is "<q>almost entirely theoretical</q>", he said, so
it could be used to generate some preliminary performance numbers.  Beyond
just using the small fixed-sized table, Torvalds's patch also circumvents
any chaining; if the hash bucket doesn't contain the entry, the second
cache is consulted.  By <a href="/Articles/509417/">avoiding "pointer
chasing"</a>, the L1 dcache "<q>really improved performance</q>".
</p>

<p>
Torvalds's dcache work is, of course, something of an aside in terms of Levin's patches, but
several kernel developers seemed favorably inclined toward consolidating
the various kernel hash table implementations.
Biederman was <a href="/Articles/510287/">unimpressed</a> with the
conversion of the UID cache in the user namespace code and Nacked it. On
the other hand, 
Mathieu 
Desnoyers had <a href="/Articles/510289/">only minor comments</a> on the
conversion of the tracepoint hash table and Eric Dumazet had mostly <a
href="/Articles/510290/">stylistic comments</a> on the conversion of the 9p
protocol 
error table. There are several other
maintainers who have not yet weighed in, but so far most of the reaction
has been positive.  Levin is trying to attract more reviews by converting a
few subsystems, as he notes in the patch.
</p>

<p>
It is still a fair amount of work to convert the other 40+ implementations,
but the conversion seems fairly straightforward.  But, Biederman's
complaint about 
the conversion of the namespace code is something to note: "<q>I don't
have the time for a new improved better hash table that makes 
the code buggier.</q>"  Levin will need to prove that his implementation
works well, and that the conversions don't introduce regressions, before there
is any chance that we will see it in the mainline.  There is no reason that all
hash tables need to be converted before that happens&mdash;though it might
make it more likely to go in.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Hash_table">Hash table</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/510202/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor510344"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2012 5:02 UTC (Thu)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/510344/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Re the pointer-chasing vs. simple table argument&mdash;has anyone tried to modify the hash tables to implement <a href="http://en.wikipedia.org/wiki/Cuckoo_hashing">Cuckoo hash</a> behavior? From my experience these provide nice gains over a simple hash table, and with zero added complexity.
      
          <div class="CommentReplyButton">
            <form action="/Articles/510344/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor510505"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2012 23:26 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/510505/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ooo. I'd failed to notice cuckoo hashes: very nice (particularly with more than one item: 50% loading is rather cruddy, but 91% is close enough to 100% as makes no odds. Combine that with using three hash functions and you could get it *very* close to 100% for only a small constant slowdown. Downside: you still do need to resize now and then, which is hateful because it breaks active iterators unless you have crazy complexity to deal with that case alone. Yes, you *can* ban modification of hashes being iterated over, but I consider that a bad-quality implementation.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/510505/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor510522"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2012 2:17 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/510522/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Downside: you still do need to resize now and then, which is hateful because it breaks active iterators unless you have crazy complexity to deal with that case alone.</font><br>
<p>
Even without resizing, keys can change location when other items are inserted, so you can't make very many guarantees. Even with a normal hash table it's difficult to say whether you will see the inserted key later on; with a cuckoo hash table you may miss _other_ keys, or even double-iterate them.<br>
<p>
If you must modify a hash table with active iterators, perhaps you should collect the list of keys up front, atomically, and iterate over that instead. It may not be quite as efficient as iterating over the hash table directly, in memory or CPU time, but the result will be much more predictable. Or you could make a shallow copy of the hash table to iterate over.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/510522/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor510621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 10, 2012 16:28 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/510621/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah. There are hash designs which don't have this problem -- e.g. any based on trees (you can even arrange that deletion of the key you're currently iterating over will only impose the same overhead on the next iteration as a normal hash lookup). Downside: trees often involve a lot of pointer chasing, and some of them are write-heavy on update and even on read (e.g. splay trees: nice self-optimizing data structure, shame about your cacheline contention).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/510621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor510421"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2012 14:32 UTC (Thu)
                               by <b>pj</b> (subscriber, #4506)
                              [<a href="/Articles/510421/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Coming right after the 'kernel regressions' article, this made me wonder... does this new generic hash table implementation come with a test suite? If so, that would be a measurable, notable improvement over the other N implementations that Sasha could point to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/510421/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511228"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 14, 2012 17:02 UTC (Tue)
                               by <b>sashal</b> (<b>&#x272D; supporter &#x272D;</b>, #81842)
                              [<a href="/Articles/511228/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed this is a great suggestion. Some sort of CONFIG_HASHTABLE_TEST (similar to what happens with list sorting for example) is definitely something I'd like to add.<br>
<p>
Thanks for the suggestion!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511228/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511363"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">User space unit tests?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2012 15:01 UTC (Wed)
                               by <b>alex</b> (subscriber, #1355)
                              [<a href="/Articles/511363/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While enabling run time testing of some kernel features is useful (the VM torture tests spring to mind) it would be much better if library code was testable in a user space build that didn't involve bringing a kernel up.<br>
<p>
How about adding "make unittests" as a target for the kernel build?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511363/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor510471"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 9, 2012 20:17 UTC (Thu)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/510471/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One has to wonder why the kernel is only now gettin such a basic data structure as a generic hash table. I think it's because generic data structures aren't all that useful in a language like C. It's not really possible to make them both generic and typesafe (at least not without horrible macro hackery), and making them customizable (so you can apply different policies regarding memory allocation, collision handling etc.) is even harder.<br>
Yes, C++ is an ugly language and it has many warts. But it's *useful* in that it lets me write code in the way I want to write it: generic, type-safe, flexible and just as efficient as C, if not more so.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/510471/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 21:40 UTC (Mon)
                               by <b>liljencrantz</b> (guest, #28458)
                              [<a href="/Articles/511104/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
C++11  is the first version of the language to feature a built in hash table. One has to wonder why the language is only now gettin (sic) such a basic data structure as a generic hash table. I think it's because generic data structures are insanely hard in a language like C++. It's not really possible to make them both generic and performant (at least not without hortrible template hackery), and making them customizable (so you can apply different policies regarding memory allocation, collision handling, etc.) is even harder.<br>
<p>
Yes, C is an ugly language and it has many warts. But it's *useful* in that it lets me write code in the way I want to write it: without hidden costs, reasonably close to the hardware and just as efficient as C++, if not more so.<br>
<p>
Seriously though, writing generic data structures in C++ is a hard enough problem that even  stl is pretty crappy for a lot of applications. Every insert into the C++ linked list causes a memory allocation. Until recently, LinkedList::size() was an O(n) operation. The attempts to make vector&lt;bool&gt; fast were a horrible failure. The COW abilities of basic_string are mostly a joke because of weak C++ aliasing rules. C++ provides you with half the tools you need to write good generic data structures and all the rope you need to hang yourself while chasing that pipe dream.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 22:18 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/511116/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;C++11 is the first version of the language to feature a built in hash table. One has to wonder why the language is only now gettin (sic) such a basic data structure as a generic hash table.</font><br>
<p>
That's because C++11 is the first major revision of C++ since 1998 (yeah, blame the ISO committee). Hash maps have been present in various non-standard ways in C++ stdlibs since 90-s. That's also the reason they are called 'unordered_maps' in the C++11 to avoid all kinds of name collisions.<br>
<p>
You might also notice, that tree based std::map has been present since C++98.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 23:42 UTC (Mon)
                               by <b>liljencrantz</b> (guest, #28458)
                              [<a href="/Articles/511132/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hash maps were invented in the fifties. C++ has been a popular language since the eighties. The fact that they couldn't design a hash table implementation that was good enough to slap a sticker on it in 1998 (that's almost 20 years down the line) is a strong testament to just how hard the trade offs are when trying to design generic C++ data structures.<br>
<p>
Do you want an open addressing implementation? What type of probing? A Cuckoo hash? Do you use a linked list to allow ordered iteration? Do you allow hash table modification during iteration? If so, only using that iterator or arbitrary insertions? What resize strategy do you use when growing the table? What resize strategy do you use when shrinking the table? Do you store precalculated hash codes in the table? Do you use tombstones to mark deleted entries? <br>
<p>
No matter what you answer to the above questions, you will make your hash table nearly useless for a large swath of people. And you can try to make the answer to all those questions decidable at compile time through templates, but that solution comes with it's own set of painful drawbacks.<br>
<p>
You might also notice, that generic tree based red black trees have been present in the Linux kernel since forever.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511138"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 14, 2012 0:04 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/511138/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Hash maps were invented in the fifties. C++ has been a popular language since the eighties. The fact that they couldn't design a hash table implementation that was good enough to slap a sticker on it in 1998</font><br>
Not in 1998 but in late 1995 (that's when the final drafts were produced). And the whole idea of STL was pretty new at that point, it's actually a small miracle they managed to put it into the C++ Standard as it is.<br>
<p>
<font class="QuotedText">&gt; Do you want an open addressing implementation? What type of probing? A Cuckoo hash? Do you use a linked list to allow ordered iteration? Do you allow hash table modification during iteration? If so, only using that iterator or arbitrary insertions? What resize strategy do you use when growing the table? What resize strategy do you use when shrinking the table? Do you store precalculated hash codes in the table? Do you use tombstones to mark deleted entries? </font><br>
<p>
You've described about 100 different structures (considering various permutations). Some of the functionality can be split into policies (they work wonderfully with templates, incidentally). Otherwise, library designers just pick a generic enough version and go along with it. <br>
<p>
If you need some special tuned version for your very specific need - you're welcome to write it. If you abide by STL's standards then you can even use them with STL/Boost algorithms. Without any loss of performance, I might add.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511138/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor511121"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 22:39 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/511121/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; C++11 is the first version of the language to feature a built in hash table. One has to wonder why the language is only now gettin (sic) such a basic data structure as a generic hash table.</font><br>
<p>
It's not that C++ is getting a "generic hash table"<br>
<p>
It's that the Linux Kernel project is implementing something they call a "generic hash table" that combines all the various features that the different hash tables in the kernel implement.<br>
<p>
C++ has a very generic hash table, it's also not very useful by itself, and as a result it does 80% of the work and you implement the remaining 20% to match your application.<br>
<p>
In the Linux Kernel, this 20% has been implemented a dozen different ways (working to solve a dozen different types of problems). This is a unified implementation that proposes to cover all dozen use cases with one set of code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511121/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor511106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 23:26 UTC (Mon)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/511106/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One has to wonder why the language is only now gettin (sic) such a basic data structure as a generic hash table</font><br>
The reason is trivial: The committee ran out of time when C++98 was standardized, thus hash tables didn't get in. However, boost and various STL vendors have been shipping hash tables for a long time. And let's not talk about the fact that C11 doesn't ship any containers at all.<br>
<p>
<font class="QuotedText">&gt; &lt;pointless trolling removed&gt;</font><br>
<p>
<font class="QuotedText">&gt; Every insert into the C++ linked list causes a memory allocation.</font><br>
One can specify an allocator if the default one isn't fast enough, and if that still doesn't cut it, one can use something like boost.intrusive, where one has full control over all memory (de)allocation. The STL isn't all things to all people. The point is that in C++ it's actually *possible* to write good (i. e. type-safe, generic, fast) containers, while it isn't in C. <br>
<p>
<font class="QuotedText">&gt; Until recently, LinkedList::size() was an O(n) operation.</font><br>
Having size() be an O(1) operation requires the size to be stored in the list and updated when elements are added or removed. This means that one can either move an iterator range from one list to another in constant time, or have size() run in constant time, but not both, because if you need to update the list sizes, you need to count the elements in the range, and requires linear time. So it actually makes sense for size() to run in linear time depending on what you want to do.<br>
<p>
<font class="QuotedText">&gt; The attempts to make vector&lt;bool&gt; fast were a horrible failure.</font><br>
Well, vector&lt;bool&gt; was a mistake, shit happens. It tends to be a minor problem in the real world. One can just use a std::vector&lt;uint8_t&gt; or std::bitset or boost::dynamic_bitset or whatever else does the job.<br>
<p>
<font class="QuotedText">&gt; The COW abilities of basic_string are mostly a joke</font><br>
C11 not having a string type at all, that's what is a joke. <br>
<p>
<font class="QuotedText">&gt; &lt;yet more pointless trolling removed&gt;</font><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511135"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 23:46 UTC (Mon)
                               by <b>liljencrantz</b> (guest, #28458)
                              [<a href="/Articles/511135/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I find it hilarious that I posted a s/Linux/C++/ of your own comment and you call me a troll. Do they have mirrors in your world?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511135/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511136"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 23:50 UTC (Mon)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/511136/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I find it hilarious that I posted a s/Linux/C++/ of your own comment and you call me a troll.</font><br>
That's because the arguments don't make sense any more when they're applied the other way around (and that's a good thing, as they'd be meaningless otherwise).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511136/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor511137"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2012 23:55 UTC (Mon)
                               by <b>liljencrantz</b> (guest, #28458)
                              [<a href="/Articles/511137/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The part where you say that it is impossible to write type-safe, generic and fast containers in C is demonstratably false. All of the above can be had with macros. I look forward to you arguing that such implementations aren't good while ignoring that most of the problems with macros also exist with templates.<br>
<p>
Whenever the many deficiencies of STL is pointed out, you defensively say that "they fixed that in boost::XXX", but ignore that any missing containers, string types and other omissions from the standard C library can be easily rectified through the use of a small set of additional libraries.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511137/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511246"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 14, 2012 19:56 UTC (Tue)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/511246/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I look forward to you arguing that such implementations aren't good while ignoring that most of the problems with macros also exist with templates.</font><br>
Nonsense, there are numerous problems with macros. Here's a simple example:<br>
template&lt;typename T&gt; bool max(T x, T y) { return x &gt; y ? x : y; }<br>
#define max(x, y) x &gt; y ? x : y<br>
<p>
The macro version will evaluate one argument twice. Bad things happen when you do max(a, max(b, c)). Yes, that can be fixed by parenthesizing each macro argument, but I shouldn't need to deal with that kind of crap. The template version will complain when the types don't match, the macro won't.<br>
Other people have tried to make it suck less by using macros to generate functions:<br>
<a href="http://www.canonware.com/rb/">http://www.canonware.com/rb/</a><br>
That sucks too, because I really don't feel that I should be responsible for the bookkeeping that approach requires. It also doesn't work if you need to deal with complex types like int(*)(void) or whatever. Yes, one can use a typedef in that case. No, that's not how it should be. Generic algorithms and data structures are important enough to warrant language features to support them. <br>
<p>
<font class="QuotedText">&gt; Whenever the many deficiencies of STL is pointed out, you defensively say that "they fixed that in boost::XXX",</font><br>
Boost doesn't usually "fix" the STL, it simply provides solutions to other problems than the STL does. std::list (de)allocates memory for you but works with arbitrary types. boost.intrusive don't work with all types (because they need the pointers to be embedded within the type), but it's more flexible with regards to memory management.<br>
<p>
<font class="QuotedText">&gt; but ignore that any missing containers, string types and other omissions from the standard C library can be easily rectified through the use of a small set of additional libraries.</font><br>
It can't, generic data structures suck when the language doesn't support them. And besides, it's not like one always needs boost. Often enough, STL containers and algorithms do the job just fine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/511246/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor511998"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 17, 2012 8:18 UTC (Fri)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/511998/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <BLOCKQUOTE><TT>template&lt;typename T&gt; <B>bool</B> max(T x, T y) { return x &gt; y ? x : y; }</TT></BLOCKQUOTE>
<P>Erm... I don't think that's the right return type, unless you want<TT> max(a, max(b, c)) </TT>to have rather unusual semantics.</P>
      
          <div class="CommentReplyButton">
            <form action="/Articles/511998/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 17, 2012 9:02 UTC (Fri)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/512001/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <P>Actually... any use of that<TT> max </TT>that returns<TT><B> bool </B></TT>would have rather unusual semantics with that return type.  Almost reminds me of <A rel="nofollow" HREF="http://me.veekun.com/blog/2012/04/09/php-a-fractal-of-bad-design/">PHP</A>.  ;-)</P>
<P>As far as the whole C / C++ debate goes:  Up until a few years ago I was an ardent C proponent and avoided C++.  Since then, I've really given C++ a chance, and I now tend to prefer it for new projects.  I still use C for quick one-offs, but for anything larger I use C++.</P>
<P>For one thing, C++ compilers are much better now than when I first looked at them ~15 years ago.  You can throw some seriously complicated template messes at a modern compiler and it'll sort it out and give you rather tight code more often than not.  5 to 10 years ago, good code in that circumstance was more the exception than the rule.  Bringing STL into the language in the 90s, plus the rise of Boost and template metaprogramming really forced compilers to up their game here.</P>
<P>I remember around 10 years ago playing with the "Stepanov" benchmark.  It's a benchmark that measures a compiler's ability to deal with abstraction in a C++ program by wrapping a simple addition with a<TT> double </TT>in increasing amounts of C++ abstraction.  G++ performed rather poorly at the time (incurring a 10x - 15x slowdown at the worst, IIRC) and our own compiler at work showing a 50x slowdown.  Now I believe both compilers show no slowdown.  They are able to flatten away the abstractions.  It's beautiful.</P>
<P>For the problems I'm tackling in my day job, I really appreciate the compositional style templates offer me.  Too often I find myself needing "an X with detail Y".  In C, I'd have to code up a separate function that combined the two, or a macro that instantiated X subbing in a Y where necessary.  In C++, it's just X&lt;Y&gt;, if X is a suitable template.  I get type safety and an awful lot of compile-time computation and help.</P>
<P>This can be really wild but useful at the limit.  I have a truly compelling example I'd love to share, but since it's my day job and it's proprietary technology, I don't know just how much I can share.  I will say that the code I generate relies on a ton of compile-time computation to generate code that's sufficiently efficient that I don't mind running on design simulations of our chips that run at speeds on the order of 100Hz, plus/minus an order of magnitude.  You read that right:  anywhere from 10 to 1000 CPU cycles per second.</P>
<P>(Note:  I've completely ignored error messages.  C error messages are rarely obtuse and usually easily grokked.  C++ with multiple nested templates is another ball of yarn altogether...  They generally suck, and I'm with you if you think they're an abomination.)</P>
      
          <div class="CommentReplyButton">
            <form action="/Articles/512001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512012"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic hash table</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 17, 2012 9:49 UTC (Fri)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/512012/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're right of course :). Oops.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512012/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2012, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
