        <!DOCTYPE html>
        <html lang="en">
        <head><title>TCP small queues and WiFi aggregation — a war story [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/757643/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/757500/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/757643/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>TCP small queues and WiFi aggregation — a war story</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="GAByline">
           <p>June 18, 2018</p>
           <p>Contributed by Carlo Grazia and Natale Patriciello</p>
           </div>
<p>This article describes our findings that connected <a
href="/Articles/507065/">TCP small queues</a> (TSQ)
with the behavior of advanced WiFi protocols and, in the process, solved a
throughput 
regression. The resulting patch is already in the mainline tree, so before
continuing, 
please make sure your kernel is updated.  Beyond the fix, it is
delightful to travel through history to see how we discovered the problem,
how it was tackled, and how it was patched.

<p>The academic life is full of rewards;  one of ours was the moment in which
three USB/WiFi 802.11ab/g/n dongles arrived. We bought dongles with an
Atheros chipset because both the software driver and the firmware are
available and modifiable. We were using the <tt>ath9k_htc</tt> kernel
module with the default configuration. We compiled the latest (at the
time) available kernel (4.13.8), and then we started the access point
to create an 802.11n network to build the core of our future testbed for
vehicular communications.
<p>
We started some simple tests with <tt>ping</tt> and <tt>iperf</tt>
to check the connectivity, the distribution of IP addresses, and our custom
DNS, which translates the names of our services into IP addresses. The
nominal transfer rate of the dongles is 150Mb/s, but what we
saw on the screen was disappointing: an upload <tt>iperf</tt> connection,
no matter which
options were used, was able to reach only 40Mb/s. Using another operating
system as a
client, we were able to achieve 90Mb/s, leaving out a problem with the
server. Even with the newer kernel release (4.14), we did not see anything
in the kernel messages that would have been correlated with a hardware or a
driver failure. To stress-test the equipment, we started a UDP transmission
at a ludicrous speed. Not so surprisingly, we arrived almost at
100Mb/s. It was clear that the root of the problem was in the TCP 
module or its interactions with the queueing disciplines, so the journey
began.

<p>The next step involved the <tt>tc</tt> command.
We started listing the default queueing
discipline and modifying its parameters. By default, we were using the
<tt>mq</tt> queuing discipline, which instantiated an
<a href="https://tools.ietf.org/html/rfc8290">FQ-Codel</a> queuing
discipline for each outgoing hardware queue. With another driver, such as
<tt>ath9k</tt>, 
the entire queuing layer is bypassed and a custom version of it, without
the possibility of tuning or modifying the queueing discipline, is deployed
inside the kernel WiFi subsystem.
With <tt>ath9k_htc</tt> driver, instead, we still had the chance to play
with the queuing discipline type and
parameters. We opted for using the most basic (but reliable) discipline,
<tt>pfifo_fast</tt>. But nothing changed.

<p>We were using the default <a
href="https://en.wikipedia.org/wiki/CUBIC_TCP">CUBIC</a>
congestion-control module. Despite 
the recent hype around <a href="/Articles/701165/">BBR</a>, we decided
to stick with CUBIC because it has always just worked and 
never betrayed us (until now, as it seems). Just for a try, we switched to
BBR, but things got worse than before; the throughput dropped by 50%, never
passing the 20Mb/s line. To do all the tests, we employed <a
href="https://flent.org/">Flent</a>, which also gives latency results.
All the 
latencies were low; we never exceeded a couple of milliseconds of delay. In our
experience, a low throughput with a low latency indicates a
well-known problem: starvation. So the question became: what was limiting
the number of segments transmitted by the client?

<p>In 2012, with <a href="https://git.kernel.org/linus/46d3ceabd8d9">commit
46d3ceabd8d9</a>, TCP small queues were
introduced. Their initial objective was to prevent TCP sockets from
queuing more than 128KB of data in the network stack. In 2013, the
algorithm was updated to have a dynamic limit. Instead of the fixed value,
the limit was defined as either two segment's worth of data or an amount of data
that corresponds to a 
transmission time of 1ms at the current (guessed) transmission rate. The
calculation of the transmission rate was added some months earlier, with
the objective of calculating the proper sizing of segments when TCP
segmentation offload is in use, along with the
introduction of a packet scheduler (FQ) able to spread out the sent segments
over an interval.
<p>
However, the first reports suggested that the amount
of data queued was too low in some subsystems, such as WiFi. The reason
behind this was the impossibility, for the WiFi driver, of performing <a
href="https://en.wikipedia.org/wiki/Frame_aggregation">frame 
aggregation</a>, due to the lack of data in
the driver's queue. The aggregation technique combines multiple packets
into a single frame to reduce the constant overhead for over-the-air
transmission.  Preventing aggregation is a sure way to wreck throughput.

<p>In response, a minimum amount of buffering
(128KB) was restored in <a
href="https://git.kernel.org/linus/98e09386c0ef4">commit
98e09386c0ef4</a>. One year later, a 
<a href="https://git.kernel.org/linus/605ad7f184b60">refactoring patch</a>
for segmentation offload sizing introduced a
small modification that, as we will see, changed the
situation dramatically. The 128KB value was changed from being a lower
bound to an upper bound. If the amount of data queued was forced to be less than
128KB, what would happen to the WiFi aggregation?

<p>Fast forwarding to the 4.14 kernel, we started to think how to tune
these thresholds. First of all, the function that decides (even in
recent kernels) how much TCP data is allowed to enter the network stack is
<a
href="https://elixir.bootlin.com/linux/latest/source/net/ipv4/tcp_output.c#L2191"><tt>tcp_small_queue_check()</tt></a>: 

<p>
<pre>
    static bool tcp_small_queue_check(struct sock *sk, const struct sk_buff *skb,
    	   			      unsigned int factor)
    {
	unsigned int limit;

	limit = max(2 * skb-&gt;truesize, sk-&gt;sk_pacing_rate &gt;&gt; 10);
	limit = min_t(u32, limit, sock_net(sk)-&gt;ipv4.sysctl_tcp_limit_output_bytes);
	limit &lt;&lt;= factor;

	/* ... */
    }
</pre>

<p>The <tt>limit</tt> is calculated as the maximum of two full-size
segments and ~1ms of data 
at the current rate. Then the minimum of this value and
the 128KB threshold is used (to be in sync with the kernel history, we must
say the default value was raised to 256KB in 2015). We started to
wonder what would happen if we patched out the possibility of setting a
lower bound on the amount of data that could be enqueued. We then
modified in the most obvious way the above function to get the following
results:
<p>
<blockquote>
<img src="https://static.lwn.net/images/2018/tsq-limit.png" alt="[Throughput results]"
class="photo">
</blockquote>

<p>The first column represents the results using the pre-fix parameters for
TSQ (two segments or
~1ms of data at the current rate). In the second, we forced 
at least 64KB to be queued. As we can see, the throughput increased by
20Mb/s, but 
also the delay (even if the latency increase is not as pronounced as the
throughput 
increase). Then we tested the original configuration in which the lower
bound was 128KB; the throughput exceeds the 90Mb/s value, with an added
latency of 2ms. It is enough to have 128KB of data queued to have the
proper aggregation behavior, at least with our hardware. Increasing that
value (we plotted up to 10MB) does not improve in any way the throughput,
but it worsens the delay. Even the case in which the TSQ is entirely
disabled did not add any improvement to the situation. We found the cause
of the problem: a minimum value of data should be enqueued to ensure that
frame aggregation works.

<p>After the testing phase, we realized that putting back fixed byte
values would be the wrong choice because, for slow flows, we would only
have increased the latency. But, thanks to the modifications done to
support BBR, we do know what the flow's current rate is: why not use it?
In fact, in <a href="https://git.kernel.org/linus/3a9b76fd0db9f">commit
3a9b76fd0db9f</a>, pushed at the end of 2017, the logic of 
TSQ was enriched by the possibility, for a device driver, to increase the
number of milliseconds worth of data that can be queued. The best value
for throughput 
that worked in all the hardware we tested was in between 4-8ms at the
flow rate. So, we shared our results, and some weeks later a patch was
accepted. In your latest kernel, thanks to <a
href="https://git.kernel.org/linus/36148c2bbfbe">commit 36148c2bbfbe</a>,
your WiFi
driver can allow TCP to queue enough data to solve the aggregation
problem with a negligible impact on latency. 

<p>The networking stack is complicated (what is simple in kernel
space?). For sure, it is not an opaque black box, but instead, it is an
orchestrated set of different pieces of knowledge, reflected into layers
that can, sometimes, make incompatible choices. As a lesson, we learned
that the relationship between latency and throughput on different
technologies is not the same, and aggregation in wireless technologies is
more common than we initially thought. Moreover, as a community, we should
start thinking about automated tests that can give an idea of the performance
impact of a patch under different technologies and in a wide range of
contexts, from the 40Gb/s device of a burdened server to the 802.11ab/g/n
USB dongle connected to a Raspberry Pi.
<p>
[The authors would like to thank Toke Høiland-Jørgensen for his support
and the time he dedicated to the Flent tool, to the WiFi drivers, and to
gather the results from the ath9k and ath10k drivers.]<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking-Wireless">Networking/Wireless</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Augusto_Grazia_Carlo">Augusto Grazia, Carlo</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/757643/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor757783"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2018 3:35 UTC (Tue)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/757783/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which USB/WiFi 802.11ab/g/n dongles were used?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757783/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor757786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2018 6:56 UTC (Tue)
                               by <b>Beolach</b> (guest, #77384)
                              [<a href="/Articles/757786/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't know what specific dongles they used, but the main thing to look for is the chipset used, which as mentioned in the article were Atheros chipsets supported by the ath9k / ath9k_htc drivers.  Even if you get a different brand of dongle, if it has an Atheros chipset supported by these drivers you should be able to get similar results.  As the article mentioned, these ath9k chipsets are fully open-source, both w/ the driver software &amp; the firmware, which allows much easier &amp; faster improvements like this.  Dave Taht also used ath9k chipsets for his CeroWRT Bufferbloat / Make-WiFi-Fast projects, for this same reason.<br>
<p>
Sadly, to the best of my knowledge there are no 802.11ac chipsets w/ both open-source drivers &amp; firmware - I believe even the ath10k 802.11ac chipsets have closed firmware blobs. :-(  I would love to hear about any I've missed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor757976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2018 15:59 UTC (Thu)
                               by <b>mtaht</b> (subscriber, #11087)
                              [<a href="/Articles/757976/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thinner firmware for 802.11ac would be nice, particularly in an age when the main<br>
cpu chip is multicore and much faster than anything built into the wifi chip.<br>
<p>
but wifi has some really hard real-time constraints that require dedicated cpus onboard, and once you start doing that the temptation to wedge all your functionality there has thus far been overwhelming for vendors.<br>
<p>
So far as I know qualcom's 802.11ac devices use a proprietary R/T OS inside.<br>
<p>
Some chipsets (like quantenna's) actually wedge an entire linux stack into their chip.<br>
<p>
qualcomms's LTE modems do also.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor757979"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2018 16:43 UTC (Thu)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/757979/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Power efficiency seems important too - you don't want to wake up Linux on the big high-performance main CPU just so it can choose to ignore a packet, when you could run that logic in the firmware on the already-awake and just-fast-enough CPU in the networking chip instead.<br>
<p>
And portability - you don't want to maintain multiple separate copies of your million lines of driver code (plus regression tests etc) for Linux, Windows, Apple, Fuchsia, the several obsolete Linux versions your customers still use, etc, when it's much easier to put almost all the code in firmware so the OS-specific driver is just a thin wrapper. Plus the Linux community will likely be much happier if you upstream that wrapper and leave the firmware opaque, than if you attempt to upstream your million lines of cross-platform-ish code that doesn't follow the Linux coding style and has an ugly abstraction layer for OS-specific bits.<br>
<p>
None of that stops you making the thick firmware open source, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757979/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor757988"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2018 19:05 UTC (Thu)
                               by <b>mtaht</b> (subscriber, #11087)
                              [<a href="/Articles/757988/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am pleased to say that hooks into qualcomm's 802.11ac firmware have appeared sufficient to mostly mitigate the bufferbloat problem they had there with the code at the mac80211 layer. Certainly I have hope their internal firmware will improve.<br>
<p>
If I had any one wish for "smart firmware", it would be only that there was enough smarts in the wifi and lte hardware/firmware to handle no more than 4ms worth of queuing and real time processing, and let the kernel handle the rest within its constraints for interrupt latency.<br>
<p>
BQL accomplished this for ethernet (sub-1ms there, actually)<br>
<p>
fq_codel for wifi ( <a href="https://www.usenix.org/system/files/conference/atc17/atc17-hoiland-jorgensen.pdf">https://www.usenix.org/system/files/conference/atc17/atc1...</a> ) gets it down to two aggregates, which can take up to ~5ms each, at any achieved "line" rate.<br>
<p>
We can do better than this with better control of txops on the AP, and certainly the algorithms above can exist, offloaded, in smarter hardware, which is happening on several chipsets I'm aware of.<br>
<p>
PS The new sch_cake actually can run ethernet, shaped to 1gbit, at lower latencies  than anything that uses BQL - at a large cost in cpu overhead, but not as much as you might think - it works at that rate on a quad core atom, for example.<br>
<p>
<a href="http://www.taht.net/~d/cake/rrul_be_-_cake-shaped-gbit-quad-long-smoother.png">http://www.taht.net/~d/cake/rrul_be_-_cake-shaped-gbit-qu...</a><br>
<p>
vs sch_fq:<br>
<p>
<a href="http://www.taht.net/~d/cake/rrul_be_-_fq-quad-long-smoother-1.png">http://www.taht.net/~d/cake/rrul_be_-_fq-quad-long-smooth...</a><br>
<p>
The principal advantage of cake, here, even though now capable running at speeds and latencies like this, is to defeat other black box token bucket shapers on a link, however, at much lower rates, with a corresponding reduction in cpu cost to (at sub-100mbit) the level of "noise".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757988/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor758011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 22, 2018 9:52 UTC (Fri)
                               by <b>kronat</b> (subscriber, #117266)
                              [<a href="/Articles/758011/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Some chipsets (like quantenna's) actually wedge an entire linux stack into their chip.</font><br>
<font class="QuotedText">&gt; qualcomms's LTE modems do also.</font><br>
<p>
Do you have a reference for these statements? I am investigating a similar problem in 3GPP networks. Thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758041"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 22, 2018 23:40 UTC (Fri)
                               by <b>mtaht</b> (subscriber, #11087)
                              [<a href="/Articles/758041/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the qualcomm work was first documented by a good ccc talk, the video for which I cannot find right now.<br>
<p>
But: <a href="https://osmocom.org/projects/quectel-modems/wiki">https://osmocom.org/projects/quectel-modems/wiki</a><br>
<p>
and the slides from that talk: <a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/system/event_attachments/attachments/000/003/151/original/Dissecting_modern_%283G_4G%29_cellular_modems.pdf">https://fahrplan.events.ccc.de/congress/2016/Fahrplan/sys...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758041/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor758007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 22, 2018 8:12 UTC (Fri)
                               by <b>cagrazia</b> (guest, #124754)
                              [<a href="/Articles/758007/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Which USB/WiFi 802.11ab/g/n dongles were used?</font><br>
<p>
The exact chipsets we used in our tests are the Atheros AR9271 (ath9k_htc driver), the Atheros AR9580 (ath9k), and Atheros QCA9880v2 (ath10k). For space constraints, we presented here only the results coming from the ath9k_htc device, but we had a similar positive outcome with all the three chipsets.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor757789"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2018 8:04 UTC (Tue)
                               by <b>shiftee</b> (subscriber, #110711)
                              [<a href="/Articles/757789/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Excellent article with a nice positive outcome.<br>
<p>
Dongles based on this chipset are available<br>
<a href="https://www.thinkpenguin.com/gnu-linux/penguin-wireless-n-usb-adapter-gnu-linux-tpe-n150usb">https://www.thinkpenguin.com/gnu-linux/penguin-wireless-n...</a><br>
and<br>
<a href="https://www.olimex.com/Products/USB-Modules/MOD-WIFI-AR9271-ANT/">https://www.olimex.com/Products/USB-Modules/MOD-WIFI-AR92...</a><br>
<p>
If I remember correctly there was a FOSS enthusiast working for Atheros who convinced them to release the firmware code but he has since left the company<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757789/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor757790"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2018 13:29 UTC (Tue)
                               by <b>johan</b> (guest, #112044)
                              [<a href="/Articles/757790/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wish the kernel devs had better testing (in this case regression testing).<br>
If they had they would likely have found issues like these a bit earlier.<br>
Obviously it's a very hard task though considering how many devices there are to test.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757790/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor757815"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2018 17:50 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/757815/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The nominal transfer rate of the dongles is 150Mb/s, but what we saw on the screen was disappointing: an upload iperf connection, no matter which options were used, was able to reach only 40Mb/s. Using another operating system as a client, we were able to achieve 90Mb/s, leaving out a problem with the server. [...] To stress-test the equipment, we started a UDP transmission at a ludicrous speed. Not so surprisingly, we arrived almost at 100Mb/s.</font><br>
<p>
I'd be curious how fast UDP on the other operating system went, to know if it topped out at the same 100Mb/s.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757815/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 22, 2018 8:27 UTC (Fri)
                               by <b>cagrazia</b> (guest, #124754)
                              [<a href="/Articles/758010/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I'd be curious how fast UDP on the other operating system went, to know if it topped out at the same 100Mb/s.</font><br>
<p>
We did a very quick TCP and UDP test on a Windows 8 machine, with a kind of iperf tool (honestly, it was tricky and messy to configure): throughput results were oscillating between 90 and 95 Mbps, while the TCP RTT was very unstable as well as the UDP jitter.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor757975"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TCP small queues and WiFi aggregation — a war story</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2018 14:47 UTC (Thu)
                               by <b>mtaht</b> (subscriber, #11087)
                              [<a href="/Articles/757975/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From eric dumazet and toke on the bloat mailing list:<br>
<p>
From eric dumazet<br>
On 06/21/2018 02:22 AM, Toke Høiland-Jørgensen wrote:<br>
<font class="QuotedText">&gt; Dave Taht &lt;dave.taht@gmail.com&gt; writes:</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;&gt; Nice war story. I'm glad this last problem with the fq_codel wifi code</font><br>
<font class="QuotedText">&gt;&gt; is solved</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt; This wasn't specific to the fq_codel wifi code, but hit all WiFi devices</font><br>
<font class="QuotedText">&gt; that were running TCP on the local stack. Which would be mostly laptops,</font><br>
<font class="QuotedText">&gt; I guess...</font><br>
<p>
Yes.<br>
<p>
Also switching TCP stack to always GSO has been a major gain for wifi in my tests.<br>
<p>
(TSQ budget is based on sk_wmem_alloc, tracking truesize of skbs, and not having<br>
GSO is considerably inflating the truesize/payload ratio)<br>
<p>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0a6b2a1dc2a2105f178255fe495eb914b09cb37a">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
tcp: switch to GSO being always on<br>
<p>
I expect SACK compression to also give a nice boost to wifi.<br>
<p>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=5d9f4262b7ea41ca9981cc790e37cca6e37c789e">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
tcp: add SACK compression<br>
<p>
Lastly I am working on adding ACK compression in TCP stack itself.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757975/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor758055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">MTU</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 23, 2018 18:16 UTC (Sat)
                               by <b>meuh</b> (guest, #22042)
                              [<a href="/Articles/758055/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I asked myself why not increasing the IP MTU (Maximum Transmission Unit) instead of relying on WiFi Frame Aggregation behavior ? I guess the answer is IPv6: as IPv6 doesn't expect routers to fragment packets, a typical TCP connection over the Internet involve packets no larger than 1280 bytes. So the WiFi hardware has to handle such small packets, hence the Frame Aggregation feature.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758140"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">MTU</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2018 9:16 UTC (Mon)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/758140/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Nope; the answer is IEE 802.3 Ethernet. WiFi (IEEE 802.11) is designed to transparently interoperate with 802.3 Ethernets. The IEEE has declared that the Ethernet MTU is fixed at 1500 bytes[1]; this implies that WiFi per-frame MTUs are also fixed at 1500 bytes. Given that it is a hard requirement for WiFi that the frame MTU is no more than 1500 bytes, you need things like aggregation to get a decent speed.
<p>If larger frames were permitted on 802.11, then you would not be able to bridge 802.11 with IEEE standard 802.3; while it's common to support jumbo frames on Ethernet, this is technically a non-standard extension, and IEEE standard 802.11 can't assume that any Ethernet it is connected to will permit jumbo frames.
<p>[1] While the IEEE 802.3 MTU is 1500 bytes, they also now require all equipment to handle frames of up to 2000 bytes in total size, to allow for headers, checksums, VLAN tags etc. WiFi is similar - 2304 byte maximum MSDU frame, of which 1500 bytes maximum is user MTU, and the other 804 bytes are reserved for VLAN tags etc.
      
          <div class="CommentReplyButton">
            <form action="/Articles/758140/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758219"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">MTU</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2018 16:01 UTC (Mon)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/758219/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's what I first though about this but the issue is not that you can't have jumbo 9000 byte MTU on the local layer2 link, either Ethernet or WiFi (although I think WiFi standard only supports 1500), which would be negotiated between endpoints as part of the TCP MSS, it's that intervening links over the Internet at some point are likely to only permit 1500 byte frames, so somewhere along the line you would need to fragment the layer3 packets, which is not allowed for IPv6 which relies on PMTU discovery to find the correct MSS/MTU that can cleanly make it through the whole path, leading to needing aggregation on the first WiFi hop for efficiency, to make up for not requiring upstream routers to fragment/reassemble.  You could probably sidestep this if you had a jumbo-clean path, and you weren't concerned about stations monopolizing airtime with large frames, but that's unlikely unless you control the whole infrastructure between endpoints.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758219/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758221"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">MTU</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2018 16:20 UTC (Mon)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/758221/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Nope. The issue is that you cannot have an MTU above 1500 on Ethernet without breaking the IEEE specs for Ethernet and for WiFi. You are simply not allowed a jumbo MTU on the Layer 2 link, and the IEEE won't accept changes to 802 series standards that increase the user MTU beyond 1500.
<p>IPv6 is not relevant here - it's an IEEE decision because even in IPv4, with router fragmentation allowed, the IEEE doesn't like it.
      
          <div class="CommentReplyButton">
            <form action="/Articles/758221/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758231"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">MTU</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2018 17:28 UTC (Mon)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/758231/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That seems bogus, I'm pretty sure I have many pieces of equipment using jumbo frames, whatever IEEE has in their written specs or whatever they "like".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758231/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor758233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">MTU</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 25, 2018 17:40 UTC (Mon)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/758233/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>You do, but they're not using IEEE standard Ethernet (jumbo frames implies not IEEE standard) - and WiFi standards (including frame aggregation) are written to get high performance when using IEEE standard Ethernet.
<p>Hence frame aggregation rather than high MTUs - a high MTU for performance means being outside the IEEE standard, while a 1500 MTU allows you to be inside the standard.
      
          <div class="CommentReplyButton">
            <form action="/Articles/758233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
