        <!DOCTYPE html>
        <html lang="en">
        <head><title>Detecting and handling split locks [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/790464/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/790560/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/790464/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Detecting and handling split locks</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="GAByline">
           <p>June 7, 2019</p>
           <p>This article was contributed by Marta Rybczyńska</p>
           </div>
<p>The Intel architecture allows misaligned memory access in situations
where other architectures (such as ARM or RISC-V) do not. One such
situation is atomic operations on memory that is split across two cache
lines. This feature is largely unknown, but its impact is even less so.  It
turns out that the performance and security impact can be significant,
breaking realtime applications or allowing a rogue application to slow the
system as a whole. Recently, Fenghua Yu has been working on detecting and
fixing these issues in the <a href="/ml/linux-kernel/1556134382-58814-1-git-send-email-fenghua.yu%40intel.com/">split-lock
patch set</a>, which is currently on its eighth revision.</p>

<h4>From misaligned memory accesses to split locks</h4>

<p>Misaligned memory access occurs when the processor accesses memory at an
address that not aligned to the type of the operand, such as an eight-byte
operation that accesses a four-byte-aligned variable.
Reading four bytes from address <tt>0x1008</tt> is
aligned, for example, while the same operation from <tt>0x1006</tt> is not.
Misaligned accesses can cause varying behavior on different
architectures, including correct and performant operation, exceptions that stop
the processor, or incorrect results.

<p>
Misaligned accesses may incur a performance penalty
even if the processor transparently handles them.
For example, a misaligned access may be  split by the CPU
into two separate memory operations. Another possibility is the processor
generating an exception that is silently handled by the kernel.
Portable and high-performance applications should avoid
misaligned accesses; the kernel's <a
href="https://www.kernel.org/doc/Documentation/unaligned-memory-access.txt">code 
guidelines</a> state that developers should assume natural alignment requirements
on all platforms.</p>

<p>A special type of a misaligned access is one that crosses two
cache lines, possibly causing the processor to have to fetch multiple lines
before performing the operation.  Things get more complicated when an
atomic operation is being performed and the processor must ensure that the
data involved is seen consistently and correctly while the operation is
executed.  Intel platforms support
atomic accesses that are split across two cache lines; such an operation is
called a "split lock".</p>

<p>With a split lock, the value needs to be kept coherent between different
CPUs, which means assuring that the two cache lines change together.
As this is an uncommon operation, the hardware design needs to take
a special path; as a result, split locks may have important consequences as
described in the cover letter of Yu's patch set. Intel's choice was to
lock the whole memory bus to solve the coherency problem; the processor
locks the bus for the duration of the operation, meaning that no
other CPUs or devices can access it. The split lock blocks not
only the CPU performing the access, but also all others in the system.
Configuring the bus-locking protocol itself also adds significant overhead to the
system as a whole.

<p>On the other hand, if the atomic operation operand fits into a single
cache line, the processor will use a less expensive cache lock. This all means
that developers may increase performance and avoid split locks by
actions like simply correctly aligning their variables.</p>

<h4>Split lock consequences</h4>

<p>Yu explained the use cases that motivated this work: hard
realtime, cloud computing, and avoiding a security hole.
The most important one seems to be related to systems
that run hard realtime applications on some cores and normal-priority
processes on other cores.  Split locks may cause the hard realtime
requirements to be broken, as 
the bus locking caused by split locks executed by the regular code blocks
memory accesses by the realtime code. Yu noted that, until now,
such complex realtime applications could not be supported for exactly this
reason:
<div class="BigQuote">
To date the designers have been unable to deploy these solutions as they
have no way to prevent the "untrusted" user code from generating split lock
and bus lock to block the hard real time code to access memory during bus
locking.
</div>
</p>

<p>In the cloud case, one user process from a guest system may block other
cores from accessing memory and cause performance degradation across
the whole system. In a similar way, malicious code may try to slow down the
system deliberately in a denial-of-service attack.</p>

<h4>Solutions</h4>

<p>Intel processors, starting with the upcoming Tremont generation, will be able to
generate an exception (called "Alignment Check" or
<tt>#AC</tt>) when a split lock is detected. Earlier processors support only
an event counter for debugging purposes (exposed by an event counter called
<tt>sq_misc.split_lock</tt> in perf), but do not allow immediate action
from the system. Yu's work is based on this new capability.</p>

<p>The correct response to split locks, including what to do when they
are detected while the system firmware is running, was the subject of <a
href="/ml/linux-kernel/6fbff2df-96c9-db51-371b-a23d1a84d070@intel.com/">some
discussion</a> during the review of the earlier version of the patch
set. The implementation in the current version concentrates on 
detection of the problem.</p>

<p>If a split-lock event happens in the kernel itself, it issues a warning and
disables the detection on the current CPU. After the warning, the faulty
instruction will execute and the system will continue — whether the system
should go on or panic was one of the main topics of discussion.
The rationale is that a
split lock in the kernel is a bug and should be fixed, but the bug is not
so severe that the kernel should be made to panic.
<p>
The situation is different for user processes,
which will be sent a fatal (by default) <tt>SIGBUS</tt> signal. The issue
will need to be 
fixed before that program can run successfully.  Something similar happens
when a split lock is created by the system's
firmware: the system will simply hang at that point.  The developers
decided on this handling because they were afraid that otherwise <a
href="/ml/linux-kernel/alpine.DEB.2.21.1806221125240.2402@nanos.tec.linutronix.de/">the
firmware would never be fixed</a>.</p>

<p>Split-lock detection is enabled by default when it is supported by the
hardware.  However, system administrators have control over the feature:
they can use a new kernel parameter (<tt>nosplit_lock_detect</tt>) at boot
time to disable it.  There is also a sysfs interface to disable it at
runtime  at <tt>/sys/devices/system/cpu/split_lock_detect</tt>.

<p>The patch set also includes support for KVM; it emulates the register in
guests, exposing the property. The host system will have the feature
enabled by default. What to do with the guests was discussed at multiple
occasions; the <a href="/ml/linux-kernel/alpine.DEB.2.21.1904280903520.1757@nanos.tec.linutronix.de/">agreed-on
solution</a> that will show up in the next iteration is to enable it in
guests when the host kernel has it enabled. It means that if the host
kernel has split-lock detection enabled and a guest triggers the exception,
it will be stopped. On the other hand, if the host kernel has it disabled,
the guest may choose to enable and use it, but is not required to.</p>

<h4>Further work</h4>

<p>The work has been through multiple iterations at this point and has
received regular comments from the kernel developers, including Thomas
Gleixner and Ingo Molnar. It has still some issues pending, but at the
current pace it should show up in the mainline kernel before too long.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Architectures-x86">Architectures/x86</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Rybczynska_Marta">Rybczynska, Marta</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/790464/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor790682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 19:02 UTC (Fri)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/790682/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Intel calls these "data chunk split misaligned" loads and stores. When they occur, the (e.g.) load buffer will hold them until the ROB indicates that the execution results would be committable to architectural state. There's a couple of fun patents if you search "data chunk split misaligned" in your favorite search engine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790688"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Worst case scenario ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 20:50 UTC (Fri)
                               by <b>meuh</b> (guest, #22042)
                              [<a href="/Articles/790688/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about an unaligned atomic operation across two consecutive unmapped pages, which will be mapped from physical memory belonging to two different NUMA nodes ?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790688/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790691"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Worst case scenario ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 20:58 UTC (Fri)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/790691/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At that point I submit that you need to either recruit better programmers or identify the saboteur :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790691/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790695"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Worst case scenario ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 21:24 UTC (Fri)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/790695/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Identify the saboteur" ... if this approach can be used deliberately as an attack that could allow unprivileged code in a container to bring the host to its knees.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790695/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790706"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Worst case scenario ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 23:41 UTC (Fri)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/790706/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wasn't even thinking that far, merely as far as "if your software system does this, then something is  wrong with it and you should do something about that".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790706/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor790697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 22:06 UTC (Fri)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/790697/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ARM can handle unaligned memory accesses since ARMv6.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2019 22:58 UTC (Fri)
                               by <b>daney</b> (guest, #24551)
                              [<a href="/Articles/790701/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They are not talking about "normal" memory accesses.  The fun seems to happen on unaligned "atomic" accesses.  IIRC, ARM does not allow for cache line splitting on atomic operations nor  on load-exclusive/store-exclusive.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor861833"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2021 2:00 UTC (Mon)
                               by <b>plugwash</b> (subscriber, #29694)
                              [<a href="/Articles/861833/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s not that simple.<br>
<p>
arm can handle unaligned accesses on regular ldr and str instructions (and I think also ldrh and strh but i&#x27;m not 100% sure on that) since armv6. There are other instructions the hardware can&#x27;t handle unaligned accesses on though (ldrd and vldr spring to mind as ones I&#x27;ve had trouble with in real code). Some of these will be emulated by 32-bit kernels but not by 64-bit kernels leading to programs crashing when run on 64-bit kernels.<br>
<p>
While I haven&#x27;t checked I certainly wouldn&#x27;t expect fancy stuff like atomics to properly support unaligned access on arm.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/861833/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor896525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2022 2:06 UTC (Sat)
                               by <b>plugwash</b> (subscriber, #29694)
                              [<a href="/Articles/896525/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unaligned access on arm is a horrible mess.<br>
<p>
On modern arm32, regular loads and stores are unaligned safe, but many other instructions (notably ldrd and vldr) are not. 32-bit kernels will trap and emulate unaligned accesses by default, but 64-bit kernels running 32-bit applications will not.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/896525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor896528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2022 2:44 UTC (Sat)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/896528/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is the 32-bit userland on 64-bit kernel issue something that could be handled by the kernel or a hardware limitation?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/896528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor790710"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 1:12 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/790710/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why doesn't the processor just lock both cache lines in the case that an atomic operation spans a cache line? I don't see why it would have to lock the whole bus.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790710/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 3:11 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/790713/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because it would need to introduce the whole new protocol for that. Basically adding *lots* of complexity to the common and very time-critical pass for the sake of something which, in property designed system, doesn't happen at all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790740"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 23:43 UTC (Sat)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/790740/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Intel *has* that feature: TSX. I’m a bit surprised that microcode doesn’t emulate split locks using TSX.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790740/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790765"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2019 22:53 UTC (Sun)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/790765/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
TSX is very recent invention and it's implementation is very tricky and buggy. First generations of CPUs where it was implemented had it disable on almost all models in the end.<br>
<p>
I'm not surprised they haven't used it to implement something they needed 20 years ago.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790765/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor790716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 5:14 UTC (Sat)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/790716/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In software you can implement large number of overly complex features for a fixed and low cost and deliver bug fixes later (or... never).<br>
<p>
Hardware is a bit different.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790731"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 19:39 UTC (Sat)
                               by <b>mokki</b> (subscriber, #33200)
                              [<a href="/Articles/790731/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Most likely the easiest way to avoid deadlocks for this rare case is to take bus lock<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790731/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790775"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 10:03 UTC (Mon)
                               by <b>dmiller</b> (guest, #115155)
                              [<a href="/Articles/790775/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could get a deadlock pretty easily this way, and that's one thing that hardware engineers are going to be very careful to try and avoid. Imagine processor 1 has virtual address 0xA0000 mapped to physical address 0x1000 and 0xA1000 mapped to 0x2000, while processor 2 has 0xA0000 mapped to 0x2000 and 0xA1000 mapped to 0x1000. Now say that both do a 4-byte atomic operation to 0xA0FFF at about the same time. This is equivalent to the "Dining Philosophers Problem" for n=2 which requires a good amount of complexity to do safely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790775/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor790729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 17:55 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/790729/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The Intel architecture allows misaligned memory access in situations where other architectures (such as ARM or RISC-V) do not. One such situation is atomic operations on memory that is split across two cache lines. This feature is largely unknown, but its impact is even less so.</font><br>
<p>
Does anybody have any insight why support for such "split" atomic accesses was added? Seems like it's an obvious source of complexity - without IMO having a lot of practical benefit? Allowing un-aligned memory accesses is certainly useful for some work, but I don't quite see that being necessary for atomic operations?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 22:32 UTC (Sat)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/790736/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because back in the 386 (and earlier) days there was no cache and atomic operations were done by literally locking the whole bus, so for the processor it was simpler not to do any check on the alignment after all it did not do any check on non-locked accesses). And when a cache was added, backwards compatibility meant you couldn't drop the feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 2:38 UTC (Mon)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/790767/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed. This is literally what the LOCK instruction prefix byte means in x86.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 6:20 UTC (Mon)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/790769/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That doesn’t explain why it wasn’t quietly dropped with the move to x86-64. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 7:10 UTC (Mon)
                               by <b>camhusmj38</b> (subscriber, #99234)
                              [<a href="/Articles/790771/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Lots of things should have been tidied up at that time. Presumably, AMD thought that might make porting more difficult.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790834"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 20:26 UTC (Mon)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/790834/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If x86-64 was to support a full x86-32 feature set anyway (which it had to, to avoid the fate of Itanic), it would probably be more costly to selectively gate off all those features in long mode than to let them through.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790834/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor790730"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 17:57 UTC (Sat)
                               by <b>lkundrak</b> (subscriber, #43452)
                              [<a href="/Articles/790730/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for this article. It did an excellent job at being an easy read even for someone who happens to be rather ignorant about the multi-processor synchronization or cache architectures. Quality writing of this sort makes it easy to recommend subscribing to LWN to friends.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790730/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790741"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">indeed</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2019 1:19 UTC (Sun)
                               by <b>gus3</b> (guest, #61103)
                              [<a href="/Articles/790741/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree with you wholeheartedly. In fact, you inspired me to renew my subscription, which was set to end next month.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790741/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor790735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 20:54 UTC (Sat)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/790735/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The kernel documentation currently states:<br>
<p>
<font class="QuotedText">&gt; When writing code, assume the target architecture has natural alignment</font><br>
<font class="QuotedText">&gt; requirements.</font><br>
<p>
This is actually bad advice, here’s my suggestion for improvement,<br>
and why this is important:<br>
<p>
<font class="QuotedText">&gt; When writing code, assume the target architecture has natural alignment</font><br>
<font class="QuotedText">&gt; requirements, but be prepared for less alignment.</font><br>
<p>
On m68k, even dword (32-bit) quantities are only aligned for 16 bits,<br>
and there has been software that implicitly relies on the implicit<br>
padding added by natural-alignment architectures if you have a<br>
struct { short; int; }; which is not added on m68k.<br>
<p>
We’ve been fixing some of them by changing some assertions (against<br>
accidental struct growth) from sizeof(struct) == value to &lt;= value,<br>
but the proper fix is to make all struct padding explicit by adding<br>
explicitly unused members to the structures. This also helps visua‐<br>
lising the problems of uninitialised padding when comparing them.<br>
<p>
I’d appreciate if someone with experuence in the LKML community<br>
could pick this up and discuss and fix it there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790737"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2019 23:14 UTC (Sat)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/790737/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I did that for SocketCAN frames. a2f11835994ed5bcd6d66c7205947cc482231b08<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790737/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790745"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2019 4:29 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/790745/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I liked this BTW, do you approve? <a href="http://www.catb.org/esr/structure-packing/">http://www.catb.org/esr/structure-packing/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790745/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790752"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2019 11:53 UTC (Sun)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/790752/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, so ESR wrote a detailled article about it. I only knew from OpenBSD commits and figuring out the rest myself.<br>
<p>
Yes! I’ve significantly reduced the in-memory size of several structures (which are then used in arrays, which pads them to powers of 2 at the end too, so going down from 36 to 32 actually reduces from 64 to 32) in some codebasēs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790752/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2019 18:44 UTC (Sun)
                               by <b>itvirta</b> (guest, #49997)
                              [<a href="/Articles/790760/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What exactly pads your structures to powers of two in arrays?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790782"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 13:17 UTC (Mon)
                               by <b>bcopeland</b> (subscriber, #51750)
                              [<a href="/Articles/790782/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the arrays are dynamically allocated, slab allocator (for example) might do this.  I once looked at a case that was allocating a bunch of individual pointers that all got rounded up from 8 to 32 bytes, meaning 75% of each allocation was unused.  It makes sense that the allocators work that way, but if you don't know that and do this sort of thing hundreds of times, and especially if the memory being allocated happens to be something like 2**n + small_amount, you can accidentally waste a lot of memory. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790782/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790849"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2019 13:26 UTC (Tue)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/790849/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The typical userland allocators on Solaris &amp; Windows also behave this way. It's not very surprising.<br>
<p>
On Linux my memory is a bit muddied between the default glibc allocator, tcmalloc, jemalloc etc. so I'm less confident, but I would expect the same.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790849/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790884"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2019 15:02 UTC (Tue)
                               by <b>fotoba</b> (subscriber, #61150)
                              [<a href="/Articles/790884/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If pointers will be huge or far<br>
not near  or not specified <br>
<a href="https://www.geeksforgeeks.org/what-are-near-far-and-huge-pointers/">https://www.geeksforgeeks.org/what-are-near-far-and-huge-...</a><br>
<p>
<p>
This problem will  not happend as I read well waht happend<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790884/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor791123"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Improving portability advice</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2019 8:03 UTC (Fri)
                               by <b>meuh</b> (guest, #22042)
                              [<a href="/Articles/791123/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This is actually bad advice, here’s my suggestion for improvement,</font><br>
<font class="QuotedText">&gt; and why this is important:</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;&gt; When writing code, assume the target architecture has natural alignment</font><br>
<font class="QuotedText">&gt;&gt; requirements, but be prepared for less alignment.</font><br>
<p>
The original advice should be interpreted as you have to explicitly pad your structure so that members are naturally aligned.<br>
<p>
<font class="QuotedText">&gt; [...] the proper fix is to make all struct padding explicit by adding explicitly unused members to the structures.</font><br>
<p>
Yes, this is the rule you have to follow when designing a data structure to be exchanged between kernel and userspace (or between kernel and firmware/hardware) so that the structure as a fixed size regarding the architecture (and padding can be initialized and/or inspected for unknown bit set).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/791123/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor810289"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2020 16:22 UTC (Wed)
                               by <b>erkki</b> (guest, #124843)
                              [<a href="/Articles/810289/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I benchmarked this and split locks cause a 200 times slow down for single threaded workloads: <a href="https://rigtorp.se/split-locks/">https://rigtorp.se/split-locks/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/810289/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor951345"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2023 20:10 UTC (Tue)
                               by <b>d3x0r</b> (guest, #168005)
                              [<a href="/Articles/951345/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there any support for GDB to be able to pause on these?  I have some code apparently that needs alignment, but I don't know where; most structures are typically aligned so setting the break on the exchange will catch thousands of operations otherwise.   Is there a signal generated?  when I do a search for 'split lock detection gdb' I get articles about one or the other, but not both topics together.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/951345/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor951355"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2023 21:28 UTC (Tue)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/951355/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>The easiest way to catch these is to boot with <tt>split_lock_detect=fatal</tt>; then the kernel will send your process a SIGBUS signal every time you get it wrong. You can then use <tt>catch signal SIGBUS</tt> or <tt>handle signal SIGBUS stop</tt> to get GDB to take control whenever you get a SIGBUS, and your normal tools to debug the program. Note that <tt>catch signal SIGBUS</tt> sets a catchpoint, which can have all your usual nice tools for working with breakpoints applied to it (e.g. <a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Break-Commands.html#Break-Commands">automatic commands run</a> when you hit the catchpoint, or <a href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Conditions.html#Conditions">conditional behaviour</a> such as continuing anyway for a SIGBUS that isn't related to a split lock.


      
          <div class="CommentReplyButton">
            <form action="/Articles/951355/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor951365"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Detecting and handling split locks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2023 4:25 UTC (Wed)
                               by <b>wsy</b> (subscriber, #121706)
                              [<a href="/Articles/951365/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://lwn.net/Articles/911219/">https://lwn.net/Articles/911219/</a><br>
<a href="https://elixir.bootlin.com/linux/latest/source/arch/x86/kernel/cpu/intel.c#L1172">https://elixir.bootlin.com/linux/latest/source/arch/x86/k...</a><br>
<p>
Kernel will give a warning with IP attached.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/951365/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
