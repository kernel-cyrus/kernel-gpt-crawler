        <!DOCTYPE html>
        <html lang="en">
        <head><title>Implementing fully immutable files [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/786258/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/786247/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/786258/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Implementing fully immutable files</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 19, 2019</br>
           </div>
Like all Unix-like systems, Linux implements the traditional protection
bits controlling who can access files in a filesystem (and what access
they have).  Fewer users, perhaps, are aware of a set of additional
permission bits hidden away behind the <a
href="http://man7.org/linux/man-pages/man1/chattr.1.html"><tt>chattr</tt></a>
and <a
href="http://man7.org/linux/man-pages/man1/lsattr.1.html"><tt>lsattr</tt></a>
commands.  Among other things, these bits can make a file append-only,
mark a file to be excluded from backups, cause a file's data to be automatically
overwritten on deletion, or make a file immutable.  The implementation of
many of these features is incomplete at best, so perhaps it's not
surprising that immutable files can still be changed in certain
limited circumstances.  Darrick Wong has posted <a
href="/ml/linux-fsdevel/155552786671.20411.6442426840435740050.stgit@magnolia/">a
patch set</a> changing this behavior, implementing a user-visible
behavioral change that he describes as "<q>an extraordinary way to
destroy everything</q>".
<p>
The <tt>chattr</tt> man page is clear on what happens when the immutable
bit is set:
<p>
<div class="BigQuote">
	A file with the 'i' attribute cannot be modified: it cannot be
        deleted or renamed, no link can be created to this file, most of
        the file's metadata can not be modified, and the file can not be
        opened in write mode.
</div>
<p>
This description is true for the most part (at least on filesystems
supporting this bit), but Wong noticed an important exception: a process
that opens a file for writing prior to the setting of the immutable bit
will still be able to write to the file after the bit is set for as long as
it holds the file descriptor open.  So while many operations on an
immutable file are blocked, modifying the data in the file using open file
descriptors is still allowed.  The file is not yet, in other words, fully
immutable.
<p>
That behavior is both inconsistent and surprising; Wong set out to change
it by making the system actually behave the way the man page says it will.
Doing that requires two types of changes, the first of which is easier than
the second.  Whenever a process attempts to write to a file descriptor, a
call is made to <a
href="https://elixir.bootlin.com/linux/v5.0/source/mm/filemap.c#L2931"><tt>generic_write_checks()</tt></a>
to ensure that the operation can be allowed.  Adding a check for
immutability to that function will cause <tt>write()</tt> calls to fail
immediately once a file has been marked immutable.  A similar check needs
to be added to <a
href="https://elixir.bootlin.com/linux/v5.0/source/mm/mmap.c#L1380"><tt>do_mmap()</tt></a>
to prevent the creation of a writable memory mapping from a file
descriptor.  Those changes close off the most obvious ways to change an
immutable file.
<p>
The remaining problem is that writable memory mappings of the file may already exist,
and those, too, can be used to modify a file that has since been marked
immutable.  User-space code need not make any system calls to write to a
memory-mapped region, so there isn't a single, simple place to add a check
like there is with <tt>write()</tt> and <tt>mmap()</tt>.  The good news is
that most of the needed machinery to prevent such writes is already in
place, thanks to how filesystems manage writable mappings now.
<p>
The problem that a filesystem implementation has to solve is that it, too,
will get no notification when a process writes to a region of memory that has
a file mapped into it; user space simply dereferences a pointer and stores
data there.  But the filesystem needs to know when that happens
so it can ensure that the newly written data eventually finds its way to
persistent storage.  The trick that is used here is to write-protect the
pages in memory.  When user space attempts to write to one of those pages,
a page fault will result; the kernel can then make the page writable and
notify the filesystem that the page has been written to.  When the
filesystem code eventually writes the modified page(s) back to disk, it can
once again write-protect those pages to mark them as being clean and to
catch any subsequent modifications.
<p>
One obvious place, then, to prevent modification of an immutable file is
when that page fault occurs; rather than allow the modification to proceed,
the kernel can fail the operation and deliver a <tt>SIGBUS</tt> signal to
user space.  But even that doesn't catch the case where pages have already been
marked as being writable; user space could continue to make changes to
those.
<p>
Closing that last hole requires making changes to every filesystem that is
to support the new behavior; that is the object of the bulk of the 
patches in Wong's set.  Filesystem implementations already have an
<tt>ioctl()</tt> handler that will be called when the immutable bit is set,
so that is the logical place to respond when the status of a file is
changed.  A number of things need to happen at that point.  If there are
direct I/O operations outstanding, they must be allowed to conclude before
marking the file immutable.  Then, any pages that are currently dirty need
to be flushed out to permanent storage; those changes were made prior to
the file being marked immutable, so they should persist.  Finally, all
pages mapped from the file in question can be marked read-only, at which
point they cannot be modified further.  In most filesystems, flushing dirty
pages and write-protecting them is already implemented as a single
operation, so it's just a matter of calling the right function.
<p>
The end result is that, once a file is marked immutable, it truly cannot be
changed further — at least, until a privileged user clears the immutable
bit.  This is, of course, a change in the kernel's behavior; any
application that relies on the ability to write to an open file descriptor
for an immutable file will break.  <a
href="http://www.hyrumslaw.com/">Hyrum's law</a> says that this is certain
to happen somewhere; that would likely lead to the reversion of this patch
set.  In practice, though, it seems entirely possible that nobody actually
depends on this obscure behavior, so Wong's patch set will fail to destroy
everything as advertised.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems">Filesystems</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/786258/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor786312"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 15:46 UTC (Fri)
                               by <b>nivedita76</b> (guest, #121790)
                              [<a href="/Articles/786312/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The man page on my system at least does note this under BUGS AND LIMITATIONS:<br>
"Setting 'a' and 'i' attributes will not affect the ability to write to already existing file descriptors."<br>
<p>
Some other attributes are also noted to not be implemented yet.<br>
<p>
Also, even for chmod(2) isn't it filesystem-dependent what happens to already open file descriptors if a file is made read-only for eg? The manpage notes that NFS may apply that permission immediately to open files, and presumably local filesystems wouldn't.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786312/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786315"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 16:58 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/786315/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>In practice, though, it seems entirely possible that nobody actually depends on this obscure behavior, so Wong's patch set will fail to destroy everything as advertised.</blockquote>

Postulate that the process writing through mmap() knows nothing of the immutable bit, and does not own the file in question. Then the patch is taking an entirely legal pointer dereference and turning it into a segfault. A segfault caused not only by a different process, but by a different user (who cannot call <tt>kill(pid, SIGBUS)</tt> directly). Maybe that's improbable, but I find it rather frightening all the same.
      
          <div class="CommentReplyButton">
            <form action="/Articles/786315/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786317"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 17:36 UTC (Fri)
                               by <b>derobert</b> (subscriber, #89569)
                              [<a href="/Articles/786317/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Immutable can only be set with by root or something with CAP_LINUX_IMMUTABLE (which normal users typically do not have). So typically the only other user able to cause this is root.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786317/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786333"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 22:25 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/786333/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Good point. So I can mentally move this from the "non-root can kill other user's process" bucket into the (far more niche) "capability X can be used to accomplish non-obvious result Y" bucket. I suppose that's obscure enough that no one is likely to care (capabilities are a rather questionable security boundary anyway).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786333/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 12:55 UTC (Mon)
                               by <b>bandrami</b> (guest, #94229)
                              [<a href="/Articles/786417/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; capabilities are a rather questionable security boundary anyway</font><br>
<p>
Honestly I despise them from a security standpoint, because of the change in reasoning required you demonstrated. More complex is bad, and non-obviously more complex is even worse.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor786375"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 20:43 UTC (Sat)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/786375/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Truncating the file already does this, and it doesn’t need any special permissions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786375/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor786316"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 17:08 UTC (Fri)
                               by <b>augustz</b> (guest, #37348)
                              [<a href="/Articles/786316/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given how frequent writes are and how infrequent setting the immutable bit on a file is, is there no way to tie in some machinery to the bit setting process to close open file handles to the file and/or mmaps? A check on every write seems like to would impact a broader range of users than something tied to setting immutable bit. <br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786316/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786318"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 17:47 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/786318/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or better still, setting the file immutable will fail if there are open write file handles or writable memory mappings for it.  It's a matter of policy whether the user chooses to break these existing open handles, or to wait for them to be closed before safely setting the immutable bit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786318/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786321"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 19:03 UTC (Fri)
                               by <b>augustz</b> (guest, #37348)
                              [<a href="/Articles/786321/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I like it, even simpler. I can close file, or kill process with file open if needed myself in this approach and keeps code even simpler it would seem, no write check on every write, no hooking into file systems / memory allocation. <br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786321/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786324"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 19:47 UTC (Fri)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/786324/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Refusing to do certain filesystem operations (e.g. renaming, deletion) if the file is open is one of the most annoying things Windows does.<br>
Please avoid this on Linux wherever possible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786324/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786387"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 11:19 UTC (Sun)
                               by <b>tao</b> (subscriber, #17563)
                              [<a href="/Articles/786387/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ideally you'd want to be able to do "set immutable then close" to avoid race conditions, hence being able to set the immutable flag on an open file seems reasonable. Maybe some kind of "apply on close" behaviour?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786387/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786392"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 18:11 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/786392/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even better, seal-on-close that can fail if the file still has other open handles. Then it's up to the calling process to either propagate the error or kill all other openers and retry.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786392/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor786328"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 21:47 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/786328/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems like a ton of complexity for very meager benefits. Why not just change the man page? While both Solaris and BSD have similar concepts, their documentation (perhaps wisely) doesn't seem to precisely define the behavior.<br>
<p>
It's also inconsistent. You can continue writing to a file through an existing file descriptor after removing write permissions from the file. Why should immutability be any different? And in my limited experience using extended attributes like immutability, the principal use case seems to be making backup and restore procedures more fail-safe. For the security case, that an existing process already had write permissions suggests the ability to revoke after the fact is a niche feature that doesn't contribute much from a systems engineering standpoint.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786328/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786338"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 2:44 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/786338/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It comes back to the two meanings of ‘read-only’ which are often confused. There is read-only in the negative sense: you are not allowed to write to this file. That is provided by the permission bits. But there is also a positive contract sense of ‘read-only’: the file will not change, now or in the future, because neither you nor anyone else can change it. So while it’s conceptually okay to tighten permissions for new open() calls and yet have existing file handles keep the access that was originally granted, it’s not okay to break a promise that the file would be forever immutable — code relies on that property being honoured. <br>
<p>
(You can compare the different meanings of ‘const’ or ‘readonly’ in languages like C++, Java and C# for another example of how an object can be read-only for you, or have a positive guarantee that it won’t be mutated while you hold a reference to it. Locking in database systems is another place where you have to separate the two meanings.)<br>
<p>
You may be right that in practice it makes little difference. Immutable files are a specialized feature. But if you’re going to have them at all, surely they should be implemented properly. A guarantee of immutability isn’t worth much unless it holds all of the time. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786338/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786343"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 5:59 UTC (Sat)
                               by <b>lkundrak</b> (subscriber, #43452)
                              [<a href="/Articles/786343/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But there is also a positive contract sense of ‘read-only’: the file will not change, now or in the future, because neither you nor anyone else can change it.</font><br>
<p>
Unless you, of course, turn off the immutable bit.<br>
<p>
I'm quite honestly having trouble finding it hard to understand the use case where the immutable files provide any sort of useful guarantee.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786343/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786354"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 12:21 UTC (Sat)
                               by <b>mikemol</b> (guest, #83507)
                              [<a href="/Articles/786354/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
These start to come up when you talk about regulatory compliance, and guarantees like these are just the sort of thing one is occasionally asked to make.<br>
<p>
I could easily construct a high-confidence system that relied on the audit framework to tell me when someone is playing with the immutable bit without the overhead of logging on every write attempt to the file in question, for example. Then, I can rely on the immutable bit (with some restrictions) as I make an assertion that a file does not, shall not change.<br>
<p>
I can see use cases in antivirus frameworks, configuration management frameworks, logging and auditing frameworks, and so on. Effectively, any system where demonstrable, positive control over a system accessible to untrusted individuals.<br>
<p>
It's not a magic bullet, but a useful armor layer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786354/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786355"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 13:01 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/786355/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Good point — I would have expected the immutable bit to be permanent, if it were to be useful in practice. (To turn it off you would have to copy the contents to a new file with a new inode number.) Maybe given that only root can turn it off, it still provides some useful property in a system where normal operation is all non-root?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786355/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786472"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 16:39 UTC (Mon)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/786472/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It *is* useful, even with the way it's currently implemented. For example, exploding a tarball--normally you *want* it to be able to overwrite files lacking write permission bits. Such cases are rather niche, but the complexity is negligible so worth it.<br>
<p>
I'm sure some people would find the proposed behavior of revoking mmap access useful, too. But the additional complexity is *tremendous* and, IMO, not worth the marginal benefit, even if there are a handful of organizations that *must* have the feature. I mean, if they really need such behavior they can always just terminate all processes with open file handles after making a file immutable. Messy, but at least the mess doesn't become a long-term maintenance burden for everybody else. It's a dubious guarantee, anyhow, considering how easy it will be to accidentally break the invariant.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786472/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786489"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 19:44 UTC (Mon)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/786489/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Correction: I meant, normally when exploding a tarball you want it to overwrite files without write permission bits because you're replacing the whole tree, but sometimes you don't and setting a file immutable makes the untar operation blow up. It's a fail-safe. There's some cleaning up to do but less than if that critical file was removed.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786489/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786490"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 20:15 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786490/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This feature has existed in its present form for at least 18 years, probably more. It even used to be documented incorrectly as<br>
<p>
"no data can be written to the file"<br>
(Debian 7 man page)<br>
<p>
someone apparently noted that this wasn't accurate and corrected to documentation to<br>
<p>
"the file can not be opened in write mode."<br>
(<a href="http://man7.org/linux/man-pages/man1/chattr.1.html">http://man7.org/linux/man-pages/man1/chattr.1.html</a>)<br>
<p>
I seriously doubt that there's any organisation on this planet which suddenly "must" have this feature. Methinks this is more something like a bored Oracle guy making undirected changes to a codebase (possibly "a sufficiently well-connected, bored Oracle guy that such undirected changes actually get accepted instead of being stonewalled").<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786490/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor786380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 0:30 UTC (Sun)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/786380/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Searching lead me to one interesting use case - marking mount point directories immutable to prevent accidental creation of files when the filesystem isn't mounted there.  It seems a bit niche though.<br>
<p>
As for security guarantees, wouldn't something like SElinux be more appropriate, fine grained and auditable than this mechanism?  That said, I have no idea if SElinux or similar behave sanely if policy is changed while files are already opened or memory mapped...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786463"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 15:15 UTC (Mon)
                               by <b>janfrode</b> (guest, #244)
                              [<a href="/Articles/786463/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Spectrum Scale/GPFS has a more useful immutability function, where files are made immutable for a given period, and you can’t reset it without deleting the filesystem/fileset: <br>
<p>
<a href="https://www.ibm.com/developerworks/community/wikis/home?lang=en-us#!/wiki/fa32927c-e904-49cc-a4cc-870bcc8e307c/page/Immutable%20Filesets">https://www.ibm.com/developerworks/community/wikis/home?l...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786463/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor786330"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2019 22:08 UTC (Fri)
                               by <b>Freeaqingme</b> (subscriber, #103259)
                              [<a href="/Articles/786330/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a specific reason why this cannot be solved in VFS, but has to be solved in all individual file systems instead? I would think - or rather, postulate - that VFS has an index per FS to keep track of what fd links to what inode. If such index exists, you could simply update the FD in VFS level when an  attribute is changed?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786330/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786335"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 1:34 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/786335/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As the article says, the fs-specific changes are not for the file descriptor case, but rather the memory mapped file case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786335/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor786351"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">DAX</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 10:53 UTC (Sat)
                               by <b>TheGopher</b> (subscriber, #59256)
                              [<a href="/Articles/786351/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn't this all fall apart on DAX (Direct Memory Access)? I think messing with access controls on open file descriptors is in general problematic, I'd like to hear about use cases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786351/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786364"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 15:44 UTC (Sat)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786364/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is documented behaviour and entirely consistent with the way all file permissions work: Access checks are done on open. Could we perhaps patch the guy who apprently didn't know this instead?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786364/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786365"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 16:16 UTC (Sat)
                               by <b>gus3</b> (guest, #61103)
                              [<a href="/Articles/786365/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
1. User's program P opens file A for write.<br>
<p>
2. Root checks for open descriptors on A, terminates User's process.<br>
<p>
3. The parent process of P notes abnormal termination, re-launches P, which re-opens A.<br>
<p>
4. Root sets immutable bit on A, but... too late, the file isn't immutable for User.<br>
<p>
Or, just take the system down to single-user, to make sure *nobody* has access except Root; set the immutable bit(s) in question; then return to multi-user.<br>
<p>
The current implementation of immutable (and append-only) files forces a sysadmin to choose between guaranteed behavior and uptime, a choice that the sysadmin's boss might not (will not) understand.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786365/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 20, 2019 22:09 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/786378/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
1a. Root sets the permission bits on file A to a-w so that no new file opens can happen unless read-only. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786397"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 21:01 UTC (Sun)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786397/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is exactly the same as for all file configuration bits in an i-node: They have no retroactive effects, ie, code using a valid file descriptor according to the 'contract' the kernel agreed to at time of the open won't suddenly experience failures because this or that i-node change happened to be made.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786397/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786551"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2019 16:42 UTC (Tue)
                               by <b>sorokin</b> (guest, #88478)
                              [<a href="/Articles/786551/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; 2. Root checks for open descriptors on A, terminates User's process.</font><br>
<font class="QuotedText">&gt; 4. Root sets immutable bit on A, but... too late, the file isn't immutable for User.</font><br>
<p>
I would say that the problem is the order of the operations. Root should set the immutable bit first and then terminate processes that use the file.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786551/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2019 16:46 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/786637/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, but then there's an unsafe period in between when the file is marked immutable, but isn't actually immutable (processes could change it before they eventually get killed).  Which is what the change described in the article is intending to fix.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 25, 2019 16:10 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786760/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is still exactly the same as for all other file mode bits: They don't change the past. An immutable file cannot be opened for writing, not even by a privileged process. This doesn't and cannot mean the data in the file isn't going to change. Eg, someone could change it via the device file. Or with a filesystem debugger. Or by reformatting the partition. Or with a custom kernel module disabling the check. There are presumably more possibilities here.<br>
<p>
The change described in the article doesn't "fix" anything, it just replaces the documented semantics with something else.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor786385"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 9:06 UTC (Sun)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/786385/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is only consistent, if the immutable bit is regarded as a permission, just as the well known rwx flags. If the immutable bit is regarded as a file property, then it is not consistent. Maybe one should look at the use cases for this bit. They should be a bit special, as most use cases should be fine with chown root and chmod go-w.<br>
<p>
I would rather think that immutable and append only are not file permissions and therefore it might be sensible to treat them differently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786385/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786415"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 11:44 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786415/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is only consistent if it's viewed in a consistent way and becomes inconsisten when regarded as ... well ... inconsistent, ie, "But I want this to be different and special!". The feature hasn't been implemented in this way and has existed for a long time in the way it has been implemented. The implementation is consistent because all 'inode bits' affecting file access are treated in the same way. This is easier to see for append-only. Marking a file as append-only means that future opens for writing will only succeed if done in append mode.<br>
<p>
'Immutable' is a bit messy because it both affects accesses to the file data and changes to the i-node. But "this file cannot be opened for writing" is a perfectly well-defined effect. It's also different from the ordinary write permissions because files marked as immutable also cannot be opened for writing by privileged processes while the bit is set. *If* some kind of retroactively effective access permission change is actually needed for something, ie, this is not just about an impedance mismatch between someone's idea of the English meaning of immutable and the technical term 'immutable file', it would be better to implement this as a different property than to change the semantics of an existing one.<br>
<p>
There's also no documented error code which could be returned by write to indicate "your access has been revoked", hence, existing code supposed to handle transient file system misconfiguration automatically is pretty much guaranteed to be broken by this. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786415/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 15:04 UTC (Mon)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/786461/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given the model you describe, it appears that the whole design wart of an immutable bit would go away if there were a fourth set of permission bits on a file: a mask revoking read, write, or execute permission, and applying even to the root user.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor786393"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 19:24 UTC (Sun)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/786393/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This calls attention to a bigger problem that has been noted frequently: the Posix file operations are all unavoidably racy. We need a better file management interface.<br>
<p>
The fundamental problem here is that between creating, writing, and marking the file, another process can slip in and alter the file, so that after marking it, you still have to go back and check that it was not corrupted before it was marked. This last step is likely to be omitted in real code.<br>
<p>
Alternatively, you make an unreadable directory and a file with an unguessable name, write the file, mark it, and then mv it into place. But does mv even work on a file so marked, if I can't link() it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786393/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786394"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 19:33 UTC (Sun)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/786394/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oops, it also says "cannot be renamed". So is there no non-racy way to do this, short of re-reading the file to make sure it has in it what it should, and (if not) deleting it and starting over?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786394/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786398"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 21, 2019 22:35 UTC (Sun)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/786398/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe use O_TMPFILE?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786398/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786426"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 14:44 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786426/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is not a problem with anything-POSIX, it's a necessary consequence of the fact that the system supports multiprogramming and that all processes have access to a shared filesystem namespace. Just like address space shared among multiple threads, this is supposed to enable processes coordinating their activities to cooperate easily. It's not supposed to isolate hostile applications from each other. Facilities for dealing with this to some degree exist, eg, namespaces, but due to the possibility of bugs in the code providing these facilities, these isolation efforts will always end up being somewhat futile: A sufficiently hostile application will be able to get around them somehow.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786426/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2019 16:41 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/786550/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, this is not a necessary consequence. One could specify operations that are not racy in this way, just POSIX does not do so. For example one could add a version of open that creates a file with zero links and just an open file descriptor. Just as if the file would have been deleted after opening it. And one could add a system call that creates a new link to a given file descriptor (i.e. add a directory entry). Then it would be possible to create a file, write to it, change all necessary attributes and permission bits and just create the link after everything is done. For other processes this would look like an atomic operation, as the finished file appears out of nowhere. And in a way it would be an atomic operation. If the process crashes before creating the link to the file, the file would not be there at all. It would be deleted like every other file with zero links and no open file descriptors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786552"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2019 17:01 UTC (Tue)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786552/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
POSIX doesn't deal with Linux i-node attributes like the immutable bit.<br>
<p>
BTW, concluding that the racyness is not a necessary consequence of the shared filesystem namespace by coming up with a contrived example built on avoiding use of the shared filesystem namespace is 'interesting' reasoning. Why is it supposed to be avoided if it's not the cause of the problem?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786552/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor786706"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 25, 2019 8:06 UTC (Thu)
                               by <b>thithib</b> (guest, #115203)
                              [<a href="/Articles/786706/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Isn't this exactly one of the two main use cases of O_TMPFILE?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786706/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor786467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And what about DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 16:28 UTC (Mon)
                               by <b>meuh</b> (guest, #22042)
                              [<a href="/Articles/786467/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      After reading the <i>thread</i> (<a href="/Articles/753027/">1</a>, <a href="/Articles/774411/">2</a>, <a href="/Articles/784574/">3</a>, <a href="/Articles/786172/">4</a>) about <code>get_user_pages()</code> and corruptions/crashes happening when a <code>mmap()</code><i>ed</i> file is writing to through DMA, I wonder what will happen when a peripheral will try to DMA-<i>write</i> to a memory mapped file toggled immutable ...

      
          <div class="CommentReplyButton">
            <form action="/Articles/786467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786480"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">And what about DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 22, 2019 17:48 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/786480/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's going to be swallowed by an impromptu created, super-miniature black hole.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786480/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor786556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2019 17:53 UTC (Tue)
                               by <b>xorbe</b> (guest, #3165)
                              [<a href="/Articles/786556/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps it's better to fail setting the immutable bit if there are open write handles.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Implementing fully immutable files</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2019 19:04 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/786654/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This certainly seems nicer than flushing all dirty data (bound for that inode? on that fs? on the *entire system*?) whenever the immutable bit is set. Saying that chattr +i implies a sync() is extremely counterintuitive.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
