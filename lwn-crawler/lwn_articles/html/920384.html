        <!DOCTYPE html>
        <html lang="en">
        <head><title>Hiding a process's executable from itself [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/920384/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/920485/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/920384/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Hiding a process's executable from itself</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 23, 2023</br>
           </div>
Back in 2019, a <a href="/Articles/781013/">high-profile container
vulnerability</a> led to the adoption of some complex workarounds and a
frenzy of patching.  The immediate problem was
fixed, but the incident was severe enough that security-conscious
developers have continued to look for ways to prevent similar
vulnerabilities in the future.  <a
href="/ml/linux-kernel/20230119170718.3129938-1-gscrivan@redhat.com/">This
patch set</a> from Giuseppe Scrivano takes a rather simpler approach to the
problem.
<p>
The 2019 incident, which came to be known as CVE-2019-5736, involved a
sequence of steps that culminated in the overwriting of the <a
href="https://github.com/opencontainers/runc"><tt>runc</tt></a>
container-runtime binary from within a container.  That binary should not
have even been visible within the container, much less writable, but such
obstacles look like challenges to a determined attacker.  In this case, the
attack was able to gain access to this binary via 
<tt>/proc/self/exe</tt>, which always refers to the binary executable for
the current process.
<p>
Specifically, the attack opens the <tt>runc</tt> process's
<tt>/proc/self/exe</tt> file, creating a read-only file descriptor — inside
the container — for the
target binary, which lives outside that container.  Once <tt>runc</tt>
exits, the attacker 
is able to reopen that file descriptor for write access; that descriptor
can subsequently be used to overwrite the <tt>runc</tt> binary.  Since
<tt>runc</tt> is run with privilege outside of the container runtime, this
becomes a compromise of the host as a whole; see the above-linked article
for details.
<p>
This vulnerability was closed by having <tt>runc</tt> copy its
binary image into a memfd area and sealing it; control is then be passed
to that image before entering the container.  Sealing prevents modifying
the image, but even if that protection fails, the container is running from
an independent copy of the binary that will never be used again, so
overwriting it is no longer useful.  It is a bit of an elaborate
workaround, but it plugged the hole at the time.
<p>
Scrivano is proposing a different solution to the problem: simply disable
access to <tt>/proc/self/exe</tt> as a way of blocking image-overwrite
attacks of this type.  Specifically, it adds a new <a
href="https://man7.org/linux/man-pages/man2/prctl.2.html"><tt>prctl()</tt></a>
command called <tt>PR_SET_HIDE_SELF_EXE</tt> that can be used to disable
access to <tt>/proc/self/exe</tt>.  Once this option has been enabled, any
attempt to open that file from within the owning process will fail with an
<tt>ENOENT</tt> error — as if
the file simply no longer existed at all.  Enabling this behavior is a
one-way operation; once it has been turned on, it cannot be disabled until
the next <a
href="https://man7.org/linux/man-pages/man2/execve.2.html"><tt>execve()</tt></a>
call, which will reset this option to the disabled state, is made.
<p>
This behavior is necessarily opt-in; any program that wants to have its
executable image protected from access in this way will have to request it
specifically.  The intent, though, is that this simple call will be able to
replace the more complicated workarounds that are needed to prevent this sort
of attack today.  A <tt>prctl()</tt> is a small price to pay if it
eliminates the need to create a new copy of the executable image every time
a new container is launched.
<p>
This new option is thus a simple way of blocking this specific attack, but
it leads to some related questions.  Hiding the container-runtime binary
seems like less satisfying solution than ensuring that this binary cannot
be modified regardless of whether it is visible within a container.  It
seems like it closes off one specific path to a compromise without
addressing the underlying problem.
<p>
More to the point, perhaps, is the question of just how many operations the
kernel developers would like to add to prevent access to specific resources
that might possibly be misused.  There is, conceivably, no end to the files
(under <tt>/proc</tt> and beyond) that might be useful to an attacker who
is determined to take over the system.  Adding a new <tt>prctl()</tt>
option — and the necessary kernel code to implement it — for every such
file could lead to a mess in the long term.  There comes a point where it
might make more sense to use a security module to implement this sort of
policy.
<p>
If the development community feels that way, though, it's not saying so —
or much of anything else.  The patch set has been posted three times and has not
received any substantive comments any of those times.  There will,
presumably, need to be an eventual 
discussion that decides whether this type of mechanism is the best way of
protecting systems against attacks using <tt>/proc/self/exe</tt>.  For the
moment, though, it would appear that this change is simply waiting for
the wider community to take notice of it.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#proc">/proc</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Security_technologies">Security/Security technologies</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/920384/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor920855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 17:07 UTC (Mon)
                               by <b>TheGopher</b> (subscriber, #59256)
                              [<a href="/Articles/920855/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn't it be better to just *not* mount /proc in the mount namespace (container)? I feel this is somehow attacking the problem from the wrong angle.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920856"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 17:09 UTC (Mon)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/920856/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Lots of programs assume that <tt>/proc</tt> is mounted; not mounting it would cause all kinds of annoying failures like the inability to usefully run <tt>ps</tt> inside a container, for example.



      
          <div class="CommentReplyButton">
            <form action="/Articles/920856/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920870"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 18:10 UTC (Mon)
                               by <b>TheGopher</b> (subscriber, #59256)
                              [<a href="/Articles/920870/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How common is this within containers though these days? And these tools should I think work just fine from the outside of the container?<br>
It seems like a game of whack-a-mole to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920870/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 8:46 UTC (Tue)
                               by <b>LtWorf</b> (subscriber, #124958)
                              [<a href="/Articles/920917/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can't recall if it's java or c#, but at least one of them, and perhaps both, requires /proc to be mounted to run at all. I know because I had tried to not mount /proc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor920858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hide /proc?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 17:21 UTC (Mon)
                               by <b>nickodell</b> (subscriber, #125165)
                              [<a href="/Articles/920858/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Many useful tools use /proc. For example, ps reads from it. If you restricted access to it, you'd break those tools.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920890"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hide /proc?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 21:10 UTC (Mon)
                               by <b>jccleaver</b> (subscriber, #127418)
                              [<a href="/Articles/920890/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;Many useful tools use /proc. For example, ps reads from it. If you restricted access to it, you'd break those tools.</span><br>
<p>
I think a bigger point is that we should probably start swinging back to running more lightweight VMs and fewer containers. <br>
The middle-ground is really annoying for anyone who has to live-debug something that was built by an OS-oblivious Dev somewhere who felt that no one would ever have to, say, run a ping command to validate network paths and was super-excited to show how they just saved 28K.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920890/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor920861"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 17:24 UTC (Mon)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/920861/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The tools like ps don't work. Painful for debugging / monitoring, but I'm not sure how painful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920861/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920899"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 1:32 UTC (Tue)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/920899/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exceptionally painful.<br>
<p>
ps is uselessly container-ignorant at the moment. It has no support for filtering by pid namespace, for example. It does not know how to use the NSPid fields in /proc/$pid/status to show a process's pid in another pid namespace, or to display a process identified by a pidns + a pid in that namespace. It can't even be told to display a tree of processes starting at a specific parent pid, you have to use the otherwise more limited pstree command for that.<br>
<p>
And that's just ps. Tools like gdb are completely incapable of functioning usefully across container boundaries and rely on having a gdbserver injected into the target container. Which in turn requires access to /proc, a session with CAP_SYS_PTRACE, etc.<br>
<p>
It's a nightmare. Container runtime tools are utterly primitive and provide no assistance whatsoever.<br>
<p>
As far as I can tell, believers in os-less containers don't actually think interactive debugging is relevant. I guess you're supposed to use printf() debugging, tracing/APM, and psychic powers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920899/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920915"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 8:33 UTC (Tue)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/920915/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interactive debugging is not relevant, because in production it is most of the time explicitly prohibited by regulations, and auditors regularly check compliance. And for non-production, you are welcome to have a separate debug container.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920915/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920931"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 10:38 UTC (Tue)
                               by <b>tpo</b> (subscriber, #25713)
                              [<a href="/Articles/920931/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Interactive debugging is not relevant</span><br>
<p>
Objection. It is relevant. I have to do it all the time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920931/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921034"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 15:11 UTC (Tue)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/921034/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <p>That just means that you don't have production environment, then.</p>

<p>Remember? <a href="https://twitter.com/stahnma/status/634849376343429120?lang=en">Everybody has a testing environment. Some people are lucky enough enough to have a totally separate environment to run production in.</a></p>

<p>I recommend you to get that separate environment to run production in.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/921034/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 5:20 UTC (Wed)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/921110/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Allow me to introduce you to the swear-words "intermittent fault" and "heisenbug".<br>
<p>
Sometimes you just have to debug what's in prod, because that's where the user/customer is hitting an issue.<br>
<p>
You definitely don't want to have to re-deploy a bunch of new container versions with printf-style debugging hacked in, different compile flags with debuginfo, etc as you try to understand the problem.<br>
<p>
Prod should be debuggable. Run services with minimal privileges, in bare-bones containers, yes. But have a way to fetch the debuginfo for compiled executables when required, inject an elevated process with a debugger, etc, so you can debug-in-place if and when required.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 12:00 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/921128/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; Prod should be debuggable.</font>

<p>If your prod is debuggable then it just means you company is not large enough to have a prod.</p>

<font class="QuotedText">&gt; Allow me to introduce you to the swear-words "intermittent fault" and "heisenbug".</font>

<p>Oh, sure. There are lots of stories like these. But they are not the reason to give someone access to prod with customer's data. Precisely because they come and go they are annoying (and sometimes take years to find out and fix) but they are not enough to permit access of some random developer to customer's data.</p>

<font class="QuotedText">&gt; You definitely don't want to have to re-deploy a bunch of new container versions with printf-style debugging hacked in, different compile flags with debuginfo, etc as you try to understand the problem.</font>

<p>Not only you have to do that, but you have to ensure that all your temporary logging changes would be properly vetoed and approved by a security team. Or else regulators would eat you alive.</p>

<font class="QuotedText">&gt; But have a way to fetch the debuginfo for compiled executables when required, inject an elevated process with a debugger, etc, so you can debug-in-place if and when required.</font>

<p>As I have said: if you are allowed to do that the you don't have a prod but a testing environment exposed to customers.</p>

<p>While valuable in many cases this requires their explicit assent and it's not a prod.</p>

<p>You can afford to do thing differently in testing environment.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/921128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 12:22 UTC (Wed)
                               by <b>tpo</b> (subscriber, #25713)
                              [<a href="/Articles/921130/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are assuming that there is exactly one context and that is your context with your givens and everything works like your context and only that way of working is correct and valid. Let me assure you there do exist other contexts than yours (really, I am not making this up!) that have other constraints than yours and work (maybe have to work!) differently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921224"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 17:28 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/921224/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>Nope. It's not about context. It's about definition. If you can do ssh to your “production” system and do something there then it's “advanced testing” environment or something else, but that's not a “production environment”.</p>

<p>Most startups don't have production and that's normal. But that doesn't mean you need gdb access in production. You don't. It's not a production till you need it.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/921224/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921241"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 18:05 UTC (Wed)
                               by <b>tpo</b> (subscriber, #25713)
                              [<a href="/Articles/921241/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nope. Neither is there a canonical definition of "production environment" nor is it up to you in particular to tell anybody what the constraints to be applied are to be allowed to use that term.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921241/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 18:09 UTC (Wed)
                               by <b>tpo</b> (subscriber, #25713)
                              [<a href="/Articles/921243/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The definition of "production environment is" is, I would say: it is used in production.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 18:54 UTC (Wed)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/921251/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please, everyone, hold off. Everyone's "production environment" is different and comes with different levels of restrictions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor921217"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 16:14 UTC (Wed)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/921217/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; If your prod is debuggable then it just means you company is not large enough to have a prod.</span><br>
<p>
If you think it is possible to have a full replica in test of your prod, then it just means you havn't worked at the largest tech companies.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921217/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921225"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 17:35 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/921225/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; If you think it is possible to have a full replica in test of your prod</font>

<p>What gave you that illusion? Yes, you can not tests everything before deployment, but that just means that your logging and telemetry becomes important.</p>

<p>Especially if you deploy not just to your servers but to millions of devices around the world.</p>

<p>But this still doesn't change the fact that production is where you can not rung gdb. It's just definition of “production”. It deals with sensitive customer's data. That's why gdb is not welcome there.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/921225/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921231"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 17:46 UTC (Wed)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/921231/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The largest prods are very debuggable. Sophisticated telemetry, with profiling and at-scale data gathering and analysis systems, right down to GDB on the instance if you need it (though this would be unusual, I'd say).<br>
<p>
It's a bit nonsensical to think that banning gdb from prod will protect customer data from the people who have access either the running instance or the code. <br>
<p>
What does happen is that you can only access instances for the software that you are responsible. Everything is as compartmentalised as possible. (Though, this still has limits, given there are groups of people responsible for system level software on various classes of the fleet).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921231/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor921091"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 20:47 UTC (Tue)
                               by <b>geofft</b> (subscriber, #59789)
                              [<a href="/Articles/921091/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you need to be much more specific - I work in a regulated industry and we certainly do not have auditors who object to interactive container access. We do care about making sure that sessions to production are approved and logged, but there's nothing wrong with running ps inside an approved and logged session, and I think the relevant regulators would in fact be less happy if we said that we have no way for a human (i.e., the actual entity that's subject to regulations) to investigate our production environments.<br>
<p>
I don't dispute that there are some use cases in some industries where specific regulations in particular jurisdictions may prohibit this, but it's certainly not universal (and of course there are plenty of use cases that legitimately count as production that aren't in regulated industries).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921091/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor921478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2023 15:00 UTC (Fri)
                               by <b>jwarnica</b> (subscriber, #27492)
                              [<a href="/Articles/921478/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Rather than try to jump in deep down the other side: administrators/auditors/developers can flip this around the other way:<br>
<p>
If you need to do interactive debugging in, er, some highly constrained environment, then you have two bugs, one of which is your system isn't verbose enough, doesn't have good enough logging and metrics, etc. And then whatever the other bug is.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor921242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 18:13 UTC (Wed)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/921242/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I regret posting this.<br>
<p>
There are environments where having *any* access to the client's / outside data is forbidden.<br>
<p>
There are environments where the deploy-ers can have access to anything to keep the deployed working.<br>
<p>
And there are those at various levels between. The number of quite correct for their environment possibilities, to me, argues against any OS taking "sides." I'm not sure if the levels of access (MLS, etc.) are sufficiently well-defined for a general OS kernel to mediate that access.<br>
<p>
Whether or not the kernel can be configured to an outside model unfortunately is not separate. Unless maybe to the extremes? And let another level / ring dictate access? I'm just a silly library / application developer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor920923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 9:41 UTC (Tue)
                               by <b>smcv</b> (subscriber, #53363)
                              [<a href="/Articles/920923/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Wouldn't it be better to just *not* mount /proc in the mount namespace (container)?</span><br>
<p>
Even if you don't want the ability to run tools like ps inside the container, increasingly much lower-level library functionality relies on having /proc mounted, mainly for /proc/self/fd, which is used to emulate fd-relative I/O (for example fexecve(3) was unimplementable without /proc mounted until execveat(2) was added to Linux), and is still necessary even on the latest kernels if you want to pass a fd-relative path to a subprocess that expects a filename as a command-line option.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor920937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 12:08 UTC (Tue)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/920937/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, runc initialization needs /proc to be mounted.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor920936"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 12:12 UTC (Tue)
                               by <b>judas_iscariote</b> (guest, #47386)
                              [<a href="/Articles/920936/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the C library needs /proc mounted, otherwise several things do not work as expected. (things that can only be done that way as they were not properly implemented with syscalls *ejem*) <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920936/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor920863"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 17:53 UTC (Mon)
                               by <b>jepler</b> (subscriber, #105975)
                              [<a href="/Articles/920863/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would the same problem apply to /proc/self/map_files entries? overwriting libc.so in the host would be even worse than overwriting runc, if the same or similar technique applies!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920863/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920876"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 18:50 UTC (Mon)
                               by <b>gscrivano</b> (subscriber, #74830)
                              [<a href="/Articles/920876/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
they are already protected by the following check:<br>
<p>
static const char *<br>
proc_map_files_get_link(struct dentry *dentry,<br>
            struct inode *inode,<br>
                struct delayed_call *done)<br>
{<br>
    if (!checkpoint_restore_ns_capable(&amp;init_user_ns))<br>
        return ERR_PTR(-EPERM);<br>
<p>
    return proc_pid_get_link(dentry, inode, done);<br>
}<br>
<p>
where checkpoint_restore_ns_capable is defined as:<br>
<p>
static inline bool checkpoint_restore_ns_capable(struct user_namespace *ns)<br>
{<br>
	return ns_capable(ns, CAP_CHECKPOINT_RESTORE) ||<br>
		ns_capable(ns, CAP_SYS_ADMIN);<br>
}<br>
<p>
So you must either have CAP_SYS_ADMIN in the initial user namespace, or have CAP_CHECKPOINT_RESTORE in the user namespace.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920876/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor920872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 18:30 UTC (Mon)
                               by <b>nomeata</b> (subscriber, #16315)
                              [<a href="/Articles/920872/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am probably ignorant of something obvious here, but isn't<br>
<p>
“Once runc exits, the attacker is able to reopen that file descriptor for write access”<br>
<p>
the fundamental problem? Why is it ok to turn a read-only filedescriptor into a read-write filedescriptor?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920877"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 18:53 UTC (Mon)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/920877/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Alternatively, "if the stuff running in the container is untrusted, why does that stuff have permission to write to the runc binary?"<br>
<p>
As the linked LWN article says, this is an issue specifically for "containers that run with access to the host root user ID (i.e. UID 0), which, sadly, covers most of the containers being run today."  That's the real problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920877/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920938"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 12:11 UTC (Tue)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/920938/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, we are working with Giuseppe to use user namespaces in Kubernetes, and so pods using it won't be able to do that attack. This was mentioned in the CVE announce too.<br>
<p>
But this is taking some years, and probably some more to be enabled by default. Furthermore, it will not eliminate completely the need to run _some_ things as root on the host.<br>
<p>
Therefore, it is still very useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920938/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2023 5:31 UTC (Tue)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/921684/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I doubt that the kernel should become more and more complicated and ugly while developers play whac-a-mole fixing leaks as they are discovered, just because some popular container tools don't use the mechanism provider for the priviliege separation, namely user namespaces.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor920878"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 19:10 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/920878/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; More to the point, perhaps, is the question of just how many operations the kernel developers would like to add to prevent access to specific resources that might possibly be misused. There is, conceivably, no end to the files (under /proc and beyond) that might be useful to an attacker who is determined to take over the system. Adding a new prctl() option — and the necessary kernel code to implement it — for every such file could lead to a mess in the long term. There comes a point where it might make more sense to use a security module to implement this sort of policy.</span><br>
<p>
In principle, couldn't the kernel simply allow processes to call unlink(2) on proc files (which would make those files vanish from *that process's* view of procfs, but would not affect any other process's view of procfs)? This would presumably require some bookkeeping on the part of the kernel, but I can't imagine it would be all that onerous.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920878/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920939"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 12:13 UTC (Tue)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/920939/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And if the process forks, can it read /proc/parent/exe?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920939/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921048"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 16:07 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/921048/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The child inherits a copy of the parent's view of procfs (it resets on execve). So if the parent has removed /proc/self/exe, then that (probably) should also remove /proc/[PID]/exe, and everything that symlinks to it.<br>
<p>
I dunno, maybe the parent has to resolve the symlink, for symmetry with the "real filesystem" case?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921048/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921084"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 19:20 UTC (Tue)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/921084/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, then you can re-exec yourself and get the link? I don't see how that can be better. Am I missing something?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921084/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 19:56 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/921089/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We're talking about an instance of the confused deputy problem, where you trick some other program (runc) into exec'ing /proc/self/exe. If you can persuade runc to execute arbitrary code, then you've already won anyway, and don't even need to bother with making it exec itself in the first place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921102"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 0:27 UTC (Wed)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/921102/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Runc runs arbitrary commands: it runs your container image. If you fork and exec you are probably in another PID namespace, but if you use the host PID namespace you have access to /proc/parent/exe. It seems fragile, IMHO, your suggestion <br>
<p>
 This is how the CVE is exploited, you run your command so that it opens /proc/self/exe and you get that pointing to the runc binary.<br>
<p>
See this blog post for an example exploit of the CVE: <a href="https://kinvolk.io/blog/2019/02/runc-breakout-vulnerability-mitigated-on-flatcar-linux/">https://kinvolk.io/blog/2019/02/runc-breakout-vulnerabili...</a><br>
<p>
IMHO what seems buggy is that you can open /proc/self/exe and that is the runc binary. I don't know now if that is something we can avoid, though. Probably not, for some reason I don't remember now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921102/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor920884"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2023 20:41 UTC (Mon)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/920884/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Going back to the initial article about the vulnerability, this seems more like a failure to blacklist runc from launching itself. The is self-referential trick using /proc/self/exe is obviously not something that ought to be allowed and yet runc accepts it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920884/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920910"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 5:37 UTC (Tue)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/920910/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Really, I can't see a reason why runc should agree to run any executable that's outside the container, even if it's a tricky /proc/ one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920910/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920928"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 10:25 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/920928/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Running the executable is not the problem. The problem is that it is possible to open the /proc/pid/exe file for writing from inside the container. <br>
<p>
Usually it is opt-in to have any files inside the container, as the filesystem namespace for the container is explicitly created. The problem is, that procfs includes the executables inside /proc/pid/exe, even if they should not be accessible from within the container. The solution is this prctl that hides the executables again. Not mounting /proc could be another solution. Unfortunately many programs rely on /proc being available.<br>
<p>
And the executable is not outside of the container. As soon as /proc is mounted, it is inside of the container, in much the same way as any executable that is accessible through bind mounts. The executable should be outside of the container, but without this new prctl there only was some ugly work-around to achieve this if /proc should be mounted.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920928/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921108"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 2:26 UTC (Wed)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/921108/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The executable IS outside the container. It is the executable of runc itself, on the host.<br>
<p>
That executable was effectively linked into the container when runc was commanded to launch itself, with /proc/self/exe effectively acting like a convoluted symlink. The runc outside was told to run /proc/self/exe which pointed to it's own executable (presumably in the host's /bin), and upon launching it, the /proc/self/exe of the runc instance inside the container continued to point to the same location, all the way back to the runc binary on the host.<br>
<p>
If runc will only launch executables that are already inside the container, no such reference can be brought inside.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921108/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921112"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 6:10 UTC (Wed)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/921112/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At the point where runc enters the container (specifically the PID namespace), the runc executable is inside the container (/proc/self/exe). This should never happen. Executing /proc/self/exe (directly or through a synlink) is just done to keep it available, as on exec(), proc/self/exe would be replaced again.<br>
<p>
And it is quite difficult to test whether someone is tricking you into executing /proc/self/exe. It is not just symlinks. Think of an executable starting with #!/proc/self/exe. The problem is that /proc/self/exe is there in the first place, not that runc can be tricked into executing it. This is just one exploit. There can be others.<br>
<p>
Also running docker exec would probably always have a race window, where runc is available inside the container. A malicious process inside the container can just wait for any docker exec to happen.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921112/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921263"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 22:00 UTC (Wed)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/921263/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; At the point where runc enters the container (specifically the PID namespace), the runc executable is inside the container (/proc/self/exe).</span><br>
<p>
Fair enough, but the vulnerable executable is only visible to runc.<br>
<p>
<span class="QuotedText">&gt; It is not just symlinks. Think of an executable starting with #!/proc/self/exe.</span><br>
<p>
Executing it in that way would almost certainly refer to the shell binary inside the container.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921263/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921264"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2023 22:37 UTC (Wed)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/921264/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;&gt; At the point where runc enters the container (specifically the PID namespace), the runc executable is inside the container (/proc/self/exe).</span><br>
<span class="QuotedText">&gt; Fair enough, but the vulnerable executable is only visible to runc.</span><br>
<p>
Yes, indeed. runc sets the non-dumpable attribute which should prevent other processes from playing with /proc/pid/exe. However, this gets reset when runc exec()s itself. Therefore the self-exec in the exploits.<br>
<p>
<span class="QuotedText">&gt;&gt; It is not just symlinks. Think of an executable starting with #!/proc/self/exe.</span><br>
<span class="QuotedText">&gt; Executing it in that way would almost certainly refer to the shell binary inside the container.</span><br>
<p>
As a container does not need to have a shell, runc executes commands directly. And if runc does exec() an executable with the shebang inside, then the proc entry refers to the runc binary.<br>
<p>
The key point is, all changes to runc to avoid being tricked into execing itself is just curating the symptoms. The underlying problem is the runc executable being part of the container. And this should just be avoided. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921264/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor921680"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_BENEATH</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2023 0:32 UTC (Tue)
                               by <b>vinipsmaker</b> (guest, #126735)
                              [<a href="/Articles/921680/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This other patchset should help to prevent such bogus path resolutions, but it hasn't made into mainline yet AFAIK: <a href="https://lwn.net/ml/linux-kernel/20190213030851.1881-1-cyphar@cyphar.com/">https://lwn.net/ml/linux-kernel/20190213030851.1881-1-cyp...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921680/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor920896"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 0:15 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/920896/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As written, couldn't this be trivially worked around by forking a process and accessing /proc/your-parent-pid/exe?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920896/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920898"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 0:38 UTC (Tue)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/920898/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
AFAICS the code is querying the flag from the target task, it's not specific to /proc/self.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920898/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920901"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 1:54 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/920901/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, so once you set the flag, /proc/yourpid/exe becomes unreadable? That sounds great, then.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920901/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 12:28 UTC (Tue)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/920941/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds terrible, exploits will use this prctl too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor921039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 15:31 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/921039/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exploits will use syscalls too. What's your point? Exploits have always had the same toolbox available as the "good guys". The difference is that the "good guys" play by the Rules. Sometimes the Rules have loopholes (usually bugs) or are blind to entire realms of possibility (spectre, meltdown, rowhammer) and new Rules need to be made.<br>
<p>
Obviously the solution is to not write/release exploitable software in the first place, but we (as a species) seem incapable of doing that. Or at least unwilling to pay the price it would take to do that (longer launch runways, better code review, etc.).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor920911"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 6:02 UTC (Tue)
                               by <b>rambolized</b> (guest, #160860)
                              [<a href="/Articles/920911/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Container runtimes like runC need to enter namespaces of containers to execute commands. Race conditions may exist between being opened by mal-processes and calling prctl(PR_HIDE_SELF_EXE).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920911/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920926"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 10:16 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/920926/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Where should there be a race condition? The container is only created after the call to prctl. And only after the container is configured, the processes within the container are spawned. Note, that the whole article is only about attacks from inside the container. If there is a privileged mal-process outside of the container all bets are off anyway. There is simply no need to access /proc/pid/exe if you can directly access the executable in the filesystem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920926/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor920943"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hiding a process's executable from itself</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2023 12:44 UTC (Tue)
                               by <b>rambolized</b> (guest, #160860)
                              [<a href="/Articles/920943/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe you are right. Actually I'm not clear how runC will utilize this feature, e.g., when dealing with requests like `docker exec`.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/920943/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor921672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Good interface</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2023 22:47 UTC (Mon)
                               by <b>vinipsmaker</b> (guest, #126735)
                              [<a href="/Articles/921672/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hope this patch gets merged.<br>
<p>
Lately I've been developing my own sandboxing solution making use of Linux namespaces (for those interested: &lt;<a href="https://emilua.gitlab.io/docs/api/0.4/tutorial/linux_namespaces.html">https://emilua.gitlab.io/docs/api/0.4/tutorial/linux_name...</a>&gt;). However the use case is not containers. The use case is compartmentalised application development. Long story short, one should be able to make use of Linux namespaces to spawn actors (Lua VMs in my project) inside isolated processes (the goal is to bring a model closer to Capsicum and actor systems to Linux).<br>
<p>
In this scenario, the cost of creating a new actor is cheap:<br>
<p>
1. fork()'ing a process that was created near main() with very few allocations and fds open.<br>
2. Initial setup for the new namespaces (e.g. mount() calls).<br>
<p>
Containers will usually will have extra steps (that I skip in my project):<br>
<p>
3. Mount an image for a whole Linux mini-distro.<br>
4. exec() into some binary.<br>
<p>
However the lack of an exec() call at the end means that I must be careful to not leak resources from the host as exec() is the only call that flushes the address space. /proc/self/exe is one of the things I must be careful about.<br>
<p>
The beauty about PR_SET_HIDE_SELF_EXE is that it'll protect not only containers that exec() at the end, but it can also be used in projects such as the one that I'm developing where no exec() call at the end ever happens. I really hope this patch gets merged.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/921672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2023, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
