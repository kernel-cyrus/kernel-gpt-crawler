        <!DOCTYPE html>
        <html lang="en">
        <head><title>The search for truly random numbers in the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/567055/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/566522/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/567055/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The search for truly random numbers in the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 18, 2013</br>
           </div>
The ongoing disclosures of governmental attempts to weaken communications
security have caused a great deal of concern.  Thus far, the evidence would
seem to suggest that the core principles behind cryptography remain sound,
and that properly encrypted communications can be secure.  But the
"properly encrypted" part is a place where many things can go wrong.  One
of those things is the generation of random numbers; without true
randomness (or, at least, unpredictability), encryption algorithms can be far
easier to break than their users might believe.  For this reason,
quite a bit of attention has been paid to the integrity of random number
generation mechanisms, including the random number generator (RNG) in the
kernel.
<p>
Random number generation in Linux seems to have been fairly well
thought out with no obvious mistakes.  But that does not mean that all is
perfect, or that improvements are not possible.  The kernel's random number
generator has been the subject of a few different conversations recently,
some of which will be summarized here.
<p>
<h4>Hardware random number generators</h4>
<p>
A program running on a computer is a deterministic state machine that
cannot, on its own, generate truly random numbers.  In the absence of a
source of randomness from the outside world, the kernel is reduced to the
use of a pseudo-random number generator (PRNG) algorithm that, in theory,
will produce numbers that could be guessed by an attacker.  In practice,
guessing the results of the kernel's PRNG will not be an easy task, but
those who concern themselves with these issues still believe that it
is better to incorporate outside entropy (randomness) whenever it is
possible.
<p>
One obvious source of such randomness would be a random number generator
built into the hardware.  By sampling quantum noise, such hardware could
create truly random data.  So it is not surprising that some processors
come with RNGs built in; the RDRAND instruction provided by some Intel
processors is one example.  The problem with hardware RNGs is that they
are almost entirely impossible to audit; should some country's spy agency
manage to compromise a hardware RNG, this tampering would be nearly
impossible to detect.  As a result, people who are concerned about
randomness tend to look at the output of hardware RNGs with a certain level
of distrust.
<p>
Some <a href="http://people.umass.edu/gbecker/BeckerChes13.pdf">recently
posted research [PDF]</a> can only reinforce that distrust.  The
researchers (Georg T. Becker, Francesco Regazzoni, Christof Paar, and Wayne
P. Burleson) have documented a way to corrupt a hardware RNG by changing the 
dopant polarity in just a few transistors on a chip.  The resulting numbers
still pass tests of randomness, and, more importantly, the hardware still
looks the 
same at almost every level, regardless of whether one looks at the masks
used or whether one looks at the chip directly with an electron microscope.
This type of hardware compromise is thus 
nearly impossible to detect; it is also relatively easy to carry out.  The
clear conclusion is that hostile hardware is a real possibility; the
corruption of a relatively simple and low-level component like an RNG is
especially so.  Thus, distrust of hardware RNGs would appear to be a
healthy tendency.
<p>
The kernel's use of data from hardware RNGs has been somewhat controversial
from the beginning, with some developers wanting to avoid such sources of
entropy altogether. The kernel's approach, though, is that using all
available sources of entropy is a good thing, as long as it is properly
done.  In the case of a hardware RNG, the random data is carefully mixed
into the buffer known as the "entropy pool" before being used to generate
kernel-level random numbers.  In theory, even if the data from the hardware
RNG is entirely hostile, it cannot cause the state of the entropy pool to
become known and, thus, it cannot cause the kernel's random numbers to be
predictable.
<p>
Given the importance of this mixing algorithm, it was a little surprising
to see, earlier this month, <a href="/Articles/567059/">a patch</a> that
would allow the user to request that the hardware RNG be used exclusively
by the kernel.  The argument for the patch was based on performance:
depending entirely on RDRAND is faster than running the kernel's full mixing
algorithm.  But the RNG is rarely a performance bottleneck in the kernel,
and the perceived risk of relying entirely on the hardware RNG was seen as
being far too high.  So the patch was not received warmly and had no real
chance of being merged; sometimes it is simply better not to tempt users to
compromise their security in the name of performance.
<p>
H. Peter Anvin raised <a href="/Articles/567064/">a related question</a>:
what about hardware RNGs found in other components, and, in particular, in
trusted platform module (TPM) chips?  Some TPMs may have true RNGs in them;
others are known to use a PRNG and, thus, are fully deterministic.  What
should the kernel's 
policy be with regard to these devices, which, for the most part, are
ignored currently?  The consensus seemed to be that no particular trust
should be put into TPM RNGs, but that using some data from the TPM to seed
the kernel's entropy pool at boot could be beneficial.  Many systems have
almost no entropy to offer at boot time, so even suspect random data from
the TPM would be helpful early in the system's lifetime.
<p>
<h4>Overestimated entropy</h4>
<p>
As noted above, the kernel attempts to pick up entropy from the outside
world whenever possible.  One source of entropy is the timing of device
interrupts; that random data is obtained by (among other things) reading
the time stamp counter (TSC) with a call to <tt>get_cycles()</tt> and using
the least significant bits.  In this way, each interrupt adds a little
entropy to the pool.  There is just one little problem, <a
href="/Articles/567070/">pointed out</a> by Stephan Mueller: on a number of
architectures, the TSC does not exist and <tt>get_cycles()</tt> returns
zero.  The amount of entropy found in a constant stream of zeroes is rather
less than one might wish for; the natural consequence is that the kernel's
entropy pool may contain less entropy than had been thought.
<p>
The most heavily used architectures do not suffer from this problem; on the
list of those that do, the most significant may be MIPS, which is used in a
wide range of home network routers and other embedded products.  As it
turned out, Ted Ts'o had already <a href="/Articles/567074/">been working
with the MIPS maintainers</a> to find a solution to this problem.  He
didn't like Stephan's proposed solution — reading a hardware clock if
<tt>get_cycles()</tt> is not available — due to the expense; hardware
clocks can take a surprisingly long time to read.  Instead, he is hoping
that each 
architecture can, somehow, provide some sort of rapidly increasing counter
that can be used to contribute entropy to the pool.  In the case of MIPS,
there is a small counter that is incremented each clock cycle; it doesn't
hold enough bits to work as a TSC, but it's sufficient for entropy
generation. 
<p>
In the end, a full solution to this issue will take a while, but, Ted <a
href="/Articles/567075/">said</a>, that is not necessarily a problem:
<p>
<div class="BigQuote">
	If we believed that /dev/random was actually returning numbers
	which are exploitable, because of this, I might agree with the "we
	must do SOMETHING" attitude.  But I don't believe this to be the
	case.  Also note that we're talking about embedded platforms, where
	upgrade cycles are measured in years --- if you're lucky.  There
	are probably home routers still stuck on 2.6 [...]
</div>
<p>
So, he said, it is better to take some time and solve the problem properly.
<p>
Meanwhile, Peter came to another conclusion about the entropy pool: when
the kernel writes to that pool, it doesn't account for the fact that it
will be overwriting some of the entropy that already exists there.  Thus,
he said, the kernel's estimate for the amount of entropy in the pool is
almost certainly too high.  He put together <a href="/Articles/567076/">a
patch set</a> to deal with this problem, but got little response.  Perhaps
that's because, as Ted <a href="/Articles/567077/">noted</a> in a different
conversation, estimating the amount of entropy in the pool is a hard
problem that cannot be solved without knowing a lot about where the
incoming entropy comes from.
<p>
The kernel tries to deal with this problem by being conservative in its
accounting for entropy.  Quite a few sources of unpredictable data are
mixed into the pool with no entropy credit at all.  So, with luck, the
kernel will have a vague handle on the amount of entropy in the pool, and
its mixing techniques and PRNG should help to make its random numbers
thoroughly 
unpredictable.  The end result should be that anybody wanting to attack the
communications security of Linux users will not see poor random numbers as
the easiest approach; in this world, one cannot do a whole lot better than
that.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Random_numbers">Random numbers</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Random_number_generation">Security/Random number generation</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Random_number_generation">Linux kernel/Random number generation</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Random_number_generation">Random number generation</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/567055/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor567358"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 3:55 UTC (Thu)
                               by <b>lsl</b> (subscriber, #86508)
                              [<a href="/Articles/567358/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; There are probably home routers still stuck on 2.6</font><br>
<p>
2.6? Optimistic. There are consumer routers sold today that ship with a 2.4 kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567358/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor567373"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 6:25 UTC (Thu)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/567373/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems the truly paranoid should solder their own hardware RNG. If I remember correctly, a basic RNG is not hard: wire a cheap transistor suitably and sample the resulting noisy signal. The last part is harder today. In the past, one could repurpose the printer port or an analogue joystick port for simple digitizing, but they have disappeared from current computers<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567373/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 17:13 UTC (Fri)
                               by <b>broonie</b> (subscriber, #7078)
                              [<a href="/Articles/567697/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A sound card is usually pretty straightforward to get - a USB one can be added if required.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567702"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 17:37 UTC (Fri)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/567702/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's not enough entropy (ie noise) in my server environment for audio-based entropy sources to work.  I found that surprising, but that's what audio-entropyd determined.<br>
<p>
I simply don't have any meaningful source of entropy available, which is why I'm resorting to hacking together some sort of USB-based RNG.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567702/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567727"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 20:33 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/567727/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I thought broonie's point was that you can use a sound processor to sample eru's transistor's output.

      
          <div class="CommentReplyButton">
            <form action="/Articles/567727/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567773"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 21, 2013 13:19 UTC (Sat)
                               by <b>broonie</b> (subscriber, #7078)
                              [<a href="/Articles/567773/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, just using it as an ADC.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567773/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor567424"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 11:54 UTC (Thu)
                               by <b>alankila</b> (guest, #47141)
                              [<a href="/Articles/567424/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linux's random source pool is IMHO distinguished by being miserably slow at accumulating random bits and ridiculously complex for what it does with difficult problems like entropy estimation. Why don't we just use some design such as Fortuna?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567424/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567441"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fortuna</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 14:04 UTC (Thu)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/567441/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seconded. One interesting feature of Fortuna is that it does not need any entropy estimation.<br>
<p>
Fortuna has two parts. The generator is simply AES (or another good block cipher) in counter mode, with the key being the state. When you request random bytes, it generates the requested bytes plus a new key (rotating the state).<br>
<p>
The accumulator has 32 pools. Incoming entropy is uniformly distributed between the pools. Each pool is used for seeding half as often as the previous pool, so the first pool is used every reseed, the second pool is used every other reseed, the third pool is used every four reseeds, and so on. A reseed is done every time the generator is called (before calling the generator), if the first pool has received more than a fixed number of bytes, and at most once every 0.1 second.<br>
<p>
With this design, at least one of the pools will have received enough entropy when it comes its turn to be used to reseed the generator. You do not have to know which one, so there is no need to estimate entropy. The state for the generator is the counter and the key, and the state for the accumulator is a rolling hash for each pool (which summarizes its contents) plus the size of the first pool and the last reseed time.<br>
<p>
For more information, see <a href="http://th.informatik.uni-mannheim.de/people/lucks/papers/Ferguson/Fortuna.pdf">http://th.informatik.uni-mannheim.de/people/lucks/papers/...</a> and <a href="https://en.wikipedia.org/wiki/Fortuna_%28PRNG%29">https://en.wikipedia.org/wiki/Fortuna_%28PRNG%29</a>.<br>
<p>
I believe the current Linux PRNG was originally derived from the one used by PGP, with modifications accumulating over time. Fortuna (and its predecessor Yarrow) is a more modern design.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567441/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567539"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fortuna</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 17:26 UTC (Thu)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/567539/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, Fortuna is designed to be a secure pseudo-random number generator. If that's what you want then /dev/urandom is fine. What we are talking is true random output, which you can't simply generate large amounts of without external input.<br>
<p>
We could just drop /dev/random altogether and symlink it to /dev/urandom. Which is what using Fortuna would amount to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567539/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567569"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fortuna</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 20:56 UTC (Thu)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/567569/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Well, Fortuna is designed to be a secure pseudo-random number generator. If that's what you want then /dev/urandom is fine. What we are talking is true random output, which you can't simply generate large amounts of without external input.</font><br>
<p>
Both /dev/random and /dev/urandom are secure pseudo-random number generators, and both are seeded with external entropy in the same way. The only difference between both is that /dev/random blocks if the entropy estimate is too low, while /dev/urandom does not.<br>
<p>
You could use Fortuna for /dev/random too, you would just need to add some sort of entropy estimator, to keep compatibility with userspace which expects it to block arbitrarily. Since most users (even cryptographic libraries) seem to use /dev/urandom, any problems with this entropy estimator would not affect them.<br>
<p>
And for users of /dev/random, you would gain the advantage that the quality of the random numbers would not be affected by bugs on the entropy estimator.<br>
<p>
Yes, an overestimation would that mean more numbers would be generated from the same amount of entropy. But Fortuna (and Yarrow) is designed so that, as long as the generator has more than a minimum amount of good quality entropy to start with (256 bits IIRC), and the state is not compromised, the output is secure even without reseeding (if the state can be compromised from the output, AES is broken and you have bigger problems). After the initial seeding, the reseeding is there only to recover if the generator state is compromised; see the presentation for more details.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567569/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor568170"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fortuna</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2013 21:29 UTC (Tue)
                               by <b>joern</b> (guest, #22392)
                              [<a href="/Articles/568170/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While in principle I like the fortuna design, I am wondering what problem you are trying to solve.  Both fortuna and the current linux design are prng, both use (or can use) real entropy to seed their pools and to stir them up once in a while.  Both should give random numbers that are impossible to predict, assuming the attacker can do almost anything except dump the entropy pool itself or control every bit of input to the pool.<br>
<p>
One of the two might have a more pleasing design.  But as long as both get the job done equally well, why would you want to do a replacement?  You can easily introduce subtle bugs and, without a strong upside, I would like to avoid that possibility.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/568170/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor567459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 15:04 UTC (Thu)
                               by <b>faramir</b> (subscriber, #2327)
                              [<a href="/Articles/567459/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If I can buy a 4Gbyte USB flash drive for &lt; $5, it should be possible to build a USB attachable source of truly random numbers for a reasonable amount of money.  All that needs to happen in the kernel is to define exactly how such a device talks to the kernel and a way for a system administrator to enable use of a specific device.  Then let the hardware guys do as many different implementations as the market will bear.<br>
<p>
Personally, I would be happy to contribute $20 to a kickstarter project that wrote the appropriate software for Linux; designed and built the hardware; and made both the software and hardware "open source".   For the paranoid, make it an option to just get an unpopulated circuit board so the recipient could source the rest of the off the shelf components from wherever they like.  Many people may not be able to design the requisite hardware, but almost anyone who cares could learn to solder well enough to put such a device together.<br>
<p>
Finally, given the existence of USB flash drives which<br>
<p>
1. Pretend to have a higher capacity then they actually do (in order to commit fraud on the purchaser)<br>
<p>
2. Pretend to be a USB keyboard/mouse for various nefarious purposes<br>
<p>
this would seem to be a simple project for someone with hardware design skills.  (Which is unfortunately not me.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567462"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 15:11 UTC (Thu)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/567462/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      It has <a href="http://www.entropykey.co.uk/">already been done</a>, and indeed has been mentioned in <a href="https://lwn.net/Articles/392735/">LWN comments</a> in the past.
      
          <div class="CommentReplyButton">
            <form action="/Articles/567462/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 16:36 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/567514/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I note that the entropy key's network entropy daemon actually relies on the kernel's entropy estimation: in particular, it relies on it so that it knows when not to bother sending in more entropy. This matters because extracting the entropy over USB is relatively CPU-expensive (it can eat a few percent of CPU time on slow machines), so it is best not to throw too much entropy into the pool unless people are using what you throw in. The key generates enough entropy to fill the pool in a couple of seconds, after all... and by the standards of modern entropy sources that is *slow*.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor567465"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 15:21 UTC (Thu)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/567465/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;it should be possible to build a USB attachable source of truly random numbers for a reasonable amount of money.</font><br>
<p>
There's an outfit out of the UK (www.entropykey.co.uk) that was selling such a widget for about $60, but they've hit some sort of unrelated financial problems and haven't been able to make/ship any for some time now.<br>
<p>
In the mean time, I'm actually working on a USB-attached RNG now, utilizing an STM32F4 MCU, which has a high-quality hardware RNG onboard. You can buy the eval boards for $15 in single-unit quantity (STM32F4DISCOVERY), so I don't think there's much of a point in trying to design a custom board since we won't be able to meet that price target without a large enough initial order.<br>
<p>
When I get it working (The USB stack is a bit of a PITA), I'll be releasing the firmware (and appropriate Linux code) under the GPL.  If there's enough interest in dedicated hardware, perhaps Kickstarter may be an option, hmm.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567465/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567470"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 15:46 UTC (Thu)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/567470/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But if commercial RNGs are not to be trusted, packaging it into a USB stick doesn't magically remove the stigma.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567470/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567545"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 17:52 UTC (Thu)
                               by <b>daney</b> (guest, #24551)
                              [<a href="/Articles/567545/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You may not trust a commercial RNG, but if the USB interface to said class of devices were standardized, you might have the option of easily switching RNG vendor.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567545/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor567546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The SOURCE for truly random numbers in the kernel is external hardware</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2013 18:06 UTC (Thu)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/567546/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My servers are perpetually entropy-starved simply by random web crawlers hitting its TLS-exposed services.  A full entropy pool is typically depleted within a few seconds, even under low-load situations.<br>
<p>
Meanwhile, I won't be using the RNG output of the STM32 directly; it will be mixed and mangled before being passed to the host -- and since Linux will mix it with its other entropy sources, it's considerably less likely to be a problem.<br>
<p>
Besides, let's be honest here, if you distrust commercial RNGs, wouldn't any random pre-packaged RNG design be equally suspect?  Just because the design/code is open source doesn't mean there's not a weakness in it that only the NSAs in the world are capable of recognizing.  And besides, even assuming noble intentions, designing a good RNG is *hard*; I'm actually more likely to introduce weaknesses (as opposed to improvements) with my meddling.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor567595"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 1:28 UTC (Fri)
                               by <b>gmaxwell</b> (guest, #30048)
                              [<a href="/Articles/567595/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh geesh, please don't reduce the estimates without increasing the size of the pool.<br>
<p>
On many systems the only thing that adds to the pool estimate anymore is the TSC ... at about 50 bits per second.  It's very easy to drain the cruddy 4kbit pool dry.  There is no good way to increase the size of the pool— you have to modify the kernel and that means moving off a distribution kernel image to something you have to maintain for yourself.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567595/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567708"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 19:01 UTC (Fri)
                               by <b>ikm</b> (guest, #493)
                              [<a href="/Articles/567708/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It's very easy to drain the cruddy 4kbit pool dry.</font><br>
<p>
Do you have a proof of that? Even simply XORing new entropy into the current seed would never make the seed less random, given that the sources of entropy don't have access to its current value. I actually doubt that it is possible to decrease entropy at all, even if it is certainly possible to not increase it (in the case where you mixing in zeroes, for example).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567708/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 19:10 UTC (Fri)
                               by <b>gmaxwell</b> (guest, #30048)
                              [<a href="/Articles/567713/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
::facepalm::<br>
<p>
The entropy estimator is a counter. It is incremented by a scarce few entropy sources in the kernel. Decremented on read from /dev/random. When it reaches zero /dev/random blocks. I am talking about the housekeeping, not quality of the CSPRNG.<br>
<p>
On a busy system (e.g. one with a lot of SSL activity) it is very easy to get mysteriously poor performance— things like SSH taking a long time to connect, as various random tasks block trying to read a few bytes from /dev/random.<br>
<p>
Here is a monitoring on a system which has this problem (but normally has a daemon running that keeps the pool full, you can see what happens when the daemon is down): <a href="http://mf4.xiph.org/munin/xiph.org/mf4.xiph.org/entropy-year.png">http://mf4.xiph.org/munin/xiph.org/mf4.xiph.org/entropy-y...</a>  (the graph claims 'bytes' but its really bits, and when its at zero, ssh connections and such start becoming visibly slow)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 19:32 UTC (Fri)
                               by <b>ikm</b> (guest, #493)
                              [<a href="/Articles/567717/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I see what you meant now. But do SSH/SSL sessions really use /dev/random and not /dev/urandom? Sounds like an overkill to me. Once /dev/urandom is properly seeded, I would expect the numbers it provided to be sufficiently random for session keys.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor567724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 20:00 UTC (Fri)
                               by <b>gmaxwell</b> (guest, #30048)
                              [<a href="/Articles/567724/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SSH does, at least on some systems. If this is advisable or not is another question.<br>
<p>
When long-term secrets are used for signing with DSA then whatever argument for /dev/random there was in the first place also really applies to the nonce generation— since weak nonces will leak the private key.<br>
<p>
To some extent there is pressure on developers to use the "more secure" thing so long as it exists. No one wants to be wearing the dunce cap for some massive security compromise.<br>
<p>
But it would be nice if there were enough space in the pool that it wasn't quite so much of a trap.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor567707"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for truly random numbers in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2013 18:22 UTC (Fri)
                               by <b>ikm</b> (guest, #493)
                              [<a href="/Articles/567707/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; on a number of architectures, the TSC does not exist and get_cycles() returns zero</font><br>
<p>
In this case, one small source of entropy which could be used is the caller's instruction pointer (i.e. the address where get_cycles() should return to). Since the order in which get_cycles() is called due to hardware interrupts is unpredictable in most cases, this would certainly be better than always feeding zeroes.<br>
<p>
Another option is mixing in the current top of stack pointer (be it the kernel or the userspace one), depending on the architecture implementation.<br>
<p>
While giving this any entropy credit would be wrong, the randomness it provides can be useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/567707/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
