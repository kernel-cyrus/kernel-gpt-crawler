        <!DOCTYPE html>
        <html lang="en">
        <head><title>Crash recovery for user-space block drivers [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/906097/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/906068/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/906097/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Crash recovery for user-space block drivers</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 29, 2022</br>
           </div>
A new <a href="/Articles/903855/">user-space block driver mechanism</a>
entered the kernel during the 6.0 merge window.  This subsystem, called
"ublk", uses <a href="/Articles/776703/">io_uring</a> to communicate with
user-space drivers, resulting in some impressive performance numbers.  Ublk
has a lot of interesting potential, but the current use cases for it are
not entirely clear.  The recently posted <a
href="/ml/linux-kernel/20220824054744.77812-1-ZiyangZhang@linux.alibaba.com/">crash-recovery
mechanism</a> for ublk makes it clear, though, that those use cases do
exist.
<p>
If an in-kernel block driver crashes, it is likely to bring down the entire
kernel with it.  Putting those drivers into user space can, theoretically,
result in a more robust system, since the kernel can now survive a driver
crash.  With ublk as found in the 6.0 kernel, though, a driver crash will
result in the associated devices disappearing and all outstanding I/O
requests failing.  From a user's point of view, this result may be nearly
indistinguishable from a complete crash of the system.  As patch author
Ziyang Zhang notes in the cover letter, some users might be disappointed by
this outcome:
<p>
<blockquote class="bq">
	This is not a good choice in practice because users do not expect
	aborted requests, I/O errors and a released device. They may want a
	recovery mechanism so that no requests are aborted and no I/O error
	occurs. Anyway, users just want everything works as usual.
</blockquote>
<p>
The goal of this patch set is to grant this wish.
<p>
A user-space block driver that implements crash recovery should set up its
ublk devices with the new <tt>UBLK_F_USER_RECOVERY</tt> flag.  There is
also an optional flag, <tt>UBLK_F_USER_RECOVERY_REISSUE</tt>, that controls
how recovery is done; more on that below.  After setup, no other changes
are needed for normal driver operation.
<p>
Should a recovery-capable ublk driver crash, the kernel will stop the
associated I/O request queues to prevent the addition of future requests,
then wait patiently for a new driver process to come along.  That wait can
be indefinite; if a driver claims to be able to do recovery, then the kernel
will expect it to live up to that claim.  There is no
notification mechanism for a driver crash; user space is required to notice on
its own that the driver has come to an untimely end and start a new one.
<p>
That new driver process will connect to the ublk subsystem and issue the
<tt>START_USER_RECOVERY</tt> command.  That causes ublk to verify that the
old driver is really gone and clean up after it, including dealing with all
of the outstanding I/O requests.  Any requests that showed up after the
crash and were not accepted by the old driver can simply be requeued to the
new one.  Requests that were accepted may have to be handled a bit more
carefully, though, since the kernel does not know if they were actually
executed or not.
<p>
There are, evidently, some ublk back-ends that cannot properly deal with
duplicated writes; such writes must be avoided in that case.  That is what
the <tt>UBLK_F_USER_RECOVERY_REISSUE</tt> flag is for; if it is present,
all outstanding requests will be reissued.  Otherwise, requests that had
been picked up by the driver, but for which no completion status had been
posted, will fail with an error status.  This will happen even with read
requests, which one would normally expect to be harmless if repeated.
<p>
After starting the recovery process, the new driver should reconnect to
each device and issue a new <tt>FETCH_REQ</tt> command on each to enable
the flow of I/O requests.  Once all of the devices have been set up, an
<tt>END_USER_RECOVERY</tt> command will restart the request queue and get
everything moving again.  With luck, users may not even notice that the
block driver crashed and was replaced.
<p>
The ublk subsystem came out of Red Hat and only includes a
simple file-backed driver, essentially replicating the loop driver, as an
example.  At the time, various use cases for this subsystem were mentioned
in a vague way,
but it was not clear how (or if) it is being used outside of a
demonstration mode.  It looks a bit like an interesting solution waiting
for a problem.
<p>
The appearance of this recovery mechanism from a different company (Alibaba), just a
few weeks after ublk was merged, suggests that more advanced use cases
exist, and that ublk is, indeed, already in active use.  This sort of
recovery mechanism tends not to be developed in the absence of some hard
experience indicating that it is necessary.  Hopefully some of these
real-world use cases will come to light — with code — so that the rest of
the world can benefit from this work.
<p>
Just as usefully, this information might give some clues about where Linux
is headed in the coming years.  The effort to blur the boundaries between
kernel tasks and those handled in user space shows no signs of slowing
down; it would not be surprising to see more ublk-like mechanisms in the
future.  It would be interesting indeed to have an idea of where these
changes are taking us — and to be shown that it isn't a world where
development moves to proprietary, user-space drivers.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer-Block_drivers">Block layer/Block drivers</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#io_uring">io_uring</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/906097/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor906388"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2022 16:27 UTC (Mon)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/906388/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If someone wants to post a driver where a significant backend lives in userspace, then there should be a requirement that an open source userspace backend be provided that exercises all of the interfaces. This has been the standard for DRM drivers, but it should be equally true for a userspace filesystem driver or anything else.<br>
<p>
GPU drivers are a bit weird, since mesa is a library and programs call into it directly instead of going down through the kernel and up into the userspace portion of the driver, and this systems seems like a place where an even stronger argument could be made. The userspace driver is needed to make the driver interface of the kernel itself work, and therefor definitely an open source reference implementation should be provided.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906388/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906389"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2022 17:02 UTC (Mon)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/906389/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the main direction this is likely to go is block devices where the actual storage is accessed over a network (using standard network-related syscalls) or USB (using libusb). So there wouldn&#x27;t be anything in the kernel specific to a device for someone to post and have requirements placed on them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906389/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor906414"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 4:20 UTC (Tue)
                               by <b>riking</b> (subscriber, #95706)
                              [<a href="/Articles/906414/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree, we need more experimentation on higher-redundancy storage (better than RAID6) as well, and that&#x27;s likely to involve placing disks across multiple kernels.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906414/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906415"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 4:21 UTC (Tue)
                               by <b>riking</b> (subscriber, #95706)
                              [<a href="/Articles/906415/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whoops - this was supposed to be a reply to the person saying &quot;where the actual storage is accessed over a network&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906415/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor906430"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 10:05 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/906430/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve been thinking about raid-16, raid-61, splattered across a network, but that brings in a whole &#x27;nother can of worms ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906430/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor906390"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2022 16:43 UTC (Mon)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/906390/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would expect this to show up in SPDK quite quickly.  And be used for complex network block device setups, possibly including ones over &quot;future transports&quot; like CXL and proprietary variants.<br>
<p>
Actually, could you expose a PostgreSQL table as a &quot;block device&quot; over this?  That&#x27;d be cute although likely silly.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906390/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor906400"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux microkernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2022 20:08 UTC (Mon)
                               by <b>storner</b> (subscriber, #119)
                              [<a href="/Articles/906400/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The first Linux development was announced 31 years ago. And one reason for starting it was that Linus didn&#x27;t like MINIX - among other things due to its microkernel architecture performance issues.<br>
<p>
I don&#x27;t want to reignite that discussion, but it feels like Linux is becoming more and more supportive of a hybrid monolithic/micro kernel design where features are implemented in userspace, with only a minimum of hooks into the &quot;core&quot; kernel to get a reasonable performance.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906400/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906411"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux microkernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 0:32 UTC (Tue)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/906411/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There&#x27;s a lot more to the performance issues of minix and mach than just being microkernels. This came up during oxide&#x27;s twitter space over their own microkernel OS [1] and the references are in the shownotes [2], but I think it was the creator of L4 who came out and said &quot;yeah, IPC is slow...if you do it wrong!&quot; Certainly as iouring and various shared memory approaches demonstrate, the IPC can indeed be quite fast.<br>
<p>
[1] <a href="https://www.youtube.com/watch?v=cypmufnPfLw">https://www.youtube.com/watch?v=cypmufnPfLw</a> around 37:20 according to the shownotes<br>
[2] <a href="https://github.com/oxidecomputer/twitter-spaces/blob/master/2021_12_13.md">https://github.com/oxidecomputer/twitter-spaces/blob/mast...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906411/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor906410"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux microkernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 0:45 UTC (Tue)
                               by <b>dvdeug</b> (guest, #10998)
                              [<a href="/Articles/906410/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The core is still clearly monolithic. It&#x27;s very convenient to run things in userspace, and many things can be run perfectly well in userspace; I suspect the difference between reading a filesystem on CD in userspace versus kernel space is nonexistent timewise and usually unnoticable added pressure to the CPU and memory system. Like many modern systems, there&#x27;s enough power to let people do things the easy, flexible way or the maximally efficient way if they need that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906410/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux microkernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 5:50 UTC (Tue)
                               by <b>zev</b> (subscriber, #88455)
                              [<a href="/Articles/906417/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>there's enough power to let people do things the easy, flexible way or the maximally efficient way if they need that.</blockquote>

Agreed -- I think the general trend is clearly toward increasing flexibility and having the <i>option</i> (for a growing set of things) of either an in-kernel implementation or a userspace one.  Though for whatever reason, it seems like whenever a new userspace option pops up the "will Linux become a microkernel?" comments inevitably appear, whereas I can't recall ever seeing the inverse when Linux grows things like (to pick some recent examples) in-kernel TLS support or KSMBD.




      
          <div class="CommentReplyButton">
            <form action="/Articles/906417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906431"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux microkernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 10:09 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/906431/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Anyways, micro-kernel DESIGN brings a lot of advantages. It reduces coupling making maintenance easier for example.<br>
<p>
But monolithic IMPLEMENTATION brings a lot of advantages too, not least speed.<br>
<p>
That&#x27;s why Linux has always been a modular system. <br>
<p>
Whatever floats your boat, and if pushing stuff into user space brings advantages (which it clearly does in many cases, not least security), go for it!<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906431/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor906435"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 11:08 UTC (Tue)
                               by <b>bbockelm</b> (subscriber, #71069)
                              [<a href="/Articles/906435/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As for the application, this work looks fairly similar to this USENIX paper from an Alibaba team:<br>
<p>
<a href="https://www.usenix.org/system/files/atc20-li-huiba.pdf">https://www.usenix.org/system/files/atc20-li-huiba.pdf</a><br>
<p>
The above paper describes a virtual block device, implemented in user space, and including crash recovery.  The overall application is to deliver block-based container images to their platform.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906435/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906437"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 11:55 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/906437/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As the same Alibaba team member, I can tell it&#x27;s not used for this scenario but for distributed block device.<br>
Instead, for container image scenarios, we will try to write a new paper based on the filesystem approach, hopefully later published.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906437/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor906438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 12:07 UTC (Tue)
                               by <b>bbockelm</b> (subscriber, #71069)
                              [<a href="/Articles/906438/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the update!  For what it&#x27;s worth, the existing paper was quite fun to read...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor906440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 12:29 UTC (Tue)
                               by <b>old-memories</b> (guest, #160155)
                              [<a href="/Articles/906440/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi. I am Ziyang Zhang.  This patchset has nothing to do with DADI. I developed it by myself.<br>
<p>
By the way, ublk is not for container images. It is a generic userspace block driver. Please read related articles published before more patiently, really.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor906498"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2022 18:51 UTC (Tue)
                               by <b>lperkov</b> (guest, #136950)
                              [<a href="/Articles/906498/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The Sartura team is working on the ublk user-space components in rust. As soon as the prototype is ready, the code will be open source. We would be happy to collaborate if there is an interest. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/906498/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor906738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">NBD driver</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 1, 2022 11:17 UTC (Thu)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/906738/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <a href="https://gitlab.com/rwmjones/libnbd/-/commits/nbdublk/">nbdublk</a> uses this to reimplement nbd.ko in userspace.  There's a very long thread on our experience: <a href="https://listman.redhat.com/archives/libguestfs/2022-August/thread.html#29655">here</a> and continued <a href="https://listman.redhat.com/archives/libguestfs/2022-September/thread.html#29734">here</a>.




      
          <div class="CommentReplyButton">
            <form action="/Articles/906738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor907031"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Had another demo driver for S3</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2022 2:12 UTC (Sat)
                               by <b>dacut</b> (subscriber, #131937)
                              [<a href="/Articles/907031/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I had a similar driver (written for the 3.x kernels; I doubt it compiles any longer): <a href="https://github.com/dacut/ubd">https://github.com/dacut/ubd</a>. The demo backend talked to S3.<br>
<p>
This was before AWS had their NFS solution (Elastic File System/EFS) and EBS volumes were limited in size to 1 TB, so I demoed an absurd idea of a tiny host (t2.micro) with a 1 PB XFS-formatted UBD volume attached. Blocks are sparsely allocated, so only the superblocks were written to S3. Still, this took overnight just to format the filesystem.<br>
<p>
It was a fun demo to write over a few weekends, but so slow as to be completely unpractical.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907031/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor907071"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Had another demo driver for S3</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2022 15:54 UTC (Sat)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/907071/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t think it&#x27;s possible to write an efficient S3 driver to store an ordinary (eg. ext4) filesystem without a very large amount of local caching.  The natural block size for S3 is very large (128K?) but if you try to create a naive filesystem with that block size it most likely won&#x27;t work at all and if it did will break assumptions about small blocks that filesystem developers make.<br>
<p>
Anyway, here&#x27;s our attempt: <a href="https://libguestfs.org/nbdkit-S3-plugin.1.html">https://libguestfs.org/nbdkit-S3-plugin.1.html</a>  It&#x27;s written in Python and apparently used somewhat widely (judging by bug reports etc).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907071/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor907137"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Had another demo driver for S3</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 5, 2022 2:08 UTC (Mon)
                               by <b>dacut</b> (subscriber, #131937)
                              [<a href="/Articles/907137/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yep, that sounds about right! I think I told xfs to use 4096 byte blocks. Still slow as molasses.<br>
<p>
Glad that your engineered solution (vs. my toy weekend project) is getting usage!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907137/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor907145"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Had another demo driver for S3</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 5, 2022 8:23 UTC (Mon)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/907145/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You may be interested in &lt;a href=&quot;<a href="https://www.youtube.com/watch?v=JcJSW7Rprio">https://www.youtube.com/watch?v=JcJSW7Rprio</a>&quot;&gt;harder drives&lt;/a&gt;, in which the author implements some unusual filesystems: one which stores data in the padding of in-flight IMCP pings; one which encodes the data within the game state of parallel emulated Tetris games; and one which is comprised of used COVID-19 test cartridges...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907145/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor907358"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Harder drives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2022 3:17 UTC (Wed)
                               by <b>dacut</b> (subscriber, #131937)
                              [<a href="/Articles/907358/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, that was a right excellent demo of completely useless technology. I loved every minute of it!<br>
<p>
Thank you!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907358/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor907677"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Had another demo driver for S3</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2022 14:57 UTC (Sat)
                               by <b>ming.lei</b> (subscriber, #74703)
                              [<a href="/Articles/907677/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
BUSE[1] implemented S3 block device too, and it is one master thesis in 2021.<br>
<p>
<a href="https://dspace.cuni.cz/bitstream/handle/20.500.11956/148791/120397658.pdf">https://dspace.cuni.cz/bitstream/handle/20.500.11956/1487...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907677/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor907210"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 5, 2022 15:27 UTC (Mon)
                               by <b>pturmel</b> (guest, #95781)
                              [<a href="/Articles/907210/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m looking forward to more of this, largely because I recently had my antipathy to userspace drivers busted rather convincingly by OpenVSwitch.<br>
<p>
I often set up custom bridge-vlan-VM network environments for my laboratory of industrial hardware (mostly Allen-Bradley and Omron products).  Until recently, it was done with native Linux bridges and native Linux vlans.<br>
<p>
Then I discovered that KVM can tap into an OpenVSwitch bridge with a specified vlan tag.  Greatly simplified the rats&#x27; nest of configurations I&#x27;ve been switching around for various simulations.<br>
<p>
But some sibling VMs on the same infrastructure had their network performance noticeably improve.  I didn&#x27;t think to benchmark it all, but I&#x27;m very happy with the results.<br>
<p>
Bring on more userspace drivers, thank you.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907210/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor907289"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2022 12:34 UTC (Tue)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/907289/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How do you actually go about configuring OpenVSwitch? I&#x27;ve used it via a number of other products, which configure it for me. It&#x27;s worked absolutely fine but I have no idea where to begin if I wanted to configure it from scratch myself...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907289/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor907292"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2022 12:53 UTC (Tue)
                               by <b>pturmel</b> (guest, #95781)
                              [<a href="/Articles/907292/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve been using netplan.io in Ubuntu Server.  Unified config with my non-OpenVSwitch items.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907292/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor907467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 8, 2022 10:40 UTC (Thu)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/907467/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks. I see NM can also configure it. I&#x27;ll check these out!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor907675"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Crash recovery for user-space block drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2022 14:51 UTC (Sat)
                               by <b>ming.lei</b> (subscriber, #74703)
                              [<a href="/Articles/907675/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It looks a bit like an interesting solution waiting for a problem.</font><br>
<p>
AFAIK, the above seems not true.<br>
<p>
IMO, there are lots of jobs which can be done by ublk, such as some generic things:<br>
<p>
- re-implement nbd-client with ublk and io_uring, especially applying recent io_uring/net zero copy feature<br>
- ublk export for qemu-storage-daemon<br>
- SPDK backend for UBD mod<br>
- ceph&#x27;s rbd<br>
- ublk based zoned target<br>
- ublk base compression target<br>
...<br>
<p>
Some of them have been in-progress.  Userspace development is easier and more efficient, but still takes<br>
a while, especially just 4 months past since the first version of ublk driver(RFC) is posted.<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/907675/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
