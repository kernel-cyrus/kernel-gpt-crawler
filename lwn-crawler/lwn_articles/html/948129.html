        <!DOCTYPE html>
        <html lang="en">
        <head><title>mseal() and what comes after [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/948129/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/948211/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/948129/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>mseal() and what comes after</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>October 20, 2023</br>
           </div>
Jeff Xu recently <a
href="/ml/linux-kernel/20231016143828.647848-1-jeffxu@chromium.org/">proposed</a>
the addition of a new system call, named <tt>mseal()</tt>, that would allow
applications to prevent modifications to selected memory mappings.  It
would enable the hardening of user-space applications against certain types
of attacks; some other operating systems have this type of feature already.
There is support for adding this type of mechanism to the Linux kernel as
well, but it has become clear that <tt>mseal()</tt> will not land in the
mainline in anything resembling its current form.  Instead, it has become
an example of how <i>not</i> to do kernel development at a number of levels.
<p>
Xu described the new system call's purpose as:
<p>
<blockquote class="bq">
	Memory sealing additionally protects the mapping itself against
	modifications. This is useful to mitigate memory corruption issues
	where a corrupted pointer is passed to a memory management
	syscall. For example, such an attacker primitive can break
	control-flow integrity guarantees since read-only memory that is
	supposed to be trusted can become writable or .text pages can get
	remapped.
</blockquote>
<p>
The target user for this functionality is the Chrome browser which, among
other things, includes a just-in-time (JIT) compilation engine for
JavaScript code.  Since it generates executable code on the fly, JIT
compilation must be done with care, lest it create (and run) the wrong kind
of code.  As described in <a
href="https://v8.dev/blog/control-flow-integrity">this blog post</a> by
Stephen RÃ¶ttger, a lot of effort has gone into control-flow integrity and
preventing the JIT system from becoming a tool for an attacker.  If,
however, an attacker is able to somehow force a memory-management system
call that changes memory permissions, all bets are off.  Thus, the Chrome
developers would like to have a mechanism that puts those system calls
off-limits for specific regions of memory, hardening the browser against
that sort of attack.
<p>
The cover letter notes that <tt>mseal()</tt> is similar to <a
href="/Articles/915640/"><tt>mimmutable()</tt></a>, which was
added recently to OpenBSD.  The prototype for the proposed system call is
quite different from <tt>mimmutable()</tt>, though:
<p>
<pre>
    int mseal(void *addr, size_t len, unsigned int types, unsigned int flags);
</pre>
<p>
The range of memory to be affected is indicated by <tt>addr</tt> and
<tt>len</tt>.  The <tt>flags</tt> must be passed as zero, and
<tt>types</tt> controls which system calls will be blocked on that address
range:
<p>
<ul>
<li> <tt>MM_SEAL_MPROTECT</tt>: <a
     href="https://man7.org/linux/man-pages/man2/mprotect.2.html"><tt>mprotect()</tt>
     and <tt>pkey_mprotect()</tt></a>
<li> <tt>MM_SEAL_MMAP</tt>: <a
     href="https://man7.org/linux/man-pages/man2/mmap.2.html"><tt>mmap()</tt></a>
<li> <tt>MM_SEAL_MUNMAP</tt>: <tt>munmap()</tt>
<li> <tt>MM_SEAL_MREMAP</tt>: <a
     href="https://man7.org/linux/man-pages/man2/mremap.2.html"><tt>mremap()</tt></a>
<li> <tt>MM_SEAL_MSEAL</tt>: future <tt>mseal()</tt> calls
</ul>
<p>
Linus Torvalds was quick to <a
href="/ml/linux-kernel/CAHk-=whFZoap+DBTYvJx6ohqPwn11Puzh7q4huFWDX9vBwXHgg@mail.gmail.com/">object</a>
to the patch series, saying: "<q>I have no objections to adding some kind
of 'lock down memory mappings' model, but this isn't it</q>".  He had a
number of complaints about the details of the implementation, but he later
<a
href="/ml/linux-kernel/CAHk-=wj87GMTH=5901ob=SjQqegAm2JYBE7E4J7skJzE64U-wQ@mail.gmail.com/">made
it clear</a> the design of the system call was wrong.  Blocking
<tt>munmap()</tt>, for example, makes little sense if other operations that
can result in the unmapping of addresses (<tt>mmap()</tt> and
<tt>mremap()</tt>, for example), are still allowed.  The effort that was
put into only blocking operations from specific system calls, he <a
href="/ml/linux-kernel/CAHk-=wixGw88-OzcFbCLEuAzSe53oUUozdM-E_RJwvejgY6ySA@mail.gmail.com/">said</a>,
was overtly wrong; if unmapping a range of memory (for example) is blocked,
it must be blocked from all directions or the protection provided will be
illusory.
<p>
Matthew Wilcox <a
href="/ml/linux-kernel/ZS1URCBgwGGj9JtM@casper.infradead.org/">questioned</a>
the complexity of the interface, suggesting instead that a couple of flags
added to <tt>mprotect()</tt> would suffice.  A memory region, he said,
should either be immutable (with the possible option of further reducing
access) or not, without regard to which system call was used.  He later added:
<p>
<blockquote class="bq">
	 This is the seccomp disease, only worse because you're trying to
	 deny individual syscalls instead of building up a list of
	 permitted syscalls.  If we introduce a new syscall tomorrow which
	 can affect VMAs, we'll then make it the application's fault for
	 not disabling that new syscall.  That's terrible design!
</blockquote>
<p>
The conversation even brought about a rare appearance on linux-kernel by
OpenBSD maintainer Theo de Raadt, who <a
href="/ml/linux-kernel/55960.1697566804@cvs.openbsd.org/">agreed with
Torvalds</a> and suggested that Linux should simply add
<tt>mimmutable()</tt> rather than reinventing that functionality in a more
complex form.  Torvalds <a
href="/ml/linux-kernel/CAHk-=wjS=xg12RVQdTNxEurjo21eXQBQO0D5My6Aox4LCfsO1A@mail.gmail.com/">was
amenable</a> to this idea, though he suggested adding a <tt>flags</tt>
argument for future changes â an idea that de Raadt <a
href="/ml/linux-kernel/19404.1697568901@cvs.openbsd.org/">disliked</a>.
That reflects the fact that OpenBSD controls its user space, so it can add
a <tt>flags</tt> parameter later if the need arises; Linux has no such
luxury, so that parameter must be present from the beginning if it is to
exist at all.
<P>
Xu, instead, <a
href="/ml/linux-kernel/CALmYWFs81T=XnT=AXQTo0+9FXo=OBAV_4rrYPSn9-16O-gBTZg@mail.gmail.com/">resisted</a>
the idea, prompting a typical (if relatively mild) <a
href="/ml/linux-kernel/95482.1697587015@cvs.openbsd.org/">de Raadt
response</a>.  Indeed, Xu continued to cling to his proposed design despite
the comments he had received, leading to a somewhat exasperated <a
href="/ml/linux-kernel/ZS%2F3GCKvNn5qzhC4@casper.infradead.org/">post</a>
from Wilcox, who tried to direct the conversation toward what the patch
series is actually trying to accomplish:
<p>
<blockquote class="bq">
	Let's start with the purpose.  The point of
	mimmutable/mseal/whatever is to fix the mapping of an address range
	to its underlying object, be it a particular file mapping or
	anonymous memory.  After the call succeeds, it must not be possible
	to make any address in that virtual range point into any other
	object.
<p>
	The secondary purpose is to lock down permissions on that range.
	Possibly to fix them where they are, possibly to allow RW-&gt;RO
	transitions.
<p>
	With those purposes in mind, you should be able to deduce for any
	syscall or any madvise(), ... whether it should be allowed.
</blockquote>
<p>
Xu, Wilcox concluded, needed do a better job of listening to the developers
who were trying to help him.
<p>
At this point, it is clear that <tt>mseal()</tt> will not enter the kernel
in anything like its current form.  That leads to the question of what
should be done instead. RÃ¶ttger <a
href="/ml/linux-kernel/CAEAAPHYgg49WtpE7Jdq6HDecFp5RHPhdxtPTUaNF12RONu5aDA@mail.gmail.com/">jumped
into the conversation</a> to point out that a pure <tt>mimmutable()</tt>
solution does not do everything that the Chrome developers would like to
see; they have cases where they want to prevent unmapping, but still need
to be able to change memory protections with <tt>mprotect()</tt>.
De Raadt <a
href="/ml/linux-kernel/20251.1697817328@cvs.openbsd.org/">described</a>
that case as "<q>partial sealing</q>" that means that the memory in
question is not actually protected.
<p>
There will presumably be some sort of follow-up proposal that maintains
that capability while removing the more complex options provided by
<tt>mseal()</tt>.  But whether that proposal will be <tt>mimmutable()</tt>
or some variant thereof remains to be seen.

<p>
One can point to a number of things that went wrong here.  The original
proposal was seen by many as an implementation of what the Chrome
developers said they wanted without looking deeply at what the real
requirements (for Chrome and any other potential users) are.  Google has no
shortage of experienced developers who could have reviewed this submission
before it was posted publicly, but that does not appear to have happened,
with the result that a relatively inexperienced developer was put into a
difficult position.  Feedback on the proposal was resisted rather than
listened to.  The result was an interaction that pleased nobody.
<p>
Despite all of that, there is a use case here that everybody involved
appears to see as legitimate.  So it is just a matter of finding the right
solution to the problem, and hopefully that problem is better understood
now.  If the next attempt looks a lot more like <tt>mimmutable()</tt> and
reflects the feedback that has been given, the kernel may yet get the
sealing capability that addresses the Chrome use case and provides for
wider user-space hardening as well.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security">Security</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls">System calls</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/948129/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor948398"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2023 16:41 UTC (Fri)
                               by <b>vbabka</b> (subscriber, #91706)
                              [<a href="/Articles/948398/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Tried to summarize the discussion yesterday on fediverse so here you go <a href="https://social.kernel.org/notice/Aavc5m4AfQZyNO2sTI">https://social.kernel.org/notice/Aavc5m4AfQZyNO2sTI</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948398/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor948404"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2023 19:48 UTC (Fri)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/948404/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The mention of glibc setting executable stack during dlopen() was a surprise to me. I'd vaguely heard of GNUSTACK as a historical kerfuffle that I thought had been taken care of.<br>
<p>
Is there background one might want to read on why this behavior hasn't been able to be put to rest yet?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948404/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948446"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 12:24 UTC (Sun)
                               by <b>dvdeug</b> (guest, #10998)
                              [<a href="/Articles/948446/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can't find a great source for it from my cell phone, but GNAT (the Ada compiler) still uses an executable stack for nested function pointers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948446/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor948884"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2023 7:02 UTC (Thu)
                               by <b>koomi</b> (subscriber, #165546)
                              [<a href="/Articles/948884/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That wormhole to the stone age has been put to great use in the recent ssh-agent forwarding exploit.<br>
<p>
I guess it would break too much stuff to disable it entirely, but maybe there are some knobs to twiddle?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948884/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor948416"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2023 22:00 UTC (Fri)
                               by <b>rywang014</b> (subscriber, #167182)
                              [<a href="/Articles/948416/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
so an extra flag in mprotect() can do all the work right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948416/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948419"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2023 3:29 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/948419/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes. That's essentially what mimmutable() syscall is. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948419/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor948427"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2023 14:02 UTC (Sat)
                               by <b>mtodorov</b> (subscriber, #158788)
                              [<a href="/Articles/948427/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just curious, do you think that the mseal() or immutable() syscall would break libc live patching by TuxCare?<br>
<p>
Thanks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948427/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948428"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2023 14:07 UTC (Sat)
                               by <b>mtodorov</b> (subscriber, #158788)
                              [<a href="/Articles/948428/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To correct myself, this is obviously mseal() and mimmutable() breaking live libc patching by TuxCare.<br>
<p>
But while trying to fix the typo, the spellchecker tried to be smarter than me again and automatically changed mimmutable() to immutable() :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948428/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor948430"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2023 16:31 UTC (Sat)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/948430/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That depends how it works. If it works by patching individual running processes eg with ptrace(POKETEXT), then it will be denied. If it patches the on-disk binary then there's a chance it'll work. It probably does the former.<br>
<p>
Possibly more relevant to people is that mimmutable() will prevent inserting breakpoints. I believe OpenBSD copes with this by disabling mimmutable() when running under a debugger.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948430/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 7:38 UTC (Sun)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/948440/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It will break uprobes too.<br>
<p>
In rr we'll be able to work around any mimmutable-style API by emulating it --- intercept the mimmutable calls, don't send them to the kernel, and apply the semantics ourselves when the application makes mmap/munmap/etc calls. This would actually be better than "disabling mimmutable() when running under a debugger" because you might want to debug bugs involving use of mimmutable()...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor948442"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 8:10 UTC (Sun)
                               by <b>mtodorov</b> (subscriber, #158788)
                              [<a href="/Articles/948442/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>It seems kind of awkward that the unmapped pages in the range <strong>mimmutable(addr, len)</strong> are left in a state one can account for (essentially undefined) by the OpenBSD - that effectively makes them lost for the process
(an especially tough issue for daemons that are supposed to run for months or years w/o a restart).</p>
<p>I am not an expert on this, but it seems prudent to be able to replace an in-memory copy of glibc with a patched, signed version on-the-fly. I don't know how the TuxCare guys do it in their KernelCare+ libpatch service we're testing because the technology is state-of-the-art and proprietary.</p>
<p>I can't really see what patching on-disk binary semantics would be? What is supposed to happen with the mimmutable() protected page when the page in the underlying mapped library changes on-disk?</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/948442/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948450"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 14:50 UTC (Sun)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/948450/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
mimmutable would only prevent changes to the memory region configuration, it doesn't (by itself) make the memory region read-only.<br>
<p>
So LongRunningDaemon could have library.so mmapped RO, and FancyPatcherTool could map library.so RW, and modifications made by FancyPatcherTool would show up in LongRunningDaemon's mmap, it just couldn't make such modifications itself. There's exceptions, here be dragons, etc, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948450/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor948453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 16:15 UTC (Sun)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/948453/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ideally, daemons would not run for years without a restart. They would respond to SIGHUP by serializing their state to storage and exec() themselves, picking up new libraries automatically. Ensuring that the new daemon actually starts correctly is left as an exercise to the programmer. (What do you mean, somebody edited the config file three months ago, introducing a syntax error, and didn't run the checker first?!)<br>
<p>
mimmutable() simply makes this address range mapping to the object unchangeable. It does nothing to prevent the object underneath unchangeable. That's left to other mechanisms (eg libfoo.so should have r-x file permissions!)<br>
<p>
So a sufficiently privileged process (like, say, a binary patching program) can modify the contents of both the file and the page cache. mimmutable is simply a piece of the puzzle, it isn't everything.<br>
<p>
Of course, this relies on the process having not COWed the page cache. If it had mapped the file MAP_PRIVATE and stored to it, it would have its own copy of the previous contents of that page, plus its own modifications, and changes to the underlying file would not be reflected in its address space. This is quite unlikely with ELF (unless you insert a uprobe or breakpoint), but IIRC it was fairly common with a.out (and was a motivation for switching to ELF)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor949791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2023 13:44 UTC (Thu)
                               by <b>sammythesnake</b> (guest, #17693)
                              [<a href="/Articles/949791/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the COW mechanism isn't reciprocal* then you could end up with some *really* nasty behaviour if a process has made changes to one page that are incompatible with something the patching changed in another page - every obscure bug you can think of is possible in that scenario...<br>
<p>
* I.e. of the changes made by the patching program to pages the COW mapped program didn't change are seen by that program, but pages changed via COW remain in place without being overwritten by the patcher's version - does creating a COW mapping imply all other mappings are thereby made COW, too? If the COW-ness *is* reciprocal, then of course that means that any patching is invisible/ineffective for any memory that's been COW mapped, which doesn't seem optimal, either...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/949791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor948445"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 11:56 UTC (Sun)
                               by <b>summentier</b> (subscriber, #100638)
                              [<a href="/Articles/948445/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm intrigued by Theo de Raadt's offhand comment from his cited email:<br>
<p>
<span class="QuotedText">&gt; I am pretty sure Linux will never get as far as we got. Even our main stacks are marked immutable, but in Linux that would conflict with glibc ld.so mprotecting RWX the stack if you dlopen() a shared library with GNUSTACK, a very bad idea which needs a different fight...</span><br>
<p>
I am afraid I don't know enough about memory management to understand this point. Does anybody care to elaborate? Is it really a fundamental (architectural) flaw in Linux?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948445/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2023 12:52 UTC (Sun)
                               by <b>randomguy3</b> (subscriber, #71063)
                              [<a href="/Articles/948447/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://wiki.gentoo.org/wiki/Hardened/GNU_stack_quickstart">https://wiki.gentoo.org/wiki/Hardened/GNU_stack_quickstart</a> has some info about GNU_STACK - it's an ELF header that indicates whether the code in the file requires the stack to executable (eg: the compiler might make use of an executable stack to implement nested functions). This presumably allows the loader to decide whether to set the no-execute bit on the stack when an executable is run (by looking at the value of this header for the executable and any libraries it links to).<br>
<p>
I would assume de Raadt's comment means that if you dlopen() a library that has GNU_STACK indicating an executable stack is required, the stack's no-execution protection will be removed (to allow you to actually use the library you just loaded). If you've made the protection bits immutable, this is no longer possible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2023 3:37 UTC (Tue)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/948604/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about we add a new flag on binaries, GNU_STACK_FORBID, which says "I solemnly swear that this program won't open anything with a GNU_STACK".  Distributions can globally enable the flag on all their binaries, allowing ld.so to apply immutability to the stack.<br>
<p>
Similar things can be done for other OpenBSD protections.  Stuff like RAW_SYSCALL_FORBID (to block syscalls outside of libc), or a new section that declares what sections of the desired memory map are the stack to allow for the pointer protection.  For most programs, the compiler knows where the stack is, and for the exceptions, distributors can remove the flags from binaries.  Existing programs would obviously lack the flags, and just keep working.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948622"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2023 11:54 UTC (Tue)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/948622/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So a note: The presence of a GNU_STACK section allows ld.so to possibly NOT mark the stack as executable. If the header is missing ld.so will be forced to mark the stack as executable. So forbidding loading anything will defiantly not achieve the desired results.<br>
<p>
Additional certain gcc nested functions require stack trampolines (and thus an executable stack). I don't know about the prevalence of this feature, especially in shared libs. However an "GNU_STACK_FORBID" would have to be a compile time opt-in thing (since you could not know if it is actually needed until runtime).<br>
<p>
Finally, the compiler will have no clue where the stack is. Address space layout randomization means it could be basically anywhere. Additionally, there's[1] 1 stack per thread, but the thread number is runtime determined. So even if ASLR was disabled, and GNU_STACK (or another mechanism added) was extended to allow specifying the stack address (AFAIK it does not currently allow this), only single threaded programs would have "compile time" knowledge of the stack address. <br>
<p>
That said: a GNU_STACK_MASK might be a good idea. Basically a mask of disallow permission on the stack. Any attempt to dlopen() a library that would violate the mask could return an error, and a load time ld.so attempt to violate a programs mask could just throw an error and exist before main().<br>
<p>
[1] Actually there are good reasons to have multiple stacks per thread. One of them is a SIGSEGV handler, which requires a separate stack. Another, though rare, is any attempt to use any form of userland threading.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948622/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor948725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2023 18:31 UTC (Tue)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/948725/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <cite> Is it really a fundamental (architectural) flaw in Linux?</cite>
<p>

It is not related to Linux. 
<p>
gcc implements an extension to C, which is called <a href="https://gcc.gnu.org/onlinedocs/gcc/Nested-functions.html">nested function</a> which requires the use of trampoline when the address of a nested function is needed (this is an instance of the <a href="https://en.wikipedia.org/wiki/Funarg_problem">funarg problem</a>).
The use of trampoline requires the stack to be executable.
<p>
The use of nested functions in GNU C is rare since it is not part of the C standard and hence not idiomatic. However it is used to implement nested functions in other languages which have them (e.g. algol and pascal derivative).
<p>
GNU_STACK provides a way to mark the stack executable only when this feature (address of nested function) actually requires it. 
<p>
If you want to fix that, you need either to find a way to implement trampoline with a noexec-stack or to remove that feature entirely.
<p>
Now, the relevance to this issue is that if your code do not use that feature but uses dlopen, dlopen can potentially load a module that uses that feature, and in that case dlopen will have to set the stack executable.











      
          <div class="CommentReplyButton">
            <form action="/Articles/948725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor948756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 25, 2023 10:30 UTC (Wed)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/948756/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://gcc.gnu.org/onlinedocs/gcc/Nested-Functions.html">https://gcc.gnu.org/onlinedocs/gcc/Nested-Functions.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/948756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor949745"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mseal() and what comes after</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2023 6:56 UTC (Thu)
                               by <b>dxin</b> (guest, #136611)
                              [<a href="/Articles/949745/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the Linux people is also misunderstanding the purpose of this feature. "Partial seal" is meaningless to attackers but is "partially" meaningful to defend against bugs. Limiting the damage that could be done by an attacker is never the top concern of an individual dev, and it's the damage by bugs that they want to minimize, even if just partially, because that's what drives them crazy every day.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/949745/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2023, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
