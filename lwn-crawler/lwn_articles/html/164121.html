        <!DOCTYPE html>
        <html lang="en">
        <head><title>SMP alternatives [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/164121/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/163269/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/164121/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>SMP alternatives</h1>
<div class="Byline">[Posted December 14, 2005 by corbet]
               <p>
               </div>
</div>
<div class="ArticleText">
The i386 processor family poses a challenge for kernel builders.  These
processors have maintained instruction set compatibility for many years;
code built for early Pentium processors will likely still run on current
hardware.  The problem is that code built for these older processors will
fail to take advantage of features added later on.  The "least common
denominator" approach can thus lead to sub-optimal use of current CPUs.
<p>
The kernel has a number of ways of dealing with this challenge.  In some
cases it can make decisions at run time, using processor features only if
they are found to be present.  Other features are only available by way of
build-time configuration options; selecting these will result in a kernel
which will not run on older systems.  Yet another mechanism is the
"alternatives" feature, which allows the kernel to optimize itself at boot
time.  Consider this example of alternatives use (from
<tt>include/asm-i386/system.h</tt>): 
<p>
<pre>
    #define mb() alternative("lock; addl $0,0(%%esp)", \
                             "mfence", \
			     X86_FEATURE_XMM2)
</pre>
<p>
This macro places a memory barrier in the code, ensuring that all memory
reads and writes initiated before the barrier complete before execution
continues.  The default implementation is essentially a bus-locked no-op;
it will work anywhere.  On  newer systems, however, the more efficient
<tt>mfence</tt> instruction is available, and it would be nice to use it.
<p>
The <tt>alternative()</tt> macro compiles in the default code, but also
makes a note of its location (and alternative implementation) in a special
ELF section.  Early in the boot process, the kernel calls
<tt>apply_alternatives()</tt>, which makes a pass through that special
section.  Every alternative instruction which is supported by the running
processor is patched directly into the loaded kernel image; it will be
filled with no-op instructions if need be.  Once
<tt>apply_alternatives()</tt> has finished its work, the kernel behaves as
if it had been compiled for the processor it is actually running on.  This
mechanism allows 
distributors to ship generic kernels which can optimize themselves at boot
time.
<p>
The 2.6 mainline uses alternatives sparingly: for barriers, prefetch hints,
and saving the floating point unit state.  Gerd Knorr, however, believes
that the use of alternatives could be expanded to further reduce the range
of kernels which distributors need to ship - and to improve runtime
flexibility as well.  In particular, he thinks that kernels can be
optimized for single- or multiprocessor systems on the fly.
<p>
Gerd's <a href="http://lwn.net/Articles/163810/">SMP alternatives patch</a>
is an implementation of this concept.  It creates an new macro
(<tt>alternative_smp()</tt>) which can be used to specify optimal
implementations of an operation on both uniprocessor and SMP systems; the
proper version will then be selected at runtime.  The main use of SMP
alternatives in his patch is with spinlock operations; spinlocks can be
patched in or edited out, as dictated by the configuration of the system at
boot time.
<p>
There are a couple of interesting features in Gerd's patch.  One is in the
handling of the i386 architecture's <tt>lock</tt> prefix.  This prefix,
when applied to specific instructions, causes the instruction to run in a
bus-locked, atomic manner.  It is used for operations which must be seen
coherently across a multiprocessor system; these include semaphore
operations and the <tt>atomic_t</tt> implementation.  Use of the
<tt>lock</tt> prefix on uniprocessor systems imposes a runtime cost with no
benefit; it would be nice to edit those out.  The SMP alternatives patch
takes a shortcut here; it simply remembers each location where a
<tt>lock</tt> prefix appears.  If the kernel boots on a uniprocessor
system, all of those prefixes can be quickly overwritten with no-ops.
<p>

A more interesting - and more controversial - feature of this patch is
that, when the kernel is converted between the SMP and uniprocessor mode,
the overwritten instructions are remembered.  At some point the the future,
then, the alternatives code can reverse the change, switching the kernel
back to the full SMP implementation.  The code is then run whenever a CPU
hotplug event happens, optimizing the kernel for the system's new
configuration.  A system can be initially booted with a single processor,
and the alternatives code will edit out all of the SMP-related
instructions.  If another processor is added later on, the kernel will be
automatically converted back into a fully SMP-capable mode.  If processors
are removed, the SMP code can be taken out too.  All within a running
system, with no need to reboot.
<p>

This feature may seem useful to a rather small minority of users - and it
is.  But that minority may be bigger than one thinks.  Virtualization
systems (and Xen in particular) are implementing the ability to configure
the number of (virtual) CPUs in each running instance on the fly, in
response to the load on each.  So it may really be that a busy, virtualized
server will have CPUs hot-plugged into it, and that those processors will
go away when the load drops.  Enabling the kernel to reconfigure itself on
the fly when this happens will allow each Xen instance to run a kernel
which is optimized for its current situation.
<p>

The CPU hotplug may be a hard sell - self-modifying code in a running
kernel tends to make people nervous.  The rest of the SMP alternatives
patch seems likely to find a place in the mainline, eventually.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Alternative_instructions">Alternative instructions</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Virtualization">Virtualization</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/164121/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor164248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That's why I love Linux...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 3:19 UTC (Thu)
                               by <b>sbishop</b> (guest, #33061)
                              [<a href="/Articles/164248/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p>The difference between this idea and the way Windows works is incredible.  Self-modifying/optimizing code versus "Another processor?  Do you have a license for that?"  Wow.</p>

<p>I've realized recently that Linux often benefits <i>technically</i> from its license.  This idea is an example of that.</p>

<p>I've seen another example at work, where I maintain a Linux USB driver used internally.  It's based off the example USB driver that's included in the Linux kernel code, and it's about 600 lines long.  The corresponding example Windows driver that comes with Microsoft's DDK (Driver Development Kit) consists of multiple files and around 8,000 lines total.  Why the difference?  Because the Linux developers aren't tied to an ABI, or API, for that matter.  They can adjust the interface between the kernel and drivers (because they have the source for those too) until they get it right.  The Windows driver contains much that really ought to be built-in.  A +10x difference in code size--that's huge.</p>

<p>And guess which is more than twice as fast than the other?  :)</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That's why I love Linux...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 10:35 UTC (Thu)
                               by <b>Duncan</b> (guest, #6647)
                              [<a href="/Articles/164307/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      I'm certainly no MSWormOS fan, and I like your point, but in actuality, <br>
from what I've read, MS is one of the better proprietaryware venders in <br>
regard to multicore, at least.  While the likes of Oracle continue to bill <br>
per core, MS has been looking pretty flexible by comparison, saying it <br>
will continue to license per CPU, even as the number of cores per CPU <br>
begins to climb. <br>
 <br>
As to the USB driver, if it's useful for you, unless you are developing it <br>
for as yet unreleased hardware, it's almost certainly going to be useful <br>
to others as well.  The GPL doesn't require publishing code for internal <br>
work, but consider the benefits of either /not/ having to do that internal <br>
maintenance, as it's done for you by the kernel crew, or submitting it for <br>
kernel inclusion and becoming the maintainer yourself, thus gaining <br>
visibility and favorable press throughout the Linux world, /plus/ having a <br>
bit of the work still done for you, when someone changes out kernel code <br>
you depend on from under you. <br>
 <br>
Of course, you likely have your reasons for not doing so, but come on, you <br>
gotta admit such a posting to LWN is just /begging/ someone to ask why you <br>
haven't yet made source available!  &lt;g&gt; <br>
 <br>
Duncan <br>
 <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164413"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That's why I love Linux...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 16:18 UTC (Thu)
                               by <b>sbishop</b> (guest, #33061)
                              [<a href="/Articles/164413/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>Yea, I suppose that I should have seen that coming.  :)</p>

<p>I work for a manufacturing company.  The hardware is a tester that only we'd be interested in.  And the driver really isn't far distanced from usb-skeleton.c, so it very interesting either.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164413/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor185933"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">That's why I love Linux...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2006 16:41 UTC (Thu)
                               by <b>cventers</b> (guest, #31465)
                              [<a href="/Articles/185933/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Is it a tester that no one else on Earth owns? :)<br>
<p>
I read that GregKH re-emphasized at the recent FreedomHEC that the kernel <br>
has drivers with only a handful of users. Perhaps mainline inclusion <br>
isn't an impossible thing after all.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/185933/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor164612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Internal-use kernel code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2005 16:51 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/164612/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      You silently merge the idea of making source code available and of getting it in the kernel.org tree.  You also seem to merge, as many people do, the idea of submitting code for inclusion and of that code being included.
<p>
There's a significant cost to getting code into kernel.org.  I myself write lots of kernel code, and while the world is welcome to all of it and much of it is published, I have never attempted to get any of it into kernel.org.
<p>
First, I'd have to translate it to a coding style I don't like and package it according to some pretty specific rules.  Then I'd have to run the gauntlet of some mailing list, probably having to rework the code a few times.  Some of that rework would be stuff I don't agree with.  Some would be stuff I have no use for.  At no point would I have any guarantee my work would result in any code going in.
<P>
So I suffer the costs of being out of tree (mainly, I can't use the most current kernel.org code), but it beats the cost of getting in tree.

      
          <div class="CommentReplyButton">
            <form action="/Articles/164612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164644"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Internal-use kernel code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2005 19:42 UTC (Fri)
                               by <b>Duncan</b> (guest, #6647)
                              [<a href="/Articles/164644/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Well, I'm aware of the difference, but didn't go to my usual lengths to  <br>
specify it.  How come other folks can take shortcuts, but every time I  <br>
abridge a detail, I get called on it?  &lt;g&gt;  I suppose it's likely because  <br>
folks are used to me being so detailed, tho some might be just  <br>
coincidence.  <br>
  <br>
Anyway, yeah, thanks for making the code available, even if it's not  <br>
targeted at the kernel tree ATM.  That's an important right of Free  <br>
source, too, being able to NOT have to go for merge, if desired, tho  <br>
because it's Free source, others can take it and go for that merge if they  <br>
want to, again, another important right.  <br>
  <br>
Thanks also for filling in those details.  It's quite possible the  <br>
additional information will be of use to future readers, and I /did/ fail  <br>
to mention it, so it's good someone came along to fill the gap. =8^)  <br>
  <br>
Duncan  <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164644/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor164298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 9:44 UTC (Thu)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/164298/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      Please excuse my ignorance of kernel development, but I don't understand how this can be made to work safely. I am not sure under which conditions CPU hotplug events are processed, but I would imagine that at that time numerous locks in the kernel would be in the locked state.<br>
<p>
If the CPU hotplug code causes the unlock functions to become a NOOP, then after the event has been processed, any scheduled tasks that perform an unlock of an existing lock will not cause any change in the state of the kernel.<br>
<p>
If the kernel is then patched for SMP again, and numerous locks which were 'unlocked' by tasks running under the non-SMP kernel are actually still marked in memory as locked, would that not cause severe system instabilty or a deadlock condition?<br>
<p>
Again, I only know the kernel by concept, and have never written a line of code for it. Excuse my ignorance. :)<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164362"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 14:05 UTC (Thu)
                               by <b>kpfleming</b> (subscriber, #23250)
                              [<a href="/Articles/164362/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      You are confusing mutual exclusion/semaphore locks with 'bus' locks. There is no 'unlock' operation involved here; the 'lock' prefix instruction being referred to only affects the instruction it precedes, and there is an automatic 'unlock' of the bus when that instruction completes.<br>
<p>
Switching from uni- to multi-processor mode won't even require holding all the kernel threads/processes in an idle state while this happens, it would just have to complete all the instruction patching before any threads could be allowed to run on the new CPU.<br>
<p>
This is a very, very cool idea :-)<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164362/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 18:39 UTC (Thu)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/164461/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      That's not how I read it.<br>
<p>
"The main use of SMP alternatives in his patch is with spinlock operations; spinlocks can be patched in or edited out, as dictated by the configuration of the system at boot time."<br>
<p>
It sounds like spinlocks will be turned into noops.  This may be ok when going SMP-&gt;UP, but maybe not the other direction, and I wonder what kind of lock state would be retained when going SMP-&gt;UP-&gt;SMP...<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164466"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 18:59 UTC (Thu)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/164466/">Link</a>] 
      </p>
      
      </div>
      </summary>
      To enable hotplug SMP -&gt; UP -&gt; SMP, you'd definitely need to retain spinlocks, or at least put a lightweight "take lock" instruction there as opposed to the full spin.  Fully NOPping spinlocks out would be a disaster, as you note.  <br>
<p>
Elsewhere, though, you could nuke/replace LOCK prefixes as needed.  <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164466/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor164375"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Safety</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 14:55 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/164375/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Changing the functioning of spinlocks could certainly create trouble if parts of the kernel are certainly holding locks!  By my reading of the patch, there are a couple of defenses against that problem, though:
<p>
<ul>
<li> A kernel built with the SMP alternatives maintains the counters for spinlocks, so lock state should be preserved in all configurations, and
<p>
<li> The hotplug CPU code has to quiesce the system anyway, so no atomic code should be running while alternatives are being applied.
</ul>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164375/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor165621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2005 19:46 UTC (Sun)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/165621/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Um, my guess is that you'd stop processes from running on the second processor -before- switching down to a single processor kernel. As only one processor could then even be holding locks, the locking mechanism becomes irrelevant, so can be NOOPed.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor164345"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 12:35 UTC (Thu)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/164345/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <I>Virtualization systems (and Xen in particular) are implementing the ability to configure the number of (virtual) CPUs in each running instance on the fly, in response to the load on each. So it may really be that a busy, virtualized server will have CPUs hot-plugged into it, and that those processors will go away when the load drops.</I>
<P>
Why bother with hotplugging virtual processors? Isn't it simpler to add more resources (e.g. more CPU splices per second) on the host to the particular virtualized server?
<P>
<CENTER>Bye,NAR</CENTER>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164345/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164402"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 15:26 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/164402/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Yes, as long as you have more slices per second to give.<br>
<p>
Once you've maxed out a single processor, your only recourse is to run the VM on more processors.  AFAIK there's no good way of doing this unless the VM is partitioned (parallelized?) as well.  Multiple virtual CPUs is the best way of doing this.<br>
<p>
But the VM doesn't care!  why not always run it in a quad-cpu configuration?  Because that wastes cycles if it's just being run on a single CPU.<br>
<p>
That's just a guess.  It seems an overcomplex solution to me but I haven't looked at the code yet.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164402/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor164745"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2005 19:26 UTC (Sun)
                               by <b>bk</b> (guest, #25617)
                              [<a href="/Articles/164745/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Can these processors be on different physical machines? This sounds like an implementation of SSI clustering, which is pretty cool.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164745/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165087"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 21, 2005 7:08 UTC (Wed)
                               by <b>csamuel</b> (<b>&#x272D; supporter &#x272D;</b>, #2624)
                              [<a href="/Articles/165087/">Link</a>] 
      </p>
      
      </div>
      </summary>
      No. <br>
 <br>
Xen is still running on a single system and whilst you can migrate a <br>
system between Xen servers (if you've got a shared filesystem that can <br>
cope) it only runs on one or the other with a tiny pause for the actual <br>
transition. <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165087/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor164478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2005 20:14 UTC (Thu)
                               by <b>captrb</b> (guest, #2291)
                              [<a href="/Articles/164478/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
       <br>
Can anybody speculate whether this functionality will make various <br>
power management easier on SMP machines?  It seems (without any <br>
knowledge to back it up) that each CPU could be removed until there <br>
was a single CPU left, then the same procedure that works on <br>
uniprocessor machines could be performed. <br>
 <br>
It's a really shame, especially with dual core CPU's and <br>
hyperthreading, that there is a choice between fancy power <br>
management and multiple processors. <br>
 <br>
 <br>
 <br>
 <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165623"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2005 19:51 UTC (Sun)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/165623/">Link</a>] 
      </p>
      
      </div>
      </summary>
      No. This is talking about removing code once you've already switched down to a single processor, and adding code when you want to switch up.<br>
<p>
Adding/removing processors at runtime, I believe, is already possible (otherwise this code would be pretty useless)<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165623/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor164619"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2005 17:38 UTC (Fri)
                               by <b>norsk</b> (guest, #30746)
                              [<a href="/Articles/164619/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Back in 1998, while working at Novell on the Netware SMP project, I did the same thing on self-modifying kernel mods. The kernel was built in SMP mode and when installed on a UP system, all the "lock" instructions, SMP and atomics called their respective init routines to determine whether UP or SMP and applied the correct op-codes. Gave us 2-5% improvement and a major cost in shipping of different kernels.<br>
<p>
I like the idea of reversing the mods when a CPU hotplug event occurs. Hardware at my time did not have the feature set.<br>
<p>
I was wondering why this had not yet happened before in Linux.  Still a far better world to work in, then the Netware kernel.<br>
<p>
doug "norsk" thompson<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/164619/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165705"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2005 17:13 UTC (Tue)
                               by <b>cajal</b> (guest, #4167)
                              [<a href="/Articles/165705/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      If I'm interpreting your post right, you're saying this is a bad thing. A 2-5% improvement is pretty negligible, and it came at a major cost. Sounds like this is something Linux should avoid.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165705/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165732"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SMP alternatives</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2005 23:17 UTC (Tue)
                               by <b>turpie</b> (guest, #5219)
                              [<a href="/Articles/165732/">Link</a>] 
      </p>
      
      </div>
      </summary>
      He meant that it saved the major cost of shipping different kernels, by allowing them to ship a single kernel for both UP and SMP.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165732/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor165285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">User base</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2005 11:22 UTC (Thu)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/165285/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      The potential user base is larger than hot-plugging SMP users and Xen users. The many of the next generation of laptops will have dual core CPUs, and it's likely to be desirable to shut down a core when on battery (for example).<br>
<p>
A dual core system is essentially SMP... and laptops are very power / performance concious. It would not hurt in the slightest to eke out every bit of speed (or efficiency, ie potentially less power use) while on a half-clocked single-core CPU for battery saving, then safely switch to full-bore dual-core mode when on mains.<br>
<p>
This patch seems like a really good way to handle that need.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165289"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">User base</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2005 11:59 UTC (Thu)
                               by <b>rrw</b> (guest, #9757)
                              [<a href="/Articles/165289/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p><i>A dual core system is essentially SMP... and laptops are very power / performance concious. It would not hurt in the slightest to eke out every bit of speed (or efficiency, ie potentially less power use) while on a half-clocked single-core CPU for battery saving, then safely switch to full-bore dual-core mode when on mains.</i></p>

<p>OK, I have a problem with this. Why would I need to clock down a notebook on batteries and clock it up on mains?</p>

<p>When a Centrino notebook on mains works with full speed it soon gets so hot that the fan works non stop, and the keyboard itself gets annoyingly warm.</p>

<p>On the other hand, when notebook runs on battery and I want to do something cpu intensive it is painstakingly slow. But where's the power consumption advantage? I have to do this anyway, slower or faster, and if I do something with downclocked CPU, power consumption per unit of time in display, gpu, harddisk doesn't decrease, so I actually eat more juice.</p>

<p>Isn't it better to just use sth like powernowd, which dynamically clocks processor depending on system load, wheather you use mains or battery?</p>

Robert
      
          <div class="CommentReplyButton">
            <form action="/Articles/165289/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor177740"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CPU usage optimisation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 30, 2006 5:20 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/177740/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Exactly.  The CPU configuration and speed should be adjusted according to  <br>
demand for processing power, not supply of electricity.  <br>
  <br>
There is never a case for consuming more power just because you *can*.   <br>
Otherwise we'd all leave all our computers and all our lights switched on  <br>
all of the time.  Bring on global warming. <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/177740/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor863905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CPU usage optimisation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 22, 2021 1:41 UTC (Thu)
                               by <b>muzg666</b> (guest, #139506)
                              [<a href="/Articles/863905/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
hahahahah lol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/863905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor165334"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Single kernel image for UP &amp; SMP</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2005 15:41 UTC (Thu)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/165334/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Could this patch cause removing CONFIG_SMP in future? With kernel image identical for SMP and UP machines and runtime patching?<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165334/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165419"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Single kernel image for UP &amp; SMP</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2005 23:30 UTC (Thu)
                               by <b>renox</b> (guest, #23785)
                              [<a href="/Articles/165419/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Well, as some others have remarked for this to work you have to remember which (spin)locks are taken, even on a UP processor thus loosing some performance in UP.<br>
<p>
I think that even a minimal loss would be a hard sell to kernel developpers considering how little this UP&lt;-&gt;SMP feature is going to be used..<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165419/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor165624"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Single kernel image for UP &amp; SMP</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2005 19:59 UTC (Sun)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/165624/">Link</a>] 
      </p>
      
      </div>
      </summary>
      There's no reason why you would have to do that (I won't repeat my last post). The speed differences would be down to the processor having to deal with the few noop's, eating up slightly more L1/L2 cache, and keeping in memory (and the kernel image file itself) - for those who worry about that - code for both scenario's.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/165624/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor187022"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Single kernel image for UP &amp; SMP</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2006 23:42 UTC (Fri)
                               by <b>niner</b> (subscriber, #26151)
                              [<a href="/Articles/187022/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I can't imagine that. Think of embedded applications. When you only have 2MB of flash and a couple of megabytes of RAM, you really start to care about the few kilobytes such a feature costs of both memory footprints.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/187022/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor187092"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Single kernel image for UP &amp; SMP</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2006 16:14 UTC (Sun)
                               by <b>tyhik</b> (guest, #14747)
                              [<a href="/Articles/187092/">Link</a>] 
      </p>
      
      </div>
      </summary>
      RAM and flash ships get larger and larger all the time. For smaller design companies it may already be cheaper to get 4mb than 2mb flash chip.<br>
<p>
But of course the code size matters. Smaller code implies better cache usage.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/187092/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2005, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
