        <!DOCTYPE html>
        <html lang="en">
        <head><title>4K-sector drives and Linux [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/377895/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/377392/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/377895/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>4K-sector drives and Linux</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 9, 2010</br>
           </div>
Almost exactly one year ago, LWN <a
href="http://lwn.net/Articles/322777/">examined the problem of 4K-sector
drives</a> and the reasons for their existence.  In short, going to 4KB
physical sectors allows drive manufacturers to increase storage density,
always welcome in that competitive market.  Recently, there have been a
number of reports that Linux is not ready to work with these drives; kernel
developer Tejun Heo even <a href="/Articles/377897/">posted an extensive,
worth-reading 
summary</a> stating that "<q>4 KiB logical sector support is broken in
both the kernel and partitioners.</q>"  As the subsequent discussion
revealed, though, the truth of the matter is that
we're not quite that badly prepared.
<p>

Linux is fully prepared for a change in the size of physical sectors on a
storage device, and has been for a long time.  The block layer was written
with an avoidance of hardwired sector sizes in mind.  Sector counts and
offsets are indeed managed as 512-byte units at that level of the kernel,
but the block layer is careful to perform all I/O in units of the correct
size.  So, one would hope, everything would Just Work.
<p>

But, as Tejun's document notes, "<q>unfortunately, there are
complications.</q>"  These complications result from the fact that the
rest of the world is not prepared to deal with anything other than 512-byte
sectors, starting with the BIOS found on almost all systems.  In fact, a
BIOS which can boot from a 4K-sector drive is an exceedingly rare item -
if, indeed, it exists at all.  Fixing the BIOS is evidently harder than one
might think, and, evidently, there is little motivation to do so.  Martin
Petersen, who has done much of the work around supporting these drives in
Linux,  <a href="/Articles/377900/">noted</a>:
<p>
<div class="BigQuote">
	Part of the hesitation to work on booting off of 4 KB lbs drives is
   	motivated by a general trend in the industry to move boot
   	functionality to SSD.  There are 4 KB LBS SSDs out there but in
   	general the industry is sticking to ATA for local boot.
</div>
<p>
The problem does not just exist at the BIOS level: bootloaders (whether
they are Linux-oriented or not) are not set up to handle larger sectors;
neither are partitioning tools, not to mention a wide variety of other operating
systems.  Something must be done to enable 4K-sector drives to work with
all of this software.
<p>
That something, of course, is to interpose a mapping layer in the middle.
So most 4K-sector drives will implement separate logical and physical
sector sizes, with the logical size - the one presented to the host
computer - remaining 512 bytes.  The system can then pretend that it's
dealing with the same kind of hardware it has always dealt with, and
everything just works as desired.
<p>
Except that, naturally enough, there are complications.  A 512-byte sector
written 
to a 4K-sector drive will now force the drive to perform a
read-modify-write cycle to avoid losing the data in the rest of the
sector.  That slows things down, of course, and also increases the risk of
data loss should something go wrong in the middle.  To avoid this kind of
problem, the operating system should do transfers that are a multiple of
the physical sector size whenever possible.  But, to do that, it must know
the physical sector size.  As it happens, that information has been made
available; the kernel makes use of this information internally and exports
it via sysfs. 
<p>
It is not quite that simple, though.  The Linux kernel can go out of its
way to use the physical sector size, and to align all transfers on 4KB
boundaries from the beginning of the partition.  But that goes badly wrong
if the partition itself is not properly aligned; in this case, <i>every</i>
carefully-arranged 4KB block will overlap two physical sectors - hardly an
optimal outcome.
<p>
As it happens, badly-aligned partitions are not just common; they are the
norm.  Consider an example: your editor was a lucky recipient of an Intel
solid-state drive 
at the Kernel Summit which was quickly plugged into his system and partitioned
for use.  It has been a great move: git repositories on an SSD are much
nicer to work with.  A quick look at the partition table, though, shows
this:
<p>
<blockquote>
<pre>
Disk /dev/sda: 80.0 GB, 80026361856 bytes
255 heads, 63 sectors/track, 9729 cylinders, total 156301488 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x5361058c

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1              63    52452224    26226081   83  Linux
</pre>
</blockquote>
<p>
Note that <tt>fdisk</tt>, despite having been taken out of the "DOS
compatibility" mode, is displaying the drive dimensions in units of heads
and cylinders.  Needless to say, this device has neither; even on rotating
media, those numbers are entirely fictional; they are a legacy from a dark
time before Linux even existed.  But that legacy is still making life
difficult now.
<p>

Once upon a time, it was determined that 63 (512-byte) sectors was far more
than anybody would be able to fit into a single disk track.  Since
track-aligned I/O is faster on a rotating drive, it made sense to align
partitions so that the data began at the beginning of a track.  So,
traditionally, the first partition on a drive begins at (logical)
sector&nbsp;63, the last sector of the first track.  That sector holds the
boot block; any filesystem stored on the partition will follow at the
beginning of the next track.
  That placement, of course, misaligns the filesystem with
regard to any physical sector size larger than 512 bytes; logical sector&nbsp;64
(the first data sector in the partition) will be placed at the end of a 4K
physical sector.  Any subsequent
partitions on the device will almost certainly be misaligned in the same
way.

<p>
One might argue that the right thing to do is to simply ditch this
particular practice and align partitions properly; it should not be all
that hard to teach partitioning tools about physical sector sizes.  This
can certainly be done.  The tools have been slow to catch on, but a
suitably motivated system administrator can usually convince them to place
partitions sensibly even now.  So weird alignments should not be an
insurmountable problem.
<p>
Unfortunately, there are complications.  It would appear that Windows XP
not only expects misaligned partitions; it actually will not function
properly without them.  One simply cannot run XP on a device which has been
properly partitioned for 4K physical sector sizes.  To cope with that, drive
manufacturers have introduced an even worse hack: shifting all 512-byte
logical sectors forward by one, so that logical sector 64 lands at the
beginning of a physical sector.  So any partitioning tool which wants to
lay things out properly must know where the origin of the device actually
is - and not all devices are entirely forthcoming with that information.
<p>
With luck, the off-by-one problem will go away before it becomes a big
issue.  As <a href="/Articles/377909/">James Bottomley put it</a>:
"<q>...fortunately very few of these have been seen in the wild and we're
hopeful they can be shot before they breed.</q>"  But that doesn't fix
the problem with the alignment of partitions for use by XP.  Later versions
of Windows need not concern themselves with this problem, since they rarely
coexist with XP (and Windows has never been greatly concerned about
coexistence with other systems in general).  Linux, though, may well be
installed on the same drive as XP; that leads to differing alignment
requirements for different partitions.  Making <i>that</i> just work  is
not going to be fun.
<p>
Martin <a href="/Articles/377910/">suggests</a> that it might be best to
just ignore the XP issue:
<p>
<div class="BigQuote">
	With regards to XP compatibility I don't think we should go too
	much out of our way to accommodate it.  XP has been disowned by its
	master and I think virtualization will take care of the rest.
</div>
<p>
It may well be that there will not be a significant number of XP
installations on new-generation storage devices, but failure to support XP
may still create some misery in some quarters.
<p>
A related issue pointed out by Tejun is that the DOS partition format,
which is still widely used, tops out at 2TB, which just does not seem all
that large anymore.  Using 4K logical sectors in the partition table can
extend that limit as far as 16TB, but, again, that requires cooperation
from the BIOS - and it still does not seem all that large.  The long-term
solution would appear to be moving to a partition format like <a
href="http://en.wikipedia.org/wiki/GUID_Partition_Table">GPT</a>, but that
is not likely to be an easy migration.
<p>

In summary: Linux is not all that badly placed to support 4K-sector drives,
especially when there is no need to share a drive with older operating
systems.  There is still work required at the tools level to make that
support work optimally without the need for low-level intervention by
system administrators, but that is, as they say, just a matter of a bit of
programming.  As these drives become more widely available, we will be able
to make good use of them.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer-Large_physical_sectors">Block layer/Large physical sectors</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/377895/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor377952"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2010 23:24 UTC (Tue)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/377952/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
This comment adds a lot of important details<br>
<p>
<a href="http://www.osnews.com/thread?409410">http://www.osnews.com/thread?409410</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/377952/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 13:33 UTC (Wed)
                               by <b>Trelane</b> (subscriber, #56877)
                              [<a href="/Articles/378000/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting link; thanks! :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor378243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 16:28 UTC (Thu)
                               by <b>msnitzer</b> (subscriber, #57232)
                              [<a href="/Articles/378243/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Here is another link that should give more insight on how most of the Linux I/O <br>
stack has already been updated upstream and will be included in Fedora 13:<br>
<a href="http://lkml.org/lkml/2010/3/11/230">http://lkml.org/lkml/2010/3/11/230</a><br>
<p>
I think it is unfortunate that the time was taken to highlight Linux's preparedness <br>
for 4K sector drives but failed to accurately convey the true state of the various <br>
pieces involved.  Even inaccurately concluding that there is much work ahead for <br>
the various Linux tools.<br>
<p>
The article focused on Tejun's misunderstanding and worked from there rather <br>
than incorporating the more promising state of Linux's preparedness that was <br>
revealed in reply to Tejun's post.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 16:45 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/378247/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Interesting...I thought I wrote an article saying that, Tejun's worries notwithstanding, we're not in all that bad a shape.  As far as I can tell, the only thing I got really wrong was regarding XP, which can handle things better than I had thought.  As for the rest...what does it take to make a partitioning utility a little smarter?
<p>
Anyway, my apologies if you feel I misrepresented the situation.
      
          <div class="CommentReplyButton">
            <form action="/Articles/378247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378253"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 17:09 UTC (Thu)
                               by <b>msnitzer</b> (subscriber, #57232)
                              [<a href="/Articles/378253/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hey Jon,<br>
<p>
Not a big deal.. I was just saying that many of the partition tools and others have <br>
already been updated.  The "what does it take" to update them is somewhat <br>
moot; as it has been done.  Updating LVM was a bit more involved than <br>
mkfs.ext3.  Updating virtio and qemu was also somewhat intrusive.<br>
<p>
But for those tools that haven't been updated they will either need to use libblkid <br>
(like e2fsprogs does) or use the new "IO topology" block ioctls.  Please see this <br>
for more info (contains the specific ioctls and more):<br>
<a href="http://people.redhat.com/msnitzer/docs/io-limits.txt">http://people.redhat.com/msnitzer/docs/io-limits.txt</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378253/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 18:47 UTC (Thu)
                               by <b>ricwheeler</b> (subscriber, #4980)
                              [<a href="/Articles/378285/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the article!<br>
<p>
One thing that seems to have been skipped in the discussion so far is that this is not just an issue with local, 4KB sector drives. The changes we have in the kernel and in the tool chain will help with external arrays which have long had larger internal "sectors" but pretended to have 512 byte sectors like a local disk.<br>
<p>
The larger impact of the change is that it should all "just work" if we got all of the bits in place correctly :-)<br>
<p>
Testing on a variety of storage hardware from various vendors, without and without DM and MD is really, really interesting right now to help us uncover any bits we did miss.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor377954"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2010 23:43 UTC (Tue)
                               by <b>pheldens</b> (guest, #19366)
                              [<a href="/Articles/377954/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just got one of these drives, a 1TB WD10EARS, I intend to put it in soft raid 1 with a WD10EACS, are there caveats there? using stock linux 2.6.33. <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/377954/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor377970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RAID: was 4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 2:36 UTC (Wed)
                               by <b>smoogen</b> (subscriber, #97)
                              [<a href="/Articles/377970/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My guess would be that you would see poor performance on the RAID-1 in the ways similar to having a 5400 RPM and and 10k RPM drive as the RAID-1 pair. or having 2 completely different disks (like in the old days of one disk saying it had 16 platters and another one saying it had 4.. IO to them is very different.) Ones always going to have different IO performance than the other so sometimes things would be fast and others really slow.<br>
<p>
But that would be my guess. If its different let us know.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/377970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor378107"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 21:21 UTC (Wed)
                               by <b>pheldens</b> (guest, #19366)
                              [<a href="/Articles/378107/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I did some tests with the EARS and the effect described in the article is very noticable.<br>
<p>
Default fdisk misaligns the sdb1 data area (63)<br>
changing it to 64 makes formats 20-30% faster<br>
changing it to 65-71 slower again, <br>
changing it to 72 faster again. (+8 presumably 4096/512)<br>
<p>
Will see what happens when I put it in an array aligned<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378107/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor377956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2010 23:54 UTC (Tue)
                               by <b>pheldens</b> (guest, #19366)
                              [<a href="/Articles/377956/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the article linked above suggests:<br>
"...For /dev/sdc, I used fdisk the same as with sdd, but after creating the partition, I realigned it. I did this by entering expert mode ("x"), then setting the start sector ("b") to 64."<br>
for about twice the write performance, compared to defaults (63).<br>
<p>
thanks for this important tip.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/377956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor377983"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 9:25 UTC (Wed)
                               by <b>Darkmere</b> (subscriber, #53695)
                              [<a href="/Articles/377983/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Most _recent_ tools ( parted 2.1 ) util-linux-ng as of... *tries to remember*  some really new release (Fedora 13 has it, 12 does not) work with the new disks perfectly as well.<br>
<p>
parted even goes as far as to yell at you if you have the wrong alignment, and offers to fix it for you. <br>
<p>
However, you may have to use % based partitions for parted to be able to fix the auto-alignment, otherwise it complains.  <br>
<p>
mkpart primary ext3 0% +200M<br>
mkpart primary ext4 200M 100%<br>
Or however you want to work things.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/377983/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379412"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 20:38 UTC (Thu)
                               by <b>till</b> (guest, #50712)
                              [<a href="/Articles/379412/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
gdisk aka GPT fdisk ( <a href="http://www.rodsbooks.com/gdisk/whygdisk.html">http://www.rodsbooks.com/gdisk/whygdisk.html</a> ) on Fedora 12 seems to work nicely, too. It aligns data by default and does not irritate with obscure old data like CHS and the partitions seem to be supported by linux. I don't care about Windows, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379412/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor378240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 16:15 UTC (Thu)
                               by <b>jackb</b> (guest, #41909)
                              [<a href="/Articles/378240/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So if you don't need to worry about non-linux operating systems will this procedure fix the problem for every 4K sector drive except those that offset by one?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor377982"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 9:25 UTC (Wed)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/377982/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"...fortunately very few of these have been seen in the wild and we're hopeful they can be shot before they breed"<br>
<p>
I have six, and another six on back-order :-(<br>
<p>
The WD Green series (at least the 1TB drive WDC WD10EARS-00Y5B1) have 4kb sectors and offset-by-one. Thankfully, that awful hack is disabled by default and must be turned on by the application of a jumper across a pin pair on the back of the drive.<br>
<p>
This is fine so long as the host OS can probe the disk to find out whether or not it's so jumpered, but somehow I doubt it's so easy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/377982/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor378110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 21:49 UTC (Wed)
                               by <b>kjp</b> (guest, #39639)
                              [<a href="/Articles/378110/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't understand the problem with GPT.  And does it fix XP as well?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 19:41 UTC (Thu)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/378298/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I don't understand the problem with GPT.</font><br>
<p>
I agree with you. We have to move to GPT soon anyway, unless you think that 2 TB should be enough for anyone.<br>
<p>
Rather than fooling with this C/H/S nonsense, we should just fix BIOSes and such so that they can use the new format.<br>
<p>
<font class="QuotedText">&gt; And does it fix XP as well?</font><br>
<p>
The 32 bit version of Windows XP can only work with MBRs, never GPTs. There is some weird way that you can have both an MBR and a GPT on your disk, but it looks ugly... very ugly. And it still doesn't let you break the 2 TB limit under XP.<br>
<p>
On the other hand, the 64-bit version of Windows XP can read and write GPT partitions, but can't boot from them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378471"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2010 21:46 UTC (Fri)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/378471/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ok, I figured out that a 4k-sector drive with a traditional MBR can be up to 16TB, not 2TB.<br>
<p>
So that should buy the old MBR scheme another few years.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378471/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378583"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 15, 2010 10:16 UTC (Mon)
                               by <b>etienne_lorrain@yahoo.fr</b> (guest, #38022)
                              [<a href="/Articles/378583/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I figured out that a 4k-sector drive with a traditional MBR can be up to 16TB, not 2TB.</font><br>
<p>
But only for disks with 4096 bytes per LOGICAL sector and 4096 bytes per PHYSICAL sector; you can't find those drives on the market.<br>
There is only 512 bytes per LOGICAL sector and 4096 bytes per PHYSICAL sector for sale, those are 100% compatible with current 512 bytes per sector drive, just are slower in some cases (so they have the same limits).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378583/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor378108"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XP compatibility</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2010 21:49 UTC (Wed)
                               by <b>mrpippy</b> (guest, #57134)
                              [<a href="/Articles/378108/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From reading AnandTech's article on 4K sectors <br>
(<a href="http://www.anandtech.com/storage/showdoc.aspx?i=3691&amp;p=2">http://www.anandtech.com/storage/showdoc.aspx?i=3691&amp;p=2</a>), I got the impression that <br>
Windows XP can function with aligned partitions, it's just not possible to create them with any of <br>
XP's partition editors. <br>
That's why XP either needs to run with the sector+1 hack, or use the WD Align tool after <br>
installation that literally shifts the entire partition back one sector. Both methods result in an <br>
aligned partition that XP can run off of.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378108/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor378159"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 5:44 UTC (Thu)
                               by <b>ranmachan</b> (guest, #21283)
                              [<a href="/Articles/378159/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One simply cannot run XP on a device which has been properly partitioned for 4K physical sector sizes</font><br>
<p>
That's not true.<br>
If you use 32 sectors per track you'll create only correctly aligned partitions. (If the disk doesn't use an offset)<br>
Of course you'll need to go to expert mode in fdisk to change the sector count and you can only do that on a yet unpartitioned disk because IIRC it doesn't recalculate the CHS values for already existing partitions.<br>
And you're still screwed with drives that use an offset. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378159/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor378181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why partition alignment?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 8:43 UTC (Thu)
                               by <b>PO8</b> (guest, #41661)
                              [<a href="/Articles/378181/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't understand why the kernel can't just read and write with the appropriate disk alignment, rather than relying on the partition being aligned.  Surely it can just look at the partition table for the device and remember the correct alignment for each partition, the same as the article above does?  The off-by-one thing is still a problem, but other than that it all seems straightforward.  What am I missing?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why partition alignment?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 15:50 UTC (Thu)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/378235/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So you want the filesystem to start at some offset from the start of the partition? How would an old kernel know about that offset? How would a new kernel know that an old filesystem did not have that offset? The rule is that the partition table specifies the start.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why partition alignment?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 17:15 UTC (Thu)
                               by <b>etienne_lorrain@yahoo.fr</b> (guest, #38022)
                              [<a href="/Articles/378250/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am not sure that is the solution neither, but if it is needed for ext2/3/4fs, it could be implemented in two steps:<br>
1. The EXTxFS superblock is no more located at 1 Kbyte from the beginning of the partition but at the 3rd sector i.e. LBA=2.<br>
It then only make unreadable the EXTxFS located on DVD-RAM or the EXTxFS images written to CDROM/DVDs.<br>
Also, it seems strange to search for a signature in the middle of a sector when the device has 4096 bytes/sector.<br>
2. The EXTxFS superblock is located at the 3rd *physical* sector of the partition.<br>
Then to mount the FS the software has to scan few sectors to see if it find an EXT* superblock, and old mount command can probably handle the "-o offset=1" parameter.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor378283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why partition alignment?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 18:39 UTC (Thu)
                               by <b>PO8</b> (guest, #41661)
                              [<a href="/Articles/378283/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, I just want the kernel to issue reads and writes aligned with the disk blocks.  I don't see why anything has to move on-disk at all?  Reads presumably aren't much of an issue anyhow, and writes are only going to be a problem at the beginning and end.  I don't see why just doing the reads and writes properly aligned wouldn't be almost as good as shifting the data on disk?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor378295"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why partition alignment?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 19:33 UTC (Thu)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/378295/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What you're talking about is actually done by a lot of SSDs that are sold today. It's called write coalescing. SSDs don't really have sectors, they have "erase blocks" which are often 16k or so in size.<br>
<p>
So when they get a request for a 512-byte write, rather than doing the read-modify-write of a 16k block, they wait to see if the user wants to do any more I/O to that erase block.<br>
<p>
The disadvantages of write coalescing are kind of obvious-- it's complex, requires temporary storage (for the un-coalesced 512-byte chunks). More buffering also means there's a longer window when power failures can result in data loss.<br>
<p>
Overall, it's not something you want to do unless you absolutely have to. Performance and stability would be a lot better if the kernel knew about the real situation on the hardware.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378295/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor378190"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2010 12:32 UTC (Thu)
                               by <b>etienne_lorrain@yahoo.fr</b> (guest, #38022)
                              [<a href="/Articles/378190/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
About NTFS having problems with unaligned start of the partition (start at sector 63), it seem strange to read:<br>
<a href="http://technet.microsoft.com/en-us/library/cc781134">http://technet.microsoft.com/en-us/library/cc781134</a>(WS.10).aspx<br>
<font class="QuotedText">&gt; Formatting Volumes: Formatting also aligns clusters at the cluster size boundary.</font><br>
Same for FAT created on the other OS, we can read a bit further:<br>
<font class="QuotedText">&gt; Because formatting in Windows Server 2003 aligns FAT data clusters at the cluster size boundary</font><br>
The FAT filesystem cluster aligment can be modified (and it seems to be the same for NTFS) depending on the alignment of the first sector; it means that you will not generate the same FAT for two partition which have the same size but are aligned differently - as a consequence you cannot directly copy them neither (by "dd").<br>
The Gujin bootloader is aware of that when creating FATs.<br>
I did not find such a field in the EXT2/3/4 filesystem to ignore some sectors at the beginning of the FS.<br>
<p>
About bootloaders and 4096 sectors, the Gujin bootloader may be able to help thanks to its minimal IDE driver in the 512 bytes MBR, but the problem is a lack of hardware to test:<br>
<a href="http://www.wdc.com/en/products/products.asp?driveid=336">http://www.wdc.com/en/products/products.asp?driveid=336</a><br>
 says drive WD10EACS has 1,000,204 MB and 1,953,525,168 sectors, i.e. (1,000,204 * 1000 * 1000) / 1,953,525,168 = 512 bytes/sectors<br>
<a href="http://www.wdc.com/en/products/products.asp?driveid=763">http://www.wdc.com/en/products/products.asp?driveid=763</a><br>
 says drive WD10EARS has exactly the same 512 bytes/sectors<br>
and WD10EARS-00Y5B1 doesn't even have a hit on WD web site... Is that available in UK?<br>
<p>
BTW, GPT is quite easy to use to define partitions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/378190/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor379350"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 15:44 UTC (Thu)
                               by <b>welinder</b> (guest, #4699)
                              [<a href="/Articles/379350/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not start the first partition at sector 63*8?<br>
<p>
That wastes 7 extra "cylinders" (7*63*512 = ~250KB) but is aligned<br>
any way you look at it.  XP should be able to read it.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379350/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor379410"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2010 20:24 UTC (Thu)
                               by <b>till</b> (guest, #50712)
                              [<a href="/Articles/379410/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The XP-bugaround mode moves the sectors by one sector, so there is no factor that can be used that works for both kind of disks with this bug and without.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/379410/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor384664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 25, 2010 15:23 UTC (Sun)
                               by <b>ramiro_morales</b> (guest, #65623)
                              [<a href="/Articles/384664/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Once upon a time, it was determined that 63 (512-byte) sectors was far  more than anybody would be able to fit into a single disk track. </font><br>
<font class="QuotedText">&gt; [...] it made sense to align partitions so that the data began at the  beginning of a track. So, traditionally, the first partition on a drive begins at (logical) sector 63, the last sector of the first track.</font><br>
<font class="QuotedText">&gt; That sector holds the boot block; any filesystem stored on the partition will follow at the beginning of the next track.</font><br>
<p>
I think the two last paragraphs are incorrect. Logical sector 63 is the first sector of the second track, sectors 0-62 are in the first track. So the first partition is completely (both administrative overhead and data) located on the second track.<br>
<p>
Not that this matters now that legacy emulated geometry is finally getting obsoleted.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor471871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">4K-sector drives and Linux</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2011 20:17 UTC (Mon)
                               by <b>derickmoore</b> (guest, #81787)
                              [<a href="/Articles/471871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One of the first things I noticed when I came to this page was the remark, "In fact, a BIOS which can boot from a 4K-sector drive is an exceedingly rare item - if, indeed, it exists at all."<br>
<p>
I can't speak for any 'other' BIOS, but the 2nd Generation SAS products from LSI do have 4K sector support under INT13 Boot.<br>
<p>
The only drawback to that support is the RMW (Read/Modify/Write) cycles that must take place in an environment that has no concept of 4K sectors.<br>
<p>
The BIOS is smart enough to 'package' accesses and minimize reads in consecutive blocks, but of necessity is unable to do anything about the many one sector (512 byte) accesses.<br>
<p>
On the other hand it does 'remember' previous reads into a 4K block, so that consecutive 512 byte accesses don't reread the 'same' 4K block when it hasn't changed.  (Remember that INT13 is single threaded)<br>
<p>
I don't know who this might help, but there it is!<br>
<p>
Derick<br>
<p>
P.S. I wish someone would update the DOS version of GDISK to work with 4K drives.  Currently, it blows up when it sees one!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/471871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
