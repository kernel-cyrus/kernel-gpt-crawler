        <!DOCTYPE html>
        <html lang="en">
        <head><title>Zoned storage [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/897263/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/897383/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/897263/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Zoned storage</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we donâ€™t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>June 14, 2022</br>
           <hr>
<a href="/Articles/lsfmm2022/">LSFMM</a>
</div>
<p>
<a href="https://zonedstorage.io/">Zoned storage</a> is a 
form of storage that offers higher capacities by making tradeoffs in the kinds
of writes that are allowed to the device.  It was the topic of a storage and
filesystem session led by Luis
Chamberlain at the
<a
href="https://events.linuxfoundation.org/lsfmm/">2022 Linux Storage,
Filesystem, Memory-management and BPF Summit</a> (LSFMM).  Over the years,
zoned storage has been a frequent topic at LSFMM, <a
href="/Articles/548116/">going back to LSFMM 2013</a>, where 
support for
shingled magnetic recording (SMR) devices, which were the starting point for
zoned storage, was discussed.
</p>

<p>
Chamberlain began with the news that a <a
href="https://lpc.events/event/16/contributions/1147/">zoned storage
microconference</a> had been accepted for this year's <a
href="https://lpc.events/">Linux Plumbers Conference</a> (LPC).  He encouraged
attendees to submit topics and hoped it was an opportunity to introduce more user-space
developers to zoned-storage concepts.  LPC will be held
September&nbsp;12-14 in Dublin, Ireland. 
</p>

<a href="/Articles/897781/">
<img src="https://static.lwn.net/images/2022/lsfmm-chamberlain2-sm.png" border=0 hspace=5
align="left" alt="[Luis Chamberlain]" title="Luis Chamberlain" width=252
height=260>
</a>

<p>
In a "really fast intro" to zoned storage, he quoted from the zoned-storage
home page linked above: it is "<q>a class of storage devices that enables
host and storage devices to cooperate to achieve higher storage capacities,
increased throughput, and lower latencies</q>".  It comes in different
form factors, including SMR and "the latest and trendiest one", which is
based on SSDs using <a
href="https://zonedstorage.io/docs/introduction/zns">NVMe zoned
namespaces</a> (ZNS).  The storage device is divided into zones; "sequential
zones" are those where all
writes in a zone must be sequential and the only way to overwrite the zone is to
reset its write pointer to the beginning.  Both SMR and ZNS devices can
optionally also have "conventional zones" (or namespaces) that support random
writes. 
There can be drives that only have sequential zones, however, which is
something that 
filesystem developers need to keep in mind, he said.
</p>

<p>
There are some "ecosystem considerations" to also keep in mind.  For one,
replacing a zoned-storage device can only be done with another device that has
the same zone sizes.  Also, ZNS requires manually switching the kernel I/O
scheduler to mq-deadline.  That is only true for some filesystems, though,
an audience member said.  Damien Le Moal said that the underlying issue is
that the order of writes needs to be guaranteed and the scheduler was the
easiest place to ensure that.
</p>

<p>
  Ted Ts'o said
there is a philosophical question on whether the kernel should be tracking
the write pointers for the zones or whether user space should be doing
that.  At Google, there is an out-of-tree patch set that hacks the CFQ
scheduler so that it will not merge requests and gives user space  the
responsibility to track
write pointer, but he knows that this out-of-tree approach is not
sustainable long term.  It was generally agreed that there is much to
discuss around these topics at LPC.
</p>

<p>
Moving on, Chamberlain noted that the patches for supporting zone sizes
that are not powers of two (npo2) had been <a
href="/ml/linux-kernel/20220427160255.300418-1-p.raghav%40samsung.com/">posted</a>
and that more revisions should be coming soon (v6 was <a
href="/ml/linux-kernel/20220525154957.393656-1-p.raghav%40samsung.com/">posted</a>
on May&nbsp;25).  He also said that <tt>btrfs check</tt> currently does not work for
image dumps of any zoned storage, probably due to a lack of zone
information on the disk.  There are also some questions about how to write
the superblocks for Btrfs on not-power-of-2 devices.
</p>

<p>
Hearkening back to an <a href="/Articles/897202/">earlier session</a>,
Chamberlain said that the lack of support for <tt>ioctl()</tt> and  direct
I/O (i.e. <tt>O_DIRECT</tt>) in Java causes problems for using it with <a
href="/Articles/794364/">zonefs</a>, which requires direct I/O.  Le Moal
said that the long-term goal is to remove the direct I/O requirement, but
it is currently needed to maintain the write-order guarantees.
</p>

<p>
After Chamberlain asked about the status of <a href="/Articles/895266/">bcachefs</a>,
Kent Overstreet said that it already has
native zoned-device support.  The allocation mechanism for bcachefs has
always been bucket-based, 
<a
href="https://www.kernel.org/doc/html/v5.18/admin-guide/bcache.html">going
back to bcache</a>, which is a good 
match to zoned storage.  Those devices will work just as well as regular block devices for
bcachefs, he said.
</p>

<p>
Chamberlain said he has been using <a
href="https://github.com/mcgrof/kdevops">kdevops</a> to "test the hell out
of zoned-storage devices" with both fstests and blktests.  There are
two modes of testing that can be done, either with real hardware or using
QEMU virtual devices.  There are some problems, currently, with the QEMU driver
for ZNS devices, Le Moal said.
</p>

<p>
Bart Van Assche wondered if there was a need to keep an eye on the standards
committees because it seems like there is a gap between the feature sets
offered by SCSI and NVMe.  Today the zoned-device code is shared for SCSI and NVMe in the
kernel, but he worries that may have to change.  In
particular, filesystems might be forced to choose which of the two types
they support.  Le Moal said that there are features in ZNS that are not
available for SCSI;  Btrfs has been trying to adapt to those differences,
for example.
</p>

<p>
Van Assche is working on Android devices with zoned storage.  The devices
are currently SCSI, but will eventually be NVMe-based; he is concerned
that the filesystem being used will have to change because of that.  Le
Moal said that the goal is that the filesystems should not have to care about
the type of the underlying device.  Several others said that because the
underlying storage technology is quite different, though, the kernel may end up with two APIs for
zoned storage.  To a certain extent, the differences in the I/O scheduler
reflect that, one attendee said.
</p>

<p>
Josef Bacik said that there should be only minimal differences that
filesystems need to be aware of in order to support zoned storage.  There
are already changes in Btrfs to support the idea of zones, but that is
about as far as things should go; anything further should be pushed out to
user space, he said.  Ts'o said that the block layer is the right place to
handle these extra features and to do so in a way that hides the underlying
differences from filesystems.  He noted that features like <a
href="/Kernel/Index/#Block_layer-Discard_operations">discard</a> are used 
by filesystems through the block-layer interface, which hides the
device differences. 
</p>

<p>
If there are new features that can provide a large benefit, storage-device
developers should have a conversation with the filesystem community about
them, Ts'o said.  If, for example, providing a hint that some data is for a
journal, such as for a filesystem or database, would make a big performance
difference, there may be a way to change the filesystems and applications to take advantage
of it.  But the benefit needs to be large and the interface to the feature
needs to be stable.  "It would probably be an <tt>ioctl()</tt>", he said to
chuckles, but he could imagine adding a feature of that sort.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer-Zoned_devices">Block layer/Zoned devices</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems">Filesystems</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_Memory-Management_and_BPF_Summit-2022">Storage, Filesystem, Memory-Management and BPF Summit/2022</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/897263/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor897970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Zoned storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 15, 2022 12:12 UTC (Wed)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/897970/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yeah, I can see one form of hiding being bad for journaling: caching random writes to a zone so they can all be written out at once<br>
<p>
caching like that could potentially wreak havoc with a journalling system, but flushing the right areas at the right times may be fraut with misunderstanding due to the difference between journal and zone sizes<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/897970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor898326"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Storage: it can only evolve to more diversity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2022 16:12 UTC (Sun)
                               by <b>abufrejoval</b> (guest, #100159)
                              [<a href="/Articles/898326/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Currently SLC vs. MLC/TLC/QLC is mostly a decision made by the SSD, slight chance it will ever by an optimal choice for the user, who will only know over time, sometimes long after the first write (and the initial decision), which speed vs. storage effiency is best for a given bit of data. The hardware in all likelyhood only needs to be told how an erase block needs to be handled, but can&#x27;t quite expose that yet at this level of granularity.<br>
<p>
And when there is an order of magnitude in difference, not even the OS may be in a good position to make that decision: you&#x27;ll have to ask the data owner via the application or service.<br>
<p>
I think the Linux community should concentrate less on stopgap attempts to follow the technical evolution and plan ahead to a much greater evolution of diverse storage technologies, because without proper abstractions, taking advantage of them will be difficult.<br>
<p>
And there perhaps one thing needs a bit more attention: Zoning decisions for a bit of data will only ever be optimal for a given point in time, so the ability to change them with measurable effort/value is key.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/898326/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
