        <!DOCTYPE html>
        <html lang="en">
        <head><title>vmsplice(): the making of a local root exploit [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/268783/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/268171/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/268783/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>vmsplice(): the making of a local root exploit</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 12, 2008</br>
           </div>
As this is being written, distributors are working quickly to ship kernel
updates fixing the local root vulnerabilities in the <tt>vmsplice()</tt>
system call.  Unlike a number of other recent vulnerabilities which have
required special situations (such as the presence of specific hardware) to
exploit, these vulnerabilities are trivially exploited and the code to do
so is circulating on the net.  Your editor found himself wondering how such
a wide hole could find its way into the core kernel code, so he set himself
the task of figuring out just what was going on - a task which took rather
longer than he had expected.
<p>

The <tt>splice()</tt> system call, remember, is a mechanism for creating
data flow plumbing within the kernel.  It can be used to join two file
descriptors; the kernel will then read data from one of those descriptors
and write it to the other in the most efficient way possible.  So one can
write a trivial file copy program which opens the source and destination
files, then splices the two together.  The <tt>vmsplice()</tt> variant
connects a file descriptor (which must be a pipe) to a region of user
memory; it is in this system call that the problems came to be.
<p>

The first step in understanding this vulnerability is that, in fact, it is
three separate bugs.  When the word of this problem first came out, it was
thought to only affect 2.6.23 and 2.6.24 kernels.  Changes to the
<tt>vmsplice()</tt> code had caused the omission of a couple of important
permissions checks.  In particular, if the application had requested that
<tt>vmsplice()</tt> move the contents of a pipe into a range of memory, the
kernel didn't check whether that application had the right to write to that
memory.  So the exploit could simply write a code snippet of its choice
into a pipe, then ask the kernel to copy it into a piece of kernel memory.
Think of it as a quick-and-easy rootkit installation mechanism.
<p>

If the application is, instead, splicing a memory range into a pipe, the
kernel must, first, read in one or more <tt>iovec</tt> structures
describing that memory range.  The 2.6.23 <tt>vmsplice()</tt> changes omitted
a check on whether the purported <tt>iovec</tt> structures were in readable
memory.  This looks more like an information disclosure vulnerability than
anything else - though, as we will see, it can be hard to tell sometimes.
<p>

These two vulnerabilities (CVE-2008-0009 and CVE-2008-0010) were patched in
the <a href="http://lwn.net/Articles/268419/">2.6.23.15</a> and <a
href="http://lwn.net/Articles/268420/">2.6.24.1</a> kernel updates,
released on February&nbsp;8.
<p>

On February 10, Niki Denev <a href="/Articles/268786/">pointed out</a> that
the kernel appeared to be still vulnerable after the fix.  In fact, the
vulnerability was the result of a different problem - and it is a much worse one, in
that kernels all the way back to 2.6.17 are affected.  At this point, a
large proportion of running Linux systems are vulnerable.  This one has
been fixed in the <a href="http://lwn.net/Articles/268662/">2.6.22.18</a>,
<a href="http://lwn.net/Articles/268663/">2.6.23.16</a>, and <a
href="http://lwn.net/Articles/268664/">2.6.24.2</a> kernels, also released
on the 10th.  At this point, with luck, all of these bugs have been firmly
stomped - though, now, we need to see a lot of distributor updates.
<p>

The problem, once again, is in the memory-to-pipe implementation.  The
function <tt>get_iovec_page_array()</tt> is charged with finding a set of
<tt>struct page</tt> pointers corresponding to the array of <tt>iovec</tt>
structures passed in by the calling application.  Those pointers are stored
in this array:
<p>
<pre>
    struct page *pages[PIPE_BUFFERS];
</pre>
<p>
Where <tt>PIPE_BUFFERS</tt> happens to be 16.  In order to avoid
overflowing this array, <tt>get_iovec_page_array()</tt> does the following
check:
<p>
<pre>
    npages = (off + len + PAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT;
    if (npages > PIPE_BUFFERS - buffers)
	npages = PIPE_BUFFERS - buffers;
</pre>
<p>
Here, <tt>off</tt> is the offset into the first page of the memory to be
transferred, <tt>len</tt> is the length passed in by the application, and
<tt>buffers</tt> is the current index into the <tt>pages</tt> array.
<p>
Now, if we turn our attention to <a
href="http://www.milw0rm.com/exploits/5092">the exploit code</a> for a
moment, we see it
setting up a number of memory areas with <tt>mmap()</tt>; some of that
setup is not necessary for the exploit to work, as it turns out.  At the
end, the code does this (edited slightly):
<p>
<pre>
    iov.iov_base = map_addr;
    iov.iov_len  = ULONG_MAX;
    vmsplice(pi[1], &amp;iov, 1, 0);
</pre>
<p>
The <tt>map_addr</tt> address points to one of the areas created with
<tt>mmap()</tt> which, crucially, is significantly more than
<tt>PIPE_BUFFERS</tt> pages long.  And the length is passed through as the
largest possible <tt>unsigned long</tt> value.
<p>
Now let's go back to <tt>fs/splice.c</tt>, where the <tt>vmsplice()</tt>
implementation lives.  We note that, prior to the fix, the
kernel did not check whether the memory area pointed to by the
<tt>iovec</tt> structure was readable by the calling process.  Once again,
this looks like an information disclosure vulnerability - the process could
cause any bit of kernel memory to be written to the pipe, from which it
could be read.  But the exploit code is, in fact, passing in a valid
pointer - it's just the length which is clearly absurd.
<p>
Looking back at the code which calculates <tt>npages</tt>, we see
something interesting:
<p>
<pre>
    npages = (off + len + PAGE_SIZE - 1) &gt;&gt; PAGE_SHIFT;
    if (npages > PIPE_BUFFERS - buffers)
	npages = PIPE_BUFFERS - buffers;
</pre>
<p>
Since <tt>len</tt> will be <tt>ULONG_MAX</tt> when the exploit runs, the
addition will cause an integer overflow - with the effect that
<tt>npages</tt> is calculated to be zero.  Which, one would think, would
cause no pages to be examined at all.  Except that there is an unfortunate
interaction with another part of the kernel.
<p>

Once <tt>npages</tt> has been calculated, the next line of code looks like
this:
<p>
<pre>
    error = get_user_pages(current, current-&gt;mm,
		       	   (unsigned long) base, npages, 0, 0,
		       	   &amp;pages[buffers], NULL);
</pre>
<p>
<tt>get_user_pages()</tt> is the core memory management function used to
pin a set of user-space pages into memory and locate their <tt>struct
page</tt> pointers.  While the <tt>npages</tt> variable passed as an
argument is an unsigned quantity, the prototype for
<tt>get_user_pages()</tt> declares it as a simple <tt>int</tt> called <tt>len</tt>.  And, to
complete the evil, this function processes pages in a
<tt>do&nbsp;{}&nbsp;while();</tt> loop which ends thusly:
<p>
<pre>
	len--;
    } while (len &amp;&amp; start &lt; vma-&gt;vm_end);
</pre>
<p>
So, if <tt>get_user_pages()</tt> is passed with a <tt>len</tt> argument of
zero, it will pass through the mapping loop once, decrement <tt>len</tt> to a
negative number, then continue faulting in pages until it hits an address
which lacks a valid mapping.  At that point it will stop and return.  But,
by then, it may have stored far more entries into the <tt>pages</tt> array
than the caller had allocated space for.
<p>
The practical result in this case is that <tt>get_user_pages()</tt> faults
in (and stores <tt>struct page</tt> pointers for) the entire region mapped
by the exploit code.  That region (by design) has more than
<tt>PIPE_BUFFERS</tt> pages - in fact, it has three times that many, so 48
pointers get stored into a 16-pointer array.  And this turns the failure to read-verify
the source array  into a buffer overflow vulnerability
within the kernel.  Once that is in place, it is a relatively
straightforward exercise for any suitably 31337 hacker to cause the kernel
to jump into the code of his or her choice.  Game over.  (<b>Update</b>: as
a linux-kernel reader <a href="/Articles/269532/">pointed out</a>, the
story is a little more complicated still at this point; this is an unusual
sort of buffer overflow attack).
<p>

The <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=712a30e63c8066ed84385b12edbfb804f49cbc44;hp=25f666300625d894ebe04bac2b4b3aadb907c861">fix</a>
which was applied simply checks the address range that the 
application is trying to splice into the pipe.  Since a range of length
<tt>ULONG_MAX</tt> is unlikely to be valid, the vulnerability is closed -
as are any potential information disclosure problems.
<p>
This vulnerability is a clear example of how a seemingly read-only
vulnerability can be escalated into something rather more severe.  It also
shows what can happen when certain types of sloppiness find their way into
the code - if <tt>get_user_pages()</tt> is asked to get zero pages, that's
how many it should do.  Your editor is working on a patch to clean that up
a bit.  Meanwhile, everybody should ensure that they are running current
kernels with the vulnerability closed.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Vulnerabilities">Security/Vulnerabilities</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#splice">splice()</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel">Linux kernel</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Vulnerabilities-Privilege_escalation">Vulnerabilities/Privilege escalation</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/268783/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor268801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 0:46 UTC (Tue)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/268801/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
It's also a good reason for checking ranges. Putting unsigned values into signed variables
could do all kinds of ugly things, as could the reverse, or any other unwise casting of types.
The fact that so few bugs of this kind have turned up over the entirety of the kernel lifespan
merits applause to the superb kernel coders out there, but as this illustrates, these sorts of
bugs happen even to the best.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 0:48 UTC (Tue)
                               by <b>jwb</b> (guest, #15467)
                              [<a href="/Articles/268803/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Can anyone explain why the fix only applied to len and not off?  Is it because the base
address does not come from userspace?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268836"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 9:11 UTC (Tue)
                               by <b>and</b> (guest, #2883)
                              [<a href="/Articles/268836/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
If my understanding of this is correct, then off is the offset within the 
first page (i.e. off is always smaller than PAGE_SIZE).
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268836/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 22:48 UTC (Tue)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/269024/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
If it's just casting, then fixing an unexploitable casting bug is tidier than leaving it,
explicitly states intention, and prevents these souped-up aggressive optimizing compilers used
on the kernel from optimizing in a problem sometime down the road. On the other hand,
unnecessary changes introduce risks of adding as many problems as they fix.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor268806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 1:10 UTC (Tue)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/268806/">Link</a>] (39 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
One of the several things over the years that has kept my nose firmly outside of the kernel
source tree is the strong and regular repugnance I feel when delving inside - I mean, look at
the number of ad-hoc calculations, bitshifts and whatnot mentioned in this article. Look at
the escalation of a simple bug into a major one by moving a single test to the end of the loop
in get_user_pages().

How much of a size/performance win was gained in return for sacrificing nice, simple
abstractions (or even just a bunch of well documented macros!), and simple, readable loops?

I notice that the NetBSD kernel bears some of the same resemblance. I will quite shamelessly
say that my userland C code never has, nor ever will look as ugly, unreadable, or ultimately
undocumented as most of the code in kernel space. Is this part of the
genius-hacker-pissing-contest culture? I (nor my current employer) would ever hire someone
that wrote code like this.

Sorry, rant over. Perhaps I'm just a stupid noob, or perhaps I have a hint of professionalism.
I can never quite work that out.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Argument goes back to Athens</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 3:08 UTC (Tue)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/268819/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
As carried out by Plato and Aristotle, courtesy of Raphael:
<a href="http://abyss.uoregon.edu/~js/glossary/aristotle.html">http://abyss.uoregon.edu/~js/glossary/aristotle.html</a>

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268830"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 7:32 UTC (Tue)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/268830/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <p>It's easy to say in userspace code: we'll just <b>never</b> use structures as big as 2GiB or larger - then we can safely use signed offsets. Of you can use 64bit offsets if you want 4GB so badly. The problem with kernel is that both solutions are inadequate: 64bit offsets will require full-sized locking on many architectures - and that's sometimes can cost you 100-150% slowdown (or even more in rare cases), 2GB limit will make the system unusable (ask HURD guys who had such limit for partition size few years ago). Thus kernel code is full is strange arithmetic where you try to calculate something in range of terabytes (think disk) with  just 32bit integers. Of course it's not "clean and easy to read" but it's necessary if you want production kernel and not a toy.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/268830/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 12:44 UTC (Tue)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/268854/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Perhaps I misunderstood here, but I think that the original poster was saying something else -
not that you do not do all these things (strange arithmetic and suchlike), but that you keep
the code in one place (i.e. a set of macros) instead of duplicating it in lots of places.

Not that it would have helped much here, since the problem was a failure to validate user
input.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268865"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 13:50 UTC (Tue)
                               by <b>ms</b> (subscriber, #41272)
                              [<a href="/Articles/268865/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I'm obviously going to sound like a broken record again. The problem is validating incoming
data. Now you next need to ask, "why should we validate user input?" to which the answer is
"because the user can supply silly values" to which the next question is "well why can the
user to supply silly values?" to which the answer is "because the type of the values the user
is supplying are too wide". So basically, you're using the wrong types. Users should not be
allowed to present "bad" input: the type system should prevent it. In an ideal world...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268865/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268867"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 14:38 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/268867/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
That's nice in theory, but I'm not sure it's entirely practical to require the users to
provide a different pointer type for every possible VM range!

(Also, kernel/user boundaries are necessarily special places: typing across the boundary is a
matter of consensus as much as enforcement.)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268867/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268873"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 14:49 UTC (Tue)
                               by <b>ms</b> (subscriber, #41272)
                              [<a href="/Articles/268873/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Yeah, I don't disagree. It is a hard thing to do - you tend to get into messes with
dependently typed languages and so forth - one could easily argue that they're not quite ready
for writing kernels in!

Typically, you first implement maths in the type system, then you can implement a basic "is
smaller than" so then you could effectively arbitrarily refine the int range to be "the value
must be an int and must also be smaller than x". That kinda thing. Of course, as soon as you
hit "the value must be a function which will terminate", you're in trouble...!
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268873/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268880"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 15:05 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/268880/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
There are a good few languages (Cayenne and Qi spring to mind) with type systems that are so
powerful that they themselves trip the halting problem: compilation is no longer guaranteed to
terminate. :)

I suppose a simple ranged length type (length must be &gt;0) would have sufficed here: you
wouldn't need separate types for every possible valid pointer range.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268880/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Halting problem ? Ha!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 20:17 UTC (Tue)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/268995/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>C++ has them beat: it's type system is not just trigger halting problem, it's turing-complete!</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/268995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Halting problem ? Ha!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 21:00 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/269002/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
C++'s template expander is modelled on ML's pattern matching. Cayenne and 
Qi are both perhaps two generations beyond that (both type systems being 
more powerful than Haskell's) in different directions: personally I prefer 
Qi's, but part of that is probably because it's possible to bootstrap the 
Qi implementation without being an ultra-guru).

Of course, C++ compilers often *appear* to not halt when compiling 
anyway ;}
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269471"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Halting problem ? Ha!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 22:01 UTC (Thu)
                               by <b>lysse</b> (guest, #3190)
                              [<a href="/Articles/269471/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I don't know if you're joking about C++, but one of the notable things about Qi is that its
type system *is* Turing-complete, by intent and proof (someone implemented SK combinators in
it).
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269471/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269485"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Halting problem ? Ha!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2008 0:06 UTC (Fri)
                               by <b>ms</b> (subscriber, #41272)
                              [<a href="/Articles/269485/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
No, nix wasn't joking. If you use C++ templates and limit yourself to numbers then it really
is turing complete. Haskell, with the right flags (undecidable instances and overlapping
instances) is also Turing complete. Cayenne is deliberately so and many people are now really
thinking that it's just better to permit Turing completeness and let the programmer take
responsibility.

The alternative is more like what Epigram is looking at (amongst others) where you limit
recursion to on the structure of terms and prevent infinite structures. That way, you can
still guarantee termination. I fear we may now be some way from the original issue though ;)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269485/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269598"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Halting problem ? Ha!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2008 21:48 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/269598/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I used the wrong terms, really. What Haskell, Cayenne and Qi provide over 
C++ is (radically) greater *expressiveness*. The syntax of Qi type 
definitions is especially strange, but it's a hell of a lot saner than 
trying to define anything complicated using C++ templates.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269598/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor269070"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 15:45 UTC (Wed)
                               by <b>werth1</b> (guest, #48435)
                              [<a href="/Articles/269070/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
The answer to the second question "why can the user supply silly values?" is more like:
Because he can.
The user is free to chose any language he wants to interface with the kernel.
In particular the user is free to chose a language without or limited type checks.
So any range checks on system functions have to be in the kernel itself.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269070/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2008 11:28 UTC (Sat)
                               by <b>ernest</b> (guest, #2355)
                              [<a href="/Articles/269635/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
It is unfortunate that the CPU cannot enforce signedness and size types. 
Anybody programming in assembly can bypass any higher level language type 
checks you have in mind. This is true even if the users has the best 
intentions.

Ernest.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269744"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This code is there not for performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2008 19:50 UTC (Sun)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/269744/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
It is unfortunate that the CPU cannot enforce signedness and size types. 
</blockquote>
<p>
The unfortunateness is at a lower level than that.  It's unfortunate that a CPU can't do ordinary integer math, where 2 + 2 = 4.  I understand why the very first CPUs wrapped around integers -- it happens naturally with the simplest implementations.  But I don't get why no CPU today provides even the option of trapping on an arithmetic overflow instead of wrapping around silently.  They do it for floating point, but not for integers.

      
          <div class="CommentReplyButton">
            <form action="/Articles/269744/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor270598"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trapping on overflow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2008 21:45 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/270598/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>But I don't get why no CPU today provides even the option
of trapping on an arithmetic overflow.</blockquote>

MIPS and Alpha have separate arithmetic instructions that trap on
signed overflow (e.g., ADD on MIPS and ADDV on Alpha).  IA-32 has INTO
which traps if OF is set.  Apparently this instruction was so rarely
used by programmers, that AMD64 removed it in order to free up some
opcode space, and did not even bother to allocate another (multi-byte)
opcode for it; but you can still implement the functionality by
combining JO (or JNO) with INT.
<p>The existence of INTO has not helped against this security hole, though.

      
          <div class="CommentReplyButton">
            <form action="/Articles/270598/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor270602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trapping on overflow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2008 22:24 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/270602/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
MIPS and Alpha have separate arithmetic instructions that trap on signed overflow ...
</blockquote>
<p>
Nice.  Do you know if there is any way to make GCC (or any other C compiler) generate such instructions?
<p>
I can understand people resisting adding instructions to handle overflow, but if I could declare in my C program "no arithmetic in here is supposed to wrap around" and get signalled to death if it does, I'd do it a lot.

      
          <div class="CommentReplyButton">
            <form action="/Articles/270602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor271274"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trapping on overflow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 28, 2008 21:23 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/271274/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Apart from asm statements and modifying gcc I don't know of a way to
get gcc or other compilers to use the trapping instructions for C
code.

<p>Concerning "no arithmetic in here is supposed to wrap around",
unsigned arithmetic is supposed to wrap around in standard C, only
signed arithmetic is allowed to trap (or do anything else) on
overflow.

      
          <div class="CommentReplyButton">
            <form action="/Articles/271274/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor269028"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Magic exists by necessity alone</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 0:19 UTC (Wed)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/269028/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Well, yes, but ideally you'd have some kind of abstraction. Since the numbers and arithmetic are "magic", they must also be impermanent and subject to continual experimentation. Possibly by a coder, possibly by the person compiling, possibly by the OS itself. As such, those need to be the components that are most easily identified and changed in a consistant way - in terms of calculations and type ranges.
<p>
Making this "pure" beyond a certain level is, agreed, problematic. You don't have infinite CPU cycles and although the compiler can do some optimization, it can't turn an abstract, general solution into something tuned to a considerably narrower range of special cases that are usable in practice that are further constrained by the implementation details of a given architecture, which is all any real-world physical computer can ever be.
<p>
A way round this would be to have some sort of hypothetical generic architecture, which implemented the formal "pure" solution but was never - and could never - actually used in practice. As all usable architectures would necessarily be perfect subsets of the "pure" solution, it no longer matters if it is easy to read, you know it's just a re-arranged and contracted form.
<p>
However, here you run into a problem. This assumes a totally generic "pure" solution even exists, wholly independent of any architecture. Since you can't use such a solution, test-run such a solution or in many cases reverse-map onto such a solution, it's not obvious you could ever show a pure solution was indeed generic or was the solution the specific implementations were specific implementations of.
      
          <div class="CommentReplyButton">
            <form action="/Articles/269028/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Magic exists by necessity alone</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2008 23:23 UTC (Fri)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/269612/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
Even if a "perfect architecture" existed such that "real machines" are "perfect subsets" (real architectures are <em>very different</em>, sometimes in very weird ways), one of the problems writing a kernel is that real hardware is as buggy (or more!) as the next software (in the end, it is algorithms implemented in silicon, with the added burden that bugs can rarely patched and the rebuilt package distributed to the users).
      
          <div class="CommentReplyButton">
            <form action="/Articles/269612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor268838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 13:18 UTC (Tue)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/268838/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
In my experience the kernel is documented where it needs to be.

Like my own code, it doesn't meet some arbitrary "programming by the book" rule about how many
comments there should be, but instead provides comments where it is expected that they would
be helpful to subsequent maintainers. Every year when I was assisting in the undergraduate
first programming class we had to first beat it into new students that they need to write
comments explaining what's going on in their code, and then beat it into them that useless
(e.g. i++; /* increment i */) explanations are worse than none at all.

Good documentation is like a good alarm system - it doesn't tell you about the ordinary, the
routine, which you are expected to already understand. Contrast AWS (a railway safety system
which alerts and requires action for all aspects except proceed, meaning it becomes more of a
routine annoyance than an actual safety aid) with ATP or TPWS (systems which do nothing until
an apparently unsafe condition occurs). Every comment is taking up space, both on the screen
and in the maintenance programmer's mind. A short function with one comment pointing at an
unusual condition for a loop may as a result be easier to comprehend than a similar function
with sixteen multi-line C++ style comments explaining mundane things you ought to be able to
pick up at a glance from the surrounding code ("this is a loop counter") or know as domain
knowledge for the system you're working on.

For example, if you work on code related to SCSI or filesytems or otherwise connected with
disks, you're expected to recognise that (bytes &gt;&gt; 9) converts from a byte count to a sector
count, since sectors are 512 bytes. Thus each incidence of this expression is not expected to
attract a comment even though it may initially seem inexplicable to someone who has never
worked with disks.

I've had to work on several parts of the Linux kernel (though I don't think any code I wrote
is currently in a Linus git repo) and I found it all satisfactorily documented. Unlike
Tanenbaum if I were grading this project I would give it at least an A minus. Maybe you're
just too sensitive - do you have trouble eating good cheese? Are you revolted by the thought
that game isn't freshly killed when its made into pies ? Not everything needs to look like
pristine sample code in order to be maintainable.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">code documented where it needs to be</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 16:12 UTC (Tue)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/268888/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Reminds me of <a 
href="http://steve-yegge.blogspot.com/2008/02/portrait-of-n00b.html">Steve 
Yegge's latest</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/268888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 16:42 UTC (Tue)
                               by <b>utoddl</b> (guest, #1232)
                              [<a href="/Articles/268889/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I basically agree with what you're saying, but I'd like to make just a couple of counter-points.
<blockquote>...beat it into them that useless
(e.g. i++; /* increment i */) explanations are worse than none at all.</blockquote>
True, that's useless to you and me, but for the noob programmer who has come through elementary and high school maths, the expression <tt>i++</tt> is not immediately obvious. By the second or third C program he should be familiar with it, certainly. But my point is that the "document what's not obvious" standard requires a judgment call where "what's obvious" varies greatly with the experience of the coder.

<blockquote>For example, if you work on code related to SCSI or filesytems or otherwise connected with disks, you're expected to recognise that <tt>(bytes >> 9)</tt> converts from a byte count to a sector count, since sectors are 512 bytes.</blockquote>

If you say so. I don't happen to work in that domain often, so it isn't obvious to me. However, a well-crafted macro <tt>BYTES2SECTORS(bytes)</tt> would give me a clue, and the magic numbers and operations on them would live in the definition of the macro, so you've got one place to maintain the conversion and it's clear to us noobs what it's related to. Again, the point isn't about this particular case, but if you can give magic numbers and operations on them a name, you can make the intent more clear (and perhaps avoid a problem, like <tt>(bytes<9)</tt>). It's already clear to somebody, but will it be clear next week, or to the next programmer who may be less experienced?
      
          <div class="CommentReplyButton">
            <form action="/Articles/268889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268946"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 18:14 UTC (Tue)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/268946/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
It is useless to the noob programmer who is looking at a piece of code with hundreds of
thousands of occurrences of the increment operator if they're all commented. It's worse than
useful to that same programmer if some but not all of them are commented (are the commented
ones somehow different?). The novice should have access to a tutorial and reference guide for
the language, and that should explain the notation. Even things which are unique to a
project's style shouldn't be documented in situ at every (or any) place they're used; they
should be documented once in a central location. So the standard should really be "comment
what's unusual about this location, given the context of the rest of the project; also
document what's unusual about this project, given the language it's written in; also have
language reference works available; and certainly don't duplicate any of this information,
since it will just get out of sync."

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268946/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269316"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 6:38 UTC (Thu)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/269316/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; &gt; For example, if you work on code related to SCSI or filesytems or otherwise connected with
disks, you're expected to recognise that (bytes &gt;&gt; 9) converts from a byte count to a sector
count, since sectors are 512 bytes.</font>

<font class="QuotedText">&gt; However, a well-crafted macro BYTES2SECTORS(bytes) would give me a clue, and the magic
numbers and operations on them would live in the definition of the macro, so you've got one
place to maintain the conversion and it's clear to us noobs what it's related to.</font>

But in the context of the kernel, hiding things in a BYTES2SECTORS macro can be downright
dangerous.  What types does it handle for input and output?  Does it sleep or have any locking
requirements?  If I pass an expression, do I have to worry about side effects if it gets
evaluated twice?  How does it behave if bytes is not a multiple of one sector?
Is it talking about the canonical 512-byte defintion of a sector or the actual 2048 byte
sectors used on CD-ROMs?

"bytes &gt;&gt; 9" is absolutely clear.  I see instantly that it handles integer types and matches
the signedness.  It is free from side effects and fast.  I know that the answer is rounded
down to the nearest whole sector.  Sectors are 512 bytes.

I don't see why you would want to hide all of that information from a developer.  Your version
is only simpler at a quick glance to a casual observer, not someone who actually has to deal
with the code and what the statement actually does.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269316/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor268972"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 19:20 UTC (Tue)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/268972/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I agree with everything you said, except...

<font class="QuotedText">&gt; you're expected to recognise that (bytes &gt;&gt; 9) converts from a byte count to a sector count</font>

Then why not define BYTES_TO_SECTORS(n) ((n)&gt;&gt;9)?  Putting this bare shift into code
introduces an informal lingo that, as it builds up, can really get in the way for new
maintainers.  True, one instance is no big deal, but trying to get up to speed on code that
has more than five or ten undocumented idioms like this is a real drag.

Even if you understand the lingo, you will likely start to think, "Ah, those are now sectors"
whenever you see &gt;&gt;9 in the code.  That's bad too.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268972/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269043"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 7:27 UTC (Wed)
                               by <b>JoeF</b> (guest, #4486)
                              [<a href="/Articles/269043/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <i>For example, if you work on code related to SCSI or filesytems or otherwise connected with
disks, you're expected to recognise that (bytes >> 9) converts from a byte count to a sector
count, since sectors are 512 bytes. </i>
<p>Hmm, no. The use of magic numbers is something <b>I</b> beat out of undergrads. Use a define, or a macro.
<br>When I do code reviews at my job, I always latch onto the use of magic numbers.
<br>And, your example is flawed, anyway. While hardware sectors may be 512 bytes (currently), filesystems usually deal with larger blocks.

      
          <div class="CommentReplyButton">
            <form action="/Articles/269043/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269318"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 6:40 UTC (Thu)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/269318/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; While hardware sectors may be 512 bytes (currently), filesystems usually deal with larger
blocks.</font>

All the more reason to be just specify it clearly at the point of use rather than hiding it
away in a #define!  See my response above too.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269318/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269435"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 19:44 UTC (Thu)
                               by <b>JoeF</b> (guest, #4486)
                              [<a href="/Articles/269435/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      You either need to add a comment, or use a define.<br>
bytes >> 9 without a clarifier is something that should <b>never</b> be in production-quality code.<br>
Magic numbers should never be in code without a clear explanation what they mean.<br>
If you don't want a macro that can hide things, write something like bytes >> SECTOR_SHIFT.

      
          <div class="CommentReplyButton">
            <form action="/Articles/269435/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269442"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 20:42 UTC (Thu)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/269442/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; You either need to add a comment, or use a define.</font>
bytes &gt;&gt; 9 without a clarifier is something that should never be in production-quality code.
Magic numbers should never be in code without a clear explanation what they mean.  If you don't
want a macro that can hide things, write something like bytes &gt;&gt; SECTOR_SHIFT.

If one doesn't want to hide things, hide it inside "SECTOR_SHIFT"?
I'm sorry, I remain unconvinced.
Using "&gt;&gt; 9" is essentially a comment saying "I'm converting this to a 512-byte sector count".
It's such a fundamentally basic operation that anyone working with filesystem or disk code
would understand it immediately.

Abstracting common constants is most useful when they might change, and they're just arbitrary
to begin with -- HZ for example.  Or things that actually have no real meaning, like magic
numbers that identify a filesystem.  For a number that has a real, well-known meaning, and for
which changing would involve huge logic changes in the code, I think macros like that are just
extra levels of obfuscation.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269442/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269508"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2008 6:54 UTC (Fri)
                               by <b>JoeF</b> (guest, #4486)
                              [<a href="/Articles/269508/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <i>Using ">> 9" is essentially a comment saying "I'm converting this to a 512-byte sector count".</i>
<p>No. It only says that you shift a value by 9 bits to the right.
<br>It may say to <b>you</b> that you are converting a value to a 512-byte sector count. It does <b>not</b> necessarily say that to others.

<p><i>It's such a fundamentally basic operation that anyone working with filesystem or disk code
would understand it immediately.</i>
<p><b>That</b> mindset is what results in a lot of the flaws in all kinds of code. There <b>will</b> always be somebody working on the code for whom it isn't obvious. I venture that if you can't see that, you must still be in your first job and haven't yet had the task to maintain somebody else's code. I can tell you from (painful) experience that this kind of stuff is among the worst stuff out there.<br> ">>9" makes implicit assumptions, and implicit assumptions, even if they may seem reasonable to the original author, are often not obvious to maintainers, possibly years down the road.
<br>Oh, and just in case, I <b>am</b> writing filesystem code. I would never even get the idea to write something like ">>9" without a comment, or better, in a macro.

      
          <div class="CommentReplyButton">
            <form action="/Articles/269508/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269512"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2008 7:43 UTC (Fri)
                               by <b>jimparis</b> (guest, #38647)
                              [<a href="/Articles/269512/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; I venture that if you can't see that, you must still be in your</font>
<font class="QuotedText">&gt; first job and haven't yet had the task to maintain somebody else's code.</font>

And I venture that, in my experience (which is not as limited as you impolitely presume),
"somebody else's code" is a whole lot more difficult to work with when I have to dig through
arbitrary levels of opaque macros to figure out what they're really trying to do.

Clearly we have a difference in opinion.  I prefer in code that is written clearly enough to
be self-explanatory.  Consider:
  inode-&gt;i_blocks = bytes &gt;&gt; 9;
vs:
  inode-&gt;i_blocks = BYTES_TO_BLOCKS(bytes);

If you maintain that the second version conveys more information than the first, then I'm
afraid we will just have to disagree.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269512/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269623"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2008 1:52 UTC (Sat)
                               by <b>dododge</b> (guest, #2870)
                              [<a href="/Articles/269623/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; Consider:</font>
<font class="QuotedText">&gt;   inode-&gt;i_blocks = bytes &gt;&gt; 9;</font>
<font class="QuotedText">&gt; vs:</font>
<font class="QuotedText">&gt;   inode-&gt;i_blocks = BYTES_TO_BLOCKS(bytes);</font>

It's a bit of an unfair example, though, because you're computing
against a value called "bytes" and assigning it to something called
"blocks".  You've put enough context around the expression to make
it clear what the shift is trying to accomplish.

The problem is when someone assumes "&gt;&gt; 9" is inherently
self-documenting and throws it into the middle of a much more
complex statement.  Consider:

  process_frag_2(sig,(get_ent(curr) &gt;&gt; 9) + 2,HEX_ENCODE);
vs:
  process_frag_2(sig,BYTES_TO_BLOCKS(get_ent(curr)) + 2,HEX_ENCODE);

When I'm reading code, I'd much rather see the latter.  It doesn't
just tell me why the shift is being done; it even adds useful
information about the APIs for get_ent() and process_frag_2().





</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269623/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269651"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2008 17:13 UTC (Sat)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/269651/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I guess we will disagree.  Your way is still hostile to new maintainers because it carries so
much implicit information.  What if your code code has this?

   inode-&gt;i_blocks = bytes &gt;&gt; 8;

What is a new maintainer to think?  Even if he does recognize that this expression is
different from the others, he's still confused.  Did you auto-optimize the expression (bytes
&gt;&gt; 9)*2?  Is it typoed or a thinko?

Will every potentially confusing use of the shift operator in your code include a comment
stating the author's intention?  If so, then will that convention still be true once someone
else has modified your code?

Also, you've given yourself a rather heavy restriction on variable naming haven't you?  Will
all your variable names really contain "blocks" and "bytes" as appropriate?  You'll probably
want to add this restriction as a comment to each file to which it applies or it won't last
long once other people start committing patches to your code!

Finally, your technique only works for trivial expressions like assignment.  What happens if
you need to actually perform a calculation?

A BYTES_TO_BLOCKS macro solves all these problems by making the conversion explicit.  Implicit
rules and unwritten conventions always make life hard for new maintainers.  Always.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269651/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor314460"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 11, 2009 4:06 UTC (Sun)
                               by <b>dibbles_you</b> (guest, #45004)
                              [<a href="/Articles/314460/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
cd /to/linux/kernel<br>
# find . -name "*.c" | xargs grep "&gt;&gt;" | awk -F "&gt;&gt;" '{ for(n=2;n&lt;=NF;n++) { $c=$n; sub(/^=/,"",$c); sub(/ /,"",$c); gsub(/\(/,"",$c); gsub(/\)/,"",$c); $c=substr($c,1,1); if ($c&gt;='0' &amp;&amp; $c&lt;='9') print "number"; else print "text"; } }' &gt; a<br>
# cat a| grep text | wc -l<br>
# cat a| grep number | wc -l<br>
<p>
number=19877<br>
text=4936<br>
<p>
so it would seem the linux kernel believes numbers are usually clearer for others to read and understand.<br>
<p>
if you believe otherwise submit a patch to the kernel removing all occurrences and replacing them with meaningful #defines.<br>
<p>
#define 'ing all numbers is stupid, using identifiers that describe what they are should allow anybody to understand their context, if you use lots of operators and numbers in a single expression split them up to use multiple variables with appropriate names, if they are in conditions use multiple conditions with comments if necessary.  The compiler will optimize all these away and make your code more readable without have 15 editors open or using code navigators to work out that the actual value of CLUSTERS_DIVIDE_BY_BYTES_IN_SECTORS_MULTIPLIED_BY_PI(x) is 2.<br>
<p>
PS. the script is an approximation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/314460/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor269111"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 17:09 UTC (Wed)
                               by <b>landley</b> (guest, #6789)
                              [<a href="/Articles/269111/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
It's easier for you to read what you wrote than it is for you to read what 
someone else wrote, therefore the problem is with the other person?

Reading code is always harder than writing code.  When you write code, by 
definition you have a working model of the code in your head and 
understand all the concepts involved (or it won't work).  When you read 
someone else's code, even well commented source code, you're trying to 
reverse engineer their thought process based on a machine they built which 
was primarily designed to function, not to teach.

Beyond that, working code is often complicated because it has to deal with 
the real world rather than a theoretical model.

Go read this:
<a href="http://www.joelonsoftware.com/articles/fog0000000069.html">http://www.joelonsoftware.com/articles/fog0000000069.html</a>


</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269111/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269117"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 17:34 UTC (Wed)
                               by <b>landley</b> (guest, #6789)
                              [<a href="/Articles/269117/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
So code other people wrote is harder for you to read than code you wrote.  
Join the club.  For code you wrote, you'd better have a complete 
theoretical model in your head or it won't work.  For other people's code, 
you're trying to reverse engineer their thought process by taking apart a 
machine they built.

So if you haven't figured out yet that source code is inherently harder to 
read than it is to wrote, or that working code accumulates complexity as 
it has to deal with a real world that does not cleanly match simple 
theoretical models, you're definitely on the "newb" side rather than 
the "professional" side.

Read this:
<a href="http://www.joelonsoftware.com/articles/fog0000000053.html">http://www.joelonsoftware.com/articles/fog0000000053.html</a>

And note how much else out there agrees with it:
<a href="http://www.spinellis.gr/codereading/">http://www.spinellis.gr/codereading/</a>
<a href="http://withoutane.com/rants/2007/when-you-read-code">http://withoutane.com/rants/2007/when-you-read-code</a>
<a href="http://blogs.msdn.com/oldnewthing/archive/2007/04/06/2036150.aspx">http://blogs.msdn.com/oldnewthing/archive/2007/04/06/2036...</a>

and so on...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269117/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 18:03 UTC (Wed)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/269141/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
As a matter of diligence I (like many, many people) document large swathes of my code in the
form of comments. Basically anywhere it has taken me more than a moment to think about, or
where the purpose of the code cannot be inferred by reading API documentation for the calls
made inside it.

Magical integer literals and bitshifts fall well within this purview, and I cannot see it as
"noobness" in these two specific cases. Imagine someone had to go back and fix all those
bitshifts when we move to Some New Compiler (in Some Hypothetical Future). Can't be regexed,
no central place where a change can ripple through the tree, and utterly dangerous, say, if
this New Compiler takes advantage of the fact that bitwise right shift on a signed number is
undefined according to ANSI C (I'm taking this as one, single example. There are hundreds
more).

I understand that other peoples' code is difficult to comprehend. Hell, I've read more than my
fair worth of Other Peoples' Code. I'm talking specifically about why the Linux kernel seems
to be so full of this, but other commenters have given good reasons for some of this already.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">code obfuscation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2008 1:21 UTC (Sat)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/269621/">Link</a>] 
      </p>
      
      </div>
      </summary>
      True. Any idiot can obfuscate his or her code, but it takes work and wit to make legible code.
      
          <div class="CommentReplyButton">
            <form action="/Articles/269621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor268807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 1:13 UTC (Tue)
                               by <b>dougg</b> (guest, #1894)
                              [<a href="/Articles/268807/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Looks like Debian is first out of the blocks. [Several of my machines running  debian etch 4.0
(i386) have new kernels (2.6.18) now. Sadly my slug (NSLU2) running etch 4.0 has not yet been
fixed.] As I write there has been no update for Fedora 8 or Ubuntu server 7.10 ...

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268809"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 1:30 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/268809/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Fedora updates are in our mailbox now, haven't seen a whole lot of others yet.
      
          <div class="CommentReplyButton">
            <form action="/Articles/268809/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 1:37 UTC (Tue)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/268810/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
"suser-jengelh/SUSE-10.3" repository updated as of Feb 12 01:18 UTC.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268815"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 2:09 UTC (Tue)
                               by <b>mrons</b> (subscriber, #1751)
                              [<a href="/Articles/268815/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I took the fedora update  kernel-2.6.23.15-137.fc8 straight from the build system
(koji.fedoraproject.org) about 21 hours ago.

I couldn't wait for it to be distributed to the mirrors, I have lots of students with shell
accounts that read slashdot!
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268815/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268834"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 8:17 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/268834/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
It is too late. Now you have lots of new co-system-administrators. ;)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268834/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 11:49 UTC (Tue)
                               by <b>Velmont</b> (guest, #46433)
                              [<a href="/Articles/268844/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
You could always had used the quick hotfix to disable vmsplice (no reboot necessary):

<a href="http://www.ping.uio.no/~mortehu/disable-vmsplice-if-exploitable.c">http://www.ping.uio.no/~mortehu/disable-vmsplice-if-explo...</a>
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 18:58 UTC (Tue)
                               by <b>incase</b> (guest, #37115)
                              [<a href="/Articles/268970/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
That "fix" is even worse than the problem itself:
It first tries wether the exploit works and overwrites parts of kernel memory on the way.
If your machine only has few and trusted users, don't use it. If you have untrusted users (or
anticipate having some remote exploit allowing the attacker to execute his code under some
(non-root) account, it would be better to shut down the machine until you have an updated
kernel installed. Either by patching your kernel yourself or by installing a distribution
kernel with the fixes in it.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269049"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 10:52 UTC (Wed)
                               by <b>Velmont</b> (guest, #46433)
                              [<a href="/Articles/269049/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
If you use the new hotfix, it will *not* use the exploit to get root but just disable
vmsplice.

Morten Hustveit made the patch while waiting for a pizza delivery, and didn't look at the
exploit - now the second version enables sysadmins to disable vmsplice more securely. ;-)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269049/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor268820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 4:25 UTC (Tue)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/268820/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Slackware patched the kernel for both -current and -stable as of 0100 UTC (6:00 PM CST), according to the ChangeLogs <a title="Slackware-current ChangeLog" href="ftp://ftp.slackware.com/pub/slackware/slackware-current/ChangeLog.txt">-current</a> and <a title="Slackware-stable ChangeLog" href="ftp://ftp.slackware.com/pub/slackware/slackware-12.0/ChangeLog.txt">-stable</a>.</p>

<p>The -current fix involves upgrading to Kernel 2.6.23.16, whereas the -stable fix appears to be a backported patch to 2.6.21.5 (which shipped with Slackware 12.0 back in July).</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268824"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 5:38 UTC (Tue)
                               by <b>afalko</b> (guest, #37028)
                              [<a href="/Articles/268824/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
For all those curious about Gentoo:

I use vanilla-sources-2.6.24 in Gentoo; I needed to package.keyword vanilla-sources and mask
2.6.25.

gentoo-sources, which is supported by Gentoo security had 2.6.23.16 kernel stable within about
a day and half.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268824/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268831"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 7:38 UTC (Tue)
                               by <b>jmm</b> (subscriber, #34596)
                              [<a href="/Articles/268831/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Updates for arm will be released soon. They're built from the same source package as the other
kernel images, but since arm is slow to compile and rarely used in a multiuser environment we
decided to go ahead with the other archs.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268831/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269023"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">distro update progress</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 22:40 UTC (Tue)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/269023/">Link</a>] 
      </p>
      
      </div>
      </summary>
      My slug (NSLU2) running etch is now updated with linux-image-2.6.18-6-ixp4xx. Thanks! Debian rocks (as usual).
      
          <div class="CommentReplyButton">
            <form action="/Articles/269023/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor270599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">for the record</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2008 22:06 UTC (Sat)
                               by <b>gvy</b> (guest, #11981)
                              [<a href="/Articles/270599/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
* Sun Feb 10 2008 Sergey Vlasov &lt;vsu@altlinux&gt; 2.6.18-alt12
- Security-related changes:
  + CVE-2008-0600: splice: fix user pointer access in get_iovec_page_array()
  + check iovec buffers in __bio_map_user_iov() (fixes issue with SG_IO)
  + guard against attempts to call get_user_pages() for 0 pages
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/270599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor268813"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gentoo's gentoo-sources updated</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 1:43 UTC (Tue)
                               by <b>dberkholz</b> (guest, #23346)
                              [<a href="/Articles/268813/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Gentoo isn't currently sending out GLSAs for kernels because we have something like 50 kernel
sources and not enough people, but at least the primary, recommended one (gentoo-sources) has
been updated since yesterday.

(Unrelated: the comments didn't have a Reply link, so I had to stick this in a new thread.)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268813/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268857"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 12:57 UTC (Tue)
                               by <b>hummassa</b> (guest, #307)
                              [<a href="/Articles/268857/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; (Unrelated: the comments didn't have a Reply link, so I had to stick</font>
<font class="QuotedText">&gt; this in a new thread.)</font>

What happened to the "reply" button?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268857/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268862"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 13:22 UTC (Tue)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/268862/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I've definitely seen this phenomenon. I'm not quite sure how it happens, but it seems to be
possible to be in a state where the site doesn't give you any reply buttons, yet you're
allowed to read the article (so you're presumably logged in as a paying customer). Maybe
(editors?) we should try to pin down when exactly this happens ?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268862/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268869"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 14:44 UTC (Tue)
                               by <b>jake</b> (editor, #205)
                              [<a href="/Articles/268869/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
If anyone sees that problem again, I'd love to figure it out and fix it.  The source of a page
that exhibits this behaviour might help.  Also, does anyone remember if *all* comments had no
"Reply ..." button or if it was just one?

Rather than clutter the thread, email to jake, you can probably guess the domain, is fine.

thanks,

jake
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268869/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268886"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 16:10 UTC (Tue)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/268886/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
The one time I saw it, it was all comments missing the button, and 
reloading the page fixed the problem.  And I was using Konqueror as my 
browser.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268886/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269347"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 11:51 UTC (Thu)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/269347/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I've seen this repeatedly with Firefox, probably because I always throw out all browser
cookies on exit; the refresh trick always fixes it.

This is how the problem occurs for me:

1. I'm not logged in and click on an article that requires subscription; LWN informs me that I
can't see this article.
2. I click on "log in to read this article"; <a href="https://lwn.net/login?target=/Articles/268783/">https://lwn.net/login?target=/Articles/268783/</a>
3. After filling in username and password, I'm redirected to the
<a href="http://lwn.net/Articles/268783/">http://lwn.net/Articles/268783/</a> page without the "reply to this comment" buttons -- as if LWN
thought I wasn't logged in.
4. Reloading the page makes the buttons appear.

To reproduce the bug again, I have to clear my cache (!) after logging out. This would suggest
that it depends on some external dependency (like CSS or JavaScript) that varies depending on
login, but gets cached pre-login by the browser. However I couldn't find such dependencies on
the LWN site.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269347/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269371"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply: FireFox versus CSS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 14:42 UTC (Thu)
                               by <b>hummassa</b> (guest, #307)
                              [<a href="/Articles/269371/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I think it is a CSS problem. As I use non-standard colors, when I do the same operation ("log
in to read this article"), it comes back with the default colors instead of my colors. At this
point, I refresh the page... hence I don't encounter the "no buttons" problem.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269371/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269924"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2008 8:09 UTC (Tue)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/269924/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>So it turns out that this indeed is the problem; the stylesheet file sizes only differ in one byte so I didn't catch the difference the first time (I thought they were equal).</p>

<pre>
--- lwn_logged_out.css  2008-02-19 09:58:38.000000000 +0200
+++ lwn_logged_in.css   2008-02-19 09:57:04.000000000 +0200
@@ -135,7 +135,7 @@
 DIV.CommentBody { padding: 0px 4px 0px 4px; }
 P.CommentPoster { margin-top: 0px; }

-div.CommentReplyButton { display: none;
+div.CommentReplyButton { display: block;
                         text-align: right;
                         padding: 4px; }

</pre>
<p>The problem here is browser cache. When the user first visits LWN.net, not having logged in yet, the browser downloads <tt>/CSS/lwn</tt> which specifies that <tt>div.CommentReplyButton</tt> should be hidden.</p>
<p>Later when the user does log in, the browser doesn't bother re-fetching the stylesheet because it already has this URL cached. The Right Way to fix this is to have different stylesheet URLs depending on whether the user is logged in -- rather than using magic stylesheets.</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269924/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor269535"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">OT: reply</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2008 15:07 UTC (Fri)
                               by <b>madscientist</b> (subscriber, #16861)
                              [<a href="/Articles/269535/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I see this happen somewhat often using FireFox too.  As you say, the buttons are ALL missing,
and a reload takes care of it.  I checked the source once on these but it looked fine: the CSS
for the buttons was all there.  They just didn't show up.

I've also had situations where the front page says there are replies, but when I click the
link I don't see any replies.  Then if I reload, the replies appear!  This happens more
rarely, but it's happened more than once.

At first I thought it was because I was using the greasemonkey add-on to distinguish between
read and unread comments, but I've since turned that off and I still see both of these
problems.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269535/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor268916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linus saw it coming</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 17:12 UTC (Tue)
                               by <b>proski</b> (subscriber, #104)
                              [<a href="/Articles/268916/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      Linus actually criticized vmsplice() from the performance standpoint.  But his reference to "VM games" seems highly relevant to this issue.  From <a href="http://kerneltrap.org/node/6506">http://kerneltrap.org/node/6506</a>:
<blockquote type="cite">
"I claim that Mach people (and apparently FreeBSD) are incompetent idiots. Playing games with VM is bad. memory copies are _also_ bad, but quite frankly, memory copies often have _less_ downside than VM games, and bigger caches will only continue to drive that point home."
</blockquote>
Having more than one way to do something has a downside.  The less used way is less tested and less reviewed for security.
      
          <div class="CommentReplyButton">
            <form action="/Articles/268916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor268964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linus saw it coming</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 18:55 UTC (Tue)
                               by <b>eSk</b> (guest, #45221)
                              [<a href="/Articles/268964/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Except that vmsplice() does not fall under the category of "VM games" since it does not actually go about modifying the page tables of the applications.  Also Linus was referring to the <em>performance</em> downsides of playing "VM games".  Considering that splice() and vmsplice() were added purely for performance reasons it would have been quite hypocritical to add vmsplice() to improve performance (if vmsplice() actually did play "VM games", that is).  I'm not familiar with his criticism of vmsplice() from the performance standpoint that you refer to.

<p>It should also be noted that Linus was in this quote quite wrong in his contempt for FreeBSD developers.  FreeBSD developers were (and are) very much aware of the issues at hand.  That's why the zero-copy socket option was disabled by default.
      
          <div class="CommentReplyButton">
            <form action="/Articles/268964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linus saw it coming</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 19:14 UTC (Tue)
                               by <b>rfunk</b> (subscriber, #4054)
                              [<a href="/Articles/268974/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
No, Linus was promoting vmsplice there, not criticizing it.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 21:15 UTC (Tue)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/268999/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <p>This is place where Linus misses the point completely: there are <b>no</b> "bigger cache sizes". There will never be "bigger cache sizes". <b>Never</b>. Pentium had 16 KiB L1 cache in 1993, PowerPC 601 had 32 Kib cache in 1993! Today... Latest and greatest Itanium has 16 KiB L1D + 16 KiB L1I cache, Inter Core 2 uses 32 KiB L1D + 32 KiB L1I caches and biggest caches of POWER6 and AMD Phenom are reaching just 64 KiB L1D + 64 KiB L1I! Basically two times increase in <b>15 years</b>! I'm not sure we'll <b>ever</b> see anything bigger than 256KiB "cache" (local RAM) in Cell.</p>

<p>So while "cheep, slow" RAM is abundant resource L1 is as precious today as it was 10 years ago and as it will be 10 years from now! Use L1 <b>very</b> sparingly!</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/268999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 22:04 UTC (Tue)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/269018/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I think you're missing the point here.

L1 cache is, as I understand it, about as fast as chip registers.  So that 16 KB cache has
grown faster and faster over the years.

What is L2 and L3 cache now is *huge* and is likely as fast if not faster than that 1993
Pentium's 16 KB cache.

And all chip cache is hugely faster than system RAM.  Look at benchmarks that show the
optimization of certain algorithms.  When they use cache-optimized blocks instead of streaming
over the entire data set, performance improves a hundred fold in some cases.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269025"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 22:51 UTC (Tue)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/269025/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Moore's law is still valid: transistors on a chip are doubling every 18 months. However clock speeds are not getting any faster; my old PIV was running at 3.2 GHz, and you seldom see those speeds nowadays. So guess where many (if not most) of all those extra transistors are going. Yep, into the caches.
      
          <div class="CommentReplyButton">
            <form action="/Articles/269025/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 20:23 UTC (Wed)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/269235/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
In mainstream consumer CPUs, maybe the clocks have stabilized (which IS a good thing, we
already waste too much power just to do office work).

Look at the IBM Power6 for some high-clock cores...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor270261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2008 9:53 UTC (Thu)
                               by <b>renox</b> (guest, #23785)
                              [<a href="/Articles/270261/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt;Look at the IBM Power6 for some high-clock cores...</font>

Except that apparently they had a lot of difficulty ramping up the clock..
Plus their CPU does *in order* integer processing which induce a loss of efficiency..

It'd be interesting to have a study which analyse whether going in order for integer
processing to increase the clock really did improve performance or if it was just a marketing
gimmick a la P4.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/270261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor270593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Power 6 clock high-score and real performance</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2008 17:14 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/270593/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>It'd be interesting to have a study which analyse whether
going in order for integer processing to increase the clock really did
improve performance</blockquote>

Take a look at <a rel="nofollow" href="http://www.spec.org/cpu2006/results/">SPEC CPU
2006 results</a>.  Last I looked, a 4.7GHz Power6 had similar speed to a 3GHz Core 2
Duo 6850 in both SPECint2006 and SPECfp2006 results.

      
          <div class="CommentReplyButton">
            <form action="/Articles/270593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor270258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2008 9:46 UTC (Thu)
                               by <b>renox</b> (guest, #23785)
                              [<a href="/Articles/270258/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt;This is place where Linus misses the point completely: there are no "bigger cache sizes".
There will never be "bigger cache sizes". Never. Pentium had 16 KiB L1 </font>

Funny how you restrict the meaning of 'bigger cache size' to 'L1 cache size' to "make your
point".

Sure L1 won't grow, but L2 and L3 cache are also cache you know?


</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/270258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor272488"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Bigger caches ? Where ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2008 23:16 UTC (Sun)
                               by <b>phip</b> (guest, #1715)
                              [<a href="/Articles/272488/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; There will never be "bigger cache sizes". Never.</font>

You should check out PA-RISC.  They have L1 D-caches up to 2048K.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/272488/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor268976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Slackware has released fixd kernel update packages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 19:18 UTC (Tue)
                               by <b>juhl</b> (guest, #33245)
                              [<a href="/Articles/268976/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
For those of you running Slackware. The <a href="http://www.slackware.com/changelog/current.php?cpu=i386">ChangeLog for Slackware-current</a> shows that there are now updated kernel packages, that fix this problem, available.
</p>
<p>
<pre>
Mon Feb 11 17:47:58 CST 2008
a/kernel-generic-2.6.23.16-i486-1.tgz:
       Upgraded to Linux 2.6.23.16 uniprocessor generic.s (requires initrd) kernel.
       All of these kernel upgrades fix yesterday's local root exploit.
       The kernel headers did not change, so a glibc rebuild is not required.
       For more information, see:
       http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-0010
       http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-0163
       http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-0600
       (* Security fix *)
       If you use lilo, don't forget to run it again after the upgrade.
</pre>
...
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/268976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor268980"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 19:40 UTC (Tue)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/268980/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Given how few userspace programs actually use vmsplice, is it safe to say that the largest
user of this system call is the exploit?  (Some quick google and koders searching implies
this; please tell me if my impression is wrong.)

I'm curious why nobody has been talking about purging this demonstrably scary call from the
kernel.  Why not redesign it so this sort of mistake will be easier to find in the future?

Ultimately, I guess here's my question: is there any quantifiable reason to believe the
current fix isn't a premature botch the way the previous fixes were?

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/268980/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 20:57 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/269001/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
The reason why it's not widely used yet is because it's quite new. Many 
people probably don't even have a glibc with this call in (it was added in 
2.5), and there's a long lag time after that before applications can start 
relying on it (or even benefiting detectably from it).
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 21:40 UTC (Tue)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/269007/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
There's nothing particularly scary about this system call.

To put this into perspective, dozens of calls with this sort of problem have been found in the
history of Linux. Dozens in Windows NT. Dozens in official AT&amp;T branded Unix. The problem was
fixed and you're still using the relevant system calls.

There are tools that are supposed to look for this sort of problem in your OS, but of course
if you keep inventing system calls, someone has to update the tools to know about the new
system calls, and if there were people being that vigilant, you'd hope that at least two of
the three bugs that lead to this discussion would have been spotted before they got into the
Linus kernel tree.

What you're looking at here is boring human error. No interesting design lessons. No
fundamental principles that ought to be reconsidered (unless you consider the hilarious
proposals earlier in comments that Linux should be re-written in a dynamic type system where
the OS would spend all its time validating your input parameters and not getting any work
done...)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269021"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 22:32 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/269021/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I think the intention was to model it on type-inferencing strongly typed 
systems, actually: but of course that sort of inferencing can't cross the 
separate-compilation-and-language abstraction boundary between the kernel 
and userspace (not to mention the privilege boundary, which is perhaps 
less significant in this case).
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269021/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor269020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">why didn't static checkers spot this?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2008 22:28 UTC (Tue)
                               by <b>adamgundy</b> (subscriber, #5418)
                              [<a href="/Articles/269020/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I was under the impression that sparse and/or coverity were specifically designed to catch
this kind of thing (reading/writing userspace pointers which haven't been correctly checked
for validity)

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2008 20:32 UTC (Wed)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/269244/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Apparently, there is a lot more technical details to this exploit.

See <a href="http://article.gmane.org/gmane.linux.kernel/639206">http://article.gmane.org/gmane.linux.kernel/639206</a> for some very interesting info from an
anonymous source in .hu.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269335"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 8:16 UTC (Thu)
                               by <b>dale77</b> (guest, #1490)
                              [<a href="/Articles/269335/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Anyone know whether SELinux would have prevented this exploit?
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/269335/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor269366"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">vmsplice(): the making of a local root exploit</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 13:44 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/269366/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The exploit is able to run arbitrary code in kernel mode, so the answer has to be "no."  Unless one had previously configured SELinux to disallow access to <tt>vmsplice()</tt> altogether, of course.
      
          <div class="CommentReplyButton">
            <form action="/Articles/269366/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor269385"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">One possible SELinux trick</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 14, 2008 15:06 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/269385/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I just ran across <a rel="nofollow" href="http://james-morris.livejournal.com/26303.html">this posting from James Morris</a> on how SELinux (in recent kernels) can block the mapping of memory into very low addresses - a feature which would have defeated this particular exploit.
      
          <div class="CommentReplyButton">
            <form action="/Articles/269385/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor270613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It's far from complete</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2008 10:55 UTC (Sun)
                               by <b>fbh</b> (guest, #49754)
                              [<a href="/Articles/270613/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Hello,

I'm suprised to see how this article is far from complete. It misses some important details
and it doesn't actually explain how the exploit works...

For example, the interesting buffer overflow (which is actually not done by get_user_pages()
BTW), is not used to put a return address on the stack at all ! Hint: it's actually used to
put 0 and 0x1000.

And, surprise surprise, the exploit also 'mmap' 2 areas starting by 0 and 0x1000. And these
areas are made up to look like a struct page structure for a compound page where the
destructor field is set to kernel_code() address.

One thing I still miss is why the exploit code is so weirdly written ?
For example, it does:

        pages[0] = *(void **) &amp;(int[2]){0,PAGE_SIZE};

whereas it could have done instead:

        pages[0] = NULL;

Is it something common for exploit code to be ofuscated ?

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/270613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor270655"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It's far from complete</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2008 0:19 UTC (Mon)
                               by <b>cras</b> (guest, #7000)
                              [<a href="/Articles/270655/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I don't know if the exploit was supposed to work as a 64bit binary (I crashed my machine when 
testing one version of it), but that code doesn't translate to "NULL" on 64bit systems.


</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/270655/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor270684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It's far from complete</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2008 9:02 UTC (Mon)
                               by <b>fbh</b> (guest, #49754)
                              [<a href="/Articles/270684/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Acutally you're right.

It's a trick to compute the addresses of the fake "struct page" structures on both 32 and 64
bits platforms.

It should work on 64 bits platforms. I don't know why it doesn't in your case though but it's
just a matter of tuning some values in the exploit code probably.

Thanks. 
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/270684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor368031"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">QA?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2009 22:07 UTC (Thu)
                               by <b>barrygould</b> (guest, #4774)
                              [<a href="/Articles/368031/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ISTM that someone should have tested the exploit against the 'fixed' kernel before declaring it fixed. (more QA is needed in the kernel development processes.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/368031/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2008, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
