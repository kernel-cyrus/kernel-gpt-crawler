        <!DOCTYPE html>
        <html lang="en">
        <head><title>The kernel and character set encodings [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/71472/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/70926/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/71472/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The kernel and character set encodings</h1>
<div class="Byline">[Posted February 18, 2004 by corbet]
               <p>
               </div>
</div>
<div class="ArticleText">
It all started as <a href="/Articles/71477/">a JFS bug report</a>.  The JFS
filesystem, it seems, gets upset when user space passes it file names
encoded in the UTF-8 format.  Rather than create or open a file with the
name as given, it gives up and returns <tt>EINVAL</tt>.  Patches which fix
the problem have been posted, but the resulting discussion has taken rather
longer to be resolved.
<p>
JFS has an "<tt>iocharset</tt>" option which can be used to state
explicitly, at mount time, which character encoding is being used.  There
were calls on linux-kernel for this option to be added to other filesystems
as well.  The idea was rather strongly shot down, however, for a few
reasons.  One of those is that multiple users could be simultaneously using
different character encodings on the same filesystem; a global option for
the whole filesystem clearly will not be able to address that case.
<p>
The real reason, however, is that performing character set conversion
requires the kernel to interpret the file name strings being passed to it
from user space.  The kernel hackers are very resistant to the imposition
of any such policy; it would go against decades of Unix tradition.
Officially, the kernel has no policy regarding which character set is being
used for file names, content, or anything else.  In each case, the kernel
sees nothing more than a stream of bytes.
<p>
That said, the kernel does have some policies regarding file names: they
use "<tt>/</tt>" as a directory delimiter, and they are terminated by a
<tt>NULL</tt> byte.  This policy rules out the use of many encodings
which are sometimes employed to represent non-ASCII characters; the
fixed-width wide encodings all tend to use lots of bytes containing zero.
In reality, the only practical choices for representing characters beyond
the ASCII set are iso-8859-1 (which allows the representation of characters
used in many continental European languages) and UTF-8, which can encode
pretty much anything.
<p>
UTF-8 is relatively easy to use; for US users it looks just like ASCII, but
it can handle a far wider range of characters while not breaking (most)
code which uses traditional C strings.  Thus it is often said that UTF-8 is
the encoding used by the Linux kernel.  That statement is a mistake,
however: Linux does not use any particular encoding.  If user space uses
UTF-8 to represent extended characters, everything will work.  But nothing
forces user space to work in that way.
<p>
This approach keeps policy out of the kernel, but some developers are not
entirely happy with it.  The lack of policy can lead to user-space
confusion in a number of ways.  For example, if a user creates a file called
<tt>W&eacute;&icirc;rd&Ntilde;&agrave;m&euml;</tt>, that name could be represented in the
filesystem in more than one way.  Depending on how user space is configured, it could choose
either iso-8859-1 or UTF-8; the encoding of that name will be quite
different depending on that choice.  A different user space could interpret
the file name differently in the future, resulting in unreadable filenames
and confused users.  The kernel, lacking a character encoding policy of its
own, will do nothing to help prevent this situation.
<p>
Confusion over character sets can also facilitate the creation of security holes; code which
attempts to clean up file names can fail if evil characters are given in an
unexpected encoding.  Code which expects UTF-8 must also be careful when
dealing with the Linux kernel because the kernel itself makes no effort to
ensure that any string is, in fact, a legal UTF-8 encoding.  
<p>
To complicate the situation even more, Andrew Tridgell posted <a
href="/Articles/71487/">another reason</a> why, he thinks, the kernel will
have to adopt a specific character encoding: case insensitivity.  Says
Tridge:
<p>
<div class="BigQuote">
	The reason is that I think that eventually the Linux kernel will
	need to efficiently support a userspace policy of
	case-insensitivity and the only way to do case-insensitive filename
	operations is to interpret those byte streams as a particular
	encoding.
</div>
<p>
Needless to say, the idea of implementing case-insensitive filesystem
operations in the kernel was not particularly popular.  Not too many kernel
hackers want to complicate the filesystem code to implement what they see
as being a broken Windows feature to begin with.  There are other
difficulties as well: case-insensitive matching must be done differently in
different languages.  The end result is that case insensitive lookups are
not very likely to make it into the kernel anytime soon.
<p>
Linus is not averse to trying to help out Samba and other applications
which wish to implement case-insensitive behavior, however.  He has <a
href="/Articles/71496/">proposed</a> a new "<tt>magic_open()</tt>"
interface which would make it easier for user space to perform
case-insensitive lookups without actually doing that work in the kernel.
This interface would likely require quite a bit of work before it would do
what the Samba developers need, but something derived from it could just
make an appearance in the 2.7 development series.
<p>
Meanwhile, the kernel does not seem likely to adopt any sort of official
encoding anytime soon.  The problems that result from the lack of an
encoding policy are mostly seen as user space issues.  Proper locale
support is still relatively new in Linux, and many rough edges remain.
Given the high level of interest in high-quality localization support in
Linux, however, one might expect those edges to be smoothed down 
quickly. 
<p>
(For those who would like to learn more about UTF-8, see <a
href="http://www.cl.cam.ac.uk/~mgk25/unicode.html">this FAQ</a> or <a
href="http://www.ietf.org/rfc/rfc3629.txt">RFC&nbsp;3629</a>).<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Character_encoding">Character encoding</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Case-independent_lookups">Filesystems/Case-independent lookups</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#JFS">JFS</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#UTF-8_encoding">UTF-8 encoding</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/71472/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor71912"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How would a case-insensitive magic_open() call work?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 9:11 UTC (Thu)
                               by <b>brouhaha</b> (subscriber, #1698)
                              [<a href="/Articles/71912/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Suppose I have two files named "Foobar" and "foobaR" in a particular directory.  The user (possibly Samba) calls magic_open("foobar", ...).
What can be expected to happen?
<p>
I think this proposed magic_open() call is almost as bad an idea as providing an option to allow normal open()s (or the filesystem code) to be case insensitive.  The few applications that really need this sort of behavior should implement it in user space by reading the directory, and they can worry about how to handle ambiguous cases there.

      
          <div class="CommentReplyButton">
            <form action="/Articles/71912/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How would a case-insensitive magic_open() call work?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 19:42 UTC (Thu)
                               by <b>chad.netzer</b> (subscriber, #4257)
                              [<a href="/Articles/72039/">Link</a>] 
      </p>
      
      </div>
      </summary>
      You get an arbitrary file.  Tridge suggests that (so far) he hasn't gotten complaints about this kind of behavior (which already exists in Samba), and there are few good alternatives.  One possible alternative, to try to keep track of which files are created by Posix systems, and which are created by Windows systems, and preferentially decide between the two, seems like too much work if no one really cares.<p>The whole case insensitivity issue of Windows is (apparently) a mess, and there appears to be no perfect policy about what to do when interoperating, other than try to do the thing which makes most practical sense.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor71913"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 9:24 UTC (Thu)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/71913/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <p>You say that the only practical choices for character encodings are ISO-8859-1 and UTF-8.  In fact, there is a vast range of encodings that will work (basically any encoding that doesn't use NUL and '/' for some other purpose than ASCII semantics).  For a start there is ISO-8859-*, KOI8-* (for Cyrillic), EUC-JP, Shift-JIS (both popular in Japan), and so on.
</p><p>
Getting the character encoding right is difficult, and with UTF-8 there is an additional complication, Unicode normalisation - the issue here is that in certain languages, you might have a symbol on the page being encoded as 3 Unicode characters: the letter with accent 1 then accent 2 in one string, and the letter with accent 2 then accent 1 in another string.  These strings result in exactly the same visual appearance on screen, yet they can't be compared with a byte comparison.  Unicode normalisation defines a specific order for all such 'combining character' strings, but unfortunately there is more than one normalisation form: Linux and the W3C use NFC, while <a href="http://twiki.org/cgi-bin/view/Codev/MacOSXFilesystemEncodingWithI18N">Darwin and MacOS X use NFD</a>, even on UFS filesystems.
</p><p>
Unicode makes life more complicated for everyone and it's likely some of this needs to be in the kernel, or at least glibc, for uniformity.  For more links on Unicode, from a Perl/Wiki oriented perspective, see the <a href="http://twiki.org/cgi-bin/view/Codev/ProposedUTF8SupportForI18N">plan for TWiki support of UTF-8</a> and this <a href="http://twiki.org/cgi-bin/view/Codev/UnicodeNormalisation">Unicode normalisation page</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/71913/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor71916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 9:54 UTC (Thu)
                               by <b>one2team</b> (guest, #7316)
                              [<a href="/Articles/71916/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      « You say that the only practical choices for character encodings are ISO-8859-1 and UTF-8. In fact, there is a vast range of encodings that will work (basically any encoding that doesn't use NUL and '/' for some other purpose than ASCII semantics). For a start there is ISO-8859-*, KOI8-* (for Cyrillic), EUC-JP, Shift-JIS (both popular in Japan), and so on. »<p>These encodings are mostly useless in a true multi-user system. Why ? Because they are all incompatible. So there is no way for a user that uses encoding A to read stuff (including filenames) made by another user using encoding B. And this is true even for close stuff (KOI8-U and KOI8-R for example). Not to speak of the poor users that may want to quote another langage (French + Russian, Welsh + Greek etc).<p>The only thing all those encodings are compatible with is english, which restricts second language to english and english only.<p>One could argue userspace would have just to use Greek encoding for Greek filenames, Russian for Russian ones and so on. But the crux of the problem is userspace have no way to request or guess what encoding was used to write a filename, since the kernel does not enforce any particular encoding nor provides encoding info to userspace.<p>One additionnal problem is some byte strings can result in invalid UTF-8 and cause applications to barf if they try to decode them.
      
          <div class="CommentReplyButton">
            <form action="/Articles/71916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor71978"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 13:12 UTC (Thu)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/71978/">Link</a>] 
      </p>
      
      </div>
      </summary>
      These encodings are fine where the users agree on a single character set (e.g. KOI8-R in Russia) or where there is some external data (e.g. the directory name or file name including 'koi8-r') describing the character set of the file.  I am very aware that there may be conversion problems, which is why Unicode is important, but not everyone is going to move to Unicode straight away - there are still gaps in the user level tools available, though they are improving.<p>What might be useful is to document the legacy non-Unicode character sets that are incompatible with ASCII and in particular *nix filesystems - so far, I believe that HZ-*, ISO-2022-* and Big5 are all incompatible, but it would be good to see a definitive list.  Then at least Linux users would know which character sets to avoid for filenames.<p>The issue of invalid UTF-8 strings is no different to any other mis-encoded characters - it would be good if glibc or perhaps the kernel checked UTF-8 for overlong characters, as this is a well known security hole and it's not hard to do this.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/71978/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor71920"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 11:18 UTC (Thu)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/71920/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p><i>
&gt; These strings result in exactly the same visual appearance on screen, yet they can't be compared with a byte comparison. 
</i></p>
<p>
You do not need even Unicode normalization for that. In most fonts the following two lines would have exactly the same visual presentation (you have to view the page with UTF-8 encoding as LWN does not allow to enter &amp;#1056;&amp;#1054;&amp;#1058; in HTML comments due to bugs in recognition of &amp;code; escapes):
<br>
POT
<br>
Ð ÐÐ¢
<br>
yet the first uses pure ASCII and the second uses only Cyrillic characters and means <i>mouth</i> in Russian.
</p>
<p>
IMHO such examples supports the notion that kernel should not impose any policy on file names encoding as in practice there are always more then one way to encode the same visual presentation and UTF-8 with Unicode does not help here.  


      
          <div class="CommentReplyButton">
            <form action="/Articles/71920/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor71930"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 12:14 UTC (Thu)
                               by <b>mwh</b> (guest, #582)
                              [<a href="/Articles/71930/">Link</a>] 
      </p>
      
      </div>
      </summary>
      &gt; Unicode makes life more complicated for everyone 
<pre>
  If Unicode is a horde of zombies with flaming dung sticks, 
  the hideous intricacies of JIS, Chinese Big-5, Chinese 
  Traditional, KOI-8, et cetera are at least an army of ogres 
  with salt and flensing knives.        -- Eric S. Raymond, python-dev
</pre>

Unicode isn't <i>that</i> hard to deal with, although I'd admit to not having any intuition for what the right answer is in this situation.
      
          <div class="CommentReplyButton">
            <form action="/Articles/71930/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor72281"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 22:19 UTC (Fri)
                               by <b>spitzak</b> (guest, #4593)
                              [<a href="/Articles/72281/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      There is no problem with UTF-8 filenames. The bytes should be stored <br>unchanged, and unchanged bytes should be used to look up the file. It <br>does not matter if those bytes are a legal UTF-8 string or not, to say <br>nothing of what normalization form they are.<p>Unfortunately there are hordes of people out there who think dumb ideas <br>like case-insensitivity should be applied at low levels to stuff that <br>really is binary data. This kind of thinking is what causes complexity, <br>and complexity causes bugs and security holes.<p>Any program that takes a string it thinks is UTF-8 and does <br>&lt;i&gt;ANYTHING&lt;/i&gt; other than pass the exact bytes unchanged to another <br>interface that wants UTF-8 is by definition broken. This simple rule will <br>completely eliminate all ambiguity about UTF-8.<p><p><br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72281/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72324"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2004 7:49 UTC (Sat)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/72324/">Link</a>] 
      </p>
      
      </div>
      </summary>
      This problem needs to be addressed somewhere, though not necessarily in the kernel (perhaps in glibc or the GUI layer): two users create identical looking filenames using Vietnamese accented characters (letter + 2 accents in different order, 3 Unicode characters altogher).   Then, there are two identical-looking filenames and you don't know how to type the 'right' one. Even if there is only one file involved, without Unicode normalisation you wouldn't be able to use bash filename completion, since you might type the accents in a different order to that used in the filename, though there would be no visual clue as to your mistake.<p>Given these issues, which affect command line tools as much as GUIs, it may be sensible to put NFC normalisation in glibc or the kernel, despite the complexity.  Files created from another system on a Linux NFS filesystem would of course bypass glibc, so the alternatives are batch renormalisation (always an option, convmv may do this) or putting NFC in the kernel.<p>It's not good enough to say 'case-insensitivity should not be in the kernel' - you need to address these use cases and say how and where you would solve them.<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72324/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor71923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unicode bugs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 11:06 UTC (Thu)
                               by <b>simonl</b> (guest, #13603)
                              [<a href="/Articles/71923/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Unicode in kernel means security holes.<p>Back in 2001 afair Unicode bugs were found in MS IIS. There are many ways to encode a ../../ path in Unicode, and IIS did not know all of them. However the kernel did, and thus circumvented any path sanitizing IIS did.<p>Linux should not repeat these mistakes.<p>We would have to fix every little script that deals with userdefined file names, it is impossible. Input validation is hard enough already.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/71923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor71981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unicode bugs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 13:19 UTC (Thu)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/71981/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Any new functionality can mean security holes, and this applies whether Unicode is implemented in libraries or the kernel.  It's important to address Unicode's potential for such holes (overlong UTF-8 encodings etc), but mostly this is just good practice - e.g. you 'filter in' the characters you know are legal, rather than trying to 'filter out' characters that are illegal (it's very easy to miss just one).<p>I'm not sure Unicode needs to live in the kernel as long as there is good library support, but it's better for library or kernel maintainers to solve these problems once rather than have different buggy implementations in every application.<p>The specific IIS issues were related to Microsoft's non-standard %uNNNN encoding of 16-bit UCS-2 (Unicode) characters, so I don't think this is a reason to abandon Unicode.
      
          <div class="CommentReplyButton">
            <form action="/Articles/71981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor71999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unicode cannot be secure---B. Schneier</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 15:28 UTC (Thu)
                               by <b>Max.Hyre</b> (subscriber, #1054)
                              [<a href="/Articles/71999/">Link</a>] 
      </p>
      
      </div>
      </summary>
         <p>Well, that should get their attention.  :-)  The exact wording
was ``Unicode is just too complex to ever be secure.''

   <p>In his July 2000 Crypto-gram <a href="http://www.schneier.com/crypto-gram-0007.html#9">article
on
Unicode</a>, Schneier points up the failures we've had dealing with
ASCII control characters, escape sequences, different semantics at
different levels of the application (think writing a <code>bash</code>
command to grep for a particular <code>grep</code> regular expression),
and concludes that with Unicode it's not merely hard, it's effectively
impossible.

   <p>I don't know enough about Unicode to argue the details, but it
certainly made me sit up and take notice.

      
          <div class="CommentReplyButton">
            <form action="/Articles/71999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor72283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unicode bugs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 22:23 UTC (Fri)
                               by <b>spitzak</b> (guest, #4593)
                              [<a href="/Articles/72283/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Avoiding those bugs is one of the primary reasons why UTF-8 is a good <br>idea.<p>&quot;../&quot; in a UTF-8 filename means the *BYTES* for '.', '.', and '/' appear <br>next to each other. It is entirely irrelevant if the UTF-8 string is <br>legal or if it contains a byte sequence that some broken software by <br>Microsoft will turn into a slash.<p>I don't know how many times this has to be stated. But if your program is <br>looking at a UTF-8 string and is doing anything other than drawing the <br>characters on the screen, YOU DO NOT NEED TO DECODE IT! Just look at the <br>bytes!<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor71979"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 13:16 UTC (Thu)
                               by <b>danscox</b> (subscriber, #4125)
                              [<a href="/Articles/71979/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      It seems to me like this would be a perfect place for either FUSE, or a &quot;settable&quot; policy mechanism within the kernel.  Even that can get hairy, of course, for many and varied reasons, but it would leave policy in userland, where it should be.  This could possibly start up a whole set of 'cottage industries'; modules to support this or that file naming convention.  I'm thinking of Firefox and it's extensions, for example.<p>Danny
      
          <div class="CommentReplyButton">
            <form action="/Articles/71979/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Method for (mostly) kernel-independant Unicode filenames?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2004 16:28 UTC (Thu)
                               by <b>Max.Hyre</b> (subscriber, #1054)
                              [<a href="/Articles/72000/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
         <p><i>[Strawman proposal---please point me toward discussions where
it's all been hashed out, shot down, &amp;c.  Or, just flame direct.]</i>

   <p>How about changing filename semantics (and, of course, every
filesystem known to Linux):  make filenames
a three-element struct:  a fixed-length specification of the name's
character-set encoding, a fixed-length count of the <i>bytes</i> in
the name, and a variable-length string holding said name:<br>
<pre>
    struct filename {
        enum encoding enc;
        int cb;
        byte *rgb;
    };
</pre>

   <p>Now, the kernel doesn't give a fig what the encoding is, or
what it might mean---it's all bytes, with no chance (hah!) of filename
buffer overflows and their attendant dangers to root.  The
libraries just use the struct for calls to <code>fopen()</code>,
<code>remove()</code>, <code>rename()</code>,
&amp; friends, with the caller allowed to specify that
<ul>
<li>an exact match (on all elements of the struct) is needed for 
equality comparisons,
<li>a bytewise match on the <code>byte *</code>s, regardless of the
encoding, is sufficient, or
<li>its own comparator function (supplied) be run on pairs of the structs.
</ul>

   <p>The kernel code is encoding-agnostic, and the rest of the work
(emphatically including sorting) is in
userland.
      
          <div class="CommentReplyButton">
            <form action="/Articles/72000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72217"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A few problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 17:35 UTC (Fri)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/72217/">Link</a>] 
      </p>
      
      </div>
      </summary>
      1) What filesystems support per-file character set selection?  Which ones<br> can handle embedded NUL characters?  What about maximum filename length<br> considerations -- you are no longer measuring in characters because the<br> number of bytes they use depends on the encoding.<p>2) There are a whole lot of system calls receiving or returning filenames<br> (the libc routines linke fopen() are a different layer): open(),<br> getdirentries(), readlink(), stat(), lstat(), rename(), unlink(), link(),<br> mknod(), chown(), chmod(), utime(), mount() etc.  (not to mention Unix<br> domain sockets).  These would all have to change.  But POSIX defines them<br> as taking certain parameters and having certain return types.  So you<br> either have to drop Unix compatability or you have to add duplicate<br> versions of each one much like Microsoft did when converting to UCS2.<p>3) What about Unix applications and old Linux apps?  They won't even<br> compile if you change the prototypes.  If you don't and make the old<br> system calls default to UTF8 or something you still have to make them work<br> with filenames in other encodings.<p>4) It won't fix the policy problem without involving the kernel anyway.<br>  What about case insensitivity, canonicalizing characters, path delimeters<br> etc.?  You removed the need for the terminating NUL but what about the &quot;/&quot;<br> character?  What about character sets with no slash, or with multiple<br> slashes?  The kernel will need to know what these are and that will depend<br> on the character set.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72217/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor72119"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 2:24 UTC (Fri)
                               by <b>flewellyn</b> (subscriber, #5047)
                              [<a href="/Articles/72119/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Why does the kernel even use &quot;/&quot; and NUL?  Seriously, pathnames should be internally coded as structures, not strings.  The only parsing of pathname strings should occur in the C library, including syscall wrappers.  The kernel should not have any notion, internally, of pathname separators.  It's just silly.<p>Instead, I propose something like this: stick each element of the pathname into an array element, innermost first (that is, the &quot;root&quot; directory would be LAST element of the array), and use a special token to indicate ROOT.  You could have the array live in a struct, with the other struct element being the length of the array, if you like.  Something like this:<p>struct pathname {<br>    int length;<br>    char* elements[];<br>}<p>This way you could get at the file's name with a simple elements[0], and walk the directory tree from root to the file like this:<p>for (i = length; i &gt;=0; i--)  {blah blah blah whatever};<p>No worrying about parsing out the &quot;/&quot; separators.
      
          <div class="CommentReplyButton">
            <form action="/Articles/72119/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72219"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 17:37 UTC (Fri)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/72219/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      But you are using C strings to denote the elements which means they are<br>still NUL terminated.  To fix it you need a second array for the path<br>component lengths.  I think you are unlikely to convince any of the kernel<br>guys this isn't too ugly to live.
      
          <div class="CommentReplyButton">
            <form action="/Articles/72219/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72284"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 22:32 UTC (Fri)
                               by <b>spitzak</b> (guest, #4593)
                              [<a href="/Articles/72284/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I agree that a length is needed, not just for encoding NUL, but to allow <br>a slash-seperated name to be quickly converted to this form, without a <br>need to malloc and copy a block of memory for each piece.<p>One possibly less-ugly scheme is to use Plan9's &quot;walk&quot; style. You have <br>&quot;file descriptors&quot; that represent a filename, unopened as yet. These are <br>created by copying an <br>existing one (a small set, such as one for &quot;/&quot;, are provided when the <br>program starts up, like stdin/out). There is then a call something like <br>walk(fd,char* name,int length) which moves fd to the subdirectory in <br>name[0..length-1]. When you finally are at the desired file you call <br>open(fd,mode). Existing open() calls would be turned into a bunch of walk <br>calls followed by a new open.<p>With this, no arrays are passed to the kernel, and it does not have to <br>store these arrays.<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72284/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor72285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2004 22:37 UTC (Fri)
                               by <b>spitzak</b> (guest, #4593)
                              [<a href="/Articles/72285/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Could somebody explain why the case-insensitivity is so important, even <br>for Samba? It seems to me there cannot be too many Windows programs that <br>take a filename provided to it by the system and change the case before <br>using it. My tests show that when you double-click files in Explorer or <br>from the file chooser or any other way I found to select the files, <br>Windows gave my program the filename with the exact same case as it was <br>reported in the file listing.<p>Yes users can type in the wrong case into a shell, but aren't <br>command-line interfaces supposed to be &quot;unfriendly&quot;? Why does anybody <br>care if user-unfriendly interfaces work for stupid users or not?<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/72285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72371"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The kernel and character set encodings</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2004 21:14 UTC (Sat)
                               by <b>fiberbit</b> (subscriber, #693)
                              [<a href="/Articles/72371/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      The problem lies in the checking whether or not a file with a given name (case insensitive) exists. Say you do an 'fp = fopen(&quot;filename&quot;, &quot;a&quot;), and &quot;filename&quot; doesn't exist yet, then in the case-insensitive case, you have to check whether &quot;Filename&quot; or &quot;fIlename&quot; or any other variant *does* exist.<br>You'd  either have to try all possible combinations, or (in practice) scan the whole directory to see if any name matches (and use the first). This not only is very time consuming, but also racy in a multi process environment.<br>It could be solved by using case-insensitive hash functions in the dentry cache, but that would negatively impact normal filesystems, and is unacceptable to most, including the top penguin.
      
          <div class="CommentReplyButton">
            <form action="/Articles/72371/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72425"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re-mount Through Caseless VFS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2004 0:37 UTC (Mon)
                               by <b>miallen</b> (guest, #10195)
                              [<a href="/Articles/72425/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Why not just create a &quot;casefs&quot; VFS that just uses the existing ops for the target mounted fs but overloads lookup() to do the caseless pathwalk (and maybe save the last N paths with hashes in a separate cache)? Now you would just (re)mount an existing fs through this casefs VFS. It wouldn't be optimal but it would still be a lot faster for Samba, WINE, or whoever and it wouldn't barf all over any other kernel code. It's probably not a lot of code either.<p>Mike
      
          <div class="CommentReplyButton">
            <form action="/Articles/72425/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor72434"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re-mount Through Caseless VFS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2004 7:40 UTC (Mon)
                               by <b>massimiliano</b> (subscriber, #3048)
                              [<a href="/Articles/72434/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <br>I am definitely not a kernel developer, but this sounds like<br>the perfect solution: very general, and perfectly decoupled<br>from the code of existing filesystems... and moreover, you pay<br>the performance penalty only if you use the feature.<p>As an added benefit, it could be implemented entirely in user<br>space using FUSE, and only if/when it works very well (and the<br>added performance is needed) as a kernel module.<p>With such a layer, it would also be possible to handle all those<br>nasty Unicode normalizations...<p>Just my two cents, anyway.
      
          <div class="CommentReplyButton">
            <form action="/Articles/72434/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2004, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
