        <!DOCTYPE html>
        <html lang="en">
        <head><title>The trouble with CAP_SYS_RAWIO [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/542327/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/542260/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/542327/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The trouble with CAP_SYS_RAWIO</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Michael Kerrisk</b><br>March 13, 2013</br>
           </div>
<p> A February linux-kernel mailing list discussion of a patch that extends
the use of the <tt>CAP_COMPROMISE_KERNEL</tt> capability soon evolved into
a discussion of the specific uses (or abuses) of the <tt>CAP_SYS_RAWIO</tt>
capability within the kernel.  However, in reality, the discussion once
again exposes some general difficulties in the Linux capabilities
implementation&mdash;difficulties that seem to have no easy solution.

<p> 

<p> The discussion began when Kees Cook <a
href="/Articles/542328/">submitted a patch</a> to guard writes to <a
href="http://en.wikipedia.org/wiki/Model-specific_register">model-specific
registers</a> (MSRs) with a check to see if the caller has the
<tt>CAP_COMPROMISE_KERNEL</tt> capability.  MSRs are x86-specific control
registers that are used for tasks such as debugging, tracing, and
performance monitoring; those registers are accessible via the <a
href="http://man7.org/linux/man-pages/man4/msr.4.html"><tt>/dev/cpu/CPUNUM/msr</tt></a>
interface.  <a
href="https://lwn.net/Articles/523367/"><tt>CAP_COMPROMISE_KERNEL</tt></a>
(formerly known as <a
href="https://lwn.net/Articles/514985/"><tt>CAP_SECURE_FIRMWARE</tt></a>)
is a new capability designed for use in conjunction with UEFI secure boot,
which is a mechanism to ensure that the kernel is booted from an on-disk
representation that has not been modified.

<p> If a process has the <tt>CAP_COMPROMISE_KERNEL</tt> capability, it can
perform operations that are not allowed in a secure-boot environment;
without that capability, such operations are denied.  The idea is that if
the kernel detects that it has been booted via the UEFI secure-boot
mechanism, then this capability is disabled for all processes.  In turn,
the lack of that capability <a href="/Articles/534637/">is intended</a> to
prevent operations that can modify the running kernel.
<tt>CAP_COMPROMISE_KERNEL</tt> is not yet part of the mainline kernel, but
already exists as <a
href="http://pkgs.fedoraproject.org/cgit/kernel.git/tree/secure-boot-20130218.patch">a
patch in the Fedora distribution</a> and Matthew Garrett is working towards
its inclusion in the mainline kernel.

<p> H.&nbsp;Peter Anvin <a href="/Articles/542330/">wondered</a> whether
<tt>CAP_SYS_RAWIO</tt> did not already suffice for Kees's purpose. In
response, Kees <a href="/Articles/542334/">argued</a> that
<tt>CAP_SYS_RAWIO</tt> is for governing <i>reads</i>: "<q>writing needs a much
stronger check</q>". Kees <a href="/Articles/542335/">went on</a> to
elaborate:

<div class="BigQuote">

     there's a reasonable distinction between systems that expect to
     strictly enforce user-space/kernel-space separation
     (<tt>CAP_COMPROMISE_KERNEL</tt>) and things that are fiddling with
     hardware (<tt>CAP_SYS_RAWIO</tt>).

</div>

<p> This in turn led to a short discussion about whether a capability was
the right way to achieve the goal of restricting certain operations in a
secure-boot environment. Kees <a href="/Articles/542455/">was inclined</a>
to think it probably was the right approach, but deferred to Matthew
Garrett, implementer of much of the secure-boot work on Fedora.  Matthew
thought that a capability approach seemed the best fit, but <a
href="/Articles/542456/">noted</a>:


<div class="BigQuote">

     I'm not wed to [a capability approach] in the slightest, and in
     fact it causes problems for some userspace (anything that drops all
     capabilities suddenly finds itself unable to do something that it
     expects to be able to do), so if anyone has any suggestions for a
     better approach&hellip;

</div>

<p> In the current mainline kernel, the <tt>CAP_SYS_RAWIO</tt> capability
is checked in the <tt>msr_open()</tt> function: if the caller has that
capability, then it can open the MSR device and perform reads and writes on
it. The purpose of Kees's patch is to add a <tt>CAP_COMPROMISE_KERNEL</tt>
check on each write to the device, so that in a secure-boot environment the
MSR devices are readable, but not writeable.  The problem that Matthew
alludes to is that this approach has the potential to break user space
because, formerly, there was no capability check on MSR writes. An
application that worked prior to the introduction of
<tt>CAP_COMPROMISE_KERNEL</tt> can now fail in the following
scenario:

<ul>

<li>

The application has a full set of privileges.

</li>

<p>
<li>

The application opens an MSR device (requires <tt>CAP_SYS_RAWIO</tt>).

</li>

<p>
<li>

The application drops all privileges, including <tt>CAP_SYS_RAWIO</tt> and
<tt>CAP_COMPROMISE_KERNEL</tt>.

</li>

<p>
<li>

The application performs a write on the previously opened MSR device
(requires <tt>CAP_COMPROMISE_KERNEL</tt>).

</li>

</ul>

<p> The last of the above steps would formerly have succeeded, but, with
the addition of the <tt>CAP_COMPROMISE_KERNEL</tt> check, it now fails. In a
subsequent reply, Matthew noted that <a href="http://wiki.qemu.org/">QEMU</a> was
one program <a
href="https://bugzilla.redhat.com/show_bug.cgi?id=908888">that was
broken</a> by a scenario similar to the above. Josh Boyer <a
href="/Articles/542464/">noted</a> that Fedora has had a few reports of
applications breaking on non-secure-boot systems because of scenarios like
this. He highlighted why such breakages are so surprising to users and why
the problem is seemingly unavoidable:

<div class="BigQuote">

     &hellip; the general problem is people think dropping all caps blindly
     is making their apps safer.  Then they find they can't do things they
     could do before the new cap was added&hellip;

     <p> Really though, the main issue is that you cannot introduce new
     caps to enforce finer grained access without breaking something.

</div>

<p> Shortly afterward, Peter stepped back <a href="/Articles/542468/">to
ask</a> a question about the bigger picture: why should
<tt>CAP_SYS_RAWIO</tt> be allowed on a secure-boot system?  In other words,
rather than adding a new <tt>CAP_COMPROMISE_KERNEL</tt> capability that is
disabled in secure-boot environments, why not just disable
<tt>CAP_SYS_RAWIO</tt> in such environments, since it is the possession of
that capability that permits compromising a booted kernel?

<p> That led Matthew <a href="/Articles/542516/">to point out</a> a major
problem with <tt>CAP_SYS_RAWIO</tt>:

<div class="BigQuote">

     CAP_SYS_RAWIO seems to have ended up being a catchall of "Maybe
     someone who isn't entirely root should be able to do this", and not
     everything it covers is equivalent to being able to compromise the
     running kernel.  I wouldn't argue with the idea that maybe we should
     just reappraise most of the current uses of CAP_SYS_RAWIO, but
     removing capability checks from places that currently have them seems
     like an invitation for userspace breakage.

</div>

<p> To see what Matthew is talking about, we need to look at a little
history.  Back in January 1999, when capabilities first appeared with the
release of Linux 2.2, <tt>CAP_SYS_RAWIO</tt> was a single-purpose
capability. It was used in just a single C file in the kernel source, where
it governed access to two system calls: <tt>iopl()</tt> and
<tt>ioperm()</tt>. Those system calls permit access to I/O ports, allowing
uncontrolled access to devices (and providing various ways to modify the
state of the running kernel); hence the requirement for a capability in
order to employ the calls.

<p> The problem was that <tt>CAP_SYS_RAWIO</tt> rapidly grew to cover a
range of other uses. By the time of Linux 2.4.0, there were 37 uses across
24 of the kernel's C source files, and <a
href="http://blog.man7.org/2013/03/revisiting-kernel-capability-usage.html">looking
at the 3.9-rc2 kernel</a>, there are 69 uses in 43 source files. By either
measure, <tt>CAP_SYS_RAWIO</tt> is now the third most commonly used
capability inside the kernel source (after <tt>CAP_SYS_ADMIN</tt> and
<tt>CAP_NET_ADMIN</tt>).

<p> <tt>CAP_SYS_RAWIO</tt> seems to have encountered <a
href="/Articles/486306/">a fate similar to <tt>CAP_SYS_ADMIN</tt></a>,
albeit on a smaller scale. It has expanded well beyond its original narrow
use. In particular, Matthew <a href="/Articles/542570/">noted</a>:

<div class="BigQuote">

     Not having CAP_SYS_RAWIO blocks various SCSI commands, for
     instance. These might result in the ability to write individual blocks
     or destroy the device firmware, but do any of them permit modifying
     the running kernel?

</div>

<p> Peter had <a href="/Articles/542571/">some choice words</a> to describe
the abuse of <tt>CAP_SYS_RAWIO</tt> to protect operations on SCSI
devices. The problem, of course, is that in order to perform relatively
harmless SCSI operations, an application requires the same capability that
can trivially be used to damage the integrity of a secure-boot system.  And
that, as Matthew <a href="/Articles/542574/">went on to point out</a>, is
the point of <tt>CAP_COMPROMISE_KERNEL</tt>: to disable the truly dangerous
operations (such as MSR writes) that <tt>CAP_SYS_RAWIO</tt> permits, while
still allowing the less dangerous operations (such as the 
SCSI device operations).

<p> All of this leads to a conundrum that was <a
href="/Articles/542575/">nicely summarized</a> by Matthew. On the one
hand, <tt>CAP_COMPROMISE_KERNEL</tt> is needed to address the problem that
<tt>CAP_SYS_RAWIO</tt> has become too diffuse in its meaning. On the other
hand, the addition of <tt>CAP_COMPROMISE_KERNEL</tt> checks in places where
there were previously no capability checks in the kernel means that
applications that drop all capabilities will break. There is no easy way
out of this difficulty. As Peter <a href="/Articles/542576/">noted</a>:
"<q>We thus have a bunch of unpalatable choices, **all of which are
wrong**</q>".

<p> Some possible resolutions of the conundrum were <a
href="/Articles/542464/">mentioned</a> by Josh Boyer earlier in the thread:
<tt>CAP_COMPROMISE_KERNEL</tt> could be treated as a "hidden" capability
whose state could be modified only internally by the kernel. Alternatively,
<tt>CAP_COMPROMISE_KERNEL</tt> might be specially treated, so that it can
be dropped only by a <tt>capset()</tt> call that operates on that
capability alone; in other words, if a <tt>capset()</tt> call specified
dropping multiple capabilities, including <tt>CAP_COMPROMISE_KERNEL</tt>,
the state of the other capabilities would be changed, but not the state of
<tt>CAP_COMPROMISE_KERNEL</tt>. The problem with these approaches is that
they special-case the treatment of <tt>CAP_COMPROMISE_KERNEL</tt> in a
surprising way (and surprises in security-related APIs have a way of coming
back to bite in the future). Furthermore, it may well be the case that analogous
problems are encountered in the future with other capabilities; handling
each of these as a special case would further add to the complexity of the
capabilities API.

<p> The discussion in the thread touched on a number of other difficulties
with capabilities. Part of the solution to the problem of the overly broad
effect of <tt>CAP_SYS_RAWIO</tt> (and <tt>CAP_SYS_ADMIN</tt>) might be to
split the capability into smaller pieces&mdash;replace one capability with
several new capabilities that each govern a subset of the operations
governed by the old capability. Each privileged operation in the kernel
would then check to see whether the caller had either the old or the new
privilege. This would allow old binaries to continue to work while allowing
new binaries to employ the new, tighter capability. The risk with this
approach is, as Casey Schaufler <a href="/Articles/542586/">noted</a>, the
possibility of an explosion in the number of capabilities, which would
further complicate administering capabilities for
applications. Furthermore, splitting capabilities in this manner doesn't
solve the particular problem that the <tt>CAP_COMPROMISE_KERNEL</tt>
patches attempt to solve for <tt>CAP_SYS_RAWIO</tt>.

<p> Another general problem <a href="/Articles/542587/">touched on</a> by
Casey is that capabilities still have not seen wide adoption as a
replacement for set-user-ID and set-group-ID programs. But, as Peter <a
href="/Articles/542588/">noted</a>, that may well be

<div class="BigQuote">

     in large part because a bunch of the capabilities are so
     close to equivalent to "superuser" that the distinction is
     meaningless... so why go through the hassle?

</div>

<p> With 502 uses in the 3.9-rc2 kernel, <tt>CAP_SYS_ADMIN</tt> is the most
egregious example of this problem. That problem itself would appear to
spring from the Linux kernel development model: the decisions about which
capabilities should govern new kernel features typically are made by individual
developer in a largely decentralized and uncoordinated
manner. Without having a coordinated big picture, many developers have
adopted the seemingly safe choice, <tt>CAP_SYS_ADMIN</tt>. A related
problem is that
<a href="http://forums.grsecurity.net/viewtopic.php?f=7&t=2522">it turns
out</a> that a number of capabilities allow escalation to full root
privileges in certain circumstances. To some degree, this is probably
unavoidable, and it doesn't diminish the fact that a well-designed
capabilities scheme can be used to reduce the attack surface of applications.

<p> One approach that might help solve the problem of overly broad capabilities
is hierarchical capabilities. The idea, <a
href="/Articles/542594/">mentioned</a>  by Peter, is to
split some capabilities in a fashion similar to the way that the root
privilege was split into capabilities. Thus, for instance,
<tt>CAP_SYS_RAWIO</tt> could become a hierarchical capability with
sub-capabilities called (say) <tt>CAP_DANGEROUS</tt> and
<tt>CAP_MOSTLY_HARMLESS</tt>. A process that gained or lost
<tt>CAP_SYS_RAWIO</tt> would implicitly gain or lose both
<tt>CAP_DANGEROUS</tt> and <tt>CAP_MOSTLY_HARMLESS</tt>, in the
same way that transitions  to and from an effective user ID of 0
grant and drop all capabilities. In addition, sub-capabilities could be
raised and dropped independently of their "siblings" at the same
hierarchical level. However, sub-capabilities are not a concept that
currently exists in the kernel, and it's not clear whether the existing
capabilities API could be tweaked in such a way that they could be
implemented sanely. Digging deeper into that topic remains an open
challenge.

<p> The <tt>CAP_SYS_RAWIO</tt> discussion touched on a long list of
difficulties in the current Linux capabilities implementation: capabilities
whose range is too broad, the difficulties of splitting capabilities while
maintaining binary compatibility (and, conversely, the administrative
difficulties associated with defining too large a set of capabilities), the
as-yet poor adoption of binaries with file capabilities vis-a-vis
traditional set-user-ID binaries, and the (possible) need for an API for
hierarchical capabilities. It would seem that capabilities still have a way
to go before they can deliver on the promise of providing a manageable
mechanism for providing discrete, non-elevatable privileges to
applications.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Capabilities">Capabilities</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Capabilities">Capabilities</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Secure_boot">Secure boot</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/542327/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor542723"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 17:21 UTC (Wed)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/542723/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For the particular scenario mentioned: couldn't CAP_COMPROMISE_KERNEL be checked at open time (together with CAP_SYS_RAWIO) and set a flag in the kernel open file struct? That way, dropping capabilities after open would not cause any problems, and the application would keep working as it used to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542723/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 17:47 UTC (Wed)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542729/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The check would be if(!capable(CAP_SYS_RAWIO) || !capable(CAP_SYS_COMPROMISE_KERNEL)) return -EPERM, so anything that drops all capabilities other than CAP_SYS_RAWIO would still fail.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542748"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 19:49 UTC (Wed)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/542748/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, the check would be "if (!capable(CAP_SYS_RAWIO)) return -EPERM;" followed by stashing the value of capable(CAP_SYS_COMPROMISE_KERNEL) somewhere. When writing, check the stashed value instead of capable(CAP_SYS_COMPROMISE_KERNEL) directly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542748/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542750"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 19:59 UTC (Wed)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542750/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which would still result in any application that drops CAP_SYS_COMPROMISE_KERNEL before doing anything else being unable to write.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542750/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor542753"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 20:11 UTC (Wed)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/542753/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, the check should be<br>
<p>
if (reading &amp;&amp; !CAP_SYS_RAWIO) return -EPERM;<br>
if (writing &amp;&amp; !CAP_SYS_COMPROMISE_KERNEL) return -EPERM;<br>
<p>
when the device is opened, and anything subsequent checking the file's flags.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542753/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 20:20 UTC (Wed)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542755/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Applications that drop CAP_SYS_COMPROMISE_KERNEL are still unable to write. How does this help?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 21:25 UTC (Wed)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/542767/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      Application which drops CAP_SYS_COMPROMISE_KERNEL will work just fine because both checks happen in open(2) syscall. It'll break application which opens file for reading and writing but then only issues read commands. This can be fixed by changing logic: if read/write open(2) request is attempted without CAP_SYS_COMPROMISE_KERNEL then it's silently translated to read-only open(2) request. Of course application which will try to write to said file will see EBADF which may crash it, but I'm not sure what can save such an application.
      
          <div class="CommentReplyButton">
            <form action="/Articles/542767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542775"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 21:38 UTC (Wed)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542775/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The current state of things: an application that drops all capabilities other than CAP_SYS_RAWIO can read and write MSRs. The new state of things: an application that drops all capabilities other than CAP_SYS_RAWIO can no longer write MSRs. So, how does that fix anything?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542775/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 22:40 UTC (Wed)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/542784/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It fixes the "open the device and then drop privileges" usage.<br>
<p>
It does not fix the "drop privileges and then open the device" case. I know that. But if userspace runs afoul of this problem, the fix is a simple re-ordering of two lines of code. Or retaining an additional capability.<br>
<p>
Is there any real-world program that would run aground at this change, or is this an academic exercise?<br>
<p>
Personally I never regarded CAP_SYS_RAWIO (or _ADMIN) as written in stone. It's a sufficiently broad catch-all category that a reasonable programmer should expect that requiring a different, or additional, capability for a task that used to work with only this one right might be in the cards.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542788"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 22:48 UTC (Wed)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542788/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You've still broken userspace. It's still undesirable and it's still a fundamental problem with the capabilities interface. Similar changes in other places in the Fedora kernel have broken various bits of userspace in irritating ways.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542788/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542813"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 4:50 UTC (Thu)
                               by <b>heijo</b> (guest, #88363)
                              [<a href="/Articles/542813/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem is that both CAP_SYS_RAWIO, CAP_SYS_ADMIN and possibly others used to be equivalent and imply the ability to arbitrarily alter the system.<br>
<p>
Redefining those to no longer being able to do so is idiotic and breaks compatibility.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542813/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 5:04 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542817/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
CAP_SYS_RAWIO is not equivalent to CAP_SYS_ADMIN. That's why they're not defined to the same value. It does not imply the ability to arbitrarily alter the system. That's *the entire point* of capabilities.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor542986"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 19:52 UTC (Thu)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/542986/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually I don't believe the suggestion change (move the check for write-modes to the open()) breaks userspace. Not the 'silent downgrade to read-only' which is the entire problem right now and identical to the 'check on write()' problem.<br>
<p>
Right now you don't appear to be able to drop-all-caps then open /dev/msr, you need to open it first then drop privs as there already is a check to block so much as reads unless you have the RAWIO cap.<br>
<p>
So how does the "read = RAWIO, write = RAWIO &amp;&amp; COMPROMISE" check on open() instead of on write() break userspace? Programs would be refused access to /dev/msr and complain about it, same as before, and their existing 'Check your caps!' error messages would still apply.<br>
<p>
There's a difference between 'breaking' userspace in a way that existing apps error messages don't apply and may not even have error-handling paths for the new issues, and simply enforcing stronger checks in a way compatible with existing error handling.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542986/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542987"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 20:03 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542987/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A program used to work. After a change, that program no longer works. A non-working program is broken. Breaking that program doesn't add any real additional security in the common (ie, non-Secure Boot) case, and so is undesirable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542987/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor543222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2013 15:46 UTC (Sun)
                               by <b>mrjk</b> (subscriber, #48482)
                              [<a href="/Articles/543222/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With the suggested change there would be no program that used to work that would not work now that I can see. Every single current program that worked with dropping privileges after an open would still work the exact same way with caching  the new capability at open time and using the cached value on those opened channels. <br>
<p>
Can you give an example that would now break -- that wouldn't have broken already?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor543223"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2013 17:02 UTC (Sun)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/543223/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Any application that drops all privileges other than CAP_SYS_RAWIO before attempting the open?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543223/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor542773"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 21:36 UTC (Wed)
                               by <b>kugel</b> (subscriber, #70540)
                              [<a href="/Articles/542773/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can the cap dropping be changed to happen in a way such that only those capabilities are dropped that existed when the program was compiled? That said, I know nothing about capability APIs or internals.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542773/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 21:49 UTC (Wed)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/542779/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Imagine a /dev/halt_catch_fire that requires CAP_SYS_RAWIO. Your application runs as root but drops all capabilities, so you never bother making sure that it doesn't accidentally touch /dev/halt_catch-fire. Later, someone decides to add a more fine-grained capability and now either CAP_SYS_RAWIO *or* CAP_SYS_HALT_CATCH_FIRE is sufficient. Your application was previously incapable of setting the machine on fire, but now it can.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor542771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 21:39 UTC (Wed)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/542771/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just for fun I will suggest changing capable from:<br>
<p>
bool capable(int cap)<br>
{<br>
	return ns_capable(&amp;init_user_ns, cap);<br>
}<br>
<p>
to:<br>
<p>
bool capable(int cap)<br>
{<br>
        if (we_dont_trust_root)<br>
                   return false;<br>
	return ns_capable(&amp;init_user_ns, cap);<br>
}<br>
<p>
Which is equivalent to running userspace outside the initial user namespace, and trivially gives you and environment that has been audited to work for an untrusted root.<br>
<p>
Just a few more things won't work that way but I would not mind a little help flushing out the things that we can trust less than fully privileged users with doing.<br>
<p>
As for msrs.  Make no mistake someone will eventually implement rdmsr(HALT_AND_CATCH_FIRE).  So I can't believe even reading msrs is safe.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542782"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2013 22:10 UTC (Wed)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/542782/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Get busy fixing this trivial local root vulnerability you introduced in 3.8 first:<br>
<a href="http://stealth.openwall.net/xSports/clown-newuser.c">http://stealth.openwall.net/xSports/clown-newuser.c</a><br>
<p>
-Brad<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542782/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542805"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 3:12 UTC (Thu)
                               by <b>shlevy</b> (guest, #87221)
                              [<a href="/Articles/542805/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yikes!!! I had to disable fs.protected_hardlinks, but I can confirm this exploit works... Has this been reported to the appropriate channels?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542805/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542824"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 6:51 UTC (Thu)
                               by <b>kees</b> (subscriber, #27264)
                              [<a href="/Articles/542824/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, and this specific issue has already been fixed:<br>
<a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=e66eded8309ebf679d3d3c1f5820d1f2ca332c71">http://git.kernel.org/cgit/linux/kernel/git/torvalds/linu...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542824/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542864"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 11:33 UTC (Thu)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/542864/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Key phrase being "this specific issue".  Several vulnerabilities have already been introduced by the addition of unprivileged user namespaces.  It speaks to the trustworthiness of the code that these were found through casual inspection of a few lines of code and a very dumb fuzzer (trinity) -- it has not been exposed to serious security auditing.  The author of the above exploit said it was the easiest he has ever written.<br>
<p>
You should also know that the existing kernel exploit payloads for granting root privilege also break out of user namespaces without modification.<br>
<p>
So the end result is opening up more attack surface to the most vulnerable part of the system, and soon on all distros you will have no choice but to be exposed to it.  It's just broken security design.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542864/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor543374"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2013 1:57 UTC (Tue)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/543374/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"So the end result is opening up more attack surface to the most vulnerable part of the system, and soon on all distros you will have no choice but to be exposed to it."<br>
<p>
Unfortunately, "less code, simpler code" is not one of the competing security paradigms in Linux Land.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543374/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor542844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">*BSD &quot;securelevel&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 10:03 UTC (Thu)
                               by <b>ewen</b> (subscriber, #4772)
                              [<a href="/Articles/542844/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p>Reading through this article reminded me of *BSDs "<a href="http://www.freebsd.org/doc/faq/security.html#securelevel">securelevel</a>", which is a one-way ratchet change (ie having changed it, you can't change it back to a less secure level except by rebooting).  It controls various "compromise the kernel" like things.  The exact set of things it controls is probably not an ideal match, but the idea of a sysctl value which can only ever be changed to "be at least as restrictive of insecure things you can do as now" seems like a fairly good fit.  And it would be completely orthogonal to the Linux capabilities, which seems helpful.  (As well as being "system wide" which seems desirable in this case -- if you've booted via secure UEFI you probably don't want to end up in a situation where <em>some</em> processes can compromise the kernel and others cannot....)</p>

<p>Ewen</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/542844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542868"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">*BSD &quot;securelevel&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 11:40 UTC (Thu)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/542868/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linux already attempts this a bit inconsistently.  See /proc/sys/kernel/modules_disabled, which does not allow module loading to be re-enabled once disabled.  Yet you can just run: <a href="https://grsecurity.net/~spender/msr32.c">https://grsecurity.net/~spender/msr32.c</a> (before it required no capabilities, now it requires CAP_SYS_RAWIO, but neither matter) and re-enable the supposed securelevel-like value.  There is no CVE for this (only for the adding of CAP_SYS_RAWIO) and no patch for the removal of modules_disabled on x86.  There's no coherency to upstream security.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542868/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542949"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">*BSD &quot;securelevel&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 16:39 UTC (Thu)
                               by <b>ThinkRob</b> (guest, #64513)
                              [<a href="/Articles/542949/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At the risk of going slightly off-topic (though not much, given the matter at hand), what do you think of FreeBSD's approach to kernel security?  I'd be willing to wager you're a fan of the fact that (it seems like) they're a bit more up-front with their security hole disclosure, but what about things like the "secure level" model, jails, capsicum, and other security-oriented features they've introduced -- do you think they're on the right track?<br>
<p>
I know the full answer to this is probably not terribly succinct, but I'm just curious to hear what you think, since kernel security is obviously something you're quite passionate about. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542949/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor543532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">*BSD &quot;securelevel&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2013 9:13 UTC (Wed)
                               by <b>renox</b> (guest, #23785)
                              [<a href="/Articles/543532/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is capsicum actually used in FreeBSD?<br>
AFAIK it's only useful iff programs are ported to use it..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor542974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">*BSD &quot;securelevel&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 18:35 UTC (Thu)
                               by <b>ewen</b> (subscriber, #4772)
                              [<a href="/Articles/542974/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which is an important point: if you're going to implement something like this, it needs to be sufficiently encompassing (in the single switch) that it doesn't allow a user (or attacker) to simply undo it by using an alternative mechanism to manipulate the value.  The *BSD "securelevel" handles that by having a single switch that cuts off a set of things, including raw memory manipulation and module loading.<br>
<p>
It sounds like the "compromise the kernel" flag is also aimed to cut off a more encompassing set of things, so hopefully it'd be less easy to do an end-run around the protection.  (And there'd be more incentive to add "you can't do that either" into the set of things turned off as other ways to manipulate it are discovered: Firewire device DMA being one that comes to mind.)<br>
<p>
Ewen<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor543485"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">*BSD &quot;securelevel&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2013 22:33 UTC (Tue)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/543485/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are enough issues w/ BSD securelevel, too, that it doesn't receive much interest these days. <br>
<p>
For example, the immutable files protection can be bypassed by mounting over the directory. It doesn't allow you to change the original file, but allows you to fool other applications at runtime and is thus of little use for, e.g., preventing root kit installation once you've already attained root.<br>
<p>
AFAIK nobody has bothered to fix it on systems where it was an issue (NetBSD was immune to this particular attack). The fundamental issue is that even this course-grained capabilities system gives a false of security. Invariably someone will forget about some corner case, or some new feature is added which allows circumvention of the whole pile of policies.<br>
<p>
Fine-grained capabilities systems (both system-level and process-level) are just too brittle, including the policies, the mechanisms, and the actual implementations.<br>
<p>
Unix systems have only just recently reached a decent level of correctness and reliability with basic file permissions. Anybody who relies on more sophisticated schemes (or allows them in their kernel) is just begging to be rooted.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543485/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor542872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 12:35 UTC (Thu)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/542872/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems pretty clear from this article that the root of this problem is that the semantic meaning of certain capabilities either was unclear at the start, or was allowed to degenerate from a precise meaning into a mess.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor542873"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 12:55 UTC (Thu)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/542873/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, in other fields of computer science, changing semantics of protocols in incompatible ways is often handled through versioning.<br>
<p>
I.e. the capability calls need a version flag, perhaps?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542873/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor542929"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 14, 2013 15:30 UTC (Thu)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/542929/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And looking into this, cap_user_header_t actually has a version field! So this problem may well be fixable without hacks or breakage, if the kernel developers start to consider that the semantic meaning of capabilities, as exposed to user-space, is versioned.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/542929/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor543895"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2013 4:36 UTC (Fri)
                               by <b>kevinm</b> (guest, #69913)
                              [<a href="/Articles/543895/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>It still sounds to me like the simple solution is <i>"remove CAP_SYS_RAWIO from the initial capability set on secure-booted kernels"</I>.  So you'll lose the ability to perform some iffy SCSI commands - well, you signed up for some bondage and discipline when you asked for a locked-down, secure-booted kernel, didn't you?</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/543895/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor543898"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2013 7:12 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/543898/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the problem is that these 'iffy' scsi commands end up being things like the ability to burn CDs, not exactly easy things to do without.<br>
<p>
Or in enterprise settings, commands to be able to manipulate tape changers<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/543898/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor545349"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 31, 2013 7:12 UTC (Sun)
                               by <b>Duncan</b> (guest, #6647)
                              [<a href="/Articles/545349/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; the problem is that these 'iffy' scsi commands end up being things like the ability to burn CDs, not exactly easy things to do without.</font><br>
<p>
Actually, that's rather less of a problem now, and trending less so, than it was a few years ago when /the/ major form of removable media was optical, CD/DVD.  Now days, the sub-GB size of a CD looks positively diminutive, and even the near-5-GB size of a standard DVD looks small, compared to the ubiquitous USB thumbdrive of say 8+GB.  A Bluray's 25 gigs is a bit better priced media-only (US$6 individual, just over $1/ea in 25-packs, pricewatch.com), but while the stick's a bit more expensive (USB flash: 32G=US$15, 16G=$10)  as it ships with its own housing and read/write hardware, it's also CONSIDERABLY less fragile and generally more easily handled, AND direct-block-device read-writable (well, as seen by the OS...).<br>
<p>
Additionally, with current inet and smartphone penetrations, people that a few years ago might have used dedicated removable media (either USB sticks or CD/DVD) these days more often either use the inet directly (streaming what might have been on CD a few years ago, or pastebinning it to a friend if not attaching it to an email), or if they do play local media, say in the car, it's from a jacked-in phone more often than a CD.<br>
<p>
Unfortunately when I upgraded machines last year I didn't think of that, and bought a blu-ray burner for it.  I really haven't used it...  Fortunately, it's a USB-based one and wasn't /that/ expensive, so it's usable on my netbook as well should I decide to and not taking any power when it's unplugged (see kernel 3.9's new ZPODD, only I've had that in the form of an unplugged USB-based bluray for a few months now), and being USB, as long as I don't mistreat it it should stay usable for years, so I suppose I'll get some use out of it, over time.  But I'd have been better off simply not buying it at all.<br>
<p>
So it's considerably easier to do without optical burning than it was even just a few years ago, to the point where many people would miss it about as much as they do their 1.44 MB floppy...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/545349/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor544065"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2013 23:32 UTC (Fri)
                               by <b>clemenstimpler</b> (guest, #71914)
                              [<a href="/Articles/544065/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It takes a bit, until curious, but uninformed readers learn what this article is about. "CAP_COMPROMISE_KERNEL (formerly known as CAP_SECURE_FIRMWARE) is a new capability designed for use in conjunction with UEFI secure boot, which is a mechanism to ensure that the kernel is booted from an on-disk representation that has not been modified" would have made a great first sentence for this article. It's also nice at the end of the second paragraph, but why not put it in the limelight of the first paragraph, where it rightly belongs? Just saying... ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544065/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor544318"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with CAP_SYS_RAWIO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2013 13:16 UTC (Mon)
                               by <b>mkerrisk</b> (subscriber, #1978)
                              [<a href="/Articles/544318/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; but why not put it in the limelight of the first paragraph, where it rightly belongs?</font><br>
<p>
Reviewing the article, it's a smart editorial suggestion and I agree with you; and it would have made for a punchier start. Next time...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/544318/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
