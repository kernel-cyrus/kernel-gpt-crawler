        <!DOCTYPE html>
        <html lang="en">
        <head><title>Another old security problem [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/404043/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/403542/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/404043/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Another old security problem</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 8, 2010</br>
           </div>
In August, a longstanding kernel security hole related to overflowing the
stack area <a href="http://lwn.net/Articles/400746/">was closed</a>.  But
it turns out there are other problems in this area, at least one of which
has been known about since late last year.  Fixes are in the
works, but it's hard not to wonder if we are not handling security issues as
well as we should be.
<p>
Once again, the problem was reported by Brad Spengler, who posted <a
href="http://www.grsecurity.net/~spender/64bit_dos.c">a short 
program</a> demonstrating how easily things can be made to go wrong.  The
program allocates a single 128KB array, which is filled as a long C
string.  Then, an array of over 24,000 <tt>char&nbsp;*</tt> pointers is
allocated, with each entry pointing to the large string.  The final step is
to call <tt>execv()</tt>, using this array as the arguments to the program
to be run.  In other words, the exploit is telling the kernel to run a
program with as many huge arguments as it can.
<p>
Once upon a time, the kernel had a limit on the maximum number of pages
which could be used by a new program's arguments.  This limit would have
prevented any problems resulting from the sort of abuse shown by Brad's
program, but it was <a
href="http://thread.gmane.org/gmane.linux.ports.hppa/752">removed for
2.6.23</a>; it seems that any sort of limit made life difficult for
Google.  In its place, a new check was put in which looks like this (from
<tt>fs/exec.c</tt>): 
<p>
<pre>
	/*
	 * Limit to 1/4-th the stack size for the argv+env strings.
	 * This ensures that:
	 *  - the remaining binfmt code will not run out of stack space,
	 *  - the program will have a reasonable amount of stack left
	 *    to work from.
	 */
	rlim = current-&gt;signal-&gt;rlim;
	if (size &gt; ACCESS_ONCE(rlim[RLIMIT_STACK].rlim_cur) / 4) {
		put_page(page);
		return NULL;
	}
</pre>
<p>

The reasoning was clear: if the arguments cannot exceed one quarter of the
allowed size for the process's stack, they cannot get completely out of
control.  It turns out that there's a fundamental flaw in that reasoning:
the stack size may well not be subject to a limit at all.  In that case,
the value of the limit is <tt>-1</tt> (all ones, in other words), and the
size check becomes meaningless.  The end result
is that, in some situations, there is no real limit on the amount of stack
space which can be consumed by arguments to <tt>exec()</tt>.  And,
unfortunately, the consequences are not limited to the offending process.

<p>
At a minimum, Brad's exploit is able to oops the system once the stack
tries to expand too far.  He <a href="/Articles/404053/">mentioned</a> the
possibility of expanding the stack down to address zero - thus reopening
the threat of null-pointer exploits - but has not been able to figure out a
way to make such exploits work.  The copying of all those arguments will,
naturally, consume large amounts of system memory; due to another glitch,
that memory use is not properly accounted for, so, if the out-of-memory
killer is brought in to straighten things out, it will not target the
process which is actually causing the problem.  And, as if that were not
enough, the counting and copying of the argument strings is not preemptible
or killable; given that it can run for a very long time, it can be very
hard on the performance of the rest of the system.
<p>
Brad says that he first reported this problem in December, 2009, but got no
response.  More recently, he sent a note to Kees Cook, who posted <a
href="/Articles/404056/">a partial fix</a> in response.  That fix had some
technical problems and was not applied, but Roland McGrath has posted <a
href="/Articles/404060/">a new set of fixes</a> which gets closer.  Roland
has taken a minimal approach, not wanting to limit argument sizes more than
absolutely necessary.  So his patch just ensures that the stack will not
grow below the minimum allowed user-space memory address
(<tt>mmap_min_addr</tt>).  That check, combined with the guard page added
to the stack region by the August fix, should prevent the stack from
growing into harmful areas.  Roland has also added a preemption point to
the argument-copying code to improve interactivity in the rest of the
system, and a signal check 
allowing the process to be killed if necessary.  He has not addressed the
OOM killer issue, which will need to be fixed separately.
<p>
Roland's patch seems likely to fix the worst problems, though some
commenters feel that it does not go far enough.  One assumes that fixes
will be headed toward distribution kernels in the near future.  But there
are a couple of discouraging things to note from this episode:
<p>
<ul>
<li> It seems that the code which is intended to block runaway resource
     use in a core Linux system call was never really tested at its
     extremes.  The Linux kernel community does not have a whole lot of
     people who do this kind of auditing and testing, unfortunately; that
     leaves the task to the people who have an interest (either benign or
     malicious) in security issues.
<p>
<li> It took some nine months after the initial report before anybody tried
     to fix the problem.  That is not the sort of rapid response that this
     community normally takes pride in.
</ul>
<p>
The problem may indicate a key shortcoming in how Linux kernel development
is supported.  There are thousands of developers who are funded to spend at
least some of their time doing kernel work.  Some of those are paid to work
in security-related areas like SELinux or AppArmor.  But it's not at all
clear that anybody is funded simply to make sure that the core kernel is
secure.  That may make it easier for security problems to slip into the
kernel, and it may slow down the response when somebody points out problems
in the code.  There is a strong (and increasing) economic interest in
exploiting security issues in the kernel; perhaps we need to find a way to
increase the level of interest in preventing these issues in the first
place.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Vulnerabilities">Security/Vulnerabilities</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/404043/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor404202"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 11:20 UTC (Thu)
                               by <b>error27</b> (subscriber, #8346)
                              [<a href="/Articles/404202/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's hard to blame all the rest of us for not doing anything when only Ted knew about this bug for the longest time...  *grumble* *grumble*<br>
<p>
Brad, I know you read these pages.  How did you find this bug in the first place?  Was it through a code audit, manual testing or was there a stack trace reported on some bugzilla?<br>
<p>
I'm pretty sure that Eugene and Kees track bugzilla entries for security related stack traces.  It seems that way from the CVEs they issue. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404202/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404341"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 19:52 UTC (Thu)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/404341/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
During an audit of ways to bypass mmap_min_addr.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404341/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor404210"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Nobody working on security</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 12:11 UTC (Thu)
                               by <b>Trou.fr</b> (subscriber, #26289)
                              [<a href="/Articles/404210/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I find it completely stunning that nobody is working on a full-time paid job to handle the security of the kernel.<br>
<p>
Microsoft, having suffered a lot a few years ago, got it right and dedicates a lot of ressources on security, internal testing/fuzzing and all (no trolling indented, just a fact).<br>
<p>
RedHat or the Linux Foundation could certainly pay someone to improve kernel security...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404210/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404945"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Nobody working on security</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2010 13:50 UTC (Tue)
                               by <b>kbad</b> (subscriber, #61983)
                              [<a href="/Articles/404945/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Like Eugene Teo? :P<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404945/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor404247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 15:30 UTC (Thu)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/404247/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Unfortunately, several high-profile kernel developers have shown a distinct antipathy towards anyt issues raised by &ldquo;crack-addled security people&rdquo;.
<p>Which attitude serves quite well to reduce community involvement of anyone with security awareness.
      
          <div class="CommentReplyButton">
            <form action="/Articles/404247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 15:53 UTC (Thu)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/404258/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it's more like those developers have shown antipathy towards some _people_ in the "security circus", more than towards the _issues_ themselves. Linus himself being the archetypal one, he agrees that most kernel bugs can have security implications.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor404321"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 18:05 UTC (Thu)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/404321/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Tried the exploit on my machine.  The DOS aspect is bad, but doesn't completely lock up the machine.  Of course you could run multiple instances.<br>
<p>
What's wrong with the obvious workaround of setting a stack size limit?  The exploit program then outputs a boring "execve failed" message and nothing bad happens.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404321/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404343"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 20:30 UTC (Thu)
                               by <b>martinfick</b> (subscriber, #4455)
                              [<a href="/Articles/404343/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"What's wrong with the obvious workaround of setting a stack size limit? The exploit program then outputs a boring "execve failed" message and nothing bad happens."<br>
<p>
I suspect that the obvious problem is the limit.  Who wants arbitrary limits that are not based on available resources and that affect potentially valid use cases (non exploits)?  As for the nothing bad happens, did you forget that the program (and now likely others that should) didn't run?  By many people's standards, that would be something bad happening. :(<br>
 <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404343/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">valid?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 22:38 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/404356/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Who wants arbitrary limits that are not based on available resources and that affect potentially valid use cases (non exploits)? </font><br>
<p>
Calling a megabytes argv a "valid use case" is a bit of a stretch.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404365"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">valid?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 23:02 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/404365/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I totally disagree.  I love no longer needing to worry about find and xargs all the time.  Does a dir have tens of thousands of files?  Who cares!  Just glob away, it just works.<br>
<p>
A gigabytes argv would be a stretch.  But megabytes?  That seems pretty reasonable to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404365/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor405134"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">valid?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2010 0:51 UTC (Wed)
                               by <b>roelofs</b> (guest, #2599)
                              [<a href="/Articles/405134/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <FONT COLOR="#004488"><I>A gigabytes argv would be a stretch. But megabytes? That seems pretty reasonable to me.</I></FONT>

<P>
Absolutely.  A minor side project of mine involves the generation of 35000 time-series images per year, each with a name of the form "fubar-XX-yyyymmdd-hhmm-UTC.png".  As a same-dir glob, that works out to just over a megabyte; add a "yyyy/" directory prefix and multiple years, and you're easily into the 10MB range.  Increase the time resolution by a factor of 3 to 5, and you're well on your way to 100MB.  (And yes, it's <I>very</I> cool to watch a full-year sequence animate, particularly on a fast machine; a 5- or 10-year sequence would be even better, assuming I could hit 60fps on the decode.)  Of course, at some point it becomes a database-driven custom app, but 10MB command lines are not out of the question with the trivial hack I have so far.

<P>
Greg
      
          <div class="CommentReplyButton">
            <form action="/Articles/405134/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor404366"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">valid?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 23:04 UTC (Thu)
                               by <b>martinfick</b> (subscriber, #4455)
                              [<a href="/Articles/404366/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, and who would ever need more than 640K of RAM?  Let's constrain the  arbitrary limit thinking for DOS(windows) users and devs, not for linux. ;)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404366/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">valid?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2010 19:18 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/404735/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Well, actually, <a href="http://www.jwz.org/gruntle/unix.html">stupid arbitrary limits</a> have long been part of the Unix experience. They're part that GNU set itself against, and I'm glad to say that it hasn't been part of the Linux experience heretofore, and Linux is all the better for it.

      
          <div class="CommentReplyButton">
            <form action="/Articles/404735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404737"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">valid?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2010 19:25 UTC (Mon)
                               by <b>martinfick</b> (subscriber, #4455)
                              [<a href="/Articles/404737/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Very true. I really should used "legacy OS" instead of "DOS/Windows" in my complaint.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404737/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor404370"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2010 23:23 UTC (Thu)
                               by <b>gregkh</b> (subscriber, #8)
                              [<a href="/Articles/404370/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Brad says that he first reported this problem in December, 2009,</font><br>
<font class="QuotedText">&gt; but got no response.</font><br>
<p>
Was this sent to the security contact for the kernel?  I just searched<br>
and could not find any notice sent to security@kernel.org from Brad<br>
during that month.<br>
<p>
If it was not sent there, where was it sent?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404370/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404372"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2010 0:00 UTC (Fri)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/404372/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The comment in 64bit_dos.c says where I sent it and when.  Apparently that's not enough, so here are the full mails.  The context was I was already working with Ted on the ext4 bug, and since he was being responsive, chose to share some additional vulnerabilities with him.  You'll note my reply was within 2 hours of the response I received.  With the general upstream attitude and handling of security bugs, on principle I don't email vendor-sec or security@.<br>
<p>
I hope it's not a complaint you're making, as every time we discover one of these vulnerabilities it's fixed within grsecurity (like this 64kb heap infoleak I actually reported and wasn't credited for:<br>
<a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=42da2f948d949efd0111309f5827bf0298bcc9a4">http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-...</a>), and I have it on good authority from Linus that issuing a patch is the same as full disclosure.  Is it only a problem when the shoe's on the other foot?<br>
<p>
-Brad<br>
<p>
2694 r + Dec 11 12:12PM tytso@mit.edu   Re: ext4 bug<br>
2695 r + Dec 11 03:37PM tytso@mit.edu   &amp;#9492;&amp;#9472;&gt;<br>
<p>
<p>
X-Spam-ASN: AS14742 69.25.192.0/20<br>
X-Spam-Checker-Version: SpamAssassin 3.2.4 (2008-01-01) on www.grsecurity.net<br>
X-Spam-Level:<br>
X-Spam-Status: No, score=0.0 required=5.0 tests=BAYES_50 autolearn=ham<br>
        version=3.2.4<br>
From: tytso@mit.edu<br>
To: Brad Spengler &lt;spender@grsecurity.net&gt;<br>
Subject: Re: ext4 bug<br>
X-SA-Exim-Connect-IP: &lt;locally generated&gt;<br>
X-SA-Exim-Mail-From: tytso@thunk.org<br>
X-SA-Exim-Scanned: No (on thunker.thunk.org); SAEximRunCond expanded to false<br>
<p>
On Fri, Dec 11, 2009 at 01:51:32PM -0500, Brad Spengler wrote:<br>
<font class="QuotedText">&gt; I've also got two local DoS mm-related bugs to be fixed if you'd like to</font><br>
<font class="QuotedText">&gt; take a look at them.  They exist in all 64bit kernels since 2.6.26 or</font><br>
<font class="QuotedText">&gt; so.  The first is an easy fix (we've fixed it in grsec for some time),</font><br>
<font class="QuotedText">&gt; but the other one requires some more thinking and decision making (it's</font><br>
<font class="QuotedText">&gt; memory exhaustion that causes a complete lockup of the machine -- and</font><br>
<font class="QuotedText">&gt; the OOM killer is unaware of the memory because it's not</font><br>
<font class="QuotedText">&gt; associated/accounted for by any task).</font><br>
<p>
Sure, send them my way!<br>
<p>
                                                - Ted<br>
<p>
 842  sF Dec 11 11:57AM To tytso@mit.ed ext4 bug<br>
 843  sF Dec 11 01:51PM To tytso@mit.ed &amp;#9492;&amp;#9472;&gt;<br>
 844  sF Dec 11 05:34PM To tytso@mit.ed   &amp;#9492;&amp;#9472;&amp;#9516;&amp;#9472;&gt;<br>
 845  sF Dec 11 05:40PM To tytso@mit.ed     &amp;#9492;&amp;#9472;&gt;<br>
<p>
To: tytso@mit.edu<br>
Subject: Re: ext4 bug<br>
<p>
[-- PGP output follows (current time: Thu 09 Sep 2010 07:33:02 PM EDT) --]<br>
gpg: Signature made Fri 11 Dec 2009 05:34:56 PM EST using DSA key ID 4245D46A<br>
gpg: Good signature from "Bradley Spengler (spender) &lt;spender@grsecurity.net&gt;"<br>
[-- End of PGP output --]<br>
<p>
[-- The following data is signed --]<br>
<p>
<font class="QuotedText">&gt; Sure, send them my way!</font><br>
&gt;<br>
<font class="QuotedText">&gt;                                               - Ted</font><br>
<p>
Ok, the second issue should be clear with the following PoC:<br>
(make sure to set your stack soft-limit to unlimited first, and compile<br>
it as 32bit, run on a 64bit machine)<br>
<p>
#include &lt;stdio.h&gt;<br>
#include &lt;stdlib.h&gt;<br>
#include &lt;string.h&gt;<br>
#include &lt;unistd.h&gt;<br>
<p>
#define NUM_ARGS 9000<br>
<p>
int main(void)<br>
{<br>
        char **args;<br>
        char *str;<br>
        int i;<br>
<p>
        str = malloc(128 * 1024);<br>
        memset(str, 'A', 128 * 1024 - 1);<br>
        str[128 * 1024 - 1] = '\0';<br>
        args = malloc(NUM_ARGS * sizeof(char *));<br>
        for (i = 0; i &lt; (NUM_ARGS - 1); i++)<br>
                args[i] = str;<br>
        args[i] = NULL;<br>
<p>
        execv("/bin/sh", args);<br>
        printf("execve failed\n");<br>
<p>
        return 0;<br>
}<br>
<p>
It requires very little memory on the part of the program doing the<br>
exec, but then explodes in kernel-space as each 128KB arg is copied into<br>
its own allocation thousands of times.  The system slows to the point of<br>
being unusable (or with the right arg amount, will halt the box from the<br>
problem below)  Meanwhile, none of the processes involved in this will<br>
get killed by the OOM killer, as none of the memory is accounted for.<br>
(that's where the thinking comes in on how to properly fix it)<br>
<p>
first issue is fs/exec.c:shift_arg_pages()<br>
Using the PoC above, you can change NUM_ARGS such that instead of<br>
exhausting all memory and locking up the system, you cause the stack to<br>
expand down so far that it tries to wrap around the address space,<br>
triggering the BUG_ON(new_start &gt; new_end)<br>
<p>
The reason this is possible on 64bit machines is because the resource<br>
check in get_arg_page: if (size &gt; rlim[RLIMIT_STACK].rlim_cur / 4)<br>
allows stack sizes that are larger than the 32bit address space, as<br>
rlim_cur is a long, and the RLIM_INFINITY soft limit is being treated<br>
an actual size count, being both larger than the possible addressing on<br>
x86 and x64, even after being divided by 4.  So by carefully choosing<br>
NUM_ARGS, you can cause the stack randomization present in the kernel to<br>
attempt to shift the arg pages down below the beginning of the address<br>
space, triggering the BUG.  It can be made easier (depending on the<br>
amount of RAM on the machine) by using the 3G personality.<br>
<p>
-Brad<br>
<p>
[-- End of signed data --]<br>
<p>
To: tytso@mit.edu<br>
Subject: Re: ext4 bug<br>
<p>
[-- PGP output follows (current time: Thu 09 Sep 2010 07:33:33 PM EDT) --]<br>
gpg: Signature made Fri 11 Dec 2009 05:40:37 PM EST using DSA key ID 4245D46A<br>
gpg: Good signature from "Bradley Spengler (spender) &lt;spender@grsecurity.net&gt;"<br>
[-- End of PGP output --]<br>
<p>
[-- The following data is signed --]<br>
<p>
Sorry, NUM_ARGS should be set larger -- around 24550 or so, to fill up<br>
the full 3GB.  And the resource exhaustion works on 32bit, just the<br>
BUG_ON is only triggerable on 64bit machines.<br>
<p>
-Brad<br>
<p>
[-- End of signed data --]<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404372/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404493"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2010 20:23 UTC (Fri)
                               by <b>gregkh</b> (subscriber, #8)
                              [<a href="/Articles/404493/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; With the general upstream attitude and handling of security bugs, on</font><br>
<font class="QuotedText">&gt; principle I don't email vendor-sec or security@.</font><br>
<p>
That's sad, as security@kernel.org is the only group that will guarantee<br>
that we will look at the issue and work to resolve it in a quick manner.<br>
<p>
<font class="QuotedText">&gt; Is it only a problem when the shoe's on the other foot?</font><br>
<p>
No, I was worried that something got reported to security@kernel.org<br>
that we did not respond to in a timely manner.<br>
<p>
If you notify random kernel developers, one of whom is not part of the<br>
kernel security team, then we can't guarantee any type of response.<br>
Which, sadly, seems to be the case here.  Otherwise the problem would<br>
have been resolved a long time ago.<br>
<p>
In the future, it would be great if you could notify security@kernel.org<br>
about these types of problems so that they can be handled properly.<br>
<p>
thanks.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404493/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor404494"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2010 20:31 UTC (Fri)
                               by <b>Trelane</b> (subscriber, #56877)
                              [<a href="/Articles/404494/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>since he was being responsive, chose to share some additional vulnerabilities with him.</blockquote>

Mmm, this sounds like you sit on vulnerabilities, choosing to notify people who can fix it upstream if and only if they're "being responsive".  Is this accurate?  Are you sitting on any now?

<blockquote>With the general upstream attitude and handling of security bugs, on principle I don't email vendor-sec or security@.</blockquote>

What principle is this that you're acting on?
      
          <div class="CommentReplyButton">
            <form action="/Articles/404494/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor404505"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2010 21:25 UTC (Fri)
                               by <b>rilder</b> (guest, #59804)
                              [<a href="/Articles/404505/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am not sure about the unlimited stack size. Most (or all) distro kernels restrict stack size. In my case it is 8 MB which I think is quite sufficient even for large systems. <br>
<p>
Are there applications  which would *normally* require stack greater than this ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404505/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404509"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2010 23:14 UTC (Fri)
                               by <b>daglwn</b> (guest, #65432)
                              [<a href="/Articles/404509/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Absolutely.  Many scientific codes regularly exceed this amount of stack.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404509/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404512"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2010 0:02 UTC (Sat)
                               by <b>jspaleta</b> (subscriber, #50639)
                              [<a href="/Articles/404512/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would not call scientific codes... normal.. nor the people who run them. <br>
<p>
-jef<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404512/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2010 4:29 UTC (Sat)
                               by <b>Trelane</b> (subscriber, #56877)
                              [<a href="/Articles/404528/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hey! I represent that remark.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor404544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2010 10:50 UTC (Sat)
                               by <b>rilder</b> (guest, #59804)
                              [<a href="/Articles/404544/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I implied through that comments is this - in regular desktop environments it won't happen(cat /proc/**/status | grep -i vmstk didn't reveal more than 100-200 KB) . However, higher stack usage may be visible in applications in enterprise or as you said scientific establishments. Though, in such conditions the applications/packages installed on the host remain stable over time and are carefully chosen with lot of testing, so any of these exploits may not find their place there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor404554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2010 14:01 UTC (Sat)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/404554/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure you understand the meaning of 'exploit' or the difference between soft and hard limits.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/404554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor405226"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2010 9:10 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/405226/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Rilder made a perfectly good point: applications do not generally need vast stacks (not even Emacs!). Thus it is reasonable to impose a hard limit.<br>
<p>
That distros generally impose soft limits instead (for no particularly obvious reason in the case of stack size) is no barrier to imposing a hard limit yourself.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/405226/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor405975"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Another old security problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2010 20:34 UTC (Fri)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/405975/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I am not sure about the unlimited stack size. Most (or all) distro kernels restrict stack size. In my case it is 8 MB which I think is quite sufficient even for large systems. </font><br>
<p>
The *default* for *thread* stacks (which are of fixed size instead of automatically growing like main process stack) is commonly set to 8MB.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/405975/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
