        <!DOCTYPE html>
        <html lang="en">
        <head><title>Toward a real &quot;too small to fail&quot; rule [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/964793/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/965369/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/964793/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Toward a real &quot;too small to fail&quot; rule</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 18, 2024</br>
           </div>
Kernel developers have long been told that any attempt to allocate memory
might fail, so their code must be prepared for memory to be unavailable.
Informally, though, the kernel's memory-management subsystem implements a
policy whereby requests below a certain size will not fail (in process
context, at least), regardless of
how tight memory may be.  A recent discussion on the linux-mm list has
looked at the idea of making <a href="/Articles/723317/">the "too small to
fail" rule</a> a policy that developers can rely on.
<p>
The kernel is unable to use virtual memory, so it is strictly bound by the
amount of physical memory in the system.  Depending on what sort of
workload is running, that memory could be tied up in various ways and
unavailable for allocation elsewhere.  Allowing allocation requests to fail
gives the kernel the freedom to avoid making things worse when memory
pressure is high.
<p>
There are some downsides to failing an allocation request, of course.
Whatever operation needed that memory will also be likely to fail, and that
failure will probably propagate out to user space, resulting in disgruntled
users.  There is also a significant chance that the kernel will not handle
the allocation failure properly, even if the developers have been properly
diligent.  Failure paths can be hard to test; many of those paths in the
kernel may never have been executed and, as a consequence, many are likely
to have bugs.  Unwinding an operation halfway through can be a complex
business, which is not the kind of task one wants to see entrusted to
untested code.
<p>
Recently, Neil Brown <a
href="/ml/linux-mm/170925937840.24797.2167230750547152404@noble.neil.brown.name/">started
a sub-thread</a> in a wide-ranging discussion on memory-management policies
by suggesting a reconsideration of the rules around <tt>GFP_KERNEL</tt>
allocations.  Currently, programmers have to be prepared for those calls to
fail, even if, in fact, the kernel will not fail small allocations.  Brown
proposed to make the "too small to fail" behavior a documented rule, at
least for allocations below a predefined size.  <tt>GFP_KERNEL</tt>
allocations are allowed to sleep, he said, and thus have access to all of
the kernel's machinery for freeing memory.  In the worst case, the
out-of-memory (OOM) killer can be summoned to remove a few processes from
the system. If this code is unable to create some free memory, he said,
"<q>the machine is a goner anyway</q>".  If, instead, <tt>GFP_KERNEL</tt>
allocations would always succeed, he concluded, it "<q>would allow us to
remove a lot of untested error handling code</q>".
<p>
Kent Overstreet <a
href="/ml/linux-mm/wpof7womk7rzsqeox63pquq7jfx4qdyb3t45tqogcvxvfvdeza@ospqr2yemjah/">objected</a>
to this idea, though.  It is common, he said, for kernel code to attempt to
allocate memory to carry out a task efficiently, but to be able to fall
back to a slower approach if the memory is unavailable; such mechanisms
will not work if memory requests do not fail.  Even worse, the kernel's
efforts to satisfy such requests may worsen performance elsewhere in the
system. Without allocation failure, there is no signal to indicate that
memory is tight; the implementation of memory overcommit for user space
has, he said, made it impossible to use memory efficiently there.
<p>
The real solution, he said, is proper testing of all those error paths;
"<q>relying on the OOM killer and saying that because [of] that now we don't
have to write and test your error paths is a lazy cop out</q>".  James
Bottomley <a
href="/ml/linux-mm/a43cf329bcfad3c52540fe33e35e2e65b0635bfd.camel@HansenPartnership.com/">disagreed</a>,
pointing out that the OOM killer only runs in extreme situation, and that
error paths are a problem.  "<q>Error legs are the least exercised and most
bug, and therefore exploit-prone pieces of code in C.  If we can get rid of
them, we should.</q>" Overstreet <a
href="/ml/linux-mm/3bykct7dzcduugy6kvp7n32sao4yavgbj2oui2rpidinst2zmn@e5qti5lkq25t/">was
unimpressed</a>: "<q>Having working error paths is _basic_, and learning
how to test your code is also basic. If you can't be bothered to do that
you shouldn't be writing kernel code.</q>"
<p>
Dave Chinner, instead, was <a
href="/ml/linux-mm/ZeFtrzN34cLhjjHK@dread.disaster.area/">enthusiastically
supportive</a> of the idea.  The XFS filesystem, he said, was originally
developed for a kernel (IRIX) that provided a guarantee for allocations.
"<q>A simple change to make long standing behaviour an actual policy we can
rely on means we can remove both code and test matrix overhead - it's a
win-win IMO.</q>"
<p>
Brown later <a
href="/ml/linux-mm/170933687972.24797.18406852925615624495@noble.neil.brown.name/">modified
his proposal</a> slightly, noting that changing the semantics of
<tt>GFP_KERNEL</tt> might cause problems for existing code.  Instead,
perhaps, <tt>GFP_KERNEL</tt> could be deprecated entirely in favor of a new
set of allocation types.  He later <a
href="/ml/linux-mm/170950594802.24797.17587526251920021411@noble.neil.brown.name/">suggested</a>
this hierarchy:
<p>
<ul class="spacylist">
<li> <tt>GFP_NOFAIL</tt> would explicitly request the "cannot fail"
     behavior and could, as a result, wait a long time for an allocation
     request to be fulfilled.
<li> <tt>GFP_KILLABLE</tt> would be the same as <tt>GFP_NOFAIL</tt>, with
     the exception that requests will fail in the presence of a fatal
     signal.
<li> <tt>GFP_RETRY</tt> would make multiple attempts to satisfy an
     allocation request, but would eventually fail if no progress is made.
<li> <tt>GFP_NO_RETRY</tt> would only allow a single attempt (which could
     still sleep) at allocating memory, after which the request would fail.
<li> <tt>GFP_ATOMIC</tt> would not sleep at all (which is the current
     behavior).
</ul>
<p>
Given these options, he said, <tt>GFP_KERNEL</tt> could go:
<p>
<blockquote class="bq">
	I don't see how "GFP_KERNEL" fits into that spectrum.  The
	definition of "this will try really hard, but might fail and we
	can't really tell you what circumstances it might fail in" isn't
	fun to work with.
</blockquote>
<p>
Overstreet <a
href="/ml/linux-mm/aownm3xt34rju5tvhsrkbcurls2vlyzueamreiqd3uuompyioj@x3wkk7w6iroy/">responded</a>,
once again, that these changes were not needed: "<q>We just need to make
sure error paths are getting tested - we need more practical fault
injection, that's all.</q>"  Chinner, instead, <a
href="/ml/linux-mm/ZeUTyxYFS6kGoM1h@dread.disaster.area/">commented</a>
that <tt>GFP_KILLABLE</tt> and <tt>GFP_RETRY</tt> were essentially the same
thing; Brown <a
href="/ml/linux-mm/170951501074.24797.10807279234722357224@noble.neil.brown.name/">responded</a>
that, perhaps, the key distinguishing feature of those allocation types is
that they would not invoke the OOM killer; perhaps both of them could be
replaced with a single <tt>GFP_NOOOM</tt> type.  "<q>We might need a better
name than GFP_NOOOM :-)</q>".
<p>
Matthew Wilcox <a
href="/ml/linux-mm/ZeUXORziOwkuB-tP@casper.infradead.org/">raised</a> a
different sort of objection.  The proper allocation policy for any given
request depends on the context in which the request is made; a function
called from an interrupt handler has fewer options available than one
running in process context.  Sometimes, the code that knows about that
context is several steps back in the call chain from the function doing the
allocation.  The way to set the allocation type, he said, is through the
use of context flags applied to the current thread.
<p>
Brown, though, <a
href="/ml/linux-mm/170951563963.24797.10928820769529800242@noble.neil.brown.name/">pointed
out</a> that this context is not the full picture.  If code has been
written assuming <tt>GFP_NOFAIL</tt> behavior, it would be incorrect to
allow the context to change an allocation into one that could fail:
"<q>context cannot add error handling</q>".
<p>
Vlastimil Babka <a
href="/ml/linux-mm/a7862cf1-1ed2-4c2c-8a27-f9d950ff4da5@suse.cz/">worried</a>
that deprecating <tt>GFP_KERNEL</tt> would be an unending task.  Instead,
guaranteeing "too small to fail" could be done quickly, and modifying
specific call sites to allow allocation failure would be a relatively easy
task, so he suggested taking that path.  Brown, though, <a
href="/ml/linux-mm/171028138478.13576.3004333623297072625@noble.neil.brown.name/">answered</a>
that <a href="/Articles/424657/">removing the big kernel lock</a> also took
a long time: "<q>I don't think this is something we should be afraid
of</q>".  Since redefining <tt>GFP_KERNEL</tt> also implies removing
error-handling code, he said, it should still be handled one call site at a
time.

<p>
The discussion wound down at about this point, but there is a good chance
that we'll be hearing these ideas again.  The kernel, for all practical
purposes, already implements <tt>GFP_NOFAIL</tt> behavior for allocations
of eight pages or less.  Turning the behavior into a guarantee would
allow for significant simplification and the removal of a lot of untested
code.  That is an idea with significant appeal; it would be surprising if
it did not come up at the <a
href="https://events.linuxfoundation.org/lsfmmbpf/">Linux Storage,
Filesystem, Memory-Management and BPF Summit</a> in May.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Page_allocator">Memory management/Page allocator</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/964793/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor965844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 16:57 UTC (Mon)
                               by <b>Baughn</b> (subscriber, #124425)
                              [<a href="/Articles/965844/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Just write correct code" appears an unfortunately common sentiment.<br>
<p>
One should test error paths, of course. But bugs happen, and *any* additional code is another opportunity for failure. If there is an opportunity to reduce the size of the codebase, especially by replacing badly-tested code with a presumably well-tested central allocator, shouldn't we take that opportunity?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965847"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 17:15 UTC (Mon)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/965847/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, does the kernel have real testing infrastructure? I know there are a couple of self-tests you can run on startup, but is there something that scales to hundreds of thousands of test cases giving significant coverage across key systems?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965847/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 18:02 UTC (Mon)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/965848/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's a bunch of test systems (some would say too many) but the closest there is probably kunit.<br>
<p>
Having a unit test system is the easy part though, the hard part is that the code needs to be (re)written in a style that makes unit testing possible in the first place, which really requires most of the community to buy into your system. Otherwise you're stuck in an endless cycle of mocking and stubbing and enormous setup code and slow unit tests and writing dummy drivers etc. which is, in practice, too much annoyance for most developers to bother with. So you end up with whatever random integration tests and shell scripts someone wrote once. Which nobody actually runs during development because it takes way too long.<br>
<p>
Incidentally stochastic systems like error injection are really the worst here, because in my experience they always take a ton of effort to set up in a useful way, ages to run with any confidence and give hard to interpret results.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965857"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 18:21 UTC (Mon)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/965857/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, so there's no basic way of actually knowing the error handling is correct, since it's basically untested? Only really human inspection, which we know requires superhumans to work well?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965857/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965870"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 20:36 UTC (Mon)
                               by <b>vegard</b> (subscriber, #52330)
                              [<a href="/Articles/965870/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
syzbot runs syzkaller on a huge amount of kernel code reachable from userspace (though probably not all of it, under all conceivable conditions). With fault injection you could be pretty sure that it eventually tests most failure paths. I had some patches at some point for detecting novel call stacks and injecting a fault there: <a href="https://lore.kernel.org/all/20161016155612.4784-10-vegard.nossum@oracle.com/">https://lore.kernel.org/all/20161016155612.4784-10-vegard...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965870/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2024 2:15 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/966116/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ISTR reading an LWN article a while back about kernel developers complaining that syzbot finds too much... is it actually finding non-bugs, or is it finding bugs-that-we-don't-care-about-very-much? If the latter, then I fear this may be a people problem rather than a technical problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/966116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2024 7:03 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/966128/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Clarifying since I realized this can be misinterpreted: A "people problem" could mean anything from "some developers don't care about writing correct code," all the way to "well, of course they *care*, they just don't have enough people to physically do the work, so it won't get done." Those are both "people problems," but of very different kinds.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/966128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2024 7:33 UTC (Thu)
                               by <b>vegard</b> (subscriber, #52330)
                              [<a href="/Articles/966130/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not a maintainer, but my impression is that some maintainers are stressed and syzbot is adding to their workload.<br>
<p>
I can understand it; if you're completely underwater already and somebody comes in and piles additional work that isn't even an issue that a real person ran into, while feeling the pressure of providing and validating fixes (if nobody else is), it seems unnecessary and annoying.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/966130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor965859"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 18:48 UTC (Mon)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/965859/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
kunit isn't what you want for testing memory allocation failure paths, you'll never have unit tests for this stuff. You just need to run the big integration tests that you already have (e.g. fstests) with fault injection.<br>
<p>
The thing that's made this hard in the past is that you need to be specific about which allocation callsites you're injecting errors into, or your tests will fail in ways that you weren't expecting. That's the capability we don't have yet: we have error injection in the kernel, but it doesn't have facilities for defining per callsite injection points and I've never seen anyone use it for testing memory allocation failures.<br>
<p>
I have a fault injection framework that can do this which I'll be posting as soon as memory allocation profiling gets merged. Memory allocation profiling adds all the infrastructure - code tagging, which it uses as well, and it turns allocations into macro calls so we can do per-callsite hooking.<br>
<p>
I've used this approach in the past, on early bcachefs/late bcache, and it worked well; test coverage by percentage of lines of source code was &gt; 90%. It's just taken awhile to get all the pieces assembled into a form that's upstreamable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965859/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 6:31 UTC (Tue)
                               by <b>PengZheng</b> (subscriber, #108006)
                              [<a href="/Articles/965889/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; kunit isn't what you want for testing memory allocation failure paths, you'll never have unit tests for this stuff. You just need to run the big integration tests that you already have (e.g. fstests) with fault injection.</span><br>
<p>
<span class="QuotedText">&gt; The thing that's made this hard in the past is that you need to be specific about which allocation callsites you're injecting errors into, or your tests will fail in ways that you weren't expecting. That's the capability we don't have yet: we have error injection in the kernel, but it doesn't have facilities for defining per callsite injection points and I've never seen anyone use it for testing memory allocation failures.</span><br>
<p>
We did lots of memory allocation error injections in unit tests, though in user space. <br>
And the error injectors are very easy to write, which are actually generated by GitHub Copilot.<br>
<p>
<a href="https://github.com/apache/celix/blob/master/libs/error_injector/malloc/src/malloc_ei.cc">https://github.com/apache/celix/blob/master/libs/error_in...</a><br>
<p>
The way to use it is quite straightforward: just link to the CMake target Celix::malloc_ei.<br>
<p>
Specifying precise call sites to fail is also easier:<br>
<a href="https://github.com/apache/celix/blob/master/libs/error_injector/README.md">https://github.com/apache/celix/blob/master/libs/error_in...</a><br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965911"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 10:42 UTC (Tue)
                               by <b>gray_-_wolf</b> (subscriber, #131074)
                              [<a href="/Articles/965911/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  And the error injectors are very easy to write, which are actually generated by GitHub Copilot.</span><br>
<p>
Do I understand it right that the file <a href="https://github.com/apache/celix/blob/master/libs/error_injector/malloc/src/malloc_ei.cc">https://github.com/apache/celix/blob/master/libs/error_in...</a> was generated by Copilot?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965911/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965912"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 10:52 UTC (Tue)
                               by <b>PengZheng</b> (subscriber, #108006)
                              [<a href="/Articles/965912/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Every single stub is generated by Copilot not the whole C file.<br>
<p>
There is no copyright issue, since there is almost only one way to write stub, such as<br>
<p>
void *__real_malloc(size_t);<br>
CELIX_EI_DEFINE(malloc, void *)<br>
void *__wrap_malloc(size_t size) {<br>
    errno = ENOMEM;<br>
    CELIX_EI_IMPL(malloc);<br>
    errno = 0;<br>
    return __real_malloc(size);<br>
}<br>
<p>
There is actually no real difference if it is written by hand or generated by AI.<br>
By the way, it is us create the pattern. <br>
AI just recognize the pattern we created and follows the pattern.<br>
<p>
Rest assured that 100% no copyright issue involved.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965912/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 11:16 UTC (Tue)
                               by <b>gray_-_wolf</b> (subscriber, #131074)
                              [<a href="/Articles/965916/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually what surprised me was the license of the file, since I was under the impression that LLM produced output is not copyrightable.  So I am trying to understand why the file is under Apache license 2 instead of, I don't know, public domain or something.<br>
<p>
Would you happen to know what the consensus here is?  Can you just slap any license you want on the output of copilot?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 11:30 UTC (Tue)
                               by <b>PengZheng</b> (subscriber, #108006)
                              [<a href="/Articles/965917/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  Would you happen to know what the consensus here is? Can you just slap any license you want on the output of copilot?</span><br>
<p>
If there is no difference between AI-generated output and hand-written codes, since there happens to be only one way of writing stub, why bother worrying copyright issues. Not to mention that I invented the mentioned way. <br>
<p>
Moreover, the mentioned tests can be put under public domain or any license (because they are not essential part of the project), and are not installed anywhere outside of the project.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965924"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 12:45 UTC (Tue)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/965924/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you are relying on the argument that there is only 1 way to write something, and hence there is nothing creative to it, and hence it is not copyrightable, then... surely you can not claim a copyright over it, and hence can not put a licence notice on it either?<br>
<p>
Smells like you get some advice on this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965924/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965925"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 12:53 UTC (Tue)
                               by <b>PengZheng</b> (subscriber, #108006)
                              [<a href="/Articles/965925/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there any argument? I just said there is nothing to worry about and I really don't care these issues.<br>
The licenses put there are just IDE boilerplate. <br>
<p>
If any one interested to correct this, just send a PR to remove these licenses claim, I will happily apply them.<br>
Unless some lawyers find me, I won't bother worrying this and leave it as is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965925/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor965918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 11:35 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/965918/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You shouldn't be able to slap ANY copyright on the output of Co-Pilot. After all, it's not your work. HOWEVER.<br>
<p>
If you fed it a template and said "write in this style", then your input is your copyright. Co-Pilot's work is a derived work, therefore your copyright flows through to the output.<br>
<p>
Equally, if you review AND CORRECT Co-Pilot's work, then you have created a derivative work, and you can claim copyright in the derivative.<br>
<p>
But no, as a fundamental rule I think it's been pretty much decided that Co-Pilot's work is not copyrightable, what matters is the pre-existing copyrights on the works Co-Pilot used as input, and post-process copyrights added to the output.<br>
<p>
Europe I think has specifically said using copyrighted works as INPUT is not infringing, so the LLM "academics" are not breaching copyright - they have NOT said that using the output is non-infringing ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965927"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 13:46 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/965927/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; But no, as a fundamental rule I think it's been pretty much decided that Co-Pilot's work is not copyrightable</span><br>
<p>
This has not been legally determined yet, and cautious users should avoid assuming this. It may also also end up depending on jurisdiction.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965927/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965932"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 16:45 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/965932/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well if a Gorilla can't get copyright, I seriously doubt an AI can!<br>
<p>
I think it's a pretty safe bet you cannot put an AI down as the copyright holder. An AI can't ADD copyright, nor can it REMOVE it.<br>
<p>
Feeding stuff in is (in places like Europe) defined in law as "non-infringing", aiui, but it says nothing about getting stuff out again :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965932/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965968"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 21:22 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/965968/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, when you said "Co-Pilot's work is not copyrightable", I thought you were saying you thought AI output was in general not copyrightable (not legally determined), rather than that the AI itself cannot be an author and hold copyright (legally quite certain barring unlikely changes in law).<br>
<p>
<span class="QuotedText">&gt; nor can it REMOVE it.</span><br>
<p>
We're likely on the same page, then. Hopefully courts agree.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965968/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor966183"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2024 11:33 UTC (Thu)
                               by <b>Karellen</b> (subscriber, #67644)
                              [<a href="/Articles/966183/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>If you fed it a template and said "write in this style", then your input is your copyright. Co-Pilot's work is a derived work, therefore your copyright flows through to the output.</blockquote>

<p>Hmmm..... if you wrote a story where half the characters were lifted from another story, and all their dialogue were copied verbatim from that story, with your new characters reacting differently to those events, then your inputs from the new characters is your copyright, and the work as a whole is derived from your work.</p>

<p>...but, it is also derived from the story you got the other characters from. Just because some of the work is yours, does not automatically give you the right to claim copyright over the whole work. See also, music sampling. Just because you wrote 95% of a song, that does not allow you to claim copyright over a small sample you lifted from elsewhere and looped in the background of your track. Even if you chop a small sample up into even smaller pieces and re-order them to be almost unrecognisable, that fact that you got those pieces from an existing work is the issue.</p>

<p>I don't think it's reasonable to conclude that the copyright of all the <em>other</em> inputs to a final work (e.g. all the other inputs to Co-Pilot's training) can just be ignored, simply because you have a claim to one of the inputs, or even to a majority of the inputs.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/966183/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2024 15:10 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/966248/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;&gt; If you fed it a template and said "write in this style", then your input is your copyright. Co-Pilot's work is a derived work, therefore your copyright flows through to the output.</span><br>
<p>
<span class="QuotedText">&gt; Hmmm..... if you wrote a story where half the characters were lifted from another story, and all their dialogue were copied verbatim from that story, with your new characters reacting differently to those events, then your inputs from the new characters is your copyright, and the work as a whole is derived from your work.</span><br>
<p>
Are you reading via "Unread comments"? It's great, but it does strip context.<br>
<p>
My intent (which I thought was obvious) was that the template was YOUR WORK, therefore YOUR COPYRIGHT. Therefore Co-Pilot's (or any other AI's) work is *also* your copyright.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/966248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor965909"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 9:48 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/965909/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You really need fault injection unit tests if you want this to work. Just running an integration test and injecting faults randomly, it's too easy to regress specific call sites and not get caught.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965909/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor965850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 17:53 UTC (Mon)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/965850/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The statement that error paths are hard to test or almost impossible to test is wrong, though.<br>
<p>
It is true that testing error paths in a system test is hard and often impossible.<br>
But testing error paths in a unit test is pretty straight forward.<br>
That of course means there must be unit tests. Which is rarely the case for kernel code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965869"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 20:29 UTC (Mon)
                               by <b>zorro</b> (subscriber, #45643)
                              [<a href="/Articles/965869/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"The kernel, for all practical purposes, already implements GFP_NOFAIL behavior for allocations of eight pages or less"<br>
<p>
How do you test an error path if there is no practical way to trigger it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965869/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 20:35 UTC (Mon)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/965871/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fault injection and/or unit tests with stubbed/instrumented allocation.<br>
<p>
What you are referring to is the system test with the normal kernel allocator. Which of course makes it impossible, as I already said.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 2:57 UTC (Tue)
                               by <b>shemminger</b> (subscriber, #5739)
                              [<a href="/Articles/965882/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This has been done in the past with modified kernel allocator that returns failure randomly.<br>
But there are so many error paths and most of them just lead to an unusable system (ie. panic on boot).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 6:04 UTC (Tue)
                               by <b>sima</b> (subscriber, #160698)
                              [<a href="/Articles/965888/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The fault injection framework allows you to limit faults to specific processes, which is I think the mode syzkaller uses. This still means you won't be able to test error paths that are executed from kernel threads and stuff like that (unless extra care is taking to include those), but there's a lot of error paths you can test.<br>
<p>
I think the next level would be if syzkaller could decide which allocations to fail, so that it can include those paths in it's fuzzing exploration. But I haven't heard of anyone trying that yet.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor965890"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 6:27 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/965890/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am not talking about a system test. I'm talking about a unit test.<br>
There is no boot or "unusable system" in a unit test.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965890/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor965866"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2024 19:31 UTC (Mon)
                               by <b>bof</b> (subscriber, #110741)
                              [<a href="/Articles/965866/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; "We might need a better name than GFP_NOOOM :-)".</span><br>
<p>
Eh, isn't the answer to that obvious? It's about Disabling OOM, right?<br>
<p>
--&gt; GFP_DOOM<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965866/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor965904"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 8:47 UTC (Tue)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/965904/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Basically the discussion on the anti-testing side seems to boil down to "I want the problem that in the real world this operation can fail to be someone else's problem because handling that failure would be too hard to do correctly"<br>
<p>
To me this all reads as the death throes of the "sufficiently smart and disciplined" programmer sentiment that underlies the whole philosophy of using languages like C which do not give you much help checking the correctness of your code.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965904/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965913"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 11:00 UTC (Tue)
                               by <b>azumanga</b> (subscriber, #90158)
                              [<a href="/Articles/965913/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If your kernel has reached the point where a 4K allocation doesn't work, you are very likely to hit a cascade effect, where attempts at recovering also fail to allocate, and allocations fail all over the kernel.<br>
<p>
I've worked, once, on a system where we really cared about this type of thing -- but it was a very tiny embedded program, and it was still incredibly hard to set up enough testing that we were confident we hit all the possible failure cases. I can't imagine doing it in practice for something the size of the kernel, and I'm also not sure there would be any useful benefit to the kernel doing slightly better at surviving when such tiny allocations can't be satisfied, rather than just giving up altogether.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965913/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor965910"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 14:20 UTC (Tue)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/965910/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Untested branch code is a problem in any language. For C, we have gcov for that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965910/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965933"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 16:56 UTC (Tue)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/965933/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Some languages more than others though. In strict languages like Rust (and to some extent C++) the compiler can check and ensure invariants are not violated in the error paths even if they are never run.<br>
<p>
So stuff like use-after-free, leaked memory, duplicated or leaks locks are not possible, and since those are precisely the kind of things that go wrong in error paths that's a huge win.<br>
<p>
If your error handling is more complicated that 'clean up and return error' you probably need a test case anyway. But not having to write test cases for the common case saves a lot of time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965933/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor965961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 17:21 UTC (Tue)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/965961/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For me the biggest problem with guaranteeing a too-small-to-fail threshold is that you can't ever lower the threshold without auditing all allocations kernel-wide before.<br>
I do realize that is basically is also true today, because an error path could be broken.<br>
But I still think it's a difference to have an error path that is probably correct vs. having no error path at all. In the second case you would have to audit the allocation and *write* the error path, if you want to lower the threshold.<br>
<p>
Most error paths are actually not that hard to get right and could actually be automatically implemented in Rust without any manual code. (Drop is called automatically, in the correct order)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor965976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2024 0:09 UTC (Wed)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/965976/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; For me the biggest problem with guaranteeing a too-small-to-fail threshold is that you can't ever lower the threshold without auditing all allocations kernel-wide before.</span><br>
<p>
I think that API would have to guarantee that the allocation never fails - no matter what size.  It may, however, block indefinitely.<br>
<p>
The threshold would be implemented by a WARN_ON every time there was an attempt to allocate larger than the threshold.<br>
We might also have a developer-mode where a message is generated each time there is a request with a larger size than the previous max - like the "used greatest stack depth" messages.<br>
That way developers would have help to ensure it is only used for "small" allocations.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966012"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2024 10:38 UTC (Wed)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/966012/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>In that respect, <a href="https://lwn.net/ml/linux-mm/170950594802.24797.17587526251920021411@noble.neil.brown.name/">your proposal for a hierarchy of wait versus fail options</a> from "retry forever until you succeed" through to "fail immediately" is effective; instead of allocations never failing because they're small, they're failure-proof because the caller has said "retry forever until you succeed".
<p>If I understand this proposal fully, you'd then have a warning on "large" allocations that were marked to retry forever, since they're likely to block forever, and the "too small to fail" threshold becomes the warning threshold for allocations that are likely to block forever, instead of an API guarantee.


      
          <div class="CommentReplyButton">
            <form action="/Articles/966012/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor965973"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2024 23:38 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/965973/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; "I want the problem that ..... to be someone else's problem"</span><br>
<p>
This is a important part of any engineering practice including software engineering.  Building complex systems is difficult and we have to share the load among different sub-specialists.<br>
<p>
So we have to compiler solve some of our problems, static analysis and testing solve some of our problems. We use introspective helpers like lockdep.  We use correctness annotations like assert() (aka BUG_ON()) and might_sleep() etc.  We create library code and encourage its use.  We look for patterns in other similar code and copy them.<br>
<p>
Any problem that CAN be referred to some person or system with more specialized knowledge/skills should me.  Trying to do it all yourself is a recipe for failure.<br>
<p>
And removing error handling isn't just about removing possible bugs.  It also removes dead code and so removes pressure on the icache.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/965973/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2024 10:13 UTC (Wed)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/966010/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>It's also why RAII is such a useful pattern whenever supported - it allows you to wrap up a resource so that users of the resource don't need to remember clean-up. Something like <a href="https://docs.kernel.org/driver-api/driver-model/devres.html">devres</a> in the kernel, for example, where you claim resources as you want to work with them, and detaching from the device automatically frees all your resources for you.


      
          <div class="CommentReplyButton">
            <form action="/Articles/966010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor966091"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2024 20:28 UTC (Wed)
                               by <b>dvdeug</b> (guest, #10998)
                              [<a href="/Articles/966091/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Brian Kernighan, one of the authors of C, said "Everyone knows that debugging is twice as hard as writing a program in the first place. So if you're as clever as you can be when you write it, how will you ever debug it?" So simplifying things, like making certain memory handling more centralized, certainly seems to be in the philosophy of the creators of C.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/966091/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor966092"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Toward a real &quot;too small to fail&quot; rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2024 20:47 UTC (Wed)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/966092/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, even more in the philosophy of the creators of C (by that definition) would be to use Rust, because it just auto-generates correct error handling code for the vast majority of cases.<br>
;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/966092/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
