        <!DOCTYPE html>
        <html lang="en">
        <head><title>Semantic patching with Coccinelle [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/315686/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/315069/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/315686/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Semantic patching with Coccinelle</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="GAByline">
           <p>January 20, 2009</p>
           <p>This article was contributed by Valerie Aurora</p>
           </div>
We've all been there: You're tracking down some evil bug, and you have
the sudden chilling realization that you're going to have to refactor
an enormous chunk of code to fix it.  You break out in a cold sweat as
you run a quick grep over the source base: hundreds of lines of code
to change!  And the change is too complex to do with a script because
it depends on the calling context, or requires adding a new variable
to every caller.
<p>

This happened to me last month when I was adding support for 64-bit
file systems to e2fsprogs.  I thought I was nearly finished when I
discovered I needed to write (yet another) new interface and convert
(yet another) several hundred lines of code to it.  The changes were
complex enough that I couldn't use a script, and simple enough that I
wanted to claw my eyes out with the soul-killing boredom of doing it
by hand.  That's when the maintainer, Theodore Ts'o, suggested I look
at
<a href="http://www.emn.fr/x-info/coccinelle/">Coccinelle</a> (a.k.a.,
spatch).


<h3>Coccinelle</h3>

Coccinelle is a tool to automatically analyze and rewrite C
code. Coccinelle (pronounced cock'-see-nel) means "ladybug" in French,
a name chosen because ladybugs eat other bugs.  Coccinelle is not just
another scripting language; it is aware of the structure of the C
language and can make much more complex changes than are possible with
pure string processing.  For example, Coccinelle can make a particular
change only in functions which are assigned to a function pointer in a
particular type of array &mdash; say, the <code>create</code> member
of <code>struct inode_operations</code>.
<p>

The input to the tool is the file(s) to be changed and a "semantic
patch," written
in <a href="http://www.emn.fr/x-info/coccinelle/docs/index.html">SmPL
(Semantic Patch Language)</a>.  SmPL looks a like a unified diff (a
patch) with some C-like declarations mixed in.  Here's an example:
<p>

<pre>
    @@
    expression E;
    identifier fld;
    @@

    - !E &amp;&amp; !E->fld
    + !E || !E->fld
</pre>
  
This semantic patch fixes the bug in which the pointer is tested for
NULL &mdash; and then dereferenced if the pointer is NULL.  An example of a
bug this semantic patch found in the Linux kernel (and automatically
generated the fix for):

<pre>
    --- a/drivers/pci/hotplug/cpqphp_ctrl.c
    +++ b/drivers/pci/hotplug/cpqphp_ctrl.c
    @@ -1139,7 +1139,7 @@ static u8 set_controller_speed(struct controller
    *ctrl, u8 adapter_speed, u8 hp_
            for(slot = ctrl->slot; slot; slot = slot->next) {
                    if (slot->device == (hp_slot + ctrl->slot_device_offset))
                            continue;
    -               if (!slot->hotplug_slot &amp;&amp; !slot->hotplug_slot->info)
    +               if (!slot->hotplug_slot || !slot->hotplug_slot->info)
                            continue;
                    if (slot->hotplug_slot->info->adapter_status == 0)
                            continue;
</pre>

(More on the semantic patch format later.)
<p>

Coccinelle is designed, written, and maintained by
<a href="http://www.diku.dk/~julia">Julia Lawall</a> at the
<a href="http://www.diku.dk/english/">Department of Computer Science at
University of Copenhagen</a>,
<a href="http://www.emn.fr/x-info/gmuller/">Gilles Muller</a> and
<a href="http://aryx.kicks-ass.org/~pad/homepage.php">Yoann
Padioleau</a> at the Ecole des Mines de Nantes, and Ren&eacute; Rydhof
Hansen at the <a href="http://www.cs.aau.dk/en/welcome/">Department of
Computer Science of Aalborg University</a>.  Coccinelle is licensed
under the GPL, however, it is written in OCaml, so the potential
developer base is somewhat limited.
<p>

The original goal of Coccinelle was to automate as much as possible
the task of keeping device drivers up to date with the latest kernel
interfaces.  But the end result can do far more than that, including
finding and fixing bugs and coding style irregularities.  Over 180
patches created using Coccinelle have
been <a href="http://www.emn.fr/x-info/coccinelle/#impact">accepted
into the Linux kernel</a> to date.  <p>

<h3>Coccinelle quickstart</h3>

Like many languages, SmPL is best learned through example.  We'll run
through one simple example here just to get started.  After that, the
Coccinelle web page has some
<a href="http://www.emn.fr/x-info/coccinelle/#documentation">documentation</a>
and a plethora of
<a href="http://www.emn.fr/x-info/coccinelle/#examples">examples</a>.
<p>

First, <a href="http://www.emn.fr/x-info/coccinelle/#download">download
Coccinelle</a> and install it.  I used the source version rather than
any of the precompiled options.  The Coccinelle binary is
called <code>spatch</code>.
<p>

As our example, say we have program with a lot of calls to
<code>alloca()</code> that we would like to replace with
<code>malloc()</code>.  <code>alloca()</code> allocates space on the
stack and can be more efficient and convenient than
<code>malloc()</code>, but it is also compiler-dependent,
non-standard, easy to use incorrectly, and has undefined behavior on
failure. (Replacing <code>alloca()</code> with <code>malloc()</code>
isn't enough, we also have to check the return value &mdash; but that
will come later.)
<p>

Here is the C file we are working on:

<pre>
    #include &lt;alloca.h&gt;

    int
    main(int argc, char *argv[])
    {
            unsigned int bytes = 1024 * 1024;
            char *buf;

            /* allocate memory */
            buf = alloca(bytes);

            return 0;
    }
</pre>

We could make the replacement using a scripting language
like <code>sed</code>:

<pre>
$ sed -i 's/alloca/malloc/g' test.c
</pre>

But this will replace the string "alloca" anywhere it appears.  The
resulting diff:

<pre>
    --- test.c
    +++ /tmp/test.c
    @@ -1,4 +1,4 @@
    -#include &lt;alloca.h&gt;
    +#include &lt;malloc.h&gt;
 
     int
     main(int argc, char *argv[])
    @@ -6,8 +6,8 @@
             unsigned int bytes = 1024 * 1024;
             char *buf;
 
    -        /* allocate memory */
    -        buf = alloca(bytes);
    +        /* mallocte memory */
    +        buf = malloc(bytes);
 
             return 0;
     }
</pre>

We can tweak our script to handle 90% of the cases:

<pre>
    $ sed -i 's/alloca(/malloc(/g' test.c
</pre>

But this script doesn't handle the case where a second function name
has the first as a suffix, it depends on a particular coding style in
which no white space comes between the function name and the open
parenthesis, etc., etc.  By now our simple <code>sed</code> script is a
hundred-character monster.  It can be done, but it's a pain.
<p>

In Coccinelle, we'd use the following semantic patch:

<pre>
    @@ expression E; @@

    -alloca(E)
    +malloc(E)
</pre>

Put the C file in <code>test.c</code> and the above semantic
patch in <code>test.cocci</code> and run it like so:

<pre>
    $ spatch -sp_file test.cocci test.c
</pre>

It should produce the following diff:

<pre>
    --- test.c
    +++ /tmp/cocci-output-17416-b5450d-test.c
    @@ -7,7 +7,7 @@ main(int argc, char *argv[])
             char *buf;
 
             /* allocate memory */
    -        buf = alloca(bytes);
    +        buf = malloc(bytes);
 
             return 0;
     }
</pre>

Let's look at the semantic patch line by line.

<pre>
    @@ expression E; @@
</pre>

This declares the "metavariable" E as a variable that can match any
expression &mdash; e.g., <code>1 +
2</code>, <code>sizeof(x)</code>, <code>strlen(name) + sizeof(x) *
72</code>.  When spatch processes the input, it sets the value of E to
the argument to <code>alloca()</code>.  The "<code>@@&nbsp;@@</code>" syntax is
chosen 
to resemble the line in a unified diff describing the lines to be
patched.  I don't find the resemblance particularly helpful, but the
intention is well-taken.

<pre>
    -alloca(E)
</pre>

This line says to remove any call to the
function <code>alloca()</code>, and to save its argument in the
metavariable E for later use.

<pre>
    +malloc(E)
</pre>

And this line says to replace the call to <code>alloca()</code> with a
call to <code>malloc()</code> and use the value of metavariable E as
its argument.
<p>

Now, we also want to check the return value of <code>malloc()</code>
and return an error if it failed.  We can do that too:

<pre>
    @@
    expression E;
    identifier ptr;
    @@

    -ptr = alloca(E);
    +ptr = malloc(E);
    +if (ptr == NULL)
    +        return 1;
</pre>

The resulting diff:

<pre>
    --- test.c
    +++ /tmp/cocci-output-17494-22a573-test.c
    @@ -7,7 +7,8 @@ main(int argc, char *argv[])
             char *buf;
 
             /* allocate memory */
    -        buf = alloca(bytes);
    +        buf = malloc(bytes);
    +        if (buf == NULL)
    +                return 1;
 
             return 0;
 }
</pre>

Semantic patches can be far more complex.  One of my favorite examples
is the move of reference counting of the <code>Scsi_Host</code>
structure out of drivers.  Changing this required adding an argument
to the function signature and removing a declaration and several other
lines from each SCSI driver's <code>proc_info</code>
function.  The semantic patch, explained in detail in their OLS
2007 slides
<a href="http://www.emn.fr/x-info/coccinelle/semantic-patches-talk-ols07.ppt">
[PPT]</a> <a href="http://www.emn.fr/x-info/coccinelle/semantic-patches-talk-ols07.odp">[ODP]</a>,
does all of this automatically.  I recommend reading and re-reading this
example 
until it sinks in.
<p>

<h3>Experience</h3>

My <a href="http://valhenson.livejournal.com/30409.html">first
experience</a> with Coccinelle was mixed.  In theory, Coccinelle does
exactly what I want &mdash; automate complex changes to code &mdash; but
in practice the implementation is beta quality.  I successfully used
Coccinelle to make hundreds of lines of changes with less than a
hundred lines of semantic patches, but only after working directly
with the developers to get bug fixes and help figuring out SmPL
features.  Coccinelle is one of those schizophrenic projects situated
on the boundary between academic research and practical software
development.
<p>

One of the first hurdles I had to overcome was teaching Coccinelle
about the macros in my code.  Coccinelle has to do all its own parsing
and pre-processing &mdash; you can't just run the input C code through
cpp because then you'd have to map the post-processor output back to
the original code.  Macros will sometimes confuse it enough that it
gives up parsing a function until it reaches the next safe grammatical
starting point (e.g., the next function) &mdash; which may mean that it
doesn't process most of the file.  To get around this, you can create
a list of macros and feed them to spatch with
the <code>-macro_file</code> option. (Yes, that's one dash &mdash; one
of my pet peeves about Coccinelle is the non-standard command-line
option style.) For example, here are a few lines from the macro file I
used for e2fsprogs:
<p>

<pre>
    #define EXT2FS_ATTR(a)
    #define _INLINE_ inline
    #define ATTR(a)
</pre>

You can build the list of macros by hand, but spatch has a feature
that helps find them automatically.  The <code>-parse_c</code> option
makes spatch list the top ten parsing errors, which will include the
macro name.  For example, some of the output from running <code>spatch
-parse_c</code> on e2fsprogs:
<p>

<pre>
    EXT2FS_ATTR: present in 85 parsing errors
    example:

          static int check_and_change_inodes(ext2_ino_t dir,
                                      int entry EXT2FS_ATTR((unused)),
                                      struct ext2_dir_entry *dirent, int
                                      offset,
                                      int  blocksize EXT2FS_ATTR((unused)),
</pre>

Coccinelle has improved significantly in the past few weeks.  The
0.1.2 release had a number of bugs that made spatch unusable for me.
The next release, 0.1.3, fixed those bugs and with it I was able to
make practical, real-world patches.  The 0.1.4 release will be out
shortly.  The developers wrote and released more documentation,
including a
<a href="http://www.emn.fr/x-info/coccinelle/options.pdf">description of
all the command-line options</a> [PDF] and a
<a href="http://www.emn.fr/x-info/coccinelle/docs/index.html">grammar
for SmPL</a>.  Many more
<a href="http://www.emn.fr/x-info/coccinelle/rules/index.html">example
spatch scripts</a> are available now.  The best reference for learning
Coccinelle continues to be the
slides
from their 2007 OLS tutorial
and the associated
<a href="http://www.emn.fr/x-info/coccinelle/ols07-padioleau.pdf">paper</a>
[PDF].
White space handling is improving; originally Coccinelle didn't care
much about white space and frequently mangled transformations involving
it, which is a problem if you want to take the hand out of
hand-editing.  One of my semantic patches left a dangling semi-colon
in the middle; the developers sent me a patch to fix it within a few
days.
<p>

One thing I am absolutely certain of: learning Coccinelle and writing
semantic patches was way more fun than making the changes by hand or
using regular expressions.  I also had much greater confidence that my
changes were correct; it is remarkably pleasant to make several
hundred lines of changes and have the result compile cleanly and pass
the regression tests the first time.

<h3>Related work</h3>

If you really want to, you can do everything Coccinelle can do by
writing your own scripts &mdash; after all, code is code.  But you have
to deal with all the little corner cases &mdash; e.g., to C, white space
is all the same, generally speaking, but regular expressions care
intensely about the difference between a space, a newline, and a tab.
Use the right tool for the job &mdash; if you're just replacing a
variable name and your first script works, great.  If you're changing
a calling convention or moving the allocation and freeing of an object
to another context, give a tool like Coccinelle a try.
<p>

In terms of power and flexibility, Coccinelle is similar to the
<a href="http://www.stanford.edu/~engler/mc-osdi.pdf">Stanford compiler
checker</a> [PDF] (commercialized by
<a href="http://coverity.com">Coverity</a>).  While the compiler
checker is far more mature and has better flow analysis and parsing,
Coccinelle can generate code to fix the bugs it finds.  Most
importantly, Coccinelle is open source, so developers can find and fix
bugs themselves.
<p>

Some IDEs include tools to automatically refactor code, which is one
aspect of what Coccinelle does.  I have never personally used one of
these IDE refactoring tools and can't compare it with Coccinelle, but
my friends who have report that their stability leaves something to be
desired.
<a href="http://www.xref.sk/xrefactory/main.html">Xrefactory</a> is a
refactoring tool available on *NIX platforms which is fully integrated
with Emacs and XEmacs.  It is not open source and requires the
purchase of a license, although one version is available for use free
of charge.
<p>

<h3>Conclusion</h3>

Coccinelle is an open source tool that can analyze and transform C
code according to specified rules, or semantic patches.  Semantic
patches are much more powerful than patches or regular expressions.
The tool is beta quality right now but usable for practical tasks and
the developers are very responsive.  It's worth learning for any
developer making a non-trivial interface change.
<p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_tools-Coccinelle">Development tools/Coccinelle</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Aurora_Henson_Valerie">Aurora (Henson), Valerie</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/315686/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor315810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 20, 2009 22:34 UTC (Tue)
                               by <b>biehl</b> (subscriber, #14636)
                              [<a href="/Articles/315810/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder if someone has ever compared <br>
<p>
Dehydra ( <a href="https://developer.mozilla.org/en/Dehydra">https://developer.mozilla.org/en/Dehydra</a> )<br>
GTK-rewriter ( <a href="http://people.imendio.com/richard/gtk-rewriter/">http://people.imendio.com/richard/gtk-rewriter/</a> )<br>
<p>
and maybe other tools ( <a href="http://blog.mozilla.com/tglek/2008/09/02/converging-elsa-strains/">http://blog.mozilla.com/tglek/2008/09/02/converging-elsa-...</a> ) to Coccinelle? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315833"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 1:30 UTC (Wed)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/315833/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From the web pages of Deydra and gtk-rewriter it seems deydra<br>
does not support any transformation (just analysis, and you have<br>
to write javascripts code apparently to match over C code), and gtk-rewrite<br>
have a few transformations hard-coded in a file. The goal of coccinelle<br>
is to make it easy to specify code patterns and transformations. You<br>
use a syntax you already know for that: C (not javascripts on ASTs), and<br>
the patch syntax.<br>
<p>
For elsa I can not speak, it's not clear what is their goal<br>
and what they can do.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315833/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor315809"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 20, 2009 22:41 UTC (Tue)
                               by <b>Thue</b> (guest, #14277)
                              [<a href="/Articles/315809/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <i>it is written in OCaml, so the potential developer base is somewhat limited</i>
<p>
Every programmer should learn to write ML or another functional language (OCaml is an object-oriented version of ML). It is the first language taught at the Department of Computer Science at University of Copenhagen, so there is at least some people who know it.
<p>
For some kinds of programs ML code is 1/3 the size of an equivalent imperative program, as well as more readable and easier to verify for correctness. ML has excellent compile time checking; If your ML program compiles it will usually also run correctly.
<p>
Many of the computer science students who learn ML keeps it as their favorite language. In my experience it is especially the best students who 'gets it' and likes ML.
      
          <div class="CommentReplyButton">
            <form action="/Articles/315809/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315835"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 1:33 UTC (Wed)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/315835/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Argh, please no programming language flame war :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315835/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 18:45 UTC (Wed)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/315916/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree -- Valerie's statement is fact, not a wish or flaming.  There simply aren't as many people who will modify the source as would be if it were in, say, Perl or Python or C itself.<br>
<p>
All comments to the contrary are wishful thinking (If I had some ham, I could have ham and eggs, if I had some eggs) and begging for a language war.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 19:45 UTC (Wed)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/315923/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <a href="http://ocaml-tutorial.org/">Learn something new ...</a>
      
          <div class="CommentReplyButton">
            <form action="/Articles/315923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315945"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 20:32 UTC (Wed)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/315945/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... and miss the point completely.<br>
<p>
You remind me of people who criticize where I go on vacation and what I do.  "You could have gone to xxx and done yyy."  Yeh, well, no matter where I go and what I do, I could have gone somewhere else and done something else.<br>
<p>
Time and resources are limited.  Some people would rather get on with the doing rather than learn new ways to not do things they don't have time for because they spend all their time learning new ways they won't use.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315945/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315977"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 22:23 UTC (Wed)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/315977/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, you're right.  We should never try anything new or do anything differently from how it's <br>
always been done.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315977/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315989"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 23:49 UTC (Wed)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/315989/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You just don't get it.  There are more people who already know common languages than who already know OCaml, and only a fraction of those people who don't know OCaml are going to have the time and resources to learn it.<br>
<p>
It's just a simple fact.  It has nothing to do with the benefits of education, of new and improved ways of doing things.  NOTHING.<br>
<p>
Quit taking it personally.  It has zero to do with you personally, your personal taste in languages or living styles, what would be best or ideal or anything.  It is a simple fact of counting heads.  More people know languages other than OCaml and could contribute in those languages.<br>
<p>
Separate raw data from your personal wishes and dreams.  Valerie wrote a fact.  Dispute the fact if you want, but don't ramble on about learning and better ways and so on, those are not facts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315989/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316275"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 1:37 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/316275/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Looks to me like you're putting words in rwmj's mouth and then disagreeing with them.  I don't see that rwmj has taken issue with Valerie's conclusions about the language choice.
<p>
Not every comment is a contradiction of the parent, and I wouldn't assume that "learn something new" was meant to say, "there's nothing unfortunate about the fact that this code is in OCaml."
<p>
Of course, I'm not really sure how "learn something new" <em>does</em> fit into the thread.  The posts after it follow more obviously: you point out that learning something new <em>isn't always</em> the right thing and rwmj misreads that as learning something new is <em>never</em> the right thing and disagrees.  While that position (learning something new is sometimes good) is obviously right, you respond as if he were arguing -- still -- that there's nothing unfortunate about the fact that this code is in OCaml.

      
          <div class="CommentReplyButton">
            <form action="/Articles/316275/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316300"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 5:41 UTC (Fri)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/316300/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I was just being sarcastic in that second posting.  OCaml and Haskell are something new.  They're 
not just exotic scripting languages - in the way that Ruby is just Perl with a different syntax.  They 
are something considerably more powerful and expressive that can take programming in new 
directions.  Unfortunately explaining this is a bit like the <a 
href="http://www.paulgraham.com/avg.html">Paul Graham explaining LISP to "Blub" 
programmers</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/316300/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 8:09 UTC (Fri)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/316307/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <em><blockquote>Unfortunately explaining this is a bit like the Paul Graham explaining LISP to "Blub" programmers. </blockquote></em>
<p>
It's hard to find explanations that do a <em>worse</em> job of introducing people to Lisp. There's a good explanation of <a href="http://research.microsoft.com/en-us/um/people/simonpj/papers/history-of-haskell/history.pdf">Haskell</a> (PDF), including a bit of history, design choices and an overview of the functional programming paradigm.
<p>
Haskell, by the way, is roughly of the same age as Python, but is expected to become the next great programming language Any Moment Now. Or maybe <a href="http://flyingfrogblog.blogspot.com/2008/08/haskells-virginity.html">not</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/316307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor316039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 6:49 UTC (Thu)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/316039/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No-one's saying that people *shouldn't* learn OCaml, or even that they personally don't wish to learn OCaml, just that in practice most of the people in the programming world perceive OCaml as exotic and do not learn it -- for whatever reason.<br>
<p>
Writing in a niche language *can* have the opposite effect on finding contributors, though.  Darcs for instance benefited quite a bit from being written in Haskell, because there were many people who had learned the language out of interest and really wanted to work on something in Haskell, but not many real-world projects to go around.  Its competitors were written in better known languages, but their potential contributor base was correspondingly diluted by all the other projects also written in those languages...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">This effect does exist but it's short-lived...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 10:29 UTC (Thu)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/316073/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Yes, darcs benefited for a time from the fact that it could attract all 
these people - but the end result was the same: when C crowd got it's shiny 
new bauble (Git) all other projects were left in dust...</p>

<p>Sometimes it's good idea to use non-mainstream language because it's the 
only way to produce something and you don't need many contributors: one of 
the most popular DFT library (<a href="http://www.fftw.org/">FFTW</a>) is 
written in OCaml (well, kinda). But it <b>does limit</b> number of 
potential contributors! No way to avoid this...</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/316073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor315853"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 10:48 UTC (Wed)
                               by <b>Yorick</b> (guest, #19241)
                              [<a href="/Articles/315853/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      First, many thanks to Valerie Henson for an excellent article and for reminding us of the existence of Coccinelle which appears to be a fine tool.<p>

But I must agree with Thue. Statements on the form <i>X is written in Y, so the potential developer base is somewhat limited</i> where <i>Y</i> is a language not well-known by the speaker are misleading. Any competent and motivated programmer will quickly learn a language such as ML, Scheme or Haskell in order to contribute to a project.<p>

We are not talking about exoticisms like Befunge or Brainfuck here but standard, well-known, well-documented and widely-taught languages. A notation well suited to the task makes the task easier; for nontrivial applications, the complexity lies in the problem domain. Anyone who has worked with GCC will attest that the fact that it is (mostly) written in C does not make it easier to understand.

      
          <div class="CommentReplyButton">
            <form action="/Articles/315853/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 12:35 UTC (Wed)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/315858/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <em><blockquote>
Statements on the form <b>X is written in Y, so the potential developer base is somewhat limited where Y is a language not well-known by the speaker</b> are misleading. Any competent and motivated programmer will quickly learn a language such as ML, Scheme or Haskell in order to contribute to a project.</blockquote></em>
<p>
This is not the common practice, of course, if only because there are a lot more incompetent programmers than programmers who quickly learn Haskell.  Whether this is true for any language Y and any project X is an interesting question.
<p>
But of the statements S in publication P, I would say yours is more sweeping than Valerie's. ;-)
      
          <div class="CommentReplyButton">
            <form action="/Articles/315858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor316018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 4:11 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/316018/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is OCaml standard now?  Last I heard it was defined by its current implementation.  Wikipedia seems to suggest that remains true.<br>
<p>
A formal definition and multiple implementations help to reassure coders that time spent learning the language and writing reams of code in it won't end up wasted when, e.g., developers of the sole implementation lose interest and leave it orphaned.  (NB: I am not saying I expect this to happen to OCaml.)  It is precisely this quality, and nothing about the details of the language design, that make apt Ms. Henson's remark about Coccinelle's potential developer base.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316035"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 6:10 UTC (Thu)
                               by <b>shimei</b> (guest, #54776)
                              [<a href="/Articles/316035/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not going to take a side on whether OCaml limits the development base or not, but I don't think it'd be the lack of standardization stopping it in any case. Look at languages like python and ruby (or, *gasp*, PHP) that are quite popular and practical. None of those are standardized in any meaningful way, but they're doing just fine. Then look at a language like Haskell that has standardization and multiple high-quality implementations, but still sits on the sidelines of the software industry.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316035/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor316029"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 5:43 UTC (Thu)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/316029/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're right for (semi) long-term contributors. But for people who just want to make a quick fix or other small contribution a for them strange language is a sort of hurdle. Perhaps big enough to miss quite a few long-term contributors who normally would have started with something small.<br>
<p>
That said, how the reception of outside contributions is by the main developers has a bigger impact than what language is used...<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316029/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316068"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 10:37 UTC (Thu)
                               by <b>Yorick</b> (guest, #19241)
                              [<a href="/Articles/316068/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you, that is a valid objection; small contributions are likely to be inhibited by the use of an unfamilar language. But not all of them; trivial typo fixes, translations, ports, build and configuration changes etc do not require much understanding of the language. Nor do testing and reporting bugs, perhaps the most important class of small contributions.<br>
<p>
But what I really wanted to challenge is the sad prevailing idea that some languages are "common" and the rest "strange". The statement in the article could be interpreted that way, although I am confident that Ms Henson does not suffer from that delusion herself. It is not helpful in making "uncommon" languages less so, even when this has great merit.<br>
<p>
(Also, some "helpful" contributions that you receive as a maintainer of a free software package makes you wonder if the language-as-barrier is such a bad idea...)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316068/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 13:43 UTC (Thu)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/316106/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <em><blockquote>But what I really wanted to challenge is the sad prevailing idea that some languages are "common" and the rest "strange". </blockquote></em>
<p>
To prove your point, maybe you should write patches for Coccinelle so that it can produce semantic patches for OCaml?
      
          <div class="CommentReplyButton">
            <form action="/Articles/316106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316119"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 16:18 UTC (Thu)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/316119/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p><i>To prove your point, maybe you should write patches for Coccinelle so that it can produce semantic patches for OCaml? </i></p>

<p>
OCaml actually supports the principle of semantic patching
natively.  You can perform almost arbitrary transformations
of the abstract syntax tree at compile time, and this feature
is used to implement interesting new features like
<a href="http://code.google.com/p/bitstring/">Erlang-style bitstrings</a>,
<a href="http://www.dse.nl/~dario/projects/pgoctut/">type-safe access
to databases</a>, <a href="http://martin.jambon.free.fr/micmatch.html">type-safe
regular expressions</a>, and
<a href="http://caml.inria.fr/cgi-bin/hump.en.cgi?sort=0&browse=92">much more</a>.
</p>

<p>
Of course this is "strange" to many.  (LISP programmers might
recognise them as a very much more powerful version of LISP
macros).  But this is just one of the several ways that OCaml
(and Haskell) are far beyond common programming languages.
</p>

<p>Rich.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/316119/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316123"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 16:28 UTC (Thu)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/316123/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; OCaml actually supports the principle of semantic patching natively.</font><br>
<p>
This is not true. What you are talking about is different and is called<br>
meta-programming. The need to refactor code is different. Even in OCaml<br>
you often need to refactor code and there is no tool right now for OCaml<br>
that does that. In fact we, in the coccinelle project, had in the past internally needed to refactor the coccinelle code and it was painful.<br>
<p>
So I guess the comment of the other guy was right on the point; we decided to do<br>
a semantic patching tool for C rather than a semantic patching tool for OCaml because there are more people writing C code :)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316123/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 0:42 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/316270/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Obviously, for symmetry, the thing to do is to write a semantic patching <br>
tool (called, perhaps, ocamelle), in C, which carries out such <br>
transformations on OCaml code. ;}<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor316298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 5:38 UTC (Fri)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/316298/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>I didn't mean that semantic patching was used in the same way as metaprogramming, but they 
are 
certainly analogous to each other.  In one case, the transformed code is applied as a patch back on 
the source.   In the other case, the transformed code is immediately passed to the compiler.</p>

<p>Anyhow .. for OCaml refactoring, Jane Street sponsored <a 
href="http://ocaml.janestreet.com/files/ocamlwizard.pdf">this project</a> last summer.
It's also something that Eclipse + the OCaml Eclipse plugin claims to do.  I have not used 
either.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/316298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor316032"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 6:36 UTC (Thu)
                               by <b>dirtyepic</b> (guest, #30178)
                              [<a href="/Articles/316032/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <i>Statements on the form X is written in Y, so the potential developer base is somewhat limited where Y is a language not well-known by the speaker are misleading. Any competent and motivated programmer will quickly learn a language such as ML, Scheme or Haskell in order to contribute to a project.</i><br>
<br>
The point is that the total number of people who know ML or will learn it in the near future is less than the total number of people who know or will know C/python/etc, just as a book written in Ukrainian has a smaller potential audience than one written in English.  You don't have to know Ukrainian to make that observation, just how to count.
      
          <div class="CommentReplyButton">
            <form action="/Articles/316032/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316042"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 6:58 UTC (Thu)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/316042/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, so let's all start writing chinese code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316042/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 17:40 UTC (Thu)
                               by <b>dirtyepic</b> (guest, #30178)
                              [<a href="/Articles/316132/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
nah, let's complain about them not learning english instead.  obviously if they were competent and motivated they would.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor316086"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 12:21 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/316086/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Any competent and motivated programmer can quickly learn a language such as ML, Scheme or Haskell in order to contribute to a project. However, pretty much every competent and motivated programmer I know would rather be necking Pimm's from the bottle than learning yet another language in order to satisfy somebody's academic preferences.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316086/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316268"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 0:40 UTC (Fri)
                               by <b>lysse</b> (guest, #3190)
                              [<a href="/Articles/316268/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
...and you, sir, win this thread. ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316268/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor315841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 2:23 UTC (Wed)
                               by <b>zooko</b> (guest, #2589)
                              [<a href="/Articles/315841/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This was an interesting and informative article.  Thanks, Valerie Henson.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor315852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 10:05 UTC (Wed)
                               by <b>wingo</b> (guest, #26929)
                              [<a href="/Articles/315852/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Great article, Val, as always.<br>
<p>
I also like turning tedium into tools problems -- it probably takes the same amount of time but writing tools is much more fun.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor315917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 18:46 UTC (Wed)
                               by <b>ndk</b> (subscriber, #43509)
                              [<a href="/Articles/315917/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... or as somebody (who?) said:<br>
<p>
"I'd rather write programs that write programs, than write programs."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316008"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 1:30 UTC (Thu)
                               by <b>sitaram</b> (guest, #5959)
                              [<a href="/Articles/316008/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
with absolutely no way to prove it, I think it was Larry Wall.<br>
<p>
If it wasn't, it should be :-)  Sounds like him...!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316008/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 2:32 UTC (Thu)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/316010/">Link</a>] 
      </p>
      
      </div>
      </summary>
      It appears that Richard Sites, who was a student of Donald Knuth, said it first (or at least before Larry Wall did), sometime in the 1970s.

      
          <div class="CommentReplyButton">
            <form action="/Articles/316010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor316030"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 5:46 UTC (Thu)
                               by <b>Mithrandir</b> (guest, #3031)
                              [<a href="/Articles/316030/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Didn't someone say something like "the definition of a geek is someone who would rather write a tool to do a repetitive task than do the task itself, even if it takes longer to write the tool"?  Might have been ESR.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316030/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 8:35 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/316055/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Douglas Adams spent several pages rhapsodizing about writing tools rather <br>
than doing the actual job, even when the job was a one-off, in _Last <br>
Chance to See_. Given that this was a book about conservation this was a <br>
somewhat strange choice :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316269"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 0:47 UTC (Fri)
                               by <b>lysse</b> (guest, #3190)
                              [<a href="/Articles/316269/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, yes, but Douglas Adams was a world-class procrastinator, and what else is writing a tool but the most productive form of procrastination? As for conservation... well, I suppose you could draw a long and tortured analogy about how conservation is a bit like that kind of job, and the temptation is to get all of the conditions exactly right for a creature's continued survival, and how even if it dies off in the meantime, before its habitat is properly ready, you still get that sense of achievement from having done a little something to save the world anyway... or something...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316269/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor315976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle in Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2009 22:22 UTC (Wed)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/315976/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Anyone interested in trying this program in Fedora, there is a package here: <br>
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=481034">https://bugzilla.redhat.com/show_bug.cgi?id=481034</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/315976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316213"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle in Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 20:56 UTC (Thu)
                               by <b>vaurora</b> (guest, #38407)
                              [<a href="/Articles/316213/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Awesome!  Thanks!  I wonder how long until the Debian package?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316213/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316221"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle in Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 21:23 UTC (Thu)
                               by <b>eugeniy</b> (guest, #24280)
                              [<a href="/Articles/316221/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Working on that already: <a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=512658">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=512658</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316221/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316290"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle in Fedora</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2009 3:49 UTC (Fri)
                               by <b>vaurora</b> (guest, #38407)
                              [<a href="/Articles/316290/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sweet!  Thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316290/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor316050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">coccinelle problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 7:57 UTC (Thu)
                               by <b>Octavian</b> (guest, #7462)
                              [<a href="/Articles/316050/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can confirm the statement that coccinelle is of beta quality currently, as it still fails on some C constructs, e. g. related to named initializers.  The following patchlet always fails because of the union inside:<br>
<p>
- struct foo my_foo[] = {<br>
-  .a = 1,<br>
-  .u.b = 42,<br>
- }<br>
+ FOO(1, 42)<br>
<p>
However, after contacting Julia Lawal I can say that she was always very helpfull at fixing the issues I found.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316091"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">coccinelle problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 12:42 UTC (Thu)
                               by <b>lawall</b> (guest, #56234)
                              [<a href="/Articles/316091/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the bug report.  I will take a look at it.  Indeed, structure declarations of various sorts are not yet as well supported as they should be.<br>
<p>
julia<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316091/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317282"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">coccinelle problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 9:09 UTC (Fri)
                               by <b>lawall</b> (guest, #56234)
                              [<a href="/Articles/317282/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Indeed, structure declarations of various sorts are not yet as well supported as they should be.</font><br>
<p>
Note that this refers to the support for structures in SmPL, ie the language in which semantic patches are written.  The C parser supports all kinds of structures with no problem, and indeed all of C, with various extensions as used in Linux code.<br>
<p>
julia<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317282/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor318071"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">coccinelle problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2009 8:46 UTC (Thu)
                               by <b>lawall</b> (guest, #56234)
                              [<a href="/Articles/318071/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This problem has been fixed in the new release (0.1.5, Feb 5, 2009).  Thanks for the bug report.<br>
<p>
julia<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/318071/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor316083"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Wrong Section?!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 12:07 UTC (Thu)
                               by <b>nikanth</b> (guest, #50093)
                              [<a href="/Articles/316083/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder why is this article published under Kernel section?!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316083/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316204"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Wrong Section?!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 19:34 UTC (Thu)
                               by <b>egoforth</b> (subscriber, #2351)
                              [<a href="/Articles/316204/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote><i>I wonder why is this article published under Kernel section?!</i></blockquote>

I would posit that it's because this is the <i>Kernel <b>development</b></i> section, and there has already been a measured impact.

<blockquote><i>The original goal of Coccinelle was to automate as much as possible the task of keeping device drivers up to date with the latest kernel interfaces.  But the end result can do far more than that, including finding and fixing bugs and coding style irregularities.  Over 180 patches created using Coccinelle have been <a href="http://www.emn.fr/x-info/coccinelle/#impact">accepted into the Linux kernel</a> to date.</i></blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/316204/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor316102"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 13:26 UTC (Thu)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/316102/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Thanks for the article, I anticipate the .4 release and this is the first I heard of it :)

One thing I've been battling with recently that unfortunately it doesn't support is modifying printf-style formats. I'd love to write something like

<pre>
@@
string A, B;
expression M, MBUF;
@@
-printk(... "%s" ..., ..., print_mac(MBUF, M), ...);
+printk(... "%pM" ..., ..., M, ...);
</pre>

but obviously parameter matching is quite a hard task and definitely needs different syntax than what I just invented on the spot.

But even without that, I've used it a few times already, if only to detect problems, e.g. http://thread.gmane.org/gmane.linux.kernel.wireless.general/26371 (though that case required filtering manually for the correct places)
      
          <div class="CommentReplyButton">
            <form action="/Articles/316102/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2009 13:27 UTC (Thu)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/316103/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, make links clicky: <a href="http://thread.gmane.org/gmane.linux.kernel.wireless.general/26371">http://thread.gmane.org/gmane.linux.kernel.wireless.gener...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor316938"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2009 14:35 UTC (Wed)
                               by <b>dmk</b> (guest, #50141)
                              [<a href="/Articles/316938/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
whoa! i can do double-click;middle-click on non-clicky links... *click**click* *click*<br>
(i feel so proud!)<br>
...to wander further off topic.. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316938/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor316603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 26, 2009 10:19 UTC (Mon)
                               by <b>jmmc</b> (guest, #34939)
                              [<a href="/Articles/316603/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just wanted to second (third, fourth, etc.) others comments - great article Val and to Jon, once again a big thanks (again !) for organizing and including such great content in LWN !<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317094"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Related work on C/C++ refactoring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 8:29 UTC (Thu)
                               by <b>tglek</b> (guest, #56374)
                              [<a href="/Articles/317094/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I spent a couple of years writing tools to rewrite C/C++ code for Mozilla. I'm glad to finally see related work discussed on LWN, but I'm a little disappointed that Pork(my refactoring toolchain) is not famous enough to be listed as an alternative.<br>
<p>
I wrote a blog post about it:<br>
<a rel="nofollow" href="http://blog.mozilla.com/tglek/2009/01/29/semantic-rewriting-of-code-with-pork-a-bitter-recap/">http://blog.mozilla.com/tglek/2009/01/29/semantic-rewriti...</a><br>
<p>
As an interesting tidbit: since Pork itself is largely written in C++ I actually used it to refactor itself, I briefly ranted about it in <a rel="nofollow" href="http://blog.mozilla.com/tglek/2008/07/25/pull-pork-with-care/">http://blog.mozilla.com/tglek/2008/07/25/pull-pork-with-c...</a><br>
<p>
With regards to C preprocessor issues mentioned, I worked with MCPP(<a rel="nofollow" href="http://sourceforge.net/projects/mcpp/">http://sourceforge.net/projects/mcpp/</a>) author to enable MCPP to produce a special form of preprocessed files that makes dealing with macros much simpler. See -K option in MCPP.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317094/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317274"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Related work on C/C++ refactoring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 7:03 UTC (Fri)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/317274/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How long does it take to express the 2 program transformations mentionned in val's article using Pork ? With coccinelle it takes respectively 7 and 9 lines of SmPL, and it can be applied on the whole kernel, including<br>
code in arch/, in code protected by ifdef, etc.<br>
<p>
Regarding CPP, how MCPP handles ifdef ? How much of the linux kernel can you analyse ? How many lines MCPP skip to make your parsing job easier ? <br>
How do you handle iterator macros ? In the case of coccinelle we need sometimes to express transformations on macros, on iterators, declarors, and so we must try to not expand macro and represent macro directly in the internal AST.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317274/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Related work on C/C++ refactoring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 19:24 UTC (Fri)
                               by <b>tglek</b> (guest, #56374)
                              [<a href="/Articles/317356/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not to make this a contest, but some refactorings require writing a C++ tool, some already have such tools.<br>
<p>
So for the rename it'd be a matter of running<br>
./renamer ::alloca ::malloc on the files of interest<br>
<p>
For the other change, who knows could be a few lines of C++ or could be a few thousand depending if the complexity of the attempted change(pork's changes can be as complex as the user desires due to having a fully elaborated AST).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Related work on C/C++ refactoring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 19:42 UTC (Fri)
                               by <b>tglek</b> (guest, #56374)
                              [<a href="/Articles/317360/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I should mention that Pork also does not require the user to teach it about various preprocessing constructs used. I know Mozilla code features some phenomenally bad macro expansions(ie defining while method bodies within macros.. or building function bodies out of various macros or otherwise having macros concatenation to call functions) most of which would be extremely unpleasant to explain to any parser. <br>
<p>
Instead Pork allows detection of code where macros interfere with a particular refactoring so it can produce an error message and inform the user that some manual help is needed for that particular bad macro. Usually that turns out to be a trivial amount of effort(in the worst possible case it took a couple of days to compensate for it).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317361"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Related work on C/C++ refactoring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 19:50 UTC (Fri)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/317361/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And will your renamer tool also rename code inside ifdefs ? If I run it on the linux kernel, will it also rename functions in arch/alpha/... or<br>
protected by #ifdef DEBUG  ?<br>
<p>
Coccinelle has also internally a fully elaborated AST and one can write any transformations in OCaml working on this AST but this is precisely what we want to avoid with Coccinelle. We don't want users to express their transformations on the AST but instead to express it easily using our SmPL patch syntax.<br>
<p>
Also you didn't really answer my question, how long will it take using Pork to express the second program transformation mentioned in val's article about renaming malloc and also adding the pointer checking code for NULL.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317361/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor317447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Regular Expressions Plus?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2009 1:52 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/317447/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Instead of a bunch of language-specific tools, how about a general tool that can do search/replace on syntactic constructs? Sort of the next step beyond regular expressions?<br>
<p>
Is this a job for a packrat parser?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Regular Expressions Plus?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 2, 2009 0:30 UTC (Mon)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/317514/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess the next step beyond regular expressions are grammars, and<br>
generic tools using grammars as parameters takes time to implement<br>
and are not always useful.You have to know more than just the<br>
syntactic structure of a programming language to make something interesting.<br>
Emacs/Eclipse knows about the grammar of many programming languages.<br>
<p>
Moreover, Coccinelle is not just a search/replace of syntactic constructs.<br>
You have expression, function, and statement metavariables allowing <br>
to match and move code and you can specify constraints about the<br>
context of those entities.As val said: <br>
"can make a particular change only in functions which are assigned to a function pointer in a particular type of array  say, the create member of struct inode_operations." You need a way to specify such constraint.<br>
I don't really understand how a packrat parser would help for that ...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Regular Expressions Plus?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 2, 2009 1:34 UTC (Mon)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/317516/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <P>padator wrote:
<BLOCKQUOTE><P>Moreover, Coccinelle is not just a search/replace of syntactic constructs.
You have expression, function, and statement metavariables allowing
to match and move code and you can specify constraints about the
context of those entities.</P></BLOCKQUOTE>
<P>Yes, but Im pretty sure that those constraints are all, in principle, expressible using well-known techniques like two-level grammars and attribute grammars.
<P>Im not saying its a simple thing to do, but nevertheless it seems useful to have such prebuilt grammars for different languages, working with a common core of code, rather than writing different code for different languages.
<P>Just a thought.
      
          <div class="CommentReplyButton">
            <form action="/Articles/317516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor317729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 3, 2009 13:56 UTC (Tue)
                               by <b>robbe</b> (guest, #16131)
                              [<a href="/Articles/317729/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was a bit disheartened to see the example code transformed into code <br>
that leaks (remember that memory reserved with alloca() is automatically <br>
freed, malloc() does not have this property).<br>
<p>
All the while I was hoping to see a third run of the tool which added the <br>
missing free() call before every return statement. Is that possible with <br>
Coccinelle?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Semantic patching with Coccinelle</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 3, 2009 21:27 UTC (Tue)
                               by <b>padator</b> (guest, #56235)
                              [<a href="/Articles/317806/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nice catch :)<br>
<p>
Yes coccinelle can do that too.<br>
Here is an example of a better semantic patch:<br>
<p>
@@<br>
expression E;<br>
identifier ptr;<br>
identifier func;<br>
@@<br>
 func(...) {<br>
  ...<br>
- ptr = alloca(E);<br>
+ ptr = malloc(E);<br>
+ if (ptr == NULL)<br>
+    return 1;<br>
  ...<br>
+ free(ptr);<br>
  return ...;<br>
}<br>
<p>
Note that the coccinelle engine will take care to add the call to free() to all control flow paths before a return. Here is an example of a patch produced by spatch on a simple C file:<br>
./spatch -sp_file demos/lwn.cocci demos/lwn.c<br>
<p>
--- demos/lwn.c	2009-02-03 15:10:38.000000000 -0600<br>
+++ /tmp/cocci-output-22113-f80295-lwn.c	2009-02-03 15:15:05.000000000 -0600<br>
@@ -3,12 +3,17 @@ void main(int argc, char *argv[])<br>
 	char *buf;<br>
 	<br>
     /* allocate memory */<br>
-	buf = alloca(bytes);<br>
+	buf = malloc(bytes);<br>
+	if (buf == NULL)<br>
+		return 1;<br>
 <br>
 <br>
-	if(argc == 0)<br>
+	if(argc == 0) {<br>
+		free(buf);<br>
 		return 0;<br>
+	}<br>
 	<br>
+	free(buf);<br>
 	return 1;<br>
 }<br>
 <br>
note: see also how (beautifully) coccinelle adds the necessary { } after the if to make it a compound statement. Coccinelle also put<br>
the correct indentation each time, even if the LWN html page does not<br>
show it because of html space mangling I guess.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor650736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Coccinelle output</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2015 14:10 UTC (Fri)
                               by <b>bou6</b> (guest, #103486)
                              [<a href="/Articles/650736/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am a beginner in coccinelle and try to run my first example.<br>
<p>
Currently I'am following the steps of this article<br>
<p>
1)I created the c file<br>
2)I created the coccinelle script<br>
3)I run it using<br>
<p>
$ spatch -sp_file test.cocci test.c<br>
In the terminal I got the expected result as mentioned in the article<br>
<p>
--- test.c<br>
+++ /tmp/cocci-output-17416-b5450d-test.c<br>
@@ -7,7 +7,7 @@ main(int argc, char *argv[])<br>
         char *buf;<br>
<p>
         /* allocate memory */<br>
-        buf = alloca(bytes);<br>
+        buf = malloc(bytes);<br>
<p>
         return 0;<br>
 }<br>
However the c file didn't change as expected.<br>
<p>
Can any body tell me where can I get the changes made by the script?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/650736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor661704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Coccinelle output</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2015 9:22 UTC (Thu)
                               by <b>mfrw</b> (subscriber, #100251)
                              [<a href="/Articles/661704/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
add the option --in-place to spatch.<br>
$ spatch --sp-file test.cocci --in-place test.c <br>
By default spatch just prints the output on the standard output, by this it will change the file also<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/661704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
