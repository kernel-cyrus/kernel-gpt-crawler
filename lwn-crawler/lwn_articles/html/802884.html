        <!DOCTYPE html>
        <html lang="en">
        <head><title>BPF and the realtime patch set [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/802884/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/802558/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/802884/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>BPF and the realtime patch set</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>October 23, 2019</br>
           </div>
<p>
Back in July, Linus Torvalds merged a <a
href="/ml/linux-kernel/20190715150402.798499167@linutronix.de/">patch</a>
in the 5.3 merge window
that added the <tt>PREEMPT_RT</tt> option to the kernel build-time configuration.
That was meant as a 
signal that the realtime patch set was moving from its longtime status as
out-of-tree code to a fully supported kernel feature.  As the code behind
the configuration option makes its way into the mainline, some friction can
be expected; we are seeing a bit of that now with respect to the BPF subsystem.
</p>

<p>
The thread started with a patch <a
href="/ml/bpf/20191017090500.ienqyium2phkxpdo@linutronix.de/">posted</a> by
Sebastian Andrzej Siewior to
the BPF mailing list.  The patch mentioned three problems with BPF running when
realtime is enabled and added Kconfig directives to only allow BPF to be
configured into kernels that did not have <tt>PREEMPT_RT</tt>:
<div class="BigQuote">
Disable BPF on PREEMPT_RT because
<ul class="spacylist">
<li>it allocates and frees memory in atomic context
<li>it uses up_read_non_owner()
<li>BPF_PROG_RUN() expects to be invoked in non-preemptible context
</ul>
</div>
</p>

<p>
Siewior said that he had tried to <a
href="https://lore.kernel.org/bpf/20190410143025.11997-1-bigeasy@linutronix.de/">address
the memory allocation problems</a> "<q>but I have no idea how to address the
other two issues</q>".   In that thread, he also gave an <a
href="https://lore.kernel.org/bpf/20190412161406.ok3b4ooyeab6i3wz@linutronix.de/">overview</a>
of what is needed to "play nicely" with the realtime patch set.
</p>

<p>
Daniel Borkmann <a
href="/ml/bpf/20191017145358.GA26267@pc-63.home/">replied</a> that the
simple approach Siewior took would not actually disable all of BPF,
as there are other BPF-using subsystems that would not be affected by the
change.  Siewior <a 
href="/ml/bpf/20191017154021.ndza4la3hntk4d4o@linutronix.de/">asked for
feedback</a> on one possible way to solve that, but David Miller <a
href="/ml/bpf/20191017.132548.2120028117307856274.davem@davemloft.net/">made
it clear</a> that he does not think this approach makes sense:
"<q>Turning off BPF just because PREEMPT_RT is enabled is a non-starter
it is 
absolutely essential functionality for a Linux system at this point.</q>"
</p>

<p>
However, as Siewior said, there are fundamental incompatibilities between the
implementation of BPF and the needs of the realtime patch set.  Thomas
Gleixner <a
href="/ml/bpf/alpine.DEB.2.21.1910172342090.1869@nanos.tec.linutronix.de/">provided
more detail</a> on the problem areas in the hopes of finding other ways to
deal with them:
<div class="BigQuote">
<ul class="spacylist" style="list-style-type:none">
  <li>#1) BPF disables preemption unconditionally with no way to do a proper RT
      substitution like most other infrastructure in the kernel provides
      via spinlocks or other locking primitives.

  <li>#2) BPF does allocations in atomic contexts, which is a dubious decision
      even for non RT. That's related to #1

  <li>#3) BPF uses the up_read_non_owner() hackery which was only invented to
      deal with already existing horrors and not meant to be proliferated.
</ul>
</div>
</p>

<p>
Miller <a
href="/ml/bpf/20191017.151335.597242104804050107.davem@davemloft.net/">replied</a>
that BPF is needed by systemd and the IR drivers already; "<q>We're
moving to the point where even LSM modules will be implemented in
bpf.</q>"  In his earlier message, he said that turning off BPF would
disable any packet sniffing so that <tt>tcpdump</tt> and Wireshark would
not function.  To a certain extent, he oversold the need for BPF as
Gleixner <a
href="/ml/bpf/alpine.DEB.2.21.1910180041430.1869@nanos.tec.linutronix.de/">pointed
out</a>; Gleixner was running Debian testing with Siewior's patch applied and not
encountering any systemd or other difficulties.  Furthermore, even though packet
sniffing is not using BPF, thus requiring a copy to user space for each
packet, it does still work, Gleixner said, so that is not really an
argument for requiring BPF either.
</p>

<p>
Beyond that, though, he was really looking for feedback on
"<q>how to tackle these issues on a technical level</q>".  Some of
that did start to come about in a <a
href="/ml/bpf/CAADnVQJPJubTx0TxcXnbCfavcQDZeu8VTnYYpa8JYpWw9Ze4qg@mail.gmail.com/">sub-thread</a>
with BPF maintainer Alexei Starovoitov, who wondered about disabling
preemption and noted that he is a "<q>complete noob in RT</q>".
Gleixner <a
href="/ml/bpf/alpine.DEB.2.21.1910180152110.1869@nanos.tec.linutronix.de/">explained</a>
the situation at some length.
</p>

<p>
Essentially, the realtime kernel cannot
disable preemption or interrupts for arbitrarily long periods of time.
The realtime patches substitute realtime-aware locks for the spinlocks and
rwlocks that do disable preemption or interrupts in the non-realtime kernel.
Those realtime-aware locks can sleep, however, so they cannot be used from
within code sections that have explicitly disabled preemption or
interrupts.
</p>

<p>
As Starovoitov <a
href="/ml/bpf/20191018055222.cwx5dmj6pppqzcpc@ast-mbp/">explained</a>, BPF
disables preemption "<q>because of per-cpu maps and per-cpu data structures
that are shared between bpf program execution and kernel execution</q>".
But, he said, BPF does not call into code that might sleep, so there should
be no problems on that score.  But that is only when looking at the BPF code
from a non-realtime perspective, Gleixner <a
href="/ml/bpf/alpine.DEB.2.21.1910181256120.1869@nanos.tec.linutronix.de/">said</a>;
because of the lock substitution, code that does not look like it could
sleep actually can sleep since the realtime locks (e.g. sleeping spinlocks)
do so.  That's what makes using <tt>preempt_disable()</tt> (and
<tt>local_irq_disable()</tt>) problematic in the realtime context.
He said that the <tt>local_lock()</tt> mechanism in the realtime tree might
be a way forward to better handle the explicit preemption disabling in BPF.
</p>

<p>
But, he said, 
there is still the outstanding problem of BPF making calls to <a
href="https://elixir.bootlin.com/linux/v5.3.6/source/kernel/locking/rwsem.c#L1616"><tt>up_read_non_owner()</tt></a>,
which allows a read-write semaphore (rwsem) to be unlocked by a process
that is not the owner of the lock.  That breaks the realtime requirement
that the locker is the same as the unlocker in order to deal with  priority
inheritance correctly.
</p>

<p>
Starovoitov also said that BPF does not have unbounded runtime within the
preemption-disabled sections, since it has a bound on the number of
instructions that can be in a BPF program.  But the limit on the number of instructions
was recently raised from 4096 to one million, which will result in
unacceptable preemption-disabled windows as Gleixner <a
href="/ml/bpf/alpine.DEB.2.21.1910181031040.1869@nanos.tec.linutronix.de/">noted</a>:
<div class="BigQuote">
Assuming a instruction/cycle ratio of 1.0 and a CPU frequency of 2GHz,
that's 500us of preempt disabled time. Out of bounds by at least one order
of [magnitude] for a lot of RT scenarios.
</div>
</p>

<p>
Even the earlier limit of 4096 would result in 2µs of preemption-disabled
time, which may be problematic Clark Williams <a
href="/ml/bpf/20191018074936.36f15bd1@tagon/">said</a>; "[...] <q>there
are some customer cases on 
the horizon where 2us would be a significant fraction of their max latency</q>".
</p>

<p>
The <tt>local_lock()</tt> scheme <a
href="/ml/bpf/20191018230540.l6e4jtrlu44hk7q5@ast-mbp/">seemed viable</a>
to Starovoitov, but he thought the overall approach taken by
Siewior's patch was backward:
<div class="BigQuote">
But reading your other replies the gradual approach we're discussing here
doesn't sound acceptable ? And you guys insist on disabling bpf under RT
just to merge some out of tree code ? I find this rude and not acceptable.
<p>
If RT wants to get merged it should be disabled when BPF is on
and not the other way around.
</div>
</p>

<p>
But Gleixner <a
href="/ml/bpf/alpine.DEB.2.21.1910201043460.2090@nanos.tec.linutronix.de/">did
not see things that way</a> at all; he noted that he was planning to
investigate local locks as a possible way forward and that there was no
insistence on anything.  In addition, turning off realtime when BPF was
enabled was always an option; "[...] <q>I could have done that right
away without even talking to 
you. That'd have been dishonest and sneaky.</q>"  He also lamented that the
discussion had degraded to that point.
</p>

<p>
For his part, Starovoitov <a
href="/ml/bpf/20191022014324.yfrvdthj6rss742c@ast-mbp.dhcp.thefacebook.com/">said</a>
that he simply thinks disabling an existing in-kernel feature in order to
ease the path for the realtime patches is likely to "<q>backfire on
RT</q>".  He suggested getting the code upstream without riling other
subsystem developers was a better way forward:
<div class="BigQuote">
imo it's better to get key RT bits (like local_locks) in without
sending contentious patches like the one that sparked this thread.
When everyone can see what this local_lock is we can figure out
how and when to use it.
</div>
</p>

<p>
That's where things were left at the time of this writing.  It is not clear
that the practical effect of which subsystem disables the other makes any
real difference to users.  For now, users of BPF will not be able to use
the realtime patches and vice versa.  Fixing the underlying problems that
prevent the two from coexisting certainly seems more important than
squabbling over who disables who; there will
be users who want both in their systems after all.  For those who run mainline
kernels, though, that definitely cannot happen until realtime gets
upstream; once it does, a piecemeal approach to resolving the
incompatibilities between BPF and realtime can commence.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#BPF">BPF</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Realtime">Realtime</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/802884/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor802990"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2019 21:16 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/802990/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Turning off BPF just because PREEMPT_RT is enabled is a non-starter it is absolutely essential functionality for a Linux system at this point.</font><br>
Fortunately, it's not. BPF is optional for systemd and infrared drivers are used exceedingly rarely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/802990/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803191"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2019 8:25 UTC (Sat)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/803191/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't you think that degrading system performance back to the 90s is a non-starter?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803191/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2019 14:05 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/803227/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Turning off BPF does NOT degrade performance. It improves it instead.<br>
<p>
The exceptions are niche: XDP and network packet capture.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803230"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2019 15:13 UTC (Sat)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/803230/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting. What do you use as an alternative solution to BPF?  (Routing, packet filtering, tracing, ...)<br>
<p>
Personally, I love RT patch going mainline, it's a long way coming and I have no issues with two conflicting features (although it'd be amazing if we can refactor BPF to play nice with RT domain) but silently dropping BPF when you enable it (and thus silently affect lots of user space tools under the hood).<br>
<p>
I can see this happen as RT patch might be tempting for anyone with latency requirements (extreme gaming, interactive sound/video processing etc.).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803230/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803231"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2019 20:05 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/803231/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
BPF is fine for what it was designed - packet filtering.<br>
<p>
It's not fine for pretty much everything else, from syscall filters to LSMs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803231/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2019 20:49 UTC (Sat)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/803232/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There you have it, packet filtering will be degraded without BPF.<br>
<p>
I didn't get what you used instead for other parts but for LSM you use compiled kernel modules?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803327"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2019 18:57 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/803327/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not many people actually care about BPF for packet filtering. It's mostly useful for high-performance routers doing crazy deep-packet inspection and routing stuff with XDP. The intersection of these people and the RT users is pretty much an empty set.<br>
<p>
I absolutely despise the push to use BPF everywhere. It's just a bad technology - undebuggable, untraceable and hard to use. Moreover, BPF is now used as a fix for broken and dysfunctional subsystems in Linux, like the whole LSM infrastructure.<br>
<p>
I guess the only other significant valid use for BPF is perf/tracing. Although I'd like a better language there, with support for string operations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803327/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 31, 2019 22:09 UTC (Thu)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/803599/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, how much you dislike BPF, you are confirming that today, there are no better alternative for both packet filtering, LSM and tracing.<br>
<p>
The intersection between LSM or tracing with RT patch is likely not an empty set. If RT is driven by latency requirements, i'd also say that fast high level packet routing is interesting in this area whenever the network is involved in the latency (remote interaction).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803614"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 1, 2019 5:08 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/803614/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I seriously doubt that any RT system would need BPF-based packet filtering. Tracing is probably more realistic use-case, but probably not really that urgent.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803614/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor812871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2020 20:10 UTC (Wed)
                               by <b>voodoosound</b> (guest, #121807)
                              [<a href="/Articles/812871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am in the empty set.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/812871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor803000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 6:34 UTC (Thu)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/803000/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While it's strictly true that the RT patchset is out of tree, this characterization by the BPF maintainer is somewhat dishonest. The RT patchset has been around for much longer than the eBPF mud which has been churning out a number of vulnerabilities with significant impact, and whose sore security areas therefore need to be disabled by security-conscious administrators, unless the users of the systems really need the extra performance...<br>
<p>
The "if it's not in mainline, it doesn't exist" mentality is a disease, which allowed the current bad design and implementation of BPF, which doesn't care about latency, to blossom unchecked for a while.<br>
<p>
The measurements reproduced in this article show that BPF is unusable for a number of real-time purposes, and therefore, some, if not most, users of the RT patchset can't use BPF anyway... so why make their life disabling it harder, and (try to) block the merging of an important feature which has been worked on for many years, on the bad design of a recent and still fortunately highly optional feature ?<br>
Couldn't the technical conflicts between BPF and RT be resolved after merging the RT patchset, which should be done rather sooner than later, to (among other reasons !) help avoid the introduction of other similarly badly designed infrastructure ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 10:49 UTC (Thu)
                               by <b>knan</b> (subscriber, #3940)
                              [<a href="/Articles/803005/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please refrain from mudslinging and badmouthing in lwn comments.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor803002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 9:07 UTC (Thu)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/803002/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure I understand the very strong objections by Miller. It appears fairly obvious (to me at least) that the requirement is intended to be dropped once BPF works properly on RT, and the proposed solution by Miller (to disable RT if BPF is enabled) has the same net result as the original patch -- users of RT will have to disable BPF for the short-term while the other problems are ironed out. RT is not going to be enabled by default, so it won't affect stock kernel.org builds nor distribution kernels (unless they enable RT). Is the issue that allyesconfig will favour the wrong thing? If so, why such a strong reaction?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 31, 2019 7:23 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/803533/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The contrapositive of  RT =&gt; not BPF is: BPF =&gt; not RT.<br>
<p>
In plain (and symmetric) English they're just mutually exclusive.<br>
<p>
Is this just some Kconfig user interface nuance I'm missing?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor803009"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 12:03 UTC (Thu)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/803009/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So, how does "out-of-tree" RT work today with respect to BPF?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803009/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803017"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 13:53 UTC (Thu)
                               by <b>tglx</b> (subscriber, #31301)
                              [<a href="/Articles/803017/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It disables BPF because BPF was not on the top priority of things to support on RT.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803017/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor812872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 19, 2020 20:16 UTC (Wed)
                               by <b>voodoosound</b> (guest, #121807)
                              [<a href="/Articles/812872/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For me it works fine with XDP packet processing of audio and video streams (AVB).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/812872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor803019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RT merge *hooray*, let's work the problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 14:10 UTC (Thu)
                               by <b>david.a.wheeler</b> (subscriber, #72896)
                              [<a href="/Articles/803019/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am *very* delighted that the realtime patch set is moving into the mainline kernel tree.  There are massive numbers of devices that need this better real-time capabilities.<br>
<p>
I think it should be entirely expected that some mechanisms (such as BPF) have trouble interacting with a "new" capability.  I would like to see reasoned, careful discussions about how to try to resolve them, instead of simply saying "you can't do 2 things that are both useful".  I hope that's where this will go.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor803045"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 14:47 UTC (Thu)
                               by <b>SEJeff</b> (guest, #51588)
                              [<a href="/Articles/803045/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Reminder that the out of tree -rt patchset is why enormous projects that benefit all Linux users just as removing the BKL (Big Kernel Lock) were undertaken. Other big features like hires timers also were originally part of the out of tree -rt patchset. All Linux users have benefited from the work of the -rt patchset team, even if they've never used -rt enabled kernels.<br>
<p>
<a href="https://kernelnewbies.org/BigKernelLock">https://kernelnewbies.org/BigKernelLock</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803045/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor803073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 16:19 UTC (Thu)
                               by <b>nevets</b> (subscriber, #11875)
                              [<a href="/Articles/803073/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The -rt patch was the push behind lockdep, and a major reason why Linux runs so well on large SMP machines today. Back in 2005, with turning spinning locks into mutexes, we were able to trigger deadlocks on a uni-processor machine that would require 8 or more CPUs to trigger upstream. As it effectively made every thread act as a separate CPU. Since the -rt developers were so tired of playing whack-a-mole in solving these deadlocks, the push for lockdep came about. Since then, the number of deadlocks in the mainline kernel has dropped significantly!<br>
<p>
Yes, although the -rt patch set is out of tree, it was a major player in making Linux into the dominant operating system it is today. It should not be considered a second class citizen, EVER!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor803107"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2019 23:54 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/803107/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I disagree that BPF should never be turned off, or it wouldn't be optional in the first place. From where I'm standing, BPF seems about as “essential” as nvidia.ko. Or systemd. If a feature's being defended using tautologies like that it makes the whole thing suspect.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803107/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor803113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 25, 2019 2:03 UTC (Fri)
                               by <b>Kamilion</b> (subscriber, #42576)
                              [<a href="/Articles/803113/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"You put your correctness feature in my performance feature!"<br>
"You got your performance feature in my correctness feature!"<br>
"" What?? ""<br>
"" ... Delicious! ""<br>
<p>
Ref: <a href="https://www.youtube.com/watch?v=O7oD_oX-Gio">https://www.youtube.com/watch?v=O7oD_oX-Gio</a><br>
Let's all just get along.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor803600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF and the realtime patch set</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 31, 2019 23:19 UTC (Thu)
                               by <b>naptastic</b> (guest, #60139)
                              [<a href="/Articles/803600/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've been watching the -rt tree try to get merged since it started, and with how much of it has been merged, I'm frankly baffled that something that can disable interrupts and preemption for an unpredictable period of time snuck its way into the kernel.<br>
<p>
With -rt merged, there will be four selections for preemption model. What would make sense, IMO, is for BPF's behavior to change depending on that setting. For PREEMPT_NONE || PREEMPT_VOLUNTARY, the current behavior seems obviously correct to me. For the other settings, though, the user is saying "I'm willing to sacrifice bandwidth to get bounded latencies" and the whole kernel, including BPF, should respect that.<br>
<p>
Could BPF do the same thing interrupts did, with a top half and a bottom half, and only the top half runs in atomic context? Could it be done in such a way that performance for BPF isn't adversely affected if preemption is voluntary or off?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/803600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
