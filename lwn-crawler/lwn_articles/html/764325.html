        <!DOCTYPE html>
        <html lang="en">
        <head><title>Trying to get STACKLEAK into the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/764325/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/764310/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/764325/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Trying to get STACKLEAK into the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>September 12, 2018</br>
           <hr>
<a href="/Archives/ConferenceByYear/#2018-Linux_Security_Summit_NA">LSS NA</a>
</div>
<p>
The STACKLEAK kernel security feature has been in the works for quite some
time now, but has not, as yet, made its way into the mainline.  That is not
for lack of trying, as Alexander Popov has posted 15 separate versions of
the patch set since May 2017.  He described STACKLEAK and its tortuous path
toward the mainline in a <a
href="https://www.youtube.com/watch?v=5wIniiWSgUc&index=4&list=PLbzoR-pLrL6rOT6m50HdJFYUHyvA9lurI">talk
[YouTube video]</a> at the  <a
href="https://events.linuxfoundation.org/events/linux-security-summit-north-america-2018/">2018
Linux Security Summit</a>.
</p>

<p>
STACKLEAK is "an awesome security feature" that was originally developed by <a
href="https://pax.grsecurity.net/">The PaX Team</a> as part of the
PaX/grsecurity patches.  The last public version of the patch set was
released in
April 2017 for
the 4.9 kernel.  Popov set himself on the goal of getting STACKLEAK into
the kernel shortly after that; he thanked both his employer (Positive
Technologies) and his family for giving him working and free time to push
STACKLEAK. 
</p>

<p>
The first step was to extract STACKLEAK from the more than 200K lines of
code in the grsecurity/PaX patch set. 
He then "carefully learned" about the patch and what it does "bit
by bit".  He followed the usual path: post the patch, get feedback,
update the patch based on the feedback, and then post it again.  He has
posted 15 versions and "it is still in progress", he said.
</p>

<h4>Vulnerability types</h4>

<a href="/Articles/764604/">
<img src="https://static.lwn.net/images/2018/lssna-popov-sm.jpg" border=0 hspace=5 align="right"
alt="[Alexander Popov]" title="Alexander Popov" width=210 height=300>
</a>

<p>
There are three kinds of vulnerabilities that STACKLEAK is meant to defend
against.  The first is information disclosure that can come from leaving data
on the stack that can be exfiltrated to user space.  To combat that,
STACKLEAK overwrites the used portion of the kernel stack with
<tt>STACKLEAK_POISON</tt> (<tt>-0xBEEF</tt>) values at the end of each
system call.  After that, there is no 
lingering, potentially sensitive data on the kernel stack to be copied.
</p>

<p>
The second STACKLEAK feature is closely related.  It targets uninitialized
variables on the kernel stack with the same mitigation: writing
<tt>STACKLEAK_POISON</tt> to the stack after every system call.  That way,
the contents of uninitialized automatic variables will not be whatever was
written to 
that stack location before, but will instead be a known value.  That would
have blocked 
<a
href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2010-2963">CVE-2010-2963</a>
and <a
href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-17712">CVE-2017-17712</a>,
Popov said; he pointed to a <a
href="https://outflux.net/blog/archives/2010/10/19/cve-2010-2963-v4l-compat-exploit/">writeup
by Kees Cook</a> as a good description of how CVE-2010-2963 can be
exploited.
(Popov's <a
href="https://events.linuxfoundation.org/wp-content/uploads/2017/11/STACKLEAK-A-Long-Way-to-the-Linux-Kernel-Mainline-Alexander-Popov-Positive-Technologies.pdf">slides
[PDF]</a> also provide details of how these types of vulnerabilities can be
exploited.) 

<p>
One important limitation of the STACKLEAK stack-poisoning
mitigation, he said, is that it only works for multi-system-call attacks;
since the 
poisoning is done at the end of system calls, it cannot
protect against attacks that complete during a single system call.
</p>

<p>
The third piece is kernel stack overflow  detection at runtime.  This will guard
against problems like <a href="/Articles/726580/">Stack Clash</a>, but it
requires some other kernel features: <a href="/Articles/692208/">virtually
mapped kernel stacks</a> (<tt>CONFIG_VMAP_STACK</tt>) and <a
href="/Articles/692953/">moving <tt>thread_info</tt> into
<tt>task_struct</tt></a> (<tt>CONFIG_THREAD_INFO_IN_TASK</tt>).
Stack
Clash is an old bug; it was first described in 2005, <a
href="/Articles/400746/">incorrectly fixed in 2010</a>, and <a
href="https://www.qualys.com/2017/06/19/stack-clash/stack-clash.txt">raised
again by Qualys</a> in 2017 (where the name "Stack Clash" came about).
Popov pointed to a <a
href="https://grsecurity.net/an_ancient_kernel_hole_is_not_closed.php">2017
grsecurity blog post</a> that gives the history and also describes how the
PaX STACKLEAK feature 
would guard against the problem.  
</p>

<p>
In order to stop stack overflows, STACKLEAK checks the allocation size for
each <tt>alloca()</tt> call—generated by the compiler to support
variable-length arrays (VLAs)—in the kernel at runtime to see if it will
overrun the stack.  That is done with a plugin to GCC.  But the
<tt>alloca()</tt> check was not well-received by Linus Torvalds.
</p>

<p>
Popov said that there is a cost, of course, to the STACKLEAK feature.  It
is, not surprisingly, highly workload dependent.  The time-honored
kernel-build benchmark showed a 0.85% performance degradation, but
a hackbench run was 4.3% slower.  The former may be acceptable, while the
latter likely is not.  He has added the <tt>STACKLEAK_METRICS</tt> option
to help potential users evaluate the performance penalty on their
workloads. 
</p>

<p>
The current STACKLEAK patch set consists of two parts.  There is the code
that erases the part of the kernel thread stack that has been used, which
runs at the end of system calls, and there is a GCC plugin that tracks the
deepest point of the stack, so that the erase functionality covers
everything that has been used.  The part of the GCC plugin that does the
<tt>alloca()</tt> checking has been removed because it is "hated by Linus".
</p>

<h4>Upstreaming timeline</h4>

<p>
The timeline for STACKLEAK in the mainline begins in April 2017 when <a
href="/Articles/721848/">grsecurity decided to start releasing its patches
only to its customers</a>.  Shortly thereafter, he decided to work on
upstreaming 
STACKLEAK, an effort that had been started by Tycho Andersen.  As he posted
the first versions, he was learning about the patch set; he started by
looking into the assembly language stack-clearing code. In June, Stack
Clash was announced and grsecurity put out its blog post that "trolled" his
efforts as simply a copy and paste of the PaX feature without understanding
it. 
</p>

<p>
Popov had documented what he still needed to learn in the to-do list on his
patches; next up was the GCC plugin, where he found and fixed a few bugs.
As time went on, he dug into other pieces of STACKLEAK, found and 
fixed other problems, and so on. There are multiple ways to get from kernel
space 
to user space at the end of a system call.  He tracked all of those down and
found a place where stack erasing had been missed, for example.
</p>

<p>
In January 2018, he was alerted to the <a
href="/Articles/741878/">page-table isolation (PTI) patches</a>, so he
rebased on top of those and, once Meltdown and Spectre were announced,
changed STACKLEAK to deal with return trampolines <strike>(retpolines)</strike>.  At the
time, "I felt like I was in the middle of this hurricane" with everything
that was going on in the kernel; "it was very impressive". 
</p>

<p>
With version 9, he thought STACKLEAK was ready to be merged, but that
was when the patches got "burned by Linus".  The stack-clearing feature
 <a href="/Articles/748642/">did not pass muster with Torvalds</a> and he said
so in no uncertain terms.  There were lots of "angry words" in Torvalds's
responses, Popov said.  But, as part of the exchange, Torvalds did say that
variable-length arrays 
should be removed from the kernel; that started the <a
href="/Articles/749064/">process</a> of removing them, which has <a
href="/Articles/763641/">made good progress</a>, but is still ongoing.
</p>

<p>
That interaction left Popov "emotionally dead for several weeks".  His wife
suggested that he go back to the replies and try to extract the technical
complaints from them.  The main complaint was that the stack-clearing code
was written in assembler, so he started looking to write that part in C.
That was difficult to do because it is tricky to make GCC emit code that is
similar to hand-written assembly code.  But he got it to work and posted
v10 of the patch set, which Brad Spengler of grsecurity called the
"<a href="https://en.wikipedia.org/wiki/Stockholm_syndrome">Stockholm
syndrome</a> patch series", Popov said. 
</p>

<p>
Several more versions were released in the months since March and, with
version&nbsp;14, he once again thought it was ready to be merged.  But the
<a
href="/ml/linux-kernel/20180813214328.GA15137@beast/">pull
request</a> for 4.19 was "burned by Linus a second time".  In his <a
href="/ml/linux-kernel/CA+55aFw5Tkn6DgkAZS-UGOjJpYp2R4rFAm9ixu_=FONeqRyofg@mail.gmail.com/">rejection</a>,
Torvalds complained about the use of <tt>BUG_ON()</tt> in the
<tt>alloca()</tt> checking and the stack-erasing code.  He
had several strongly worded responses in that thread.  Popov once again
extracted the technical objections from the angry words to produce another
version that is targeted for the next version of Linux (4.20 or, perhaps, 5.0).
</p>

<h4>STACKLEAK changes</h4>

<p>
Along the way, he has made multiple changes to the original STACKLEAK
feature.  Bugs in the GCC plugin have been fixed, some assertions in the
stack tracking and <tt>alloca()</tt> checks were wrong and have been
corrected, and STACKLEAK was missing places where the stack needed erasing,
which 
have been added.  There was a lot of refactoring as well.  Popov extracted
the common parts (including the C rewrite of the stack-erasing code) to
make it easier to port STACKLEAK to new platforms.  The initial version was
far from the "usual requirements" for upstream inclusion, in terms of
documentation and code style, but he has cleaned that all up.
</p>

<p>
There is also new functionality that has been added to the original
feature.  Trampoline stack support has been added for x86_64, for example.
He and Andersen put together some "nice tests" to go with the
feature. Laura Abbott added support for arm64 and worked with him on
GCC&nbsp;8 support for the plugin.  Two features that were requested by
Ingo Molnar have been added: the metrics feature that tracks
stack usage in system calls to help performance evaluations and a way to
disable STACKLEAK at runtime, which Popov said he was opposed to, but
Molnar insisted on.  The runtime disable is only available if it is configured
into the kernel, which it is not by default; that was the compromise that
he and Molnar found, Popov said.
</p>

<p>
There is functionality that has been dropped from the PaX STACKLEAK feature
as well.  The erroneous assertions in the stack-tracking code are gone as
he noted earlier.  There was code to do stack erasing at the beginning of
system calls after calls like
<tt>ptrace()</tt> and <tt>seccomp()</tt>, but that got dropped early on due
to complaints from Torvalds.  Most recently, the <tt>alloca()</tt> checking
has been dropped since it is believed that all VLAs are on their way out of
the kernel (and <tt>-Wvla</tt> will be enabled so none creep back in),
though that 
job has not been completed yet.  In addition, it is now abundantly clear that
<tt>BUG_ON()</tt> is <a
href="/ml/linux-kernel/CA+55aFy6jNLsywVYdGp83AMrXBo_P-pkjkphPGrO=82SPKCpLQ@mail.gmail.com/">completely
prohibited</a> for hardening patches.
</p>

<p>
Popov noted that Spengler has said that upstream security developers often
do not understand the code they have copy-pasted from grsecurity. "I am
sure that is not applicable to the STACKLEAK upstreaming efforts", Popov said.
</p>

<p>
He went on to explain what he meant by "burned by Linus" in his talk and on
his slides.  There is strong language in some of Torvalds's replies, "even
swearing, which I don't quote" mixed with the technical objections.  So
people need to put their emotions aside and try to extract the actual
complaints from these kinds of messages.  Torvalds will also NAK patches
without even looking at them, which is difficult to handle, Popov said.
It makes him wonder if Torvalds is by default irritated by the kernel
hardening initiatives.

<p>
Popov said that all of that "kills my motivation"
to work on Linux.  It remains to be seen if STACKLEAK will get merged or if
all of his efforts have simply been like those of <a
href="https://en.wikipedia.org/wiki/Sisyphus">Sisyphus</a>.  In
conclusion, Popov said, the attendees represent the Linux kernel
community, which is responsible for all of the different systems that run
"our favorite operating system".  He suggested putting more effort
toward kernel security features so that those efforts cannot be ignored.
</p>

<p>
[I would like to thank LWN's travel sponsor, the Linux Foundation, for
travel assistance to attend the Linux Security Summit in Vancouver.]<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Kernel_hardening">Security/Kernel hardening</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Hardening">Linux kernel/Hardening</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Linux_Security_Summit_North_America-2018">Linux Security Summit North America/2018</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/764325/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor764669"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 12, 2018 22:53 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/764669/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't understand why Cook and Popov and others keep putting up with Linus' abusive behaviour. There are plenty of other interesting projects with non-toxic communities. I suppose in Cook's case Google makes it worth his while.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764669/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764726"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 16:48 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/764726/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus' abusive behaviour is unnecessary theatrics, a curable condition. I hope one day it is so, rehabilitation is better than isolation.<br>
<p>
grsecurity's abusive behaviour on the other hand is sincere, unwavering, and part of their business model.<br>
<p>
I see this work, and similar efforts, as a long term project to extinguish the latter. With no more unique product to sell and a bit of patience, the company will perish and we'll suffer no more of them; they bring no skills to the table besides public trolling of anyone in the same field as them (= burnout, less security work being done, more for them to charge for), and code that takes a herculean effort every time to be hammered into fit-for-upstream condition (I don't think Hanlon's Razor applies here).<br>
<p>
It seems to be worth money to some companies, and it's a lot more bang for the buck in that regard than trying to kick Linus out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764726/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764751"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 20:09 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/764751/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Linus' abusive behaviour is unnecessary theatrics, a curable condition. I hope one day it is so, rehabilitation is better than isolation.</font><br>
<p>
I agree, but he needs help. It's unclear from the outside whether anyone he respects is willing to call him on it.<br>
<p>
Maybe the LWN editors? They surely appreciate the problem, given that if someone repeated Linus' behaviour in these LWN comments, they'd be banned.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764751/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 17:13 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/764844/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I doubt that. People have been much more offensive than Linus without being banned here. It *is* possible to be so offensive you get banned, but it's hard. (Linus levels of offensiveness would probably only get a warning.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor764771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 22:29 UTC (Thu)
                               by <b>sjfriedl</b> (<b>&#x272D; supporter &#x272D;</b>, #10111)
                              [<a href="/Articles/764771/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; grsecurity's abusive behaviour on the other hand is sincere, unwavering, and part of their business model.</font><br>
<p>
Not having any of the history, I'm trying to figure out what led the universe here. Everything I've seen about grsecurity is that it's real-deal security, but my review has been extremely superficial (and I'm not a user).<br>
<p>
Is this a case of some really smart people doing yeoman security work on the kernel, but nobody wants to pay for security, so they react badly when their business model doesn't pan out?<br>
<p>
Or is this something else?<br>
<p>
I really don't know the answer (and I have no dog in this fight). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764863"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2018 12:40 UTC (Sat)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/764863/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The grsec code does add some security from what I've observed second-hand, but it goes about it like windows antivirus vendors: sticking hooks in random places and doing many things to cause userspace breakage (one of the reasons it never got upstreamed) and worse, kernel breakage (a normal user should never be able to hang the kernel with `cat`).<br>
<p>
The way they respond to criticism of those things, you'd think they were malware authors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764863/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor765179"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2018 23:41 UTC (Mon)
                               by <b>ThinkRob</b> (guest, #64513)
                              [<a href="/Articles/765179/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
 Linus' abusive behaviour is unnecessary theatrics, a curable condition. I hope one day it is so, rehabilitation is better than isolation.</blockquote>

<p>
I think part of why Linus doesn't get called out on it as much is that it's not always obvious from the various quotes and excerpts that make it into the mainstream trade press.  (And they certainly make for attention-getting headlines, so I get why they're reprinted.) Before I followed kernel dev that closely I would have been surprised if this were the case.  But after having gotten more into kernel dev in the last year or two now, it's obvious that yeah, it is.  Why?  Because he often leads in to a rejection with a flame, but then [frequently] has solid technical critiques... later on in the thread.

<p>
There's some argument to be made that "you have to be blunt or exceptions start getting made".  And I get, and am even sympathetic to that... to some degree. But that doesn't mean that you have to 1) go in all-guns-blazing every single time 2) make the attacks personal.  You can still have an honest response to a bad patch that rips the code apart [1] and that doesn't come off as condescending or malicious or personal, but far too often I've read flames from him that make it sound like he dislikes the <i>coder</i> rather than the code.  And that makes it a problem, whether that's his intent or not.

<p>
He doesn't even have to stop calling bad code bad!  We've probably all ranted to a friend or coworker about some busted, oddball library we were forced to use.  And most of us probably get a kick out of things like that infamous rant on the PSD file format or some of JWZ's musings on "the Xwindows disaster".  But this isn't the same, because Linus's screeds often aren't aimed at the code, they're about people.  And that takes it from a potential solution to a technical problem to serious problem for people trying to write technical solutions.

<p><sup>[1] although whether or not such a blunt response is necessary or appropriate is situation dependent</sup>
      
          <div class="CommentReplyButton">
            <form action="/Articles/765179/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor764776"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 0:23 UTC (Fri)
                               by <b>curtis3389</b> (guest, #127185)
                              [<a href="/Articles/764776/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; There are plenty of other interesting projects with non-toxic communities.</font><br>
<p>
This struck me.<br>
<p>
Is there a consensus that the Linux community is toxic?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764776/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764777"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 0:50 UTC (Fri)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/764777/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I assume a lot of developers in the kernel community itself would disagree, though selection effects must partially explain that.<br>
<p>
But I don't think there are many other open-source projects where Linus' behaviour would be tolerated. In that sense, I think there is a consensus.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764777/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764798"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 9:36 UTC (Fri)
                               by <b>blackwood</b> (guest, #44174)
                              [<a href="/Articles/764798/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus and Linux are fairly regularly used in keynotes as _the_ example of a toxic/dysfunctional community. e.g. rust just recently:<br>
<p>
<a href="https://www.youtube.com/watch?v=J9OFQm8Qf1I&amp;feature=youtu.be&amp;t=2425">https://www.youtube.com/watch?v=J9OFQm8Qf1I&amp;feature=y...</a><br>
<p>
(jumps directly to the right spot)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764798/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor764786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 6:00 UTC (Fri)
                               by <b>seyman</b> (subscriber, #1172)
                              [<a href="/Articles/764786/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Is there a consensus that the Linux community is toxic?</font><br>
<p>
I believe there's a consensus that a number of former kernel devs are now working on other projects because they did not appreciate the Linux community mindset. There's also consensus that a number of people have chosen to not get involved with kernel development in the first place for the same reason.<br>
<p>
As roc said, the kernel community itself probably disagrees and I suspect only legal action will change their minds.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764792"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 7:21 UTC (Fri)
                               by <b>lkundrak</b> (subscriber, #43452)
                              [<a href="/Articles/764792/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Is there a consensus that the Linux community is toxic?</font><br>
<p>
What would justify calling the whole community toxic? Is a couple of individuals who occasionally say something that insults someone else's feelings sufficient?<br>
<p>
If so, then any sufficiently large community is guaranteed to get toxic.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764792/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 8:34 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/764793/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's the tolerance of this behavior that makes it toxic.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764809"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 12:35 UTC (Fri)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/764809/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would argue that Linux devel has become toxic, but for the complete opposite reason that you think.<br>
<p>
Linux devel used to be fun, exciting, risky, interesting.  But the big push has come in to make it corporate.  And the more corporate it becomes, it's mostly now indistinguishable for coding for IBM or Microsoft or similar.<br>
<p>
So despite years and years of being a committed Linux user and developer, I find myself caring less and less.  Because with the limited free time I have to code, why volunteer that time to a project that has become bland and boring.<br>
<p>
But anyway, feel free to keep up your push to stamp out what little  flame there is left in the community.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764809/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 13:40 UTC (Fri)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/764819/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps the issue is that Linux's original culture has become a victim of its own success. Nowadays Linux is so big and so important that it would be irresponsible to leave its development to just a bunch of hackers having fun. Maintaining it and extending it requires thousands of developers working together, because of the sheer amount of work involved, and getting that many people to cooperate productively requires boring management and professional communication etc to minimise interpersonal conflicts - the kind of culture that has helped Microsoft and IBM successfully develop software over decades with thousands of developers. It's not fun or efficient, but it works.<br>
<p>
If you want to work in a culture like Linux had when it was small and unimportant, there are plenty of other projects that are small and unimportant that you could work on. And hopefully you will help those to become large and successful and boring, and then can move on to another one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor764794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 11:35 UTC (Fri)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/764794/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's disingenuous to refer to Linus as just "an individual" in the community.<br>
<p>
As Cyberax says, it's the toleration, defense and even sometimes celebration of this behaviour that is toxic.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor766436"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">individuals, and robustness in the face of extreme diversity thereof</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 24, 2018 5:18 UTC (Mon)
                               by <b>Garak</b> (guest, #99377)
                              [<a href="/Articles/766436/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>It's disingenuous to refer to Linus as just "an individual" in the community.</blockquote>

lkundrak was clearly enough describing a general logical proof involving sets and individuals.  Extrapolating the situation to the general, not referring to the specific instance.  Thus not disingenuous.<br/>
<br/>
I too think that a significant aspect of this is the 'specialness' of the 'supreme leader'(core trademark holder).  At the end of the day, anyone is free to fork linux, call it anything else, and do whatever they want.  It's not like anything Linus Torvalds does or does not do interferes with anyone's freedom to do that.  Given that dynamic (the core dynamic of FOSS), this doesn't seem very important to me (given the context of billions if not trillions of processors out there running 'linux' and keeping the world turning)

      
          <div class="CommentReplyButton">
            <form action="/Articles/766436/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor764675"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 6:01 UTC (Thu)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/764675/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Here's what spender has to say about this article:<br>
<a href="https://twitter.com/grsecurity/status/1039987873683070977">https://twitter.com/grsecurity/status/1039987873683070977</a><br>
<a href="https://twitter.com/grsecurity/status/1039988230811250689">https://twitter.com/grsecurity/status/1039988230811250689</a><br>
<a href="https://twitter.com/grsecurity/status/1039988817745375233">https://twitter.com/grsecurity/status/1039988817745375233</a><br>
<p>
'Some false quotes from LWN's regurgibloid article on STACKLEAK: "some assertions in the stack tracking and alloca() checks were wrong and have been corrected" / "STACKLEAK was missing places where the stack needed erasing"<br>
In fact, the current upstream-proposed STACKLEAK is weaker in a number of areas where it matters, but LWN will never report that because they need it on some public mailing list and written by an upstream developer they can copy+paste their uncritical articles from<br>
(It's also slower for reasons that serve no security purpose at all, and their manual VLA removal has resulted in slower/buggier code in general -- what's faster, a simple check inserted by the compiler to make sure a VLA use is safe, or a whole kmalloc/kfree in a function?)'<br>
<p>
Since two persons are asserting opposite things about a matter, we know that at least one of them is lying, whether voluntarily or not.<br>
Given the stellar track record of spender and PaXTeam on:<br>
* creating quality defenses and being able to explain their tradeoffs and why they work: KERNEXEC, MEMORY_UDEREF, CONSTIFY, RANDSTRUCT, RAP (none of which mainline Linux has at a breadth that resembles grsecurity's, or at all, despite their protective ability), etc.;<br>
* criticizing / not implementing poor defenses: KASLR, Intel's very weak CFI called CET, etc.<br>
* IME, usually thanking / pointing when their own mistakes are found: for instance, some bugs I reported in grsecurity over time, such as a double stable patch security backport; more recently, spender pointing that he found that his initial thought about Meltdown being already inexploitable on properly configured grsec kernels was wrong, although the standard exploit which tripped other kernels was indeed blocked<br>
their vision of Linux security is more effective, and they usually warrant more trust wrt. statements related to Linux security, than basically anyone else. Even if they can certainly make mistakes, like everyone else.<br>
<p>
Mainline Linux security is a lost cause... even if a semi-official curated hardened Linux tree, like strcat's, were to be created, and maintained in a sustainable way over the long term, as a way to widen testing of patches in the real world before they hit mainline.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764675/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764680"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 6:38 UTC (Thu)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/764680/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please aim higher. <br>
<p>
This presentation does little to convince any who are not already convinced. If you don't care about that goal, then I do not see the point of this at all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764680/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764688"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 12:50 UTC (Thu)
                               by <b>jkingweb</b> (subscriber, #113039)
                              [<a href="/Articles/764688/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm mystified as to why grsecurity is attacking LWN for the patch's supposed failings. Is Jake supposed to know the patch better than its author does? Where's the hostility coming from?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764688/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764691"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 13:14 UTC (Thu)
                               by <b>sjfriedl</b> (<b>&#x272D; supporter &#x272D;</b>, #10111)
                              [<a href="/Articles/764691/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; [jkingweb] Where's the hostility coming from?</font><br>
<p>
No kidding.   I knew nothing about this issue before this article, and the responses don't give a very good impression.<br>
<p>
<font class="QuotedText">&gt; [Lionel_Debroux] Since two persons are asserting opposite things about a matter, we know that at least one of them is lying, whether voluntarily or not.</font><br>
<p>
Uh, "involuntarily lying"?  Maybe an alternate explanation is that one of them is merely mistaken?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764691/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764740"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 18:15 UTC (Thu)
                               by <b>seyman</b> (subscriber, #1172)
                              [<a href="/Articles/764740/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I'm mystified as to why grsecurity is attacking LWN for the patch's supposed failings.</font><br>
<p>
I share that sentiment. One of the tweets pointed out by Lionel criticizes LWN for requiring quoted information to be public but I view that as a good thing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764740/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764747"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 19:53 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/764747/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Once the community no longer supports you and the current state of the world no longer supports your business model, and you start building your business on FUD, then good reporting, facts, and sunlight become your enemy. (Sunlight is the best disinfectant, which is good news unless you're building your business around the infection.) grsecurity is pretty much SCO at this point, lawsuits included.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764747/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 22:14 UTC (Thu)
                               by <b>seyman</b> (subscriber, #1172)
                              [<a href="/Articles/764766/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; grsecurity is pretty much SCO at this point, lawsuits included.</font><br>
<p>
Speaking at which, did grsecurity ever refile the defamation suit they had going against Bruce Perens? Last I heard, the case had been thrown out by the judge. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764788"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 10:23 UTC (Fri)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/764788/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      As long as the PaX and grsecurity patchsets were publicly downloadable at no extra cost (beyond some form of Internet connection, that is), until April 2017:<br>
<ul><li><i>about community support</i>: they did have a loyal following of users aware of the insecurity of mainline kernels, and willing to go through limited extra pain (especially after multiple large distros gained linux-grsec packages, at the cost of slightly reduced security because it nullifies RANDSTRUCT) to use more secure kernels than the default.<br>
Unfortunately, too many people trust words by Linus and friends more than words by the real security experts PaXTeam and spender. Many people - including subsystem and driver maintainers - didn't even bother to dig deeper into the huge security benefits of PaX / grsecurity + the hundreds of small, scattered bugfixes relevant to subsystem maintainers + the many additional stable backports (see Twitter thread about hundreds more patches being backported in grsecurity than in mainline) relevant to, well, pretty much everyone not trying to run mainline kernels all the time, i.e. lots of users. Instead of making their informed opinion by themselves, some of these people based their decisions on hearsay...<br>
The insecurity of mainline kernels is technically alleviable, as shown by PaX / grsecurity, but politically unfixable as shown by Linus rejecting some useful features and watering others down - as reported in this article and other earlier articles.</li>
<li><i>about supporting their business model</i>: I can agree with that part of your post. It's a fact that the corporate customers, and community supporters, paying spender's company used not to be enough for PaXTeam + spender to be able to work on PaX / grsecurity near-full-time (assuming they wished to be able to do that anyway - I simply don't know). Most people just used the free version even in professional setups, few of them contributed money.<br>
The KSPP made their business model even more unsustainable by creating <i>more</i> work for them by integrating buggy, watered down derivatives of outdated versions of small PaX / grsecurity subsets: PaXTeam and spender had to fix conflicts, debug issues, review mainline changes which often turned out to be more bugs than fixes they should reintegrate.</li>
<li><i>good reporting, facts and sunlight</i>: it's not clear to me how good reporting / facts / sunlight would be real enemies to PaX/grsecurity. If "reporters" pretend to provide good information, based on facts, and shine some sunlight, then they have no choice but point the <a href="https://grsecurity.net/features.php">large feature set</a>. I found the earlier version clearer, with its single table full of ticks for grsecurity and missing features for mainline, but it was less detailed.<br>
Maybe on the communication style front, as spender's style is known to be abrasive ? Sure, but then Linus' style is also well documented as repeatedly offensive, turning some developers away from the kernel community (see multiple posts in the sub-thread above the sub-thread I started - I'll add a mention of Sarah Sharp, who created the USB 3 stack in Linux, making Linux the first kernel with decent USB 3 support). Good reporting needs to point it too.<br>
The defamation suit ? Indeed, that wasn't a step in the right direction, and definitely earned them negative publicity... But Bruce Perens contributing negative things against a technically unmatched product - from a relatively famous and supposedly trusted person, that other people can use to justify more FUD against grsecurity - might not have been a smart thing to do for the progress of mankind. There would have been no reason to make a suit against him without that trigger.</li></ul>
<br>
Now that they only provide the PaX and grsecurity patchsets behind a paywall accessible only to corporations (AFAIK):
<ul><li>they have lost their community of individual users, obviously;</li>
<li>however, they have gained customers (more logos on their web page, at least, but...), so the state of the world does support their business model to some extent, at least better than it used to when nearly everyone was free-riding. The defamation suit probably alienated them some potential customers, but the increased visibility might have unexpected benefits, who knows.</li>
<li>no change on good reporting, facts and sunlight: they obviously need to mention the defamation suit and the abrasiveness, but they also have to mention the technical advantages of the product, the severe systemic insecurity of the product it is based on, and the toxicity of mainline development, starting with Linus' abrasiveness.</li></ul>
<br>
TL;DR: I tried to imagine what you meant in multiple areas, but I partially failed. Are you willing to give more details on what you meant ? :)
      
          <div class="CommentReplyButton">
            <form action="/Articles/764788/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 12:26 UTC (Fri)
                               by <b>seyman</b> (subscriber, #1172)
                              [<a href="/Articles/764806/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But Bruce Perens contributing negative things [...] might not have been a smart thing to do for the progress of mankind.</font><br>
<p>
Bruce Perens warning people that using Grsecurity's Linux kernel security could invite legal trouble is indeed a smart thing to do, contrary to what you claim. <br>
<p>
<font class="QuotedText">&gt; There would have been no reason to make a suit against him without that trigger.</font><br>
<p>
There was no reason to sue him even with that trigger, as a judge has ruled.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2018 5:40 UTC (Sat)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/764858/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Re RANDSTRUCT, any idea if PaX/grsec folks have evaluated multicompiler?<br>
<p>
<a href="http://ssllab.org/#multic">http://ssllab.org/#multic</a><br>
<a href="https://github.com/securesystemslab/multicompiler">https://github.com/securesystemslab/multicompiler</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor765759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2018 11:14 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/765759/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Since two persons are asserting opposite things about a matter, we know that at least one of them is lying, whether voluntarily or not.</font><br>
<p>
From personal experience I can assure you that you're wrong. And I'm pretty certain the correct conclusion in policing is that if two people assert the SAME thing about a matter, then they are probably lying (colluding).<br>
<p>
Firstly there is the law of relativity - two observers in two different places will see the same event in two different ways.<br>
<p>
And secondly, I have had plenty of experience of friends describing things to me - where I have the same personal experience as them - and I beg to differ strongly with what they see. That doesn't mean one of us is lying. It means one of us is *wrong*, but that's a very different matter - chances are *both* of us are wrong.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/765759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor764676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">GCC stackleak function attribute</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 6:47 UTC (Thu)
                               by <b>mjw</b> (subscriber, #16740)
                              [<a href="/Articles/764676/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At the GNU Tools Cauldron last week there was a presentation on a similar topic to get a new stackleak like attribute for functions that would clear the stack used on function return into GCC.<br>
<p>
This might be used instead of the gcc plugin currently used (assuming the goals are similar enough). It might be interesting to collaborate on these kind of functionality/security mitigations can be made more generic so they can be used across user and kernel space.<br>
<p>
Slides and video should appear here soon: <a href="https://gcc.gnu.org/wiki/cauldron2018#Slides.2C_Videos_and_Notes">https://gcc.gnu.org/wiki/cauldron2018#Slides.2C_Videos_an...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">GCC stackleak function attribute</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 10:08 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/764683/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That certainly sounds sensible.  Following up on roc's comment above, might the working environment be more friendly as well?  Perhaps other people working on security in the kernel should be looking at whether some of their work can be done in the toolchain instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">GCC stackleak function attribute</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 13:45 UTC (Thu)
                               by <b>a13xp0p0v</b> (guest, #118926)
                              [<a href="/Articles/764697/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nice! Thanks for the link.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764699"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">GCC stack_erase function attribute</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 13:52 UTC (Thu)
                               by <b>mjw</b> (subscriber, #16740)
                              [<a href="/Articles/764699/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It looks like the video of the talk isn't there yet, but I found the slides already here: <a href="https://gmarkall.files.wordpress.com/2018/09/secure_and_gcc.pdf">https://gmarkall.files.wordpress.com/2018/09/secure_and_g...</a><br>
<p>
The suggested attribute name was actually "stack_erase".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764699/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor764685"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 12:56 UTC (Thu)
                               by <b>a13xp0p0v</b> (guest, #118926)
                              [<a href="/Articles/764685/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the article, Jake!<br>
You've done a very good job since grsecurity doesn't complain about crediting them right.<br>
<p>
Let me correct this:<br>
<p>
<font class="QuotedText">&gt; In January 2018, he was alerted to the page-table isolation (PTI) patches, so he rebased on top</font><br>
<font class="QuotedText">&gt; of those and, once Meltdown and Spectre were announced, changed STACKLEAK to deal with</font><br>
<font class="QuotedText">&gt; return trampolines (retpolines).</font><br>
<p>
STACKLEAK has nothing to do with Spectre and retpolines.<br>
<p>
PTI patches introduced the trampoline stack on x86_64. Kernel switches to<br>
this stack from a thread stack just before returning to the userspace. However<br>
there are cases when we return to the userspace directly from the thread stack,<br>
without switching to this trampoline stack.<br>
<p>
So during rebasing I adjusted the stack erasing. It detects which stack is used and:<br>
 - if it is called from the trampoline stack, erasing goes up to the thread stack top,<br>
 - if it is called from the thread stack, erasing goes up to the stack pointer. <br>
<p>
----<br>
<p>
Now let me give the technical details according to Brad Spengler's comments in twitter.<br>
<p>
First, I should say that having any technical feedback from him about my patches<br>
is a VERY rare event. So I'm glad that he posted it, let's talk about that.<br>
<p>
<font class="QuotedText">&gt; 'Some false quotes from LWN's regurgibloid article on STACKLEAK: "some assertions</font><br>
<font class="QuotedText">&gt; in the stack tracking and alloca() checks were wrong and have been corrected" </font><br>
<p>
1. The original assertion in track_stack() for detecting stack exhaustion<br>
looks like that:<br>
 +	if (unlikely((sp &amp; ~(THREAD_SIZE - 1)) &lt; (THREAD_SIZE / 16)))<br>
 +		BUG();<br>
<p>
After a careful look you can see that this check will never work because of erroneous '~'.<br>
<p>
But if we remove this '~', we get into another trouble: when kernel stack is exhausted<br>
and this check is hit, we get into recursive BUG(), since the functions which handle<br>
BUG() are instrumented and call track_stack() themselves. <br>
<p>
As a result, this recursive BUG() handling hits the guard page below the thread stack or<br>
corrupts the neighbor memory (if CONFIG_VMAP_STACK or similar feature is disabled).<br>
<p>
That's why I say that the original assertion in stack tracking was wrong.<br>
<p>
2. Now about assertion in check_alloca().<br>
In v4 I also fixed the surplus and erroneous code for calculating stack_left in check_alloca()<br>
on x86_64. That code repeats the work which is already done in get_stack_info() and it<br>
misses the fact that different exception stacks on x86_64 have different size.<br>
<a href="https://www.openwall.com/lists/kernel-hardening/2017/10/04/68">https://www.openwall.com/lists/kernel-hardening/2017/10/0...</a><br>
<p>
<font class="QuotedText">&gt; "STACKLEAK was missing places where the stack needed erasing"</font><br>
<p>
I added missing erase_kstack() call at ret_from_fork() for x86_32.<br>
<p>
Anyway, if Brad will prove that I'm wrong, I'll be only happy to learn it.<br>
By the way, he never thanked me for the STACKLEAK fixes which I shared with him.<br>
<p>
<font class="QuotedText">&gt; In fact, the current upstream-proposed STACKLEAK is weaker in a number</font><br>
<font class="QuotedText">&gt; of areas where it matters</font><br>
<p>
I absolutely agree with Brad. Linus and Ingo made me do several changes<br>
which I'm not happy about. It's the price for our compromise. In fact, Linus<br>
doesn't want STACKLEAK at all, but I fight for it.<br>
<p>
<font class="QuotedText">&gt; (It's also slower for reasons that serve no security purpose at all,</font><br>
<p>
Yes, technically that's true. However, I didn't see the noticeable difference during<br>
performance tests. Original stack erasing in assembly language and my stack erasing<br>
in C show the same numbers.<br>
<p>
<font class="QuotedText">&gt; and their manual VLA removal has resulted in slower/buggier code in general</font><br>
<font class="QuotedText">&gt; -- what's faster, a simple check inserted by the compiler to make sure a VLA use</font><br>
<font class="QuotedText">&gt; is safe, or a whole kmalloc/kfree in a function?)'</font><br>
<p>
I don't have a strong opinion on that.<br>
Please see Kees' talk at Linux Security Summit, which gives more details:<br>
<a href="https://www.youtube.com/watch?v=XfNt6MsLj0E">https://www.youtube.com/watch?v=XfNt6MsLj0E</a><br>
<p>
Anyway, I don't like dropping check_alloca() forced by Linus.<br>
Let's imagine that all VLAs are removed from the mainline kernel.<br>
But how about VLAs in non-upstream code? STACKLEAK with check_alloca()<br>
could protect it from Stack Clash!<br>
<p>
----<br>
<p>
Let's see what will happen with my patches in the next merge window.<br>
The current v15 fits Linus' requirements.<br>
I wish Kees Cook the best of luck to negotiate with Linus.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764685/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 14:02 UTC (Thu)
                               by <b>jake</b> (editor, #205)
                              [<a href="/Articles/764701/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; STACKLEAK has nothing to do with Spectre and retpolines.</font><br>
<p>
ah, sorry about that ... my brain badly wanted to turn 'return trampoline' into 'retpoline' for some reason ... i have adjusted the article ...<br>
<p>
thanks,<br>
<p>
jake<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor764840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 14:48 UTC (Fri)
                               by <b>a13xp0p0v</b> (guest, #118926)
                              [<a href="/Articles/764840/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ok, Brad Spengler has replied with a very detailed post about STACKLEAK:<br>
<a href="https://grsecurity.net/~spender/stackleak_response.txt">https://grsecurity.net/~spender/stackleak_response.txt</a><br>
<p>
Cool, I appreciate that! Normally such discussions happen at the Linux Kernel<br>
Mailing List (LKML), but in our case I have to reply here at LWN.<br>
<p>
I also see that Brad is desperately trying to be always right. Actually he can relax:<br>
he is genius, he is always right, I'm not protesting :)<br>
<p>
I just do my work: I'm pushing this feature into the mainline.<br>
<p>
Let me reply Brad.<br>
<p>
============<br>
<p>
<font class="QuotedText">&gt; RE: the assertion in track_stack, the flaw in it (the added ~) was found by Tycho Andersen,</font><br>
<font class="QuotedText">&gt; not Alex (though it's not claimed directly, it's implied as Alex is taking credit for the STACKLEAK</font><br>
<font class="QuotedText">&gt; upstreaming work).  This was properly credited below:</font><br>
<font class="QuotedText">&gt; commit 12927d314b2763dd791ef11e56c42184fba4d3f8</font><br>
<font class="QuotedText">&gt; Author: Brad Spengler &lt;spender@grsecurity.net&gt;</font><br>
<font class="QuotedText">&gt; Date:   Tue Aug 15 07:11:47 2017 -0400</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    Fix 32bit stackleak stack_left test present in grsec only, as spotted</font><br>
<font class="QuotedText">&gt;    by Tycho Andersen</font><br>
<p>
Oh, Brad, come on! Tycho is my good friend, he supports my upstreaming efforts very<br>
much, I always praise his work. Yes, he was the first who spotted your mistake with '~':<br>
<a href="https://www.openwall.com/lists/kernel-hardening/2017/08/15/1">https://www.openwall.com/lists/kernel-hardening/2017/08/15/1</a><br>
<p>
And then later I've investigated the recursive BUG() trouble caused by this check and finally<br>
dropped it in v6:<br>
<a href="https://www.openwall.com/lists/kernel-hardening/2017/12/05/18">https://www.openwall.com/lists/kernel-hardening/2017/12/0...</a><br>
<p>
<p>
<font class="QuotedText">&gt; This test however doesn't have to do with PAX_STACKLEAK as mentioned there -- you can look</font><br>
<font class="QuotedText">&gt; at any PaX patch and see that the test doesn't exist.  What the check in grsecurity (tried) to do was</font><br>
<font class="QuotedText">&gt; piggy-back off being called in useful places throughout the entire kernel and in the lack of</font><br>
<font class="QuotedText">&gt; KSTACKOVERFLOW wanted to avoid a recursion-based stack overflow from being able to cleanly</font><br>
<font class="QuotedText">&gt; overwrite its intended target.  In fact, the same day I made the above change I added an #ifndef</font><br>
<font class="QuotedText">&gt; to make this explicit:</font><br>
<font class="QuotedText">&gt; commit 16e1332faabc9f270fde9787ddb23e95cb2aad9c</font><br>
<font class="QuotedText">&gt; Author: Brad Spengler &lt;spender@grsecurity.net&gt;</font><br>
<font class="QuotedText">&gt; Date:   Tue Aug 15 07:16:30 2017 -0400</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    Make 32bit stack_left check depend on !KSTACKOVERFLOW to improve performance a bit</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt; So it is correct that there was a bug in the check I added that caused it to be a no-op, but it's</font><br>
<font class="QuotedText">&gt; not part of the STACKLEAK defense and I don't believe we ever advertised that particular added check.</font><br>
<p>
Ok, I see. I know that it is your code, not PaX Team's.<br>
<p>
But I didn't know that it is NOT a part of STACKLEAK feature. That's because all we have<br>
is a single giant grsecurity patch and NOT the git history which you quote here.<br>
N.B. I don't blame you.<br>
<p>
<p>
<font class="QuotedText">&gt; A further claim was "STACKLEAK was missing PLACES where the stack needed erasing" (emphasis mine).</font><br>
<font class="QuotedText">&gt; Alex identified one location in ret_from_fork which in our 4.9 patch was missing instrumentation</font><br>
<font class="QuotedText">&gt; for x86_32.  This instrumentation wasn't missing in the original STACKLEAK code, nor in our stable</font><br>
<font class="QuotedText">&gt; patches for 3.2 or 3.14.  Alex is free to verify this as we have done.  It was introduced during</font><br>
<font class="QuotedText">&gt; some upstream churn in the entry code via the following commit:</font><br>
<font class="QuotedText">&gt; commit 39e8701f33d65c7f51d749a5d12a1379065e0926</font><br>
<font class="QuotedText">&gt; Author: Andy Lutomirski &lt;luto@kernel.org&gt;</font><br>
<font class="QuotedText">&gt; Date:   Mon Oct 5 17:48:13 2015 -0700</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt;    x86/entry/32: Open-code return tracking from fork and kthreads</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt; This open-coding changed ret_from_fork from following a path that would perform the stack clearing</font><br>
<font class="QuotedText">&gt; to one that would not, and since we didn't have any comment-based guards in place there, it slipped</font><br>
<font class="QuotedText">&gt; our notice.  As mentioned, this only affected i386, and would be rendered benign by having</font><br>
<font class="QuotedText">&gt; RANDKSTACK enabled (as it is by default in autoconfig) which would clear the full stack on entry to</font><br>
<font class="QuotedText">&gt; the following syscall (as the lowest_stack field is set to the end of the stack for the new</font><br>
<font class="QuotedText">&gt; process).  Further, the newly-created process' stack would already be cleared in the presence of</font><br>
<font class="QuotedText">&gt; CONFIG_DEBUG_STACK_USAGE or in any kernel with commit e01e80634ecdde1dd113ac43b3adad21b47f3957</font><br>
<font class="QuotedText">&gt; "fork: unconditionally clear stack on fork".  Further, it is likely (possibly guaranteed, I'd have</font><br>
<font class="QuotedText">&gt; to confirm this) that the presence of PAX_MEMORY_SANITIZE (which would be auto-enabled in every</font><br>
<font class="QuotedText">&gt; instance where STACKLEAK was auto-enabled) would ensure the newly-allocated stack would be cleared</font><br>
<font class="QuotedText">&gt; with the SANITIZE poison value.</font><br>
<p>
Ok, so it's evil Andy Lutomirski who has broken your patch :)<br>
Ok, it's not security relevant, that is good.<br>
<p>
<p>
<font class="QuotedText">&gt; There was no other location identified by Alex (and I went ahead and confirmed with v14 that no</font><br>
<font class="QuotedText">&gt; other location has been identified), so the claim that "places" (a plural) were missing</font><br>
<font class="QuotedText">&gt; instrumentation is false.</font><br>
<p>
Oh, I'm sorry for 'PLACES', it's definitely my fault...<br>
In v6 I added two missing erase_kstack() calls:<br>
<a href="https://www.openwall.com/lists/kernel-hardening/2017/12/05/18">https://www.openwall.com/lists/kernel-hardening/2017/12/0...</a><br>
But later one of them turned out to be surplus (kudos to Dmitry V. Levin).<br>
<p>
So let me sum up:<br>
 - it is not your mistake, it is evil upstream which has broken your patch :)<br>
 - there was only ONE erase_kstack() missing, which I fixed.<br>
<p>
<p>
<font class="QuotedText">&gt; Regarding errors in the alloca() checking, Alex's claims there are false.  get_stack_info didn't</font><br>
<font class="QuotedText">&gt; exist when STACKLEAK was first written, but when it was introduced we did convert to using it.</font><br>
<font class="QuotedText">&gt; We don't needlessly duplicate functionality of get_stack_info, we only have some additional code</font><br>
<font class="QuotedText">&gt; for correctly computing the amount of stack space left, and our checks there are correct.</font><br>
<p>
Hm... Let's compare the code. That's funny to do it here and not at LKML.<br>
<p>
Here is my version (ouch, lwn breaks the identation):<br>
<p>
+void __used stackleak_check_alloca(unsigned long size)<br>
+{<br>
+        unsigned long sp = (unsigned long)&amp;sp;<br>
+	struct stack_info stack_info = {0};<br>
+	unsigned long visit_mask = 0;<br>
+	unsigned long stack_left;<br>
+<br>
+	BUG_ON(get_stack_info(&amp;sp, current, &amp;stack_info, &amp;visit_mask));<br>
+<br>
+	stack_left = sp - (unsigned long)stack_info.begin;<br>
+<br>
+	if (size &gt;= stack_left) {<br>
+		/*<br>
+		 * Kernel stack depth overflow is detected, let's report that.<br>
+		 * If CONFIG_VMAP_STACK is enabled, we can safely use BUG().<br>
+		 * If CONFIG_VMAP_STACK is disabled, BUG() handling can corrupt<br>
+		 * the neighbour memory. CONFIG_SCHED_STACK_END_CHECK calls<br>
+		 * panic() in a similar situation, so let's do the same if that<br>
+		 * option is on. Otherwise just use BUG() and hope for the best.<br>
+		 */<br>
+#if !defined(CONFIG_VMAP_STACK) &amp;&amp; defined(CONFIG_SCHED_STACK_END_CHECK)<br>
+		panic("alloca() over the kernel stack boundary\n");<br>
+#else<br>
+		BUG();<br>
+#endif<br>
+	}<br>
+}<br>
<p>
And here is grsecurity code for x86_64 from the last public patch (there is a<br>
separate implementation for x86_32):<br>
<p>
+void __used pax_check_alloca(unsigned long size)<br>
+{<br>
+	struct stack_info stack_info = {0};<br>
+	unsigned long visit_mask = 0;<br>
+	unsigned long sp = (unsigned long)&amp;sp;<br>
+	unsigned long stack_left;<br>
+<br>
+	BUG_ON(get_stack_info(&amp;sp, current, &amp;stack_info, &amp;visit_mask));<br>
+<br>
+	switch (stack_info.type) {<br>
+	case STACK_TYPE_TASK:<br>
+		stack_left = sp &amp; (THREAD_SIZE - 1);<br>
+		break;<br>
+<br>
+	case STACK_TYPE_IRQ:<br>
+		stack_left = sp &amp; (IRQ_STACK_SIZE - 1);<br>
+		break;<br>
+<br>
+	case STACK_TYPE_EXCEPTION ... STACK_TYPE_EXCEPTION_LAST:<br>
+		stack_left = sp &amp; (EXCEPTION_STKSZ - 1);<br>
+		break;<br>
+<br>
+	case STACK_TYPE_SOFTIRQ:<br>
+	default:<br>
+		BUG();<br>
+	}<br>
+<br>
+	BUG_ON(stack_left &lt; 256 || size &gt;= stack_left - 256);<br>
+}<br>
<p>
First, I think there is no reason for this 'switch', since get_stack_info() calculates<br>
the stack size itself, so we can simply do:<br>
+	stack_left = sp - (unsigned long)stack_info.begin;<br>
<p>
Moreover, I have previously stated that different exception stacks have different<br>
size at x86_64. All of them are 4K, except the debug stack which is 8K:<br>
static unsigned long exception_stack_sizes[N_EXCEPTION_STACKS] = {<br>
	[0 ... N_EXCEPTION_STACKS - 1]		= EXCEPTION_STKSZ,<br>
	[DEBUG_STACK - 1]			= DEBUG_STKSZ<br>
};<br>
<p>
Maybe it's not critical for alloca check... Anyway, I prefer to rely on get_stack_info()<br>
to follow "Don't Repeat Yourself" rule. And if it changes, we don't have to patch<br>
check_alloca().<br>
<p>
<p>
Now the second difference: grsecurity code uses this '256' magic value in BUG_ON().<br>
<p>
Mark Rutland and I had a long discussion about it in this thread:<br>
<a href="http://openwall.com/lists/kernel-hardening/2018/05/11/12">http://openwall.com/lists/kernel-hardening/2018/05/11/12</a><br>
<p>
I think that this '256' is useless here, since we don't know how much of stack space<br>
the BUG_ON() handling consumes. So it can overflow these 256 bytes and corrupt the<br>
neighbour memory.<br>
<p>
And here is our solution:<br>
<p>
+	if (size &gt;= stack_left) {<br>
+		/*<br>
+		 * Kernel stack depth overflow is detected, let's report that.<br>
+		 * If CONFIG_VMAP_STACK is enabled, we can safely use BUG().<br>
+		 * If CONFIG_VMAP_STACK is disabled, BUG() handling can corrupt<br>
+		 * the neighbour memory. CONFIG_SCHED_STACK_END_CHECK calls<br>
+		 * panic() in a similar situation, so let's do the same if that<br>
+		 * option is on. Otherwise just use BUG() and hope for the best.<br>
+		 */<br>
+#if !defined(CONFIG_VMAP_STACK) &amp;&amp; defined(CONFIG_SCHED_STACK_END_CHECK)<br>
+		panic("alloca() over the kernel stack boundary\n");<br>
+#else<br>
+		BUG();<br>
+#endif<br>
<p>
<p>
At the same time I see one tricky aspect in my code.<br>
We don't know in which order the compiler puts the local variables on the stack.<br>
So calculating the stack pointer with this:<br>
+	unsigned long sp = (unsigned long)&amp;sp;<br>
can make alloca size check incorrect (but 256 magic value mitigates that).<br>
<p>
If one day I will come up with the "check_alloca() add-on" to my v15, I will use<br>
'current_stack_pointer' instead to avoid that aspect.<br>
<p>
<font class="QuotedText">&gt; If Alex would like us to explain to him how his change there is incorrect and our checks are correct,</font><br>
<p>
Brad, you perfectly know all my arguments, I've already posted them at LKML,<br>
and I always put you in CC. My development process is completely open.<br>
<p>
<font class="QuotedText">&gt; I'd be happy to explain it in full provided he agree to donate $1000 to a charity of my choosing.</font><br>
<font class="QuotedText">&gt; Now that I've stated he's wrong, he's able to either figure out the reason on his own and correct</font><br>
<font class="QuotedText">&gt; his statement publicly, or if he's so certain he's correct, has nothing to lose by entering</font><br>
<font class="QuotedText">&gt; into this challenge.  In the case that we're wrong (not possible as we re-confirmed it prior to</font><br>
<font class="QuotedText">&gt; writing this), I'll be happy to admit defeat and donate $1000 to charity, providing full proof to</font><br>
<font class="QuotedText">&gt; the public and correcting this statement.</font><br>
<p>
Huh. Organizing such a bet to donate money to charity?<br>
We do it on a regular basis without such bets. I'm sure, Grsecurity is a company with<br>
social responsibility, which regularly donates to charity, doesn't it?<br>
<p>
Anyway, let me thank you once again for all the information that you've already shared with us.<br>
All my arguments and patches are open, feel free to use them for your version of STACKLEAK.<br>
<p>
By the way, you keep silence about my fixes in the gcc plugin... Didn't you apply them?<br>
<p>
<font class="QuotedText">&gt; So to sum up:</font><br>
<font class="QuotedText">&gt; Yes there was a bug in an added check in grsecurity that depended on STACKLEAK being enabled, but</font><br>
<font class="QuotedText">&gt; which wasn't advertised and wasn't part of the STACKLEAK defense.  This was found by Tycho</font><br>
<font class="QuotedText">&gt; Andersen, not Alex, and credited properly in our changelogs.</font><br>
<p>
You are absolutely right. I should only add that your check also causes the recursive BUG()<br>
which corrupts the memory below the stack bottom or hits the guard page.<br>
<p>
<font class="QuotedText">&gt; Yes, in some newer versions of grsecurity (after the commit mentioned above) we were missing</font><br>
<font class="QuotedText">&gt; explicit STACKLEAK clearing in returning from fork on i386 in a newly-forked process.  Due to the</font><br>
<font class="QuotedText">&gt; other factors mentioned above, this likely had 0 real-life impact.</font><br>
<p>
I absolutely agree. I've fixed this SINGLE flaw.<br>
<p>
<font class="QuotedText">&gt; No, our alloca() tests aren't wrong and don't needlessly duplicate code.  We have made a public</font><br>
<font class="QuotedText">&gt; offer to donate $1000 to charity if we're wrong on this point (with us offering to provide all the</font><br>
<font class="QuotedText">&gt; details to easily determine the truth of the statement) provided that Alex agrees to the same</font><br>
<font class="QuotedText">&gt; terms, as we won't do the KSPP's work for free.</font><br>
<p>
Sorry Brad, I don't like this idea. I'm not going to donate to charity because of such a bet.<br>
I've already described all my technical arguments above.<br>
But I'm also not going to force you "do the KSPP's work for free".<br>
<p>
I sincerely thank you for such an interesting discussion!<br>
Maybe later I will post the link or digest to LKML, since discussing Linux kernel patches<br>
in twitter-lwn-something doesn't work well.<br>
<p>
Best regards,<br>
Alexander<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor765055"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2018 15:31 UTC (Mon)
                               by <b>shemminger</b> (subscriber, #5739)
                              [<a href="/Articles/765055/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is great technical feedback. And it is why security fixes should be done in the open on mailing lists instead of flame wars and twitter storms.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/765055/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789524"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2019 15:27 UTC (Mon)
                               by <b>a13xp0p0v</b> (guest, #118926)
                              [<a href="/Articles/789524/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
[resurrecting an old thread]<br>
<p>
<font class="QuotedText">&gt; Moreover, I have previously stated that different exception stacks have different</font><br>
<font class="QuotedText">&gt; size at x86_64. All of them are 4K, except the debug stack which is 8K:</font><br>
<font class="QuotedText">&gt; static unsigned long exception_stack_sizes[N_EXCEPTION_STACKS] = {</font><br>
<font class="QuotedText">&gt; [0 ... N_EXCEPTION_STACKS - 1] = EXCEPTION_STKSZ,</font><br>
<font class="QuotedText">&gt; [DEBUG_STACK - 1] = DEBUG_STKSZ</font><br>
<font class="QuotedText">&gt; };</font><br>
<p>
This particular statement was wrong - my mistake!<br>
Brad has revealed (thanks to him) why calculating the stack size from grsecurity was correct:<br>
"The debug IST stack is actually two separate debug stacks to handle #DB recursion"<br>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git/commit/?id=2a594d4ccf3f10f80b77d71bd3dad10813ac0137">https://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.g...</a><br>
Great!<br>
<p>
I will *not* make a patch for the upstream kernel since alloca() checking didn't get to the mainline - <br>
all VLA (Variable Length Arrays) should be removed instead.<br>
<p>
Best regards,<br>
Alexander<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789524/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor764738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 17:43 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/764738/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I normally do not care about Linus' behavior, but this really starts to cross the line: <a href="https://lkml.org/lkml/2018/8/15/510">https://lkml.org/lkml/2018/8/15/510</a><br>
<p>
No. The correct reply here would not be:<br>
<font class="QuotedText">&gt; "Is there someone else up there we can talk to?"</font><br>
<p>
It would be an apology with a reference to Monty Python to explain it. And thinking the next time that in some cultures "your mom" jokes are especially EXTREMELY offensive. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764742"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 18:34 UTC (Thu)
                               by <b>patrick_g</b> (subscriber, #44470)
                              [<a href="/Articles/764742/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;in some cultures "your mom" jokes are especially EXTREMELY offensive. </font><br>
<p>
Problem is you'll always find a culture in which a specific referential joke is offensive. <br>
The only realistic solution is to accept jokes depending on the work environment and sub-culture you are in. And Monty Python references/jokes are an important part of the hacker culture so I don't see Linus' mail crossing the line.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764742/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764743"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 18:41 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/764743/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn't matter. In this case one person clearly indicated that Linus had crossed the line. The correct answer here is to apologize and maybe try to explain yourself.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764743/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764746"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 18:56 UTC (Thu)
                               by <b>patrick_g</b> (subscriber, #44470)
                              [<a href="/Articles/764746/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The correct answer here is to apologize and maybe try to explain yourself.</font><br>
<p>
IMHO Linus tried to explain the joke because he wrote : "just google for it if you haven't seen the Holy Grail".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764746/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor764755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 13, 2018 21:33 UTC (Thu)
                               by <b>GennaroReinger</b> (guest, #127208)
                              [<a href="/Articles/764755/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The thing is he wasn't chatting with his buddies while drinking in the pub. He was communicating with people which have only professional relationship with him. Some of them may don't even know (in-person) or like him.<br>
<p>
It also tells something that those "jokes" and other rude comments are traveling only the one way.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2018 17:29 UTC (Fri)
                               by <b>hkario</b> (subscriber, #94864)
                              [<a href="/Articles/764845/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
you could look at it the other way, as Linus degrading himself and putting the person "attacked" as the King Arthur while himself as the french buffoon that won't let the king to enter for entirely petty reasons<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor764866"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2018 15:14 UTC (Sat)
                               by <b>nilsmeyer</b> (guest, #122604)
                              [<a href="/Articles/764866/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thus offending the French ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764866/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor764860"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to get STACKLEAK into the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2018 8:25 UTC (Sat)
                               by <b>meyert</b> (subscriber, #32097)
                              [<a href="/Articles/764860/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
👏 for your work mr. Poppov! please keep on pushing this to the mainline kernel!<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/764860/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
