        <!DOCTYPE html>
        <html lang="en">
        <head><title>Ext4 encryption [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/639427/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/638985/">Return to the Security page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/639427/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Ext4 encryption</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 8, 2015</br>
           </div>
For reasons that should be reasonably obvious, there is an increasing level
of awareness of the wisdom of encrypting sensitive data stored on devices —
especially on devices that, like a phone handset, are easily stolen or
lost.  In current kernels, encrypting a filesystem requires the use of an
add-on module like <a href="/Articles/156921/">eCryptfs</a> or <a
href="http://en.wikipedia.org/wiki/Dm-crypt">dm-crypt</a>.  These modules
work, but they can have an adverse effect on filesystem performance as a
result of the way they are implemented.  Performance is important;
problems in this area are widely cited as the reason for Google's decision
to back off from its plan to encrypt filesystems by default in the Android
"Lollipop" release.  Linux might be able to provide a filesystem with better
performance if encryption were built into the filesystem itself, but,
currently, not even Btrfs has encryption as an option.
<p>
Change is afoot, however; it takes the form of <a
href="/Articles/639262/">a set of patches adding encryption to the ext4
filesystem</a>.  They were posted by ext4 maintainer Ted Ts'o, but the lead
developer behind the work is Michael Halcrow — the same developer who added
eCryptfs to the kernel ten years ago.  The ext4 work, though, reflects some
of the lessons that have been learned in the meantime.
<p>
Performance suffers in eCryptfs as a result of the stacked nature of the
filesystem.  Imagine a system running eCryptfs over ext4 now; if a process
wants to read a page from an encrypted file, eCryptfs must first instruct
ext4 to read that page into the page cache.  It then decrypts the data —
into another page-cache page.  The extra copies of the data can consume a
lot of memory and slow things down unnecessarily.
Putting encryption support directly into ext4 can eliminate much of that
waste.  
<p>
Encryption in ext4 is a per-directory-tree affair.  One starts by setting
an encryption policy (using an <tt>ioctl()</tt> call) for a given
directory, which must be empty at the 
time; that policy includes a master key used for all files and directories
stored below the target directory.  Each individual file
is encrypted with its own key, which is derived from the master key and a
per-file random nonce value (which is stored in an extended attribute
attached to the file's inode).  File names and symbolic links are also
encrypted. 
<p>

The keys used by processes to access the encrypted directory tree are
stored in the kernel's keyring as "logon" keys, meaning that user space can
create them, but it is not allowed to read the value of the keys.  (The
kernel's key-management functionality is beyond the scope of this article;
see <a
href="/Articles/639523/"><tt>Documentation/security/keys.txt</tt></a> for
an overview of how it works).
If a user-space process has the requisite master key in its per-process
keyring, it can access an encrypted directory as usual.  In the absence
of the key, though, things are different.  Directories can still be read
(if the normal permissions and security module policy allow, of course),
but the file names will all be encrypted, so the result may not be
particularly satisfying.  It will be possible to determine how many files
are in the directory, their sizes, and their permissions, but not their
names or contents.  Attempts to open a file (for read or write) without
access to the 
key will simply fail.  It is still possible to delete encrypted files,
though, if the permissions allow.
<p>
If a process with access to the appropriate key reads a page from a file,
the filesystem code starts by allocating a separate bounce buffer.  The
encrypted data is read into the buffer, then decrypted into the page
cache.  Writes work similarly: the page being written is read from
persistent storage and decrypted
if necessary; then the new data is written, the data is encrypted into a bounce
buffer, and written to permanent storage.  Some extra memory is used during
the actual encryption and decryption operations, but then it is immediately
returned to the system, so overall memory use is significantly reduced
relative to eCryptfs or dm-crypt.
<p>
Keeping the plain text of an encrypted file in memory has some obvious
risks associated with it; if an attacker can get at that memory, all of the
work put into encrypting the file on disk is for nothing.  To an extent
that risk just has to be accepted; the developers are not attempting to
make a system that is resistant to attacks when it is hibernated, for
example.  Still, efforts have been made to clear plain-text data out of
memory when it is no longer needed in an attempt to mitigate that risk
somewhat.  The developers note, though, that if an attacker can make
changes to an encrypted filesystem that is subsequently mounted by the
user, all bets are off.  So ext4 encryption can protect a lost or stolen
device, but protecting a device that has been covertly modified is beyond
its threat model.
<p>
The code currently uses AES-256-XTS as the encryption algorithm for file
contents, while AES-256-CBC+CTS is used for file names.  The code is designed
with the idea that, at some point, it will be desirable to change to a
different encryption scheme; care has been taken to avoid wiring the
specific algorithm too deeply into the filesystem.
<p>
While Google prefers ext4 as the filesystem to
use on Android systems, not all Android devices use it.  So it is worth
noting that Ted has been talking with the maintainer of the F2FS
flash-oriented filesystem to get the same <tt>ioctl()</tt> interfaces
implemented there.  That would allow Android systems to use encrypted
storage on either filesystem without the need for any filesystem-specific
code.
<p>
This code is marked as experimental in the current patch set, but it may
not stay that way for long.  There is already user-space code to make use
of this feature in the Android open-source repository, and, according to
Ted, it will be included in the next major Android release.  As of this
writing, it has also found its way into linux-next, suggesting that it is
intended for the 4.1 merge window.  Some developers <a
href="/Articles/639433/">think that may be premature</a>, though, since the
code has just now surfaced.  Filesystem changes in general merit a high
level of review, given the severe consequences of getting something wrong
at that level of the system.  Security-relevant code needs even more
review, of course.  Until that review has happened, developers may well
feel nervous about shipping these particular changes in a mainline kernel
release.
<p>
This obstacle will likely be overcome before too long; at that point Linux
will have native encryption support in a major filesystem for the first
time.  In a period where many people are concerned about the security of
their data, that can only be a good thing.
<p>
(See <a
href="https://docs.google.com/document/d/1ft26lUQyuSpiu6VleP70_npaWdRfXFoNnB8JYnykNTg">this
document</a> for some more information on the design of the ext4 encryption
mechanism).<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ext4">Filesystems/ext4</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Filesystem_encryption">Security/Filesystem encryption</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Encryption-Filesystems">Encryption/Filesystems</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/639427/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor639686"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 7:07 UTC (Thu)
                               by <b>bunch</b> (subscriber, #18522)
                              [<a href="/Articles/639686/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even if I see why eCryptfs would increase memory usage, I don't see why using dm-crypt would have worst performances than Ext4 encryption.<br>
<p>
Since blocks are deciphered before hitting the FS layer, it could use the same mechanism (temporary disk buffers) as Ext4 encryption.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639686/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 12:44 UTC (Thu)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/639724/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is it a matter of which pages are used for the decryption?  If, say, an internal buffer is used in one method while a mapped page is used in the other, the internal buffer could be a bottleneck requiring a lock, while the mapped page may cause a dirty page to be flushed.<br>
<p>
I am just brainstorming, no idea of what I am talking about.  Please be gentle :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor639736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 13:41 UTC (Thu)
                               by <b>msnitzer</b> (subscriber, #57232)
                              [<a href="/Articles/639736/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As the primary DM maintainer I've yet to see a single report about dm-crypt performance being a pain point for android.  Yet ext4 developers have gotten to a point where AOSP changes were introduced to use their newly crafted encryption support.  Amazing really.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 15:49 UTC (Thu)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/639780/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <p>Are you suggesting that the Android folks ignored your (presumably serviceable and efficient) DM-Crypt code and decided to write their own?</p>

<p>I'm not trying to ruffle feathers here; I'm sincerely curious why a community of developers would go out and re-invent the wheel.  Kinda like how we're up to <a href="http://www.99-bottles-of-beer.net/">1500 programming languages</a>&mdash;because whoever wrote the Nth programming language did so because the other N-1 were &quot;broken&quot;. Sigh.</p>

<p>Or...</p>

<p>&lt;CONSPIRACY THEORY&gt;Your DM code <i>lacks</i> a back door.&lt;/CONSPIRACY THEORY&gt; (hint, hint!)</p>

<p>Perhaps I'm comparing apples and oranges with the programming languages analogy, but my jaded attitude towards the plethora of languages is real.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/639780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 16:08 UTC (Thu)
                               by <b>msnitzer</b> (subscriber, #57232)
                              [<a href="/Articles/639786/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I really have no idea.  Filesystems yielding functionality to block devices tends to make filesystem developers uneasy (any excuse to avoid it).  Fosters NIH syndrome.  But to be fair, there are efficiencies to be had with a filesystem natively providing functionality.  Same efficiencies can be had with fs+block integration but it takes more work/coordination that is less comfortable for filesystem developers.<br>
<p>
I'm not convinced there isn't a way to make dm-crypt work perfectly well for andoid's needs -- but that is purely my naive position considering I'm uninformed about their motivations/requirements.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor645598"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2015 9:59 UTC (Fri)
                               by <b>xnox</b> (guest, #63320)
                              [<a href="/Articles/645598/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="http://nelenkov.blogspot.ru/2012/07/using-app-encryption-in-jelly-bean.html">http://nelenkov.blogspot.ru/2012/07/using-app-encryption-...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/645598/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor645993"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2015 5:37 UTC (Wed)
                               by <b>geofft</b> (subscriber, #59789)
                              [<a href="/Articles/645993/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
dm-crypt is block-level encryption, not filesystem-level encryption. This means that you cannot add any bytes in the process of encrypting it. This means that your encryption is not authenticated, and unauthenticated encryption is generally a major mistake.<br>
<p>
dm-crypt is very good at what it does, but what it does is necessarily incomplete by the nature of the problem. There are (limited) use cases for unauthenticated disk encryption, and dm-crypt is great for those, but if you can do authenticated encryption, you should. It's sorta like unsalted, unstretched passwords: SHA-512 is a fantastic hash function, but using it as a password storage scheme makes for a bad password storage scheme.<br>
<p>
I see your conspiracy theory and raise you "The NSA is sending shills into comment sections to complain about people writing good cryptosystems instead of reusing the bad cryptosystems they already know how to break."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/645993/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor646097"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2015 16:10 UTC (Wed)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/646097/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can think of a more mundane explanation: Android devices have all the software necessary to flip dm-crypt usage on/off in-place, but lack the hardware (battery capacity) to do it safely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/646097/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor648968"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 22, 2015 17:09 UTC (Mon)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/648968/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be straightforward to do it in place in a resumable fashion using a mix of dm-crypt, dm-linear, and whatever the dm target that delays IO is.  All you'd need to do is have a little bit of spare space and some user code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/648968/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor646140"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2015 18:26 UTC (Wed)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/646140/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; dm-crypt is block-level encryption, not filesystem-level encryption. This means that you cannot add any bytes in the process of encrypting it. This means that your encryption is not authenticated, and unauthenticated encryption is generally a major mistake.</font><br>
<p>
Ext4's new encryption mode, as described, is equally unauthenticated -- it is not designed to be resilient against covert modifications to the ciphertext.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/646140/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor640002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 21:57 UTC (Fri)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/640002/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mike, as you suggest, I don't expect we'll be able to realize a significant performance boost for raw unauthenticated (XTS) encryption by doing it in ext4 rather than the block layer.<br>
<p>
Down the road, I do think we'll be able to implement authenticated encryption more easily than a dm layer mechanism will, because we've got existing transactional facilities to give us consistency between the crypto metadata and the ciphertext, and we expect to get per-block metadata support from Mingming when it's ready. I've got a roadmap for that, but we're taking this one step at a time and doing unauthenticated crypto first.<br>
<p>
Once we start talking about managing additional per-block metadata with transactional semantics, we're pretty far into "file system" territory. With that extra data, we'll need to make some decisions around I/O patterns, memory usage, and so forth. The file system is the best place to manage that sort of complexity.<br>
<p>
If you've got a single-user laptop that's subject to being left in a taxi, FDE like dm-crypt makes a lot of sense.<br>
<p>
If it's more complicated than the single-user laptop story, you often need to jump through hoops to make it work with FDE. Pushing a key into the keyring and setting a policy on a directory for an existing file system vastly simplifies many scenarios. Multi-user environments such as Android, Chrome OS, and Cloud servers are targets for encryption that can be selectively enabled and managed on shared live mounted file systems with multiple users.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 12, 2015 5:46 UTC (Sun)
                               by <b>hobarrera</b> (guest, #101888)
                              [<a href="/Articles/640052/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From what I can well, these changes allow per-directory-tree keys/passwords. Can dm-crypt do that? Maybe the Android folks needed/wanted that for some reason or another (I can't guess why, though).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2015 17:38 UTC (Tue)
                               by <b>chloe_zen</b> (guest, #8258)
                              [<a href="/Articles/640298/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One of the weaknesses of full-disk encryption is that once any user logs in the whole disk is effectively in plaintext; all an attacker needs is privilege escalation.  Directory tree encryption is *the* killer feature here.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor649506"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2015 12:44 UTC (Fri)
                               by <b>yoshi314</b> (guest, #36190)
                              [<a href="/Articles/649506/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
separate encryption per each user-profile, that's one use case i am thinking about. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/649506/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor648963"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 22, 2015 16:18 UTC (Mon)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/648963/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh!<br>
<p>
Now that’s… puzzling.<br>
<p>
They have different use cases of course: a per-file nonce instead of a per-block nonce, and differing keys, which is kinda neat, but I’d actually expect dmcrypt to perform *better*.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/648963/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor639825"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 18:25 UTC (Thu)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/639825/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree. I don't understand why dm-crypt and ecryptfs are lumped together in the article, neither what the use case of only encrypting file name and contents is. Is it for unauthenticated users to be able to delete files?<br>
<p>
Corbet's articles are usually much more enlightening. How about a follow up article, with a little more details?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639825/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 22:00 UTC (Fri)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/640005/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is for users without the key to be able to delete files. In one scenario, the Chromium OS user cache management system needs to be able to delete other users' cache files while they aren't logged in. That's why they're using eCryptfs for the user cache right now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor640051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 12, 2015 5:45 UTC (Sun)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/640051/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, this article is missing a few bits of context.<br>
<p>
There are two major advantages of doing encryption in at the file system level.<br>
<p>
1)  We don't have to worry about encrypted and unencrypted pages hanging around in the page cache.   We do need to use bounce pages on the writepage path, but they get released right after the I/O is complete.  This is a bit harder to handle with ecryptfs because it uses a stacking file system paradigm.<br>
<p>
2)  We can use multiple keys so that each user and/or work profile can be encrypted with a single key.   This is something you can't do with dm-crypt, and it's important if you want to be able to flexibly share space between multiple users who are mutually suspicious with each other.   In the chrome OS case, the user who is logged in can send a request to a root daemon for more disk space (if free disk space is running low), and the root daemon can delete files from that cache directory of some other user who is currently not logged in.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor639702"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 8:27 UTC (Thu)
                               by <b>meskio</b> (guest, #100774)
                              [<a href="/Articles/639702/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nice to see encryption as part of the filesystem itself. But I'm worry to see that it leaks sizes and hierarchy of files, in some cases this might be as bad as leaking the content of the files. We'll need to keep relying in dm-crypt for full disk encryption.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639702/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 22:15 UTC (Thu)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/639848/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I didn't catch whether or not it encrypts xattrs.  I also missed a bit about modification of the encrypted data.  Are they not using MACs to ensure the data hasn't been changed?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640006"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 22:04 UTC (Fri)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/640006/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Encryption with authentication should happen and is on my road map. But it's also hard to get right, and we don't have the facilities in place yet to give us per-block metadata with transactional semantics. I think we'll have it before too long though. Jonathan was careful to discuss the adversarial model in his writeup, and that's important to keep in mind when making a decision about whether or how to use this feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640006/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640040"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 11, 2015 16:30 UTC (Sat)
                               by <b>Trou.fr</b> (subscriber, #26289)
                              [<a href="/Articles/640040/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, thank you for the update. I must admit I don't really see much to gain by using ext4 encryption vs dm-crypt if you don't get authentication.<br>
<p>
I really look forward for a version with auth, it would be quite useful for homedirs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640040/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor754966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2018 11:23 UTC (Sun)
                               by <b>e4crypt</b> (guest, #124524)
                              [<a href="/Articles/754966/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>I didn't catch whether or not it encrypts xattrs.</blockquote>
<p>It doesn't. Extended attributes are plain-text. Even if there is no key in the keyring and the file contents are not accessible, everyone can still read xattrs.
<p>This is a major security hole on personal devices. Some very popular applications set extended attributes on files (even though mostly this information remains untouched). The most notable culprits are: Chrome/chromium and Wget.
<pre>
# truncate -s 2G storage
# mkfs.ext4 storage
# tune2fs -O encrypt storage
# mkdir mountpoint
# mount storage mountpoint
# cd mountpoint
# mkdir protected
# e4crypt add_key protected
# cd protected
# wget https://static.lwn.net/images/logo/barepenguin-70.png
# getfattr -d barepenguin-70.png
&gt; # file: barepenguin-70.png
&gt; user.xdg.origin.url="https://static.lwn.net/images/logo/barepenguin-70.png"
# cd ../..
# umount mountpoint
# e4crypt new_session
# mount storage mountpoint
# getfattr -d mountpoint/protected/w6W9jZ+I2d62uybxftwuHt4,M3N
&gt; # file: mountpoint/protected/w6W9jZ+I2d62uybxftwuHt4,M3N
&gt; user.xdg.origin.url="https://static.lwn.net/images/logo/barepenguin-70.png"
</pre>
<p>To protect against such an obvious leak, I suggest the following workaround. Obviously, it could be much better if extended attributes were stored encrypted along with file contents.
<p>Mount a filesystem with an option "nouser_xattr" set. This will protect against "accidental" setting of extended attributes by applications. Note the downside of this approach: the option can only be set per mountpoint, meaning that user extended attributes will be disabled across the filesystem, not only in protected paths.
<pre>
# mount -o nouser_xattr storage mountpoint
</pre>
<p>But for the time being, ext4 filesystem encryption support seems to be more well-suited to protect mail spool directories and proprietary software on Git shared hosting. It is a bit premature to speak about desktop/end-user readiness.
<p>May 2018. Tested with kernel 4.14.40 and e2fsprogs 1.44.1.

      
          <div class="CommentReplyButton">
            <form action="/Articles/754966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor639719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 10:47 UTC (Thu)
                               by <b>Trou.fr</b> (subscriber, #26289)
                              [<a href="/Articles/639719/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am concerned that the proposal doesn't include authentication of encrypted data. Filesystems have way more flexibility than whole disk encryption scheme. While AES-GCM is not directly usable in such context, it can be adapted and used (as ZFS does : <a href="https://blogs.oracle.com/darren/entry/zfs_encryption_what_is_on">https://blogs.oracle.com/darren/entry/zfs_encryption_what...</a>) to provide authentication.<br>
<p>
Note that not authenticating data opens to pretty serious attacks : by (blindly) modifying binaries in a correct way, one can get root access to the system once booted.<br>
<p>
<p>
So I guess this proposal needs more work before the devs commit to an on-disk format with such limitations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 22:17 UTC (Thu)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/639850/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was wondering the same thing.  Encryption is good, but using encryption wrong is very bad.  It gives a false sense of security.<br>
<p>
Without using some sort of Message Authentication Code (MAC), they may as well not use encryption at all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 22:08 UTC (Fri)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/640007/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The design and Jonathan's writeup both make the adversarial model for the current incarnation of this feature clear. When facilities are in place to allow us to implement encryption with integrity reliably and efficiently, we'll be able to incorporate that into what we've already built. We shouldn't hold up the existing functionality for the existing declared adversarial model in the meantime.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor639718"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 10:51 UTC (Thu)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/639718/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the encryption is per-directory-tree I wonder how the design takes into account links to files that appear on both sides of the directory boundary. What happens when a file is moved into or out of the encrypted directory?<br>
<p>
File names have traditionally been decoupled from the actual file objects. The model is that there is a many-to-one unidirectional mapping from file names to inodes. The actual files do not know what they are called or where in the directory tree they are linked from, and can be linked from more than one place in the file system.<br>
<p>
Are we gradually getting rid of this model?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639718/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639739"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 14:03 UTC (Thu)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/639739/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe attempts to cross-encrypted-directory-tree hardlinks should be made to fail? I would also be interested to know how files being moved in/out works.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639739/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor639778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 15:41 UTC (Thu)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/639778/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If the encryption is per-directory-tree I wonder how the design takes into account links to files that appear on both sides of the directory boundary.</font><br>
<p>
In the case of symlinks, there's two encryption policies. The symlink itself has its contents (the link destination URI) encrypted, and the destination is also encrypted. If a user only has crypto access to the link source, she gets back an encrypted hash when accessing the destination. <br>
<p>
The penultimate page in the design doc (<a href="https://docs.google.com/document/d/1ft26lUQyuSpiu6VleP70_npaWdRfXFoNnB8JYnykNTg">https://docs.google.com/document/d/1ft26lUQyuSpiu6VleP70_...</a>) covers how symlinks are handled. <br>
<p>
<font class="QuotedText">&gt; What happens when a file is moved into or out of the encrypted directory?</font><br>
<p>
It is rewritten according to the crypto policy on the destination.<br>
<p>
<font class="QuotedText">&gt; Are we gradually getting rid of this model?</font><br>
<p>
No. File names and data are still separate. They're encrypted separately, even using different AES modes to provide the best crypto performance while maintaining high security for data length (CBC is faster but has some weaknesses when a single key is used for massive amounts of data, which isn't a concern with file names). <br>
<p>
I don't see any departure from how file system structures have worked in the past. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 16:09 UTC (Thu)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/639791/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
man 2 link<br>
man 2 rename<br>
then reread what you'd been replying to.  Note, BTW, that renaming an opened file is perfectly legal and should not disrupt an ongoing IO...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor639790"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 16:31 UTC (Thu)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/639790/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In the case of symlinks, there's two encryption policies. The symlink </font><br>
<font class="QuotedText">&gt; itself has its contents (the link destination URI) encrypted, and the </font><br>
<font class="QuotedText">&gt; destination is also encrypted. If a user only has crypto access to the </font><br>
<font class="QuotedText">&gt; link source, she gets back an encrypted hash when accessing the </font><br>
<font class="QuotedText">&gt; destination.</font><br>
<p>
Sigh. I should have pointed out that I meant hard links. Symlinks are not interesting.<br>
<p>
<font class="QuotedText">&gt;&gt; What happens when a file is moved into or out of the encrypted directory?</font><br>
<p>
<font class="QuotedText">&gt; It is rewritten according to the crypto policy on the destination.</font><br>
<p>
Ok, so what happens if I make a link to an encrypted file so that there exists a (hard) link to it both inside the encrypted directory and outside of it? Or if I make a (hard) link to a non-encrypted file that appears below the encrypted directory?<br>
<p>
<font class="QuotedText">&gt; I don't see any departure from how file system structures have worked in the past.</font><br>
<p>
Well, in the "good old days" files in a file system were not arranged hierarchically, but existed as a flat collection where each file was referenced by inode number. On top of that we had directories mapping names to inodes. In the really good old days a directory was not much more than a file containing records each containing an inode number and a string giving the name of the file.<br>
<p>
The same file could have several names in the same directory or any other directories within the same file system. The file object itself had no knowledge of under which name and from which directories it was referenced from. In fact, a file might not have a name at all but still exist. As long as the file is open for a process, you can delete it from all directories and still read or write to it.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639790/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640498"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 16, 2015 0:25 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/640498/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The same file could have several names in the same directory or any other directories within the same file system. </font><br>
<p>
I still make extensive use of this ...<br>
<p>
Photos on my system are generally owned by root, and in an archive directory. Then they are hard-linked into various user directories. Given that they are typically 10, 16 or 24 MP in size, that saves a LOT of space when you are storing several copies of each photo ...<br>
<p>
(not that I particularly wish to crypto-protect my photos, but other people might have similar setups to mine where they do want protection.)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640498/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor754968"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2018 12:00 UTC (Sun)
                               by <b>e4crypt</b> (guest, #124524)
                              [<a href="/Articles/754968/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>Ok, so what happens if I make a link to an encrypted file so that there exists a (hard) link to it both inside the encrypted directory and outside of it?</blockquote>
<p>The name of the link outside the protected directory will obviously remain unencrypted. The contents, however, will remain inaccessible until a correct key is in the keyring.
<pre>
# truncate -s 2G storage
# mkfs.ext4 storage
# tune2fs -O encrypt storage
# mkdir mountpoint
# mount storage mountpoint
# cd mountpoint
# mkdir protected plain-text
# e4crypt add_key protected
# cd protected
# wget https://static.lwn.net/images/logo/barepenguin-70.png
# ln barepenguin-70.png ../plain-text
# file ../plain-text/barepenguin-70.png 
&gt; ../plain-text/barepenguin-70.png: PNG image data, 70 x 81, 8-bit/color RGBA, non-interlaced
# cd ../..
# umount mountpoint
# e4crypt new_session
# mount storage mountpoint
# cd mountpoint
# file plain-text/barepenguin-70.png 
&gt; plain-text/barepenguin-70.png: writable, regular file, no read permission
# cat plain-text/barepenguin-70.png 
&gt; plain-text/barepenguin-70.png: Required key not available
</pre>
<blockquote>Or if I make a (hard) link to a non-encrypted file that appears below the encrypted directory?</blockquote>
<p>The system won't let you.
<pre>
# touch plain-text/fuck_systemd
# ln plain-text/fuck_systemd protected
&gt; ln: failed to create hard link 'protected/fuck_systemd' =&gt; 'plain-text/fuck_systemd': Operation not permitted
</pre>
<p>May 2018. Tested with kernel 4.14.40 and e2fsprogs 1.44.1.

      
          <div class="CommentReplyButton">
            <form action="/Articles/754968/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor639766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Information leaks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 14:38 UTC (Thu)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/639766/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would never rely on per-directory encryption.  Modern desktop environments would leak too much information in files outside the encrypted directory.<br>
<p>
mlocate/slocate/updatedb and other search tools<br>
global and per-application recently-used lists<br>
search history<br>
gvfs<br>
caches<br>
thumbnails<br>
trash folders<br>
swap files<br>
/tmp files<br>
etc.<br>
<p>
Even something as simple as "cat encrypted-file.txt" from a terminal could end up writing an unencrypted copy to disk:<br>
<a rel="nofollow" href="http://seclists.org/fulldisclosure/2012/Mar/32">http://seclists.org/fulldisclosure/2012/Mar/32</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639782"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Information leaks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 16:22 UTC (Thu)
                               by <b>droundy</b> (subscriber, #4559)
                              [<a href="/Articles/639782/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I expect that the per directory feature will more often be used in an effectively per user manner than to encrypt a single smaller subdirectory, and for this use case (encrypted home directories) the issues you mention are much less problematic.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639782/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640299"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Information leaks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2015 17:41 UTC (Tue)
                               by <b>chloe_zen</b> (guest, #8258)
                              [<a href="/Articles/640299/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If an encrypted directory does not encrypt the filenames, it is fail.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640299/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640326"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Information leaks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2015 1:30 UTC (Wed)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/640326/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about the number of files or directories? Think a maildir tree. Even the file size could be useful. Though this is a good first step.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640326/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Information leaks</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2015 1:48 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/640329/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, you can pad files with a small random-sized pad. But yeah, there are limits of what is practical.<br>
<p>
I don't consider the disclosure of file sizes to be a huge problem for lots of people. And you always have dm-crypt if you are really paranoid.<br>
<p>
Personally, I'm happily using eCryptfs on my self-made NAS, automatically mounted when my Mac connects to the share with the password that I store in Keychain.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor639776"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 16:19 UTC (Thu)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/639776/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Each individual file is encrypted with its own key, which is derived from the master key and a per-file random nonce value (which is stored in an extended attribute attached to the file's inode).</font><br>
<p>
I wish there was a little more discussion on this topic. It seems like an interesting choice that must be made for some specific reason. Yet, neither the article nor any of the links discuss this design choice. Is it to minimize seeking (to pull the directory master key), memory use (caching directory master key), or attempting to keep the total amount of data encrypted by a single key small? <br>
<p>
Perhaps I'm not familiar enough with other disk encryption, but I'm not aware of other products that use a similar technique. <br>
<p>
A longer discussion on key management would have been nice as well. There is mention of dealing with multiple users, so I wonder if keys will be managed more in line with LUKS, although the phrase "master key" is used quite often. In LUKS, there are up to 8 key slots that can be used to unlock the actual master key. Will there be a similar implementation where ext4 can store multiple key slots, and only the kernel gets access to the actual key? <br>
<p>
Of course that leads to more complexity. Assuming that there can be multiple passphrases to access a single master key (which of course links to multiple directory master keys and multiple file keys), is it also possible to have multiple master master master keys (the kernel keyring logon keys)? It seems necessary for any sort of complex policy. Here's an example of what I mean.<br>
<p>
3 Users -- Alice, Bob, and Eve -- are sharing a computer. Each one needs *one* and only one unique password (because password sharing is wrong) that they use to both sign into the computer and access their encrypted data. Each has their home directory encrypted, but only Alice and Bob have access to the encrypted data in /var/lib/mysql. <br>
<p>
Do the keys and passphrases work out like this?<br>
<p>
Eve: passphrase --&gt; kernel logon key (serial number 0) --&gt; /home/eve directory key --&gt; ...<br>
Alice: passphrase --&gt; kernel logon key (serial number 1) --&gt; /home/alice directory key --&gt; ...<br>
Alice: passphrase (same as above) --&gt; kernel logon key (serial number 2) --&gt; /var/lib/mysql directory key --&gt; ...<br>
Bob: passphrase --&gt; kernel logon key (serial number 2) --&gt; /home/bobdirectory key --&gt; ...<br>
Bob: passphrase (same as above) --&gt; kernel logon key (serial number 1) --&gt; /var/lib/mysql directory key --&gt; ...<br>
<p>
Basically, is there a mechanism for Bob and Alice to access the logon key #1 without sharing a password? I worry that if that's left to user space, a secure place to store the LUKS-style keyslot management data is lacking. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639776/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639826"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2015 18:41 UTC (Thu)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/639826/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another pass through the design document answered my question:<br>
<p>
<font class="QuotedText">&gt; Our present proposal allows for a single key to protect any given directory or file.</font><br>
<p>
That's incredibly disappointing, although it's not completely surprising that a feature going to Android first has such fundamental limitations. <br>
<p>
Usually "policy" means more than on/off.<br>
<p>
So you can encrypt an arbitrary assortment of your new, empty directories, but they're all going to be based off the same key. Sounds like a proof-of-concept. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639826/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640014"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 11, 2015 1:34 UTC (Sat)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/640014/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This meets requirements for Chromium OS and Android while keeping the total inode size within 256 bytes. So we don't need to spill over the default amount allocated for an inode, and we get a performance boost from being able to use what's already being read in.<br>
<p>
Based on the prevalent usage patterns I've been seeing for eCryptfs, which lets you specify one policy per mount point, this per-top-level-directory approach to policy will work fine. My initial prototype let you specify file-granular policies with fancy things like synthesizing multiple keys, but it took too much xattr space and didn't seem to address any compelling requirements.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640014/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640053"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 12, 2015 6:01 UTC (Sun)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/640053/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's fairer to say that this is a "Minimum Viable Product".  It solves a number of important use cases for Chrome OS and for Android in the near term.<br>
<p>
We've talked about in the future adding public key crypto, in which case there will be a per-inode key that would get encrypted once so that Alice's private key will be able to obtain the per-inode key, and once so that Bob's private key could obtain the per-inode key.<br>
<p>
In the initial prototype, we had this support w/o public key crypto, and it didn't add a lot of value, since it meant that at the time when you created the file, you would need to have Alice and Bob's symmetric key in memory, and for both Android and Chrome OS, an important design principle is that if a user is not logged in, their key is not available (at least not in decrypted form) anywhere on the system.<br>
<p>
The other problem is that in the initial prototype, even when you had a single per-inode key wrapped with a single user's symmetric key, the resulting size of the extended attribute, combined with the size of the SELinux policy xattr (which is a _pig_; it uses a very verbose ascii string), the resulting xattrs would require an external 4k block for each inode.  This was considered extremely unfortunate.<br>
<p>
So hence we decided to fall back to using a very compact encoding for files that were encrypted for only a single user.   In the future we'll add a version 2 on-disk structure which will allow for a file to use a per-file key encrypted by multiple users' public keys.  Public key is also a pig, so at that point you will definitely need to go to an external xattr block --- but the assumption is that the number of shared files that would need to be accessible by multiple users will be relatively small.   Or maybe we could do something by adding another layer of indirection.  We'll see.  The bottom line is that there's a pretty tight deadline for getting kernel changes in for the 'M' release, and what we have is sufficient for the use cases articulated to us by both the ChromeOS and Android teams.<br>
<p>
What might get supported in releases beyond that will be a different question, but we have plenty of time to figure that out.   Consider this the first step in a journey, not the end point.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640053/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2015 1:38 UTC (Mon)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/640073/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the detailed reply.<br>
<p>
This gets back to a question I had in another comment: What made the developers decide on the per-file protector? I can't wrap my head around what the actual goal of it is, and without a per-file protector, the size (and therefor performance) xattr considerations don't come into play. Obviously, there would still be a performance impact with multiple protectors on directories, and I'm not sure how much of a problem that would be in practice (plus the mechanism to iterate over multiple protectors to find the proper one for the user's key(s)).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640078"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2015 3:00 UTC (Mon)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/640078/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why use a separate key for each file?   There are a couple of advantages for doing things that way:<br>
<p>
1)  It makes it easier for us to later on migrate to allowing multiple users access to a file.  Example: Alice owns a file which is encrypted in a unique key which is derived from Alice's logon key plus a unique per-file nonce.   In the future, when we support public key crypto, Alice wants to allow Bob to access the file as well; so we can update the policy structure to include the per-file key encrypted using Bob's public key.  If all of the files owned by Alice are encrypted directly by Alice's logon key, we wouldn't be able to do this without decrypting and re-encrypting the file in a new unique key (since otherwise Bob would have access to all of Alice's files).<br>
<p>
2)  It simplifies the XTS Tweak Value (think IV or ESSIV value if we were using CBC mode), since we can just use the logical block number of the file as the basis for the generation of the XTS Tweak value or CBC IV value.  If all of the files are encrypted directly with the same key, we would have to do something such as include the inode number as part of the XTS Tweak  / IV value.   That in turn would break the ability to resize file systems (since sometimes the inode number could change on for some files after a resize2fs shrink operation).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640078/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor640211"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2015 23:37 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/640211/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
Or maybe we could do something by adding another layer of indirection.
</blockquote>
That's what LUKS does, but of course it has somewhere where it can store that sort of thing (the LUKS header). If you're storing everything on a per-file basis, it's harder: there's no obvious location to store stuff like intermediate keys (which is, in effect, how you'd implement multiple passphrases).

      
          <div class="CommentReplyButton">
            <form action="/Articles/640211/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor639859"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 0:14 UTC (Fri)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/639859/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If they encrypt the filename, how do they avoid the filename containing reserved bytes (i.e. null or forward slash) ? Since encrypted data is fundamentally random, it could contain either of these bytes, which would then make the file name invalid. It could also perchance contain escape sequences, etc, which could make your terminal emulator malfunction or crash. The obvious answer to this would be to encode the filename (e.g. modified Base64) - do they do this? (I had a quick look at the patch, but I'd have to read it in more detail to understand this.)<br>
<p>
There is a proposal before the Austin Group to change POSIX to ban some or all C0 control characters in filenames.  <a href="http://austingroupbugs.net/view.php?id=251">http://austingroupbugs.net/view.php?id=251</a> - who knows if this will pass (personally I like the proposal, others may disagree) - but if that was added to POSIX, this issue would become even bigger (there would be 33 reserved bytes instead of just 2).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639859/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 14:55 UTC (Fri)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/639971/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, they do.<br>
<p>
<font class="QuotedText">&gt; The encode operation is very similar to Base64 encoding. However, to make sure that an encoded name is a legal EXT4 name, the character set used for encoding is a-zA-Z0-9+=. The encoding function maps three bytes of the input string (hash to be encoded) to 4 characters in the above range.</font><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640212"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2015 23:58 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/640212/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="http://austingroupbugs.net/view.php?id=251">http://austingroupbugs.net/view.php?id=251</a>... oh my god that bug has so much concentrated stupid in it, it hurts. From dwheeler's perfectly reasonable proposal -- I can't see any sane programs being hurt by an optional, default-on flag that bars creation of files with linefeeds, esc, escape, backspace and the like in them -- we get to a mention (in Geoff Clare's comment 1732) of an old committee decision which has been catastrophically infected with second-system syndrome involving a new readdir() flag, a readdir() that fails when encountering such filenames (!!!) and oh dear oh dear I can't see this ever getting implemented. I'm frankly surprised Al Viro didn't turn up on the thread with some choice words for the people proposing such an overengineered disaster.<br>
<p>
Even ignoring everything else, readdir() doesn't actually take flags, so what are they going to do? changing readdir()'s prototype is impossible and introducing a readdir2() with an extra flags argument is more or less useless because only those programs whose authors think about the problem of weird filenames would ever use it, but if people *did* think about that problem, weird filenames wouldn't cause trouble in the first place because everyone would handle them fine. If you had the flag default on unless readdir2() was used to turn it off, this would just turn filenames containing linefeeds into an attack vector on *everything*, not just on shell scripts, as others on the same bug pointed out. It's not like anything is really prepared for readdir() to fail, either -- people tend to assume readdir() failure means disk damage or some other catastrophic problem, so any directory with a filename in it inducing such a failure would be more or less entirely unusable. Bingo, instant DoS attack vector.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640212/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640216"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2015 0:38 UTC (Tue)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/640216/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hadn't seen it, actually.  What choice words, other than obvious "NOTABUG, WONTFIX", anyway?  POSIX is only relevant to an extent it matches the reality. They can't order us to implement that kind of crap, they are extremely unlikely to be able to convince that it's a good idea (a quick scan leaves Bowman-style impression[1]), therefore it won't be implemented.  Case closed.  Any whinge along the lines of "but I've lobbied POSIX and now they say it's a bug" will be met with "it's their problem"...<br>
<p>
[1] "My God, it's full of s..."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640216/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor640253"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2015 11:12 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/640253/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think that's why its gone nowhere in five years or more. Several people pointed out that there was little chance anyone would willingly implement anything as baroque as that committee-driven scheme...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640253/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor639927"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 12:50 UTC (Fri)
                               by <b>robbe</b> (guest, #16131)
                              [<a href="/Articles/639927/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So would it be fair to say that this is eCryptFs and ext4 smushed together in a giant layer violation for performance?<br>
<p>
Me, I'm staying with dm-crypt. The performance downsides [citation appreciated] of it seem to apply mainly to the hand-held form factor.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639927/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639931"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 13:41 UTC (Fri)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/639931/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Me, I'm staying with dm-crypt. The performance downsides [citation appreciated] of it seem to apply mainly to the hand-held form factor.</font><br>
<p>
If your CPU doesn't have AESNI or equivalent, it uses lots of CPU when doing an I/O heavy operation (like a full backup). The performance difference when going from a CPU without AESNI to a CPU with AESNI is noticeable.<br>
<p>
AFAIK, that was precisely the problem with Android: a lot of phones didn't have the AESNI equivalent enabled because reasons.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639931/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor639997"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 20:40 UTC (Fri)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/639997/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If your CPU doesn't have AESNI or equivalent, it uses lots of CPU when doing an I/O heavy operation (like a full backup). The performance difference when going from a CPU without AESNI to a CPU with AESNI is noticeable.</font><br>
<p>
Ouch, yes, the difference is huge. At one point we had a server which was going dog-slow, while an apparently identical server next to it had no problems. After much searching it turned out that for some reason on this server the aesni_intel module was not getting loaded. An extra line in /etc/modules and a reboot later everything back to normal.<br>
<p>
If the goal of this patch it to make as much of the filesystem usable without invoking any encryption then it explains some of the choices, but it's definitely a feature aimed at embedded processors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639997/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640202"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2015 19:53 UTC (Mon)
                               by <b>robbe</b> (guest, #16131)
                              [<a href="/Articles/640202/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All true, but the proposed ext4 encryption does not change this one jota.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640202/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor640015"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 11, 2015 1:39 UTC (Sat)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/640015/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you're protecting a single-user laptop, I suggest you stick with dm-crypt.<br>
<p>
eCryptfs is a layer that should never have happened without proper stacking support in the MM/VFS.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640015/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor639999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2015 21:07 UTC (Fri)
                               by <b>mhalcrow</b> (guest, #17371)
                              [<a href="/Articles/639999/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Jonathan, great writeup. Thanks for covering this -- and, in particular, for emphasizing our threat model for the current code drop.<br>
<p>
I have one minor correction. We don't allocate bounce buffers on reads. We read and then decrypt in place, and we don't set the page up to date until after the decryption is done. Writes have to be bounced though.<br>
<p>
About that future encryption scheme, there's a hint in the patchset: EXT4_ENCRYPTION_MODE_AES_256_GCM. My original design called for encryption with integrity, but there's a dependency on per-block metadata support. The metadata needs to have transactional semantics since the metadata and the ciphertext need to be consistent. I hear Mingming cao is currently working on a framework for that, but there's not word on when it'll be ready at this point. As soon as we have a place to put per-block metadata, we can slap a nonce and auth tag on each block and expand our threat model a bit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/639999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor640562"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Ext4 encryption</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 16, 2015 11:49 UTC (Thu)
                               by <b>tenshin</b> (guest, #101995)
                              [<a href="/Articles/640562/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Will encryption eventually be a feature that can be added to existing ext4 filesystems with tune2fs? If so, what precautions, if any, does one need to take to ensure that ext4 filesystems created today are compatible with it in the future?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/640562/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2015, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
