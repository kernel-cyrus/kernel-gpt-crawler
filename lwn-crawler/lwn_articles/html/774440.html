        <!DOCTYPE html>
        <html lang="en">
        <head><title>A filesystem corruption bug breaks loose [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/774440/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/774101/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/774440/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A filesystem corruption bug breaks loose</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 10, 2018</br>
           </div>
Kernel bugs can have all kinds of unfortunate consequences, from
inconvenient crashes to nasty security vulnerabilities.  Some of the most
feared bugs, though, are those that corrupt data in filesystems.  The
losses imposed on users can be severe, and the resulting problems may not
be noticed for a long time, making recovery difficult.  Filesystem
developers, knowing that they will have to face their users in the real
world, go to considerable effort to prevent this kind of bug from finding
its way into a released kernel.  A recent failure in that regard raises a
number of interesting questions about how kernel development is done.
<p>
On November 13, Claude Heiland-Allan created <a
href="https://bugzilla.kernel.org/show_bug.cgi?id=201685">a bug
report about a
filesystem corruption problem</a> with the 4.19.1 kernel; other users
joined in with reports of their own.  Initially, the problem was thought to
be in the ext4 filesystem, since that is what the affected users were
using.  Tracking the problem down took a few weeks, though, because few
developers were able to reproduce the problem.  There were some attempts at
using bisection to find the commit that caused the problem, but they proved
to be worse than useless, as they identified the wrong commits and caused
developers to waste time on false leads.
<p>
It took until December 4 for  Lukáš Krejčí to <a
href="https://bugzilla.kernel.org/show_bug.cgi?id=201685#c232">correctly
bisect the problem</a> down to a block-layer change.  <a
href="https://git.kernel.org/linus/6ce3dd6eec114930cf2035a8bcb1e80477ed79a8">Commit
6ce3dd6eec</a>, added during the 4.19 merge window, optimized the handling
of requests in 
the multiqueue block layer.  If there is no I/O scheduler in use, and if
the hardware queue is not full, this patch causes new I/O requests to be
placed directly into the hardware queue, shorting out a bunch of
unnecessary processing.  It's a harmless-seeming change that should make
I/O go a little faster.
<p>
Things can go bad, though, if the low-level driver for the block device is
unable to actually execute that request.  This is most likely to happen as
the result of a resource shortage — memory, perhaps, or something related
to the hardware itself.  In that case, the driver will return a soft
failure, causing the I/O request to be requeued for another attempt later.
While that request sits in the queue, the block layer may merge it with
other requests for adjacent blocks, which should be fine.  If, however, the
low-level driver has already done some of the setup for the request, such
as creating scatter/gather DMA mappings, those mappings may not be
updated to match the larger, merged request.  That results in only part of
the request being executed by the hardware, with bad effects on the data
involved.
<p>
The problem was partially fixed with <a
href="https://git.kernel.org/linus/ffe81d45322cc3cb140f0db080a4727ea284661e">this
commit</a>, but <a
href="https://git.kernel.org/linus/c616cbee97aed4bc6178f148a7240206dcdb85a6">one
more fix</a> was required to fix a new problem caused by the first.  Both
fixes were included in the 4.20-rc6 release; they also found their way into
4.19.8.  The original patch was never selected for backporting to older
stable kernels, so those were not affected.
<p>
<h4>How this happened</h4>
<p>
Naturally, some developers are wondering how a problem like this could have
made it into a final kernel release without having been noticed.  Surely
automated testing should have been able to find such a bug?  Not all parts
of the kernel have exhaustive automated testing regimes (to put it
charitably), but the block layer is better than most.  That is a function
of the severity of bugs at that layer (which can often cause data loss),
but also of the relative ease of testing that code.  There are 
few hardware-specific issues to deal with, so testing can usually be done
in virtual machines.
<p>
This particular case, though, turned up a hole or two in the testing
regime.  It required a filesystem on a device configured to use no I/O
scheduler at all (a relatively rare configuration on the affected
filesystems), and that device needed to run into resource limitations
that would cause it to temporarily fail requests.  The driver for the
device also needed to store state in the request structure and use that
state in subsequent retries.  Finally, the multiqueue block layer must be
in use, which only happens by default for SCSI devices as of 4.19.  That
last change is unlikely to have been picked up by many developers or
testing setups, since kernel configuration files tend to be carried forward
from one release to the next.
<p>
As a result of all those factors, nobody doing automated testing of the
block layer reported this particular problem, and developers found
themselves unable to reproduce it once it came to light.  Ubuntu users who
install from the <tt>kernel-ppa</tt> repository, instead, got a shiny new
configuration file with their bleeding-edge kernel and were thus exposed to
the problem.  This sort of occurrence is one of the reasons why developers
tend to like to remove configuration options; more options create more
configurations that must be tested.  In this case, block
maintainer Jens Axboe has <a
href="https://bugzilla.kernel.org/show_bug.cgi?id=201685#c276">said</a>
that he will be writing a new test for this particular issue.  He also <a
href="https://bugzilla.kernel.org/show_bug.cgi?id=201685#c279">noted</a>
that "<q>this is the first corruption issue we've had (blk-mq or
otherwise) in any kernel in the storage stack in decades as far as I can
remember</q>".
<p>
<h4>Doing better next time</h4>
<p>
There have been some suggestions that the kernel community should have done
more to protect users once the problem was discovered.  It is not clear
that there is a whole lot that could have been done, though.  Arguably
there should 
be a mechanism to inform users that a given kernel might have a serious
issue and should not be used, but the community lacks such a mechanism.
This particular issue was, in fact, less visible than many since it was not
discussed on the mailing lists.  The only people who were aware of it were
those who were watching the kernel bugzilla — or who were busy restoring
their filesystems from backups.
<p>
Laura Abbott <a
href="/ml/linux-kernel/c04ea7b1-23f3-f1e0-4f31-07b62abdee24@redhat.com/">noted</a>
that the problem left Fedora users in an awkward position: they could
either run a 4.19 kernel that might mangle their data or run the 4.18
kernel, which was no longer being supported.  Perhaps, she said, there
should be a way to respond to problems like this?
<p>
<div class="BigQuote">
	I'm wondering if there's anything we can do to make things easier
	on kernel consumers. Bugs will certainly happen but it really makes
	it hard to push the "always run the latest stable" narrative if
	there isn't a good fallback when things go seriously wrong.
</div>
<p>
Willy Tarreau <a
href="/ml/linux-kernel/20181208073259.GB11787@1wt.eu/">responded</a> that
he ensures that the previous long-term stable release works on the systems
he supports for just this reason.  Dropping back to 4.14 is unlikely to be
a pleasing alternative for many users, but it's not clear that something
better will come along.  Some people would surely like it if the previous
release (4.18 in this case) were maintained for longer but, as stable
maintainer Greg Kroah-Hartman <a
href="/ml/linux-kernel/20181208115629.GA3288@kroah.com/">put it</a>, that
"<q>isn't going to happen</q>"; the resources to do that simply are
not available.
<p>
Kroah-Hartman did have one suggestion for situations like this: tell him
and the other stable maintainers about it. In this case, he was only
informed, by accident, shortly before the bug was tracked down and fixed.
There is not much that could have been done even if he had known sooner, since
nobody knew what the origin of the problem was.  But keeping the stable
maintainers in the loop regarding serious problems that have appeared in
stable kernels can only help to get the fixes out more quickly.
<p>

One other aspect of this bug is that, depending on how one looks at it, it
could be seen as resulting from either of two different underlying issues.  One is
that the multiqueue block layer is arguably still not sufficiently mature,
so it is turning up with severe bugs.  The other is that maintaining two
independent block subsystems is putting a strain on the system and letting
bugs get through.  One's point of view may well affect how one views the
prospect of the legacy block API being removed in the next merge window,
which is the current plan.  Ted Ts'o <a
href="/ml/linux-kernel/20181208171853.GA20708@thunk.org/">let it be
known</a> that this idea "<q>is not filling me with a lot of joy and
gladness</q>".  But for many others, the time to make this transition is
long past and, in any case, the number of devices that can only use the
multiqueue API is growing quickly.  


<p>
The good news is that problems of this severity are rare and, when they do
happen, they get the full attention of the developers involved.  Some early
adopters were burned, which is never a good thing, but the vast majority of
users will never be affected by this issue.  Some testing holes have been
identified that will hopefully be closed in the near future.  But no amount
of testing will ever reveal all of the bugs in the system; occasionally a
serious one will escape and bite users.  With luck and effort the number
and severity such events can be minimized, but they are not going to be
entirely eliminated anytime in the near future.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer">Block layer</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-Stable_tree">Development model/Stable tree</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/774440/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor774505"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 20:57 UTC (Mon)
                               by <b>maniax</b> (subscriber, #4509)
                              [<a href="/Articles/774505/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As for this being the only corruption in the stack in the last decade, there was one more that stayed in for a few years - I opened a bug for Ubuntu for it at <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1796542">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1796542</a> , after a customer of ours hit it, we tracked it and found that Suse had found the same issue three months earlier and had pushed a patch in mainline. The issue was introduced in v4.10-rc1 with 72ecad22d9f198aafee64218512e02ffa7818671.<br>
<p>
And, not sure if that counts, but I've seen patches fixing somewhat silent data corruption in ext4 if a cgroup's memory runs out.<br>
<p>
I really hope there's an answer to the testing problem. Maybe instead of bitcoin people can donate their CPU for linux kernel tests...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774505/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor774508"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">git bisect considered dangerous</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 21:09 UTC (Mon)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/774508/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So the bug is fixed upstream - great.  But anyone doing a git bisect on an unrelated bug can encounter it again.  An expert user who has read this article and remembers it could avoid it, but... time passes, people forget, and not everyone reads every lwn article.  What can be done to make git bisect safer?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774508/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774509"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">git bisect considered dangerous</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 21:38 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/774509/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd like the ability to give a list of patches to cherry-pick onto every step of the bisect. I've done this before by using a `git bisect run` which applies the diff, runs the test, and then unapplies the diff (since bisect doesn't like local changes). Conflicts are annoying to deal with though. If the project could specify that a patch fixes something introduced in a patch, bisect could determine whether it needs to be applied automatically by checking the ancestry of the current commit. Gathering the list of potential fix commits is the hard part there (though conflicts are still an issue, how/where to store this "fixes" information might be hard). Commit trailers work well for other things though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774509/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor774514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A **block layer** corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 22:12 UTC (Mon)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/774514/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One is that the multiqueue block layer is arguably still not sufficiently mature, so it is turning up with severe bugs. The other is that maintaining two independent block subsystems is putting a strain on the system and letting bugs get through. </font><br>
<p>
There's the paradox of kernel development:  Too busy cutting wood to design and build safe and fast autonomous chainsaws.<br>
<p>
The headline is very misleading--this is a block layer bug, not a filesystem bug.  Everyone's affected by the former, while only people who picked the wrong filesystem are affected by the latter.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774557"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A **block layer** corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 14:00 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/774557/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The headline says filesystem corruption bug, i.e., a bug that corrupts filesystems. It does not say where the bug is located in the code or io stack.<br>
<p>
And to see whether you are affected or not, you have to read the article anyways. Because not everyone is affected by this bug in the block layer. Only the ones who picked the wrong queueing discipline (multi queue), the wrong driver (scsi) and the wrong io scheduler (none). I do not see why this is so much different from picking a wrong filesystem.<br>
<p>
If everyone would be affected by this bug, it would have been found much earlier.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774557/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774561"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A **block layer** corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 14:37 UTC (Tue)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/774561/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You hardly "pick" mq, none and scsi. Those are the defaults nowadays.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774561/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774606"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A **block layer** corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 19:11 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/774606/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I thought Kyber was the default for mq?<br>
<p>
(I'll just be over here in my corner, running BFQ…)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774606/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor774591"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A **block layer** corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 16:30 UTC (Tue)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/774591/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A block-layer bug would also affect non-filesystem things, like swap and raw partitions used by VMs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774591/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor775008"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A **block layer** corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 15, 2018 22:32 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/775008/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>This is a victim of our sloppy use of terminology.  We commonly use "filesystem" 3 ways.  The purest definition of filesystem is a set of bits that can be interpreted as files, as in "the filesystem that contains my paper is on this disk drive."  But people normally also use the word to refer to a filesystem type, as in "FAT16 is the most portable filesystem" and also to refer to a filesystem driver ("This filesystem has bugs").

<p>The headline refers to a true filesystem; OP took it to mean filesystem driver.

<p>There are many more examples in technical talk of words commonly used in multiple ways (usually as both an object and a class of those objects) where the reader is expected to discern from context which one it is.  "command" is a great example.  I wish we did this less.

      
          <div class="CommentReplyButton">
            <form action="/Articles/775008/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor774515"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 22:18 UTC (Mon)
                               by <b>cornelio</b> (guest, #117499)
                              [<a href="/Articles/774515/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Speaking about bugs ... btrfs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774515/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774551"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 12:17 UTC (Tue)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/774551/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes? What about it? (I'm using it so I'd like to know. Haven't had problems for quite a while.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774551/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774560"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 14:25 UTC (Tue)
                               by <b>Baughn</b> (subscriber, #124425)
                              [<a href="/Articles/774560/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You never have to manually rebalance it?<br>
<p>
How well do non-mirrored RAID modes work?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774560/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774609"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 20:24 UTC (Tue)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/774609/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You still need to balance one data block group every now and then, just enough to keep one chunk unallocated on each drive.  A partial or full rebalance is required after some array layout changes (and always will be--the best outcome would be to automatically start a balance when that occurs).<br>
<p>
Parity RAID now survives data corruption and non-timeout IO errors.  It will happily--and correctly--fix itself even if you corrupt one random byte on every block of two disks in a RAID6 array (except nodatacow files, which will be corrupted because nodatacow intentionally trades detection or repair of data corruption for performance).  I haven't tried it with real failing disks, though, and I lack the imagination and contempt for data integrity required to try to replicate drive firmware bugs in a VM.<br>
<p>
That said, there are still hundreds of other bugs, and there are still plenty of opportunities to improve performance in btrfs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774609/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor774518"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 23:02 UTC (Mon)
                               by <b>mangix</b> (guest, #126006)
                              [<a href="/Articles/774518/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A few thoughts,<br>
<p>
This seems to affect users of NVME devices, as those seem to use a scheduler of none and use blk-mq by default.<br>
<p>
This is also not the first filesystem corruption issue that I've seen. I saw a recent one introduced in kernel 4.8 for very specific MIPS devices (MIPS 1004KC, probably the only one actually). It was an L1 cache bug where the cache on the second core was not being cleared. After some uptime, data corruption ensued. ext4 managed to get corrupted very fast. btrfs less so. It even spammed dmesg like crazy. But it also was not immune.<br>
<p>
Fixed and backported to 4.9<br>
<p>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/commit/?h=next-20181210&amp;id=55a2aa08b3af519a9693f99cdf7fa6d8b62d9f65">https://git.kernel.org/pub/scm/linux/kernel/git/next/linu...</a><br>
<p>
<p>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774518/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774520"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 23:05 UTC (Mon)
                               by <b>mangix</b> (guest, #126006)
                              [<a href="/Articles/774520/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Let's not even mention the data loss that resulted from this (bad btrfs repair options).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774520/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor774522"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2018 23:20 UTC (Mon)
                               by <b>axboe</b> (subscriber, #904)
                              [<a href="/Articles/774522/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This seems to affect users of NVME devices, as those seem to use a scheduler of none and use blk-mq by default.</font><br>
<p>
No, as the article mentions, only a subset of SCSI was affected. To hit this issue, you need:<br>
<p>
1) Driver that can hit a BUSY condition on dispatch. SCSI fits that bill.<br>
2) Driver that retains state over a BUSY condition. Only SCSI fits that bill.<br>
3) Device that hits this condition outside of normal queue full. Only ATA fits that bill, with some commands not being queued.<br>
4) Device NOT using an IO scheduler<br>
5) Lots of bad luck<br>
<p>
All of these conditions have to be met, or you cannot hit it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774522/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 0:46 UTC (Tue)
                               by <b>mangix</b> (guest, #126006)
                              [<a href="/Articles/774525/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Got it. Thanks for the clarification.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor774526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 1:21 UTC (Tue)
                               by <b>ken</b> (subscriber, #625)
                              [<a href="/Articles/774526/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was one of the unlucky ones hitting this on ubuntu 18.10.<br>
<p>
All important files was on NFS so not a huge problem but I found out that it no longer works to run fsck on boot in ubuntu .  So now your forced to boot from a usb live system just to do fsck on root.<br>
<p>
That upset me more than the actual filesystem bug.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 1:28 UTC (Tue)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/774528/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><font class="QuotedText">it no longer works to run fsck on boot</font></blockquote>

<p>Was that because of this bug?</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/774528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774529"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 1:46 UTC (Tue)
                               by <b>ken</b> (subscriber, #625)
                              [<a href="/Articles/774529/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No I was booting 4.12 kernel when I tried to fix the drive. <br>
<p>
tried the good old. touch /forcefsck but that creates a warning<br>
Please pass 'fsck.mode=force' on the kernel command<br>
<p>
but that did not help I did still got the <br>
"warning: mounting fs with errors, running e2fsck is recommended"<br>
<p>
That only stopped once I run fsck manually from a live usb boot. <br>
<p>
I could not find any trace fsck was run at all on boot.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774529/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 12:59 UTC (Tue)
                               by <b>mgedmin</b> (subscriber, #34497)
                              [<a href="/Articles/774554/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can check /run/initramfs/fsck.log for a full log of fsck execution from the initramfs.<br>
<p>
Perhaps fsck -f -a was unable to fix the corruption automatically?  In which case you needed to pass fsck.repair=yes as well, to change that command to fsck -f -y.  I'm not sure where that's documented, I discovered it by grepping through the initramfs shell scripts in /usr/share/initramfs-tools.<br>
<p>
Anyway, booting a livecd and running fsck interactively sounds like a good plan, where you can tell what's going on without digging through a maze of little scripts in /usr/share/initramfs-tools.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775335"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 20, 2018 17:07 UTC (Thu)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/775335/">Link</a>] 
      </p>
      
      </div>
      </summary>
      These command-line parameters were first implemented by systemd and are documented in <a href="https://manpages.debian.org/stretch/systemd/systemd-fsck.8.en.html">systemd-fsck(8)</a>. Since initramfs-tools took over running fsck on / and /usr, it is meant to support the same command-line parameters that control fsck in either initscripts or systemd.
      
          <div class="CommentReplyButton">
            <form action="/Articles/775335/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor774608"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 19:30 UTC (Tue)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/774608/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I copied e2fsck into initramfs years ago.  Also dropbear (to diagnose and repair the root filesystem remotely), mkfs and rsync (in case the diagnosis and repair does not end well, and a restore from backups over the network is required).<br>
<p>
The old Unix way of running fsck on a live root filesystem so that it will be potentially modifying its own program text (or block maps thereof) was, at best, a workaround for not having a usable initramfs subsystem to run fsck from.  That era ended 15 years ago on Linux, and even earlier on Solaris and other commercial Unixes.<br>
<p>
I'm surprised Linux distros that boot with initramfs today still try to fsck after / is mounted.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774608/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 20:16 UTC (Tue)
                               by <b>lkundrak</b> (subscriber, #43452)
                              [<a href="/Articles/774612/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Uh? A fresh Fedora install:

<pre>
[root@nedofet lkundrak]# lsinitrd |grep -i fsck
-rwxr-xr-x   1 root     root        28512 Oct 25 09:14 usr/lib/systemd/systemd-fsck
-rw-r--r--   1 root     root          671 Oct 25 09:14 usr/lib/systemd/system/systemd-fsck@.service
-rwxr-xr-x   2 root     root            0 Jul 13 04:35 usr/sbin/e2fsck
-rwxr-xr-x   1 root     root        55952 Jul 16 13:51 usr/sbin/fsck
-rwxr-xr-x   2 root     root       339424 Jul 13 04:35 usr/sbin/fsck.ext4
[root@nedofet lkundrak]#
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/774612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774614"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 20:18 UTC (Tue)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/774614/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OK, that's one...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774614/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774662"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2018 3:45 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/774662/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Debian also includes e2fsck in the initramfs:<br>
<p>
[~]$ lsinitramfs /boot/initrd.img-4.18.0-2-amd64  | fgrep fsck<br>
usr/sbin/e2fsck<br>
usr/sbin/fsck<br>
usr/sbin/fsck.ext4<br>
usr/sbin/reiserfsck<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774662/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor775339"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 20, 2018 17:10 UTC (Thu)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/775339/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed, we've been doing this by default since Debian 8 "jessie". But if you build a custom kernel with no initramfs then of course fsck gets run in the old way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/775339/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor774971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 14, 2018 23:41 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/774971/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Presumably you also install iproute2, or you'll have trouble bringing the network up to rsync over it (unless it's already up for netconsole or something, I suppose).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor774592"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 11, 2018 16:30 UTC (Tue)
                               by <b>tbm</b> (subscriber, #7049)
                              [<a href="/Articles/774592/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a great illustration of how bugs get fixed in open source.<br>
<p>
What I find disappointing is that Lukáš Krejčí wasn't credited at all in the commit message. He did great work finding a setup that allowed the developer to reproduce and identify the issue. QA people need more recognition.<br>
<p>
(To be fair, there is at least a Tested-by but not Lukáš)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774592/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor774658"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2018 1:51 UTC (Wed)
                               by <b>axboe</b> (subscriber, #904)
                              [<a href="/Articles/774658/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; What I find disappointing is that Lukáš Krejčí wasn't credited at all in the commit message</font><br>
<p>
I totally agree, and I'll take the blame for that. For what it's worth, he's credited in the fio reproducer I made based on his setup description.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774658/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor774770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A filesystem corruption bug breaks loose</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 12, 2018 22:17 UTC (Wed)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/774770/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a great point.  A lot of us were racing pretty hard to find a good repro, but I really don't think I would have nailed the recipe myself.<br>
<p>
We can't change git history, but we'll work out a way to send him something.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/774770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
