        <!DOCTYPE html>
        <html lang="en">
        <head><title>KVM for Android [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/836693/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/836254/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/836693/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>KVM for Android</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>November 11, 2020</br>
           <hr>
<a href="/Archives/ConferenceByYear/#2020-KVM_Forum">KVM Forum</a>
</div>
<p>
A Google project aims to bring the Linux kernel virtualization
mechanism, KVM, to Android systems.  Will Deacon leads that effort and he
(virtually) came to <a
href="https://events.linuxfoundation.org/kvm-forum/">KVM Forum</a> to
discuss the project, its goals, and some of the challenges it has faced.
Unlike some Android projects of the past, though, "protected KVM" is being
worked on in the open, with code going upstream along the way.
</p>

<p>
Deacon is one of the maintainers of the arm64 architecture for the kernel,
as well as a maintainer and contributor in various other parts of the
kernel, including concurrency, locking, atomic operations, and tools for
the kernel memory model.  He has worked in the kernel for a long time, but
not really on KVM; the closest he had come to that is maintaining the Arm
IOMMU drivers.  He started working on the Android Systems team at Google
in 2019 "and found myself leading the protected KVM project", which is the KVM
on Android effort.
</p>

<p>
The project is the top contributor to KVM for arm64 for the 5.9 and 5.10
kernels; KVM seems to be a "hot topic" right now, he said, and not just for
arm64, but for other architectures as well.  All of the project's work is
being upstreamed as it goes, so what he was presenting was "very much a
work in progress".  He wants to avoid the trap of doing a bunch of work out
of tree and then "throwing it over the wall", which does not lead to good
solutions that are embraced by the community.
</p>

<h4>Android background</h4>

<p>
The latest development for the overall Android system is the <a
href="https://source.android.com/devices/architecture/kernel/generic-kernel-image">generic
kernel image</a> (GKI), which is meant to <a
href="/Articles/830979/">reduce Android kernel
fragmentation</a>. Traditionally, each handset had its own kernel version,
which simply does not scale.  That leads to fragmentation, which in turn leads to the inability to
update some systems because of the difficulties and expenses associated
with updating multiple kernel versions, one for each different device.  It
can also make it impossible to update the 
Android release on certain devices because their kernel is too old to have
a feature needed by the more recent Android release.
</p>

<p>
One other problem that stems from this fragmentation does not get enough
attention, he said: it is also bad for the upstream kernel.  The idea behind
the mainline kernel is to have the right subsystems and abstractions to be
able to support a wide variety of hardware, 
but that cannot be done unless the developers have visibility into all of
the different problems and solutions for all of the disparate hardware.
Because the code is all "squirreled 
away in all these different kernels, it's very hard to see the wood for the
trees"; that means the kernel developers cannot come up with an abstraction that
will work for everyone.
</p>

<p>
GKI is meant to solve that problem by "rallying around" a given kernel
version that is tied to a particular Android release.  A limited subset of
the module ABI will be maintained as a stable interface for that kernel.
Vendors can then create driver modules that will continue to work as the
kernel gets long-term support (LTS) and security updates.
</p>

<p>
With a grin, Deacon said that he could hear audience members strongly
suggesting ("screaming") that
the Android systems team <i>not</i> maintain the ABI as the kernel
evolves.  He acknowledged the problems with that, but noted that the team
has identified a strict subset of the symbols in the ABI that it will
continue to maintainâ€”only for a single kernel version and Android release pair.
</p>

<h4>Android virtualization today</h4>

<p>
The hypervisor situation on Android is chaotic.
"If you think fragmentation on the kernel side is bad, this is much, much
worse."  At least all of the Android devices are running some version of
Linux, but in terms of hypervisors, "it's the wild west of fragmentation".
Some devices do not have a hypervisor at all, which simplifies the picture,
but many do, and they are used for several different things.
</p>

<p>
The first main use is for security enhancements that are meant to protect
the kernel but are sometimes problematic in their own right.  He pointed to
Jann Horn's <a
href="https://googleprojectzero.blogspot.com/2020/02/mitigations-are-attack-surface-too.html">Project
Zero blog post</a> that notes: "<q>Mitigations are attack surface,
too</q>".  It shows how attacks can be made against some of these
security enhancements.  It is important to remember that the hypervisor is
running with elevated privileges, so bugs there can mean that these
supposed protections are not really protecting the system.
</p>

<p>
Another hypervisor use in Android today is for coarse-grained memory
partitioning that looks something like an IOMMU but actually is not.  It
is used at boot time to carve up the physical memory into regions that can be handed off
to various devices for DMA and other uses.  He understands why that is
needed, but there is a lot more that could be done with a hypervisor after
boot time, so this type of use
is kind of a waste, he said.
</p>

<p>
The final reason that hypervisors are used in Android today is his least
favorite: running code outside of Android itself.
Armv8 has multiple privilege levels, called <a
href="https://developer.arm.com/architectures/learn-the-architecture/exception-model/privilege-and-exception-levels">exception levels</a>, going from
the most privileged, firmware (EL3), through the hypervisor (EL2) and operating system
(EL1) levels, to the least privileged user (EL0) level.
The hypervisor exception
level is not the firmware level, so device makers do not have to worry
about bricking devices when updating code there, and it is not the operating
system level, so code running there does not need to integrate with
anything else.  That means EL2 has become  something of a "playground"; code that
doesn't seem to fit anywhere else gets stuck there, which is bad because
EL2 has lots more privileges than are probably needed.
</p>

<p>
In most cases, there are not even any virtual machines (VMs), so these
hypervisors are not providing the usual services.  His conclusion is that
both security and functionality are losing out because of that.  Security
is hampered
because there is an increased <a
href="https://en.wikipedia.org/wiki/Trusted_computing_base">trusted
computing base</a> (TCB) and it is more difficult to update the devices
because of the fragmentation at that level.  And functionality is lacking
because there is no access to the hardware virtualization features from
within Android.
</p>

<p>
He then described the Armv8 "exception model", showing how the various
levels of software are built up from most to least privileged, but also how
Arm has long had a parallel "trusted" 
side where applications can be run on a trusted OS and hypervisor.
The definition of "trusted" is just a "bit on the bus" that allows more
access to physical memory.  It is important to note that code on the
trusted side can access all of the memory, while code on the untrusted side
is unable to access trusted-only memory.
</p>

<p>
Effectively, the trusted levels are all more privileged than the non-secure
levels, so the trusted OS can map non-trusted hypervisor memory, for
example, and it could provide access so that trusted applications have
access to it too.  That is problematic in the Android world in part because
of what is typically running on the trusted side: third-party code for
digital rights management (DRM), various opaque binary blobs, cryptographic
code, and so on. That code may not be trustworthy and it suffers from the
fragmentation problem as well. 
What people think of as "Android" is running in the 
least-privileged part of the system.
</p>

<p>
The term "trusted" is largely a marketing term, he thinks, to make people
feel that the code running there is safe and reliable.  But there is
another definition of "trust", to "expect, hope, or suppose", and that is
also operative here.  The Android system has to hope that the software
running in the trusted side is not malicious or compromised because there
is not anything Android can do if it is.
</p>

<p>
Instead, the Android project would like to have a way to de-privilege this
third-party code.  There is a need for a portable environment that can host
these services in a way that is isolated from the Android system.  That mechanism would
also isolate these third-party programs from each other.
</p>

<h4>Enter KVM</h4>

<p>
One way to do that is to move the trusted code into a VM at
the same level as the Android system.  The third-party code would be no
more (or less) trusted than Android itself.  Since there are no VMs
currently in Android, there is an opening to add some if there is a
hypervisor available to manage them.  The idea is to use the GKI effort to
introduce KVM as that hypervisor in order to move that third-party code out of
the over-privileged trusted region.
</p>

<p>
All arm64 Android devices support virtualization in hardware and have
two-stage MMUs, which allow partitioning the memory so that guests cannot
access outside of their memory regions.  KVM has been supported on arm64
since Linux&nbsp;3.11 (in 2013).  There are two basic modes that are
supported depending on whether the <a
href="https://developer.arm.com/architectures/learn-the-architecture/aarch64-virtualization/virtualization-host-extensions">Virtualization
Host Extensions</a> (VHE) support is available; that support was added to
v8.1 of the architecture, but all arm64 processors can still run in the earlier
non-VHE (nVHE) mode if they choose.
</p>

<p>
In nVHE mode, the host and guest kernels both run at the operating system
level (EL1), while there is a virtual machine monitor (VMM) at the EL2
hypervisor level.  Because the host kernel does not have the privileges
needed to directly switch to and from the guests, the VMM must do a "world
switch" to make that happen, which makes nVHE mode  relatively slow.
[<b>Update</b>: The article confuses the VMM and world-switch code, which Deacon helpfully untangles in a comment below.]
</p>

<p>
In v8.1, the VHE support allowed EL2 programs to have fewer constraints, so
the host kernel could be run in EL2, with all of the guests as VMs in EL1,
which is "blazingly fast".  That mode is not really compatible with the
threat model for Android, however.  It moves the host kernel and VMM (via
<tt>ioctl()</tt>) into the TCB and the host kernel has access to all of the
memory of the guests.  It effectively turns the trusted model on its head,
so only the Android system would be in a privileged position, which is not
desirable either.
</p>

<p>
The envisioned Android security model requires that guest data remains private even if
the host kernel is compromised, and KVM using VHE does not work that way.
But that is not a problem with nVHE mode, so it might make sense to revisit
that.  Instead of trusting the full host kernel, only the world-switch
piece needs to be trusted.  It can be extended to manage the stage-2 page
tables and manage other functions for the guests.  Message passing can be
used between the host kernel and the VMs and a special bootloader can be
used to ensure that the host does not tamper with the VM images. "While
we're at it, we'll try to apply formal verification techniques because the EL2
code is drastically simpler than Linux."
</p>

<p>
Another possibility would be to run Android in a VM, which is plausible, but Deacon does not
really think that is demonstrably better;  it has a different set of
challenges.  Interrupt latency could be a problem for an Android VM.  There
is also a need for device pass-through and he does not think the Arm IOMMUs
are really up to handling that at this point.
</p>

<p>
The nVHE execution environment in EL2 is "a pretty horrible place"; it has its
own limited virtual address space that lacks the addressing capability needed for
running general kernel code.  Any code running there is not preemptible or
interruptible, so you cannot block or schedule.  EL2 can access all of the
memory if it is mapped, but, because of that, the project does not want to
put a lot of complicated code thereâ€”that would defeat the purpose.
There is "very limited device access at EL2" because the host kernel
normally handles all of that; typically, there is no console at EL2, though
they have some hacks for a debug console.
</p>

<p>
The EL2 code needs to be self-contained and safe against a compromised
host, which is not the case for kernels prior to 5.9, where KVM could
effectively cause arbitrary code to be run as an EL2 hypercall by passing a
function pointer for
what to call. As part of the recent changes, the project has switched to a
fixed set of hypercalls for the services that need to be provided.  The EL2
payload is embedded in a separate ELF section that uses symbol prefixing to
ensure that symbols from the host kernel are not wrongly used.  As the
system boots, the host kernel sets the static keys appropriately before it
de-privileges itself by moving to EL1; the EL2 object is then no longer
mapped from EL1, so those changes are one-way.
</p>

<h4>Open problems</h4>

<p>
There are still a number of problems, however, most of which come down to
how the virtual memory is managed.  Today, the host kernel is in control of
the hypervisor's virtual memory, which is obviously a problem given the
Android use case.  The stage-1 mappings are created by the host kernel, which
means it can change the page table out from under the hypervisor; it can
also write to any of the hypervisor memory.
</p>

<p>
Beyond that, the stage-2 page tables for guests are also managed by the
host kernel.  When EL2 does a world switch, it just blindly installs those
tables assuming that the host kernel is doing the right thing.  That
obviously needs to change as well.  The protected KVM project has some
patches that it is targeting for Linux&nbsp;5.11 to change page-table
handling, some of which (e.g. <a
href="https://lore.kernel.org/kvmarm/20200911132529.19844-1-will@kernel.org/">page
table and fault handling</a>, <a
href="https://lore.kernel.org/lkml/20200922204910.7265-1-dbrazdil@google.com/">per-CPU
data handling</a>) have already landed in&nbsp;5.10.
</p>

<p>
Moving the page-table handling code to EL2 has some interesting
properties.  When a new guest is created, its memory will be unmapped from
the host, which is not something that Linux can deal with.  It is not like
memory hotplug, where a whole bank can go away, it is just the pages
assigned to the guest that will disappear. The <a
href="/Articles/835342/">KVM
protected memory extension</a> patches would fix that problem, though they
have not been merged.  They would allow handling the case where guest
memory disappears and then reappears later when the guest is torn down.
</p>

<p>
IOMMU support is needed to avoid DMA attacks, but the current
systems-on-chip (SoCs) are not really ready for that.  Ideally, the IOMMUs
would simply reuse the page tables that are already installed in the CPU, so there
would be limited IOMMU-management code needed in EL2.  It would not be
desirable to have multiple different IOMMU drivers bloating the EL2 code.
</p>

<p>
Another piece that will be needed is the template bootloader that is used
to start guests; it will be "very very small" and the current plan is to
write it in bare-metal Rust.  It will check the signature of the VM image
to ensure that it has not been tampered with; if it passes, the bootloader
will jump to it.  That image will have a "proper second-stage bootloader"
as part of it, so the template bootloader can remain extremely simple.
None of that is particularly arm64-specific, so other architectures may be
able to use it as well.
</p>

<h4>Virtual platform</h4>

<p>
The protected KVM project is adapting the <a
href="https://chromium.googlesource.com/chromiumos/platform/crosvm/">Chrome
OS VMM</a> (crosvm) for its VMM.  Crosvm is now
included in the Android open-source project (AOSP); there have been lots of talks
about it at KVM Forums, he said.  Crosvm is written in Rust with a major focus
on security and sandboxing, which makes it a good match.  It also has
many virtio devices already implemented and is cross-architecture,
which is important, perhaps surprisingly, in part because of the <a
href="https://source.android.com/setup/create/cuttlefish">Cuttlefish</a>
virtual Android device that is based on the x86 architecture. 
</p>

<p>
Protected KVM provides a fairly basic arm64 virtual platform for guests, with much of
what would be expected.  One major difference is that it provides the <a
href="https://developer.arm.com/architectures/system-architectures/software-standards/rvic">Reduced
Virtual Interrupt Controller [PDF]</a> (RVIC, which is a paravirtual IC), rather than the standard <a
href="https://developer.arm.com/ip-products/system-ip/system-controllers/interrupt-controllers">Generic
Interrupt Controller</a> (GIC) because the latter is more complicated than
what the developers want to add to the EL2 code.
</p>

<p>
For I/O, the obvious answer is virtio, he said, but that does not fully solve the problem
because it assumes that hosts have access to all of guest memory.  Even if
you work around that, it means that the host can intercept the I/O data for
the guest, which means "you have to use quite clever crypto".  There is
also no shared-memory device for virtio, so bounce buffers are needed.
Support for that is working but has various undesirable properties,
including slower
performance, so some other
solution is sought.
</p>

<p>
His final slide was a long list of things that still need to be done.  One
big lurking item is something where he underestimated the effort required:
getting it all working with the rest of the Android system.  There is a lot needed
to integrate with the user-space bits of the system, which his experience as
a kernel (and now KVM) developer did not prepare him for.  He 
encouraged those interested to contact the team or to post to the <a
href="https://lists.cs.columbia.edu/mailman/listinfo/kvmarm">KVM/Arm
mailing list</a>. The <a
href="https://mirrors.edge.kernel.org/pub/linux/kernel/people/will/slides/kvmforum-2020-edited.pdf">PDF
slides</a> are available and the video can be <a
href="/Articles/836505/">accessed</a> from the <a
href="https://www.accelevents.com/e/OSSELCEU2020">event site</a> and will
eventually appear on YouTube.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Android">Android</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#KVM">KVM</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#KVM_Forum-2020">KVM Forum/2020</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/836693/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor836950"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2020 7:38 UTC (Thu)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/836950/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would this work allow for running the distros in VMs on Android devices?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/836950/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor837017"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2020 15:19 UTC (Thu)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/837017/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;third-party code for digital rights management (DRM), various opaque binary blobs, cryptographic code, and so on</font><br>
<p>
So in the end, the &quot;security&quot; gains of the &quot;protected KVM&quot; project are securing the device against the user, not actual improved security for the user. That&#x27;s pretty disappointing. When people talk about shrinking the TCB, and how that improves security, I generally take them at their word, not as this kind of masked anti-user effort...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837017/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor837020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2020 15:32 UTC (Thu)
                               by <b>adam820</b> (subscriber, #101353)
                              [<a href="/Articles/837020/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suppose that depends on how you read the context of that whole sentence. It sounded to me like the goal was to protect the Android system (and thus, the user) from whatever this third-party code is doing, since there&#x27;s no control over it. Not necessarily to enable that code (it&#x27;s enabled regardless).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor837077"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2020 12:12 UTC (Fri)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/837077/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s how I read it too. Currently it&#x27;s forced upon the user and runs in a super-privileged context with no oversight at all. Sandboxing this code can only benefit the user. (Though I agree that removing it would be best.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837077/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor837079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2020 13:40 UTC (Fri)
                               by <b>mzyngier</b> (subscriber, #32898)
                              [<a href="/Articles/837079/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s indeed the goal. We can&#x27;t really get rid of it (apparently, people really want 4K N*****x on a 15cm screen), but we can move that code to a place where it won&#x27;t risk harming the rest of the system if it goes mad.<br>
<p>
At least, that&#x27;s the plan.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor837858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2020 7:49 UTC (Fri)
                               by <b>rmayr</b> (subscriber, #16880)
                              [<a href="/Articles/837858/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, that is one of the main drives - TrustZone (where most of this code lives today) is highly privileged and opaque, and TEE implementations certainly have had their share of vulnerabilities. Sandboxing that code in VMs helps the whole system and therefore users.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor837131"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2020 15:45 UTC (Fri)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/837131/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Protecting the Android system and the user could be done by running these DRM blobs under normal KVM. The &quot;protected KVM&quot; project isn&#x27;t necessary to achieve that - regular KVM would work fine.<br>
<p>
&quot;Protected KVM&quot; is only necessary if you don&#x27;t want the Android kernel and user to have a higher privilege level than the DRM blobs - which is a requirement specific to DRM and anti-user things like it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837131/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor837021"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2020 7:48 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/837021/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; digital rights management</font><br>
<p>
Well â€¦ actually I think the defectivebydesign.org people have gotten that right when they renamed the acronym to Digital Restrictions Management.<br>
<p>
There&#x27;s no rights being &quot;managed&quot; here. Only withheld.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837021/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor837334"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2020 11:09 UTC (Mon)
                               by <b>wildea01</b> (subscriber, #71011)
                              [<a href="/Articles/837334/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the excellent write-up, Jake!<br>
<p>
One thing I feel that I should clarify is my use of the term &quot;VMM&quot;, which I used to refer to the _userspace_ component of KVM on the host (e.g. QEMU, crosvm or kvmtool). This always lives in userspace, regardless of VHE/nVHE. The primary difference between VHE and nVHE is that the host _kernel_ runs at EL2 or EL1 respectively. With nVHE, EL2 contains some small &quot;world-switch&quot; code installed by the kernel and it is this layer that we are working to extend for Protected KVM.<br>
<p>
Will<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837334/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor844139"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 27, 2021 14:26 UTC (Wed)
                               by <b>jserra</b> (guest, #144441)
                              [<a href="/Articles/844139/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How does this fit within ARM Trusted Frmware(ATF) architecture. Will ATF no longer be used? <br>
I&#x27;m assuming that ATF&#x27;s BL3 that implements the SMC interface will bot be running at EL3. In practice this means Trustzone will not be used at all?<br>
Will your EL3 code also implement PSCI?<br>
What about Android&#x27;s Keymaster TA that runs in the TEE? Also moved to a KVM guest?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/844139/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor875548"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">KVM for Android</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2021 2:53 UTC (Wed)
                               by <b>mountainlion0523</b> (guest, #155244)
                              [<a href="/Articles/875548/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What distinguishes Protected KVM with lowvisor in nVHE?<br>
before VHE,  there was already a lowvisor which does handle hypervisor requests and it runs on EL2, it seems very similiar with Protected KVM<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875548/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
