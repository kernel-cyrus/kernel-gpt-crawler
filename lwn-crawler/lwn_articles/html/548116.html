        <!DOCTYPE html>
        <html lang="en">
        <head><title>LSFMM: A storage technology update [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/548116/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/548116/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>LSFMM: A storage technology update</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 23, 2013</br>
           <hr>
<a href="/Articles/LSFMM2013/">LSFMM Summit 2013</a>
</div>
Rob Elliott stood up before the assembled group to discuss developments in
the T10 (SCSI) standard community and beyond.  There is a lot going on in
the storage industry that will have to be answered in the Linux kernel.
<p>
Rob started by stating that storage devices continue to get faster, to the
point where they can saturate any interface they are connected to.  Keeping
up with these devices is increasingly hard for any operating system.  He
said we would see the introduction of "non-uniform I/O access" systems where I/O
controllers are local to each CPU.  Christoph Hellwig interjected that some
developers have been working with such systems for the last fifteen years.
It was acknowledged that the idea is not entirely new, but with the proviso
that the parts of the kernel that can work effectively on such systems are
limited — the "knowledge" of how to handle non-uniform I/O access has not
been spread through the kernel as a whole.
<p>
The "SBC-4" proposal envisions a new, highly reduced SCSI command set.
SCSI drivers currently have a lot of special cases to handle the specific
subset of commands supported by each device.  SBC-4 devices would be
guaranteed to support the full (reduced) command set and nothing more, eliminating a
lot of special-case code.  Of course, to SCSI developers, SBC-4 can also
look like yet another special case to handle.  Perhaps in an answer to
that, Rob suggested the creation of a new, optimized SCSI disk driver that
would only work with such devices.
<p>
The other concern with SBC-4 was that, inevitably, USB drives would claim
to support it as well.  Since those drives are famous for not supporting
any standard all that well, the likely result is a new set of heuristics
and workarounds.  That led to a brief discussion on the idea of certifying
devices for use with Linux.  The sense seemed to be that certification
would be nice, but the manufacturers of dirt-cheap USB drives have no
incentive to get their hardware certified to any standard, so the overall
situation would not change much.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
There are a couple of interesting additions to the SCSI command set in the
works.  One is "WRITE ATOMIC" — an extended write operation that would
either succeed fully or not at all.  A filesystem could bundle a bunch of
data into an atomic write with the understanding that there was no risk of
the operation completing only partially.  Atomic writes combine well with
scatter/gather operations, which are the other addition.  Scatter/gather
operations need not specify a single contiguous region of the disk;
instead, they provide a vector of offsets and lengths, scattering the data
across the drive.  A scattered write
could combine a change to a file with the changes to the associated metadata in
a single operation.  That has the potential to eliminate the need for a lot
of defensive measures currently in place to ensure metadata consistency.
<p>
Once again, though, there is a problem: how well would these features be
supported?  Both are optional, and, for scatter/gather operations, there is
no minimum number of segments that would have to be supported.  Dave
Chinner said that, for XFS to fully use this feature, it would have to
support as many as 500,000 segments, holding 1-2GB of data, in a single
operation.  It seems unlikely that many devices will support operations
that large.  Ted Ts'o said that ext4, instead, could get away with a half
dozen segments — but that would just be to make journaling more efficient;
ext4 would still need its journal when operating in that mode.  Josef Bacik
also agreed that scatter/gather operations could make Btrfs logging more
efficient, but it couldn't eliminate the need altogether.  Btrfs, he said,
can build up several gigabytes of dirty metadata; it is hard to imagine
that it could all be handed to the drive in a single operation.
<p>
There are various proposals out to improve the effectiveness of the
"DIF" data-integrity mechanism.  They mostly consist of using different CRC
algorithms or adding the logical block number to the CRC to help guard
against block aliasing.  Other proposals include a "product type" field for
multiple-card readers, "conglomerate LUNS" to handle vast numbers of
logical unit numbers in virtualized environments, deadline scheduling for
I/O priority ordering, adding a "force" bit to the UNMAP command to
guarantee that old data would be unretrievable, and an option to sanitize
old data when it is overwritten.
<p>
Rob then moved to a set of "bogged-down proposals," the most important of
which is 
shingled drives.  A "shingled magnetic recording" (SMR) drive is a rotating
drive that packs its tracks so closely that one track cannot be overwritten
without destroying the neighboring tracks as well.  The result is that
overwriting data requires rewriting the entire set of closely-spaced tracks;
that is an expensive tradeoff, but the benefit — much higher storage
density — is deemed to be worth the cost in some situations.
<p>
At least, the storage industry seems to think it's worth the cost.  Most of
the rest of the industry doesn't seem to be overly interested; to them, SMR
drives just look like more complexity to deal with.  But these drives are
here anyway; they are the most cost-effective path toward larger
capacities.  The question is simply: how much of the resulting ugliness
should be exposed to the system software?
<p>
One option is to treat an SMR drive as if it were a traditional tape drive
with the added benefit of random read access. Christoph liked this idea,
saying it matched how the drives will be typically used: for backups and
such.  It also seems to match the biggest use case for these drives, which
is to store the data which is driving much of the storage industry:
photographs and cat videos.
<p>
Martin Petersen asked if it was worthwhile to do "crazy stuff" in the I/O
stack to support a technology which may be transitional at best.  The
answer was that the constraints that are driving the push to SMR drives
will be around for a while.  Once you start packing your bits closely
enough, it becomes impossible to change them individually.  It was
suggested that solid-state storage could eventually run into similar
problems.  So the problem of SMR drives may be around for longer than
anybody in the room might have liked.
<p>
In any case, as James Bottomley pointed out, Linux has always been friendly
toward experimental technology, even though not all of that technology
makes it out to end users.  Ric Wheeler added that supporting this
technology is good for Linux in the long run.  But, he added, we are likely
to see more use of tiered storage systems in the future where SMR drives
will be hidden behind a layer that provides a more reasonable interface to
the host system.
<p>
<h4>SCSI Express</h4>
<p>
There followed a plenary session ostensibly about SCSI express and the
challenges of handling high-speed devices.  The session was somewhat
scattered, though, and hard to take good notes from.  So, unfortunately,
not much will be reported here.
<p>
One topic that came up during the discussion was the multi-queue block
layer patches that Jens Axboe has been working on for some time.  It is
fair to say that the developers in the room think that, maybe, those
patches have had long enough to mature within Fusion-io and should perhaps
be posted to the wider world.
<p>
Jens agreed that the time had come.  The patches, he said, are in his
linux-block tree, but have not yet made it to any mailing list.  They are
in the form of
a 72-patch series that does some "weird and crazy things"; the work is not
complete, but it does appear to be stable.  The main push is to get drivers
away from using the <tt>make_request()</tt> mechanism when they need to try
for higher performance.  Using <tt>make_request()</tt> allows a driver to
replace much of the block layer, at the cost of having to replicate much of
the logic already found in the block layer.  Driver conversion, he said, is
relatively easy.
<p>
The main barrier to merging the code, he said, was just the need to clean
it up and add a few more features.  James suggested that it should be
posted for merging in the 3.11 cycle; any problems could be fixed up
thereafter.  Jens agreed; he has since <a
href="https://plus.google.com/111643045511375507360/posts/iohyBeoz9Hj">made
his repository available</a> for those who would like to take an early look
at the code.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#SCSI">SCSI</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Shingled_magnetic_recording">Shingled magnetic recording</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2013">Storage, Filesystem, and Memory-Management Summit/2013</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/548116/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor548221"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2013 22:49 UTC (Tue)
                               by <b>bjencks</b> (subscriber, #80303)
                              [<a href="/Articles/548221/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What companies are planning to use these new features? Presumably the "storage industry" isn't going to develop these features without some software that can use them on day one. I thought Linux was the primary target for non-consumer storage these days, but it sounds like the "storage industry" is pretty much throwing this stuff over the wall. Are VMware or Microsoft working more closely with the vendors?<br>
<p>
Also, how many of these features are expected to be in disks, vs. those that are only exposed in SANs? Are some of the features targeted at disks that will be in SANs, but not expected to be used by general purpose OSes?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548221/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor548682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 26, 2013 19:09 UTC (Fri)
                               by <b>RobertCElliott</b> (guest, #90524)
                              [<a href="/Articles/548682/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fusion-io has contributed MySQL InnoDB patches that use atomic writes with vectored I/O (using their own vendor-specific SDK, not standard SCSI commands).  These patches eliminate the need for the doublewrite buffer to survive disruptions during writes.<br>
<p>
Atomic writes are a natural fit for SSDs (which never write in place), plausible for RAID controllers with non-volatile caches (with SSDs or HDDs on the back-end), but unlikely for HDDs themselves.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor548249"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2013 3:53 UTC (Wed)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/548249/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  SBC-4 devices would be guaranteed to support the full (reduced) command set and nothing more, eliminating a lot of special-case code.</font><br>
<p>
yeah right.<br>
<p>
A standard that can never be extended, how long is _that_ going to last.<br>
<p>
I predict that within a year of the first SBC-4 devices being released, someone will release something that is 'based on SBC-4' but with some new feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548249/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor548254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2013 5:26 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/548254/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's fine, as long as the basic set is supported. Then we can have SBC-5 in a couple of years with new "must-have" features.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor548255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2013 5:34 UTC (Wed)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/548255/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, one of the explicit goals of SBC-4 is to eliminate all optional and proprietary commands. That's why they say "and nothing more"<br>
<p>
This also makes it impossible for there to ever be backwards compatibility with this standard, by definition, anything that includes even one additional command is not in compliance with this standard<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor548687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 26, 2013 19:23 UTC (Fri)
                               by <b>RobertCElliott</b> (guest, #90524)
                              [<a href="/Articles/548687/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The SBC-4 standard will continue to collect new features as they are invented.  Each feature set picks a subset of the full standard.  Devices can also implement features not defined in their advertised feature sets.<br>
<p>
Features can be added to a feature set over time; a version number will be incremented when this is done.  That avoids breaking older software, which may rely on anything in the version of the feature set to which it was designed.  <br>
<p>
Removal of a feature requires defining a new feature set, since that could break older software.  If some command becomes uninteresting, devices would implement it as a NOP to maintain software compatibility rather than return errors.<br>
<p>
It's not perfect, but we hope this will be simpler for software to manage than worrying about every individual bit and field.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor548250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2013 4:11 UTC (Wed)
                               by <b>axboe</b> (subscriber, #904)
                              [<a href="/Articles/548250/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Jens agreed; he has since made his repository available for those who would like to take an early look at the code.</font><br>
<p>
To be fair, the code has always been available in the public, it was always sitting in my public git repository.<br>
<p>
After posting that story on G+, I have cleaned up and collapsed the patch series. So should be easier to look over now, without all the messy history.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor548384"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LSFMM: A storage technology update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 25, 2013 1:29 UTC (Thu)
                               by <b>smcameron</b> (guest, #90522)
                              [<a href="/Articles/548384/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If anybody wants to look at the SCSI Express driver it is here:<br>
<a href="https://github.com/HPSmartStorage/scsi-over-pcie">https://github.com/HPSmartStorage/scsi-over-pcie</a><br>
<p>
There are actually two drivers, a SCSI driver and a block driver.  The block driver performs decently, and uses the make_request_fn interface.  The SCSI driver performs, uh, less decently, and uses the conventional SCSI driver interface, and hasn't been worked on since December or so.  The block driver is still a work in progress, but it's mostly there.  The design of the block driver is very similar to that of the nvme driver -- lots of per-cpu stuff to avoid contention and increase parallelism.<br>
<p>
-- steve<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/548384/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
