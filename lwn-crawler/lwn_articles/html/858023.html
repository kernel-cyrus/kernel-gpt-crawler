        <!DOCTYPE html>
        <html lang="en">
        <head><title>Auditing io_uring [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/858023/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/858156/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/858023/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Auditing io_uring</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>June 3, 2021</br>
           </div>
The <a href="/Articles/776703/">io_uring subsystem</a>, first introduced in
2019, has quickly become the leading way to perform high-bandwidth,
asynchronous I/O.  It has drawn the attention of many developers, including,
more recently,
those who are focused more on security than performance.  Now some members
of the security 
community are lamenting a perceived lack of thought about security support in
io_uring, and are trying to remedy that shortcoming by adding audit and
Linux security module support there.  That process is proving difficult,
and has raised the prospect of an unpleasant fallback solution.
<p>
The Linux <a
href="https://man7.org/linux/man-pages/man8/auditd.8.html">audit</a>
mechanism allows the monitoring and logging of all significant activity on
the system.  If somebody wants to know, for example, who looked at a
specific file, an audit-enabled system can provide answers.  This
capability is required to obtain any of a number of security certifications
which, in turn, are crucial if one wants to deploy Linux in certain types
of security-conscious settings.
It is probably fair to say that a relatively small percentage of Linux
systems have auditing turned on, but distributors, almost without
exception, enable auditing in their kernels.
<p>
The audit mechanism relies, in turn, on a large array of hooks sprinkled
throughout the kernel source.  Whenever an event that may be of interest
occurs, it is reported via the appropriate hook to the audit code.  There,
a set of rules loaded from user space controls which events are reported
to user space.

<p>
When io_uring was being developed (which is still happening now, of
course), the developers involved were deeply concerned about performance
and functionality.  Supporting security features like auditing was not at
the top of their list, so they duly neglected to add the needed hooks â€” or
to think about how auditing could be supported in a way consistent with the
performance goals.  Now that io_uring is showing up in more distributor
kernels (and, in particular, the sorts of kernels where auditing is
relatively likely to be enabled), security-oriented developers are starting
to worry about it.  Having io_uring serve as a way to circumvent the
otherwise all-seeing audit eye does not seem like a good way to maintain
those security certifications.
<p>
<h4>Adding security support</h4>
<p>
In late May, Paul Moore (a maintainer of the audit subsystem) posted <a
href="/ml/linux-fsdevel/162163367115.8379.8459012634106035341.stgit@sifl/">a
set of patches</a> adding Linux security module (LSM) and audit
capabilities to io_uring.  The LSM side is relatively straightforward; the
operations performed by io_uring are already covered by LSM hooks, so all
that was needed was a pair of new hooks to pass judgment on
io_uring-specific actions.  Specifically, these hooks control the sharing
(between processes)
of credentials that are stored with the ring buffer that is used to
communicate operation 
requests to the kernel; see <a
href="/ml/linux-fsdevel/162163382536.8379.3124023175473604584.stgit@sifl/">this
patch</a> for details.  This part of the patch set does not seem to be
controversial.
<p>
The audit code is another story.  The core io_uring code has been carefully
optimized to dispatch requests and their results as quickly as possible.
Use cases for io_uring can involve performing millions of I/O operations
per second, so any added overhead will prove most unwelcome.  Adding the
audit hooks to cover operations submitted through the ring slowed down one
of the
most performance-critical parts of io_uring, leading Pavel Begunkov to <a
href="/ml/linux-fsdevel/f07bd213-6656-7516-9099-c6ecf4174519@gmail.com/">react
negatively</a>: "<q>So, it adds two if's with memory loads
(i.e. current-&gt;audit_context) per request in one of the hottest functions
here... No way, nack</q>".
<p>
Begunkov suggested that perhaps the audit hooks could be patched in at run
time when they are actually enabled, the way tracepoints and kprobes work.
Moore <a
href="/ml/linux-fsdevel/CAHC9VhRjzWxweB8d8fypUx11CX6tRBnxSWbXH+5qM1virE509A@mail.gmail.com/">responded</a>
that the audit subsystem doesn't support that sort of patching, and that
doing so could raise problems of its own: "<q>I fear it
would run afoul of the various security certifications</q>".  So that
does not appear to be the route to a possible solution.
<p>
Meanwhile, Jens Axboe, the io_uring maintainer, <a
href="/ml/linux-fsdevel/9e69e4b6-2b87-a688-d604-c7f70be894f5@kernel.dk/">ran
some tests</a>.  A simple random-read test slowed down by nearly 5% with
the audit hooks installed, even in the absence of any actual audit rules.
Various other benchmarks, even when run with an updated version of the
patch set (which was not posted publicly), gave the same results.  Kernel
developers can work for months for a 5% performance gain; losing that
amount to audit hooks is a bitter pill for them to swallow.

<p>
Axboe pointed out that read and write operations are not audited
when they are initiated through the older asynchronous I/O system calls.
"<q>In the past two decades, I take it that hasn't been a
concern?</q>"  He agreed that some operations (such as opening or
removing files) should be audited, but said that auditing read and write
operations was "<q>just utter noise and not useful at all</q>".
Since those operations are the ones where performance matters the most,
taking the audit hooks out of the fast path for them might be a possible
solution.
<p>

Moore <a
href="/ml/linux-fsdevel/CAHC9VhRZEwtsxjhpZM1DXGNJ9yL59B7T_p2B60oLmC_YxCrOiw@mail.gmail.com/">suggested</a>
an approach based on that idea; only a specific, carefully chosen set of
operations would have the audit hooks applied.  There is a handy
<tt>switch</tt> statement in the io_uring dispatcher that makes it easy to
instrument just the desired operations.  He asked for feedback, but
has not gotten much so far.  The important question, as Begunkov <a
href="/ml/linux-fsdevel/94e50554-f71a-50ab-c468-418863d2b46f@gmail.com/">pointed
out</a>, is which operations in particular need audit support.  Adding an
audit call when opening a file is unlikely to bother anybody; a call added
to, say, a poll operation would be another story.  Moore has posted <a
href="/ml/linux-fsdevel/CAHC9VhS7Vhby4YR94U2YOwMtva-rc=_ifRcZYi1YVPwfi+Xuzg@mail.gmail.com/">an
initial set of operations</a> that he thinks merit auditing.

<p>
<h4>Threats and grumbles</h4>
<p>
With luck, that solution will prove acceptable to everybody.  The
alternative to adding audit support to io_uring is, <a
href="/ml/linux-fsdevel/CAHC9VhTS_Yt0PzG_WjsgUA04inHa=N8+OjWju9waefP==Di39A@mail.gmail.com/">according
to Moore</a>, not particularly pleasant:
<p>
<blockquote class="bq">
	If we can't find a solution here we would need to make io_uring and
	audit mutually exclusive and I don't think that is in the best
	interests of the users, and would surely create a headache for the
	distros.
</blockquote>
<p>
"Headache" is not really the word for it.  If the two features are made
exclusive, then it will not be possible to configure a kernel containing
both of them.  So distributors would have to either ship two different
kernels (something they will go far out of their way to avoid) or pick one
of the two features to support.  Hopefully it will not come to that.
<p>
Meanwhile, there has been some disgruntlement expressed by developers on
both sides, but the security developers have made it especially clear that
they would have liked to see audit designed into io_uring from the
beginning.  As Casey Schaufler <a
href="/ml/linux-fsdevel/cba563e3-60da-3edf-e5fe-e409415ce3cc@schaufler-ca.com/">put
it</a>:
<p>
<blockquote class="bq">
	It would have been real handy had the audit and LSM requirements
	been designed into io_uring. The performance implications could
	have been addressed up front. Instead it all has to be retrofit.
</blockquote>
<p>
Richard Guy Briggs also <a
href="/ml/linux-fsdevel/20210528223544.GL447005@madcap2.tricolour.ca/">complained</a>
that "<q>multiple aspects of security appear to have been a complete
afterthought to this feature, necessitating it to be bolted on after the
fact</q>".  The implication in both cases is that, with adequate
forethought, the difficulties being encountered now could have been
avoided.
<p>
That is arguably a fair criticism.  Kernel developers working on new
features often leave security as something to be thought about later; that
is especially true for relatively niche features like auditing, which is
unlikely to be enabled on development systems.  The kernel community can be
a bit unfriendly toward its security developers, characterizing them as
prioritizing security above anything else (and above performance in
particular).  Such an environment seems like a recipe for leaving security
concerns by the wayside, to be fixed up later.
<p>
It is also fair to point out, though, that io_uring has been developed in
public since early 2019.  It has been heavily discussed on the mailing
lists (and in LWN), but the security community did not see that as their
cue to make suggestions on how features like auditing could be supported.
It is a rare kernel developer who can summon the focus to implement a
million-operation-per-second I/O subsystem while simultaneously making
provisions for security hooks that won't kill performance.  Perhaps the
io_uring developers should have been considering security from the
beginning, but they should also have had help from the beginning.
<p>
The kernel community has surprisingly few rules regarding the addition of
new features like io_uring.  In theory, new system calls should come with
manual pages, but it's somewhat surprising when that actually happens.  In
a project with a more bureaucratic process, it would make sense to insist
that new features do not go in until they have proper support for mechanisms
like LSM and auditing.  That might force earlier interactions with security
developers and avoid this kind of problem.
<p>
That is not the world that we live in, though; there is nobody with a
checklist making sure that all of the relevant boxes have been marked
before a new subsystem can be merged.  So the kernel community will have to
continue to muddle along, supporting the needed features as best it can.
This is not the last time that a security mechanism will have to be
retrofitted into an existing kernel feature.  It's arguably not the best
approach, but it generally gets the job done in the end.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Auditing">Auditing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#io_uring">io_uring</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#io_uring">io_uring</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/858023/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor858216"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2021 19:13 UTC (Thu)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/858216/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW, this is the kind of thing that leads people to say things like &quot;The kernel is too slow at FOO; I did a prototype in userspace and it was eleventy-bajillion percent faster!&quot;<br>
<p>
Having worked on one or two of these projects, my first response is &quot;What functionality did your prototype leave out to achieve that speedup, are real users actually ok without those features, and can we make those features optional in the current implementation?&quot;<br>
<p>
Yeah, audit support is slow. But it&#x27;s also mandatory in some environments.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858216/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858223"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2021 20:46 UTC (Thu)
                               by <b>JanC_</b> (guest, #34940)
                              [<a href="/Articles/858223/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      But how many would need both hyper-detailed audit support <em>and</em> hyper-fast I/O?
      
          <div class="CommentReplyButton">
            <form action="/Articles/858223/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858224"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2021 20:50 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/858224/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A database server with important information might want fast IO and good security/auditing support. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858224/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2021 22:05 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/858235/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems unlikely that kernel level audit support for individual read/write operations would be useful for a database server. The audit information wouldn&#x27;t contain enough context (which client, how did they authorize, what statement), and the audit operations would often end up far from the user actions due to the database buffer pools. Including IO potentially happening in different processes/threads from the user action. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2021 23:04 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/858248/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Typically you want audit for other stuff, to detect and trace intrusions into the overall system.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor859541"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2021 0:27 UTC (Mon)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/859541/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
a huge percentage of users. SELinux depends on AUDIT, and basically all managed linux systems have that on. All Fedora, Red Hat, and Ubuntu systems have either SELinux or AppArmor turned on by default, with various levels of enforcement and permissiveness in their settings.<br>
<p>
I doubt anyone really needs audit support for async reads and writes but lacking file open and close operations would add a pretty trivial way around selinux.<br>
<p>
Further the whole point of selinux is defense in depth should some application get compromised, and there are lots of applications that are network accessible and require fast IO, or want async IO that has the model of io_uring.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/859541/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor859677"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2021 16:18 UTC (Mon)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/859677/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If it were possible to have both at the same time, MS Windows probably wouldn&#x27;t be as miserably slow as it is with active antivirus scanners that intercept file ops. That&#x27;s a problem they&#x27;ve been saddled with for an extremely long time and not for lack of resources.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/859677/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor860360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2021 0:23 UTC (Mon)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/860360/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Someone who wants auditting won&#x27;t be happy if it can be circumvented using different system calls.<br>
Everyone cares about performance sometimes, even those audit crazy types, so the best solution is to make auditting low over head.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/860360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor858350"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 14:52 UTC (Fri)
                               by <b>jbarns231</b> (guest, #152627)
                              [<a href="/Articles/858350/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Large scale customers I worked for in the past I saw flamegraphs where they had audit on with a number of rules. Man.. audit took ~80% of the cycles that were needed for the syscall and ~20% just for the actual logic. If you can just turn it off by default and opt-in globally the speedup is really immense. No wonder people complain kernel is too slow. Because of regulations or whatever the argument is here is &lt;1% of kernel users.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858350/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor858243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2021 22:39 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/858243/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems to me that people should push harder on the code-patching approach. The objections to it amount to &quot;might be a problem&quot;. Well, find out if it IS a problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 0:35 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/858254/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Itâ€™s a fascinating idea, actually, with potentially a lot of benefit for expensive (and commonly disabled) security checks anywhere they exist.  I hope it resurfaces.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor858274"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 8:48 UTC (Fri)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/858274/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, in case adding audit hooks at runtime really is a problem for certification - removing them when they aren&#x27;t needed seems like it can&#x27;t possibly be an issue. You want to make sure they&#x27;re never disabled? Just don&#x27;t load/install/compile the module that removes them. <br>
<p>
This seems like it&#x27;s mostly the same situation we have now, just the runtime patcher module is something an attacker needs to bring/write instead of it being bundled with the kernel. And when an attacker can load kernel modules, you&#x27;ve already lost anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858274/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor858259"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 1:58 UTC (Fri)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/858259/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Runtime code patching *is* the answer here, sorry. Static keys work fine. What *exactly* is the security concern behind runtime code patching to enable audit rules?<br>
<p>
It seems to me like the opposition there is just more &quot;it sounds scary, so no way&quot; FUD-based superstition. Runtime code patching works fine and has worked fine for many years. I can&#x27;t think of a single good reason that the audit subsystem is too precious for it. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858259/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858290"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 13:35 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/858290/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A very good variation was suggested above:<br>
<p>
Patch *out* auditing at runtime, if not having it compiled in gives certification people the willies.  (Now if weâ€™re opposed to that, we have to ask ourselves why...  and if the security certification people arenâ€™t being so crazy after all.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858290/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor858353"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 15:59 UTC (Fri)
                               by <b>Nahor</b> (subscriber, #51583)
                              [<a href="/Articles/858353/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My bikeshed guess is that they don&#x27;t want the attacker to be able to disable the audit. Patching out would not solve that problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858353/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858386"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 19:03 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/858386/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What do they imagine would stop the attacker from loading a module of their own to patch out the audit code?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858386/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858398"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 20:05 UTC (Fri)
                               by <b>Nahor</b> (subscriber, #51583)
                              [<a href="/Articles/858398/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was thinking that with patching out disallowed, the kernel could be made read-only by the bootloader, but I guess people who care about auditing could still make the kernel RO anyway, while other keep the kernel RW and can patch out the auditing code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858398/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 20:46 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/858409/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am not sure about all other hardware but on x86 I am fairly sure that the only way to make kernel memory truly read-only is with a hypervisor enforcing it. Otherwise anything running at the kernel level can set it read-write again. <br>
<p>
This is what Windows does with the Core Isolation setting, which uses Hyper-V to protect the kernel and selected drivers even from other driver code.<br>
<p>
So I suppose that if you have a boot loader which can set up and configure a virtual machine to load the kernel into then you could have a read-only kernel image.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858412"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 20:54 UTC (Fri)
                               by <b>Nahor</b> (subscriber, #51583)
                              [<a href="/Articles/858412/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
An article about making x86 trustworthy was just mentioned yesterday in the LWN weekly edition (<a href="https://mjg59.dreamwidth.org/57199.html">https://mjg59.dreamwidth.org/57199.html</a>).<br>
<p>
But I&#x27;m guessing the issue of audit an io_uring is not specific to x86 anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858412/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor858278"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 9:28 UTC (Fri)
                               by <b>Freeaqingme</b> (subscriber, #103259)
                              [<a href="/Articles/858278/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m not sure I understand where the slowdown comes from. If it&#x27;s in a hot path, the code is executed a gazillion times. Shouldn&#x27;t the CPU be able to optimize it away pretty quickly using branch prediction?<br>
<p>
I realize branch prediction has been somewhat of a hassle around the kernel (and elsewhere), but I&#x27;d expect it to be quite useful in scenarios like these. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858278/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858286"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2021 12:12 UTC (Fri)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/858286/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The CPU cannot optimize away the comparisons. The audit flag could change in the meantime. What branch prediction does, is to allow the execution to continue while the comparison is done. If the prediction is correct (which it should be almost always), you only have the impact of loading the values and doing the comparison. If the prediction is wrong, the CPU pipeline needs to be flushed (because execution continued in the wrong branch) and you loose many cycles.<br>
<p>
It seems that the slowdown is just because of the overhead of the instructions added to the hot path. However, 5% is really quite much. Either the auditing code is not optimized that much, or the io_uring only has a few instructions on this path. This means that the &quot;real code&quot; only takes 20 times as much time as the auditing code that just has to verify that auditing is indeed turned off.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858286/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor858518"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2021 7:33 UTC (Mon)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/858518/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about exporting the audit events via... io_uring?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858518/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor858939"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Auditing io_uring</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2021 11:07 UTC (Thu)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/858939/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have an example implementation right here, but this eBPF format is too small to contain it.<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/858939/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
