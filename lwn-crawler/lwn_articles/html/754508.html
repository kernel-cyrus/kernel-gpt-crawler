        <!DOCTYPE html>
        <html lang="en">
        <head><title>Case-insensitive filesystem lookups [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/754508/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/754734/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/754508/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Case-insensitive filesystem lookups</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 23, 2018</br>
           <hr>
<a href="/Articles/lsfmm2018/">LSFMM</a>
</div>
<p>
Case-insensitive file name lookups are a feature that is fairly frequently
raised at the Linux 
Storage, Filesystem, and Memory-Management Summit (LSFMM).  At the 2018
summit, Gabriel Krisman Bertazi proposed a new way to support
the feature, though it met with a rather skeptical reception—with one
notable exception.  Ted Ts'o seemed favorably disposed to the idea, in part
because 
it would potentially be a way to get rid of some longstanding Android ugliness:
<a href="/Articles/718640/">wrapfs</a>. 
</p>

<p>
Krisman noted that proposals for case-insensitive lookups show up on the
Linux kernel mailing list periodically.  He has incorporated some of that
work into his proposal, including some <a
href="https://www.spinics.net/lists/xfs/msg30069.html">SGI patches from
2014</a> that implemented Unicode support and case-folding for
XFS.  His <a
href="https://www.spinics.net/lists/linux-ext4/msg59577.html">patches</a>
would add support to the VFS layer with filesystem-specific hooks to
actually do the insensitive hashes and lookups.  
</p>

<a href="/Articles/754536/">
<img src="https://static.lwn.net/images/2018/lsf-bertazi-sm.jpg" border=0 hspace=5 align="right"
alt="[Gabriel Krisman Bertazi]" title="Gabriel Krisman Bertazi" width=210 height=300>
</a>

<p>
The intent is to be able to bind
mount a subtree of a case-sensitive filesystem in a case-insensitive form,
but there are changes needed to the directory entry cache to make it all work.
David Howells asked if there would potentially be different case-folding
functions for each mount point and Krisman indicated there would be.
</p>

<p>
The Android use case is to support the <tt>/sdcard</tt> directory (which
was FAT-based and thus case-insensitive in the early days) on ext4, which is
case-sensitive, of course. Ts'o said that it is a legacy Android
feature that is
"kind of ugly", but he would like to get rid of the out-of-tree hacks
that are currently being used to support it. It is "legacy insanity",
Dave Chinner said.  The bind-mount approach being proposed is the "least
insane way to implement what is, I grant, a somewhat insane thing", Ts'o
said; Android apps expect that behavior and breaking user space is
something that the Android project avoids.
</p>

<p>
Al Viro wanted to know how Krisman's code would handle two different
directory-cache entries (dentries) that had the "same" name but with
different case for some letters.  Krisman said there would be a hash
function that would hash to the same value for names that differ only by
case, so there would be only one dentry per case-insensitive name.  The
exact name with its case preserved would be stored in the dentry, though.
</p>

<p>
A problem comes from negative dentries: assertions that a given
file name does not exist, which are cached when a lookup fails.  He is
proposing a "hard negative dentry" that would assert that there is no file
that would satisfy a case-insensitive lookup.  If the filesystem determines
that there should be a hard negative dentry for a given name, it would
invalidate all but one of the negative dentries for any other case variants.
</p>

<p>
But if there is the ability to have both <tt>foo</tt> and <tt>FOO</tt> on
the disk, which would a lookup return on the case-insensitive side?   That
and a number of other problems with what Krisman is suggesting were
discussed in a rapid-fire round-robin that was difficult to capture.  The
general upshot was that most in the room were fairly skeptical of the approach.
</p>

<p>
Ts'o said that for the Android case, which is much of the reason for the
"case-sensitive and case-insensitive view of the same subtree" use case,
99% of the time the access is through the case-insensitive view.  There
are, however, certain ways to access those files in a case-sensitive way
and some apps are dependent on this behavior.  It would be more sane to
have case-sensitivity be a property of the directory, but it is
not clear to him how much that would break apps in the wild.  He could
start that conversation with the Android team, he said.
</p>

<p>
Chinner said that what XFS has done for case-insensitive file names "may
look stupid and slow", but it is much faster than what Samba is doing.
However, it requires marking a filesystem as being case-insensitive at
<tt>mkfs</tt> time.  A case-insensitive hash is used for the dentries and
there can be no names in the filesystem that only differ by case.
</p>

<p>
Krisman concluded by noting that his code is mostly working at this point,
though there are still some problems.  In particular, there are difficulties
with collisions of positive dentries.  Returning the first dentry found
is unpredictable, so it will return an exact match if it can, but if there
are multiple entries and no exact match, it is not clear what to return.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Case-independent_lookups">Filesystems/Case-independent lookups</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2018">Storage, Filesystem, and Memory-Management Summit/2018</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/754508/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor755397"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 16:04 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/755397/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could get into trouble if foo exists on disk and someone does<br>
<p>
% mv Foo FOO<br>
<p>
Classically, mv(1) works by first linking and then unlinking.  So it would create the name FOO and then ask to unlink Foo.  That would have two possible matches, neither of them exact.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755397/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755414"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 18:25 UTC (Wed)
                               by <b>saffroy</b> (guest, #43999)
                              [<a href="/Articles/755414/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I'm not sure mv(1) behaves like that on Linux nowadays:

<pre>
$ strace mv foo bar

...
stat("bar", 0x7fffffffdd40)             = -1 ENOENT (No such file or directory)
lstat("foo", {st_mode=S_IFREG|0644, st_size=0, ...}) = 0
lstat("bar", 0x7fffffffda10)            = -1 ENOENT (No such file or directory)
rename("foo", "bar")                    = 0
...
</pre>

But apps are certainly allowed to do link+unlink, and it should work reliably (ie. for a case-insensitive mount the link call should fail with EEXIST).
      
          <div class="CommentReplyButton">
            <form action="/Articles/755414/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755709"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2018 9:29 UTC (Sat)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/755709/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
rename() backing mv has been standard for at least two decades.  I'm only familiar with things like solaris, freebsd, linux, os x, at this level.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755709/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor755406"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 17:05 UTC (Wed)
                               by <b>EdwardConnolly</b> (guest, #123865)
                              [<a href="/Articles/755406/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would someone familiar with the issue mind reminding folks like me of the details revolving around case-insensitive lookups in filesystems? I realize this is long standing issue but I can't for the life of me remember exactly what the issue/challenge is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755406/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755410"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 18:09 UTC (Wed)
                               by <b>saffroy</b> (guest, #43999)
                              [<a href="/Articles/755410/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Different environments have different expectations regarding case sensitivity for names of files and directories on a filesystem. I wasn't aware of the situation with Android mentioned in the article, but I do know about the issue with Linux-based SMB servers.<br>
<p>
The most commonly used network filesystem in the Windows and Mac worlds is now SMB (Apple deprecated its own AFP file service a few years ago), and these environments (applications, tools) expect file names to be case insensitive, that is: in any given directory, "foo" and "FOO" and "Foo" must resolve to the same file (if they resolve to any file at all). Another expectation is that the filesystem be case preserving: if the application creates file "Foo", it is expected to show up as "Foo" (and not "foo" or "FOO") in a directory listing.<br>
<p>
But of course, in Unix tradition, a Linux filesystem is case sensitive.<br>
<p>
To meet these expectations, a Linux-based SMB server (Samba) running on a case-sensitive Linux filesystem needs to do extra work which can badly impact performance. For example, when creating "Foo", Samba needs to check if *any* variant of "[fF][oO][oO]" already exists; typically, this is done by scanning the entire directory, which becomes horribly expensive when that directory is large (think thousands of entries). This is pretty bad. And some SMB clients (such as the MacOS Finder) make things worse by their specific quirks (Appledouble files come to mind).<br>
<p>
If the underlying filesystem were case insensitive (and case preserving), Samba would have much less work to do in many cases. And actually, some filesystem vendors (eg. IBM for GPFS) provide Samba modules that reduce the impact when possible: the filesystem can be made case-sensitive (entirely, or per directory), and/or its Samba module can provide an optimized case-insensitive lookup method that bypasses the VFS.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755410/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755435"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 21:15 UTC (Wed)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/755435/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even more difficult, the notion of case depends on the locale.<br>
<p>
E.g.: In English, i and I are the same letter with different case. In Turkish, they are entirely different letters, and thus should not compare equal.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755435/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 21:27 UTC (Wed)
                               by <b>saffroy</b> (guest, #43999)
                              [<a href="/Articles/755438/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Indeed, locale matters, and this means the definition of case also depends on the character encoding.

<p/> Unicode case folding does simplify things, but AFAIK the Turkish "i" still requires some special care (see <a href="http://www.i18nguy.com/unicode/turkish-i18n.html">this page</a> for a detailed explanation).

      
          <div class="CommentReplyButton">
            <form action="/Articles/755438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755686"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 18:58 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/755686/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
There's really only a single choice for doing case-insensitive names: rely on Unicode case-folding rules. It's the only choice because it's the only one, AFAIK, with an <a href="http://www.unicode.org/policies/stability_policy.html#Case_Folding">explicit guarantee regarding forward stability</a>:

<blockquote>
For each string S containing characters only from a given Unicode version, toCasefold(toNFKC(S)) under that version is identical to toCasefold(toNFKC(S)) under any later version of Unicode.
</blockquote>
</p>

<p>
Backward compatibility--mounting a volume created on a system supporting Unicode X-1 that was created on a system supporting Unicode X-- is problematic but I don't think that's entirely avoidable.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/755686/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755456"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 4:32 UTC (Thu)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/755456/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This natural language issue is a very good argument for case-sensitive file systems, or rather, file systems that simply accept (almost) arbitrary strings as names, and do not try to find equivalences between them other than comparing the bytes. I hope adding case-insensitivity support to Linux does not result in people actually starting to use it for anything else than handling legacy compatibility.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755456/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor755461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 6:36 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/755461/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is true, but for the purposes of filenames, does it really matter? Technically SS and “beta S” are different in German but they can also be interchanged some of the time. Surely a filesystem that treated I-with-dot and I-without-dot the same (while preserving what was input) would be good enough in practice. A spell checker has to be stricter. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 7:23 UTC (Thu)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/755464/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's good enough in practice for you, but it would not necessarily for someone else.<br>
<p>
Would you be content with a filesystem that said v and w is the same (but preserved with one was used), if someone came to you and proposed that? I mean, in practice it might be good enough…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755476"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 9:32 UTC (Thu)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/755476/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We can also make "s" and "z" the same for the bennefit of all our britton friends out there...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755476/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor755481"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 10:34 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/755481/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I mean is, the more you get into these distinctions, the further away you move from what makes case sensitivity useful to start with.  I appreciate the convenience of having a file called Sandia.txt on disk and being able to load it by the name sandia.txt, so I can save the effort of pressing the shift key or remembering exactly what the capitalization was.  I would appreciate less getting a file not found error because it was called Sandía.txt and I forgot to include the accent on the letter i.  But then, in Turkish the distinction between i and ı is probably a lot stronger than the difference of an accent in Spanish.<br>
<p>
All in all it's a knottier problem than it appears (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=202251">https://bugzilla.mozilla.org/show_bug.cgi?id=202251</a> has been going on for 15 years) and I sympathize with the view that these things should be handled in the user interface, not the filesystem.  If you have to put locale code in the filesystem itself you've surely taken a wrong turning.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755481/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 17:45 UTC (Thu)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/755564/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I sympathize with the view that these things should be handled in the user interface, not the filesystem. If you have to put locale code in the filesystem itself you've surely taken a wrong turning.</font><br>
<p>
In many cases, I think filenames really are a UI concept that is being used directly as a core part of the filesystem (the disk format plus the associated APIs and protocols like SMB), which feels like a serious layering violation. When a user saves a document, they give it a human-readable name so they can find it later in a list of all their saved documents. They don't care if it's stored with that name as its filename, or if it's stored as "cff5f247-64bd-4066-ab2f-66ff8aed2322.doc" and the name is in some metadata, or if it's stored in a special database and not as a separate file at all - the UI could be the same for all of those. But since we choose to implement it with human-readable filenames, the UI is complicated by filesystem restrictions (why can't the user put "/" in a document name?), and the filesystems(/APIs/protocols/etc) are complicated by UI issues (Unicode, case sensitivity, locale dependence, etc). It seems particularly bad given that Unicode changes over time, and locales differ between users, while filesystems are persistent and shared - there's a fundamental mismatch there.<br>
<p>
Surely there must be a better way to design the system, if legacy compatibility didn't matter, where the implementation details of storing and referencing files are more cleanly separated from the UI concept of naming files? (Though of course legacy compatibility does matter more than almost anything else, so this is hypothetical and probably pointless.)<br>
<p>
(There are other cases where filenames aren't UI, they're well-known identifiers like "/etc/passwd" or "c:\autoexec.bat" - the name is needed as a portable way for programs to refer to a particular file. But they have very different requirements to user-chosen document names, e.g. ASCII is probably fine, and it's not obvious that the same solution should be used for them.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 19:03 UTC (Fri)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/755687/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Surely there must be a better way to design the system, if legacy compatibility didn't matter, where the implementation details of storing and referencing files are more cleanly separated from the UI concept of naming files?</font><br>
<p>
Since Unix files can be arbitrary strings then just use a hash of the file to store it in the file system.  Then you manage names on the application layer by providing a handy dandy API for everybody to use. <br>
<p>
Because just imagine that instead of one locale you have to make insensitivity work for ALL locales.  A lot of Linux file systems house data that is globally sourced using languages and names from dozens, if not hundreds, of different languages. <br>
<p>
Good luck making that work on a file-system layer.<br>
<p>
I mean: what are you going to do?   <br>
<p>
To have any remote chance of making it work in a case sensitive manner is by having the locale of each file embedded right there in the file system's metadata so it can be correctly managed in the way it was intended.   And then what are you going to do when you have a English user from North America edit a file somebody made from Greece?  Change the locale?  Make the insensitivity work differently or now force the English user to understand the character set used by the other person from Greece?  How are you going to deal with file names that don't conflict in the original locale, but do after somebody edits it? <br>
<p>
<p>
So the choice is really: <br>
<p>
1. Have a case sensitive file system that always works under all circumstances that is simple, robust, and fast. <br>
<p>
2. Have a case insensitive system with massive amounts of extra code and logic that will never actually have a chance of working. <br>
<p>
<p>
<p>
YES; having a sensitive file system is a bad UI.   But it's impossible to make it actually work otherwise.  <br>
<p>
Therefore:  If you are looking for a very good user interface exposing a Unix-style file system to the user is not a good solution.  You have to do something else. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2018 15:48 UTC (Sat)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/755714/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <i> But then, in Turkish the distinction between i and ı is probably a lot stronger than the difference of an accent in Spanish.</i>
<p>
I don't know how it is in Turkish, but in my native Finnish you cannot be careless with dieresis on top of "a" or "o". Dropping it can change a word into a different word. For example, "sää" and "saa" are both valid Finnish words with entirely different meanings. Of course, humans usually can figure out words with omitted dots from context, the same way one can mentally correct other kinds of mis-spellings.
<p>
By the way, someone jokingly mentioned making "v and "w" equivalent. Actually the normal alphabetical ordering rules of Finnish specify precisely that. However, Linux "ls", "bash" and so on under the Finnish locale does not obey this particular rule. Probably a good thing, I won't be filing a  bug report...

      
          <div class="CommentReplyButton">
            <form action="/Articles/755714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755730"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2018 9:39 UTC (Sun)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/755730/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even in English the difference of upper and lower case can change one word to another, from polish to Polish.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755730/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor755610"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 8:50 UTC (Fri)
                               by <b>MarcB</b> (subscriber, #101804)
                              [<a href="/Articles/755610/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One pretty glaring issue is, that native Linux filesystems do not use any defined character set for file names, i.e. file names are essentially binary keys without any semantics (with the exception of the 0-Byte and the ASCII-encoding of /). So technically, the notion of "case" does not even exist in Linux filesystems. Also, Linux filesystems do not "support Unicode", they merely tolerate it (as long as the uses Unicode encoding does not produce 0-Bytes). This allows you to do horrible things, like creating files with identical names (after decoding) but different encoded representations.<br>
<p>
Now, in practise you can ignore this, if you can enforce that all file name operations must go through some layer that enforces sanity - like the Samba server, or the mentioned "wrapfs" or some higher level API. But as soon as applications can do direct syscalls, things get weird again.<br>
<p>
So, the first problem is defining what case even means. After that is solved, you are faced with the complexity, that "saffroy" explains.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755610/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755547"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 15:09 UTC (Thu)
                               by <b>hkario</b> (subscriber, #94864)
                              [<a href="/Articles/755547/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
not only there is problem of different locales that consider different codepoints to be the same letters (already mentioned Turkish is common example)<br>
but filenames are quite explicitly NOT unicode, they don't even have to be printable characters, in any encoding!<br>
<p>
how do you handle case comparison for a file that has a name that is broken UTF-8?<br>
<p>
what if the files were written on system that used ISO-8859-2 codepage? Let alone one of the CJK systems?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755547/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755611"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 9:16 UTC (Fri)
                               by <b>MarcB</b> (subscriber, #101804)
                              [<a href="/Articles/755611/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly. Before you can start with case-insensitive lookups, you first need a definition of what case even means. And currently, Linux filesystems do *not* have this. Those semantics only exist on the application level - and nothing on a stock Linux system is forcing applications to be consistent about those semantics.<br>
<p>
I haven't found any detailed information of Android's "wrapfs", but I assume it does more than just providing case-insensitive lookups. Likely it also enforces an encoding and perhaps even a Unicode normalization.<br>
<p>
If case-insensitive lookups are added, what is preventing a bad or careless actor from creating "duplicate" files, perhaps "superseding" the original file? (But this is already possible in Linux today, as no Unicode normalization is enforced, i.e. you can have files using different UTF-8 encodings of the same decoded string in the same directory).<br>
<p>
Either you rely on some sanitization layer on top of the filesystem through which every access must pass, or you add new, stricter versions of all syscalls dealing with filenames.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755611/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 20:17 UTC (Fri)
                               by <b>saffroy</b> (guest, #43999)
                              [<a href="/Articles/755697/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To give further support to the idea of supporting case insensitive names:<br>
<p>
FWIW in my day job I work on a proprietary userland distributed filesystem, to which I did add support for case insensitivity (per directory), in order to improve performance with Samba (see my other comment on Samba having to scan large directories).<br>
<p>
It works pretty well, using libicu to do Unicode case folding. This means indeed that the file names are then restricted to valid UTF-8 strings (this includes all ASCII strings), which in practice isn't a very annoying restriction for us, considering that we enable case insensitivity when serving through Samba, and Samba itself already converts incoming file names to UTF-8.<br>
<p>
I see some comments arguing that this complexity should be pushed to the UI: well, it's easier said than done, and anyone trying to do this ends up reimplementing a filesystem if they want the result to be even moderately efficient. Therefore, there is real value in having Linux filesystems that support case insensitivity.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755710"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2018 9:51 UTC (Sat)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/755710/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem with making the filesystem 'smart' is that the applications which use the filesystem must be able to understand the smartness.  In other words, making interacting with files complicated to achieve complicated user goals will introduce bugs across all programs.  <br>
<p>
I can't tell you the number of awful hacks I've had to do in order to deal with the strange behavior of OS X, where the filename you use to create a file is not guaranteed to be the filename of the file later.  Putting this level of intelligence into the raw filesystem interface usually leads to these kinds of problems.<br>
<p>
One thing is for sure, if you want to go down this road, filenames will have to have explicit encoding and locale info.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755710/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2018 8:37 UTC (Tue)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/755855/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The problem with making the filesystem 'smart' is that the applications which use the filesystem must be able to understand the smartness. </font><br>
<p>
It's worse than that. Some applications will need to be able to *undo* the smartness. It doesn't need to be said that this is hell, if not plainly impossible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor758766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Case-insensitive filesystem lookups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 1, 2018 7:07 UTC (Sun)
                               by <b>mmjo</b> (guest, #55791)
                              [<a href="/Articles/758766/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just an idea.<br>
<p>
Couldn't extended attributes be used to store encoding, language and a display-name?<br>
Together with mount option(s); indicating what to do with these attributes and providing defaults.<br>
<p>
Though this would then be limited to filesystems supporting extended attributes (mainly ext{2,3,4} and XFS).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/758766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
