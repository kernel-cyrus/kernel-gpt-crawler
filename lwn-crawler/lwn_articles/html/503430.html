        <!DOCTYPE html>
        <html lang="en">
        <head><title>printk() problems [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/503430/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/502982/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/503430/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>printk() problems</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>June 26, 2012</br>
           </div>
The <a href="/Articles/492125/">record-oriented logging patch set</a> was
pulled into the mainline during the 3.5 merge window.  These changes are
meant to make the processing of kernel messages generated by
<tt>printk()</tt> and friends more reliable, more informative, and more
easily consumed by automatic systems.  But recently it has turned out that
these changes make <tt>printk()</tt> less useful for kernel developers.
Now there is some uncertainty as to whether this feature can be repaired in
time, or whether it will be reverted back out of the 3.5 release.
<p>
One of the core design features of the new <tt>printk()</tt> is a change
from byte-streamed output to record-oriented output.  Current kernels can
easily corrupt messages on their way to the log; for example, when the log
buffer overflows, the kernel simply wraps around and partially overwrites
older messages.  Messages from multiple CPUs can also get confused,
especially if one or more CPUs are using multiple <tt>printk()</tt> calls
to output a single line of text.  The switch to the record-oriented
mechanism eliminates these problems; it also makes it possible to attach
useful structured information to messages.  As a whole, it looks like a
solid improvement to the kernel logging subsystem.
<p>
There is just one little problem, though: when the kernel outputs a partial
message (by passing a string to <tt>printk()</tt> that does not end with a
newline), the logging system will buffer the text until the rest of the
message arrives.  The good news is that this buffering causes the full line
to be output together once it's completeâ€”if things go well.  The situation
when things do not go well was best <a
href="/Articles/503444/">summarized</a> by Andrew Morton:
<p>
<div class="BigQuote">
	If a driver does
<p>
<pre>
	printk("testing the frobnozzle ...");
	do_test();
	printk(" OK\n");
</pre>
<p>
	and do_test() hangs up, we really really want the user to know that
	there was a frobnozzle testing problem.  Please tell me this isn't
	broken.
</div>
<p>
Not only is this behavior now broken, but it has also burned at least one
developer who ended up spending a lot of time trying to figure out why the
kernel was hanging.  Kernel developers depend heavily on <tt>printk()</tt>,
so this change has caused a fair amount of concern.  
<p>
Bugs happen, of course; the important thing is to fix them.  A number of
possible fixes have been discussed on the list, including:
<p>
<ul>
<li> Leave <tt>printk()</tt> as it is, and change specific callers to
     output only full lines.  Kay Sievers, the author of the
     <tt>printk()</tt> changes, <a href="/Articles/503455/">suggested</a>
     that approach, saying "<q>We really should not optimize for
     cosmetics (full lines work reliably, they are not buffered) of
     self-tests, for the price of the reliability and integrity of all
     other users.</q>"
<p>
<li> Adding a <tt>printk_flush()</tt> function to be called in places where
     it is important to see partial lines even if things go wrong before
     the newline character is printed.  The problem with this approach is
     that, like printing full lines only, it requires changing every place
     in the code where the problem might hit.  Experience says that many of
     those places can only be found the hard way.
<p>
<li> Add a global knob by which buffering can be turned on or off; this
     knob might be set by either user space or the kernel.  This idea was
     not particularly popular; it seems unlikely that the knob will be set
     for unbuffered output when it really matters.
<p>
<li> Simply revert the <tt>printk()</tt> changes for 3.5 and try again for
     3.6 or later.  Ingo Molnar posted <a href="/Articles/503456/">a
     patch</a> to this effect, seemingly as a way of pressuring Kay
     to take the problem more seriously.
</ul>
<p>
As of this writing, most of the discussion centers around <a
href="/Articles/503457/">this patch from Steven Rostedt</a> which simply
removes the buffering from <tt>printk()</tt>.  For the most part, the
advantages of the new code remain.  But it is now possible that a single
line of output created with multiple <tt>printk()</tt> calls may be split
into multiple lines, with messages from other CPUs mixed in between.  It
seems to many to be a reasonable compromise fix.
<p>
Except that Kay still <a href="/Articles/503458/">doesn't like</a> the splitting
of continuation lines.  Andrew Morton is also <a
href="/Articles/503459/">concerned</a> about where the <tt>printk()</tt>
code is going, saying "<q>The core printk code is starting to make one
think of things like 'cleansing with fire'.</q>"  Steven, meanwhile, is
<a href="/Articles/503461/">reconsidering</a> the whole thing, saying that,
perhaps, <tt>printk()</tt> is not the right tool for structured logging and
other approaches should be considered.  And Greg Kroah-Hartman has <a
href="/Articles/503584/">suggested</a> that it might be better just to fix
the call sites rather than further complicating the <tt>printk()</tt> code.
<p>

Linus, however, has <a href="/Articles/503586/">argued strongly</a> for the
merging of Steven's patch.  His view is that buffering at the logging level
is fine, but text emitted with <tt>printk()</tt> has to get to the console
immediately.  So chances are that some version of Steven's fix will be
applied for the 3.5 release.  But it has become clear, again, that
adding structured logging to the kernel while not making life harder for
kernel developers is a difficult problem.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Kernel_messages">Kernel messages</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Messages">Messages</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/503430/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor503905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">printk() problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2012 5:19 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/503905/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Personally, I'd rather see printk just start saying "Oh, you didn't put a newline at the end of your line, I'll put one for you."<br>
<p>
If printk exists for debugging, it doesn't need to do fancy things like "drivername: checking for whatever ... OK"; it can just as easily say "drivername: checking for whatever" and later "drivername: whatever OK\n<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/503905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor503961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">printk() problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2012 11:54 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/503961/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem with that is that the people who wrote the printk()s meant there to be a distinction between those that ended in \n and those that did not: losing that destroys information. Now perhaps that information is not very valuable, but nonetheless it is notable that having printk() automatically append \n's would have made the boot messages on most x86-64 systems look quite horrible. If even the boot process is using this, what else is? ("A lot" is the answer.)<br>
<p>
Linus is clearly right: the place to merge adjacent buffers when the earlier one does not end with a \n is in userspace, in the logging daemon. Logging daemons can already do duplicate elimination, rate-limiting and such things -- adjacent merging is trivial. (The kernel *also* implements a rate-limit mechanism, but that's because the buffer is limited in size and to avoid possible DoS attacks before the message ever reaches the logging daemon. Neither of these considerations apply to a trailing \n.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/503961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor503971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">printk() problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2012 13:05 UTC (Thu)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/503971/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Linus is clearly right: the place to merge adjacent buffers when the earlier one does not end with a \n is in userspace, in the logging daemon.</font><br>
<p>
The way I read Linus' message, he is advocating merging the buffers in *kernel* space ("the stuff that actually makes it to dmesg" is still in the kernel), but at the same time sending an unbuffered copy to the console. Giving us the best of both worlds, at the small cost of the screen output and dmesg output being slightly different in case multiple CPUs interleave their messages (the screen would have them interleaved, the kernel log would have them separated correctly).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/503971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor504011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">printk() problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2012 16:09 UTC (Thu)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/504011/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's a whole other problem here too. When a driver printk's some partial message and then goes off to wait on the hardware to come up, what is stopping the other driver which is running in parallel from printk'ing all over that line? Absolutely nothing, in fact.<br>
<p>
Perhaps printk outputs need unique ID codes so the logging daemons know which bits to stick together.<br>
<p>
Or just make each message a complete atomic entity.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/504011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505305"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">printk() problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 10:33 UTC (Thu)
                               by <b>incase</b> (guest, #37115)
                              [<a href="/Articles/505305/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Or just make each message a complete atomic entity.</font><br>
<p>
In my opinion, this is the only sane approach. Makes boot logs longer with <br>
<p>
xyz: initializing peripheral<br>
abc: checking<br>
xyz: peripheral OK<br>
abc: Error<br>
...<br>
<p>
But doesn't interleave unrelated messages:<br>
<p>
xyz: initializing abc: checking OK(from abc or xyz?)<br>
Error (again: Which one?)<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505305/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor503981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">printk() problems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 28, 2012 14:12 UTC (Thu)
                               by <b>ortalo</b> (guest, #4654)
                              [<a href="/Articles/503981/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would simply also treating trailing '...' as a flush indication (like '\n') fix enough of the problematic call places to be worth considering?<br>
(That's a workaround of course, but well... ;-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/503981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2012, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
