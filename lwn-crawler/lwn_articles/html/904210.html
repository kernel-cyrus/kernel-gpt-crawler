        <!DOCTYPE html>
        <html lang="en">
        <head><title>The trouble with 64-bit DMA [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/904210/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/904454/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/904210/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The trouble with 64-bit DMA</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 11, 2022</br>
           </div>
We live in a 64-bit world, to the point that many distributors want to stop
supporting 32-bit systems at all.  However, lurking within our 64-bit
kernels is a subsystem that has not really managed to move past 32-bit
addresses.  The quick merge-window failure of an attempt to use
64-bit addresses in the I/O memory-management unit (IOMMU) subsystem shows
how hard it can be to leave all of one's 32-bit history behind.
<p>
Peripheral devices that move data at any significant rate have to support
direct memory access (DMA) to get reasonable performance.  As the DMA name
suggests, these devices once had direct access to the system's memory in
the physical address space.  Over time, though, most systems have moved to
interposing an IOMMU between devices and memory, for a number of reasons.
The IOMMU can help to ensure that the device only accesses the memory that
was intended for it, for example.  It is also possible to use the IOMMU to
make pages scattered throughout physical memory appear to be contiguous
from the device's point of view.
<p>
For all of this to work, a device driver must create an IOMMU mapping for
an I/O buffer before presenting the mapped addresses to the device.  Those
addresses, called I/O virtual addresses (or IOVAs), look like physical
addresses, but they have their own 64-bit address space.  One would expect
to be able to pass an address anywhere in that range to a device, but life
is not so simple; many devices have surprising limitations on how many
address bits they can actually use.  The kernel's DMA-mapping layer takes
this into account; drivers pass in a mask indicating the address range that
the device can handle, and the kernel finds an address within that range.
<p>
The IOMMU layer imposes an additional constraint, though, in that it will
pick an address below 4GB (i.e. one that fits in 32&nbsp;bits) if at all
possible.  In the early days of the PCI bus, a device performing DMA to a
64-bit address had to use a special "dual-address cycle" (DAC) mode with
each access; DAC cycles were slower than single-address cycles, and a lot
of devices either didn't implement them at all or had buggy
implementations.  Limiting IOVAs to the 32-bit range helped performance and
danced around the ever-present possibility of hardware bugs.
<p>

It is now 2022, and the PCI bus has been superseded by PCI-Express, which
does not have the same performance problems with DAC addresses.  One might
think that current hardware would not have trouble with 64-bit addresses,
which are not exactly new technology at this point.  The 32-bit constraint
is still in place, though, and it is causing some pain of its own.  Back in
June, Robin Murphy posted <a
href="/ml/linux-kernel/3f06994f9f370f9d35b2630ab75171ecd2065621.1654782107.git.robin.murphy@arm.com/">a
patch</a> describing that pain:

<p>
<blockquote class="bq">
	The IOVA allocator doesn't behave all that well once the 32-bit
	space starts getting full.  As DMA working sets get bigger, this
	optimisation increasingly backfires and adds considerable overhead
	to the dma_map path for use-cases like high-bandwidth
	networking. We've increasingly bandaged the allocator in attempts
	to mitigate this, but it remains fundamentally at odds with other
	valid requirements to try as hard as possible to satisfy a request
	within the given limit.
</blockquote>
<p>
At a first glance, 4GB of DMA address space seems like it should be enough
for anybody, but a big system with the right workload can fragment that
space and make allocations hard.  On the theory that the kernel is
needlessly restricting its options to satisfy constraints that no longer make
sense, 
Murphy changed the default so that the IOMMU layer would no longer
try to find a 32-bit-compatible address and would, instead, use the full
address range that the target device claimed to support.  That makes the
performance problem go away, which is a good thing.
<p>
The problem of buggy devices, though, cannot be made to disappear with a
simple kernel patch.  In a sense, that problem is even worse now, in that
the 32-bit constraint may have papered over bugs in both devices and the
drivers that control them for years.  A driver author, perhaps an
inexperienced developer
who has not yet learned about the mendacity of hardware data sheets, may
have trusted the documentation and told the DMA-mapping layer that their
hardware could handle full 64-bit IOVAs when, in fact, it cannot.  Now the
only thing making that hardware actually work is the 32-bit constraint
applied by the IOMMU layer.
<p>
Murphy acknowledged the risk that this change would expose this kind of
bug; the patch included a couple of options for restoring the old behavior.
But Murphy wanted to push the change through:
<p>
<blockquote class="bq">
	Let's be brave and default it to off in the hope that CI systems
	and developers will find and fix those bugs, but expect that
	desktop-focused distro configs are likely to want to turn it back
	on for maximum compatibility.
</blockquote>
<p>
IOMMU maintainer Joerg Roedel <a
href="/ml/linux-kernel/YrMSJ6AGwn3PxSIH@8bytes.org/">applied the patch</a>
with reservations: "<q>I don't have an overall good feeling about this, but
as you said, let's be brave</q>".  The patch then <a
href="https://git.kernel.org/linus/4bf7fda4dce2">landed in the mainline</a>
during the 6.0 merge window.
<p>
It didn't stay there for long, though.  One of the core rules of kernel
development is that good things rarely result from breaking Linus
Torvalds's machine, and that is what happened here.  He promptly <a
href="https://git.kernel.org/linus/af3e9579ecfb">reverted the change</a>,
saying: "<q>It turns out that it was hopelessly naive to think that this would
	work, considering that we've always done this.  The first machine I
	actually tested this on broke at bootup</q>".
He <a
href="/ml/linux-kernel/CAHk-%3DwiSxEVW78nTumvz%2BZYt2MZcmqe6S0nb_-efKYm636VuGA%40mail.gmail.com/">added</a>
that Murphy could "<q>try again in a decade or so</q>".
<p>
The problem, of course, is that the problems created by the 32-bit
constraint are 
unlikely to get better by themselves in the next decade or so.  There is
going to be increasing pressure to leave that behavior behind, at least on
machines where the hardware is known to work properly.  Somehow, the
community is going to have to find a way to change things that doesn't
break systems across the planet.  Perhaps drivers could set a new flag for
hardware that is known to be good, or perhaps some sort of list could be
maintained separately.  The kernel has spent years papering over buggy
hardware and drivers; climbing out of the resulting hole is likely to take
a while as well.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Direct_memory_access">Direct memory access</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-6.0">Releases/6.0</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/904210/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor904468"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 14:32 UTC (Thu)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/904468/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It is now 2022, and the PCI bus has been superseded by PCI-Express, which does not have the same performance problems with DAC addresses. </font><br>
<p>
Corbet, as you may know, this is nuanced. There still is a performance penalty for using address with any of the upper 32-bits set on PCIe. It makes the packet one &quot;dword&quot; longer (32-bit address have shorter PCIe headers). A 32-bit PCIe address access has a 3 dword TLP header (IIRC), while a 64-bit address requires the larger 4-dword TLP header.<br>
<p>
Of course, for performant DMA, you&#x27;d hope that the payload on the packet is large enough that the 1 extra dword will not be noticable.<br>
<p>
Perhapes the IOVA allocater could prefer the lower 4GiB initially (while reserving, say 1GiB for hw in the same translation space that mandates it), And then later fill applicable requests with higher addresses. This should work well especially in cases where the performant/important devices are loaded first (and thus get first pick of 32-bit addresses).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904468/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904479"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 15:21 UTC (Thu)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/904479/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
“Perhapes the IOVA allocater could prefer the lower 4GiB initially (while reserving, say 1GiB for hw in the same translation space that mandates it), And then later fill applicable requests with higher addresses. This should work well especially in cases where the performant/important devices are loaded first (and thus get first pick of 32-bit addresses).”<br>
<p>
Is there any reason to think they are loaded first?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904479/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904489"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 15:47 UTC (Thu)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/904489/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
More importantly, this approach does nothing to mitigate buggy drivers or hardware. You&#x27;re maybe less likely to encounter bugs because you&#x27;re trying to pack things in the lower 4GB, but when A) the range fills up or B) the range becomes too fragmented to use, you&#x27;re going to immediately crash headfirst into the bugs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904489/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 4:52 UTC (Fri)
                               by <b>TheGopher</b> (subscriber, #59256)
                              [<a href="/Articles/904516/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agree - this seems like a great way to introduce difficult to reproduce errors!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor904506"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 23:07 UTC (Thu)
                               by <b>Karellen</b> (subscriber, #67644)
                              [<a href="/Articles/904506/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>This should work well especially in cases where the performant/important devices are loaded first (and thus get first pick of 32-bit addresses).</blockquote>

<p>Wait... there's only one 32-bit mapping across the whole system? There isn't one mapping per device?</p>

<p>O. M. G.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/904506/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904517"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 5:36 UTC (Fri)
                               by <b>cladisch</b> (<b>&#x272D; supporter &#x272D;</b>, #50193)
                              [<a href="/Articles/904517/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
PCI is a shared bus with a common address space.<br>
<p>
PCIe&#x27;s programming model is backwards compatible. Peer-to-peer transfers are still possible (see <a href="https://lwn.net/Articles/767281/">https://lwn.net/Articles/767281/</a>), but not all PCIe root complexes (chipsets) support it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904517/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 15:59 UTC (Fri)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/904570/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Irrelevant nitpick, what we think of as a PCI bus on computers can be a single PCI bus, or multiple PCI busses with their own independent memory spaces, usually with arranged mapped memory windows.  The latter is pretty rare outside of weird server hardware though.  In such cases, the busses each have their own shared memory space with mappings from bus to bus handled by bridge logic.  Regardless, it&#x27;s still a bus-wide memory layout as stated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904520"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 7:33 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/904520/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Wait... there&#x27;s only one 32-bit mapping across the whole system? There isn&#x27;t one mapping per device?</font><br>
<p>
That&#x27;s the point. They are NOT mapped addresses. OS&#x27;s have suffered this problem for ever. And it&#x27;s absolutely crazy, but the first &quot;big&quot; consumer OS *mostly* solved the problem. CP/M. If only that technique had made its way into MS/DOS we *might* not be having this conversation right now. (And we would have avoided all that trouble with lo/hi mem.)<br>
<p>
At some point, mapped addresses have to be mapped to physical addresses. And if your i/o device expects to put a 32-bit address onto the physical address bus, you&#x27;re stuffed ... because MS/DOS assumed everything had a fixed physical address - and allocated the 640K-1MB area specifically to hardware buses, we&#x27;re still paying the price now :-(<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904520/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904560"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 14:05 UTC (Fri)
                               by <b>Karellen</b> (subscriber, #67644)
                              [<a href="/Articles/904560/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>They are NOT mapped addresses.</blockquote>

<p>Huh? According to the article:</p>

<blockquote>As the DMA name suggests, these devices once had direct access to the system's memory in the physical address space. Over time, though, most systems have moved to interposing an IOMMU between devices and memory, for a number of reasons. The IOMMU can help to ensure that the device only accesses the memory that was intended for it, for example. <em>It is also possible to use the IOMMU to make pages scattered throughout physical memory appear to be contiguous from the device's point of view.</em></blockquote>

<p>Emphasis mine - but how does that work if the addresses aren't mapped?</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/904560/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor904604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 3:38 UTC (Sat)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/904604/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Elaborate on CP/M?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904610"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 9:11 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/904610/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
CP/M made no assumptions about memory ranges and reserved space.<br>
<p>
The only thing it stipulated, to my knowledge, was that first ?100? bytes of memory (which pretty much has to exist, on any system) contained a jump table telling it where to find everything else. CP/M itself existed in high memory, which moved around with however much ram you had, so when you added more ram to the system you had to re-gen the OS to move it.<br>
<p>
But that assumption that nothing had a fixed address - I don&#x27;t know exactly how it did hardware but it would have taken the exact same attitude - would have meant that a lot of these problems would not have arisen. And I think that approach did carry over into CP/M86, which was widely acknowledged as much better than MS-DOS. It just lost out because - I think - Bill Gates Junior had a bunch of contacts in IBM who swung it Bill III&#x27;s way.<br>
<p>
We would never have had that memory hole between 640K and 1MB, for example. Hardware would never have assumed that it could just claim certain memory addresses. Etc etc - the mindset would have been different. We&#x27;ll never know what differences it would have made, but it would have made people think rather more deeply about the consequences of their choices. Taking short cuts would have been a lot harder.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904610/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 10:47 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/904613/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It just lost out because - I think - Bill Gates Junior had a bunch of contacts in IBM who swung it Bill III&#x27;s way.</font><br>
<p>
From reading Wikipedia, and an archived January 1982 Byte magazine review of the IBM PC referenced therefrom, the situation appears to have been:<br>
<p>
Digital Research and IBM couldn&#x27;t agree on terms – IBM wanted an NDA, and DR wanted per-unit royalties rather than a one-time payment – so IBM went looking for someone else. Microsoft bought an OS from Seattle Computer Products and offered it to IBM as &quot;MS-DOS&quot;.<br>
<p>
CP/M-86 still ended up being made available on the PC, but only because Gary Kildall threatened IBM with a copyright infringement lawsuit over... something (Wikipedia doesn&#x27;t tell me exactly what).<br>
<p>
Very few people bought it, because (a) the PC started shipping in October 1981, but CP/M-86 for the IBM Personal Computer 1.0 wasn&#x27;t ready until spring 1982 and (b) buying CP/M-86 with your PC cost $240, while buying MS-DOS cost $40 (c) porting CP/M software to CP/M-86 was about as much work as porting it to MS-DOS.<br>
<p>
As for hardware addresses? The reason the IBM PC memory map became the industry standard for MS-DOS 8088/8086 machines was because application software was accessing hardware directly based on that memory map.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904615"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 10:56 UTC (Sat)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/904615/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; As for hardware addresses? The reason the IBM PC memory map became the industry standard for MS-DOS 8088/8086 machines was because application software was accessing hardware directly based on that memory map.</font><br>
<p>
Right? The hardware is mapped. Whether that mapping is fixed or mutable is up to the hardware, not the OS. You can&#x27;t get away from the fact that the CPU is going to start executing code from a fixed address, so there&#x27;d better be something there that contains startup code. Yes, life is probably better if you avoid fixed mappings other than those that are absolutely necessary, but that&#x27;s still something that&#x27;s determined by the hardware and not by the OS that you want to run there. Throwing CP/M on a modern PC wouldn&#x27;t avoid the fact that (eg) the TPM is speced to decode in a specific address range.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904615/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904617"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 11:28 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/904617/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So what you&#x27;re saying, is that if two different pieces of hardware both want the same address, the user is stuffed?<br>
<p>
The point I&#x27;m making is that CP/M used indirect references as a matter of course. If that philosophy had carried on (and not been screwed by &quot;the race to the bottom&quot;), the OS would have used a soft mapping by default, and life would have been easier.<br>
<p>
We&#x27;ll never know, but it&#x27;s my perpetual Word / WordPerfect moan ... WP tried to do things right, it always set out to solve the immediate problem by addressing the underlying cause. Word just shoved a fix out the door asap. That&#x27;s why I hate Word - because it&#x27;s a bundle of single-shot wizards. WordPerfect was far *fewer*, so easier to comprehend, *well thought out* so easier to comprehend, tools that did a far better job ... :-)<br>
<p>
It&#x27;s the mindset that matters, and the current mindset has been horribly corrupted from what I was brought up in my early career with the mini-computer &quot;get it right&quot; ethos. Now it&#x27;s &quot;I need a bodge now&quot; and &quot;if it looks like it&#x27;s working, get it out the door&quot;.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904617/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904618"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 13:39 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/904618/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  if two different pieces of hardware both want the same address, the user is stuffed?</font><br>
<p>
If the hardware doesn&#x27;t include a mechanism for selecting the resource allocations (physical address ranges, edge-triggered interrupt lines, etc.) of a device, then yes, the user is stuffed if two different pieces of hardware are expecting to use the same resource.<br>
<p>
These days, of course, far more of those mechanisms are conveniently software controllable; I remember Dad having to open up a Commodore 1541 and make/break solder links on the PCB so that we could sensibly have two disk drives on our Commodore 64.<br>
<p>
<font class="QuotedText">&gt; The point I&#x27;m making is that CP/M used indirect references as a matter of course.</font><br>
<p>
CP/M needed them, because CP/M ran on a bewildering array of hardware. Some machines had display adapters; others had serial ports. Different manufacturers had different disk formats.<br>
<p>
MS-DOS had many of those mechanisms, but didn&#x27;t actually need them, because the IBM Model 5150 (to say nothing of the clones, which started appearing on the market less than a year after it was released) sold so many units, and had such a well documented architecture, that you could just target &quot;IBM PC or 100% compatible&quot; and then directly access the screen, the 8250 UART, the keyboard controller, etc if you wanted to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904618/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor904624"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 14:03 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/904624/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; If that philosophy had carried on (and not been screwed by "the race to the bottom"), the OS would have used a soft mapping by default, and life would have been easier.</font>

<p>Except that philosophy <b>was</b> there in the MS-DOS and there were <b>lots</b> of MS-DOS compatible-yet-not-IBM-PC-compatible devices with their own <a href="https://winworldpc.com/product/ms-dos/1x">special version of MS-DOS</a>.</p>

<p>Microsoft even used one of these to link some software since it could use 960KB of RAM!</p>

<p>But these can not run Lotus 1-2-3 and that meant pretty soon they have become half-forgotten history.</p>

<font class="QuotedText">&gt; Now it's "I need a bodge now" and "if it looks like it's working, get it out the door".</font>

<p>Yes, but Microsoft haven't invented it. It <b>adopted</b> it. MS-DOS, in particular. is result of said adoption.</p>

<p>Do you know that Microsoft actually <b>had</b> <a href="https://en.wikipedia.org/wiki/MIDAS_(operating_system)">an operation system</a> when it signed contract with IBM? It wasn't the one they actually delivered, eventually, but it's not as if they agreed to deliver something they haven't had at all</p>

<p>It was much closer to what you like, but it was much heavier, wouldn't even run on standard IBM PC (first models had memory between 16KB and 64KB and while MS-DOS is pretty happy with 64KB M-DOS needed more) and thus, eventually, was replaced.</p>

<font class="QuotedText">&gt; It's the mindset that matters, and the current mindset has been horribly corrupted from what I was brought up in my early career with the mini-computer "get it right" ethos.</font>

<p>We would be getting back to that mindset soon, but transition is not expected to be painless.</p>

<p>The <i>if it looks like it's working, get it out the door</i> only makes sense when markets are rapidly expanding and Moore's law covers your back.</p>

<p>We had a few decades of these but we are near the end of that era. Soon there would a a crash (and a big one, <a href="https://en.wikipedia.org/wiki/Great_Depression">Great Depression</a> would be felt as something mild in comparison) and then the mindset would change.</p>

<p>Not sure if that's a good thing or a bad one, though.</p>





      
          <div class="CommentReplyButton">
            <form action="/Articles/904624/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor904647"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 20:54 UTC (Sat)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/904647/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; So what you&#x27;re saying, is that if two different pieces of hardware both want the same address, the user is stuffed?</font><br>
<p>
Yes. Thankfully that doesn&#x27;t typically happen because the hardware that has fixed addressing is part of the platform and so is just designed not to conflict, and everything else is dynamically programmed into empty areas of address space (these days, at least - in the old days you&#x27;d need to jumper your cards to map them without conflict). And again, this isn&#x27;t an OS issue, it&#x27;s a hardware design issue. Changing the OS running on a PC doesn&#x27;t alter the fact that this hardware exists in one place, so CP/M rather than DOS wouldn&#x27;t have resulted in a different outcome.<br>
<p>
Now, you *could* avoid any knowledge of the underlying hardware layout by restricting yourself to performing all access via the BIOS, but then you&#x27;re limited to whatever subset of functionality the BIOS happens to offer. So instead we abstract at the OS driver level (in general userland apps have no idea what physical address anything is associated with), and further abstract it at the IOMMU level (so, for instance, a 32-bit PCI device can still DMA into physical addresses that are above 4GB despite having no way to express that itself).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904647/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904659"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 14, 2022 11:11 UTC (Sun)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/904659/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>And on that note, the IBM PC's bus really was just the processor bus exposed to expansion cards. ISA PnP hacked around this by relying on the fact that a microcontroller in 1993 was cheap, so you could rely on detecting complex sequences of access to the bus and respond to them.
<p>If IBM had intended the PC to be expandable by ordinary consumers (not skilled technicians who'd handle the conflicts by setting jumpers, or even soldering wires on cards), they'd have implemented the 5150's bus (and hence ISA) differently - rather than having the expansion bus be the CPU's raw bus, they'd have had the motherboard implement a "slot inhibit" feature to tell cards when they should decode the bus, they'd have had one IRQ per slot (routing to a unique pin on the 8259A, and they'd have had the motherboard assign DMA channels to cards.


      
          <div class="CommentReplyButton">
            <form action="/Articles/904659/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2022 12:06 UTC (Mon)
                               by <b>wittenberg</b> (subscriber, #4473)
                              [<a href="/Articles/904690/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a classic example of &quot;Worse is Better&quot;  <a href="https://www.jwz.org/doc/worse-is-better.html">https://www.jwz.org/doc/worse-is-better.html</a> a talk that Richard Gabriel gave in 1990 comparing C and Lisp.  He gives the history, including his later misgivings in <a href="https://www.dreamsongs.com/WorseIsBetter.html">https://www.dreamsongs.com/WorseIsBetter.html</a> <br>
This problem has been around for a long time, and isn&#x27;t likely to go away soon.<br>
<p>
--David<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor904616"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 11:17 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/904616/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; CP/M-86 still ended up being made available on the PC, but only because Gary Kildall threatened IBM with a copyright infringement lawsuit over... something (Wikipedia doesn&#x27;t tell me exactly what).</font><br>
<p>
So the story goes ... Gary asked IBM to provide a pristine IBM PC to court, then hit a magic key sequence that triggered a Digital Research copyright message.<br>
<p>
Not much IBM could do in their defence after that ... the claim basically was that PC-Dos contained a load of DR code which was quite plausible, because Dos was written by ?Seattle Computer?, as a hobby project, never really intended for commercial sale. So the guy who wrote it probably didn&#x27;t see any harm in copying loads of stuff, and when Bill bought it he probably didn&#x27;t go looking for stuff that shouldn&#x27;t be there ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904616/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904627"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 14:22 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/904627/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>That's pretty nice story except for the fact that somehow no one can present these magical key sequences and show anything like that.</p>

<p>On the contrary, the exact same story where <b>Bill Gates</b> inserted the copyright message into <b>Commodore</b> computer and <a href="https://www.pagetable.com/?p=43">is very easy to repeat</a>.</p>

<p>This, to me, <b>strongly</b> hints at the fact that this Digital Research tale is just an urban legend.</p>

<p>Because I heard it from quite a few sources and we have pristine copies of PC-DOS 1.0, lots of original IBM 5150 devices still working… and yet no one was able to repeat this feat.</p>

<p>P.S. Keep in mind that triggering sequence shouldn't be too complicated. Otherwise we would have <a href="https://retrocomputing.stackexchange.com/questions/4416/how-did-commodores-anti-microsoft-easter-egg-work">something like this</a>.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/904627/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2022 15:02 UTC (Mon)
                               by <b>smoogen</b> (subscriber, #97)
                              [<a href="/Articles/904758/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The version I heard when I was a kid around 1978 was between Digital Equipment Corporation and Data General. Another version I heard in the early 1980&#x27;s was between Apple ][ and Franklin. When I got to college in the 1980&#x27;s, the one the old hands of the IT group talked about were IBM and Burroughs from the 1960&#x27;s. And at a different workplace, there was some version between Univac and a clone. The stories all have the same core story where in a court case, the defamed creator does some &#x27;plug change&#x27;, &#x27;toggle switch manuever&#x27;, &#x27;keystroke&#x27;, etc and shows that the system prints up something from their company. <br>
<p>
In the years since, I have yet to find anyone able to show where their case actually happened. Especially now that trial records are digitized, these sorts of things are findable but somehow hundreds of these cases have somehow been purged... or never existed in the first place. I expect that some version (or versions) are true. I don&#x27;t know which ones though anymore.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2022 16:19 UTC (Mon)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/904760/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>As I have said: the only one which actually looks plausible is about Commodore, Bill Gates and trade show.</p>

<p>Because we know where text was kept, how to trigger the message, how the trigger does what it does and we even know it was only in one version of Basic (it was, apparently, removed from later versions when Bill Gates showed it to Tramiel), but then it was present in all copies of that Basic, including ones that survived to this day.</p>

<p>All others… there are no evidence and they are too numerous to all be true.</p>

<p>Maybe, just maybe, one of them is true… but unlikely. More likely just a fairy tales.</p>

<p>P.S. I have become much more sceptical about accusations about Bill Gates stealing anything after existence of <a href="https://en.wikipedia.org/wiki/MIDAS_(operating_system)">MDOS</a> was revealed.</p>

<p>It's one thing to have an OS when you sign a deal and to buy a better one if you see yours is problematic (MDOS was too heavy for IBM PC which was initially sold with RAM between 16KiB and 64KiB… not a good fit when even most powerful “standard” config is not powerful enough to run “default” OS), it's completely different thing if you promise to deliver what you don't have at all</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/904760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor911010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 13, 2022 1:54 UTC (Thu)
                               by <b>Thomas</b> (subscriber, #39963)
                              [<a href="/Articles/911010/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Atari ST's TOS has entered the chat.<br>
<p>
A jump table (among other useful stuff) in the first kB. Cannot hide proper design, can you?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 13, 2022 7:42 UTC (Thu)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/911018/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And so the Amiga has to follow ;-)  Single fixed pointer to ExecBase at 4.  All the rest is reached by indirection from that.<br>
<p>
Actually the Commodore KERNAL (as used on e.g. PET and C64) had a fixed jump table at the end of the address space, too.  This provided only basic I/O, so no fancy color graphics, sprites, or border tricks on the C64 ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911027"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 13, 2022 11:04 UTC (Thu)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/911027/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>For the ultimate expression of this pattern, you get <a href="https://heyrick.eu/assembler/swi.html">ARM's SWI instruction</a> in 1986 - a hardware jump to the OS preserving almost all registers, allowing the OS to handle the indirection from there.


      
          <div class="CommentReplyButton">
            <form action="/Articles/911027/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911065"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 13, 2022 15:21 UTC (Thu)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/911065/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or the 6502's BRK instruction? Which is probably predated by BRK on the 6800...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911065/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor904471"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 14:49 UTC (Thu)
                               by <b>fhuberts</b> (subscriber, #64683)
                              [<a href="/Articles/904471/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The default way to fix such a problem is to reroute the original function to a new function with an argument that indicates whether the &#x27;old&#x27; or the  &#x27;new&#x27; behaviour is required and then to convert all callers of the original function one-by-one to the new function with the argument set to &#x27;new&#x27; (evolve them).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904471/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904480"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 15:22 UTC (Thu)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/904480/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But this isn’t about functions, it’ll have to be a hardware whitelist.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904480/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904491"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 15:59 UTC (Thu)
                               by <b>fhuberts</b> (subscriber, #64683)
                              [<a href="/Articles/904491/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A function doesn&#x27;t need to be an actual code function. It can be an architecture function or conceptual function as well. It&#x27;s about the strategy of evolution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904491/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904522"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 7:44 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/904522/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly, this sort of problem is not solved by &quot;trying again in a decade or so&quot; but by gradually switching hardware configurations one by one over the next decade.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904522/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904487"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 15:44 UTC (Thu)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/904487/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ok, sure, it broke Torvalds&#x27; machine. It&#x27;s expected to break a lot of machines, that&#x27;s why it defaults to off.<br>
<p>
But if the option (off by default) isn&#x27;t there, how the in the world are people supposed to slowly find and fix buggy drivers or blacklist truly broken devices?<br>
<p>
Add Torvalds&#x27; machine to the blacklist, merge the patch, and let&#x27;s move on.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904487/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904498"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 19:43 UTC (Thu)
                               by <b>mwilck</b> (subscriber, #1966)
                              [<a href="/Articles/904498/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was thinking the same. It&#x27;s just a config option, so why did he have to wipe it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904498/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904499"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 19:52 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/904499/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      From the email linked in the article: "<q>but at least on x86-64, that config option is basically a "stop modern
machines from working", and I don't want to have that even as an
option.</q>"


      
          <div class="CommentReplyButton">
            <form action="/Articles/904499/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904512"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 2:53 UTC (Fri)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/904512/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And there aren&#x27;t other config options that can bork your kernel when used improperly?<br>
<p>
How does he ever expect this to get fixed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904512/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 8:59 UTC (Fri)
                               by <b>joib</b> (subscriber, #8541)
                              [<a href="/Articles/904525/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Add a flag to the DMA allocator saying &quot;yes, I can handle 64-bit addresses&quot;, then individual drivers can be tested and converted one-by-one? Presumably there aren&#x27;t that many drivers that want and benefit from such large DMA spaces in the first place, so probably less effort than spending a decade chasing down bugs in a zillion obscure drivers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor904534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 13:32 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/904534/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There certainly are. Off the top of my head: the config option to clean up stray bus-master flags left enabled by EFI (which *sounds* like a good idea for security) causes my desktop to not boot. Turning on the AMD memory encryption support caused my (also AMD) GPU to not work and I&#x27;ve been dissuaded from trying again, though the BIOS option to have it always enabled seems to work without problems.<br>
<p>
On the other hand running with the *defaults* causes my laptop&#x27;s CPU frequency controls to not work correctly because it does special things for acpi_osi=Linux. And so on.<br>
<p>
We do actually need options for this stuff, or else we&#x27;re left with a padded cell of lowest common denominator functionality.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 14:17 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/904563/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I just remembered an even easier one! Ethernet MTU. It&#x27;s incredibly easy to cause your network to break in weird and wonderful ways just by setting each card&#x27;s MTU to its maximum advertised amount, and you don&#x27;t even need to reboot, let alone tweak the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904589"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 21:42 UTC (Fri)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/904589/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s your switches not supporting the higher MTU not the network card though usually. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904589/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904775"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2022 19:31 UTC (Mon)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/904775/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All devices on the network must have the same MTU. Otherwise, one device may send a frame to another device which the latter can&#x27;t receive, and there is no way to detect this.  End result: the network just doesn&#x27;t work sometimes.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904775/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 16, 2022 9:52 UTC (Tue)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/904796/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>That's one of the bugs of switched Ethernet as opposed to doing routing at every device. If you had a router on the other end of the cable (or in WiFi, if the AP routed between all stations), you'd be able to have per-device MTUs and path MTU discovery, and slowly increase the MTU as you upgrade equipment (at the expense of a small number of ICMP Packet Too Big messages when you cross segments).
<p>WiFi, for example, has a "native" MTU of 2304 bytes, but we choose to limit it to 1500 because of the need to switch to 1500 byte MTU Ethernet - in theory, though, you could have an infrastructure with a 2304 byte MTU (non-standard for Ethernet, mind), and get the efficiency gains across the network.
<p>This is, of course, not the only consideration in choosing between switching L2 frames or routing L3 packets, but it <em>is</em> a downside of choosing to switch instead of route.


      
          <div class="CommentReplyButton">
            <form action="/Articles/904796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor904588"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 21:41 UTC (Fri)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/904588/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
By default the kernel actively ignores and denies any _OSI(Linux) requests and in fact throws an alert into your DMESG that your BIOS attempted one on newer kernels.<br>
<p>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/acpi/osi.c?h=v5.19.1#n163">https://git.kernel.org/pub/scm/linux/kernel/git/stable/li...</a><br>
<p>
That&#x27;s been true dating all the way back before the v3.0 days (I didn&#x27;t verify a specific git link for earlier):<br>
<p>
<a href="https://github.com/torvalds/linux/blob/02f8c6aee8df3cdc935e9bdd4f2d020306035dbe/drivers/acpi/osl.c#L116">https://github.com/torvalds/linux/blob/02f8c6aee8df3cdc93...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904588/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor904503"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 21:27 UTC (Thu)
                               by <b>Tov</b> (subscriber, #61080)
                              [<a href="/Articles/904503/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems like the default &quot;off&quot; actually disables the old behavior.<br>
<p>
But yes: &quot;Lets be brave and default this new behavior across the board for all odd devices out there, do no significant testing and hope other developers and users will find and fix all the buggy devices for us&quot;.<br>
<p>
No wonder Linus has given them a decade to think about another way forward...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904503/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 8:58 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/904526/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; No wonder Linus has given them a decade to think about another way forward...</font><br>
<p>
The problem is we DON&#x27;T HAVE a decade. The old way is already breaking top-end machines, and the problem is only going to get worse as that becomes consumer hardware ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor904500"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 21:09 UTC (Thu)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/904500/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <tt>Murphy acknowledged the risk ...</tt>
<p>
<a href="https://en.wikipedia.org/wiki/Murphy's_law">Murphy's law</a>: If anything can go wrong, it will.



      
          <div class="CommentReplyButton">
            <form action="/Articles/904500/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor904507"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 11, 2022 23:41 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/904507/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about clearing that &quot;64 bit addresses supported&quot; feature bit on all devices and then adding it back if/when each device has actually been tested with it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904507/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 13:12 UTC (Fri)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/904533/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There&#x27;s very little incentive for people to test their devices compatibility with 64-bit DMA.<br>
<p>
On the other hand, the opt-out variant, while apparently providing miserable UX, at least makes people report incompatible devices.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904648"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 22:29 UTC (Sat)
                               by <b>gray_-_wolf</b> (subscriber, #131074)
                              [<a href="/Articles/904648/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; There&#x27;s very little incentive for people to test their devices compatibility with 64-bit DMA.</font><br>
<p>
Hm, but most people just don&#x27;t care about this no? I don&#x27;t feel like my laptop is limited by only having 32-bit mapping. Wouldn&#x27;t it be a safe assumption that likes of Google would bother testing the drivers for those few places where they actually suffer from this problem? So you could enable 64-bit (or rather, the supported range) just for those devices/drivers?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904648/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor911011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 13, 2022 2:10 UTC (Thu)
                               by <b>Thomas</b> (subscriber, #39963)
                              [<a href="/Articles/911011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's going to be a tough challenge.<br>
<p>
The 64-bit address support is read from a device's PCI capabilities, i.e. it is read from the label on the PCI device's box. This is something one cannot modify, because it comes with the equipment and is read-only. Therefore, in order to be able to overwrite this value, one has to already know that a device is incapable of supporting a 64-bit address space despite reporting it. -&gt; Chicken-egg problem. On top of that a modify-on-write copy of a device's capabilities needs to be maintained because some devices need to have the 64-bit capability overwritten.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904515"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reserve the lower four gigs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 4:42 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/904515/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>At a first glance, 4GB of DMA address space seems like it should be enough for anybody, but a big system with the right workload can fragment that space and make allocations hard.</blockquote>
On a big system why not reserve the lower four gigabytes (or most of it) for DMA?  Then it wouldn't get fragmented.


      
          <div class="CommentReplyButton">
            <form action="/Articles/904515/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904518"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reserve the lower four gigs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 5:40 UTC (Fri)
                               by <b>cladisch</b> (<b>&#x272D; supporter &#x272D;</b>, #50193)
                              [<a href="/Articles/904518/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; why not reserve the lower four gigabytes (or most of it) for DMA?</font><br>
<p>
With an IOMMU, the I/O address space is virtual and separate from the physical address space. The entire I/O address space already is reserved for DMA; the problem is that all of it gets filled up.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904518/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904562"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reserve the lower four gigs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 14:20 UTC (Fri)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/904562/">Link</a>] 
      </p>
      
      </div>
      </summary>
      As far as I know, making a large IOVA-contiguous DMA allocation still needs the memory to be contiguous in the CPU (physical) address space, even with an IOMMU.<br>
<br>
It would help avoid the issues caused by memory fragmentation if more drivers were converted to the <code>dma_alloc_noncontiguous()</code> API instead, which allows assembling such IOVA-contiguous allocation from non-contiguous single pages.










      
          <div class="CommentReplyButton">
            <form action="/Articles/904562/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor904683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reserve the lower four gigs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 15, 2022 9:11 UTC (Mon)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/904683/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I understood that the bottom four gigs of *physical* memory needed to be used, but it was fragmented because of other uses.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor904519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 5:53 UTC (Fri)
                               by <b>maniax</b> (subscriber, #4509)
                              [<a href="/Articles/904519/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is something I see every month - anything you try to do with hardware that&#x27;s not what the Linux kernel does by default, doesn&#x27;t work. Nobody tests that, nobody seems to care and half the time you&#x27;re on your own, working around weird hardware bugs.<br>
<p>
(so for example for every DPDK driver and related things, for every problem you see you also need to go look in the kernel how something is implemented)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 9:07 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/904527/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And Windows is different how?<br>
<p>
Oh yes, all development is done behind closed doors, and we don&#x27;t see the hardware manufacturers screaming about their drivers.<br>
<p>
The problem is no different - IF the manufacturer can be bothered to provide a linux driver but for any OS the attitude is typically &quot;if it works, ship it&quot;, and the kernel devs attitude is sadly but inevitably, &quot;it works for me, I can&#x27;t test it on anything else, so I&#x27;ll assume it&#x27;s fine&quot;.<br>
<p>
As an application programmer, I hate that attitude, there&#x27;s loads of (sadly pretty ubiquitous) software that is buggy / illogical / downright frustrating as hell software out there. I try and make sure everything I do makes logical sense and addresses the entire &quot;truth table&quot; range (even if only &quot;I don&#x27;t want to go there, but I&#x27;m not going to stuff you up if you do&quot;). But the majority of crap out there doesn&#x27;t even try :-(<br>
<p>
And for a hardware engineer/device driver writer, that attitude is very hard to take in the face of hardware bugs ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 9:19 UTC (Fri)
                               by <b>maniax</b> (subscriber, #4509)
                              [<a href="/Articles/904528/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sorry, I think I wasn&#x27;t clear :)<br>
<p>
My beef is with the hardware vendors on this (and you can do s/Linux/Windows/ in my comment, or say &quot;the most used OSes&quot;). What they test with seems to be what the OSes do, so using any feature not used in Linux, or in a way that Linux doesn&#x27;t use leads to problems.<br>
<p>
I&#x27;m not talking about extremely obscure stuff, either... Without naming names, one vendor of NICs had a problem that when filtering packets in the NIC based on UDP port, it tended to corrupt the packets. They&#x27;d come in, with the flag for correct checksum set, but the packet would be either truncated, or would have another packet starting at a 4k offset. Never got them to fix it, as it was easily reproducibe only with serious amounts of traffic.<br>
<p>
And we get to the situation where a hardware bug is not fixed because the mainstream OSes work around it or don&#x27;t use that functionality, and the hardware vendors don&#x27;t really care for the rest. So we all end up implementing the same (bad) workarounds...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 12, 2022 23:29 UTC (Fri)
                               by <b>Avamander</b> (guest, #152359)
                              [<a href="/Articles/904593/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even Linux defaults might not function, RDRAND and TSC come to mind. But there are other, more subtle bugs, like incomplete ACPI tables.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor904608"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 8:17 UTC (Sat)
                               by <b>thoeme</b> (subscriber, #2871)
                              [<a href="/Articles/904608/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;for example for every DPDK driver</font><br>
Hm, I have to ask our DPDK developer about that... I know the DPDK driver for the AMD EPYC 3000 SoC (on a COM express 7 module) did not work when I tested it, according to one of the people responsible because the specific PHY used on the dev carrier board was not supported. Now I wonder if there&#x27;s more to it...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904608/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904595"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 0:47 UTC (Sat)
                               by <b>xxiao</b> (guest, #9631)
                              [<a href="/Articles/904595/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How does Nvidia&#x27;s CUDA do this then? It has hundreds of GB memories on both sides(GPU and CPU) and they definitely need to allocate and move via DMA at large regions(and cross PCIe), there might be some smart way to overcome this IOVA limit?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904595/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 15:43 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/904635/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Both nVidia and AMD only recently offered a way to do that. AMD calls it <a href="https://www.amd.com/en/technologies/smart-access-memory">Smart Access Memory</a> and nVidia <a href="https://www.nvidia.com/en-us/geforce/news/geforce-rtx-30-series-resizable-bar-support/">Resizable BAR</a>.</p>

<p>Before that they just used 256MB-512MB fixed preallocated “window” to move data.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/904635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor904614"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 10:27 UTC (Sat)
                               by <b>andy_shev</b> (subscriber, #75870)
                              [<a href="/Articles/904614/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem with Linux nowadays that Linus wants to have his branch as (almost) stable all over the time, and all CIs are for that. The 2 months cycle is too short for such a patch, and it basically blocks the Linux improvements (similar happened to printk threads). We need real development Linux kernel tree, where 6 month or so the release cycle would be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/904614/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor904621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with 64-bit DMA</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2022 12:30 UTC (Sat)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/904621/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Sounds like there should be <code>linux-next-longterm</code> tree for the really brave.<br>
<br>
And CI infrastructure and bots should be testing that.






      
          <div class="CommentReplyButton">
            <form action="/Articles/904621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
