        <!DOCTYPE html>
        <html lang="en">
        <head><title>Kernel building with GCC plugins [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/691102/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/690629/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/691102/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Kernel building with GCC plugins</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>June 14, 2016</br>
           </div>
It has long been understood that static-analysis tools can be useful in
finding (and defending against) bugs and security problems in code.  One of
the best places to implement 
such tools is in the compiler itself, since much of the work required to
analyze a program is already done in the compilation process.  Despite the
fact that GCC has had the ability to support security-oriented plugins for
some years, the mainline kernel has never adopted any such plugins.  That
situation looks likely to change with the 4.8 kernel release, though.
<p>
For many years, GCC famously did not support plugins out of a fear that
proprietary plugins would undermine the free compiler.  That roadblock
ended in 2009, when the <a href="/Articles/301959/">GCC runtime library
exemption</a> was rewritten.  This library, which is needed by almost every
program built with GCC, can be linked with proprietary code — but only if
no non-GPLv3 plugins were used in the compilation process.  The addition of
that rule gave the powers that be at the Free Software Foundation the
confidence that they could safely add a plugin mechanism to GCC.
<p>
Relatively few plugins have materialized in any setting, perhaps because
writing one requires a fairly deep understanding of how GCC works and the
documentation available is not entirely helpful.  (LWN ran <a
href="/Articles/457543/">an introduction to creating GCC plugins</a> back
in 2011).  One group that did jump onto the plugin bandwagon, though, is <a
href="https://grsecurity.net/">grsecurity</a>, where the ability to analyze
— and transform — kernel code was quickly recognized as having a lot of
potential.  There were four plugins in the grsecurity patch set when LWN <a
href="/Articles/461696/">took a look</a> in 2011.  The current testing
patch set from grsecurity shows twelve of them, performing a variety of
functions:
<p>
<ul>
<li> <b>Checker</b> incorporates some address-space checks normally
     performed separately with the <a href="/Articles/689907/">sparse</a>
     tool.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
<li> <b>Colorize</b> simply adds color to some diagnostic output.
<p>
<li> <b>Constify</b> makes structures containing only function pointers
     <tt>const</tt>. 
<p>
<li> <b>Initify</b> moves string constants that are only referenced in
     <tt>__init</tt> or <tt>__exit</tt> functions to the appropriate ELF
     sections.
<p>
<li> <b>Kallocstat</b> generates information on sizes passed to
     <tt>kmalloc()</tt>. 
<p>
<li> <b>Kernexec</b> is there to "<q>to make KERNEXEC/amd64 almost as
     good as it is on i386</q>"; it ensures that, for example,
     user-space pages are not executable by the kernel.
<p>
<li> <b>Latent_entropy</b> tries to generate entropy (randomness) from the
     kernel's execution; more on this one below.
<p>
<li> <b>Randomize_layout</b> reorganizes structure layout randomly.
<p>
<li> <b>Rap</b> implements grsecurity's "return address protection"
     mechanism, described in <a
     href="https://pax.grsecurity.net/docs/PaXTeam-H2HC15-RAP-RIP-ROP.pdf">this
     presentation [PDF]</a>.
<p>
<li> <b>Size_overflow</b> (described on <a
     href="https://forums.grsecurity.net/viewtopic.php?f=7&t=3043">this
     page</a>) detects some integer overflows.
<p>
<li> <b>Stackleak</b> tracks kernel-stack usage so that the stack can be
     cleared on return to user space.
<p>
<li> <b>Structleak</b> forcibly clears structure fields if they might be
     copied to user space.
</ul>
<p>
These plugins have clear value to developers wishing to harden the kernel,
and they are all free software (though many of them are GPLv2-only, meaning
that they cannot be used to compile code needing the GCC runtime library;
fortunately, the kernel does not use that library).  So far, though, they
remain unavailable to kernel developers and distributors, living only in
the grsecurity patch set.  There are no serious technical or legal
obstacles keeping them out of the mainline, but nobody has made the effort
to move them over — until now.
<p>
<h4>Plugins go mainline</h4>
<p>
Recently, interest in hardening the mainline kernel has increased — or,
perhaps more accurately, resistance to doing so has decreased.  One obvious way
of doing so is to try to bring some of the ideas found in grsecurity into
the mainline kernel; that includes the plugin mechanism.  To that end, the
Linux Foundation's Core Infrastructure Initiative has funded Emese Révfy,
the developer of some of the above-listed plugins, to bring this
functionality into the mainline kernel.  The resulting <a
href="/Articles/688491/">patch set</a> has been through several rounds of
review and is currently staged in linux-next for a probable 4.8 merge.
<p>
Emese's patch set does not include all of the plugins listed above; indeed,
it includes none of them.  Instead, there are two relatively simple plugins
provided as a sort of demonstration of how things can be done.  One of
them, called "sancov," inserts a tracing call at the beginning of each
basic block of code.  This feature is useful for anything requiring
coverage tracking; it is aimed at the <a
href="/Articles/677764/">syzkaller</a> fuzz tester in particular.
<p>
The other included plugin calculates the "<a
href="https://en.wikipedia.org/wiki/Cyclomatic_complexity">cyclomatic
complexity</a>" of each function in the kernel.  This metric is a simple
count of the number of possible paths through the function; a higher
complexity count indicates more twisted code that, perhaps, is a more
likely hiding place for bugs.  Emese has <a
href="/Articles/691110/">suggested</a> that it could be incorporated into
the build-testing systems, where it could emit warnings when somebody
adds a new function above a given complexity threshold.
<p>
Your editor built an <tt>allyesconfig</tt> kernel with this plugin enabled;
the result was nearly 620,000 complexity values printed to the output.
According to this metric, the most complex function in the kernel, with a
score of 817, is <a
href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/md/bcache/super.c#n1805"><tt>cache_alloc()</tt></a>
in <tt>drivers/md/bcache/super.c</tt> — a demonstration of just how much
complexity can be hidden in macros.  Perhaps a more convincing
demonstration is <a
href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/drivers/net/wireless/ralink/rt2x00/rt2800lib.c#n4536"><tt>rt2800_init_registers()</tt></a>,
a 450-line function weighing in at 586.  The most complex core-kernel
function is <a
href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/mm/page_alloc.c#n7074"><tt>alloc_large_system_hash()</tt></a>,
with a score of 278.
<p>

The latent_entropy plugin from grsecurity <a href="/Articles/689145/">has
been posted</a> as a separate patch set.  This plugin tries to address the
problem that systems often have very little entropy available immediately
after boot.  It adds code to initialization-time functions; each of those
functions will generate a pseudo-random value when called and mix it into
the entropy pool.  That did not seem particularly random to a number of
observers; the key, <a href="/Articles/691118/">according to "PaX
Team",</a> is that the timing and sequencing of this mixing varies
according to the interrupts raised during system boot.  Ted Ts'o <a
href="/Articles/691119/">commented</a> that this "entropy" might merely
duplicate that obtained from the interrupt-timing measurements that are
already done.  He noted that mixing it in twice won't hurt, but it may not
help much either.
<p>
See <a
href="https://grsecurity.net/pipermail/grsecurity/2012-July/001093.html">this
2012 message</a> from PaX Team for more information on how the
latent_entropy plugin works. 
<p>
As noted above, the plugin infrastructure and two simple plugins are
currently poised to be merged for 4.8.  The latent_entropy plugin is not
in linux-next as of this writing, so it is likely to arrive later, if at
all.  But there is a whole set of existing plugins waiting for somebody to
make the effort to bring them over and, even better, the potential for
many other plugins to be written in the future.  A pluggable compiler can
be a potent tool for the checking and hardening of kernel code; the kernel
community may have a lot to gain from making use of it.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Build_system-GCC_plugins">Build system/GCC plugins</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/691102/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor691484"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 15, 2016 15:30 UTC (Wed)
                               by <b>SEJeff</b> (guest, #51588)
                              [<a href="/Articles/691484/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've always wondered why something akin to tracepoints couldn't be inserted by the compiler to help tools such as perf/sysdig/utrace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691484/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor691615"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 16, 2016 11:19 UTC (Thu)
                               by <b>wildea01</b> (subscriber, #71011)
                              [<a href="/Articles/691615/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; These plugins have clear value to developers wishing to harden the kernel, and they are all free software (though many of them are GPLv2-only, meaning that they cannot be used to compile code needing the GCC runtime library; fortunately, the kernel does not use that library).</font><br>
<p>
As far as I can tell, there are a handful of architectures that appear to link against libgcc. Are they going to find themselves in trouble here?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691615/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691689"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 16, 2016 20:37 UTC (Thu)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/691689/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
if an arch's vmlinux links to code from libgcc that is under the 'GCC Runtime Library Exception' (not all the code of libgcc is under that license) then it will not have met the 'Eligible Compilation' condition and the end result cannot be propagated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691689/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor691738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Only for kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 17, 2016 11:49 UTC (Fri)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/691738/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was wondering if do some of these extensions make sense for user space programs? For example Constify or Initify seems to be useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor691756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 17, 2016 15:36 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/691756/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Does <b>Randomize_layout</b> change only the padding of a structure?  Or does it also change the ordering?  Because the C standard does guarantee that structure members are laid out in memory in the order they are declared.  I'm struggling to think of a use-case for something that changes the order of structure members.
      
          <div class="CommentReplyButton">
            <form action="/Articles/691756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor692113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2016 12:29 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/692113/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure, but I imagine it means that exploits would need to discover what the order of struts were before they could exfiltrate data or chain function calls together.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor692151"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2016 15:46 UTC (Tue)
                               by <b>kdave</b> (subscriber, #44472)
                              [<a href="/Articles/692151/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The exploit code searches for a pattern uid and gid in creds and the overwrites it to zeros (<a href="http://lxr.free-electrons.com/source/include/linux/cred.h#L127">http://lxr.free-electrons.com/source/include/linux/cred.h...</a>). With random layout, the pattern won't be found. Examples:<br>
<a href="https://github.com/offensive-security/exploit-database/blob/master/platforms/linux/local/744.c#L274">https://github.com/offensive-security/exploit-database/bl...</a><br>
<a href="https://github.com/offensive-security/exploit-database/blob/master/platforms/linux/local/9545.c#L232">https://github.com/offensive-security/exploit-database/bl...</a><br>
<p>
To make such exploits "work" and not hang, a fake copy of the credentials can be added to the expected location, all updates to the true creds would update both values. This needs more changes to code, so it's out of scope of the plugin. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692151/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor710569"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2017 6:12 UTC (Wed)
                               by <b>kaiwantech</b> (subscriber, #108966)
                              [<a href="/Articles/710569/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Won't changing the order of members in a structure adversely affect cpu caching (thus violating the 'keep important/hotspot members together and at the top' rule)? AFAIK there are several instances of data structures in the kernel codebase which rely on a particular ordering, if nothing else then for cache optimization.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/710569/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor710570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2017 6:39 UTC (Wed)
                               by <b>kaiwantech</b> (subscriber, #108966)
                              [<a href="/Articles/710570/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Okay, looks like I found the answer to my question (above) in a comment by 'joib' here [ <a rel="nofollow" href="https://lwn.net/Articles/705262/">https://lwn.net/Articles/705262/</a> ]:<br>
"[...] It says in the article that it only affects structs which contain only function pointers (which all have the same size, AFAICS). Furthermore, the slides say that it can be configured to randomize only within a cache line."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/710570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor691769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 17, 2016 16:54 UTC (Fri)
                               by <b>shemminger</b> (subscriber, #5739)
                              [<a href="/Articles/691769/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be good if constify and initify could be used to produce warnings which then could be used to modify original code.<br>
Not sure I like compiler silently fixing and changing things.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 17, 2016 17:16 UTC (Fri)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/691770/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Compilers <i>do</i> silently fix and change things. E.g. get rid of dead code, propagate constants and use the knowledge so gained to generate different code, reorder computations, and so on. It is called "optimization", and without it your code would be as fast (or lack thereof) as what <a href="http://bellard.org/tcc">tcc</a> generates...</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/691770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 17, 2016 22:15 UTC (Fri)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/691823/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
didn't you vehemently argue against all of this back in 2011 already: <a href="https://lwn.net/Articles/463283/">https://lwn.net/Articles/463283/</a> ? or are you just going with the flow, turning the coat, a day as any other?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor692980"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 29, 2016 8:17 UTC (Wed)
                               by <b>oldtomas</b> (guest, #72579)
                              [<a href="/Articles/692980/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; didn't you vehemently argue against all of this back in 2011 already [...]</font><br>
<p>
I actually went back and I do read vonbrandt's argument differently. In a nutshell, what I read there is that there's a cost in changing the semantic interpretation of C source from what the "standard" does. And that still makes sense.<br>
<p>
 &gt; or are you just going with the flow, turning the coat, a day as any other?<br>
<p>
See, and that is what spoils the interaction with you: you are extremely smart people, and do contribute significantly to our wellbeing. But this constant insinuation of malice on other people's parts is not really helpful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692980/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor691826"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 17, 2016 22:37 UTC (Fri)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/691826/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the initify plugin has a verbose mode that will emit a message (not a 'warning' but a 'note') whenever it changes something and it's trivial to add something like that to the constify plugin as well. however i don't see anyone producing source code patches based on that information, it's just not feasible. we tried this with constify a few years ago where Emese submitted patches produced by a coccinelle script and the reception of that series is probably an object lesson of why this will never work. also some of the changes made by a plugin don't have an equivalent source code change, say initifying __func__.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691826/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 18, 2016 1:08 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/691840/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; we tried this with constify a few years ago where Emese submitted patches produced by a coccinelle script and the reception of that series is probably an object lesson of why this will never work.</font><br>
<p>
The main outcome of that discussion appears to have been "please submit per-subsystem patches, instead of a huge patchseries doing everything". With a few exceptions Acked-By's seems to have easy to come by.  I don't think the discussions support your conclusion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 18, 2016 12:42 UTC (Sat)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/691852/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
there never was 'a huge patchseries doing everything'. it started with individual patches per ops type (only a small subset of the types that could have been constified). the first fork on the road occured right there as some people ack'd some patches while others flat out refused to even accept the usefulness of ops constification. then some people requested a further breakup per subsystem *and* per ops type which as expected multiplied the number of patches.  this is where the second fork occured where some people objected to *that*. there was never any consensus reached as to how exactly these constification patches should be submitted and IIRC, even those that got ack'ed didn't always get applied. the icing on the cake was that checkpatch did get modified to find a few more of the writable ops structures but as you can verify it yourself, not many took it seriously and the kernel continues to have such ops variables left writable that by policy should be const.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691915"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2016 18:05 UTC (Sun)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/691915/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I wonder if a half-way solution for constify would go better:
<ol type="a">
<li> Have the plugin add a "const_instances" attribute, which when applied to a struct causes all instances of this struct to automatically become const. (Hopefully, this means the size of the patch to actually add this attribute to all ops structures would be much smaller than what Emese had to try and push through previously&hellip;)
<li> Have another plugin (or an option to the same one) that produces warnings when a struct looks like it should be auto-const'able; make this shut up when the struct has a "non_const_instances" attribute (for ops structs that we do modify and cannot fix).
</ol>
For initify&mdash;there is probably no other viable approach except the current one.
<p>
Another useful plugin would be something that causes errors on writes to <tt>ro_after_init</tt> variables from functions not marked <tt>__init</tt>&hellip; I wonder how feasible it is to implement.
      
          <div class="CommentReplyButton">
            <form action="/Articles/691915/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor691919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2016 19:26 UTC (Sun)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/691919/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the constify plugin already provides a do_const attribute for exactly that purpose (that we make use of for non-ops types already) and reporting on candidate types is also trivial to add in the constifiable() function. as for your last suggestion, it's doable but it will take a fair amount of static analysis that will effectively have to duplicate existing gcc logic in the C/C++ frontends. the easier way out is to mark these variables 'const' for a test compilation and examine the fallout.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/691919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor692219"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2016 19:40 UTC (Tue)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/692219/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Changes that start with write a coccinelle script and update everything in the kernel.  Always seem to be merged most easily if you have your own tree and send Linus the pull request.    If the change is really as trivial as adding const where needed that shouldn't be a problem.<br>
<p>
Now if a handful of those structures are not const for a some reason I can imaging problems.  Otherwise it should be one of the boring things like big kernel lock push down, that just happens.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692219/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor692250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2016 22:15 UTC (Tue)
                               by <b>tao</b> (subscriber, #17563)
                              [<a href="/Articles/692250/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Having patches broken up per subsystem is *always* the norm for patch submission, especially for people who don't maintain any subsystems already. There are exceptions (people with a proven track record, such as Alexander Viro, for instance, can have their patches accepted even if they touch multiple subsystems at once), but unless a patch is of the "everything *has* to change in lockstep"<br>
type, then you should expect having to submit a patch series per subsystem.<br>
<p>
Sure, you might get lucky and have it accepted anyway, but if you get upset that your patch series doesn't accepted, without being willing to split it up by subsystem, then you might need to re-evaluate your notion that you're really doing what you can to get it merged.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor692267"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel building with GCC plugins</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 21, 2016 23:37 UTC (Tue)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/692267/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Had you read any of the mailing list posts your exposition is based on, you would know that the "advice" you've provided is exactly what Emese ended up doing (as the PaX Team already explained in the comment you're replying to).  I'll save you the hassle of using Google and provide you with direct links to the results of Emese breaking up the patches by subsystem and structure type.  Feel free to read the rest of the thread.<br>
<p>
Greg's request to have them split up by subsystem and structure type: <a href="http://marc.info/?l=linux-kernel&amp;m=126020923129594&amp;w=2">http://marc.info/?l=linux-kernel&amp;m=126020923129594&amp;...</a><br>
Responses to split up patches:<br>
<a href="http://marc.info/?l=linux-kernel&amp;m=126075717420046&amp;w=2">http://marc.info/?l=linux-kernel&amp;m=126075717420046&amp;...</a><br>
<a href="http://marc.info/?l=linux-kernel&amp;m=126075113315052&amp;w=2">http://marc.info/?l=linux-kernel&amp;m=126075113315052&amp;...</a><br>
<a href="http://marc.info/?l=linux-kernel&amp;m=126080632115907&amp;w=2">http://marc.info/?l=linux-kernel&amp;m=126080632115907&amp;...</a><br>
<a href="http://marc.info/?l=linux-kernel&amp;m=126009146214087&amp;w=2">http://marc.info/?l=linux-kernel&amp;m=126009146214087&amp;...</a><br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/692267/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2016, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
