        <!DOCTYPE html>
        <html lang="en">
        <head><title>Handling argc==0 in the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/882799/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/882885/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/882799/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Handling argc==0 in the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 28, 2022</br>
           </div>
By now, most readers are likely to be familiar with the <a
href="/Articles/882609/">Polkit vulnerability</a> known as CVE-2021-4034.
The fix for Polkit is relatively straightforward and is being rolled out
across the net.  The root of this problem, though, lies in a
misunderstanding about how programs are run on Unix-like systems.  This
problem is highly likely to exist in other programs, so it would be nice to
find a more general solution.  The best place to address this issue may be
in the kernel, but properly working around this
misunderstanding without causing regressions is not an easy task.
<p>
<h4>I'd like to have an argument, please</h4>
<p>
Most developers are familiar with the prototype of the main program as
expressed in the C&nbsp;language:
<p>
<pre>
    int main(int argc, char *argv[], char *envp[]);
</pre>
<p>
The program is invoked with its command-line arguments in <tt>argv</tt> and
the environment in <tt>envp</tt>; both are pointers to null-terminated
arrays of
<tt>char&nbsp;*</tt> strings.  The number of non-null entries in
<tt>argv</tt> is stored in <tt>argc</tt>.  This API is a user-space
creation, though; what happens when the kernel first runs a program is a
little bit different: on Linux, that program is passed a single pointer to the
<tt>argv</tt> array.  The <tt>envp</tt> array begins immediately after the
<tt>NULL</tt> value that terminates <tt>argv</tt>.  Thus, in a C program,
the following statement will be true on entry to <tt>main()</tt>:
<p>
<pre>
    envp == argv + argc + 1
</pre>
<p>
By convention, <tt>argv[0]</tt> is the name of the program that is being
executed, and many programs rely on that convention.  As it happens,
though, this convention is exactly that: a convention, but not a guarantee.
The actual contents of <tt>argv</tt> are entirely under the control of
whoever calls <a
href="https://man7.org/linux/man-pages/man2/execve.2.html"><tt>execve()</tt></a>
to run the program in the first place, and that caller is not required to
put the program name in <tt>argv[0]</tt>.
<p>
Indeed, the caller is not required to provide <tt>argv[0]</tt> at all.  If
the <tt>argv</tt> array passed to <tt>execve()</tt> is empty (or the
<tt>argv</tt> pointer is simply <tt>NULL</tt>), the first pointer in the
new program's <tt>argv</tt> array will be <tt>NULL</tt>, 
and the <tt>envp</tt> array will start immediately thereafter.
Unfortunately, Polkit (or, more specifically, the setuid <tt>pkexec</tt> utility)
"knew" that <tt>argv[0]</tt> would always be present,
so it performed its argument processing by iterating over the <tt>argv</tt>
array starting at <tt>argv[1]</tt>.  If there are no arguments at all,
<tt>argv[1]</tt> is the same as <tt>envp</tt>, so <tt>pkexec</tt> was iterating
through its environment variables instead.  Throw in some in-place argument
modification (<tt>pkexec</tt> overwrites its <tt>argv</tt> array), and
<tt>pkexec</tt> could be convinced to rewrite its environment 
variables, thus bypassing the sanitizing of those variables done for setuid
programs.  At that point, the game was over.
<p>
This problem is not new, and neither is awareness of it.  Ryan Mallon <a
href="https://ryiron.wordpress.com/2013/12/16/argv-silliness/">wrote about
it in 2013</a>, noting that "<q>it does allow for some amusing behaviour
from setuid binaries</q>"; he also evidently <a
href="https://twitter.com/ryiron/status/1486207465918468097">sent a Polkit
patch</a> to address it, but that patch was never applied.  Even further
back, in 2007, Michael Kerrisk <a
href="https://bugzilla.kernel.org/show_bug.cgi?id=8408">reported the
kernel's behavior as a bug</a>, but the report was closed with little
discussion.  So the problem persisted, culminating in the vulnerability
administrators are scrambling to patch now.
<p>
<h4>Toward a more general fix</h4>
<p>
Fixing this issue is a simple matter of making <tt>pkexec</tt> check that
<tt>argc</tt> is at least one.  But there are surely other programs out
there containing similar assumptions.  Given the strength of the
<tt>argv[0]</tt> convention, it is natural to ask whether it makes sense to
allow programs to be run with an empty <tt>argv</tt> array at all.  Perhaps
it doesn't, but the current API has a lot of history and cannot be changed
without a lot of thought.
<p>
Ariadne Conill <a
href="/ml/linux-kernel/20220126043947.10058-1-ariadne@dereferenced.org/">started
the linux-kernel discussion</a> with a patch that would simply disallow
calls to <tt>execve()</tt> without at least one <tt>argv</tt> entry.
Offending callers would get an <tt>EFAULT</tt> return value instead.  This would
solve the problem by providing a guarantee that <tt>argv</tt> would not be
empty, but at the potential cost of introducing problems of its own.
One is that, as Kees Cook <a
href="/ml/linux-kernel/39480927-B17F-4573-B335-7FCFD81AB997@chromium.org/">discovered</a>,
there is actually a fair amount of code out there that calls
<tt>execve()</tt> with an empty <tt>argv</tt> array.  Conill <a
href="/ml/linux-kernel/44b4472d-1d50-c43f-dbb1-953532339fb4@dereferenced.org/">wrote
those off</a> as "<q>lazily-written test cases which should be
fixed</q>", but regressions in lazily-written test cases are still
regressions.  Also, as <a
href="/ml/linux-kernel/YfE%2FowUY+gVnn2b%2F@selene.zem.fi/">Heikki
Kallasjoki</a> and <a
href="/ml/linux-kernel/20220126132729.GA7942@brightrain.aerifal.cx/">Rich
Felker</a> both pointed out, an empty <tt>argv</tt> array is actually
allowed by the POSIX standard.
<p>
Felker also suggested an alternative with less potential for regressions:
only enforce a non-empty <tt>argv</tt> at privilege boundaries — when
<tt>execve()</tt> is being called to run a setuid program, in other words.
Cook <a href="/ml/linux-kernel/202201261210.E0E7EB83@keescook/">said</a>
that he would rather avoid taking the privilege boundary into account if
possible, though.
He proposed <a
href="/ml/linux-kernel/20220126175747.3270945-1-keescook@chromium.org/">a
different solution</a> to the problem: inject an extra null pointer at the
end of an empty <tt>argv</tt> array so that even code that tries to skip
<tt>argv[0]</tt> will notice that there is nothing there.  This solution
will not work either, as it turns out: the ABI promise is that <tt>envp</tt> starts
immediately after <tt>argv</tt>, and the extra <tt>NULL</tt> breaks that
promise.  There are evidently programs that rely on that layout and would
break if it were changed.
<p>
Yet another approach, first <a
href="/ml/linux-kernel/877damwi2u.fsf@email.froward.int.ebiederm.org/">suggested</a>
by Eric Biederman, would be to replace an empty <tt>argv</tt> with one
containing a single pointer to an empty string.  This proposal had some
support (though nobody has implemented it as of this writing), but also
provoked some worries of its own.  Perhaps there are programs out there
that will respond badly to an empty-string argument, or which do something
special when <tt>argc</tt> is zero.  Changing the number of arguments
passed to the program run by <tt>execve()</tt> just looks like it could
create surprises.
<p>
Cook eventually <a
href="/ml/linux-kernel/202201261440.0C13601104@keescook/">summarized the
situation</a> this way:
<p>
<blockquote class="bq">
	Given the code we've found that depends on NULL argv, I think we
	likely can't make the change outright, so we're down this weird
	rabbit hole of trying to reject what we can and create work-around
	behaviors for the cases that currently exist.
</blockquote>
<p>
That notwithstanding, he then went on to express a preference for the
initial change (simply 
disallowing a zero-argument <tt>execve()</tt> call anyway, albeit with an
<tt>EINVAL</tt> return rather than <tt>EFAULT</tt>), with a suggestion to
fix a <a href="https://valgrind.org/">Valgrind</a> test that is already
known to break with that restriction.

Conill responded <a
href="/ml/linux-kernel/20220127000724.15106-1-ariadne@dereferenced.org/">with
a new version of the original patch</a>; this time it emits a warning
before failing an empty-<tt>argv</tt> call to <tt>execve()</tt> with
<tt>EINVAL</tt>.  Cook <a
href="/ml/linux-kernel/202201262119.105FA8BCA9@keescook/">acked the
patch</a>, saying: "<q>Let's do it and see what breaks</q>"; Biederman
<a
href="/ml/linux-kernel/87r18tt952.fsf@email.froward.int.ebiederm.org/">concurred</a>:
"<q>Especially since you are signing up to help fix the tests</q>".
<p>
That is where the discussion stands as of this writing, but it is far from
clear that this is how the problem will eventually be addressed.  This
patch has, crucially, not yet survived its first encounter with Linus
Torvalds, who may take a dim view of its potential for regressions.  It
<i>is</i> an ABI change, after all, and there may well be code out there
that responds badly to it, though the fact that BSD systems already
prohibit an empty <tt>argv</tt> will, with luck, have already shaken out
most of those. 
Should unfortunate regressions arise anyway, a different 
solution will almost certainly need to be found.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Vulnerabilities">Security/Vulnerabilities</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-execve">System calls/execve()</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel">Linux kernel</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/882799/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor883061"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 15:21 UTC (Fri)
                               by <b>maxfragg</b> (subscriber, #122266)
                              [<a href="/Articles/883061/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For security reasons it would be a good idea to actually break with the rule of &quot;envp == argv + argc + 1&quot; and move env and argv to separate pages, with one guard in between. This convention really is risky and saving 2 pages does not seem worth it today.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883061/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883067"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 15:42 UTC (Fri)
                               by <b>johnnyapol</b> (subscriber, #151785)
                              [<a href="/Articles/883067/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I like this idea - I had a similar one where issues of argc==0 could be addressed by modifying libc (specifically glibc) to pass in NULL for argv so attempts to read/write would just segfault. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883067/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883069"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:02 UTC (Fri)
                               by <b>Tobu</b> (subscriber, #24111)
                              [<a href="/Articles/883069/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The way argc / argv[] / envp[] are <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/binfmt_elf.c?h=v5.16#n323">laid out on the stack by the elf loader</a> is <a href="https://refspecs.linuxfoundation.org/elf/x86_64-abi-0.99.pdf">part of the elf ABI</a> (for existing architectures at least).

You might be able to shuffle it in userspace, I guess.


      
          <div class="CommentReplyButton">
            <form action="/Articles/883069/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883076"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:15 UTC (Fri)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/883076/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Breaking <tt>envp == (1+ argc + argv)</tt> wlll break all current ELF executables that have been statically linked against glibc. [Asking for a system that is highly robust requires that there be at least a few such programs.] It will also break all executable main programs that have been compressed by <tt>upx</tt>.


      
          <div class="CommentReplyButton">
            <form action="/Articles/883076/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883101"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 17:26 UTC (Fri)
                               by <b>ariadne</b> (subscriber, #138312)
                              [<a href="/Articles/883101/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Breaking contracts like the ELF ABI for security reasons is a bad idea, and this would be a far more severe ABI break than the one I proposed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883101/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 20:14 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/883126/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Note that while, at one time, both C standard and POSIX allowed <code>argc == 0</code> both are fixed now and POSIX, in fact, says that explicitly <a href="https://pubs.opengroup.org/onlinepubs/9699919799.2018edition/functions/execve.html">to remove any shadow of doubt</a>:</p>

<font class="QuotedText">&gt; The wording, in particular the use of the word <i>should</i>, requires a Strictly Conforming POSIX Application to pass at least one argument to the <code>exec</code> function, thus guaranteeing that <code>argc</code> be one or greater when invoked by such an application.</font>

<p>So yes, it's a mess, kinda, because yes, old standards explicitly allowed this, but <b>these standards were fixed</b>.</p>

<p>Whether Linux can or should take advantage of that change is another story, of course.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/883126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:52 UTC (Fri)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/883141/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
People care far less about standards written on paper than all the programs that will break or behave unexpectedly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 0:23 UTC (Sat)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/883154/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus&#x27;s &quot;no user regressions&quot; policy covers *many* programs which are not Strictly Conforming POSIX Applications, so I&#x27;m not sure how that change in the standard is relevant. For example, anything that depends on Linux-specific interfaces, or on any implementation-defined behavior not specified by POSIX, is not a Strictly Conforming POSIX Application. (How many Strictly Conforming POSIX Applications are there in an average Linux installation, really?)<br>
<p>
If you do claim to be a Strictly Conforming POSIX Application then you can&#x27;t call exec with less than one argument. However, a Strictly Conforming POSIX Application may be *invoked* with zero arguments, and is required to handle that case as well to qualify as Strictly Conforming since POSIX does not specify that the argument list passed to main() will be non-empty and you can&#x27;t assume every other program in the system is also Strictly Conforming.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883155"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 1:43 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/883155/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It’s relevant insofar as the argument - which I believe was made in the article? - that “POSIX allows this” is used in support of it.  It’s irrelevant insofar as there are real applications which use it (and one cares about them).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883155/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 10:43 UTC (Sat)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Absolutely not, POSIX says, more completely:<br>
<p>
<font class="QuotedText">&gt; Early proposals required that the value of argc passed to main() be &quot;one or greater&quot;. This was driven by the same requirement in drafts of the ISO C standard. In fact, historical implementations have passed a value of zero when no arguments are supplied to the caller of the exec functions. This requirement was removed from the ISO C standard and subsequently removed from this volume of POSIX.1-2017 as well.</font><br>
<p>
There&#x27;s no hard requirement on argc.<br>
<p>
<font class="QuotedText">&gt; The wording, in particular the use of the word should, requires a Strictly Conforming POSIX Application to pass at least one argument to the exec function, thus guaranteeing that argc be one or greater when invoked by such an application. In fact, this is good practice, since many existing applications reference argv[0] without first checking the value of argc.</font><br>
<p>
A *strictly* conforming application.  This is more than just &quot;plain&quot; POSIX.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor883065"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 15:47 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883065/">Link</a>] (28 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think there are few things confused here and in the Kernel ML, namely the case a) argv == NULL and the case b) argv[0] == NULL:<br>
<p>
<font class="QuotedText">&gt; If the argv array passed to execve() is empty (or the argv pointer is simply NULL), the first pointer in the new program&#x27;s argv array will be NULL, and the envp array will start immediately thereafter. </font><br>
<p>
POSIX says that argv == NULL isn&#x27;t allowed:<br>
<p>
<font class="QuotedText">&gt; The argument argv is an array of character pointers to null-terminated strings. The application shall ensure that the last member of this array is a null pointer. </font><br>
<p>
(<a href="https://pubs.opengroup.org/onlinepubs/9699919799.2018edition/functions/execve.html">https://pubs.opengroup.org/onlinepubs/9699919799.2018edit...</a>)<br>
<p>
That&#x27;s also what the kernel bug (<a href="https://bugzilla.kernel.org/show_bug.cgi?id=8408">https://bugzilla.kernel.org/show_bug.cgi?id=8408</a>) from years back is about.  It is *not* about enforcing argc &gt;= 1 (i.e., argv[0] != NULL).<br>
<p>
The patch by Ariadne Conill does *not* address what was reported in the bug, despite claiming so.  It enforces that case b) never happens which is a stricter requirement and indeed not required by POSIX, as correctly pointed out by Heikki Kallasjoki and Rich Felker.  This is just a recommendation:<br>
<p>
<font class="QuotedText">&gt; The value in argv[0] should point to a filename string that is</font><br>
associated with the process [...]<br>
<p>
I agree that Linux should not allow argv == NULL, that&#x27;s definitely against the spec.  argv[0] == NULL is a different matter although I think it is a reasonable demand, from a security stand point.<br>
<p>
-------<br>
<p>
Appendix:<br>
<p>
POSIX on shall and should:<br>
<p>
<font class="QuotedText">&gt; shall</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt; For an implementation that conforms to POSIX.1-2017, describes a feature or behavior that is mandatory. An application can rely on the existence of the feature or behavior.</font><br>
<p>
<font class="QuotedText">&gt; should</font><br>
<font class="QuotedText">&gt;</font><br>
<font class="QuotedText">&gt; For an implementation that conforms to POSIX.1-2017, describes a feature or behavior that is recommended but not mandatory. An application should not rely on the existence of the feature or behavior. An application that relies on such a feature or behavior cannot be assured to be portable across conforming implementations.</font><br>
<p>
(<a href="https://pubs.opengroup.org/onlinepubs/9699919799.2018edition/basedefs/V1_chap01.html">https://pubs.opengroup.org/onlinepubs/9699919799.2018edit...</a>)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883065/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883078"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:26 UTC (Fri)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/883078/">Link</a>] (25 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I think there are few things confused here and in the Kernel ML, namely the case a) argv == NULL and the case b) argv[0] == NULL:</font><br>
<p>
Probably the confusion is for a simple reason. The two things are more or less the same. If the execve() function is called with argv == NULL, the kernel actually constructs a NULL-terminated array argv with argv[0] == NULL and calls main(argv,0). Thus for the called application, these two things are indistinguishable.<br>
<p>
<font class="QuotedText">&gt; I agree that Linux should not allow argv == NULL, that&#x27;s definitely against the spec.</font><br>
<p>
From the examples in the discussions it seems that the &quot;lazily written tests&quot; do exactly this: call execve() with argv == NULL. If Linux disallows this, these tests will break due to an ABI/API change.<br>
<p>
<font class="QuotedText">&gt; argv[0] == NULL is a different matter although I think it is a reasonable demand, from a security stand point.</font><br>
<p>
Yeah, but disallowing the former and allowing the latter does not make any sense, as the two cases cannot be distinguished by the called application. There would be no advantage from just disallowing argv == NULL. <br>
<p>
The problematic case from the security persepctive is allowing argv[0] == NULL (or more precisely argc==0). The problematic case from the compatibility perspective is disallowing argv == NULL in the execve() call. Thus only disallowing argv == NULL in the call gives us the worst from both perspectives. We get all compatibility problems with no increase in security. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883078/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:35 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883085/">Link</a>] (24 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That makes sense, I didn&#x27;t know that Linux constructed the {NULL} array.  However, this makes many people be confused about the original bug and the BSD behavior.  E.g., FreeBSD, until 2 days ago, allowed a {NULL} array as argv but not argv==NULL.<br>
<p>
<font class="QuotedText">&gt;  Yeah, but disallowing the former and allowing the latter does not make any sense, as the two cases cannot be distinguished by the called application. There would be no advantage from just disallowing argv == NULL.</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt; The problematic case from the security persepctive is allowing argv[0] == NULL (or more precisely argc==0). The problematic case from the compatibility perspective is disallowing argv == NULL in the execve() call. Thus only disallowing argv == NULL in the call gives us the worst from both perspectives. We get all compatibility problems with no increase in security. </font><br>
<p>
I disagree here though. Disallowing argv == NULL but allowing argv[0] == NULL would allow for this &quot;iterator&quot; pattern (which is as old as UNIX):<br>
<p>
    for (**arg = &amp;argv[1]; arg &lt; &amp;argv[argc]; arg++)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:57 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/883089/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Allowing <tt>argv[0]==NULL</tt> would indeed allow the "old as Unix" pattern to work.  But it also works fine now in the <tt>argv==NULL</tt> case.  The pattern, perhaps equally old, that fails is:
<p>
<pre>
    for (arg = argv + 1; *arg; arg++)
        /* ... */
</pre>
<p>
...and that pattern will still fail badly with <tt>argv[0]==NULL</tt>.



      
          <div class="CommentReplyButton">
            <form action="/Articles/883089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883095"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 17:00 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883095/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Arguably a bad pattern :-)<br>
<p>
But I think that Ariadne&#x27;s patch should be applied nontheless. It&#x27;s just that there&#x27;s much confusion about these two different issues (although related).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883095/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883187"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 18:56 UTC (Sat)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/883187/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The best, UB free, pattern is<br>
<p>
for (int i = 1; i &lt; argc; ++i) { const char *arg = argv[i]; ... }<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883187/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883230"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 23:32 UTC (Sun)
                               by <b>rschroev</b> (subscriber, #4164)
                              [<a href="/Articles/883230/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s simple, readable, clearly states the intent. Why do people even try to come up with other ways to do things?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883230/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 1:01 UTC (Mon)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/883232/">Link</a>] 
      </p>
      
      </div>
      </summary>
      &gt;<i>Why do people even try to come up with other ways to do things?</i>
<p>Because that does not accommodate state changes: deleting, re-arranging, or re-writing pieces of <tt>argv</tt> (and thus <tt>argc</tt>); because the GNU <tt>getopt</tt> routine has not always existed, has not always offered all its current features, and early suffered from bugs; and probably other reasons, too.


      
          <div class="CommentReplyButton">
            <form action="/Articles/883232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor883088"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 17:12 UTC (Fri)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/883088/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I disagree here though. Disallowing argv == NULL but allowing argv[0] == NULL would allow for this &quot;iterator&quot; pattern (which is as old as UNIX):</font><br>
<font class="QuotedText">&gt; for (**arg = &amp;argv[1]; arg &lt; &amp;argv[argc]; arg++)</font><br>
<p>
Disallowing argv[0] still allows for this pattern. The security problem arises with applications relying on argc&gt;0 (like pkexec did). <br>
<p>
And there is really no reason to disallow argv == NULL (in the execve()-call) while allowing argv[0] == NULL. As Linux constructs the { NULL } array, both things cannot be distinguished from the called application. There is no reason to get all the compatibility problems arising from disallowing argv == NULL without gaining any security benefit. Either we want the get rid of the security issues. Then we have to disallow argv[0] == NULL. Or we can leave everything as it is now.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883088/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883166"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 8:31 UTC (Sat)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/883166/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; for (**arg = &amp;argv[1]; arg &lt; &amp;argv[argc]; arg++)</font><br>
<p>
I just was wondering if this is UB if argc==0. Probably it is. According to the C standard argv is a argc+1 sized array, where argv[argc] == NULL. If argc is 0, argv[1] uses an index outside of the bounds of the array. Thus even writing argv[1] would be UB. The code argv+1 instead of &amp;argv[1] would be valid, as it is perfectly allowed to construct a pointer pointing to the address immediately after the end of an array. However one is not allowed to dereference it.<br>
<p>
I do not really expect this to break even in the case of argc==0 and of course as long as the program is called with argc&gt;0 this code is not UB at all. But a conforming compiler can probably eliminate a check argc!=0 that occurs later on, because the very fact that argv[1] has been used tells the compiler that either argc&gt;0 or the code is UB and the compiler is free to do whatever it wants.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883166/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883172"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 10:39 UTC (Sat)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883172/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; However one is not allowed to dereference it.</font><br>
<p>
But there&#x27;s no dereferencing?  But more plainly perhaps:<br>
<p>
    for (char **arg = argv + 1; arg &lt; argv+argv; arg++)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883172/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883174"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 11:05 UTC (Sat)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/883174/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
argv[1] is clearly dereferencing and the &amp; operator then takes the address of the dereferenced value. If you have an invalid pointer, you are not allowed to dereference it. Writing &amp;*a is UB if a is an invalid pointer, even if the combination of &amp; and * should be a no-op. And writing &amp;argv[1] is UB if argv is an array of length 1 (only containing the terminating NULL) as writing argv[1] is already UB. You cannot make the UB of argv[1] be defined again by later taking the address.<br>
<p>
I agree that the compiler will probably generate the exact same code for **arg = &amp;argv[1] and **arg = argv + 1. But in the first case, the compiler is allowed to conclude that the length of the argv array is at least two (including the final NULL value), as argv[1] is UB if the array has length one. I am not saying that any compiler actually does this, but when it comes to UB, compilers are known to do very crazy things, so it is not entirely impossible. And in the case of the main function it is even less likely that the compiler will do anything crazy. The pointer is provided by the OS and the compiler does not know the length of the array (unless it uses the special connection between argv and argc). So the code should probably be fine. But this is one of the things I really do not like about C. The threat of UB is almost everywhere. And at some point in the future some clever compiler will exploit this against you.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883174/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 11:22 UTC (Sat)
                               by <b>mchapman</b> (subscriber, #66589)
                              [<a href="/Articles/883175/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Writing &amp;*a is UB if a is an invalid pointer, even if the combination of &amp; and * should be a no-op.</font><br>
<p>
No, this is not correct.<br>
<p>
C specifies that &amp;*a is equivalent to a: &quot;neither [the * operator] nor the &amp; operator is evaluated and the result is as if both were omitted&quot;. This expression is valid for any value of a, even a null pointer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883202"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 23:08 UTC (Sat)
                               by <b>areilly</b> (subscriber, #87829)
                              [<a href="/Articles/883202/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;And writing &amp;argv[1] is UB if argv is an array of length 1 (only containing the terminating NULL) as writing argv[1] is already UB.&quot;<br>
<p>
No: &amp;argv[1] is semantically identical to argv + 1.  It is pointer arithmetic and does not cause a dereference.<br>
<p>
However: in deference to C support on AS400 (and Unisys? anything with fancy pointer representations) it *is* undefined behaviour for arrays of length zero.  It&#x27;s only legal to construct a pointer value to the single element past the end of the array, whether or not the pointer is subsequently dereferenced.  This is also why it&#x27;s technically illegal to use a post-decremented pointer traversal that accesses the first element of an array.  The one-past-the-end rule doesn&#x27;t extend to one-before-the-beginning.  Sigh.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883202/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883212"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 10:43 UTC (Sun)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883212/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; However: in deference to C support on AS400 (and Unisys? anything with fancy pointer representations) it *is* undefined behaviour for arrays of length zero.</font><br>
<p>
Aren&#x27;t zero-length arrays a GNU extension?  Or do you refer to flexible struct members?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883212/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883213"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 11:23 UTC (Sun)
                               by <b>areilly</b> (subscriber, #87829)
                              [<a href="/Articles/883213/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To  be honest, I was thinking about the argc==0 example here, where the argument vector allocation was real, because it was just the first part before an explicit null and the environment variable elements.  In that case I don&#x27;t think that the one-past-the-end situation arises, because the memory object is the whole thing and clearly not zero length.  OK, I don&#x27;t think that the zero-length issue is a thing, sorry.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883213/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 9:50 UTC (Mon)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883247/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, I see, I was just curious if I missed something :)  No problem!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883221"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 20:21 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883221/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is legal to call malloc(0), and it is legal for malloc(0) to return a value other than NULL. If it does so, then the only thing you&#x27;re allowed to do with that value is pass it to free(). In particular, you cannot add one to it, because it&#x27;s functionally equivalent to a zero-length array (but I don&#x27;t know if the standard actually uses the exact phrase &quot;zero-length array&quot;).<br>
<p>
In practice, most implementations either return NULL or convert it into a call to malloc(1). But even then, that&#x27;s a one-byte array, not a one-object array, so you still can&#x27;t legally add one to it unless the pointer&#x27;s type has sizeof() == 1.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883221/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 20:23 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883222/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; then the only thing you&#x27;re allowed to do with that value is pass it to free().</font><br>
<p>
Or realloc(), I suppose. Point is, you definitely can&#x27;t dereference it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">malloc(0)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 1:20 UTC (Mon)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/883233/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      &gt;<i>It is legal to call malloc(0), and it is legal for malloc(0) to return a value other than NULL. If it does so, then the only thing you're allowed to do with that value is pass it to free()</i>
<p>One of the uses of <tt>malloc(0)</tt> is to serve as an analogue of the Lisp function <tt>(gensym)</tt>: return a unique value, one that does not point to anything else returned by <tt>malloc</tt>, both now and for the remaining life of the process.  (Yes, the standard requires this.)  An implementation for which <tt>malloc(0)</tt> always returns NULL is not acceptable.  So in practice, many implementations begin with something like <tt>size += (0==size)</tt>, i.e. <tt>malloc(0)</tt> is treated as <tt>malloc(1)</tt>.


      
          <div class="CommentReplyButton">
            <form action="/Articles/883233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">malloc(0)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 1:31 UTC (Mon)
                               by <b>ABCD</b> (subscriber, #53650)
                              [<a href="/Articles/883235/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>An implementation for which <tt>malloc(0)</tt> always returns <tt>NULL</tt> is expressly permitted by the POSIX standard:</p>

<blockquote><p>
If the size of the space requested is 0, the behavior is implementation-defined: the value returned shall be either a null pointer or a unique pointer.
</p></blockquote>

<p>The C17 standard says something similar:</p>
<blockquote><p>
If the size of the space requested is zero, the behavior is implementation-defined: either a null pointer is returned to indicate an error, or the behavior is as if the size were some nonzero value, except that the returned pointer shall not be used to access an object.
</p></blockquote>



      
          <div class="CommentReplyButton">
            <form action="/Articles/883235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">malloc(0)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 9:43 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883244/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The null pointer satisfies all of the technical requirements of a heap-allocated zero-length array (you can form a pointer that is one past the end, you can iterate over it zero times with a standard for loop, and you can pass it to realloc without breaking anything), and all heap-allocated zero-length arrays are functionally identical because they have no state which can be mutated, so returning NULL can be thought of as semantically equivalent to a copy elision (i.e. you could think of all heap-allocated zero-length arrays as &quot;copies&quot; of the zero-length array that lives at NULL, and then you can elide those copies because zero-length arrays are immutable, so making a copy is unnecessary).<br>
<p>
The fact that it happens to vaguely resemble some feature of Lisp, but the standard does not actually require it to fulfill all the requirements of that feature is, frankly, Lisp&#x27;s problem, not C&#x27;s problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 10:02 UTC (Mon)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883251/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fair enough, although I *think* C restricts the meaning of array to things that are declared T D[N];  Zero-allocations are definitely possible though, yes, and POSIX is a bit more lax about wording since they say &quot;argv is an array&quot; while, in C terminology, it&#x27;s &quot;just&quot; a pointer to some memory that... and so on.<br>
<p>
Anyway, the POSIX standard pretty clearly says that argv is NULL-terminated, that is, not by itself a zero-length array, but at least<br>
<p>
    char **argv = { NULL };<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor883207"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 3:24 UTC (Sun)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/883207/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If argc is 0, argv[1] uses an index outside of the bounds of the array. Thus even writing argv[1] would be UB.</font><br>
<p>
Another comment by areilly hinted at this already, but evaluating argv[1] for an argv array of size 1 (where argc == 0) is not undefined behavior. You are allowed to construct (but not dereference) a pointer to the element immediately after the end of an array. (Taking the address of a dereference or array indexing expression does not count as actually dereferencing the pointer: even though argv[1] in an expression by itself would be UB, &amp;argv[1] and &amp;*(argv + 1) are both semantically identical to the pointer arithmetic operation argv + 1. The address-of operator &quot;cancels out&quot; the dereference.) So there is no undefined behavior in the example, even if argc == 0, as &amp;argv[1] and &amp;argv[0] are both valid pointers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883207/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor889485"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 28, 2022 21:41 UTC (Mon)
                               by <b>fest3er</b> (guest, #60379)
                              [<a href="/Articles/889485/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;According to the C standard argv is a argc+1 sized array, where argv[argc] == NULL. If argc is 0, argv[1] uses an index outside of the bounds of the array.&quot;<br>
<p>
Hmmm. Off-by-one seems to rear its head here. If argc is 0, then argv[] should contain 0+1 elements, thus only argv[0] exists and should be null and argv[1] is out-of-bounds.<br>
<p>
Aside, why are people saying that argv is the same as argv[0]? Isn&#x27;t argv the address of the array, and argv[0] the address of the zeroeth argument (or null to indicate the end of the array)? Thus, shouldn&#x27;t argv always be a valid pointer to an array and the array always contain at least the terminating NULL pointer?<br>
<p>
And when the kernel constructs the argv array, does it use its memory or the user&#x27;s memory?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/889485/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor889534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 29, 2022 12:51 UTC (Tue)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/889534/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Hmmm. Off-by-one seems to rear its head here. If argc is 0, then argv[] should contain 0+1 elements, thus only argv[0] exists and should be null and argv[1] is out-of-bounds.</font><br>
<p>
Yes, of course. If argc is 0, then the argument vector is empty and only contains the terminating NULL at index 0. You can&#x27;t expect to find anything of interest in argv[1].<br>
<p>
<font class="QuotedText">&gt;And when the kernel constructs the argv array, does it use its memory or the user&#x27;s memory?</font><br>
<p>
The argv array is in the process (user) address space. You can print the address of argv if you are interested to find out where it is located.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/889534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor889604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 29, 2022 20:16 UTC (Tue)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/889604/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The code argv+1 instead of &amp;argv[1] would be valid, as it is perfectly allowed to construct a pointer pointing to the address immediately after the end of an array. However one is not allowed to dereference it.</font><br>
<p>
From C99 (draft) §6.5.3.2:<br>
<p>
<font class="QuotedText">&gt; If the operand is the result of a unary * operator, neither that operator nor the &amp; operator is evaluated and the result is as if both were omitted, except that the constraints on the operators still apply and the result is not an lvalue. Similarly, if the operand is the result of a [] operator, neither the &amp; operator nor the unary * that is implied by the [] is evaluated and the result is as if the &amp; operator were removed and the [] operator were changed to a + operator.</font><br>
<p>
So &quot;&amp;argv[1]&quot; is effectively rewritten as &quot;argv+1&quot; and there is no undefined behavior either way. You could even have an expression like &quot;&amp;(*p)&quot; or &quot;&amp;p[0]&quot; where p == NULL and the result will be well-defined (NULL). A conforming compiler cannot assume that argc &gt; 0 based on the presence of &quot;&amp;argv[1]&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/889604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor883124"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 20:07 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/883124/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>You found the right page, just, perhaps, not the right quote. I think that one should close that discussion about meanings of different words:</p>

<font class="QuotedText">&gt; The wording, in particular the use of the word <i>should</i>, requires a Strictly Conforming POSIX Application to pass at least one argument to the exec function, thus guaranteeing that argc be one or greater when invoked by such an application.</font>

<p>I don't think explanations can be more clear than that.</p>

<p>You don't need to dig around for strict meanings of different words, authors of the standard did that for you.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/883124/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:13 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883132/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But in what way does this contradict what I say?  &quot;should&quot; means that this is a recommendation, i.e., a *strictly* conforming application needs to fulfill this criterion.  But POSIX only uses should for argv[0] being the program name, but they use *shall* for argv ≠ NULL.  Which is precisely my point.  The latter is a *must do*, the former is not as strict as a requirement.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor883074"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:08 UTC (Fri)
                               by <b>judas_iscariote</b> (guest, #47386)
                              [<a href="/Articles/883074/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
POSIX says a lot a crazy things..and is technically wrong worringly often.. When will people stop language-lawyering things and get real ?<br>
<p>
BSDs on this case return -EFAULT , other OSs return -EINVAL..so  allowing this behaviour is not the common standard..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883074/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883081"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:18 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883081/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At least FreeBSD runs this fine.  They do return -EFAULT though when you do:<br>
<p>
    execve(&quot;/bin/date&quot;, NULL, NULL);<br>
<p>
as mentioned in the year-old bug report.  But this patch is about<br>
<p>
    execve(&quot;/bin/date&quot;, &amp;(char*){NULL}, NULL);<br>
<p>
which neither FreeBSD thinks is faulty, nor POSIX requires (i.e., FreeBSD is exactly in line with POSIX here).  POSIX however recommends that argv[0] != NULL.<br>
<p>
There are two issues here, a) that Linux isn&#x27;t POSIX conforming, allowing argv == NULL, and b) pkexec relying on argv[0] != NULL which is only a POSIX recommendation.  I do think the patch from Ariadne Conill should be applied, but then Linux is decidedly stricter than FreeBSD.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883081/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883083"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 16:22 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883083/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
However, FreeBSD has applied a similar patch as proposed by Ariadne 2 days ago:<br>
<p>
<a href="https://github.com/freebsd/freebsd-src/commit/773fa8cd136a5775241c3e3a70f1997633ebeedf">https://github.com/freebsd/freebsd-src/commit/773fa8cd136...</a><br>
<p>
Copied from OpenBSD, says the commit message.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883083/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 17:33 UTC (Fri)
                               by <b>ariadne</b> (subscriber, #138312)
                              [<a href="/Articles/883103/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s about both, Linux turns NULL into {NULL} which is then rejected by the patch.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 17:44 UTC (Fri)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883106/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fair enough :D<br>
<p>
But, at least to me, it was kind of confusing at first to see these two mangled.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883220"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 18:44 UTC (Sun)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/883220/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
Linux isn't POSIX conforming, allowing argv == NULL
</blockquote>

Can you support this claim with actual POSIX wording?


      
          <div class="CommentReplyButton">
            <form action="/Articles/883220/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883249"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 9:58 UTC (Mon)
                               by <b>larkey</b> (guest, #104463)
                              [<a href="/Articles/883249/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The POSIX standard says:<br>
<p>
<font class="QuotedText">&gt; The argument argv is an array of character pointers to null-terminated strings. The application shall ensure that the last member of this array is a null pointer. </font><br>
<p>
There is nothing in POSIX saying &quot;it may be an array, but it also may be NULL&quot;.  If a pointer may be NULL in any C function, this is explicitly noted.  Compare the standard on strtol(3):<br>
<p>
<font class="QuotedText">&gt; A pointer to the final string shall be stored in the object pointed to by endptr, provided that endptr is not a null pointer.</font><br>
<p>
<p>
(<a href="https://pubs.opengroup.org/onlinepubs/9699919799/functions/strtol.html">https://pubs.opengroup.org/onlinepubs/9699919799/function...</a>).<br>
<p>
This is making it explicit that endptr may be NULL.  The nptr argument, however, may not be NULL i.e.,<br>
<p>
    strtol(NULL, NULL, 10);<br>
<p>
is *not* allowed.  In the same vain, you can&#x27;t just make argv be NULL.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883249/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 12:35 UTC (Mon)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/883255/">Link</a>] 
      </p>
      
      </div>
      </summary>
      In all of this text I see only requirements on the application, not on the OS.  An application must not pass argv=NULL, and POSIX does not define define what the OS shall do if the application is non-conforming in this respect.  Linux has a certain behaviour, BSD a different one, both conforming AFAICT.


      
          <div class="CommentReplyButton">
            <form action="/Articles/883255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor883113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 18:53 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/883113/">Link</a>] (29 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just idly speculating here... what would the fallout be if instead of throwing an error, the kernel filled in an empty argv with &quot;/proc/self/exe&quot;? That&#x27;s going from one Linux-specific behaviour to another but I&#x27;m guessing it&#x27;d still close the original exploit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883115"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 19:16 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883115/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMHO the kernel should only try to provide a meaningful value there if we can be 100% sure it will actually work (because if it only works 95% of the time, someone will depend on it until it breaks). Problems include:<br>
<p>
* /proc might not be mounted at all, or it might be mounted somewhere other than /proc.<br>
* / might not be / (e.g. chroot, containers, etc.), and so /proc might be inaccessible.<br>
* The callee might try to pass the argv[0] string on to some other process, but then /proc/self will be interpreted as that process.<br>
* If you try to fix the above using an absolute PID instead of &quot;self,&quot; then you run into PID namespaces.<br>
* There are a variety of situations where the called process&#x27;s binary is not directly accessible to the called process as a regular file, and /proc/self/exe appears to be a broken symlink. The only way to fix this problem is for the caller to provide a suitable alternative path, if a functional argv[0] is desired at all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883115/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883225"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 21:42 UTC (Sun)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/883225/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would the case where you delete the executable file also fall into this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883225/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883370"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2022 1:34 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883370/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t know the inner guts of procfs symlink resolution, but I imagine so.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883370/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883424"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2022 14:57 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/883424/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve actually played around with this before. So if you create an executable and check its `/proc/$pid/exe` (I think I was actually playing with `/proc/$pid/fd/$n`, but I imagine it&#x27;s similar behavior). It is linked to `/path/to/exe`. If you delete it, the symlink now &quot;points to&quot; `/path/to/exe (deleted)`. If you then create *this* path, the symlink is still broken even though the &quot;target path&quot; exists if you manually use the `readlink` result. Creating the original path also keeps it in the &quot;(deleted)&quot; state IIRC.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883424/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2022 18:07 UTC (Tue)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/883447/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If you delete it, the symlink now &quot;points to&quot; `/path/to/exe (deleted)`.</font><br>
<p>
Interesting fact: Even though the /proc/$PID/exe symlink is &quot;broken&quot; you can still open it, producing a reference to the original file. The /proc filesystem has its own special rules for resolving symlinks. However, attempting to restore the file by creating a hard-link with `ln` or `link` gives the error &quot;Invalid cross-device link&quot; even though the original (deleted) file and the target directory are on the same filesystem. (You can *copy* /proc/$PID/exe to a new file, though.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883980"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 7, 2022 9:28 UTC (Mon)
                               by <b>jwilk</b> (subscriber, #63328)
                              [<a href="/Articles/883980/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>"<code>ln /proc/$PID/exe foo</code>" fails with <code>EXDEV</code>, because it's trying to hardlink the symlink that resides in <code>/proc</code>.

<p>You probably wanted "<code>ln -L /proc/$PID/exe foo</code>" to dereference the symlink… which still doesn't work, but at least you get a more understandable error message. (The dereferencing happens on the kernel side, so it <em>could</em> work in principle.)











      
          <div class="CommentReplyButton">
            <form action="/Articles/883980/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884047"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 7, 2022 18:27 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/884047/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You probably wanted &quot;ln -L /proc/$PID/exe foo&quot; to dereference the symlink...</font><br>
<p>
Yes, I tried it both with and without the -L option—I suppose I should have mentioned the difference in the error message. The kernel specifically blocks the creation of a hard-link to a previously deleted (zero-refcount) inode. It does work, however, if the inode still exists in the filesystem due to hard-links, even if the original path was deleted and the /proc/$PID/fd/N symlink is broken.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884047/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884418"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 10, 2022 21:21 UTC (Thu)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/884418/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The kernel specifically blocks the creation of a hard-link to a previously deleted (zero-refcount) inode.</font><br>
<p>
If you an open the deleted /proc/pid/exe, why would linkat(fd, &quot;&quot;, AT_FDCWD, &quot;/path/for/file&quot;, AT_EMPTY_PATH); not work? A filedescriptor obtained with open( &quot;.&quot;, , | O_RDWR ) has to have a zero st_nlink as well.<br>
<p>
I have never done an open(,O_TMPFILE) + linkat(fd, &quot;&quot;, AT_FDCWD,...) so this may be a misconception.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884418/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2022 0:29 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/884452/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I also find the restrictions a bit surprising, but Linus&#x27;s response[0] when someone proposed an flink() system call[1]—which would have been more-or-less equivalent to hard-linking from /proc/$PID/fd/$N, with the primary use-case involving creating links to previously unlinked files—was a flat rejection: &quot;there is no way in HELL we can do this securely without major other incursions.&quot; I believe the result of this discussion was a number of new restrictions on hard-linking files via /proc.<br>
<p>
There are various things you can still do with /proc/$PID/fd/$N which may prove surprising from a security point of view. For example, if a file descriptor is opened read-only and passed to another user over a socket, or inherited by a child process, then normally the recipient can only read from that FD, even if they would have had write access to the original file. However, the target process inheriting that file descriptor can open /proc/self/fd/$N *for writing* and modify the contents of the file, even without access to the original path, so long as permissions on the file itself are compatible:<br>
<p>
user$ mkdir my_dir<br>
user$ chmod 0700 my_dir<br>
user$ cd my_dir<br>
user$ echo test &gt; testfile<br>
user$ chmod 0666 testfile<br>
user$ exec 3&lt; testfile<br>
user$ su -c &#x27;su nobody -s /bin/bash&#x27;  # can&#x27;t use sudo here as by default it would close the FD<br>
nobody$ ls -l /proc/self/fd/3<br>
lr-x------ 1 nobody nogroup 64 Feb 10 00:00 /proc/self/fd/3 -&gt; /home/user/my_dir/testfile<br>
nobody$ cat /home/user/my_dir/testfile  # no access via my_dir<br>
cat: /home/user/my_dir/testfile: Permission denied<br>
nobody$ cat /proc/self/fd/3<br>
test<br>
nobody$ echo attempt1 1&gt;&amp;3  # writing to the FD itself fails, because it was opened read-only<br>
bash: echo: write error: Bad file descriptor<br>
nobody$ echo attempt2 &gt; /proc/self/fd/3  # but this succeeds!<br>
nobody$ cat /proc/self/fd/3<br>
attempt2<br>
nobody$ mkdir /tmp/other_dir &amp;&amp; cd /tmp/other_dir<br>
nobody$ ln -L /proc/self/fd/3 testfile_link  # this works despite /proc/sys/fs/protected_hardlinks because we have read and write access to the file<br>
nobody$ ls -l testfile_link<br>
-rw-rw-rw- 3 user user 9 Feb 10 00:00 testfile_link<br>
nobody$ echo attempt3 &gt; testfile_link<br>
nobody$ cat testfile_link<br>
attempt3<br>
nobody$ exit<br>
user$ cat testfile  # confirm that the original file was changed<br>
attempt3<br>
<p>
The overall moral of this example is that if you&#x27;re relying on restrictive permissions on a parent directory to restrict access to otherwise-writable files it may not work out quite the way you hoped.<br>
<p>
[0] <a href="https://marc.info/?l=linux-kernel&amp;m=104973707408577&amp;w=2">https://marc.info/?l=linux-kernel&amp;m=104973707408577&amp;...</a><br>
<p>
[1] <a href="https://marc.info/?l=linux-kernel&amp;m=104965452917349">https://marc.info/?l=linux-kernel&amp;m=104965452917349</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor883125"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 20:06 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/883125/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <p>You don't need to muck about in /proc.  The first argument to execve() is the pathname being executed; that could be placed as argv[0]. </p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/883125/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883127"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 20:20 UTC (Fri)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/883127/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not just pass &quot;&quot;, i.e. the empty string? <br>
<p>
If a callee does not inspect argv[0], then any string is good. If a callee expects some non-empty string as argv[0], then calling with argv pointing to { NULL } does not work today. And there is no reason why it should work tomorrow. Doing anything else than aborting with an error would only be to be backwards compatible with the current situation. <br>
<p>
The only reason this could break anything that is working now that I can images is, that some callee actually expects to be called with argc==0 and argv pointing to { NULL }. But this would be really weird.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883127/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883226"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 21:43 UTC (Sun)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/883226/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could run into issues with programs that check argc. They may expect it to be zero, or they may expect it to be 1 with a valid path, but they may not expect it to be 1 with an invalid path.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883226/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 20:24 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/883128/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Nope. It couldn't. Since that one, too, may be <code>/proc/self/exe</code> (and, indeed there are one case where pattern <code>exec("/proc/self/exe", NULL, NULL);</code> is used).</p>

<p>So it's not bullet-proof and, I think, few examples where this Linux-only misfeature is exploited are not worth inventing crazy schemes.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/883128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883131"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:07 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/883131/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>But if <code>execve("/proc/self/exe", NULL, NULL);</code> succeeds, under what circumstances could <code>/proc/self/exe</code> not be relied on in the execed program?


      
          <div class="CommentReplyButton">
            <form action="/Articles/883131/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883136"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:15 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/883136/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>When someone would call `realpath` on it? That never happened in real-world usecase so yeah, you are right, that may a way out.</p>

<p>Of course this would also break most tests anyway thus it's not clear if couple of real programs are worth that complexity.</p>

<p>Kernel config option looks more and more sensible: we know such programs are rare, but how rare exactly?</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/883136/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883139"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:26 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/883139/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p><code>realpath</code> is an executable; I think you meant <code>readlink(2)</code>.  But my point is this:  If the original <code>execve</code> call succeeds, then <code>"/proc/self/exe"</code> must still be valid in the exec'd program.  if <code>/proc/self/exe</code> were not valid, then the <code>execve</code> call would fail.





      
          <div class="CommentReplyButton">
            <form action="/Articles/883139/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883159"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 2:48 UTC (Sat)
                               by <b>comex</b> (subscriber, #71521)
                              [<a href="/Articles/883159/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not to get lost in the weeds, but realpath is also the name of a function; see `man 3 realpath`.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883159/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor883129"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 20:31 UTC (Fri)
                               by <b>floppus</b> (guest, #137245)
                              [<a href="/Articles/883129/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But if any setuid program actually relies on argv[0] being the name of the program, that&#x27;s a severe bug (symlinks, TOCTOU, etc., never mind the fact that the caller can always specify any string they want.)<br>
<p>
If the kernel were to silently replace argc==0 with argc==1, it seems like using an empty string would be most parsimonious.  At least an empty string is guaranteed not to be a valid filename, whereas /proc/self/exe or the name of the executable might or might not be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883129/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883133"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:11 UTC (Fri)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/883133/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>I think either an empty string or a copy of the first argument to <tt>execve</tt> is a good choice.



      
          <div class="CommentReplyButton">
            <form action="/Articles/883133/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883135"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 21:21 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/883135/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; But if any setuid program actually relies on argv[0] being the name of the program, that's a severe bug (symlinks, TOCTOU, etc., never mind the fact that the caller can always specify any string they want.)</font>

<p>How? All examples I have ever saw are using <code>argv[0]</code> only to multiplex binaries. They don't ever look on the actual binary which is specified in <code>argv[0]</code>, rather, they are only interested in `basename`. Symlinks, TOCTOU and even the fact that caller can specify anything there are irrelevant: for them it's just an argument of the command line which happen to include name of the program.</p>

<p>And empty arguments have tendency to make programs wonky.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/883135/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883142"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 22:12 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883142/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; And empty arguments have tendency to make programs wonky.</font><br>
<p>
setuid programs already need to defend against argv[0] == &quot;&quot; (or any other actual string, for that matter) because they must not trust the caller. POSIX explicitly specifies that the caller can set argv[0] to whatever it wants, and passing an invalid or incorrect argv[0] has been well understood for a long time as A Thing That Can Be Done (even though it&#x27;s probably a bad idea in most cases). OTOH, the &quot;there is no argv[0]&quot; case is much less obvious and (I think) is not supported at all on some platforms, so it should not be too surprising that at least one setuid program failed to check for it.<br>
<p>
So, from a security perspective, changing &quot;the string doesn&#x27;t exist&quot; to &quot;the string is empty&quot; is the most straightforward way to close the security hole, since the callee is very likely already checking for an empty string (to the extent that it cares about argv[0] at all).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883142/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883146"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2022 22:41 UTC (Fri)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/883146/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Replacing argv[0] via an exec call was a common trick back in the days of students sharing some Vax machine and wanting to hide the fact that they were playing games from &quot;ps&quot;.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883146/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor884310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 10, 2022 4:45 UTC (Thu)
                               by <b>rlhamil</b> (guest, #6472)
                              [<a href="/Articles/884310/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And arguments against altering argv in the kernel don&#x27;t make sense, since that already happens for interpreter execs, right?<br>
<p>
That&#x27;s a much more complex transformation than inserting argv[0]=&quot;&quot; if argv is NULL or argv[0] is NULL.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor883227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2022 21:48 UTC (Sun)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/883227/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think changing argc from 0 to 1 and adding an empty string will probably trip up legitimate programs. If argc is 0, then they may handle that by not checking argv and all is well. If argc is one, then they may expect a valid entry in argv[0]. It&#x27;s still not great to require a valid name in argv[0], but regardless of what vulnerabilities may exist already I can see this causing more breakage to programs that attempt to handle argc==0 correctly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883371"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2022 1:37 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883371/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As I explained in another comment, the caller can set argv[0] to any string it wishes, and a setuid program must not trust the caller (because the caller is unprivileged). So all setuid programs *must* behave correctly for invalid or &quot;wrong&quot; argv[0]. If they don&#x27;t, then that&#x27;s a separate vulnerability which must be fixed regardless of what the kernel does in the argc == 0 case. By coalescing the two cases into one case, you halve the number of potential vulnerabilities that application writers need to worry about.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883371/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor883838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 4, 2022 16:48 UTC (Fri)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/883838/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;The first argument to execve() is the pathname being executed; that could be placed as argv[0].</font><br>
<p>
Not when using execveat(fd, &quot;&quot;, ..., AT_EMPTY_PATH)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883839"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 4, 2022 17:04 UTC (Fri)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/883839/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
d_path() can name any file.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883839/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 5, 2022 1:14 UTC (Sat)
                               by <b>mchapman</b> (subscriber, #66589)
                              [<a href="/Articles/883872/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What is the process name -- as returned by prctl(PR_GET_NAME) -- when you do that? It seems like whatever it chooses would be an appropriate thing to default argv[0] to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor883153"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 0:06 UTC (Sat)
                               by <b>ariadne</b> (subscriber, #138312)
                              [<a href="/Articles/883153/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the argv construction case, I suggested {bprm-&gt;filename, NULL} which is even better than that.  But the conversation shifted back to &quot;lets just see if we can reject this entirely,&quot; so let&#x27;s see how that plays out first.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883153/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883183"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2022 16:45 UTC (Sat)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/883183/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Handling this in the kernel is likely too rigid.<br>
What not a special ldsuid.so loader for SUID program that would sanitize everything before the real program start ?<br>
This way security-conscious distro could ship a ldsuid.so program that implement the security they want.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883183/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883238"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 2:41 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/883238/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The envp array begins immediately after the NULL value that terminates argv.</font><br>
<p>
First, a brief reminder that some standard requires argv[argc] to be NULL would be IMHO very useful. It&#x27;s not obvious that it does because why would you need a clumsy NULL terminator when you already have a proper argc?<br>
<p>
For a while I wondered &quot;Did he mean the \0 byte terminating argv[argc - 1] instead?&quot;. The pointer arithmetic and discussion that follows clarifies but it comes after. Also, pointer arithmetic with a mix of pointers and arrays degrading to pointers is... not fun :-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883238/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 8:53 UTC (Mon)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/883242/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><em>First, a brief reminder that some standard requires argv[argc] to be NULL would be IMHO very useful.</em></blockquote>
<p>
FWIW, my venerable copy of ANSI/ISO 9899-1990 says, in section 5.1.2.2.1:
</p>
<blockquote>
<tt>argv[argc]</tt> shall be a null pointer.
</blockquote>
<p>
Perhaps this was changed in the meantime but I would be surprised.
</p>
<blockquote><em>
It's not obvious that it does because why would you need a clumsy NULL terminator when you already have a proper argc?
</em></blockquote>
<p>
Presumably so you can say <tt>char **p; for (p = argv;  *p; p++) {…}</tt>. One might argue that this is superfluous and that people ought to be doing something like <tt>int i; for (i = 0; i &lt; argc; i++) {…}</tt> instead, but chances are that in the run-up to ANSI/ISO 9899-1990 there were C implementations that did guarantee <tt>argv[argc] == 0</tt> already, and the former idiom was sufficiently widespread that it was easier to mandate this for everyone than to outlaw (or leave vague) something that worked fine for a large enough number of people.
</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/883242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 9:55 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883248/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would bet that there was somebody who insisted that one or the other of those loops was 2% faster on architecture X (for some value of X), and therefore demanded that it be allowed.<br>
<p>
I would tend to assume that the int loop is marginally easier to branch-predict? But I&#x27;m somewhat skeptical that that was relevant on the hardware of the time...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883252"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 11:19 UTC (Mon)
                               by <b>mfuzzey</b> (subscriber, #57966)
                              [<a href="/Articles/883252/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Especially as the time spent processing the argument list is likely to be negligable compared with the time doing the exec() and all the subsequent setup of the new process (loading shared libraries etc). The strace output for hello world is quite &quot;frightening&quot;...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883252/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor883258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 13:14 UTC (Mon)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/883258/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <p>One might also argue that <tt>argc</tt> is superfluous, and iterating over <tt>argv</tt> by incrementing a pointer variable, stopping when the terminating NULL is reached, would be the idiomatic C thing to do. After all, this would be analogous to how C's null-terminated strings are handled. </p>







      
          <div class="CommentReplyButton">
            <form action="/Articles/883258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883355"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 19:10 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/883355/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One might also argue that argc is superfluous, ...</font><br>
<p>
Yes and that would be very ironic in an article about a pkexec security issue caused by not using argc as termination and fixed by looking at it :-)<br>
<p>
Anyway comparing termination in C versus all other programming languages was not my point. Using _both_ argc and NULL at the same time is idiomatic in exactly zero programming language, so that&#x27;s confusing. So I&#x27;m merely suggesting adding one short sentence about that.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883355/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 19:42 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/883356/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; caused by not using argc as termination</font><br>
<p>
One could equally well cast this issue as &quot;caused by not checking the first element of the array for the NULL terminator&quot;. It&#x27;s exactly the same error as if you received a NUL-terminated string and started iterating over it from the second element, assuming the string to be non-empty.<br>
<p>
I&#x27;m in the Pascal-style string/list camp myself—lengths should be explicit—but using argc instead of checking for NULL is neither necessary nor sufficient to avoid this problem. (To illustrate the latter, consider the case of a program making the same non-empty argv assumption and using a loop of the form &quot;int i = 1; do { ... } while (i++ &lt; argc)&quot; to shave off a &quot;redundant&quot; bounds check.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883357"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 19:57 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/883357/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One could equally well cast this issue as &quot;caused by not checking the first element of the array for the NULL terminator&quot;. It&#x27;s exactly the same error as if you received a NUL-terminated string and started iterating over it from the second element, assuming the string to be non-empty.</font><br>
<p>
It&#x27;s &quot;exactly the same&quot; only if your termination looks like &quot;i != argc&quot; but no one ever does that. Everyone does &quot;i &lt; argc&quot; or something like it. I mean no one writes:<br>
<p>
   for (int i; i++; i!=argc)<br>
<p>
<font class="QuotedText">&gt; but using argc instead of checking for NULL is neither necessary nor sufficient to avoid this problem. </font><br>
<p>
I haven&#x27;t looked at the actual code but if pkexec&#x27;s loop had used an argc-based termination then the loop would have not run at all.<br>
<p>
<font class="QuotedText">&gt; int i = 1; do { ... } while (i++ &lt; argc)&quot; to shave off a &quot;redundant&quot; bounds check.)</font><br>
<p>
That&#x27;s bending over backwards to avoid a simpler for loop. I&#x27;m sure you can find some real world and valid cases for this but most of the time people just write a simpler for loop.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883357/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883363"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 31, 2022 22:19 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/883363/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; for (int i; i++; i!=argc)</font><br>
<p>
Of course I meant no one writes this:<br>
<p>
  for (int i=start; i!=argc; i++)<br>
<p>
Sorry for the noise.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883363/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883373"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2022 1:58 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/883373/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It&#x27;s &quot;exactly the same&quot; only if your termination looks like &quot;i != argc&quot; but no one ever does that. Everyone does &quot;i &lt; argc&quot; or something like it. I mean no one writes:</font><br>
<font class="QuotedText">&gt;</font><br>
<font class="QuotedText">&gt; for (int i; i++; i!=argc)</font><br>
<p>
Maybe not in C, but C++ tacitly encourages this sort of nonsense because iterators are not, strictly speaking, required to be ordered (for example, a linked-list iterator may only be comparable for equality, because there is no O(1) way of ordering two iterators). So if you&#x27;re taking C++ code and porting it to straight C, the most straightforward translation of a foreach loop is to use an inequality comparison instead of a less-than comparison, and it&#x27;s possible that some programmers who started out as C++ programmers and later learned C may have picked this up as an idiom.<br>
<p>
(Incidentally, these people also tend to favor the preincrement operator over the postincrement operator in contexts where there&#x27;s no semantic difference, because in C++, postincrement can be significantly costlier due to the need to make a copy.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883373/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883381"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2022 12:59 UTC (Tue)
                               by <b>madscientist</b> (subscriber, #16861)
                              [<a href="/Articles/883381/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In my experience with C++, people use &lt; most of the time when looping over integers.  You can&#x27;t perform integer looping with an iterator, unless you add your own specializations which people don&#x27;t really bother to do, so these kinds of loops are written differently than loops with STL iterators anyway.<br>
<p>
Also even in C, old-school programmers preferred pre-increment because post-increment was less efficient.  Of course it was hard to detect that inefficiency, but it was a peg to hang one&#x27;s preferential hat on and that&#x27;s all that&#x27;s needed when faced with two essentially equivalent choices.  In C++ with operator overloading it can be measurably less efficient, of course, depending on the type implementation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883381/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor884674"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Handling argc==0 in the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2022 23:46 UTC (Sun)
                               by <b>Smon</b> (guest, #104795)
                              [<a href="/Articles/884674/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There will be less breaking userspace, if two methods are combined:<br>
Only set argv[0] to &quot;&quot; if the binary is setuid (or has other privileges).<br>
<p>
I am also happy with a kernel parameter or compile flag. When all distributions are using it, it can get the kernel default behavior.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884674/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
