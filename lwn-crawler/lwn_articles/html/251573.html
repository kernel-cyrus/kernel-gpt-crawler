        <!DOCTYPE html>
        <html lang="en">
        <head><title>Reviving linux-tiny [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/251573/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/250756/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/251573/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Reviving linux-tiny</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>September 26, 2007</br>
           </div>
<p>
An <a href="http://lwn.net/Articles/250533/">announcement of the revival of
linux-tiny</a>, a set of patches aimed at reducing the footprint of the
kernel, mainly for the embedded world, has led to a number of linux-kernel
threads.  The conversations range from the proper place for linux-tiny to
reside to the removal of the enormous number of <tt>printk()</tt> strings
in the kernel.  They provide an interesting glimpse into the kernel
development process.
</p>

<p>
The linux-tiny project was <a href="http://lwn.net/Articles/62858/">started
by Matt Mackall</a> in December 2003 with the aim to "<q>collect patches that
reduce kernel disk and memory footprint as well as tools for working
on small systems.</q>"  LWN <a href="http://lwn.net/Articles/63516/">covered
the announcement</a> at the time and <a
href="http://lwn.net/Articles/191955/">tried out the patches</a> more than
a year ago.  Many of the linux-tiny features have found their way into the
mainline, but quite a few still remain outside.
</p>

<p>
The Consumer Electronics Linux Forum (CELF) is behind the effort to revive
the project, with Tim Bird, architecture group chair, announcing the plan,
including a new maintainer, Michael Opdenacker.  The first step has been
mostly completed, bringing the patches forward from the 2.6.14 kernel to
2.6.22.  A <a href="http://elinux.org/Linux_Tiny_Patch_Details">status
page</a> has been established to track the progress of updating the
patches, but it is clear that moving them into the mainline, rather than
maintaining them as patches, is a big motivation behind the revival.
</p>

<p>
Andrew Morton immediately volunteered to manage the linux-tiny patches in an <a
href="http://lwn.net/Articles/251626/">answer to the revival message</a>:
<div class="BigQuote">
Seriously, putting this stuff into some private patch collection should
be a complete last resort - you should only do this with patches which
you (and the rest of us) agree have no hope of ever getting into mainline.
</div>
<p>
Reactions were quite favorable, with the maintainer, Opdenacker <a
href="http://lwn.net/Articles/251627/">responding</a>:
<div class="BigQuote">
Andrew, you're completely right... The patches should all aim at being
included into mainline or die. 

<p>
I'm finishing a sequence of crazy weeks and I will have time to send you
patches one by one next week, starting with the easiest ones.
</div>
</p>

<p>
The full patchset will live in a separate repository as the individual
patches are being 
worked on for inclusion, but it is clear that no one wants to continuously
maintain and out-of-tree patchset for a long time.  The cost of ensuring
that the patches do not bitrot is large and their inclusion in the mainline
will get them in the hands of more developers.  
</p>

<p>
From there, more detailed discussion of how to structure the patches - and
tiny features in general - ensued.  A separate discussion also came about regarding
<tt>printk()</tt> and the large amounts of memory it consumes with all of 
its static strings.  <tt>printk()</tt> has long been seen as an area that
could be improved to reduce the memory footprint of the kernel.
</p>

<p>
All sorts of kernel messages are printed to logfiles or the console via
<tt>printk()</tt>; there are something on the order of 60,000 calls 
in 2.6.  There can be a severity level associated with a specific call, which
provides a primitive syslog-style categorization of the messages.  
Unfortunately, in the mainline, those calls are either present, with all the
associated memory for the strings, or completely absent, compiled out via a config
option.  It is rather difficult to diagnose problems without at least some
<tt>printk()</tt> information, but keeping all of the data in can increase
the size of the kernel 5-10%.
</p>

<p>
Rob Landley <a href="http://lwn.net/Articles/251655/">started things off</a>
with a way to make it possible to only compile in messages based on their
severity level.  An embedded developer could remove <tt>KERN_NOTICE</tt>,
<tt>KERN_DEBUG</tt> and similar low severity messages while keeping the
more critical messages:
<div class="BigQuote">
[...] the compiler's dead code eliminator zaps the printks you don't 
care about so they 
don't bloat the kernel image.  But this doesn't _completely_ eliminate 
printks, so you can still get the panic() calls and such.  You tweak precisely 
how much bloat you want, using the granularity information that's already 
there in the source code.
</div>
</p>

<p>
Landley's suggestion has a drawback in that it would require a flag
day for <tt>printk()</tt> or the creation of a new function that implemented
his suggestion with relevant changes trickling into the kernel over time.
In the meantime, small-system developers would still be looking for ways to get
the messages they want, while removing the others from the code.  There was 
also discussion of using separate calls for each severity level, where
<tt>pr_info()</tt>, or some similar name, would produce messages with that
level.  The preprocessor could then be used to remove those that a developer
is not interested in.
</p>

<p>
The discussion led Vegard Nossum to put together an RFC for a
<a href="http://lwn.net/Articles/251650/">new kernel-message logging API</a>.
He starts with requirements that the API be backwards-compatible with the
existing <tt>printk()</tt> usage, with the output format being extensible
at either compile or run time.  The RFC also tries to handle the case of
multiple <tt>printk()</tt> calls to emit what is essentially a single 
message, but it seems like an over-engineered solution to what should be
a fairly straightforward problem.
</p>

<p>
Another contender, one that is already part of the linux-tiny patchset, is
Tim Bird's 
<a href="http://tree.celinuxforum.org/CelfPubWiki/DoPrintk">DoPrintk</a> patch.
This allows developers to selectively choose source code files for which
<tt>printk()</tt> will be enabled, removing it from the rest of the code and
resulting kernel image.  While not allowing fine-grained selection of 
messages based on severity, it does put more control into the hands of 
developers.
</p>

<p>
It is too early to say which, if any, <tt>printk()</tt> changes are coming down
the pike.  There does seem to be a lot of interest in helping small systems
reduce their kernel footprint without sacrificing all diagnostic messages.
<tt>printk()</tt> is claimed to be one of the lowest hanging fruit for 
significant kernel size reduction, which would seem to make it a likely
candidate for change.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Embedded_systems">Embedded systems</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/251573/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor251797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 5:40 UTC (Thu)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/251797/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      Why not change all printk to a message number and parameters, and bundle all messages into the source tree only?  Waaaay back in mainframe days, you had to look up errors by number for just that reason.  I realize it wouldn't be as handy, but for the ones that only developers care about, wouldn't that be good enough?  I suppose you could have a build-time option to include the full text, but wouldn't most production system be better off with just a message ID?<br>
<p>
I don't think managing message IDs would be tricky.  They only have to be unique, not consecutive.  Never reuse old obsolete numbers.  32 bits surely ought to be enough, a considerable shrinkage.<br>
<p>
Well, it's just an idea.  Please don't flame me!<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor251819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 8:37 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/251819/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      That is horrible. You already end up often enough in Windows with messages like "Error 1026" and dunno wtf it means without doing lengthy searches on MSDN.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor251821"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 9:01 UTC (Thu)
                               by <b>filipjoelsson</b> (guest, #2622)
                              [<a href="/Articles/251821/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      So put a translator in userland!<br>
<p>
Let "make install" put a printk.map-2.6.24 in /boot for vmlinuz-2.6.24 - and syslog/dmesg could grab the relevant message and make the switch. For embedded systems you could trim the lower levels of interest, zip the file, or whatever. You should get the error code only if the relevant string isn't found - and that should happen only if you have actively chosen to trim that class of printks (or printks alltogether - but in that case, and error code would be an improvent on no-message-at-all, right?).<br>
<p>
This leaves the problem of getting the message out in case of a kernel panic - so maybe a subset of strings still need to reside in the kernel. But I don't believe all of it is needed there.<br>
<p>
I agree we don't need messages like "Error 1026" and lengthy MSDN searches to uncover that it means "Memory corruption" - but bloating the RAM with error strings isn't the only alternative.<br>
<p>
Seriously, I know putting too much stuff in userland is frowned upon - but putting error translation there looks way better than putting filesystems in userland.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251821/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor251863"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 13:34 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/251863/">Link</a>] 
      </p>
      
      </div>
      </summary>
      And when userspace is dead, or if the machine dies before the necessary daemon is running, now the poor damn users are just hit with gibberish error codes again... just when natural-language messages might help them climb out of the mire.<br>
<p>
(Also, what about the printf()-style format substitutions printk() allows? An error ID scheme provides no space for that at all. There's a reason the old catgets scheme is unused except by masochists.)<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251863/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor251823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 9:11 UTC (Thu)
                               by <b>james</b> (subscriber, #1325)
                              [<a href="/Articles/251823/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      On the other hand, truly unique error numbers (especially if they are all printed as LINUX44353, for example) are easy to Google...<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor252838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error message numbers...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2007 16:00 UTC (Wed)
                               by <b>hummassa</b> (guest, #307)
                              [<a href="/Articles/252838/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      are the salvation for anyone who has ever used Oracle. If you don't understand the short message, you just google for ORA.01234 or whatnot and voila -- tonnes of info about what, where and how the error often occurs.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/252838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor252844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error message numbers...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2007 16:07 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/252844/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Well too bad if your only machine's network card driver quit its job.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/252844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor252852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error message numbers...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2007 16:25 UTC (Wed)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/252852/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Also too bad if you can't read the comment that suggests it be a compile time option, so only those who want to save the memory need enable it.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/252852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor252919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error message numbers...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2007 19:08 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/252919/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Speaking as someone who uses Oracle every day, they're bloody awful. Oh <br>
look, I got an ORA-xxyy complaining about some column in a big query. <br>
Which column? Oh, look, even though the RDBMS knows it refuses to tell me <br>
because there's no way to fit that into its precious bloody message <br>
number.<br>
<p>
And so on.<br>
<p>
I'd say that 25% of my error-message-revealed bug-fixing time is spent <br>
figuring out just what the hell the system is actually trying to tell me, <br>
entirely because of this problem.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/252919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor255431"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[ot] sqlplus or oracle developer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2007 23:32 UTC (Mon)
                               by <b>hummassa</b> (guest, #307)
                              [<a href="/Articles/255431/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <pre class="FormattedComment">
use one of sqlplus or oracle developer to repeat your query, they usually 
mark the right spot where the error ocurred.
</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/255431/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor255479"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">[ot] sqlplus or oracle developer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2007 13:09 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/255479/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <pre class="FormattedComment">
Very amusing, well done.

(they always mark *a* spot, often an entirely different one. I don't 
castigate them for this: parser error recovery is notoriously difficult. 
But the numbered-error-messages thing just makes everything so much harder 
than it should be...)
</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/255479/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor251878"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">So change your config</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 14:32 UTC (Thu)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/251878/">Link</a>] 
      </p>
      
      </div>
      </summary>
      If it's a config item, you can choose the bulky kernel with complete messages or the slim kernel with just numbers.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251878/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor252123"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2007 22:02 UTC (Fri)
                               by <b>nlucas</b> (guest, #33793)
                              [<a href="/Articles/252123/">Link</a>] 
      </p>
      
      </div>
      </summary>
      So, because Windows do it (even if it is in no way any innovation at all), Linux can't.<br>
<p>
I'm still waiting for someone to come up with a better idea.<br>
<p>
A message in a foreign language you don't know (remember the majority of the world population doesn't speak English) doesn't seem to me the brightest idea around.<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/252123/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor251953"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 20:33 UTC (Thu)
                               by <b>moxfyre</b> (guest, #13847)
                              [<a href="/Articles/251953/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      &gt; <i>Why not change all printk to a message number and parameters, and bundle all messages into the source tree only? Waaaay back in mainframe days, you had to look up errors by number for just that reason. I realize it wouldn't be as handy, but for the ones that only developers care about, wouldn't that be good enough? I suppose you could have a build-time option to include the full text, but wouldn't most production system be better off with just a message ID?</i><p>

I think that's a pretty good idea!  For embedded systems, the console is usually a serial port connected to a desktop computer.  That computer could run a translator that would simply convert the numeric codes to strings, so the user would see the same thing.<p>

For example, the embedded system might send out a kernel message like:<p>

<pre>0xDEADBEEF,/dev/hda,123</pre></p>

... and the translator would convert that to:<p>

<pre>&lt;CRITICAL&gt;sata-driver: CRC error on /dev/hda in block 123</pre><p>

Basically, you'd be compressing the kernel by converting human-readable strings to 32-bit numbers.  The numbers wouldn't even have to be globally unique!  Just unique to that particular kernel build!  When you built a kernel for such a system, in addition to a bzImage you would get a Strings.db file.  Put the bzImage into the device firmware, and give Strings.db to your serial console translator... voila, ready to debug.  This could be a really seamless solution.
      
          <div class="CommentReplyButton">
            <form action="/Articles/251953/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor251972"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 22:25 UTC (Thu)
                               by <b>felixfix</b> (subscriber, #242)
                              [<a href="/Articles/251972/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I hadn't thought of only needing to be unique per build.  Interesting idea.  You'd lose the ability to google for a universally unique number, but maybe that doesn't matter so much.  People who want to read them on a production server or desktop with plenty of RAM would keep the messages themselves in the kernel.  It's really only the firmware and other small-footprint people who need to lose the message text.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251972/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor251983"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2007 1:09 UTC (Fri)
                               by <b>moxfyre</b> (guest, #13847)
                              [<a href="/Articles/251983/">Link</a>] 
      </p>
      
      </div>
      </summary>
      > I hadn't thought of only needing to be unique per build. Interesting idea. You'd lose the ability to google for a universally unique number, but maybe that doesn't matter so much. People who want to read them on a production server or desktop with plenty of RAM would keep the messages themselves in the kernel. It's really only the firmware and other small-footprint people who need to lose the message text.<p>

Yeah, I think it would be a very useful and not a very complex modification.  Store the table of strings on the "big" computer, and just the indices on the "small/embedded" system.<p>

As far as I can tell, it would require a kernel build option to modify printk, and then something to strip the strings out of the object files.  Here's a rough sketch of what printk() would look like in this setup:
printk() for an embedded system:<p>

<pre>
#include &lt;stdarg.h&gt;

#define unique_id(string) \
  /* some hash function of the string */

#define printk(format,...) \
  extern const char *__printk_string_ ## unique_id(format) = format; \
  printk_embedded(unique_id(format), __VA_ARGS__, NULL)

void
printk_embedded(int id, ...)
{
  va_list args;
  unsigned int arg;

  va_start (args, id)
  for (arg=id; arg != NULL; arg=va_arg(args, unsigned int))
    kprint_integer_followed_by_comma(arg)
  kprint_char('\n')
  va_end (args)
}
</pre>

This should work for all printk() argument fields except for strings (since they're not passed by value).  And then there would have to be a utility to go through the ELF image and strip out all the __printk_string_XXXXXXXX items... not too difficult I don't think.<p>

There are a few details to work out (how to make string arguments work!!) but otherwise that's about it.  Any opinions?
      
          <div class="CommentReplyButton">
            <form action="/Articles/251983/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor252029"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2007 11:54 UTC (Fri)
                               by <b>etienne_lorrain@yahoo.fr</b> (guest, #38022)
                              [<a href="/Articles/252029/">Link</a>] 
      </p>
      
      </div>
      </summary>
       If you go down that route, your "message number" could be the address (in hexadecimal) of the string and you instruct the linker/objcopy to remove the ".string" section - plus or minus some special cases.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/252029/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor251872"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reviving linux-tiny</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2007 14:17 UTC (Thu)
                               by <b>kjp</b> (guest, #39639)
                              [<a href="/Articles/251872/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I dont understand why, for the majority of printk's where the format string is a literal, the compiler couldn't do a compile time check for the &lt;Severity&gt; code and decide whether or not to generate code for it.<br>
<p>
I do similar things and it has worked for ages with gcc.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/251872/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2007, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
