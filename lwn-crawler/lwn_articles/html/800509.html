        <!DOCTYPE html>
        <html lang="en">
        <head><title>Fixing getrandom() [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/800509/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/800603/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/800509/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Fixing getrandom()</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>September 27, 2019</br>
           </div>
<p>
A <a
href="/ml/linux-kernel/20190910042107.GA1517@darwi-home-pc/">report</a> of
a boot hang in the 5.3 series has led to an enormous, somewhat contentious
thread on the linux-kernel mailing list.  The proximate cause was some changes that made the
ext4 filesystem do less I/O early in the boot phase, incidentally causing
fewer interrupts, but the 
underlying issue was <a href="/Articles/606141/">the <tt>getrandom()</tt>
system call</a>, which was blocking until the <tt>/dev/urandom</tt> pool
was initialized—as designed.  Since the system in question was not
gathering enough entropy due to the lack of unpredictable interrupt
timings, that would hang more or less forever.  That has called into
question the design and implementation of <a
href="http://man7.org/linux/man-pages/man2/getrandom.2.html"><tt>getrandom()</tt></a>. 
</p>

<p>
Ahmed S. Darwish reported the original problem and <a
href="/ml/linux-kernel/20190910173243.GA3992@darwi-home-pc/">tracked it
down</a> to the <a href="https://wiki.gnome.org/Projects/GDM">GNOME Display
Manager</a> (GDM), which handles graphical logins.  It turns out that GDM
was calling <tt>getrandom()</tt> in order to generate the "MIT magic
cookie" that is used for <a
href="https://en.wikipedia.org/wiki/X_Window_authorization">authorization
by the X Window System</a>.
As was pointed out by several in the mega-thread, using cryptographic-strength
random numbers for the cookie (or much of anything in terms of X Window
security) is well beyond the pale—a much weaker random number generator
could have been used with no loss of security.
Darwish noted that the call "only" requests a
small number of random bytes (five calls requesting 16 bytes each) but, as
Theodore Y. Ts'o <a
href="/ml/linux-kernel/20190911160729.GF2740@mit.edu/">said</a>,
that doesn't matter: by default <tt>getrandom()</tt> will not return
anything until the cryptographic random number generator (CRNG) is
initialized—which requires entropy. 
</p>

<p>
When Darwish originally bisected the
problem, he pinpointed an <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b03755ad6f33b7b8cd7312a3596a2dbf496de6e7">ext4
commit</a> that had the effect of reducing the amount of disk I/O that was
being done early in the boot process.  That performance enhancement also,
unfortunately, turned out to reduce the amount of entropy gathered on
Darwish's laptop—to the point it would not boot.  That change has been <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=72dbcf72156641fde4d8ea401e977341bfd35a05">reverted</a>
for now.
</p>

<h4><tt>getrandom()</tt></h4>

<p>
Back in 2014, <tt>getrandom()</tt> was added at least partly in response to
a complaint from the <a href="http://www.libressl.org">LibreSSL project</a>
that Linux lacked a way to get random numbers in the face of
file-descriptor exhaustion.  The "approved" mechanism was to read from
<tt>/dev/urandom</tt>, but if an attacker arranged that all of the file
descriptors were already open, that method could fail.  So
<tt>getrandom()</tt> was created to provide a way to get random numbers
without a file descriptor or, even, a visible <tt>/dev/urandom</tt>
(e.g. from a container or <tt>chroot()</tt>).  In fact,
<tt>getrandom()</tt> was intentionally designed to block until
the <tt>/dev/urandom</tt> pool is initialized; prior to
<tt>getrandom()</tt> there was no way for user 
space to be sure that enough entropy had been gathered to properly
initialize the pool.  Since the behavior of <tt>/dev/urandom</tt> is part
of the kernel ABI, it could not change; a new system call was under no such
constraints, of course.
</p>

<p>
Initializing the CRNG requires 512 bits of estimated entropy, or 4096 interrupts
using the current calculations, which Ts'o said were conservatively
chosen.  <tt>getrandom()</tt> is clearly documented to block until that
happens, but it has not stopped user space from sometimes using it
incorrectly.   Ts'o said that is going to be a problem moving forward:
<div class="BigQuote">
Ultimately, though, we need to find *some* way to fix userspace's
assumptions that they can always get high quality entropy in early
boot, or we need to get over people's distrust of Intel and RDRAND.
Otherwise, future performance improvements in any part of the system
which reduces the number of interrupts is always going to potentially
result in somebody's misconfigured system or badly written
applications to fail to boot.  :-(
</div>
</p>

<p>
Linus Torvalds <a
href="/ml/linux-kernel/CAHk-=whW_AB0pZ0u6P9uVSWpqeb5t2NCX_sMpZNGy8shPDyDNg@mail.gmail.com/">noted</a>
that the <tt>RDRAND</tt> instruction does not exist everywhere, so it is no
panacea.  He is also <a
href="/ml/linux-kernel/CAHk-=wi_yXK5KSmRhgNRSmJSD55x+2-pRdZZPOT8Fm1B8w6jUw@mail.gmail.com/">concerned</a>
that problems stemming from fewer interrupts will only get worse:
<div class="BigQuote">
The interrupt thing is only going to get worse as disks turn into
ssd's and some of them end up using polling rather than interrupts..
So we're likely to see _fewer_ interrupts in the future, not more.
</div>
</p>

<h4>Error return</h4>

<p>
Ts'o <a
href="/ml/linux-kernel/20190912082530.GA27365@mit.edu/">suggested</a>
adding a kind of "fail safe" flag that would let callers request that
<tt>getrandom()</tt> only block for, say, two minutes; after that, the best
available random numbers would be returned.  But Torvalds <a
href="/ml/linux-kernel/CAHk-=wjyH910+JRBdZf_Y9G54c1M=LBF8NKXB6vJcm9XjLnRfg@mail.gmail.com/">believes</a>
that blocking by default is simply wrong.  He said that any new flag should
request the blocking behavior explicitly so that unthinking users get what
they expect.  Or perhaps an error could be returned:
<div class="BigQuote">
An alternative might be to make getrandom() just return an error
instead of waiting. Sure, fill the buffer with "as random as we can"
stuff, but then return -EINVAL because you called us too early.
</div>
</p>

<p>
Several seemed in agreement with that approach;
Darwish <a
href="/ml/linux-kernel/20190914122500.GA1425@darwi-home-pc/">posted an RFC
patch</a> along those lines.
Alexander E. Patrakov <a
href="/ml/linux-kernel/008f17bc-102b-e762-a17c-e2766d48f515@gmail.com/">reworked
the commit message</a>, but also complained about the idea of returning an
error and forcing user space to deal with the problem ("<q>the whole result
looks like shifting the responsibility/blame without achieving anything
useful</q>").
Ts'o clearly thinks it is a bad idea,
overall, but somewhat waspishly <a
href="/ml/linux-kernel/20190915052242.GG19710@mit.edu/">further modified the
patch</a> so that the blocking behavior was configurable at build time (or
via a kernel command-line parameter).  Darwish took that <a
href="/ml/linux-kernel/20190915081747.GA1058@darwi-home-pc/">one step
further</a> and increased the length of commit message again, adding even
more background and details.  In addition, at Torvalds's request, the
<tt>-EINVAL</tt> return was removed, so that <tt>getrandom()</tt>
effectively reverted to the same behavior as reading from
<tt>/dev/urandom</tt>: callers get the "best" randomness available at the
time of the call.
</p>

<p>
Lennart Poettering <a
href="/ml/linux-kernel/20190915085907.GC29771@gardel-login/">disagreed</a>
with that approach, calling it "<q>sticking your head in the
sand</q>" by providing bad random numbers to potentially sensitive
key-generation operations early in the boot process.  He suggested that the
problem is not in the kernel at all and that it should be solved in user space:
<div class="BigQuote">
Let the people putting together systems deal with this. Let
them provide a creditable hw rng, and let them pay the price if they
don't.
</div>

<p>
Part of the problem may be that once the GNU C Library (glibc) got around
to <a href="/Articles/711013/">adding a wrapper for
<tt>getrandom()</tt></a>, an OpenBSD-like <a
href="http://man7.org/linux/man-pages/man3/getentropy.3.html"><tt>getentropy()</tt></a>
call was also added.  However the OpenBSD version does not block, while the
glibc version is implemented using <tt>getrandom()</tt> and, thus, can
block indefinitely in the early boot process.  Developers calling
<tt>getentropy()</tt> might well be unaware of this little "gotcha"—though
it is documented in the man page. 
As Torvalds and others
mentioned in the thread, another problem is that once the system has
blocked waiting for entropy, said entropy is likely to never arrive.  User
space needs to cause things to happen (e.g. keys pressed, disks accessed)
to produce the interrupts necessary to get the CRNG initialized.
</p>

<p>
Yet another part of the problem that Torvalds sees is that there are (at least) two
different kinds of users of <tt>getrandom()</tt> who are passing 0 for the
flags value (which he 
calls "<tt>getrandom(0)</tt>"): those that actually want/need to block in
order to get random numbers only after the CRNG has been initialized and
those who are just after "good" random numbers and didn't think too hard
about it.  Callers of glibc's <tt>getentropy()</tt> could also fall into that
latter category.
</p>

<h4>Limiting delays</h4>

<p>
Unsurprisingly, Torvalds was <a href="/ml/linux-kernel/CAHk-=wgg2T=3KxrO-BY3nHJgMEyApjnO3cwbQb_0vxsn9qKN8Q@mail.gmail.com/">not in
favor of a configuration option</a>; his first solution was to limit the wait time
of <tt>getrandom()</tt> to 15 seconds on the first call when the CRNG is
not initialized, reducing the delay on each subsequent call so that the
maximum possible delay is 30 seconds.  The code returns <tt>-EAGAIN</tt> in
that case so
that user space can detect it.  In a comment in the code (repeated in the
email message), he said: "<q>Just asking for blocking random numbers is
completely and fundamentally wrong, and the kernel will not play that game.</q>"
</p>

<p>
That set off another huge sub-thread.  Poettering once again <a
href="/ml/linux-kernel/20190916180801.GB30990@gardel-login/">said</a> that
the problem should not be solved by the kernel in a "<q>never trust
userspace</q>" fashion.  Darwish <a
href="/ml/linux-kernel/20190918211503.GA1808@darwi-home-pc/">posted</a>
another version of his patch set that proposed a <tt>getrandom2()</tt>
system call, which used new flag names to be ever more explicit about the
intentions of the caller.  But there are still plenty of flag bits
available for <tt>getrandom()</tt>, Torvalds <a
href="/ml/linux-kernel/CAHk-=wiCqDiU7SE3FLn2W26MS_voUAuqj5XFa1V_tiGTrrW-zQ@mail.gmail.com/">said</a>,
so introducing a new system call seems unnecessary.
</p>

<p>
Instead, he suggested
reworking the flag values to better represent what was being asked
for.  The <tt>GRND_EXPLICIT</tt> flag would be used to indicate that user
space "knows what it is doing", so if it explicitly asks to block forever, that will
be honored.  The <tt>GRND_SECURE</tt> and <tt>GRND_INSECURE</tt> values would ask
for blocking and non-blocking behavior respectively, but both would also
set the <tt>GRND_EXPLICIT</tt> bit.
The patch left the <tt>getrandom(0)</tt> case alone, but
Torvalds has plans for that as well:
<div class="BigQuote">
In particular, this still leaves the semantics of that nasty
"getrandom(0)" as the same "blocking urandom" that it currently is.
But now it's a separate case, and we can make that perhaps do the
timeout, or at least the warning.
<p>
And the new cases are defined to *not* warn. In particular,
GRND_INSECURE very much does *not* warn about early urandom access
when crng isn't ready. Because the whole point of that new mode is
that the user knows it isn't secure.
</div>
</p>

<p>
Ts'o <a href="/ml/linux-kernel/20190919143427.GQ6762@mit.edu/">wondered</a>
why the <tt>getrandom(0)</tt> case was not simply mapped to the same
behavior as <tt>GRND_SECURE</tt>, which would effectively be the same as it
is today, but Torvalds <a
href="/ml/linux-kernel/CAHk-=wgqbBy84ovtr8wPFqRo6U8jvp59rvQ8a6TvXuoyb-4L-Q@mail.gmail.com/">was
adamant</a> that was the wrong approach; he is concerned that Ts'o is
getting overly caught up in what Torvalds sees as theoretical attacks and
is missing the real <tt>getrandom(0)</tt> problem.  Torvalds intends the
patch to be backported to the stable kernels, so any change to
<tt>getrandom(0)</tt> will be in separate, mainline-only patch.
</p>

<h4>Jitter entropy</h4>

<p>
Patrakov <a
href="/ml/linux-kernel/6adb02d4-c486-a945-7f51-d007d6de45b2@gmail.com/">asked</a>
about <a href="/Articles/642166/">using "jitter entropy"</a> as is done by
the <a href="http://www.issihosts.com/haveged/">haveged</a> entropy
daemon.  Using haveged is being suggested by some distributions as a way to
ensure that there is enough entropy early in the system boot.  He noted
that the technique is controversial as some are concerned that it is not
truly random data.  Torvalds <a
href="/ml/linux-kernel/CAHk-=wjGAaPAGnfok6fuZK1PYMkZ9bNOGkWXLYtS7+6bAWnAGQ@mail.gmail.com/">said</a>
that he is one of the skeptics, but thought it might provide a solution to
the current mess:
<div class="BigQuote">
I would perhaps be willing to just put my foot down, and say "ok,
we'll solve the 'getrandom(0)' issue by just saying that if that
blocks too  much, we'll do the jitter entropy thing".
<p>
Making absolutely nobody happy, but working in practice. And maybe
encouraging the people who don't like jitter entropy to use
GRND_SECURE instead.
</div>
</p>

<p>
But <tt>getrandom()</tt> has been in the kernel for five years and in glibc
for more than two years, so it is clearly part of the kernel ABI.  The
behavior that some want when they call <tt>getrandom(0)</tt> should not be
arbitrarily changed to provide "bad" random numbers in a way that breaks
user-space programs.  That was the upshot of Andy Lutomirski's <a
href="/ml/linux-kernel/CALCETrV=4TX2a4uV5t2xOFzv+zM_jnOtMLJna8Vb7uXz6S=wSw@mail.gmail.com/">argument</a>
in the thread.  He agreed that the <tt>getrandom()</tt> call was poorly
thought out before it was added, but that should not change now:
<div class="BigQuote">
There are programs that call getrandom(0) *today* that expect secure
output.  openssl does a horrible dance in which it calls getentropy()
if available and falls back to syscall(__NR_getrandom, buf, buflen, 0)
otherwise.  We can't break this use case.  Changing the semantics of
getrandom(0) out from under them seems like the worst kind of ABI
break -- existing applications will *appear* to continue working but
will, in fact, become insecure.
</div>
</p>

<p>
Lutomirski also believes it is a "<q>straight up kernel bug</q>" that
blocking in <tt>getrandom(0)</tt> early in the boot deadlocks the system by
waiting for entropy.  He suggested actively fixing that problem: "<q>How about we make
getrandom() (probably  
actually wait_for_random_bytes()) do something useful to try to seed
the RNG if the system is otherwise not doing IO.</q>"   Torvalds is <a href="/ml/linux-kernel/CAHk-=wjpTWgpo6d24pTv+ubfea_uEomX-sHjjOkdACfV-8Nmkg@mail.gmail.com/">in
agreement with that</a>, though he seems to be leaning toward the
jitter-entropy stopgap:
<div class="BigQuote">
And yes, we'll have to block - at least for a time - to get some
entropy. But at some point we either start making entropy up, or we
say "0 means jitter-entropy for ten seconds".
<p>
That will _work_, but it will also make the security-people nervous,
which is just one more hint that they should move to
GRND_SECURE[_BLOCKING].
</div>
</p>

<p>
The goal is to ensure that callers are really aware that they are asking to
block (and potentially deadlock) waiting for the CRNG to be properly
initialized.  In the ambiguous default case, that may well not be the case,
so Torvalds is <a
href="/ml/linux-kernel/CAHk-=whJ3kmcZp=Ws+uXnRB9KokG6nXSQCSuBnerG--jkAfP5w@mail.gmail.com/">determined
to find a way</a> to make that not block:
<div class="BigQuote">
So we absolutely _will_ come up with some way 0 ends the wait. Whether
it's _just_ a timeout, or whether it's jitter-entropy or whatever, it
will happen.
</div>
</p>

<p>
He is concerned about the amount of time it might take to gather enough
jitter entropy to initialize the CRNG, however.  He suggested that he was
willing to block as long as 15 seconds, but thought that might require some
kind of accelerated jitter-entropy technique.  Patrakov <a
href="/ml/linux-kernel/ff3504ba-c21b-6560-6b87-e8c5b964b1a4@gmail.com/">said</a>
that acceleration was not needed as the existing technique can generate plenty of
entropy in two seconds.  In addition, as had also been noted elsewhere in
the thread, Matthew Garrett <a
href="/ml/linux-kernel/20190920201747.kmzx2kjdv2hbljsy@srcf.ucam.org/">pointed
out</a>
that the <a
href="https://fuchsia.googlesource.com/fuchsia/+/master/zircon/README.md">Zircon</a>
kernel for the <a
href="https://fuchsia.googlesource.com/fuchsia/">Fuchsia</a> operating
system initializes its CRNG <a
href="https://fuchsia.dev/fuchsia-src/zircon/jitterentropy/config-basic">using
jitter entropy</a>, which may lend some credibility to the technique.
</p>

<h4>ABI</h4>

<p>
In a departure from his usual stance, Torvalds seems fairly unconcerned about changing the
kernel ABI in this case.  He <a
href="/ml/linux-kernel/CAHk-=wh2PuYtuUVt523j20cTceN+ps8UNJY=uRWQuRaDeDyLQw@mail.gmail.com/">said</a>
that any breakage from changing <tt>getrandom(0)</tt> to time out was
theoretical, but that the boot deadlock problem was real.  In
order for the generation of keys to fail under that scheme, he said, they would have
to be generated at boot on idle machines that are not doing anything that
would allow 
entropy to be collected.  As Garrett <a
href="/ml/linux-kernel/BEF07E89-E36D-480F-AB1E-25C80C9DABE7@srcf.ucam.org/">noted</a>,
though, that is the exact scenario for which the <tt>getrandom(0)</tt> behavior
was designed.   Torvalds <a
href="/ml/linux-kernel/CAHk-=whfPwei+yf9vBgfSuG5HDtiYmt3nOu9Js+vkTYSrMf2ow@mail.gmail.com/">does
not see</a> that kind of key generation as anything other than a
hypothetical, it seems.
</p>

<p>
The main difference between the proposals from Torvalds and Lutomirski is
whether or not to actually provide some way for <tt>getrandom()</tt>
callers to block, possibly forever, or not.  Torvalds is willing to have
that as a non-default option to <tt>getrandom()</tt>, while Lutomirski
would prefer to <a
href="/ml/linux-kernel/cover.1568990048.git.luto@kernel.org/">simplify
<tt>getrandom()</tt></a> (though the patch text calls it
"<tt>getentropy()</tt>"), while also removing all of 
the machinery behind the <tt>/dev/random</tt> blocking pool.
The net
effect would be that users who truly need today's <tt>getrandom(0)</tt>
behavior could still get it by reading <tt>/dev/random</tt>. 
</p>

<p>
The thread is long and twisty; Torvalds's final decision is not yet clear.
It does seem that something will be done to <tt>getrandom(0)</tt>, but
whether it times out or switches to jitter entropy in the problematic case
is unclear.  It does also seem that the blocking random number pool's days
are numbered, as well, based on Torvalds's statements in the thread.  But
the final shape of those changes is not yet apparent.
</p>

<p>
It would seem that, once again, the kernel development community has failed
in the design of an API/ABI.  According to Torvalds and others, the default
for <tt>getrandom()</tt>
should never have been "block forever", but that information comes five years too
late.  API/ABI review is an area that the kernel has struggled with over the years;
hopefully situations like this will provide enough incentive to take some extra
time (and do some testing, though that probably would not have mattered
here) before committing to an ABI that has to be supported, for the most
part, anyway, forever.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Random_numbers">Random numbers</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/800509/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor800706"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 16:25 UTC (Fri)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/800706/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There’s a UEFI random number protocol that ought to seed the kernel PRNG on boot - was the system using UEFI, and had it subsequently run out of entropy?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800706/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800712"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 17:53 UTC (Fri)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/800712/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is only used if the system is booted via the EFI boot stub - grub still defaults to jumping directly into the main kernel entry point, so on a lot of distributions this is skipped.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800712/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 17:55 UTC (Fri)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/800713/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is what I would call "shifting the responsibility" and reject on this basis. Exactly the same logic as described in the article for getrandom() also applies to the UEFI random number protocol: where does it get the seed? If it is fake, then it is a very roundabout way to return fake entropy. If it consults some hardware, then the kernel can do the same.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 18:37 UTC (Fri)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/800716/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A new seed is written before the computer is rebooted. This way the accumulated entropy is not flushed at restart.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 19:05 UTC (Fri)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/800724/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah though, actually *crediting* it is a different step: <a href="https://github.com/systemd/systemd/issues/4271">https://github.com/systemd/systemd/issues/4271</a> (and crediting is highly relevant to this discussion)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 20:05 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/800837/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I recommend clicking through to that bug report. This is more complicated than I had imagined, because in cases where people take images of live systems, you really shouldn't credit any "stored" entropy at all (because it's been duplicated umpteen times into other instances of the same image, so it's no longer unpredictable). But you can't know that someone imaged the system, so how do you square that circle?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 20:27 UTC (Sun)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/800838/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is exactly why I say "don't". Too many bugs stem from our desire do achieve the impossible instead of giving up immediately.<br>
<p>
OTOH, jitter entropy will definitely help here, up to the point of making it completely unneeded to save entropy between reboots.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor801049"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 20:54 UTC (Tue)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/801049/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Trusting the BIOS to provide good entropy seems like more of a mistake than jitter-entropy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801049/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor800714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 18:03 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/800714/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; “Let the people putting together systems deal with this. Let them provide a creditable hw rng, and let them pay the price if they don't.”</font><br>
<p>
I can see the hysterical tech tabloid headlines already: “systemd announces business plan to brick all old systems unless you purchase an expensive security dongle”.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 18:09 UTC (Fri)
                               by <b>jccleaver</b> (subscriber, #127418)
                              [<a href="/Articles/800715/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I can see the hysterical tech tabloid headlines already: “systemd announces business plan to brick all old systems unless you purchase an expensive security dongle”.</font><br>
<p>
It's worth pointing out that half this problem is actually *caused* by having moved everything into systemd. If you needed entropy in early but post-initramfs boot and needed to be sure it was there, it was trivial enough to put some sort of arbitrary shell action way up in the script to do it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 16:36 UTC (Sat)
                               by <b>mads</b> (subscriber, #55377)
                              [<a href="/Articles/800797/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But it would be trivial to add that to systemd too, and why does it have to be a shell script? (not that systemd can't use bash, but why should it)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 9:26 UTC (Sun)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/800817/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
systemd reads a random seed off disk just fine for you, no need to write any script for that. Problem with the approach is that it's waaaay too late: we can only credit a random seed read from disk when we can also update it on disk, so that it is never reused. This means /var needs to be writable, which is really later during boot, long after we already needed entropy, and long after the initrd.<br>
<p>
Hence, no, systemd is not causing this, systemd does what it can, but it can't magically create entropy where there is none.<br>
<p>
Or to say this differently: that "arbitrary shell script" you are envisioning, what is it supposed to do? Where would it derive entropy from where neither the kernel nor systemd do or could do it at least as good?<br>
<p>
if you care, have a look here, about the approach systemd takes to help you with the general problem: <a href="https://systemd.io/RANDOM_SEEDS.html">https://systemd.io/RANDOM_SEEDS.html</a><br>
<p>
Lennart<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800835"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 19:37 UTC (Sun)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/800835/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So, I had a lingering question that the last paragraph of that page answers sufficiently.<br>
<p>
I've got a system where the NVRAM is probably fine, but it has a broken EFI implementation (AMI), where nobody bothered to implement deallocating deleted vars, so eventually it'd start returning -ENOSPC for every write operation. Me naively leaving pstore panic logging enabled soon flushed that out (followed by real panic at efibootmgr failing, and a day of downtime trying to figure out what went wrong and tearing the room up to get at a CMOS jumper).<br>
<p>
The kernel help text for EFI features could use a gentle reminder that yes, EFI firmware *is* written by the same nincompoops as the bad old BIOSes of the 90s, and should be equally mistrusted.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800835/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 19:30 UTC (Mon)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/800935/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Who cares if it's reused? The same 32-byte random seed cryptographically mixed with a non-repeating nonce, like the system clock, would have the same strength as a new 32-byte random seed, presuming the seed remains confidential. Long-term it's better to change the seed in case confidentiality was unknowingly violated or the nonce repeats (clock reset), but as a practical matter those aren't prerequisites to having a reasonably sane and secure system, especially considering the alternative--a multiplicity of userland CSPRNGs all scavenging for entropy independently.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801023"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 17:28 UTC (Tue)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/801023/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      You're assuming that there is a reasonably-initialized system clock at the point where entropy is required&nbsp;&ndash; this is just as wrong as any of the other assumptions regarding entropy.
      
          <div class="CommentReplyButton">
            <form action="/Articles/801023/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801030"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 19:07 UTC (Tue)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/801030/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am assuming it, but I think it's a reasonable assumption--that there are adequate sources available to minimize the chance of a repeating nonce. The system clock was just an example. And of course there are systems where the assumption can't hold at all. So what? How many systems do there need to be to hold back everybody else? 1%? 0.1?%? 0.01%? 0%?<br>
<p>
Some systems are just hopelessly broken when it comes to entropy. And that can't be fixed. But those systems are increasingly (and at this point likely *entirely*), small, embedded systems. It was always the responsibility of the designers of those systems to either make sure there's an entropy source available or design their firmware so that it wasn't necessary (i.e. no sshd generating a new private key on first boot). Are we going to let them hold back the inevitable *forever*? At some point we have to hold the stragglers' feet to the fire and cut our losses on the installed base--most of which would never upgrade, anyhow, and are unlikely to even be using getrandom(2) in the first place.<br>
<p>
With the prevalence of not only RDRAND and similar on-chip sources, but also many other sources (e.g. Intel QuickAssist provided a hardware generator on the NIC controller since *before* it was even branded QuickAssist, EFI provides randomness, which in some cases comes from a hardware source--but that's a QoI issue), it's time to make the switch over to assuming (*loudly* assuming) that strong entropy is available at boot or will be available very shortly after boot (see CPU jitter hack as a last-ditch effort). Almost all of userland already makes this assumption, and has for quite some time, rightly or wrongly; now the ball is in the kernel's court to make good on that assumption to the best of its ability.<br>
<p>
This *will* happen eventually, the only question is how long we'll wring our hands over misplaced concern for embedded platforms that are and were fundamentally broken. It's been almost 15 years since the VIA C3 included an on-chip RNG. Embedded designers have had ample warning about the necessity of providing strong entropy for a long time.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801030/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801046"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 20:23 UTC (Tue)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/801046/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, just to be clear, the context for the boot seed was systemd.  The overlap of embedded systems lacking both hardware entropy such as RDRAND and a reliable system clock but still running systemd is likely not very large. But then you also need to discount that by the odds of consecutive boots where systemd couldn't re-save a seed. *And* you need to discount it further by the odds the system was doing anything security critical. *And* you need to discount this by the odds that such a scenario would be distinguishable and exploitable.<br>
<p>
Can this scenario exist? Sure. Does it exist? We should assume so. The only question is what's the risk, and does that risk outweigh the risk of not improving other aspects of the system's randomness semantics with the consequence that software will attempt to compensate *poorly*. And, again, what's that relative risk within the context of embedded system + systemd - RNG - clock?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801046/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor800719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 18:37 UTC (Fri)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/800719/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In order for the generation of keys to fail under that scheme, he said, they would have to be generated at boot on idle machines that are not doing anything that would allow entropy to be collected.</font><br>
<p>
Isn't "idle machines that are not doing anything else" exactly the situation in the first boot of a newly-installed distribution, which is when the long-term ssh host keys (which do need strong random numbers) are usually generated?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801271"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2019 7:14 UTC (Fri)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/801271/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
1. The installation process generates a lot of IO, sufficient to seed the CSPRNG.  It should emit a seed that can be used by the next boot (much like any other reboot entropy save).<br>
2. Optionally, the installer can also generate and write out sshd host keys.  There's not a lot of reason to wait until first boot for that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801271/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801282"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2019 11:36 UTC (Fri)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/801282/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The devices in question aren't installed individually. One image of a single install is put on thousands or millions of them, so generating host keys at installation time is the worst thing to do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801282/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor800722"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 18:44 UTC (Fri)
                               by <b>mgedmin</b> (subscriber, #34497)
                              [<a href="/Articles/800722/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Anyone remember <a href="https://factorable.net/?">https://factorable.net/?</a>  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800722/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800782"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 12:07 UTC (Sat)
                               by <b>corsac</b> (subscriber, #49696)
                              [<a href="/Articles/800782/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agreed. I didn't read the whole thread, but I'm surprised not to see any reference to “Mining your Ps and Qs” from Usenix Security 2012 (<a href="https://www.usenix.org/conference/usenixsecurity12/technical-sessions/presentation/heninger">https://www.usenix.org/conference/usenixsecurity12/techni...</a> and <a href="https://factorable.net/weakkeys12.extended.pdf">https://factorable.net/weakkeys12.extended.pdf</a>)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800782/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 19:44 UTC (Sat)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/800803/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This site was indeed mentioned in the discussion. However, a return of the factorable.net issue for systems that do not properly restore the random seed is preferable, in my viewpoint, to breaking almost all systems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800816"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 9:01 UTC (Sun)
                               by <b>corsac</b> (subscriber, #49696)
                              [<a href="/Articles/800816/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Factorable.net problem is not only for systems not restoring random seed. Most of them are devices booting for the first time and generating long term keys (ssh etc.) with a really similar entropy state (because of unseeded RNG). It's likely there are a *lot* of devices like these beeing shipped every day, even more so with cloud VMs, so breaking those is a really bad idea I think.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800816/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor800733"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Inject entropy from the disk using the bootloader and similar problem fixed in Python</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2019 21:07 UTC (Fri)
                               by <b>vstinner</b> (subscriber, #42675)
                              [<a href="/Articles/800733/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Since the system in question was not gathering enough entropy due to the lack of unpredictable interrupt timings, (...)"<br>
<p>
OpenBSD fixed this boot issue: their bootloader loads entropy from disk, and the installer collects enough entropy. It doesn't cover all cases (read-only livecd, systems with no entropy source to feed new entropy, etc.), but it fix the "lack of entropy at boot" issue for the common case.<br>
<p>
--<br>
<p>
In 2015, a systemd script used Python to compute a hash. Python blocked on getrandom() at boot.<br>
<p>
When the bug has been reported, a very long discussion started on the bug tracker, continued on the python-dev mailing list. A new mailing list has been created just to discuss this bug :-)<br>
<p>
At the end, we decided to fallback on /dev/urandom if getrandom() blocks, to initialize the "secret hash seed". This secret is used to randomize the dictionary hash function, to reduce the disk of a denial of attack on dictionaries.<br>
<p>
Moreover, the os.urandom() function has been modified on Linux (and Solaris: systems providing getrandom() syscall/function) to block (on purpose) until the system collected enough entropy.<br>
<p>
Calling os.getrandom(1, os.GRND_NONBLOCK) can be used to check if getrandom() is going to block or not. Some people asked for this feature, but I'm not sure that it's really used in practice.<br>
<p>
The <a href="https://www.python.org/dev/peps/pep-0524/">https://www.python.org/dev/peps/pep-0524/</a> describes the issue and fix.<br>
<p>
--<br>
<p>
Python was an early adopter of getrandom() syscall, before it was exposed as a function in the glibc ;-)<br>
<p>
Python keeps a file descriptor open on /dev/urandom for best performance. Some badly written applications close the file descriptor by mistake, so Python detects if the file descriptor changed (compare st_dev and st_ino) to workaround application bugs. Moreover, there is no lock on the file descriptor for best performance, which requires to detect when two threads open the file "at the same time".<br>
<p>
So well, getrandom() avoids all these issues.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800733/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800752"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 5:08 UTC (Sat)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/800752/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am always amazed when people insist that truly random data is a scarce resource. Most machines nowadays have at least one of a CCD camera, microphone, or radio reciever. All are excellent sources of enough truly random noise (along with possibly deterministic bits, which are harmless) for almost any purpose.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800752/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800754"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 6:00 UTC (Sat)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/800754/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The actual scarce resource (in my opinion &#128527;) is random data <em>that can be trusted by a truly-paranoid person</em>. (Whether the paranoia is justified or not is a different question; I would expect the <em>smart</em> paranoid to use a hardware RNG, not trust the off-the-shelf randomness from a general-purpose computer + OS).
<p>For most uses, a simple <em>userspace</em> solution that runs very early in the boot sequence and credits some environment noise as entropy should be sufficient. This would solve even the &ldquo;initial SSHD seed&rdquo; concerns&nbsp;&mdash; however it is easily broken by distributors / packagers who might remove it in the name of &ldquo;faster boot&rdquo;.
      
          <div class="CommentReplyButton">
            <form action="/Articles/800754/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800813"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 6:04 UTC (Sun)
                               by <b>edeloget</b> (subscriber, #88392)
                              [<a href="/Articles/800813/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, for the past ten years I have been developing specialized distributions for network devices, and they tend to not have any of the above. And yes, SSH keys generated on the first boot are really a pain (actually less of a pain these days because newer CPUs tend to propose a hwrng but hey, this is an industry where you are routinely dealing with severly out-of-date CPUs...). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800813/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 8:26 UTC (Mon)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/800852/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      I do not know if a microphone or radio are good random sources, but a camera is.  The resolution of camera sensors is high enough that the randomness of the photons coming in is reflected in the raw sensor output (and it is a lot for a (not too) bright picture).  However, that means that the sensor must be on and receive significant light on booting, and you need a way to get the raw data (transformation into JPEG usually tries to get rid of the noise that we want for the RNG).

      
          <div class="CommentReplyButton">
            <form action="/Articles/800852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800857"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 11:59 UTC (Mon)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/800857/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you can get a decent amount of entropy even if there is no light on the camera, because of thermal noise in the sensor. That's probably safer than receiving significant light, because if the sensor gets saturated then you'll get a pure white image with no entropy. Phone cameras don't have physical shutters but the sensors often have some non-exposed pixels around the edge (for black level calibration etc) and you could probably use those.<br>
<p>
<font class="QuotedText">&gt; you need a way to get the raw data (transformation into JPEG usually tries to get rid of the noise that we want for the RNG)</font><br>
<p>
It's not just the JPEG compression - the Android camera API is happy to give you uncompressed YUV but that still wouldn't be raw enough. You'd want the (typically) 10-bit Bayer data directly from the sensor, before the ISP has tried to make it look pretty (doing noise reduction, adjusting levels in a way that might saturate the noise out of existence, smoothing the image, etc). And you probably want to manually configure the sensor to maximise noise (long exposure, high gain, disable binning, etc). Android provides enough control to let applications request that, but I don't know how many of the camera drivers implement it fully, so it's probably not a very portable approach.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800857/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800864"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 12:49 UTC (Mon)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/800864/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Thermal noise is relatively small compared to photon noise if the sensor receives significant photons, but may be enough for initializing the RNG.  And of course you don't want to be have so much brightness and so much exposure that the sensor saturates, but you can recognize anything approaching saturation, and then use shorter exposure time, if too many pixels are saturated.  Combining high gain with long exposure will give more thermal noise in darkness, but produce saturation if there is light.
      
          <div class="CommentReplyButton">
            <form action="/Articles/800864/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor801197"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2019 10:40 UTC (Thu)
                               by <b>NRArnot</b> (subscriber, #3033)
                              [<a href="/Articles/801197/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As long as you can crank up the gain high enough to input "hiss" or "static" (electronic shot noise or  cosmic background radiation) then even a microphone jack with no microphone plugged in, or a radio with no aerial, is a source of physical randomness. I don't know if the common on-board microphone sockets in the PC world can be used this way. I guess the problem for the truly paranoid, is how to tell whether what is coming in has been deviously compromised so as to only look random. <br>
<p>
Personally I'd go with a boot parameter "paranoia = n" (maybe the current and maximum  value is 11, with a nod to Spinal Tap). 10 would allow use of the random number generator on the CPU chip if there is one, and thereby solve all the problems other than the possibility that (insert conspiracy theory here). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801197/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 19, 2021 16:51 UTC (Fri)
                               by <b>Lawless-M</b> (guest, #155377)
                              [<a href="/Articles/876532/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My VMs do not have cameras, radios or microphones<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor800755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 5:52 UTC (Sat)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/800755/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; As Garrett noted, though, that is the exact scenario for which the getrandom(0) behavior was designed. Torvalds does not see that kind of key generation as anything other than a hypothetical, it seems.</font><br>
<p>
Many distributions (both live and initial-boot) generate SSH keys on boot. They do this *today*. That's not a hypothetical, that's a case that Debian folks have been discussing for a while now, where systems take forever to boot. This is still a bug today, if you don't have a hardware random number generator.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801272"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2019 7:21 UTC (Fri)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/801272/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn't fix the issue for live systems (are there many of those without RDRAND?), but for installed initial-boot systems: why not have the installer write out a random seed and optionally also sshd host keys? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801272/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801280"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2019 9:23 UTC (Fri)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/801280/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because host keys need to be unique. Installer is used once to create a template. This template is then used number of times to create virtual machines.<br>
Template cannot contain pregenerated host keys, because every VM would have the same key.<br>
Using installer everytime when creating new VM is not feasible, installation process takes too much time. Creating new VM is something that should take no more than few seconds.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801280/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor800756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 6:09 UTC (Sat)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/800756/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      In my opinion, a better solution would be to <em>remove</em> the automatic collection of entropy from the kernel at boot time, and <em>require</em> userspace to provide randomness (or to explicitly start the kernel randomness collection). And&nbsp;- make <tt>getrandom()</tt> (and <tt>/dev/{u,}random</tt>) return an error if they have no randomness to provide.
<p>This would mean that a userspace that doesn't initialize randomness early enough will just fail, loudly <em>and deterministically</em>. So even the folks who try to &ldquo;optimize boot time&rdquo; by just removing boot-time items without thinking won't be able to build a broken system that boots but isn't secure.
      
          <div class="CommentReplyButton">
            <form action="/Articles/800756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801273"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2019 7:31 UTC (Fri)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/801273/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't see what possible benefit removing kernel entropy collection might offer.  Many kernel entropy sources simply aren't available to userspace.  Additionally, the kernel is the logical place to pool entropy for the system; it outlives all ephemeral userspace programs.<br>
<p>
As to the rest, the APIs you ask for already exist.<br>
<p>
<font class="QuotedText">&gt; make getrandom() (and /dev/{u,}random) return an error if they have no randomness to provide.</font><br>
<p>
getrandom(1, GRND_NONBLOCK) ⇒ -1/EAGAIN; poll(/dev/random, POLLIN, 0) ⇒ 0.<br>
<p>
<font class="QuotedText">&gt; This would mean that a userspace that doesn't initialize randomness early enough will just fail, loudly and deterministically.</font><br>
<p>
All you need to do is add one of the above checks and a printf() to your userspace init process to produce the loud warning.<br>
<p>
<font class="QuotedText">&gt; So even the folks who try to “optimize boot time” by just removing boot-time items without thinking won't be able to build a broken system that boots but isn't secure.</font><br>
<p>
That is the status quo with correct use of getrandom().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801273/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor800770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 9:57 UTC (Sat)
                               by <b>dd9jn</b> (<b>&#x272D; supporter &#x272D;</b>, #4459)
                              [<a href="/Articles/800770/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So in Libgcrypt we have been urged to move to getrandom to avoid some issues in the early boot phase and to get better performance in almost all cases.  Weakening getrandowm now is a no-go and would badly reflect on the security consciousness of _some_ kernel folks.<br>
<p>
Using Stephan Müller's jitter based entropy generator inside the kernel is by any means the Right Thing to do - even if it is for now only a fallback.  In Libgcrypt's Windows version we already use it because on Windows the JitterRNG is the only non-external-hardware RNG which has been approved by Germany's BSI for use in restricted communication at the VS-NfD level.  On Linux getrandom has been evaluated as fine but nevertheless we mix some entropy from the JitterRNG into our own entropy pool.  Right, we also use RDRAND in addition and that is technically okay. But because RDRAND can't be evaluated the evaluation of Libgcrypt assumes that RDRAND adds 0 bits of entropy to the pool.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800804"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 19:52 UTC (Sat)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/800804/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Could you please submit some documental evidence of this approval? Asking because it would be the perfect response to the last paragraph in <a href="https://lore.kernel.org/lkml/CAHk-=whz7Okts01ygAP6GZWBvCV7s==CKjghmOp+r+LWketBYQ@mail.gmail.com/">https://lore.kernel.org/lkml/CAHk-=whz7Okts01ygAP6GZWBvCV...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800804/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2019 20:38 UTC (Sat)
                               by <b>joib</b> (subscriber, #8541)
                              [<a href="/Articles/800807/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Probably the BSI cares only about x86(-64) Windows on cpu's supported by currently maintained Windows versions, so they can assume the presence of TSC? So it doesn't really address what seemed to be Linus main objection.<br>
<p>
(Though in my non-expert opinion, it seems having a jitter entropy generator in the kernel for supported targets would be the least bad approach of those discussed here. Those few that run unsupported targets are hopefully sufficiently clueful that they can use a hw RNG, haveged, or maybe they don't need early boot random numbers anyway.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor801076"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2019 0:54 UTC (Wed)
                               by <b>mangix</b> (guest, #126006)
                              [<a href="/Articles/801076/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW OpenWrt master (and 19.07) uses this. It's faster than haveged.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801076/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor800815"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2019 7:29 UTC (Sun)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/800815/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The story has received an update: Linus Torvalds posted a patch to get the entropy from the timing of schedule() calls. Very similar to jitter entropy.<br>
<p>
<a href="https://lore.kernel.org/lkml/CAHk-=wgjC01UaoV35PZvGPnrQ812SRGPoV7Xp63BBFxAsJjvrg@mail.gmail.com/T/#m2ec3b5e4cd80cb55b155c15333bc8da9b6ab86d2">https://lore.kernel.org/lkml/CAHk-=wgjC01UaoV35PZvGPnrQ81...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800815/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 10:54 UTC (Mon)
                               by <b>joib</b> (subscriber, #8541)
                              [<a href="/Articles/800854/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems this approach was merged:<br>
<p>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3f2dc2798b81531fd93a3b9b7c39da47ec689e55">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
<p>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=50ee7529ec4500c88f8664560770a7a1b65db72b">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800859"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 11:57 UTC (Mon)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/800859/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, but with a few phrases in the commit message that I not necessarily agree with (or maybe should interpret as sarcasm, because then it makes perfect sense). Let me quote the problematic sentence.<br>
<p>
"""<br>
While this was triggered by what is arguably a user space bug with GDM/gnome-session asking for secure randomness during early boot, when they didn't even need any such truly secure thing, the issue ends up being that our "getrandom()" interface is prone to that kind of confusion, because people don't think very hard about whether they want to block for sufficient amounts of entropy.<br>
"""<br>
<p>
If things as late as GDM/gnome-session are still "early boot", then which service does not count as early boot? See the problem?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800859/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800869"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2019 13:19 UTC (Mon)
                               by <b>Otus</b> (subscriber, #67685)
                              [<a href="/Articles/800869/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If things as late as GDM/gnome-session are still "early boot", then which service does not count as early boot? See the problem?</font><br>
<p>
From the point of view of the random pools, before this change, anything before the user gets a login screen is early boot. That's when you start getting more than a trickle of entropy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800869/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor800961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 2:46 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/800961/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Well, if that's too early, that means you're plausibly running all kinds of nonsense, like <a href="https://docs.python.org/3/library/os.html#os.urandom">Python</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/800961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor800970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 9:39 UTC (Tue)
                               by <b>ceplm</b> (subscriber, #41334)
                              [<a href="/Articles/800970/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fixing getrandom() is removing it, or providing getnormalrandom() (which reads random data from /dev/urandom without any other checks). In the moment when there is silly method with a nice kernel call and reasonable method which is even slightly more complicated to use, everybody uses the first one even in the situation when they shouldn’t. Data from /dev/random are not more random or somehow with a pixie dust on the top. They are exactly the same, but sometimes /dev/random blocks for reasons which don’t matter for almost anybody (<a href="https://www.2uo.de/myths-about-urandom/">https://www.2uo.de/myths-about-urandom/</a>).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor800971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 9:49 UTC (Tue)
                               by <b>ceplm</b> (subscriber, #41334)
                              [<a href="/Articles/800971/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was working on the mistaken assumption that getrandom() gets data from /dev/random. It doesn’t, it is actually desgined well, and this is just a bug, which need to be fixed, no more fuss about it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/800971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 16:53 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/801018/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Using /dev/random is a bad idea in general. There's no reason it's more secure than /dev/urandom and it can lead to large delays.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801269"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2019 6:50 UTC (Fri)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/801269/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you have a device no one can use, why have it?  So I'd say it's the design of Linux /dev/random that's at fault.  Linux could drop their "entropy draining" concept tomorrow and have a /dev/random like BSD /dev/[u]random and everyone would be just as happy.  There is no academic or practical basis in the "entropy draining" model Linux's /dev/random espouses.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801269/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor802012"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 10, 2019 20:28 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/802012/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Entropy draining is still useful, but not for blocking reads -- more, so that expensive methods of *accumulating* entropy only need to run when people have actually been reading from /dev/random in the first place (right now, adding entropy to a full pool will block until the pool drains a bit). These expensive methods are not theoretical: I have one attached to the machine I'm typing this on right now. Adding entropy non-stop will max out a core...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/802012/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor801020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 17:05 UTC (Tue)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/801020/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What do you do about the fact that IoT devices built with identical hardware and identical software boot up and produce one of *maybe* 4,000 or so *identical* /dev/urandom streams. It's pretty much based on temperature which can *slightly* modify the interrupt rates vs clock cycles.<br>
<p>
At any rate, it's a real problem. Because if they do something during boot such as generate their own SSH or SSL certificates the attacker only has to guess a few possibilities.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor801033"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixing getrandom()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2019 19:02 UTC (Tue)
                               by <b>ceplm</b> (subscriber, #41334)
                              [<a href="/Articles/801033/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hold on! I haven’t said it cannot be real problem (although, couldn’t that first start of ssh daemon be a bit dealyed after whole system is up; systemd should be able to do something like that, shoudln’t it?). I just said a) there is something wrong with getrandom() defaults to the blocking version (sshd is certainly minority here, so it should be calling getrandom() with some specific options to make sure it gets lovely perfect random number), b) there is something wrong with gdm, when it doesn’t expect to be run rather early with possibly not enough entropy for something which really doesn’t require super-random numbers (it should certainly call getrandom(0) because it really doesn’t matter that much how superspecial those random numbers are). c) well, those IoT devices should know about this situation and somehow collect more enthropy themselves (mixing in MAC addresses, some their serial numbers; yes, it is predictable for the given device, but possibly less predictable for anonymous device in general? Not sure.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801033/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
