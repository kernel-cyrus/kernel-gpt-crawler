        <!DOCTYPE html>
        <html lang="en">
        <head><title>The Linux &quot;copy problem&quot; [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/789623/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/789232/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/789623/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The Linux &quot;copy problem&quot;</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 29, 2019</br>
           <hr>
<a href="/Articles/lsfmm2019/">LSFMM</a>
</div>
<p>
In a filesystem session on the third day of the 2019 Linux Storage,
Filesystem, and Memory-Management Summit (LSFMM), Steve French wanted to
talk about copy operations.  Much of the development work that has gone on
in the Linux filesystem world over the last few years has been related to
the performance of
copying files, at least indirectly, he said.  There are still pain
points around copy operations, however, so he would like to see those get
addressed. 
</p>

<p>
The "copy problem" is something that has been discussed at LSFMM before,
French said, but things have gotten better over the last year due to
efforts by Oracle, Amazon, Microsoft, and others.  Things are also changing
for copy operations; many of them are done to and from the cloud, which has
to deal with a wide variation in network latency.  At the other end, NVMe
is making larger
storage faster at a relatively affordable price.  Meanwhile virtualization
is taking more CPU, at times, because operations that might have been
offloaded to network hardware are being handled by the CPU.
</p>

<a href="/Articles/789642/">
<img src="https://static.lwn.net/images/2019/lsf-french-sm.jpg" border=0 hspace=5 align="left"
alt="[Steve French]" title="Steve French" width=232 height=280>
</a>

<p>
But copying files is one of the simplest, most intuitive operations
for users; people do it all the time.  He made multiple copies of his
presentation slides in various locations, for example.  Some of the most
common utilities used are rsync, which is part of the Samba tools, scp from
OpenSSH, and cp from the coreutils.
</p>

<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
The source code for cp is "almost embarrassingly small" at around 4K lines
of code; scp is about the same and rsync is somewhat larger.  They each
have to deal with some corner cases as well.  He showed some examples of
the amount of time it takes to copy files on Btrfs and ext4 on two
different drives attached to his laptop, one faster and one slower.  On the
slow drive with Btrfs, scp took almost five times as long as cp for a 1GB
copy.  On the fast drive, for a 2GB copy on ext4, cp took 1.2s (1.7s on the
slow), scp 1.7s (8.4s), and rsync took 4.3s (not run on the slow drive,
apparently).  These represent "a dramatic difference in performance" for a
"really stupid" copy operation
</p>

<p>
The I/O size for cp is 128K and the others use 16K, which explains some of
the difference, he said.  These copies are all going through the page
cache, which is kind of odd because you don't normally need the data you
just copied again.  None of the utilities uses <tt>O_DIRECT</tt>, if they
did there would an improvement in the performance of a few percent, he
said.  Larger I/O sizes would also improve things.
</p>

<p>
There are alternative tools that make various changes to improve
performance. For example, <a
href="https://blogs.oracle.com/cloud-infrastructure/announcing-parallel-file-tools-for-file-storage">parcp</a>
and <a href="https://www.gnu.org/software/parallel/">parallel</a>
parallelize copy operations. In addition, <a
href="https://github.com/martymac/fpart">fpart and fpsync</a> can
parallelize the operations that copy directories.  Beyond that, <a
href="https://github.com/pkolano/mutil">Mutil</a> is a parallel copy that
is based on the cp and md5sum code from coreutils; it comes out of a <a
href="https://pkolano.github.io/papers/lisa10.pdf">ten-year old paper
[PDF]</a> covering some work that NASA did on analyzing copy performance
because the agency found Linux cp to be lacking.  The code never went
upstream, however, so it can't even be built at this point, French said.
</p>

<p>
Cluster environments and network filesystems would rather have the server
handle the copies directly using copy offload.  Cloud providers would
presumably prefer to have their backends handle copy operations rather than
have them done directly from clients, he said.  Also parallelization is a
need because the common tools overuse one processor rather than
spreading the load, especially if you are doing any encryption.  In
addition, local cross-mount copies are not being done efficiently; he believes
that Linux filesystems could do a much better job in the kernel than cp
does in user space
even if they were 
copying between two different mounted filesystems of the same type.
</p>

<p>
Luis Chamberlain asked if French had spoken about these issues at
conferences that had more of a user-space focus.  The problems are real,
but it is not up to kernel developers to fix them, he said.  In addition,
any change 
to parallelize, say, cp would need to continue to operate serially in the
default case for backward compatibility.  In the end, these are user-space
problems, Chamberlain said.
</p>

<p>
In the vast majority of
cases for the open-source developers of these tools, it is the I/O device
that is the 
bottleneck, Ted Ts'o said.  If you have a 500-disk RAID array, parallel cp
makes a lot of 
sense, but the coreutils developers are not using those kinds of
machines. Similarly, "not everyone is bottlenecked on the network"; those
who are will want copy offload.  More progress will be made by targeting
specific use cases, rather than some generic "copy problem", since there are
many different kinds of bottlenecks at play here.
</p>

<p>
French said that he strongly agrees with that.  The problem is that when
people run into problems with copy performance on SMB or NFS, they contact
him.  Other types of problems lead users to contact developers of other
kernel filesystems.  For example, he said he was tempted to track down a
Btrfs developer 
when he was running some of his tests that took an inordinate amount of
time on that filesystem.
</p>

<p>
Chris Mason said that if there are dramatically different results from
local copies on the same device using the standard utilities, it probably
points to some kind 
of bug in buffered I/O.  The I/O size should not make a huge difference as
the readahead in the kernel should keep the performance roughly the same.
French agreed but said that the copy problem in Linux is something that is
discussed in multiple places.  For example, Amazon has a day-long tutorial
on copying for Linux, he said; "it's crazy".  This is a big deal for many,
"and not
just local filesystems and not just clusters".
</p>

<p>
There are different use
cases, some are trying to minimize network bandwidth, others are trying to
reduce CPU use, still others have clusters that have problems with metadata
updates.  The good news is that all of these problems have 
been solved, he said, but the bad news is that the developers of cp, parcp,
and others 
do not have the knowledge that the filesystems developers have, so they
need advice.
</p>

<p>
Though there are some places "where our APIs are badly broken", he said.
For example, when opening a file and setting a bunch of attributes, such as
access control lists (ACLs), there are races because those operations
cannot be done 
atomically.  That opens security holes.
</p>

<p>
There are some things he thinks the filesystems could do.  For example,
Btrfs could support <a
href="http://man7.org/linux/man-pages/man2/copy_file_range.2.html"><tt>copy_file_range()</tt></a>;
there are cases where Btrfs knows how to copy faster and, if it doesn't,
user space can fall back to what it does today.  There are five or so
filesystems in the kernel that support <tt>copy_file_range()</tt> and Btrfs
could do a better job with copies if this copy API is invoked; Btrfs knows
more about the placement of the data and what I/O sizes to use.
</p>

<p>
Metadata is another problem area, French said.  The race on setting ACLs is
one aspect of that.  Another is that filesystem-specific metadata may not
get copied as part of a copy operation, such as file attributes and
specialized ACLs.  There is no API for user space to call that knows how to
copy 
everything about a file; Windows and macOS have that, though it is not the
default. 
</p>

<p>
Ts'o said that shows a need for a library that provides ways to copy ACLs,
extended attributes (xattrs), and the like.  Application developers have
told him that they truncate and rewrite files because "they are too lazy to
copy the ACLs and xattrs", but then complain when they lose their data if
the machine crashes.  The solution is not a kernel API, he said.
</p>

<p>
But French is concerned that some of the xattrs have security implications
(e.g. for SELinux), so he thinks the filesystems should be involved in
copying them.  Ts'o said that doing so in the kernel actually complicates
the problem; SELinux is set up to make decisions about what the attributes
should be from user space, doing it in the kernel is the wrong place. Mason
agreed, saying there is a long history with the API for security
attributes; he is "not thrilled" with the idea of redoing that work.  He
does think that there should be a way to create files with all of their
attributes atomically, however.
</p>

<p>
There was more discussion of ways to possibly change the user-space tools,
but several asked for specific ideas of what interfaces the kernel
should be providing to help.  French said that one example would be to
provide a way to get the recommended I/O size for a file.  Right now, the
utilities base their I/O size on the inode block size reported for the file; SMB
and NFS lie and say it is 1MB to improve performance.
</p>

<p>
But Mason said that the right I/O size depends on the device.  Ts'o said
that the <tt>st_blksize</tt> returned from <tt>stat()</tt> is the preferred
I/O size according to POSIX; "whatever the hell that means".
Right now, the filesystem block size is returned in that field and there
are probably applications that use it for that purpose so a new interface
is likely needed to get the optimal I/O size; that could perhaps be added
to <tt>statx()</tt>.
But if a
filesystem is on a RAID device, 
for example, it would need to interact with the RAID controller to try to
figure out the best I/O size; often the devices will not provide enough
information so the filesystem has to guess and will get it wrong
sometimes.  That means there will need to be a way to override that value
via sysfs.
</p>

<p>
Another idea would be to give user space a way to figure out if it makes
sense to turn off the page cache, French said.  But that depends on what is
going to be done with the file after the copy, Mason said; if you are going
to build a kernel with the copied files, then you want that data in the
page cache.  It is not a decision that the kernel can help with.
</p>


<p>
The large list of copy tools with different strategies is actually a good
motivation not to change what the kernel does, Mason said.  User space is
the right place to have different policies for how to do a copy
operation. French said that 90% of the complaints he hears are about cp
performance.  Several in the discussion suggested that volunteers or
interns be found to go fix cp and make it smarter, but French would like to
see the filesystem developers participate in developing the tools or
at least advising those developers.  Mason pointed out that kernel
developers are not ambassadors to go fix applications across the
open-source world, however; "our job is to build the interfaces", so
that is where the focus of the discussion should be.
</p>

<p>
As the session closed, French said that Linux copy performance was a bit
embarrassing; OS/2 was probably better for copy performance in some ways.
But he did note that the way sparse files were handled using
<a
href="https://www.kernel.org/doc/Documentation/filesystems/fiemap.txt"><tt>FIEMAP</tt></a>
in cp was great.  Ts'o pointed out that <tt>FIEMAP</tt> is 
a great example of how the process should work.  Someone identified a
problem, so kernel developers added a new feature to help fix it, and now
that code is in cp; that is what should be happening with any other kernel
features needed for copy operations.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Block_layer">Block layer</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-copy_file_range">System calls/copy_file_range()</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2019">Storage, Filesystem, and Memory-Management Summit/2019</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/789623/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor789744"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 19:57 UTC (Wed)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/789744/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No mention of the sendfile system call?<br>
It does not work for every case, but when it does, it is much more efficient than doing chunk based copy, and it solves the "what is the optimal I/O size" dilemma.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789744/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 21:38 UTC (Wed)
                               by <b>ewen</b> (subscriber, #4772)
                              [<a href="/Articles/789760/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The sendfile system call was my thought too.  If a copy tool used sendfile, eg, for within a file system copying then the kernel has lots more information on the high level goal with which to optimise the approach taken. And even between file systems it could potentially make use of file system internal knowledge (block layout, etc) and buffer access.<br>
<p>
If copy tools just do read/write in a loop, the kernel is left guessing the high level intent (including read ahead and whether to cache it in the kernel buffers),<br>
<p>
Ewen<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789851"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 13:22 UTC (Thu)
                               by <b>ecree</b> (guest, #95790)
                              [<a href="/Articles/789851/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was wondering about splice().  Wouldn't that be a more efficient way to do copies?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789851/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 13:38 UTC (Thu)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/789852/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
According to `man splice`:<br>
<font class="QuotedText">&gt; splice()  moves  data between two file descriptors [...] where one of the file descriptors must refer to a pipe</font><br>
<p>
sendfile does not have this restriction (it can also work if the destination fd is a socket), so it is the ideal candidate for copying files.<br>
<p>
Apparently, someone proposed to update coreutil's cp to use sendfile in 2012, but it was rejected: <a href="https://lists.gnu.org/archive/html/coreutils/2012-10/msg00026.html">https://lists.gnu.org/archive/html/coreutils/2012-10/msg0...</a><br>
<p>
A while ago I did some benchmarks in Python to compare "read/write chunk" vs "sendfile" based copy, and it let to a 30-50% speedup : <a href="https://github.com/desbma/pyfastcopy#performance">https://github.com/desbma/pyfastcopy#performance</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789853"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 13:54 UTC (Thu)
                               by <b>ecree</b> (guest, #95790)
                              [<a href="/Articles/789853/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; &gt; one of the file descriptors must refer to a pipe</font><br>
Yes, so you make two splice calls:<br>
<p>
  int p[2];<br>
  pipe(p);<br>
  splice(fd_in, NULL, p[1], NULL, len, flags);<br>
  splice(p[0], NULL, fd_out, NULL, len, flags);<br>
<p>
I haven't actually tried this, but in theory it should enable the kernel to do a zero-copy copy where the underlying files support that.  The pipe is really no more than a way to associate a userspace handle with a kernel buffer; see <a href="https://yarchive.net/comp/linux/splice.html">https://yarchive.net/comp/linux/splice.html</a> for details.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789853/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 14:00 UTC (Thu)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/789854/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I haven't actually tried this, but in theory it should enable the kernel to do a zero-copy copy where the underlying files support that.</font><br>
<p>
This is exactly what sendfile does, with a single system call, instead of 3 for your example.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789749"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 20:20 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/789749/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Mason pointed out that kernel developers are not ambassadors to go fix applications across the open-source world, however; "our job is to build the interfaces", so that is where the focus of the discussion should be.</font><br>
<p>
It seems like it would be worth at least diving into `cp` and making sure it's as good as can be, since that gets used so much. Then you can point developers of those other applications at `cp` as an example of how to do things right.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789749/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 21:05 UTC (Wed)
                               by <b>smfrench</b> (subscriber, #124116)
                              [<a href="/Articles/789755/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the presentation I listed seven options that could be added (e.g. to cp and rsync).   Other copy tools (like robocopy for Windows) have these (as well as others that may be less important for us on Linux) and may be useful examples.<br>
<p>
For example some options which other tools like robocopy let the user select:<br>
- parallel i/o (especially for the uncached copy case)<br>
- allow setting file size first (to reduce the number of metadata updates during the copy operation)<br>
- allow calling the copy system call (copy_file_range API) for file systems which support it<br>
- allow copying additional metadata (e..g xattr and ACLs)<br>
- allow choosing larger i/o (overriding the block size).  For some filesystems i/o &gt; 1MB can be much faster than small I/O (some tools will default to 4K or smaller which can be more than 10 times slower)<br>
<p>
And then following up on other discussions at the sumimt:<br>
- allow options like encryption or compression (which could be supported over SMB3 for example and probably other filesystems).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789776"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 23:05 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/789776/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That makes sense, but you also want to the default to be as good as can be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789776/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789886"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 16:20 UTC (Thu)
                               by <b>boutcher</b> (subscriber, #7730)
                              [<a href="/Articles/789886/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I had to laugh that you brought up OS/2<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789886/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790041"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 1:40 UTC (Sat)
                               by <b>tarkasteve</b> (guest, #94934)
                              [<a href="/Articles/790041/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd also humbly suggest `xcp`:<br>
<p>
<a href="https://crates.io/crates/xcp">https://crates.io/crates/xcp</a><br>
<p>
* Uses copy_file_range() where possible, falls back to userspace if not.<br>
* Supports sparse files (with lseek; I wasn't aware of fiemap, is there any advantage to one over the other?)<br>
* Partially parallel (recursive read is separate from copy operations; I have an todo for parallel copy as it seems to have advantages on nvme drives).<br>
* Optional progress bar.<br>
* Written in Rust<br>
* Cross platform (well, Linux + other unix-like OSs; Windows may work, I've never managed to get Rust to work on it).<br>
<p>
It doesn't support much in the way of permissions/ACLs ATM, it's still an intermittent WIP.<br>
<p>
I did look at using O_DIRECT, but I get EINVAL. The open manpage lists a whole series of caveats and warnings about using it, including a disparaging quote from Linus.<br>
<p>
Thanks for the discussion/article, it's given me some things to look into.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790041/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790054"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 13:04 UTC (Sat)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/790054/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the link.<br>
<p>
It joins the list of great little tools that have taken inspiration from classic Unix command line tools, but rewritten them in Rust with many improvements along the way: grep -&gt; ripgrep, find -&gt; fd, hexdump -&gt; hexyl, cat -&gt; bat, du -&gt; diskus, cloc -&gt; tokei...<br>
<p>
I'll be sure to look into xcp, and probably open a few issues along the way :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790054/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790067"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 3:02 UTC (Sun)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/790067/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I myself was using inotail until I reported the problem (tail -f didn't support inotify) to coreutils and it was actually fixed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790067/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor790072"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 5:12 UTC (Sun)
                               by <b>tarkasteve</b> (guest, #94934)
                              [<a href="/Articles/790072/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So inspired by all this, I've updated xcp with the ability to do parallel copies (at the per-file level). The results are fairly good; I'm seeing 30%-60% speed-ups depending on caching.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790072/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790839"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2019 21:58 UTC (Mon)
                               by <b>smfrench</b> (subscriber, #124116)
                              [<a href="/Articles/790839/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is great news - looking forward to trying it.   Am also very excited about the work Andreas at RedHat did, enabling GCM crypto for SMB3.1.1 mounts, which can more than double performance copying files to server when on encrypted mounts (in conjunction with two cifs.ko client patches that I recently merged into for-next that enable GCM on the client).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790839/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor789805"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 7:29 UTC (Thu)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/789805/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I had a range of responses to this 'build the interfaces' thing. <br>
<p>
How people use those interfaces is something that needs guidance, always: you form a symbiotic loop in reliance on each other. <br>
<p>
Conway's Law hasn't gone away and is implications about interacting with the users of your interfaces still stand. I think that Chris Mason's comment here is misguided and that we need to help people work together and communicate better. I think we need to balance this view of APIs with criticism of xattrs being difficult to copy and racy (with security implications).<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789805/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 16:00 UTC (Thu)
                               by <b>KAMiKAZOW</b> (guest, #107958)
                              [<a href="/Articles/789882/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It seems like it would be worth at least diving into `cp` and making sure it's as good as can be, since that gets used so much.</font><br>
<p>
I find it insane that cp was fixed a decade ago by NASA and in all that time neither them nor anybody else thought about upstreaming the changes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789885"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 16:17 UTC (Thu)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/789885/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unfortunately, there are many other example of cases like this.<br>
<p>
For example zlib, one the most widely used software library in the world, has several forks (Intel, Cloudflare, zlib-ng...) with optimizations that improve compression/decompression speed.<br>
<p>
Yet the changes have never been merged back in zlib, and everybody still uses the historic version, and happily wastes CPU cycles (including when your browser decompresses this very page).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789885/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790069"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 3:07 UTC (Sun)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/790069/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  (including when your browser decompresses this very page).</font><br>
<p>
Compression is disabled for https sites due to various attacks on the file size information leak.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790069/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790075"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 10:27 UTC (Sun)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/790075/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My browser (and curl) both disagree with you:<br>
curl -v --compressed '<a href="https://lwn.net/">https://lwn.net/</a>' &gt; /dev/null 2&gt;&amp;1 | grep gzip<br>
<font class="QuotedText">&gt; Accept-Encoding: deflate, gzip</font><br>
&lt; Content-Encoding: gzip<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790075/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790077"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 12:20 UTC (Sun)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/790077/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; curl -v --compressed '<a href="https://lwn.net/">https://lwn.net/</a>' &gt; /dev/null 2&gt;&amp;1 | grep gzip</font><br>
<p>
This command is obviously without any output.<br>
<p>
$ curl -v --compressed '<a href="https://lwn.net/">https://lwn.net/</a>' &gt; /dev/null 2&gt;&amp;1 | wc<br>
      0       0       0<br>
<p>
Perhaps you meant: curl -v --compressed '<a href="https://lwn.net/">https://lwn.net/</a>' 2&gt;&amp;1 &gt; /dev/null | grep gzip<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790077/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 12:45 UTC (Sun)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/790079/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are right, I'm using ZSH and didn't realize that line was not portable across other shells.<br>
<p>
curl -v --compressed '<a href="https://lwn.net/">https://lwn.net/</a>' -o /dev/null 2&gt;&amp;1 | grep gzip<br>
<p>
also works<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789818"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 10:35 UTC (Thu)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/789818/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't cp often but when I do I cp --reflink<br>
<p>
:)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789818/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 9:33 UTC (Fri)
                               by <b>LtWorf</b> (subscriber, #124958)
                              [<a href="/Articles/789970/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Some of us don't use experimental filesystems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 14:44 UTC (Fri)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/790007/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn't XFS has reflink() support?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 15:46 UTC (Fri)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/790011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes.  Enabled by default in recent Fedora and RHEL 8 as well. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor791227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 16, 2019 17:40 UTC (Sun)
                               by <b>nevyn</b> (guest, #33129)
                              [<a href="/Articles/791227/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why is this not the default?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/791227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor791532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 20, 2019 6:51 UTC (Thu)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/791532/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think people were concerned with loss of redundancy. Some claimed that they make a copy because they want to *really* have an actual copy and making it COW by default is surprising to the user by basically changing the contract of the command.<br>
<p>
That's how I remember it at least.<br>
<p>
Anyway, when I copy something it's mostly because I screwed up and I am restoring things from a btrfs backup snapshot. Making a real copy would cause unnecessary duplication in the backup - and would be unnecessarily slow and drive-thrashing. But that's just my use case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/791532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor791854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 24, 2019 14:28 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/791854/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Reflinking does, inevitably, reduce the fragmentation-resistance of the filesystem if you use it a lot and tend to keep the post-reflinked files for longer than the pre-reflinked ones. (That's the whole point, after all: the new blocks are necessarily going to be fragmented wrt the old ones, even if this is reduced by writing more than strictly needed in the CoW phase.)<br>
<p>
Ideally, a background preen phase would rewrite such things after a while so they are non-fragmented again. I guess one could call xfs_fsr from cron to do that... on an SSD this matters not at all, of course, and not very much if there's a caching layer like LVM's or bcache in the way either. But it's a real concern on unintermediated spinning rust.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/791854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor789869"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The copy problem is really the backup problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 15:01 UTC (Thu)
                               by <b>mcr</b> (subscriber, #99374)
                              [<a href="/Articles/789869/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the old says of Unix, with a single file system, we used "dump" to get a good copy.  It had all sorts ridiculous issues of having a userspace program trying to decipher file system contents from raw reads of the disk. On the other hand, when it worked, it got all the metadata, did it without destroying the buffer cache, and often was able to backup disks which were in the process of dying.  When it failed, it failed, and the backups were sometimes garbage.  And it didn't work for many things.  So people mostly use tar for backup.  And that's should be the most common copy problem, which is not just about data centers or cluster environments.  And tar fails for any file system that does something innovative.<br>
My claim is that our VFS layer is incomplete: it should include an atomic backup and an atomic restore operation, at least on a file level, but optionally on a directory basis.  If we had that, then cp would always usefully be backup file | restore file2.  This means that file systems have to serialize file contents and meta data, and have to deserialize it too.  We Linux a microkernel architecture, then probably much of this deserialization could be done in some system-provided, non-ring0 context.  Should we pick tar for serialization, or something more modern like CBOR, that's a bike shed for a design team.<br>
I would just be happy if we could agree that we need this functionality.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789869/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The copy problem is really the backup problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2019 9:18 UTC (Tue)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/790232/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At least on btrfs that's:<br>
<p>
btrfs subvolume snapshot -r<br>
btrfs send<br>
btrfs receive<br>
<p>
But it does not work on per-file basis, unfortunately. And yes, btrfs defines its own serialization format.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790239"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The copy problem is really the backup problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2019 14:06 UTC (Tue)
                               by <b>mcr</b> (subscriber, #99374)
                              [<a href="/Articles/790239/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What happens if a file is open (TXTBUSY)?  or open O_DIRECT, or any of these other things that might be mutually exclusive with regular I/O?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790239/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor791513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The copy problem is really the backup problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2019 21:32 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/791513/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
btrfs send and receive are not regular I/O, so they work fine. (Though I'm not sure what happens in conjunction with O_DIRECT, which is a bit... hard to grasp the semantics of on a CoW filesystem in any case.)<br>
<p>
(You don't get -ETXTBSY if you read a file in any case, only if you try to modify it.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/791513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor789909"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 18:56 UTC (Thu)
                               by <b>jmgao</b> (guest, #104246)
                              [<a href="/Articles/789909/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; He does think that there should be a way to create files with all of their attributes atomically, however.</font><br>
<p>
Isn't there already a solution to this? You can open a file on the filesystem you want to create the file on with O_TMPFILE to hide it until you've done all of your attribute twiddling, do your fsetfilecon, fsetxattr, etc. on the file descriptor, and then use linkat to put it into place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789909/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor790060"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 16:11 UTC (Sat)
                               by <b>jmclnx</b> (guest, #72456)
                              [<a href="/Articles/790060/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Speeding up things is always good, but the one thing I have noticed in the last few years.  Once in a great while, if I cp a large file from one local fs to another local fs, the whole system would freeze for multiple 10s of seconds when a sync happens.  <br>
<p>
In the early days I never saw this and we use to make fun of Microsoft for having that freeze issue.  I would rather have a slower cp and not have that sync freeze :)<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790060/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790064"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 21:13 UTC (Sat)
                               by <b>desbma</b> (guest, #118820)
                              [<a href="/Articles/790064/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is most likely the infamous "dirty writeback" problem, best described in this LWN article: <a href="https://lwn.net/Articles/572911/">https://lwn.net/Articles/572911/</a><br>
<p>
On my systems, I fix it permanently with:<br>
echo "vm.dirty_background_bytes=$((48 * 1024 * 1024))<br>
vm.dirty_ratio=10" | sudo tee /etc/sysctl.d/99-dirty-writeback.conf<br>
sudo sysctl --system<br>
<p>
That way the writeback kicks in with at most 48MB of dirty data, and also stalls the writer process before there is more than 10% of all memory consumed by dirty writeback pages.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790064/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor844695"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Linux &quot;copy problem&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 1, 2021 13:18 UTC (Mon)
                               by <b>oliwer</b> (subscriber, #40989)
                              [<a href="/Articles/844695/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Note that GNU cp(1) recently added support for copy_file_range(2).<br>
<a rel="nofollow" href="https://git.savannah.gnu.org/cgit/coreutils.git/commit/src/copy.c?id=4b04a0c3b792d27909670a81d21f2a3b3e0ea563">https://git.savannah.gnu.org/cgit/coreutils.git/commit/sr...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/844695/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
