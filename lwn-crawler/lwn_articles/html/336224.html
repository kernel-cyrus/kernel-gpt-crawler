        <!DOCTYPE html>
        <html lang="en">
        <head><title>Linux kernel design patterns - part 1 [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/336224/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/336138/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/336224/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Linux kernel design patterns - part 1</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="GAByline">
           <p>June 8, 2009</p>
           <p>This article was contributed by Neil&nbsp;Brown</p>
           </div>
One of the topics of ongoing interest in the kernel community is that
of maintaining quality.  It is trivially obvious that we need to
maintain and even improve quality.  It is less obvious how best to do
so.
One broad approach that has found some real success is to increase the
visibility of various aspects of the kernel.  This makes the quality
of those aspects more apparent, so this tends to lead to an
improvement of the quality.
<p>
This increase in visibility takes many forms:
<p>
<ul>
<li> The <tt>checkpatch.pl</tt> script highlights many deviations
   from accepted code formatting style.   This encourages people (who
   remember to use the script) to fix those style errors.  So, by
   increasing the visibility of the style guide, we increase the
   uniformity of appearance and so, to some extent, the quality.
<p>
<li> The "lockdep" system (when enabled) dynamically measures
   dependencies between locks (and related states such as whether
   interrupts are enabled).  It then reports anything that looks odd.
   These oddities will not always mean a deadlock or similar problem is
   possible, but in many cases they do, and the deadlock possibility
   can be removed.  So by increasing the visibility of the lock
   dependency graph, quality can be increased.
<p>
<li> The kernel contains various other enhancements to visibility such
   as the "poisoning" of unused areas of memory so invalid access will
   be more apparent, or simply the use of symbolic names rather than
   plain hexadecimal addresses in stack traces so that bug reports are more
   useful.
<p>
<li> At a much higher level, the "git" revision tracking software that
   is used for tracking kernel changes makes it quite easy to see who
   did what and when.  The fact that it encourages a comment to be
   attached to each patch makes it that much easier to answer the
   question "Why is the code this way".  This visibility can improve
   understanding and that is likely to improve quality as more
   developers are better informed.
</ul>
<p>
There are plenty of other areas where increasing visibility does, or
could, improve quality.  In this series we will explore one
particular area where your author feels visibility could be increased
in a way that could well lead to qualitative improvements.  That area
is the enunciation of kernel-specific design patterns.
<p>
<h4>Design Patterns</h4>

<p>
A "design pattern" is a concept that was first expounded in the field of
Architecture and was brought to computer engineering, and particularly
the Object Oriented Programming field, though the 1994 publication
<i>Design Patterns: Elements of Reusable Object-Oriented Software</i>.
Wikipedia has <a
href="http://en.wikipedia.org/wiki/Design_pattern_%28computer_science%29">further
useful background information</a> on the topic. 
<p>
In brief, a design pattern describes a particular class of design
problem, and details an approach to solving that class of problem that
has proven effective in the past.  One particular benefit of a design
pattern is that it combines the problem description and the solution
description together and gives them a name.  Having a simple and
memorable name for a pattern is particularly valuable.  If both
developer and reviewer know the same names for the same patterns, then
a significant design decision can be communicated in one or two words,
thus making the decision much more visible.
<p>
In the Linux kernel code base there are many design patterns that have
been found to be effective.  However most of them have never been
documented so they are not easily available to other developers.   It
is my hope that by explicitly documenting these patterns, I can help them
to be
more widely used and, thus, developers will be able to achieve effective
solutions to common problems more quickly.
<p>
In the remainder of this series we will be looking at three problem
domains and finding a variety of design patterns of greatly varying
scope and significance.  Our goal in doing so is to not only to enunciate
these patterns, but also to show the range and value of such
patterns so that others might make the effort to enunciate patterns
that they have seen.
<p>
A number of examples from the Linux kernel will be presented
throughout this series as examples are an important part of
illuminating any pattern.  Unless otherwise stated they are all from
2.6.30-rc4.
<p>
<a name="refcount"></a>
<h4>Reference Counts</h4>

<p>
The idea of using a reference counter to manage the lifetime of an
object is fairly common.  The core idea is to have a counter which is
incremented whenever a new reference is taken and decremented when a
reference is released.  When this counter reaches zero any resources
used by the object (such as the memory used to store it) can be
freed.
<p>
The mechanisms for managing reference counts seem quite straightforward.
However there are some subtleties that make it quite easy to
get the mechanisms wrong.  Partly for this reason, the Linux kernel
has (since 2004) a data type known as "kref" with associated support
routines (see <tt>Documentation/kref.txt</tt>,
<tt>&lt;linux/kref.h&gt;</tt>, and 
<tt>lib/kref.c</tt>).  These encapsulate some of those subtleties and, in
particular, make it clear that a given counter is being used as a
reference counter in a particular way.  As noted above, names for
design patterns are very valuable and just providing that name for
kernel developers to use is a significant benefit for reviewers.
<p>
In <a
href="http://lkml.indiana.edu/hypermail/linux/kernel/0403.1/1656.html">the
words of Andrew Morton</a>: 
<p>
<div class="BigQuote">
   I care more about being able to say "ah, it uses kref. I understand
   that refcounting idiom, I know it's well debugged and I know that
   it traps common errors". That's better than "oh crap, this thing
   implements its own refcounting - I need to review it for the usual
   errors".
</div>
<p>
This inclusion of kref in the Linux kernel gives both a tick and a
cross to the kernel in terms of explicit support for design patterns.

A tick is deserved as the kref clearly embodies an important design
pattern, is well documented, and is clearly visible in the code when
used.

It deserves a cross however because the kref only encapsulates part of
the story about reference counting.  There are some usages of
reference counting that do not fit well into the kref model as we will
see shortly.  Having a "blessed" mechanism for reference counting that
does not provide the required functionality can actually encourage
mistakes as people might use a kref where it doesn't belong and so
think it should just work where in fact it doesn't.
<p>
A useful step to understanding the complexities of reference counting
is to understand that there are often two distinctly different sorts of
references to an object.  In truth there can be three or even more, but
that is very uncommon and can usually be understood by generalizing
the case of two.
We will call the two types of references "external" and "internal",
though in some cases "strong" and "weak" might be more appropriate.
<p>
An "external" reference is the sort of reference we are probably most
accustomed to think about.  They are counted with "get" and "put" and
can be held by subsystems quite distant from the subsystem that
manages the object.  The existence of a counted external reference has
a strong and simple meaning:  This object is in use.
<p>
By contrast, an "internal" reference is often not counted, and is only
held internally to the system that manages the object (or some close
relative).  Different internal references can have very different
meanings and hence very different implications for implementation.
<p>
Possibly the most common example of an internal reference is a cache
which provides a "lookup by name" service.  If you know the name of an
object, you can apply to the cache to get an external reference,
providing the object actually exists in the cache.  Such a cache
would hold each object on a list, or on one of a number of lists under
e.g. a hash table.  The presence of the object on such a list is a
reference to the object.  However it is likely not a counted
reference.  It does not mean "this object is in use" but only "this
object is hanging around in case someone wants it".  Objects are not
removed from the list until all external references have been dropped,
and possibly they won't be removed immediately even then.
Clearly the existence and nature of internal references can have
significant implications on how reference counting is implemented.
<p>
One useful way to classify different reference counting styles is by
the required implementation of the "put" operation.
The "get" operation is always the same.  It takes an
external reference and produces another external reference.
It is implemented by something like:
<p>
<pre>
    assert(obj-&gt;refcount &gt; 0) ; increment(obj-&gt;refcount);
</pre>
<p>
or, in Linux-kernel C:
<p>
<pre>
    BUG_ON(!atomic_read(&amp;obj-&gt;refcnt)) ; atomic_inc(&amp;obj-&gt;refcnt);
</pre>
<p>
Note that "get" cannot be used on an unreferenced object.  Something
else is needed there.
<p>
The "put" operation comes in three variations.  While there can be
some overlap in use cases, it is good to keep them separate to help
with clarity of the code.  The three options, in Linux-C, are:
<p>
<pre>
   1      atomic_dec(&amp;obj-&gt;refcnt);

   2      if (atomic_dec_and_test(&amp;obj-&gt;refcnt)) { ... do stuff ... }

   3      if (atomic_dec_and_lock(&amp;obj-&gt;refcnt, &amp;subsystem_lock)) {
                 ..... do stuff ....
		 spin_unlock(&amp;subsystem_lock);
	  }
</pre>
<p>
<h4>The "kref" style</h4>

<p>
Starting in the middle, option "2" is the style used for a kref.
This style is appropriate when the object does not outlive its last
external reference.   When that reference count becomes zero, the object
needs to be freed or otherwise dealt with, hence the need to test for
the zero condition with <tt>atomic_dec_and_test()</tt>.
<p>
Objects that fit this style often do not have any internal references
to worry about, as is the case with most objects in sysfs, which is a
heavy user of kref.
If, instead, an object using the kref style does have internal references, it
cannot be allowed to create an external reference from an internal
reference unless there are known to be other external references.
If this is necessary, a primitive is available:
<p>
<pre>
     atomic_inc_not_zero(&amp;obj-&gt;refcnt);
</pre>
<p>
which increments a value providing it isn't zero, and returns a result
indicating success or otherwise.

<tt>atomic_inc_not_zero()</tt> is a relatively recent invention in the linux
kernel, appearing in late 2005 as part of the lockless page cache
work.  For this reason it isn't widely used and some code that could
benefit from it uses spinlocks instead.
Sadly, the kref package does not make use of this primitive either.
<p>
An interesting example of this style of reference that does not use
kref, and does not even use <tt>atomic_dec_and_test()</tt> (though it could
and 
arguably should) are the two ref counts in <tt>struct&nbsp;super</tt>:
<tt>s_count</tt> and <tt>s_active</tt>.
<p>
<tt>s_active</tt> fits the kref style of reference counts exactly.  A
superblock starts life with <tt>s_active</tt> being 1 (set in
<tt>alloc_super()</tt>), and,
when <tt>s_active</tt> becomes zero, further external references cannot be
taken.  This rule is encoded in <tt>grab_super()</tt>, though this is not
immediately clear.  The current code (for historical reasons) adds a
very large value (S_BIAS) to <tt>s_count</tt> whenever <tt>s_active</tt> is non-zero,
and <tt>grab_super()</tt> tests for <tt>s_count</tt> exceeding S_BIAS rather than for
<tt>s_active</tt> being zero.  It could just as easily do the latter test using
<tt>atomic_inc_not_zero()</tt>, and avoid the use of spinlocks.
<p>
<tt>s_count</tt> provides for a different sort of reference which has both
"internal" and "external" aspects.  It is internal in that its
semantic is much weaker than that of <tt>s_active</tt>-counted references.
References counted by <tt>s_count</tt> just mean "this superblock cannot be
freed just now" without asserting that it is actually active.
It is external in that it is much like a kref starting life
at 1 (well, 1*S_BIAS actually), and when it becomes zero (in
<tt>__put_super()</tt>) the superblock is destroyed.
<p>
So these two reference counts could be replaced by two krefs,
providing:
<p>
<ul>
<li> S_BIAS was set to 1
<p>
<li> <tt>grab_super()</tt> used <tt>atomic_inc_not_zero()</tt> rather than
     testing against 
    S_BIAS
</ul>
<p>
and a number of spinlock calls could go away.  The details are left as
an exercise for the reader.
<p>
<h4>The "kcref" style</h4>

<p>
The Linux kernel doesn't have a "kcref" object, but that is a name
that seems suitable to propose for the next style of reference count.
The "c" stands for "cached" as this style is very often used in
caches.  So it is a Kernel Cached REFerence.
<p>
A kcref uses <tt>atomic_dec_and_lock()</tt> as given in option 3 above.  It does
this because, on the last put, it needs to be freed or checked to see if any other
special handling is needed.   This needs to be done under a lock to
ensure no new reference is taken while the current state is being
evaluated.
<p>
A simple example here is the <tt>i_count</tt> reference counter in
<tt>struct&nbsp;inode</tt>. 
The important part of <tt>iput()</tt> reads:
<p>
<pre>
    if (atomic_dec_and_lock(&amp;inode-&gt;i_count, &amp;inode_lock))
	iput_final(inode);
</pre>
<p>
where <tt>iput_final()</tt> examines the state of the inode and decides if it
can be destroyed, or left in the cache in case it could get reused
soon.
<p>
Among other things, the <tt>inode_lock</tt> prevents new external references
being created from the internal references of the inode hash table.
For this reason converting internal references to external references
is only permitted while the <tt>inode_lock</tt> is held.  It is no accident
that the function supporting this is called <tt>iget_locked()</tt> (or
<tt>iget5_locked()</tt>).
<p>
A slightly more complex example is in <tt>struct dentry</tt>, where
<tt>d_count</tt> is 
managed like a kcref.  It is more complex because two locks need to be
taken before we can be sure no new reference can be taken - both
<tt>dcache_lock</tt> and <tt>de-&gt;d_lock</tt>.  This requires that either we hold one
lock, then <tt>atomic_dec_and_lock()</tt> the other (as in
<tt>prune_one_dentry()</tt>), or 
that we <tt>atomic_dec_and_lock()</tt> the first, then claim the second and
retest the refcount - as in <tt>dput()</tt>.
This is good example of the fact that you can never assume you have
encapsulated all possible reference counting styles.  Needing two
locks could hardly be foreseen.
<p>
An even more complex kcref-style refcount is <tt>mnt_count</tt> in 
<tt>struct&nbsp;vfsmount</tt>.  The complexity here is the interplay of the two refcounts
that this structure has: <tt>mnt_count</tt>, which is a fairly straightforward
count of external references, and <tt>mnt_pinned</tt>, which counts
internal references from the process accounting module.  In particular
it counts the number of accounting files that are open on the
filesystem (and as such could use a more meaningful name).  The
complexity comes from the fact that when there are only internal
references remaining, they are all converted to external references.
Exploring the details of this is again left as an exercise for the
interested reader.
<p>
<h4>The "plain" style</h4>

<p>
The final style for refcounting involves just decrementing the
reference count (<tt>atomic_dec()</tt>) and not doing anything else.
This style is relatively uncommon in the kernel, and for good reason.
Leaving unreferenced objects just lying around isn't a good idea.
<p>
One use of this style is in <tt>struct buffer_head</tt>, managed by
<tt>fs/buffer.c</tt> 
and <tt>&lt;linux/buffer_head.h&gt;</tt>.  The <tt>put_bh()</tt> function
is simply: 
<p>
<pre>
    static inline void put_bh(struct buffer_head *bh)
    {
        smp_mb__before_atomic_dec();
        atomic_dec(&amp;bh-&gt;b_count);
    }
</pre>
<p>
This is OK because buffer_heads have lifetime rules that are closely
tied to a page.  One or more buffer_heads get allocated to a page to
chop it up into smaller pieces (buffers).  They tend to remain there
until the page is freed at which point all the buffer_heads will be
purged (by <tt>drop_buffers()</tt> called from <tt>try_to_free_buffers()</tt>).
<p>
In general, the "plain" style is suitable if it is known that there
will always be an internal reference so that the object doesn't get
lost, and if there is some process whereby this internal reference
will eventually get used to find and free the object.
<p>

<h4>Anti-patterns</h4>

<p>
To wrap up this little review of reference counting as an introduction
to design patterns, we will discuss the related concept of an
anti-pattern.
While design patterns are approaches that have been shown to work and
should be encouraged, anti-patterns are approaches that history shows
us do not work well and should be discouraged.
<p>
Your author would like to suggest that the use of a "bias" in a
refcount is an example of an anti-pattern.

A bias in this context is a large value that is added to, or
subtracted from, the reference count and is used to effectively
store one bit of information.

We have already glimpsed the idea of a bias in the management of
<tt>s_count</tt> for superblocks.  In this case the presence of the bias
indicates that the value of <tt>s_active</tt> is non-zero, which is easy enough
to test directly.  So the bias adds no value here and only obscures the
true purpose of the code.
<p>
Another example of a bias is in the management of
<tt>struct&nbsp;sysfs_dirent</tt>,
in <tt>fs/sysfs/sysfs.h</tt> and <tt>fs/sysfs/dir.c</tt>.  Interestingly,
<tt>sysfs_dirent</tt> has two refcounts just like superblocks, also called
<tt>s_count</tt> and <tt>s_active</tt>.  In this case <tt>s_active</tt> has a large negative bias
when the entry is being deactivated.  The same bit of information
could be stored just as effectively and much more clearly in the
flag word <tt>s_flags</tt>.  Storing single bits of information in flags is
much easier to understand that storing them as a bias in a counter,
and should be preferred.
<p>
In general, using a bias does not add any clarity as it is not a
common pattern.  It cannot add more functionality than a single flag
bit can provide, and it would be extremely rare that memory is so
tight that one bit cannot be found to record whatever would otherwise
be denoted by the presence of the bias.  For these reasons, biases in
refcounts should be considered anti-patterns and avoided if at all
possible.
<p>

<h4>Conclusion</h4>

<p>
This brings to a close our exploration of the various design patterns
surrounding reference counts.  Simply having terminology such a "kref"
versus "kcref" and "external" versus "internal" references can be very
helpful in increasing the visibility of the behaviour of different
references and counts.  Having code to embody this as we do with kref
and could with kcref, and using this code at every opportunity, would
be a great help both to developers who might find it easy to choose
the right model first time, and to reviewers who can see more clearly
what is intended.
<p>

The design patterns we have covered in this article are:
<p>
<ul>
<li> <b>kref</b>:
    When the lifetime of an object extends only to the moment that
    the last external reference is dropped, a kref is appropriate.
    If there are any internal reference to the object, they can only
    be promoted to external references with <tt>atomic_inc_not_zero()</tt>.
    Examples:  <tt>s_active</tt> and <tt>s_count</tt> in <tt>struct
    super_block</tt>. 
<p>
<li> <b>kcref</b>:
    With this the lifetime of an object can extend beyond the dropping
    of the last external reference, the kcref with its
    <tt>atomic_dec_and_lock()</tt> is appropriate.  An internal reference can
    only be converted to an external reference will the subsystem
    lock is held.
    Examples: <tt>i_count</tt> in <tt>struct inode</tt>.
<p>
<li> <b>plain</b>:
    When the lifetime of an object is subordinate to some other
    object, the plain reference pattern is appropriate.  Non-zero
    reference counts on the object must be treated as internal
    reference to the parent object, and converting internal references
    to external references must follow the same rules as for the
    parent object.
    Examples: <tt>b_count</tt> in <tt>struct buffer_head</tt>.
<p>
<li> <b>biased-reference</b>:
    When you feel the need to use add a large bias
    to the value in a reference count to indicate some particular
    state, don't.  Use a flag bit elsewhere.  This is an
    anti-pattern. 
</ul>
<p>
Next week we will move on to another area where the Linux kernel has
proved some successful design patterns and explore the slightly
richer area of complex data structures.  (<a
href="/Articles/336255/">Part&nbsp;2</a> and <a
href="/Articles/336262/">part&nbsp;3</a> of this series are now
available). 

<p>    
<h4>Exercises</h4>

<p>
As your author has been reminded while preparing this series, there is
nothing like a directed study of code to clarify understanding of
these sorts of issues.  With that in mind, here are some exercises for
the interested reader.
<p>
<ol>
<li> Replace <tt>s_active</tt> and <tt>s_count</tt> in <tt>struct super</tt> with krefs, discarding
   S_BIAS in the process.  Compare the result with the original using
   the trifecta of Correctness, Maintainability, and Performance.
<p>
<li> Choose a more meaningful name for <tt>mnt_pinned</tt> and related
   functions that manipulate it.
<p>
<li> Add a function to the kref library that makes use of
   <tt>atomic_inc_not_zero()</tt>, and using it (or otherwise) remove the use of
   <tt>atomic_dec_and_lock()</tt> on a kref in
   <tt>net/sunrpc/svcauth.c</tt> - a usage 
   which violates the kref abstraction.
<p>
<li> Examine the <tt>_count</tt> reference count in <tt>struct page</tt>
(see <tt>mm_types.h</tt> 
   for example) and determine whether it behaves most like a kref or a
   kcref (hint: it is not "plain").  This should involve identifying
   any and all internal references and related locking rules.
   Identify why the page cache (<tt>struct address_space.page_tree</tt>) owns
   a counted reference or explain why it should not.
   This will involve understanding <tt>page_freeze_refs()</tt> and its usage in
   <tt>__remove_mapping()</tt>, as well as
   <tt>page_cache_{get,add}_speculative()</tt>.
</ol>
<p>
Bonus credit:  provide a series of minimal self-contained patches to
   implement any changes that the above investigations proved useful.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-Patterns">Development model/Patterns</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Brown_Neil">Brown, Neil</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/336224/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor336719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">One use for reference-count biases...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 4:36 UTC (Tue)
                               by <b>PaulMcKenney</b> (<b>&#x272D; supporter &#x272D;</b>, #9624)
                              [<a href="/Articles/336719/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One use for reference-count biases is where the reference count is modified often enough that it must be represented as a per-CPU variable, as can happen when the reference count represents the number of outstanding I/Os. However, unless the reference count tends to be much larger than the number of CPUs, you get no benefit from the per-CPU nature of the variable.  Adding in a large bias, on the other hand, allows the counter to operate on a completely per-CPU basis under normal operating conditions.<br>
<p>
This trick is useful in cases where it is only necessary to actually test the counter for zero-or-not in special situations, such as when attempting to remove or reconfigure the I/O device.  When such a situation arises, one subtracts out the bias, and then runs inefficiently until the I/Os drain and the reference count goes to zero, at which point the device may be safely removed or reconfigured.  The bias may be added back in to return to normal operating conditions.<br>
<p>
A very specialized use of a reference count, perhaps, but one that has actually appeared in real code in past lives.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/336719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336720"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">One use for reference-count biases...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 5:39 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/336720/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>
Yes, I wouldn't be surprised if reference counts that are spread across multiple per-cpu variables would have very different trade-offs and hence different Patterns to the more traditional kinds!
<p>
I'm having trouble picturing exactly how the counters you describe would work (and particularly exactly what happens when the per-cpu counter hits zero) but it seems possible that the "one bit of information" that I claim a bias stores would, in this case, be the bit "Someone cares about a precise total value" and that one bit could conceivably be stored in a read-mostly
cache line that could be easily shared among multiple processors.
<p>
So the code might look like:
<pre>
   if (dec_and_test(per_cpu_counter))
         if (__test_bit(flag_name, &amp;flag_variable))
               do some costly cross-cpu thing;
</pre>
<p>
Is there any chance that would achieve the same result?
<p>
It may well be a case where you don't want to pay the price of an
extra bit though.

      
          <div class="CommentReplyButton">
            <form action="/Articles/336720/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336752"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">One use for reference-count biases...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 13:50 UTC (Tue)
                               by <b>PaulMcKenney</b> (<b>&#x272D; supporter &#x272D;</b>, #9624)
                              [<a href="/Articles/336752/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Hmmmm...  I was thinking more in terms of something like the following:<P>

<code>
preempt_disable();<br>
if (per_cpu_counter > 0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;per_cpu_counter++;<br>
else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do some costly global-lock-and-variable thing<br>
preempt_enable();<br>
</code>

<p>But it has been a good ten years since I messed with this, so I should take another look at it.

<p>In any case, I very much agree with your overall premise that higher-level primitives are a very great improvement over continually re-inventing the wheel, most especially for those wheels with a strong history of being re-invented badly!!!
      
          <div class="CommentReplyButton">
            <form action="/Articles/336752/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor473452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">One use for reference-count biases...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2011 5:30 UTC (Fri)
                               by <b>atiqure</b> (guest, #81951)
                              [<a href="/Articles/473452/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
hii.. i dnt know who r u but i need help... please tell me something about how to develop a kernel without using any source i just want to use programming language like c,c++,java and assembly language can i do that   with these languages ..if yes then please tell me from where to start and how ...pls help it will be christmas gift for me from you ...  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/473452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor336744"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux Kernel Design Patterns - Part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 10:24 UTC (Tue)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/336744/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Your statements seem reasonable but then I read the part about the reference counting in sysfs which I have actually worked with in detail and I stare in disbelief.<br>
<p>
Placing the extra bit of information in s_flags does not work because that breaks the atomic nature of the current test.<br>
<p>
Furthermore you have missed one of the most interesting bits about the reference counting in sysfs.  Holding just about any lock when removing a sysfs file and by extention a kobject or struct device is a fun way to dead lock the kernel without lockdep having a clue.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/336744/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336747"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux Kernel Design Patterns - Part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 12:15 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/336747/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
Hi.
<p>
Thanks for your comments!
<p>
Your "furthermore" observation about locks is probably quite true.  However I cannot see exactly how it is relevant.  I'm not advocating adding any locks in there.
<p>
Your statement that placing the information in s_flags "does not work" is one that I don't agree with.  Seeing I didn't include this among the exercises, I will give the reason here.
<p>
Let us hypothesise a flag SYS_FLAG_ACTIVE which is set at the same time
that s_active is set to 0.  This flag indicates that the entry is 'active'
and it implies a counted reference on the sysfs_dirent.  So instead
of initialising s_active to 0, we initialise it to 1 (which is more in
keeping with the kref pattern anyway).
<p>
In place of the (rather complex) loop in sysfs_get_active, we have the
code
<pre>
  if (test_bit(SYS_FLAG_ACTIVE, &amp;sd->s_flags) 
      &amp;&amp; atomic_inc_not_zero(&amp;sd->s_active))
       return sd;
  else
       return NULL;
</pre>
For me, that is easier to understand.
<p>
sysfs_deactivate then becomes
<pre>
   sd->s_sibling = (void *)&amp;wait;

   clear_bit(SYS_FLAG_ACTIVE, &amp;sd->s_flags);

   if (! atomic_dec_and_test(&amp;sd->s_active))
          wait_for_completion(&amp;wait);

   sd->s_sibling = NULL;
</pre>
Note that clearing the ACTIVE bit requires that we drop the reference
that it implies.  If that was the last reference we don't need to
wait for any completion.
<p>
Finally sysfs_put_active becomes:
<pre>
   if (atomic_dec_and_test(&amp;sd->s_active)) {
         struct completion *cmpl = (void*)sd->s_sibling;
         complete(cmpl);
   }
</pre>
A few moments thought shows that this now allows us to make sysfs_deactivate even
simpler.
<pre>
    sd->s_sibling = (void *)&amp;wait;

    clear_bit(SYS_FLAG_ACTIVE, &amp;sd->s_flags);
    sysfs_put_active(sd);
    wait_for_completion(&amp;wait);
</pre>
This calls "complete" and then "wait_for_completion" in the same
thread, which is a bit unusual, but should work perfectly.
<p>
Providing support for atomic_inc_not_zero were added to kref (which
I have already advocated), this would allow s_active to become
a kref.
<p>
I believe the net result of these changes would be that the code is easier
to understand, and hence harder to break at a later date.  They do not
change the functionality at all.


      
          <div class="CommentReplyButton">
            <form action="/Articles/336747/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor336753"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">kref_get_not_zero()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 14:11 UTC (Tue)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/336753/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Sadly, the kref package does make use of this primitive either.</font><br>
<p>
Heh.  I suggested introducing kref_get_not_zero() (based on atomic_inc_not_zero()) back in January, but got a lot of resistance.  Better luck to the next guy.<br>
<p>
<a href="http://marc.info/?l=linux-scsi&amp;m=123196509202149&amp;w=4">http://marc.info/?l=linux-scsi&amp;m=123196509202149&amp;w=4</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/336753/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">kref_get_not_zero()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 20:42 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/336796/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
Thanks for that reference.
<p>
I cannot comment on the code under the microscope in that thread as I am not familiar with it at all.  However your observation that kref_get_not_zero() can be safe when used under a lock that excludes the object from being freed is one that I completely agree with.  It is therefore tempting to call the function kref_get_locked() to match the inode_get_locked that already exists.
<p>
However it can be valid to use atomic_inc_not_zero() when not holding a lock,
as in the example in a previous thread.  In that case it is safe not because a lock is held, but because a secondary reference is held (s_count).
<p>
Either way, the complete pattern description for kref would need to spell
out how and when to use kref_get_not_zero() (or whatever it gets called).
<p>
I must say that Greg's 'ick' in the reply to your linked post surprised me.
kref_get_not_zero is (in my view) much less 'ick' than kref_set which is part of the current kref API (exercise: find all 3 places that use kref_set and replace them with calls to other parts of the api).
      
          <div class="CommentReplyButton">
            <form action="/Articles/336796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor336756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unfortunate wording</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 14:21 UTC (Tue)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/336756/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <i>Sadly, the kref package does make use of this primitive either.</i> [in section  <b>The "kref" style</b> at the end of paragraph three.]
<p>Please correct this confusing usage.  Is there a missing "not"?
      
          <div class="CommentReplyButton">
            <form action="/Articles/336756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336762"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Unfortunate wording</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2009 14:44 UTC (Tue)
                               by <b>jake</b> (editor, #205)
                              [<a href="/Articles/336762/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Is there a missing "not"?</font><br>
<p>
oops ... fixed now, thanks!<br>
<p>
jake<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/336762/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor336924"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Typo</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2009 20:32 UTC (Wed)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/336924/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <pre>
3      if (atomic_dec_and_lock(&amp;obj->refcnt), &amp;subsystem_lock) {
</pre>

Either we've got variable argument if statements now, or someone put the closing parenthese in the wrong place.

      
          <div class="CommentReplyButton">
            <form action="/Articles/336924/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor336966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It's a comma operator.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2009 0:56 UTC (Thu)
                               by <b>xoddam</b> (guest, #2322)
                              [<a href="/Articles/336966/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is C.  In C, we have many ways of camouflaging incorrect code, including the infamous <a href="http://en.wikipedia.org/wiki/Comma_operator">http://en.wikipedia.org/wiki/Comma_operator</a>.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/336966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor492559"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">It's a comma operator.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2012 23:47 UTC (Sun)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/492559/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Posted Jun 11, 2009 0:56 UTC (Thu) by xoddam notes<br>
"the infamous <a href="http://en.wikipedia.org/wiki/Comma_operator">http://en.wikipedia.org/wiki/Comma_operator</a>".<br>
<p>
Humorously, I just had a look at the Wikipedia article.   "Huh, I thought I understood the comma operator!" Copied the code in question out, compiled and tested it, and sure enough the latest revision to the article was erroneous.    So yeah, I guess the Comma Operator causes some confusion!<br>
<p>
-- Alison<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/492559/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor337077"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux Kernel Design Patterns - Part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2009 14:41 UTC (Thu)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/337077/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&lt;troll&gt;<br>
Ha! Now I know why kernel development is an order of magnitude harder than developing user level applications. This is not just the intrinsic problem of most bugs crashing the whole system. This is also the problem that advanced software engineering concepts like code reuse are only starting to reach these shores!<br>
&lt;/troll&gt;<br>
<p>
Just for fun: <a href="http://lwn.net/Articles/306843/">http://lwn.net/Articles/306843/</a><br>
<p>
Sometimes I dream of a kernel written in a high-level programming language...<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/337077/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor337244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux Kernel Design Patterns - Part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 12, 2009 12:05 UTC (Fri)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/337244/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Sometimes I dream of a kernel written in a high-level programming language...</font><br>
There are many such projects, including Inferno from Bell Labs, Singularity from Microsoft (!) and a whole lot of others.<br>
It's an interesting research area because it completely throws away decades-old CPU memory protection, because typesafe virtual machines guarantee that you can't access anything you don't have a reference to.<br>
<p>
Obviously none of these is usable as a desktop OS though.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/337244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor337248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux Kernel Design Patterns - Part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 12, 2009 12:39 UTC (Fri)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/337248/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Luke Palmer, Dana:<br>
<a href="http://lukepalmer.wordpress.com/2009/06/12/the-role-of-a-core-calculus/">http://lukepalmer.wordpress.com/2009/06/12/the-role-of-a-...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/337248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor914309"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux kernel design patterns - part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2022 7:23 UTC (Thu)
                               by <b>dafnaf</b> (subscriber, #158251)
                              [<a href="/Articles/914309/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
in the 'get' example<br>
<p>
    BUG_ON(atomic_read(&amp;obj-&gt;refcnt)) ; atomic_inc(&amp;obj-&gt;refcnt);<br>
<p>
shouldn't it be BUG_ON(!atomic_read(&amp;obj-&gt;refcnt)) //(bug if refcount is 0)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914309/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914487"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux kernel design patterns - part 1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2022 23:47 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/914487/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; shouldn't it be BUG_ON(!atomic_read(&amp;obj-&gt;refcnt)) //(bug if refcount is 0)</span><br>
<p>
Yes it should.  Thanks for pointing that out.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914487/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914492"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Fixed</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2022 0:13 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/914492/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I've applied the fix, thanks.  The error has only been there for 13 years...


      
          <div class="CommentReplyButton">
            <form action="/Articles/914492/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
