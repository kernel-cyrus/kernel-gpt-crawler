        <!DOCTYPE html>
        <html lang="en">
        <head><title>New APIs for filesystems [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/975444/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/975975/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/975444/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>New APIs for filesystems</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 30, 2024</br>
           <hr>
<a href="/Articles/lsfmmbpf2024/">LSFMM+BPF</a>
</div>
<p>
A discussion of extensions to the <a
href="https://man7.org/linux/man-pages/man2/statx.2.html"><tt>statx()</tt></a>
system call comes up frequently at the <a
href="https://events.linuxfoundation.org/lsfmmbpf/">Linux Storage,
Filesystem, Memory Management, and BPF Summit</a>; this year's edition was
no exception.  Kent Overstreet led the first filesystem-only session at the
summit on querying information about filesystems that have subvolumes and
snapshots. While it was billed as a discussion on <tt>statx()</tt>
additions, it ranged more widely over new APIs needed for modern filesystems.
</p>

<h4>Brainstorming</h4>

<p>
Overstreet began the session with the idea that it would be something of a
brainstorming exercise to come up with additions to the filesystem APIs.
He had some thoughts on new features, but wanted to hear what other
attendees were thinking so that a list of tasks could be gathered. He said 
that he did not plan to do all of
the work on that list himself, but he
would help coordinate it.
</p>

<p>
He has started thinking about per-subvolume disk-accounting for bcachefs,
which led him to the need for a way to iterate over subvolumes.  He
mentioned some previous discussion where Al Viro had an idea for an iterator API that would
return a file descriptor for each open subvolume.  "That was crazy and
cool", Overstreet said; it also fits well with various <a
href="https://man7.org/linux/man-pages/man2/open.2.html"><tt>openat()</tt></a>-style
interfaces.  He thinks there is a simpler approach, however.
</p>

<a href="/Articles/975449/">
<img src="https://static.lwn.net/images/2024/lsfmb-overstreet-sm.png" border=0 hspace=5
align="right" alt="[Kent Overstreet]" title="Kent Overstreet" width=230
height=280> 
</a>

<p>
Adding a flags parameter to <a
href="https://man7.org/linux/man-pages/man3/opendir.3.html"><tt>opendir()</tt></a>
would allow creating a flag for iterating over subvolumes and submounts.  Subvolumes and
mounts have a lot in common, he has noticed recently; user-space developers
would like to have 
ways to work with them, which this would provide.
</p>

<p>
Extended attributes (xattrs) on files are also in need of an iterator
interface of some kind, he said.  Those could smoothly fit into the scheme
he is proposing.  The existing <a
href="https://man7.org/linux/man-pages/man2/getdents64.2.html"><tt>getdents()</tt></a>
interface is "nice and clean", he said, so it could be used for xattrs as well.
</p>

<p>
The <tt>stx_subvol</tt> field has recently been added to <tt>statx()</tt>
for subvolume identifiers.  Another flag for <tt>statx()</tt> will be
needed to identify whether the file is in a snapshot.  That way, coreutils
would be able to, by default, filter out snapshots. That way, when someone is
working through the filesystem, they do not see the same files over and
over again.
</p>

<p>
Steve French asked a "beginner question" about how to list the snapshots for
a given mount in a generic fashion on Linux.  Overstreet said that a
snapshot is a type of subvolume and that "a subvolume is a fancy
directory".  This new <tt>opendir()</tt> interface could be used to iterate over the
subvolumes and the new <tt>statx()</tt> flag could be used to check which
are snapshots.
</p>

<p>
All of the information that <a
href="https://man7.org/linux/man-pages/man2/statfs.2.html"><tt>statfs()</tt></a>
returns for a mounted filesystem
should also be available for subvolumes, he said, 
"continuing with the theme that subvolumes and mount points actually have a
lot in common".  That includes things like disk-space usage and the number
of inodes used.
</p>

<p>
Dave Chinner said that XFS already has a similar interface
based on project IDs, where a directory entry that corresponds to a
particular project can be passed to <tt>statfs()</tt> to retrieve the
information specific to that project.  He said that filesystems could
examine the passed-in directory and decide what to report based on that, so
no new system call would be needed.  Overstreet was skeptical that users
who type <tt>df</tt> in their home directory would expect to only get
information for the subvolume it is in, rather than the whole disk, as they
do now.  He thought a new system call would be the right way to approach it.
</p>

<p>
French said that other operating systems have a way to simply open a
version of a file from a snapshot without actually having to directly work
with the entire snapshot subvolume itself.  A user can simply open a file
from a given snapshot identifier, which is convenient and not really
possible on Linux.  Overstreet acknowledged the problem, but said that he
did not think a new system call was needed to support that use case.  Using
the new interfaces that are being discussed, user space should be able to
handle that functionality, perhaps using read-only mounts of snapshots in such a
way that the user does not directly have to work with them.
</p>

<h4>User-space concerns</h4>

<p>
But Lennart Poettering said: "as a user-space person, I find it a bit
weird" that <tt>opendir()</tt> is seen as a good interface for this
functionality.  In many ways, he finds <tt>opendir()</tt> to be "a terrible
API" because it gives you a filename, but then you have to open the file to
get more information, which does not necessarily match up because there can be
a race between the two operations.  He would much prefer to get a file
descriptor when enumerating things so that the state cannot change between
the two.
</p>

<p>
There are some other mismatches between <tt>opendir()</tt> and subvolumes,
he continued.  Right now, user space expects to get filenames from <a
href="https://man7.org/linux/man-pages/man3/readdir.3.html"><tt>readdir()</tt></a>,
which means they do not contain the slash ("/") character, but subvolume
path names do.  In addition, the filename returned in the
<tt>struct&nbsp;dirent</tt> can only be 255 characters long, which is too
restrictive for subvolume names.
</p>

<p>
In the end, Poettering thinks that user-space programs do not want to get
filenames, they want something that cannot change out from under them.
Jeff Layton suggested using <a href="/Articles/375888/">file handles</a>
instead, which Poettering agreed would be better still.  Christian Brauner
noted that the <a href="/Articles/950569/"><tt>listmount()</tt> system
call</a> uses a new 64-bit mount ID, but there is no way to go from that
mount ID to a file descriptor or handle.  It would be easy to add, however.
</p>

<p>
Overstreet said that he plans to add <a
href="https://one.vg/blog/apple-file-system-firmlink-black-magic">firmlinks</a>,
which is an Apple filesystem (APFS) feature that fits in between hard links and
symbolic links.  It would use a file handle and filesystem universally
unique ID (UUID) to identify a particular file.  Amir Goldstein said that
<a href="https://docs.kernel.org/filesystems/overlayfs.html">overlayfs</a>
also uses those two IDs to identify its files, so Overstreet thought that
perhaps that scheme should become a standard for Linux filesystems.
</p>

<p>
There are some other missing pieces for file handles, though, he
said. There is no system call to go from a file handle to a path.
Goldstein said that the ability exists, but it is only reliable for
directories.  "That's because hard links suck", Overstreet said; Goldstein
agreed that was part of it, but Jan Kara said that there are some
filesystems that cannot provide that mapping.
</p>

<p>
It is getting increasingly difficult to guarantee inode-number uniqueness,
Overstreet said. Most of the discussion about his <a
href="/ml/linux-fsdevel/2uvhm6gweyl7iyyp2xpfryvcu2g3padagaeqcbiavjyiis6prl%40yjm725bizncq/">proposal
for a session at LSFMM+BPF</a> revolved around the problem and its
solutions; it has <a href="/Articles/895444/">come up at earlier
summits</a>, as well.  The basic problem is that more-recent filesystems
(Btrfs, bcachefs) have lots of trouble ensuring that inode numbers are
unique across all of the subvolumes/snapshots in a mounted filesystem,
which confuses tools like <tt>rsync</tt> and <tt>tar</tt>.
</p>

<p>
The 64-bit inode space is simply too small to guarantee uniqueness, he
said, but
there are various schemes that have been used to make things work.  He
would rather not be "kicking cans down the road" and thinks filesystem
developers need to nudge user-space developers to start using file handles for
uniqueness detection "sooner, rather than later". 
</p>

<h4>Inode zero</h4>

<p>
He noted a recent "kerfuffle" regarding <a
href="/ml/linux-kernel/20240126150209.367ff402%40gandalf.local.home/">filesystems
that return all inode numbers as zero values</a>, which broke lots of user-space
tools.  That will become more prevalent over time, so he wondered if it
made sense to add a mount option that would intentionally report the same
inode number in order to shake out those kinds of problems.  Chinner
suggested using a sysctl instead, which Overstreet agreed would be a better choice.
</p>

<p>
Ted Ts'o said that in order to get user space on board with a switch to using file
handles, it is important to make it a cross-OS initiative.  Lots of
maintainers of user-space tools want to ensure that they work on macOS and
the BSDs. If it can get to a point where using file handles is "supported
by more forward-leaning, POSIX-like filesystems", the chances will be much
better for getting
enough of user space converted so that it is possible to return zeroes for
inode numbers without breaking everything.  It will still be a multi-year
effort, which means that it is worth taking the time to try to ensure that
it can be adopted more widely than just on Linux.
</p>

<p>
Overstreet asked about support for file handles in the other operating
systems; Chinner said that anything that supports NFS must have some form
of file-handle support.  Ts'o agreed but said that the others may not
export file-handle information to user space.
</p>

<p>
As part of the conversion process, a list of affected programs should be
created, Ts'o said.  To his "total shock", he found out that the
shared-library loader needs unique inode numbers because that is how it
distinguishes different libraries, which he found out the hard way.
Overstreet wanted to hear that story, but it is a long one that might need
a more casual setting to relate, Ts'o said.
</p>

<p>
This problem will only get worse in, say, 20 years when 64 bits is even
less able to handle the number of inodes, Overstreet said.  If the right
tools are provided to user-space developers, they will help find and fix
all of the problems.  But Poettering cautioned that getting rid of the
reliance on the uniqueness of inode numbers is going to be extremely
difficult.  It is used to ensure that the same resources are not loaded
multiple times, for example, so it would be better to provide user-space
APIs that directly address that problem.
</p>

<p>
There was some discussion of various ways to try to add information to the
inode number to solve that problem, but there is nothing generalized for
all filesystems; it is fair to say there is not any real agreement on how to do
that within the filesystem community.  Ts'o asked Poettering if file
handles, which have more 
bits to work with, would solve his problems.  Poettering said that "file
handles are great", but it requires different privileges to query them and they are not
implemented on all filesystems, so he still needs a fallback. 
</p>

<p>
For example, he wondered about getting file handles for procfs files,
though it was not entirely clear what the answer to that was.  Beyond that,
he asked if there was a limit on the size of a file handle; Overstreet said
it was a string, so there was no limit.  There was some mention of using a
hash on the file handles to create a fixed-length quantity, but the end of
the session was a bit chaotic, with multiple side discussions all going on
at once.
</p>

<p>
Brauner got the last word in, pretty much, when he said that he originally
had been scared of adding an option to return zero for all inode numbers.
But he sees that it makes sense as a tool for educating user space that
inode numbers are not unique.  There is still a need to provide user space
with some kind of API to determine whether two files are actually the same,
but that will have to be worked out later—on the mailing list or perhaps at
a future summit.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-APIs">Filesystems/APIs</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_Memory-Management_and_BPF_Summit-2024">Storage, Filesystem, Memory-Management and BPF Summit/2024</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/975444/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor976051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 13:49 UTC (Thu)
                               by <b>pj</b> (subscriber, #4506)
                              [<a href="/Articles/976051/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there any chance of getting POSIX itself updated to allow the use of filehandles?  It's been learned that using filenames leads to security race conditions, which should be enough of a reason for the standard to change, and changing the standard would likely make it easier to get the BSDs on-board and agreeing to a common API for tools.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976068"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 15:38 UTC (Thu)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/976068/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems POSIX 2024 publication is just underway. Considering it takes up to a decade between revisions, we may have missed that train.<br>
On a related note, is POSIX the place to discuss APIs with other platforms these days?<br>
There's this grammatical phenomenon where people talk about POSIX in the past tense, not so much about what's up and coming from them. Is that just a misconception I have?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976068/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976080"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 17:07 UTC (Thu)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/976080/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We're mostly there w.r.t. fd handles with the introduction of the XXXat() calls.<br>
<p>
There are two missing pieces with race conditions though. One is unlinkat(fd, name, flags). The problem is "name" may be rename-raced for the unlink. One way to fix that would be to add these semantics to unlinkat():<br>
<p>
unlinkat(fd, NULL, flags)<br>
<p>
where fd becomes a handle pointing to the object to unlink. Hard links are the problem here.<br>
<p>
The second is renameat(), which suffers from the same rename-race problem for the source name. A similar solution,<br>
<p>
renameat(fd, NULL, dirfd, newpath)<br>
<p>
where fd becomes a handle pointing to the object to rename works. If we can work out the hardlink problem, this would fortify the API against races considerably.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976080/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976081"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 17:14 UTC (Thu)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/976081/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Never mind. I was mixing up file handles: struct file_handle *handle<br>
with the old familiar integer fd's. I'm not aware of any common userspace code that uses struct file_handle though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976081/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor976387"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2024 14:26 UTC (Sat)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/976387/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;One way to fix that would be to add these semantics to unlinkat():</span><br>
<span class="QuotedText">&gt;&gt;unlinkat(fd, NULL, flags)</span><br>
<span class="QuotedText">&gt;Hard links are the problem here.</span><br>
<p>
If you unlinkat(open("foo.txt",O_RDONLY),NULL,0), sure, that's ambiguous, because the fd refers to the inode, which may have anywhere from *0* to UINT64_MAx hardlinks and you're not saying which of the hardlinks you want gone.<br>
But surely that's what unlinkat(open("foo.txt",O_PATH),NULL,0) is supposed to address.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976387/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976410"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2024 21:04 UTC (Sat)
                               by <b>dezgeg</b> (subscriber, #92243)
                              [<a href="/Articles/976410/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think regardless of O_PATH Linux does track the pathname which was used to open the file - you can see it in /proc/&lt;pid&gt;/fd.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976410/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor976401"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2024 19:04 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/976401/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; where fd becomes a handle pointing to the object to rename works. If we can work out the hardlink problem, this would fortify the API against races</span><br>
<p>
Except surely the whole point of hardlinks is to provide multiple names to one object. The hardlink "problem" simply says to me that nobody has worked out the difference between a name (reference) and an object (inode). What exactly are you trying to do - do you want to delete the *reference* (in which case you have to use the filename), or do you want to delete the *thing* in which case you use the handle.<br>
<p>
So we have two completely different possibilities - "delete by name" which deletes the object if all references to it have disappeared, and "delete the thing" which then has to clean up dangling references. Possibly by "null"ing the object, and fixing the filesystem driver to clean up null'd inode references when it scans a directory. After all, "file close" will autodelete a file with no references.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976401/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor976130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 0:36 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/976130/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As currently envisioned, file handles - an opaque value that allows direct reference to a specific file regardless of location, etc - totally bypass normal path based security conventions, at least when used for open.  I guess if you barred using them for open and made it possible to acquire one off an fd or something?<br>
<p>
The point is unless I’ve missed something they’re not at all suitable for normal use without further refinement.  As of today, open by handle is a privileged operation due to the permission business, but that is the only way to actually use a handle.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor976116"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 20:24 UTC (Thu)
                               by <b>shironeko</b> (subscriber, #159952)
                              [<a href="/Articles/976116/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMO updating the standard should be the last step, after everyone has agreed on something.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976116/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 7:13 UTC (Fri)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/976143/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem is that in practice everybody implements a slight variant of everybody else's idea and then posix standardizes the 15th variant: <a href="https://xkcd.com/927/">https://xkcd.com/927/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor976064"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hierarchical file systems ...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 15:01 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/976064/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Okay, I know Unix doesn't like hierarchies, but that lack can be a major problem (like maybe here :-)<br>
<p>
One of the reasons linux doesn't (as far as I can make out) have decent ACLs is exactly this. Plus it might have copied Windows ...<br>
<p>
But as part of the file identifier, is it possible to include the id of the canonical parent directory. This is categorically NOT defined as always being valid, but inasmuch as the system hasn't engaged in hard-link shenanigans, it should provide a valid canonical path. Creating, moving, and copying files would update this parent-id, but hardlinking wouldn't. So hardlinking then deleting the original parent directory would break the link.<br>
<p>
But provided that parent-id can be queried regardless of snapshots, subvolumes, etc etc, it should be possible to declare two files as the same by following that path.<br>
<p>
And it might result in a decent ACL system :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976064/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976066"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hierarchical file systems ...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 15:15 UTC (Thu)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/976066/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's basically what bcachefs does now internally, for backpointers from inodes to dirents. Unlike xfs we don't store backpointers for every dirent - just one, because the main thing I wanted it for is simplifying fsck and directories don't have hardlinks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976066/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor976095"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 19:23 UTC (Thu)
                               by <b>geofft</b> (subscriber, #59789)
                              [<a href="/Articles/976095/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      How will the proposal to use file handles get over the current restriction in <a href="https://man7.org/linux/man-pages/man2/open_by_handle_at.2.html"><tt>open_by_handle_at</tt>(2)</a> that only privileged users can call it? Right now you're able to have a world-readable file in a non-world-accessible directory and that's enough to make sure other users can't get to it. This is useful in practice to e.g. unpack/rsync/etc. files with arbitrary permissions somewhere in your home directory, when your home directory is mode 700. So there isn't an unprivileged API to work with file handles because that would bypass that protection.
<p>
For the inode problem, I think almost all uses of inode numbers in userspace is to tell if two files are the same. You can imagine userspace APIs to do this specific task that use handles within the kernel. For instance, imagine something kind of like <a href="https://man7.org/linux/man-pages/man2/kcmp.2.html"><tt>kcmp</tt>{2)</a>, with *at-style arguments for filenames (and without the pid arguments):
<pre>    int compare_files_at(int dirfd1, const char *path1, int flags1, int dirfd2, const char *path2. int flags2);</pre>
which would tell you if the files you'd get from <tt>openat(dirfd1, path1, flags1)</tt> and <tt>openat(dirfd2, path2, flags2)</tt> are the same file. Like <tt>kcmp</tt> it would give you some sort order if they weren't equal. This is easy to implement with actual file handles, but if that's hard for a filesystem, it can do something else.
<p>
This API is enough to implement the commonly-supported shell syntax <tt>[ file1 -ef file2 ]</tt>, though in practice I see a lot of shell users writing something like <tt>[ "$(stat -c %i file1 )" -eq "$(stat -c %i file2)" ]</tt> (possibly because <tt>-ef</tt> is non-POSIX... but it's supported in ksh, bash, and dash, and <tt>stat -c</tt> isn't the right syntax on e.g. macOS, so <tt>-ef</tt> would be more portable). So there will need to be some publicity so people start migrating.
<p>
You could also imagine some API where the kernel maintained a set of file handles and told you if a handle was already in it, with some API kind of like epoll:
<pre>
    int fhset_create(int flags);
    int fhset_ctl(int fhset, int op, int dirfd, const char *path, int flags, u64 *userdata);
</pre>
where, if you add a file that you've seen before, you get EEXIST and <tt>userdata</tt> gets set to the value that was previously passed when you added it originally. Then you can have some userspace list of the filename you previously used, or whatever other metadata you find useful. I think this is sufficient for tools like <tt>tar</tt> and <tt>find</tt> and the glibc loader (whose deduping on inodes I have also had the misfortune of running into).
<p>
For <tt>opendir</tt> would it work to return <tt>O_PATH</tt> file descriptors? Now that we have <a href="https://man7.org/linux/man-pages/man2/close_range.2.html"><tt>close_range</tt>(2)</a>, it's less annoying to have to close a pile of file descriptors.



      
          <div class="CommentReplyButton">
            <form action="/Articles/976095/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976305"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 14:01 UTC (Fri)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/976305/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
compare_files() is not the API you want when checking for hardlinks - you can't keep every file you've seen open<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976305/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976309"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 14:23 UTC (Fri)
                               by <b>geofft</b> (subscriber, #59789)
                              [<a href="/Articles/976309/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, hence the rest of my comment :) I think you want both APIs, but if the kernel will only take one, you can implement the former in userspace with the latter.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976309/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor976112"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 20:01 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/976112/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
rr is an example of an application that assumes device/inode number pairs uniquely identify a file. That's how we determine if two file descriptors refer to the same file, and we can also read /proc/.../maps to identify which files are backing VMAs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976112/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor976113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Inodes, Yocto, and Pseudo</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2024 20:06 UTC (Thu)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/976113/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The pseudo utility from Yocto is another example of an application that uses inodes:<br>
<p>
<a href="https://git.yoctoproject.org/pseudo/">https://git.yoctoproject.org/pseudo/</a><br>
<p>
If you delete a file outside of pseudo and then create another file that happens to have the same inode number, pseudo becomes confused:<br>
<p>
<a href="https://wiki.yoctoproject.org/wiki/Pseudo_Abort">https://wiki.yoctoproject.org/wiki/Pseudo_Abort</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor976131"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 0:48 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/976131/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I put this in a thread, but I’m going to pop this up to the top level.<br>
<p>
Kent, today, open by handle is a privileged op because it intrinsically bypasses the directory hierarchy (and the associated permissions).  What are the ideas for dealing with that?  I had one up thread which would be an API for getting an open handle from an fd, so you keep *open by handle* privileged.  Is that the thought or is there something else (or have I missed something and that already exists)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976131/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976304"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 13:59 UTC (Fri)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/976304/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Filesystems with backpointers (XFS, bcachefs) can do the path walk and permissions checks when opening by file handle - we could lift that restriction for them.<br>
<p>
But mostly that's not what we want to expose filehandles for. It's more just for uniquely identifying files for detecting hardlinks and rigorously avoiding TOCTOU races.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976304/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor976388"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2024 14:37 UTC (Sat)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/976388/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Kent, today, open by handle is a privileged op because it intrinsically bypasses the directory hierarchy (and the associated permissions).</span><br>
<p>
As a curiosity: according to what I have read, Microsoft Windows has a privilege called "Bypass Traverse Checking" which is enabled by default, and which when enabled bypasses the directory permission checks, and also allows the use of the Windows equivalent of "open by handle" (OpenFileById). So it's a "privileged operation", but most users there already have the necessary privilege (and disabling it breaks other things, since the same privilege is also used for directory change notification).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976388/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor976145"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 7:42 UTC (Fri)
                               by <b>LtWorf</b> (subscriber, #124958)
                              [<a href="/Articles/976145/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; thinks filesystem developers need to nudge user-space developers to start using file handles for uniqueness detection "sooner, rather than later"</span><br>
<p>
Is this one of these situations where "We do not break userspace, except when we do"?<br>
<p>
In the cache that weborf (my thesis, from a long time ago) generates, inode is part of the key of the cache. Setting all inode numbers to 0, or having collisions for inodes on the same filesystem could certainly cause the server to send wrong content to a client.<br>
<p>
I think a server web is "userspace"… So I'm baffled at how this is even being considered.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976145/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976153"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 10:45 UTC (Fri)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/976153/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, this is one of those situations where kernel developers think about the problems of tomorrow so the "we never want to change anything at all" people don't constantly paint themselves into a corner as the world inevitably changes around them (e.g. by numbers of files or sizes of filesystems increasing and approaching limits of fixed width integer values in the implementation).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976153/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976326"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 16:58 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/976326/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is anyone seriously running a filesystem with 2^64 files on it in production? That seems a bit excessive even by Linux standards.<br>
<p>
Or is this about efficiency? I.e. you don't want to keep a central store of the available inode numbers because it's too slow, so you would rather do something decentralized like a UUID? In that case... I really don't think it is reasonable to break userspace on the basis of efficiency, unless it's in a new (or at least currently-unstable) filesystem, with appropriate "nothing is going to be compatible with this" warnings in the documentation.<br>
<p>
(It is not "breaking userspace" to provide a filesystem that does weird things and isn't compatible with commonly-used software, or else NFS would not be allowed to exist. The sysadmin can decide whether they want to deal with the compatibility issues, and keep using ext4 if they prefer stability.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976326/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976328"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 17:19 UTC (Fri)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/976328/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; It is not "breaking userspace" to provide a filesystem that does weird things and isn't compatible with commonly-used software, or else NFS would not be allowed to exist. </span><br>
<p>
Just feel the need to point out that NFS predates Linux and that commonly-used software.<br>
<p>
...This is another scenario where the "everything is a simple file" abstraction leaks all over one's shoes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976328/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor976331"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 17:45 UTC (Fri)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/976331/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Files in different snapshots will have the same inode number - so we'd have to include the subvolume ID in the reported inode number, and that would take some bits (~20).<br>
<p>
And bcachefs shards inode numbers by CPU id, that takes more bits.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976331/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Subvolumes and inodes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2024 8:42 UTC (Mon)
                               by <b>DemiMarie</b> (subscriber, #164188)
                              [<a href="/Articles/976513/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Could those have different st_dev, though?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor976385"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2024 14:14 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/976385/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, no one has that many - yet.  But supercomputer systems and probably some cloud distributed systems can see it from here - the largest are approach an exabyte of data, which is 10^18 or 2^60.  So you’ve 4 powers of two left on your bytes, and say no one would have an average file size under a kilobyte, and you’ve got another ten powers of 2.  So 14 powers of two.<br>
<p>
That doesn’t make *me* super comfortable over the medium to long term.  Especially if you want to offer file system lifetime uniqueness rather than allow reuse.  Which is why those systems generally already have much larger internal handles (which they tend to expose as file handles if they support those APIs).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976385/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2024 17:29 UTC (Sun)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/976453/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's not about having 2^64 inodes, it's about the efficiency of allocating inside numbers. As Kent said above, btrfs shards by CPU, so that's, say, 2^54 IDs per 2^10 CPUs. Other filesystems assign inode # ranges to allocation groups ... so if you have one large file that occupies an entire AG, that makes the, say, 2^13 inode #s for that AG unassignable.<br>
<p>
There are a lot of tradeoffs in FS development which aren't immediately apparent to people who aren't FS developers. It's what keeps it interesting!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976902"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2024 10:00 UTC (Tue)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/976902/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As soon as you start encoding structure into numbers (i.e., different portions of the number are directly or indirectly controlled by different portions of some external structure) it becomes nearly impossible to realise full efficiency in assigning from that number space.<br>
<p>
Empirical evidence in telephony and networking suggests it is hard to get past a H-Density ratio of 87% (which may correspond to a "direct" utilisation of less than 20% useable-v-total-address-spacec), at least in those contexts. See RFC3194:<br>
<p>
<a href="https://datatracker.ietf.org/doc/html/rfc3194">https://datatracker.ietf.org/doc/html/rfc3194</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976902/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977036"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2024 18:02 UTC (Tue)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/977036/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I definitely think it's both - it's true, yes, that the larger ranges allow distributed allocations by range-slicing.  This might just be starting to appear as a concern for local file systems as the distributed-ness of individual computers swells, but the distributed FS folks have been worrying about this for a long time.  It's standard practice for a head/master node to hand out big lumps of ID space to various child nodes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977036/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor976343"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 19:43 UTC (Fri)
                               by <b>gray_-_wolf</b> (subscriber, #131074)
                              [<a href="/Articles/976343/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Will there be any measurable effect on either RAM or CPU usage in the user space?  My understanding is that e.g. find basically keeps a set of seen inodes.  Assuming that is correct, how will it be affected by switching to set of strings instead of set of int64_t?  That should cost more both in RAM (more to store) and CPU (strcmp costs more than comparing numbers).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976343/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976354"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2024 22:27 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/976354/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think 'find' keeps a list of seen inodes.  It only tracks inode numbers on the path down to the current file, so that it can detect loops.  And that isn't even 'find', that is 'ftw' or similar.<br>
<p>
'tar' keep a list of inode number for every file that has 2 or more links.  Usually that is a small number of files.  If we asked find to keep a full file handle for every linked file, and used it on a directory tree where everything was a hard link (which certainly does happen in practice) then it would cause tar to use more RAM.  File handles might be double the size of dev+inode so it wouldn't be enormously more RAM.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/976354/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor976816"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New APIs for filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2024 19:40 UTC (Mon)
                               by <b>Tobu</b> (subscriber, #24111)
                              [<a href="/Articles/976816/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Re alloc efficiency, is the size of a filehandle fixed for a given mount (mount_id or dev_id)?</p>
<p>Going by the <a href="https://www.man7.org/linux/man-pages/man2/name_to_handle_at.2.html">name_to_handle_at manpage</a> (paragraph starting with “The caller can discover the required size”), it seems to be, but I don't know if it's an actual guarantee.  If it's basically ino_t but slightly expanded so there's bits for snapshots, cpu sharding, layered mounts, and future proofing, it doesn't seem like a big impact, but a symbolic key of variable length feels heavier, for use cases like backups or indexing. Layered mounts do seem to imply you have to add to the largest of the lower mounts' filehandle size.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/976816/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
