        <!DOCTYPE html>
        <html lang="en">
        <head><title>Linux 5.12's very bad, double ungood day [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/848431/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/848236/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/848431/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Linux 5.12's very bad, double ungood day</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 8, 2021</br>
           </div>
The -rc kernels released by Linus Torvalds exist for a reason: after 10,000
or so changes flow into the kernel over a two-week merge window, there will
surely be some bugs in need of squashing.  The -rc kernels provide an
opportunity for wider testing after all those patches have been
integrated.  Most of the time, -rc kernels (even the initial -rc1 releases)
are surprisingly safe to run.  Occasionally, though, something goes wrong,
giving early testers reason to reconsider their life choices.  The 5.12-rc1
kernel, as it turns out, was one of those.
<p>
On January 26, Christoph Hellwig posted <a
href="/ml/linux-block/20210126145247.1964410-1-hch@lst.de/">a 17-patch
series</a> containing cleanups to the code dealing with the allocation of
the BIO structures used to represent block-I/O requests.  The <a
href="/ml/linux-block/20210126145247.1964410-18-hch@lst.de/">final
patch</a> in that series simplified the allocation of requests for swap
files in particular.  The series was <a
href="/ml/linux-block/53e9b2e0-7169-f2fe-3c33-5f8a28cbd01b@kernel.dk/">applied
by block maintainer Jens Axboe</a> one day later.  The change was included
in <a
href="/ml/linux-block/ff4cdd19-1930-bf79-c0fd-f022147095f7@kernel.dk/">this
pull request</a> sent on February&nbsp;17, and <a
href="https://git.kernel.org/linus/48d15436fde6">landed in the mainline</a>
on February&nbsp;21 as part of the massive set of pulls done by Torvalds
once his power was restored.
<p>
"Swapping" is how the kernel pushes anonymous pages (those which are not
backed up by a file on disk — program data, in other words) out to
persistent storage when memory gets tight.  Linux can swap directly to a
partition on a block device; that is how systems are traditionally set up.
But the kernel can also swap to a file within a mounted filesystem with
something close to the same performance.  Swapping to a file gives
administrators some additional flexibility; it is an easy way to give some
relief to a system that is running short of memory without disturbing the
existing workload, for example.
<p>
The problematic patch works just fine for swap activity to a partition.
But, when a swap <i>file</i> is in use, the offset to the location of its
blocks within the filesystem would be lost.  That had the result of
redirecting swap traffic to an essentially random location on the
filesystem — a location that was not intended for swapping and may well
have contained other information that somebody would have preferred to
keep.  In other words, the filesystem containing the swap file would be
corrupted.  (Interestingly, a similar bug was <a
href="https://git.kernel.org/linus/dd6bd0d9c7db">introduced in 2014</a> and
lurked undetected because it only affects extremely rare configurations.)
<p>
On March 2, <a href="https://git.kernel.org/linus/caf6912f3f4a">a fix</a>
was applied to the mainline repository.  
One day later, Torvalds sent <a
href="/ml/linux-kernel/CAHk-=wjnzdLSP3oDxhf9eMTYo7GF-QjaNLBUH1Zk3c4A7X75YA@mail.gmail.com/">a
warning</a> to the linux-kernel mailing list describing the problem and
noting that: "<q>This is what we in the industry call 'double
ungood'</q>".  He removed the 5.12-rc1 tag from his repository (or,
rather, renamed it to "5.12-rc1-dontuse") and generally made it clear that
this release should be avoided.  He also had a couple of requests for
maintainers.
<p>
One had to do with the 5.12-rc1 tag; he can remove it from his repository,
but that does not change anybody else's repository.  So, he said,
maintainers should manually remove that tag themselves just to prevent any
accidental use of that release.
<p>
Beyond that, it is common for subsystem maintainers to base new branches on
an -rc release, even -rc1.  But any such branches pose a particular hazard
for the development and testing community in general, because they will not
contain the fix for this problem.  The <tt>git bisect</tt> tool, which is
frequently used to find the patch that caused a regression, can land
on any location in the development history; branches containing the buggy
commit (but not the fix) create extended ranges of history with the
potential to destroy filesystems far into the future.  This, also, seems
"<q>'double ungood'</q>".
<p>
The answer is to not base development branches on 5.12-rc1, but instead to
use either an older release or to wait until -rc2.  That will not be
entirely helpful for subsystem maintainers who have already published
branches with an -rc1 base, as some certainly have.  They have a choice
between keeping the dangerous branch or rebasing it onto a safer branch
point, possibly creating difficulties for anybody else who has built on
that branch.  That sort of rebasing would normally be frowned upon, but
Torvalds <a
href="/ml/linux-kernel/CAHk-=wgZjJ89jeH72TC3i6N+z9WEY=3ysp8zR9naRUcSqcAvTA@mail.gmail.com/">made
it clear</a> that it is permissible — and expected — this time.
<p>
The kernel community is mostly treating this as a case of "bugs happen" and
moving on.  One can indeed argue that the process has worked the way it is
supposed to: a catastrophic bug was caught early during the stabilization
period and will never make it anywhere near a production system.  That
said, there may be room for a bit of introspection and thinking about how
things could have been done better.
<p>
For example, one might argue that the review process could have worked
better.  The patch in question was only posted once, and was applied to the
block repository the next day.  The patch in the mainline repository
contains two Reviewed-by tags and one Acked-by tag, but the mailing-list thread
shows those tags all being offered for a different patch in the series.
Perhaps all three reviewers offered their tags off-list but, from the
public record, it's not clear how much review the
problematic patch actually received.
<p>
There is no 
guarantee that more eyeballs would have found this bug before it was
committed, but it seems that those eyeballs were not given much of a chance
here.  It is tempting to see "cleanup" patches as being inherently safe and
needing less review, but those patches can contain subtle bugs as well.
<p>
A part of the process that could have worked more quickly was warning the
community as a whole of the problem.  In the message linked above, Torvalds
acknowledged that he should have acted more quickly rather than waiting to
be sure that the proposed fix actually made the problem go away.  One can
only imagine that the warning will go out more quickly the next time.
<p>
There is one other little problem here that surprisingly few people are
talking about.  The health of the mailing-lists hosted on vger.kernel.org
has not been optimal for a while; at times, posts to the mailing lists have
been delayed for a day or two or dropped altogether.  Torvalds's warning
was not delayed that badly, but it still took several hours to get to recipients
of linux-kernel.  Whether the delay in the delivery of that warning caused
more testers to be bitten by this bug is not clear, but it certainly did
not help.
<p>
The good news is that work is currently being done to put the vger lists on
a more solid, well-supported footing.  With luck, the mailing-list problems
will be behind us in the relatively near future.
<p>
Even then, though, a warning sent just to linux-kernel has a real chance of
disappearing into the noise.  The traffic on that list, which routinely
exceeds 1,000 messages per day, can drown out important messages and has
caused many developers to unsubscribe completely.  It may well be that we
need better communication channels for this kind of urgent message.
<p>
In the end, the actual pain caused by this bug was probably relatively
small; there have not been massive numbers of "it ate my filesystem!"
messages going around.  The process did mostly work the way it was intended
to.  With luck, lessons learned from this incident can help that process to
work even better the next time.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-5.12">Releases/5.12</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/848431/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor848713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 17:06 UTC (Mon)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/848713/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      The commit message doesn't say why what is essentially

<pre>-	bio-&gt;bi_iter.bi_sector = map_swap_page(page, &amp;bdev);
+	bio-&gt;bi_iter.bi_sector = swap_page_sector(page);</pre>

would have been the right replacement. I suppose that's where the bug lies?
      
          <div class="CommentReplyButton">
            <form action="/Articles/848713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 17:56 UTC (Mon)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/848717/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <p>The bug is trivially awful (because it's obvious when you see it, but not when you're working on it); for most of the swap code, the swap location for any given page is referenced as an offset from the beginning of the swap file (or device). For a swap partition, this is fine - the offset from the beginning of the device is the correct location in the swap partition, too. For swap files, the correct offset on the device has to account for where on the device the filesystem has placed swap extents.
<p>In the old code, map_swap_page calls map_swap_entry, which accounts for this offset. In the new code, it calls swap_page_sector, which was previously only ever used for swap partitions, and thus didn't account for the filesystem offset. The fix is to change swap_page_sector to account for swap files, and thus to look at the filesystem-provided extent map. That way, the foot gun is removed for everyone.
      
          <div class="CommentReplyButton">
            <form action="/Articles/848717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848721"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 18:10 UTC (Mon)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/848721/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In the old code, map_swap_page calls map_swap_entry, which accounts for this offset. In the new code, it calls swap_page_sector, </font><br>
<p>
And doing that without pointing it out in the commit message is super sloppy.  If you&#x27;re saying that you&#x27;re Just Inlining Code, you&#x27;d better just inline code<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848721/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 8:32 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/848769/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I dream about a compiler flag that would output a &#x27;logical build&#x27; of the code.  It would compile to some kind of bytecode where all symbol names have been stripped and all non-recursive function calls have been inlined.  Then if the commit message says &quot;renamed variable&quot; or &quot;inlined function&quot; or even &quot;use ?: ternary operator instead of if-else&quot;, you could automatically verify that indeed it hasn&#x27;t changed the bytecode output and so has no effect on the meaning of the code.  In other words you can flag commits as pure refactorings and have a machine assistant to verify that, so that human reviewers can concentrate their attention on the patches in the series that change something.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 8:36 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/848770/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
P.S. I know that in general, it is impossible for a computer program to spot all possible cases where two programs have identical behaviour.  I am not suggesting this assistant could have anything like 100% coverage, even for pure refactoring commits.  But if it can tick off 80% of them that would still make a reviewer&#x27;s life easier, and improve my peace of mind as a programmer.  (Did that change from a for-loop to a while-loop affect the behaviour?  Hmm, I&#x27;m not sure... instead of staring at it or working it through with pencil and paper, let&#x27;s see if the bytecode has changed.  If it has changed, the bytecode diff tool will usually point out what I&#x27;ve accidentally altered.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 19:09 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/848871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I tend to imagine you can get 90% of the way there with gcc -S -O0 -finline-functions -findirect-inlining and some combination of the max-inline tuning parameters (whose documentation I&#x27;m finding a little hard to follow). But that won&#x27;t cross translation units because it doesn&#x27;t link. You&#x27;d need some kind of LTO optionally followed by a disassembly step to get the other 10%.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 21:01 UTC (Tue)
                               by <b>error27</b> (subscriber, #8346)
                              [<a href="/Articles/848882/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I use my rename_rev.pl script to review renamed the variable patches.<br>
<p>
<a href="https://github.com/error27/rename_rev">https://github.com/error27/rename_rev</a><br>
<p>
It also has a -r NULL mode to review changes like &quot;if (foo != NULL) {&quot; --&gt; &quot;if (foo) {&quot; because sometimes people get those transitions inverted.  A bunch of little tricks like that.<br>
<p>
I sometimes think like you do about ways to do something similar at the bytecode level or with static analysis but I can&#x27;t think how that would work...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848915"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 7:23 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/848915/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another approach is when you use an automated tool to make the change in the first place.  I mostly develop in C# and I use the proprietary tool Resharper to rename variables, inline methods, convert for-loops to foreach-loops, and a few more exotic transformations like &quot;extract method&quot; (take a chunk of code and move it to its own method, passing in and out the variables it uses).  In this case the commit message could include full details of the transformation you applied, in machine-readable format.  Then to verify the patch series you run the same transformation and check the output code is the same.  (That would be an additional verification step; it checks you just ran the &quot;convert for to foreach&quot; automated refactoring and didn&#x27;t accidentally introduce other changes, but it doesn&#x27;t check that the refactoring tool itself is correct.  So some kind of bytecode check would also be useful.)<br>
<p>
Such a machine-readable record of the refactoring change would also be handy when rebasing.  Instead of hitting a merge conflict on the &#x27;renamed variable&#x27; commit, you could reapply that change using the refactoring tool.  As long as both the old commit and the new one are pure refactorings (logical bytecode doesn&#x27;t change), this can be done automatically as part of the rebase process, leaving the human programmer to concentrate on the conflicts that aren&#x27;t trivial.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848915/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 8:10 UTC (Wed)
                               by <b>error27</b> (subscriber, #8346)
                              [<a href="/Articles/848917/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah.  If you make your patch with Coccinelle then we normally encourage you to post the script (unless it&#x27;s one of the ones that ship with the kernel).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849939"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 20, 2021 23:50 UTC (Sat)
                               by <b>Hi-Angel</b> (guest, #110915)
                              [<a href="/Articles/849939/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For C these days part of such refactoring could be done with LSP-servers, like clangd for example. Thankfully, all actively developed editors and IDEs support LSP servers, whether natively or through a plugin.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849939/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849943"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2021 5:34 UTC (Sun)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/849943/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While GNU ed is actively developed, it seems unlikely it will ever support LSP :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849943/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor848715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 17:12 UTC (Mon)
                               by <b>PaulMcKenney</b> (<b>&#x272D; supporter &#x272D;</b>, #9624)
                              [<a href="/Articles/848715/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you for this!  You see, rcutorture does not use swap, so I was blissfully ignorant of this problem.  I see another rebase in the -rcu tree&#x27;s future.  ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 17:25 UTC (Mon)
                               by <b>brice</b> (subscriber, #35493)
                              [<a href="/Articles/848716/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh man. This reminds me of when I ran a benchmark on newly installed SSDs in a production colo box by punching holes on the raw block device instead of executing something that was filesystem aware. A couple days later the database was corrupted. And for some reason I was convinced it was a LSI raid firmware issue....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor848714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 17:30 UTC (Mon)
                               by <b>syrjala</b> (subscriber, #47399)
                              [<a href="/Articles/848714/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve not seen a definite statement on whether the patch was tested at all by the author. I don&#x27;t think it&#x27;s unreasonable to expect changes to swapfile.c to be tested using a swapfile? &quot;I was too busy/lazy to run any tests whatsoever&quot; is not a valid excuse IMO.<br>
<p>
An excuse I would accept is that appropriate tests were run but they simply did not catch the problem. In which case I would expect to see improvements to the tests (+ making sure someone is actually running them in their CI system) to make sure this same bug doesn&#x27;t happen ever again.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 19:28 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/848724/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, the state of patch status visibility on mailing lists is…low. Long mail delivery time doesn&#x27;t help the issue. I&#x27;m fine with mailing lists as a development nexus, but there needs to be some infrastructure around them to indicate the status of the patches as superceded, reviewed, rejected, queued, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848734"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 20:34 UTC (Mon)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/848734/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s what <a href="https://patchwork.kernel.org/">https://patchwork.kernel.org/</a> appears to already address.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848734/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848744"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 21:56 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/848744/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, it *tries*. Look at this pull request:<br>
<p>
<a href="https://patchwork.kernel.org/project/keyrings/patch/1323922.1612970030@warthog.procyon.org.uk/">https://patchwork.kernel.org/project/keyrings/patch/13239...</a><br>
<p>
Its state is &quot;New&quot;, but it has been dropped by the submitter. How would one change the state from &quot;New&quot; to &quot;Dropped&quot;?<br>
<p>
This one is tracked as &quot;New&quot;, but has been merged (as noted by the pr-tracker-bot). How did Patchtracker miss this?<br>
<p>
<a href="https://patchwork.kernel.org/project/keyrings/patch/1322896.1612969174@warthog.procyon.org.uk/">https://patchwork.kernel.org/project/keyrings/patch/13228...</a><br>
<p>
And this is for pull requests.<br>
<p>
This one is &quot;New&quot;, but has a &quot;Reviewed-by&quot; someone who can collect it for the subsystem. Where is it on its way into the appropriate tree(s)?<br>
<p>
<a href="https://patchwork.kernel.org/project/keyrings/patch/20210204033208.1389901-1-eric.snowberg@oracle.com/">https://patchwork.kernel.org/project/keyrings/patch/20210...</a><br>
<p>
And that&#x27;s just the one list I follow loosely. How can one trust this site for actual tracking of arbitrary kernel patches with this quality of tracking? Sure, this list might not *use* patchtracker as much as other lists, but how does one determine *that* bit of information?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848744/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 16:12 UTC (Tue)
                               by <b>andy_shev</b> (subscriber, #75870)
                              [<a href="/Articles/848841/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Unfortunately patchwork is disconnected from the target repository. That&#x27;s why Gerrit is better, for example.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848876"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 20:29 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/848876/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Unfortunately patchwork is disconnected from the target repository. That&#x27;s why Gerrit is better, for example.</font><br>
<p>
patchwork tries to find code submissions not addressed to it directly. All other code review solutions require everything to be sent to them directly, they act as gateways. That&#x27;s the very simple reason why they have all the information and all work better.<br>
<p>
The icing on the cake is of course recipient-controlled email notifications instead of sender-control notifications (a.k.a... &quot;spam&quot;). In other words people routinely subscribe and unsubscribe to/from individual code reviews; not possible with a crude mailing list.<br>
<p>
None of this is rocket science, it&#x27;s all very easy to see and understand except when obsessing about the &quot;email versus web&quot; user interface questions; these debates are not &quot;wrong&quot; but they hide the much more important backend and database design issues.<br>
<p>
You could totally have a gateway type code review tool entirely driven by email. In fact requesting all submissions, review comments and approvals or rejections to be sent (by email) to patchwork directly and putting patchwork in better control of the git repo would get at least half-way there.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848876/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2021 16:04 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/849110/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another instance I saw today was that a version of the patch that went in was never on the list (a whitespace fix). While such a tiny change is probably OK in practice, I vastly prefer having a bot attached to the service that stashes away every version of the patchset for posterity.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor848729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 20:19 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/848729/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I don&#x27;t think it&#x27;s unreasonable to expect changes to swapfile.c to be tested using a swapfile?</font><br>
<p>
Even though it&#x27;s called &quot;swapfile.c&quot;, that file has the code for both swap files and swap partitions, including things like the swapon and swapoff system calls. Surprisingly little of that code is specific to either swap files only or swap partitions only, nearly all of it being in the setup and teardown of the swap areas (setting the block size on swapon for partitions, reading the swap extents from the filesystem on swapon for regular files). Search that file for S_ISBLK and S_ISREG to see the few places where the code diverges.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848750"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 23:17 UTC (Mon)
                               by <b>tome</b> (subscriber, #3171)
                              [<a href="/Articles/848750/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; An excuse I would accept is that appropriate tests were run but they simply did not catch the problem. In which case I would expect to see improvements to the tests</font><br>
<p>
Indeed this bug could pass tests on a swap file accidentally by just clobbering unused locations .  If so those tests need more fuzz.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848750/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 8:21 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/848767/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the test does not verify that the data is written to the correct location in the swapfile, the test will probably pass. The data can be read back fine. Even if you hit some used location this will manifest as random filesystem corruption. You only notice this if you verify the filesystem afterwards, but why should a test of the swapping code verify the correctness of a totally unrelated filesystem?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 8:44 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/848771/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Tests may pass, but some time later the machine will behave erratically which will raise suspicion. Pretty much what happened but too far away from the origin of the patch and too late.<br>
<p>
So back to the original question: which &quot;swaptorture&quot; test suite was used to validate this patch and did that test suite include configuration(s) with swap file(s)? The main article wonders &quot;how things could have been done better&quot; and asks some interesting code review questions but does not seem to mention anything like &quot;test gap&quot;.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor848844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 16:43 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/848844/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Here&#x27;s an idea:<br>
<p>
  - initialize a swapfile<br>
  - do things with it<br>
  - copy it to a new, fresh FS<br>
  - restore from it<br>
<p>
That at least gets the &quot;everything was written to the swapfile&quot; (rather than willy-nilly across the hosting FS). Doesn&#x27;t guarantee that *extra* writes didn&#x27;t go out. Some form of writing a given bitpattern to the entire FS and then ensuring that post-FS init and swap file creation, nothing else changes (modulo mtime/inode updates) might suffice? I have no idea if such a &quot;simple&quot; FS exists though. Or create a single file which takes up the remaining FS space with a given bitpattern reads properly after using the swapfile. Wrecking any data or metadata would presumably be detectable then, no?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848897"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 1:47 UTC (Wed)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/848897/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is (hypothetically) a test. It doesn&#x27;t need to be a reasonable FS in the first place. Tell the swapfile code that the file begins at such-and-such offset and occupies such-and-such size, and fill the rest of the image with 0xDEADBEEF or whatever sentinel value you like. I&#x27;m sure they could make an extremely stupid filesystem that works that way internally (and just returns EROFS or whatever if the user tries to create files or do other things it doesn&#x27;t like), so you don&#x27;t even need to properly mock out any of the FS code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848897/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor848725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 19:28 UTC (Mon)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/848725/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would consider this situation to demonstrate a problem with git.  Sure, maintainers should avoid publishing known-bad trees / commits, but git bisect should be able to avoid generating known-bad states for testing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848730"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 20:13 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/848730/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;d have a way to add a commit range to something like a `bisect.avoidIfPossible` configuration. It would just treat any commit in there as `skip` by default and would delve in only on explicit requirements (maybe each range could even have an explanation for the exclusion so I can know whether it applies to my situation). However…<br>
<p>
Git just generally has a problem with shipping configuration values around. I can&#x27;t make bullet-proof commands for others to use because I don&#x27;t even know what remote names are in use. I vastly prefer `origin` for the main repo and `$prefix/$username` for any forks (including mine and the prefix depends on the hosting service). Others prefer `origin` for their fork and `upstream` for the main repository. Useful aliases, hooks, etc. all have non-existent ways of being distributed in git today. We have a script that developers should run to at least match the docs, but that&#x27;s not generally used.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848730/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848733"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 20:28 UTC (Mon)
                               by <b>pebolle</b> (guest, #35204)
                              [<a href="/Articles/848733/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What I wonder is why v5.12-rc2 wasn&#x27;t done like this:<br>
- restart at v5.11;<br>
- add everything in v5.12-rc1-dontuse except the misguided commit;<br>
- add the misguided commit and it&#x27;s fix squashed as a single commit;<br>
- add everything else that is now in v5.12-rc2 but not in v5.12-rc1-dontuse.<br>
<p>
That should make v5.12-rc1-dontuse a dead end which no-one would ever hit while bisecting. (And v5.12-rc2 basically a second try at a v5.12-rc1.) Or doesn&#x27;t git work like that?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848733/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848737"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 21:13 UTC (Mon)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/848737/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That could absolutely be done. It&#x27;d mean that the repository would have a non-fast-forwarding change, which would be disruptive. It&#x27;d also set a precedent that non-fast-forwarding changes are an option for a serious enough bug, which might be undesirable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848737/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 21:16 UTC (Mon)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/848738/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Following your approach would rebase the master branch of <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a>, which is something Linus does not want to do ever.  This would affect any tree that has pulled from this branch after the bad commit was merged into his tree.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848772"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 8:46 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/848772/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This would affect any tree that has pulled from this branch after the bad commit was merged into his tree.</font><br>
<p>
That&#x27;s the goal.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848772/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848774"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 10:21 UTC (Tue)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/848774/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><font class="QuotedText">Following your approach would rebase the master branch [...], which is something Linus does not want to do ever.</font></blockquote>

<p>But, in this particular case, he's making an exception.  From our editor's article (emphasis mine):</p>

<blockquote><font class="QuotedText">That sort of rebasing would normally be frowned upon, but Torvalds <a href="https://lwn.net/ml/linux-kernel/CAHk-=wgZjJ89jeH72TC3i6N+z9WEY=3ysp8zR9naRUcSqcAvTA@mail.gmail.com/">made it clear</a> that it is permissible &mdash; and expected &mdash; <em>this time</em>.</font></blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/848774/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848777"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 10:44 UTC (Tue)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/848777/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The discussion was about rebasing Linus Torvalds&#x27; master branch, not about rebasing maintainers&#x27; branches for submitting pull requests.<br>
If Linus had been comfortable about rebasing his own master branch, he would have done so for sure.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848777/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor848723"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 19:30 UTC (Mon)
                               by <b>amarao</b> (subscriber, #87073)
                              [<a href="/Articles/848723/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I never worked on kernel CI, but for our in-house needs there is a rule of red-green bugfixing. When you have same nastiness happened, you search for root cause, commit a red test to reproduce it, and fix it to make test green. That more or less protects against repeating the same type of mistake/misunderstanding, and has amazingly high &#x27;catch ratio&#x27;. These &#x27;red-green&#x27; derived tests usually raise alarm more often than synthetic inventions of QA or developers.<br>
 Basically, in this story I can&#x27;t see the finale: rather trivial test to see that filesystem with swap file is not corrupted after swap in / out in a pagefile on it.<br>
<p>
Even without kernel instrumentation it would take about hour or two to develop.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848723/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848742"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 21:20 UTC (Mon)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/848742/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes. I was a little sad to see that &quot;add some automated tests that would have caught this&quot; (that run before every RC release, if not every commit) was not one of the &quot;thinking about how things could have been done better&quot; items in this article.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848742/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848743"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 21:42 UTC (Mon)
                               by <b>airlied</b> (subscriber, #9104)
                              [<a href="/Articles/848743/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
automated tests did catch it. It took out the Intel graphics CI system for a few days while they root caused it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848743/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848751"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 23:18 UTC (Mon)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/848751/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Something is definitely wrong if automated tests caught it and it was still released as rc1 and people still based work on top of it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848751/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848763"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 4:26 UTC (Tue)
                               by <b>airlied</b> (subscriber, #9104)
                              [<a href="/Articles/848763/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the intel graphics CI only gets it hands on things at rc1, there is usually a bunch of minor regressions, and sometimes a major one.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848763/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 12:01 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/848784/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well then, like I said above: tests need to be run before the RC releases. This is testing 101 stuff that is table stakes for most projects today.<br>
<p>
I am constantly frustrated by the kernel testing culture, or lack of it. rr has approximately zero resources behind it and our automated tests are still responsible for detecting an average of about one kernel regression every release.<br>
<p>
Every time I bring this up people have a string of excuses, like how it&#x27;s hard to test drivers etc. Some of those are fair, but the bug in this article and pretty much all the regressions found by rr aren&#x27;t in drivers, they&#x27;re in core kernel code that can easily be tested, even from user space.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 13:27 UTC (Tue)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/848786/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Well then, like I said above: tests need to be run before the RC releases.</font><br>
<p>
Okay, so... when exactly?<br>
<p>
There are 10K commits (give or take a couple thousand) that land in every -rc1.  Indeed, until -rc1 lands, nobody can really be sure if a given pull request (or even a specific patch) will get accepted.  This is why nearly all upstream tooling treats &quot;-rc1&quot; as the &quot;time to start looking for regressions&quot; inflection point [1], and they spend the next *two months* fixing whatever comes up.  This has been the established process for over a decade now.<br>
<p>
So what if there was a (nasty) bug that takes down a test rig?  That&#x27;s what the test rigs are for!  The only thing unusual about this bug is that it leads to silent corruption, to the point where &quot;testing&quot; in of itself wasn&#x27;t enough; the test would have had to been robust enough to ensure nothing unexpected was written anywhere to the disk.  That&#x27;s a deceptively hairy testing scenario, arguably going well beyond the tests folks developing filesystems run.<br>
<p>
Note I&#x27;m not making excuses here; it is a nasty bug and clearly the tests that its developers ran was insufficient.  But it is ridiculous to expect &quot;release-quality&quot; regression testing to be completed at the start of the designated testing period.<br>
<p>
[1] Indeed, many regressions are due to the combinations of unrelated changes in a given -rc1; each of those 10K patches in of themselves is fine, but (eg) patch #3313 could lead to data loss, but only in combination of a specific kernel option being enabled, and run on a system containing an old 3Ware RAID controller and a specific motherboard with a PCI-X bridge that can&#x27;t pass through MSI interrupts due to how it was physically wired up. [2] [3]<br>
<p>
[2] It&#x27;s sitting about four feet away from me as I type this.  <br>
<p>
[3] Kernel bugzilla #43074<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848788"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 14:11 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/848788/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess if the test setup uses a checksummed filesystem then you verify the filesystem after the tests have completed and if it&#x27;s corrupted, that&#x27;s a failure.  If the filesystem doesn&#x27;t have per-file checksums, you can at least do the usual fsck stuff to check metadata.  (For testing it would be handy to have a filesystem mode that always zeroes out unused pages, so that a thorough fsck can later check that all unused pages are zero.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848788/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848792"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 15:12 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/848792/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus can issue a pre-RC (alpha1?) to give time to run the tests, a day before the actual RC.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848792/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 15:22 UTC (Tue)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/848793/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s why we linux-next, which is used for lots of automated integration tests<br>
<p>
$ git tag --contains 48d15436fde6<br>
next-20210128<br>
next-20210129<br>
next-20210201<br>
next-20210202<br>
next-20210203<br>
next-20210204<br>
next-20210205<br>
next-20210208<br>
next-20210209<br>
next-20210210<br>
next-20210211<br>
next-20210212<br>
next-20210215<br>
next-20210216<br>
next-20210217<br>
next-20210218<br>
next-20210219<br>
next-20210222<br>
next-20210223<br>
next-20210224<br>
next-20210225<br>
next-20210226<br>
next-20210301<br>
next-20210302<br>
next-20210303<br>
next-20210304<br>
next-20210305<br>
next-20210309<br>
v5.12-rc1<br>
v5.12-rc1-dontuse<br>
v5.12-rc2<br>
<p>
Three weeks passed between the buggy commit entering linux-next and upstream.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848795"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 15:35 UTC (Tue)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/848795/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; That&#x27;s why we linux-next, which is used for lots of automated integration tests</font><br>
<font class="QuotedText">&gt; Three weeks passed between the buggy commit entering linux-next and upstream.</font><br>
<p>
So the &quot;problem&quot; here isn&#x27;t that nothing was being tested, it&#x27;s just that none of the tests run during this interval window caught this particular issue.  It&#x27;s also not clear that there was even a test out there that could have caught this, except by pure happenstance.<br>
<p>
But that&#x27;s the reality of software work; a bug turns up, write a test to catch it (and hopefully others of the same class), add it to the test suite (which runs as often as your available resources allow) .... and repeat endlessly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848795/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor848794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 15:25 UTC (Tue)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/848794/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
... okay, so rename &quot;rc1&quot; to &quot;alpha1&quot; , &quot;rc2&quot; to &quot;alpha2&quot; and so forth.   Problem solved?<br>
<p>
Not that it will stop folks complaining when &quot;5.32-alpha0-rc4-pre3&quot; fails to boot on their production system, obviously because it should have been tested first, and we need a pre-pre-pre-pre-pre release snapshot to start testing against.<br>
<p>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 15:26 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/848796/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Kinda. You&#x27;ll have alphaN that is released before rcN, and the distinction is that alphaN is meant only for automatic testing on throwaway hardware.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 17:47 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/848848/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And how many people will ignore that (or be unaware) and load alphaN on their production server anyway?<br>
<p>
Horse to water and all that ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848875"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 19:55 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/848875/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Crazy idea: require kernel.testing.alpha=5.20.0-alpha1 on the cmdline to boot such an alpha kernel. Reject such an option in non-alpha kernels (including development kernels; the tagged release would require this code and not otherwise).<br>
<p>
But this kind of one-off code is annoying to test itself and someone will script adding it to their boot command lines anyways.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848875/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 21:58 UTC (Wed)
                               by <b>sjj</b> (guest, #2020)
                              [<a href="/Articles/849018/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How many people run non-distro kernels these days, especially in production? If you do that with an rc kernel, you certainly deserve whatever pieces are left of your data.<br>
<p>
I don’t think I’ve built a kernel in 10 years, or maybe that one time 7-8 years ago.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849026"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 22:22 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/849026/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the past, when reporting a bug in a release kernel, people have asked me to install some random kernel revision to see if the bug is still present with it. If we should never do that, people should stop asking for it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849026/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2021 8:43 UTC (Thu)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/849052/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You weren&#x27;t supposed to do that in production though. Also, answering &quot;sorry I can&#x27;t&quot; is perfectly valid. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849028"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 23:20 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/849028/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I don’t think I’ve built a kernel in 10 years, or maybe that one time 7-8 years ago.</font><br>
<p>
You clearly don&#x27;t run gentoo :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849028/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor855107"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 2, 2021 2:58 UTC (Sun)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/855107/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Not that it will stop folks complaining when &quot;5.32-alpha0-rc4-pre3&quot; fails to boot on their production system, obviously because it should have been tested first, and we need a pre-pre-pre-pre-pre release snapshot to start testing against.</font><br>
<p>
I saw this scroll by when I upgraded this system to Fedora 34:<br>
<p>
$ rpm -q icedtea-web<br>
icedtea-web-2.0.0-pre.0.3.alpha16.patched1.fc34.3.x86_64<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/855107/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor848889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 22:44 UTC (Tue)
                               by <b>dbnichol</b> (subscriber, #39622)
                              [<a href="/Articles/848889/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not test linus master HEAD prior to tagging? It&#x27;s not like he pulls all the requests and tags the release in one giant push. Testing a tagged release makes sense as that&#x27;s what people are going to use, but a CI system could test HEAD constantly. I think that&#x27;s what basically every other project does - test what&#x27;s on the branch before you tag it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 2:43 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/848906/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Many projects run tests on every PR before merging. It&#x27;s difficult to get this to scale, but not impossible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor848904"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 2:34 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/848904/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Projects that are serious about testing run all their automated tests as often as they can. The sooner you detect a regression the easier it is to bisect, debug, and fix, with less impact on other developers and users.<br>
<p>
In practice, large projects often try to maximise bang-for-the-buck by dividing tests into tiers, e.g. tier 1 tests run on every push, tier 2 every day, maybe a tier 3 that runs less often. Many projects use heuristics or machine learning to choose which tests to run in each run of tier 1.<br>
<p>
Yes, I understand that it&#x27;s difficult to thoroughly test weird hardware and configuration combinations. Ideally organizations that produce hardware with Linux support would contribute testing on that hardware. But even if we ignore all those bugs, there are still lots of core kernel bugs not being caught by kernel CI.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848904/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor848754"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2021 23:33 UTC (Mon)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/848754/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Phoronix also hit it pretty early:<br>
<a href="https://phoronix.com/scan.php?page=news_item&amp;px=Linux-5.12-Early-Buggy-Issue">https://phoronix.com/scan.php?page=news_item&amp;px=Linux...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848754/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor848790"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 14:29 UTC (Tue)
                               by <b>daenzer</b> (subscriber, #7050)
                              [<a href="/Articles/848790/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Like other commenters, I was a bit disappointed that the (otherwise excellent as usual) article doesn&#x27;t discuss the possibility of automated tests catching buggy changes like this before they are merged anywhere. The kernel is behind current best practices there.<br>
<p>
E.g. it shouldn&#x27;t be hard to hook up tests to a GitLab CI pipeline which can catch this bug (and more), and only allow merging changes which pass the tests.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848790/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 14:54 UTC (Tue)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/848791/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There&#x27;s already CKI, KernelCI and more. However testing kernels is not that easy. For example for obvious reasons you cannot install a kernel from a bog standard gitlab pipeline.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 16:12 UTC (Tue)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/848840/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could run user-mode-linux, or possibly kvm if the platform has nested VMs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 17:32 UTC (Tue)
                               by <b>daenzer</b> (subscriber, #7050)
                              [<a href="/Articles/848845/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, user-mode-linux should have sufficed in this case.<br>
<p>
And there are CI pipelines on <a href="https://gitlab.freedesktop.org/">https://gitlab.freedesktop.org/</a> running VMs via KVM, which should allow booting kernels built as part of the pipeline as well. (Another possibility is having dedicated test machines which can be powered on/off remotely; Mesa is using a number of those for testing GPU drivers)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor848884"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux 5.12's very bad, double ungood day</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 21:11 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/848884/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I was a bit disappointed that the (otherwise excellent as usual) article doesn&#x27;t discuss the possibility of automated tests catching buggy changes like this before they are merged anywhere. The kernel is behind current best practices there.</font><br>
<p>
I think the gap in the article hides a much more worrying gap. There&#x27;s a long and interesting discussion in the middle of the comments about test setups and workflows with not a single link to .... test code. Is there any?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848884/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848886"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Automated tests</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2021 21:33 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/848886/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      One could certainly write an automated test to catch this, but it would not be easy.  You'd need to set up a machine with a swap file, drive it into memory pressure with a lot of dirty anonymous pages, then somehow verify that none of the swap traffic went astray.  That means comparing the entire block device (including free space) with what you expect it to be, or mapping out the swap file, picking the swap traffic out of a blktrace stream, and ensuring that each page goes to the right place.
<p>
Certainly doable, but this would not be a fast-running test.
      
          <div class="CommentReplyButton">
            <form action="/Articles/848886/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor848907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Automated tests</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 2:49 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/848907/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could make it run pretty fast by having the test generate a virtual machine image that is just big enough, i.e. a minimal amount of memory and a minimal-sized block device. Lots of tests could potentially benefit from this.<br>
<p>
You&#x27;d have to write block device verification code to check the free space and the contents of all files, but that code could be useful for detecting all kinds of bugs.<br>
<p>
One thing about automated testing is that once you bite the bullet and start creating infrastructure for things that look hard to test, you make it easier to test all kinds of things and people are much more willing to write tests for all kinds of things as part of their normal development. So the sooner you create such infrastructure, the better.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor848908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Automated tests</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 2:52 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/848908/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One could certainly write an automated test to catch this, but it would not be easy. </font><br>
I was one of people responsible for getting EC2 instances to hibernate. We used files for hibernation and actually found that the kernel had been broken for YEARS with file hibernation (it required a reboot for the hibernation target setting to take effect).<br>
<p>
We also had a test for this very issue. It created an EC2 instance with a small disk (~2Gb) and limited RAM (512Mb). The test program created a swap file and then filled the disk to capacity with pseudo-random numbers (by creating a file and writing to it). It then allocated enough pseudo-random data to swap out at least some of it. <br>
<p>
Then hibernate, thaw, and checksum the disk and the data in RAM to check for corruption.<br>
<p>
The tests ran in about 2 minutes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Automated tests</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 22:12 UTC (Wed)
                               by <b>sjj</b> (guest, #2020)
                              [<a href="/Articles/849019/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting, I never thought about hibernation in AWS. I haven’t thought about hibernation in years, since it was the unreliable thing you had to do on laptops of the day.<br>
<p>
Curious what the use case for it in AWS is. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849023"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Hibernation</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 22:18 UTC (Wed)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/849023/">Link</a>] 
      </p>
      
      </div>
      </summary>
      That work, and the use case behind it, were discussed in <a href="https://lwn.net/Articles/821158/">this OSPM article</a> from last May.
      
          <div class="CommentReplyButton">
            <form action="/Articles/849023/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor848914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Automated tests</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2021 6:42 UTC (Wed)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/848914/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You&#x27;d need to set up a machine with a swap file, </font><br>
<p>
As this is an apparently common configuration, you&#x27;d expect anyone modifying swap code to grant that configuration some reasonable amount of test time.<br>
<p>
<font class="QuotedText">&gt; drive it into memory pressure with a lot of dirty anonymous pages,</font><br>
<p>
Also called &quot;swapping&quot;?<br>
<p>
<font class="QuotedText">&gt; then somehow verify that none of the swap traffic went astray.</font><br>
<p>
Unless you&#x27;re re-installing your entire system every few tests, there&#x27;s a good chance you will soon notice something somewhere has gone terribly wrong even when not verifying every byte on the disk. This is apparently how the bug was found and relatively quickly by people not even testing swap but other things. The perfect that does not get done is the enemy of the good that does and this is especially true with chronically underdeveloped validation.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/848914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849137"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Automated tests</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2021 19:56 UTC (Thu)
                               by <b>thumperward</b> (guest, #34368)
                              [<a href="/Articles/849137/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For an integration test that would specifically have caught this issue, sure. But given the assumption that swap_page_sector() could be called on a swap file, a unit test that called swap_page_sector() on a swap file with a given input and verify that the file contained the right bytes in the right order afterwards is something that could well have existed and caught said bug before the refectoring inadvertently exposed it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849137/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
