        <!DOCTYPE html>
        <html lang="en">
        <head><title>LCA: Why filesystems are hard [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/370419/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/369883/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/370419/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>LCA: Why filesystems are hard</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 20, 2010</br>
           </div>
The ext4 filesystem is reaching the culmination of a long development
process.  It has been marked as stable in the mainline kernel for over a
year, distributions are installing it by default, and it may start to see
more widespread enterprise-level deployment toward the end of this year.
At linux.conf.au 2010, ext4 hacker Ted Ts'o talked about the process of
stabilizing ext4 and why filesystems take a long time to become ready for
production use.
<p>
In general, Ted says, people tend to be overly optimistic about how quickly
a filesystem can stabilize.  It is not a fast process, for a number of
fairly clear reasons.  In general, there are some aspects of software which
can make it hard to test and debug.  These include premature optimization
("the root of all evil"), the presence of large amounts of internal state,
and an environment involving a lot of parallelism.  Any of these features
will make code more difficult to understand and complicate the testing
environment.
<p>
Filesystems suffer from all of these problems.  Users demand that a
general-purpose filesystem be heavily optimized for a wide variety of
workloads; this optimization work must be done at all levels of the code.
The entire job of a filesystem is to store and manage internal state.
Among other things, that makes it hard for developers to reproduce
problems; specific bugs are quite likely to be associated with the state of
a specific filesystem which a user may be unwilling to share even in the
absence of the practical difficulties implicit in making hundreds of
gigabytes of data available to developers.  And parallelism is a core part of the
environment for any general-purpose filesystem; there will always be many
things going on at once.  All of these factors combine to make filesystems
difficult to stabilize.
<p>
What it comes down to, Ted says, is that filesystems, like fine wines, have
to age for a fair period of time before they are ready.  But there's an
associated problem: the workload-dependent nature of many filesystem
problems guarantees that filesystem developers cannot, by themselves, find
all of the bugs in their code.  There will always be a need for users to
test the code and report their experiences.  So filesystem developers have
a strong incentive to encourage users to use the code, but the more ethical
developers (at least) do not want to cause users to lose data.  It's a fine
line which can be hard to manage.
<p>
So what does it take to get a filesystem written and ready for use?  As
part of the process of seeking funding for Btrfs development, Ted talked to

<a href="/Articles/370421/"><img src="https://static.lwn.net/images/conf/lca2010/TedTso-sm.jpg"
width=150 height=178 alt="[Ted Ts'o]" border=0 align="right"></a>

veterans of a number of filesystem development projects over the years.
They all estimated that getting a filesystem to a production-ready state
would require something between 75 and 100 person-years of effort - or
more.  That can be a daunting thing to tell corporate executives when one
is trying to get a project funded; for Btrfs, Ted settled for suggesting
that every company involved should donate two engineers to the cause.
Alas, not all of the companies followed through completely; vague problems
associated with an economic crisis got in the way.
<p>
An associated example: Sun started working on the ZFS filesystem in 2001.
The project was only announced in 2005, with the first shipments happening
in 2006.  But it is really only in the last year or so that system
administrators have gained enough confidence in ZFS to start using it in
production environments.  Over that period of time, the ZFS team - well
over a dozen people at its peak - devoted a lot of time to the development
of the filesystem.
<p>
So where do things stand with ext4?  It is, Ted says, an interesting time.
It has been shipping in community distributions for a while, with a
number of them now installing it by default.  With luck, the long term
support and enterprise distributions will start shipping it soon;
enterprise-level adoption can be expected to follow a year or so after
that.
<p>
Over the last year or so, There have been something between 60 and 100 ext4
patches in each mainline kernel release.  Just under half of those are bug
fixes; many of the rest are cleanup patches.  There's also a small amount
of new feature and performance enhancement work still.  Ted noted that the
number of bug fixes has not been going down in recent releases.  That, he
says, is to be expected; the user community for ext4 is growing rapidly,
and more users will find (and report) more bugs.
<p>
A certain number of those bugs are denial of service problems; many of
those are system crashes in response to a corrupted on-disk filesystem
image.  A larger share of the problems are race conditions and, especially
deadlocks.  There are a few problems associated with synchronization; one
does not normally notice these at all unless the system crashes at the
wrong time.  And there are a few memory leaks, usually associated with
poorly-tested error-handling paths.
<p>
The areas where the bulk of these bugs can be found is illuminating.  There
have been problems in the interaction between the block allocator and the
online resize functionality - it turns out that people do not resize
filesystems often, so this code is not always all that heavily tested.
Other bugs have come up in the interaction between block pre-allocation and
out-of-space handling.  Online defragmentation has had a number of
problems, including one nasty security bug; it turned out that nobody had
really been testing that code.  The <tt>FIEMAP</tt> <tt>ioctl()</tt>
command, really only used by one utility, had some problems.  There were
issues associated with disk quotas; this feature, too, is not often used,
especially by filesystem developers.  And there have been problems with the
no-journal mode contributed by Google; the filesystem had a number of
"there is always a journal" assumptions inherited from ext3, but, again,
few people have tested this feature.
<p>
The common theme here should be clear: a lot of the bugs turning up in this
stage of the game are associated with little-used features which have not
received as much testing as the core filesystem functions.  The good news
is that, as a result, most of the bugs have not actually affected that many
users.
<p>
There was one problem in particular which took six months to find;
about once a month, it would corrupt a filesystem belonging to a dedicated
and long-suffering tester.  It turned out that there was a race condition
which could corrupt the disk if two processes were writing the same file at
the same time.  Samba, as it happens, does exactly that, whereas the
applications run by most filesystem developers do not.  The moral of the
story: just because the filesystem developer has not seen problems does
not mean that the code is truly safe.
<p>
Another bug would only strike if the system crashed at just the wrong time;
it had been there for a long time before anybody noticed it.  How long?
The bug was present in the ext3 filesystem as well, but nobody ever
reported it.
<p>
There have also been a number of performance problems which have been found
and fixed.  Perhaps the most significant one had to do with performance in
the writeback path.  According to Ted, the core writeback code in the
kernel is fairly badly broken at the moment, with the result that it will
not tell the filesystem to write back more than 1024 blocks at a time.
That is far too small for large, fast devices.  So ext4 contains a hack
whereby it will write back much more data than the VFS layer has requested; it
is justified, he says, because all of the other filesystems do it too.  In
general, nobody wants to touch the writeback code, partly because they fear
breaking all of the workarounds which have found their way into
filesystem-specific code over the years.
<p>
Ted concluded by noting that, in one way, filesystems are easy: the Linux
kernel contains a great deal of generic support code which does much of the
work.  But the truth of the matter is that they are hard.  There are lots
of workloads to support, the performance demands are strong, and there tend
to be lots of processes running in parallel.

The creation of a new filesystem is done as a labor of love; it's generally
hard to justify from a business perspective.  This reality is reflected in
the fact that almost nobody is investing in filesystem work currently, with
the one high-profile exception being Sun and its ZFS work.  But, Ted noted,
that work has cost them a lot, and it's not clear that they have gotten a
return which justifies that investment.  Hopefully the considerable amount
of work which has gone into Linux filesystem development will have a more
obvious payback.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems">Filesystems</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#linux.conf.au-2010">linux.conf.au/2010</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/370419/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor370531"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2010 3:01 UTC (Thu)
                               by <b>yokem_55</b> (guest, #10498)
                              [<a href="/Articles/370531/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>This reality is reflected in the fact that almost nobody is 
investing in filesystem work currently, with the one high-profile exception 
being Sun and its ZFS work.</blockquote>

Is Oracle and btrfs a low profile contributor? While probably still a couple 
of years out from stability, btrfs will have most of the functionality that 
makes zfs desirable.
      
          <div class="CommentReplyButton">
            <form action="/Articles/370531/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2010 3:04 UTC (Thu)
                               by <b>yokem_55</b> (guest, #10498)
                              [<a href="/Articles/370532/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I should have done a better job of RTFA. Mea culpa. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor370548"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2010 8:15 UTC (Thu)
                               by <b>dwmw2</b> (subscriber, #2063)
                              [<a href="/Articles/370548/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ted is absolutely right. File systems are hard and take a long time to properly stabilise.<br>
<p>
That's why I find it so strange that people are willing to trust the closed-source file system inside SSDs, which have such a long track record of losing data, and which you can't even fsck and recover when they go wrong.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370548/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2010 11:13 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/370563/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The 'filesystem' inside an SSD may be buggy and unreliable, but does its expected failure rate exceed the chance of mechanical failure you'd have with a hard disk?  Nobody expects an SSD to work as a reliable backup medium, so it may not matter.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor370709"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2010 1:16 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/370709/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the filesystem inside a SSD actually is MUCH simpler than a general purpose filesystem<br>
<p>
it is always working in fixed size objects<br>
it never sees more than one write to a object at a time (and if it gets conflicting data for a block, ethe latest version wins)<br>
it also doesn't have to guess at the architecture and performance of the underlying storage<br>
it has a very simple command set (store this block here) rather than there being many different ways to do things.<br>
it has a single command queue where a general filesystem is getting reads and writes in parallel from many processes.<br>
it does not need to be able to run on multiple cpu cores at the same time<br>
<p>
all of these things make the resulting code drastically smaller, and therefor easier to check and test.<br>
<p>
the complexity of the code in the filesystem climbs significantly faster than the complexity of the problem the filesystem is trying to address, and the chance of there being bugs climbs significantly faster than the complexity of the code in the filesystem<br>
<p>
but the bottom line of why people are willing to trust the prioprietary filesystems in the SSDs is that so far the SSD vendors have been getting it right (or at least close enough to right) so the resulting failure rate is down in the noise of mechanical and electrical failure rates. definitely not noticeably higher than any other firmware (even firmware that doesn't contain an internal filesystem)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370709/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor370564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Testing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2010 11:17 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/370564/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a fuzz tester for filesystems that starts a virtual machine image and thrashes it with randomly generated filesystem calls by user processes, online resizing and defragmenting, artificially generated 'disk hardware errors' and so on until it crashes?<br>
<p>
Or, perhaps easier, a fuzz tester that corrupts disk images and tries to crash the kernel?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370627"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Testing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 21, 2010 17:36 UTC (Thu)
                               by <b>bcopeland</b> (subscriber, #51750)
                              [<a href="/Articles/370627/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not sure about VM-based tests (not really necessary) but there are fsfuzzer and various incarnations of fsx to name a couple of popular options.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370627/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Testing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2010 6:57 UTC (Fri)
                               by <b>cpeterso</b> (guest, #305)
                              [<a href="/Articles/370736/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps the fuzz tests could be used on a filesystem in a loopback device? The host system would be (mostly) protected from corruption of the real filesystem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor370748"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarification Please!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2010 10:49 UTC (Fri)
                               by <b>ctg</b> (guest, #3459)
                              [<a href="/Articles/370748/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The article talks exclusively about Ext4, except for the sentence where Ted was requesting funding for btrfs.  Is this right?  Or does it mean ext4?  Or was Ted helping out btrfs in his capacity as the then Linux Foundation Technology Director?<br>
<p>
Thank you!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370748/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarification Please!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2010 18:46 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/370794/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Ted was indeed trying to obtain resources for Btrfs development; it's a project he has always supported.
      
          <div class="CommentReplyButton">
            <form action="/Articles/370794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor370759"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2010 15:18 UTC (Fri)
                               by <b>ricwheeler</b> (subscriber, #4980)
                              [<a href="/Articles/370759/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I certainly disagree with the comment that no one is investing in file systems. <br>
<p>
At Red Hat, we have a team of 15 file system developers who contribute actively to a host of projects - ext2/3/4, btrfs, gfs2, NFS, CIFS, xfs and others. Not to mention the qa &amp; performance teams who turn our development code into hardened, high performance platforms for a huge number of businesses.<br>
<p>
Let's not paint an overly bleak picture, I think that the Linux file system community has made substantial and significant gains in the past few years and we certainly match or exceed the investment in this area that is done by proprietary vendors.<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370759/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370795"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Investing in filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 22, 2010 18:49 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/370795/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I have probably not really conveyed what Ted said clearly here; he was saying that almost nobody <i>else</i> is really investing in filesystems.  The investment from the Linux community is large and easily visible.
      
          <div class="CommentReplyButton">
            <form action="/Articles/370795/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor371654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Investing in filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 28, 2010 13:22 UTC (Thu)
                               by <b>dmaxwell</b> (guest, #14010)
                              [<a href="/Articles/371654/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well I do see news about DragonflyBSD's HAMMER from time to time. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/371654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor370868"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LCA: Why filesystems are hard</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2010 18:00 UTC (Sat)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/370868/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nice article. It would be very interesting to know how ext4 was/is tested by developers (even before being released).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370868/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor370893"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2010 8:11 UTC (Sun)
                               by <b>patrick_g</b> (subscriber, #44470)
                              [<a href="/Articles/370893/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      According to <a href="http://www.phoronix.com/scan.php?page=article&item=ext4_then_now&num=1">benchmarks by Phoronix</a> the performance of the ext4 file-system goes down with new kernel releases.<br>
Is Ted Ts'o aware of that ?


      
          <div class="CommentReplyButton">
            <form action="/Articles/370893/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370901"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2010 13:47 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/370901/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd trust those benchmarks to be indicative of problems in ext4 as far as <br>
I could throw their designer.<br>
<p>
e.g. one really obvious case they haven't checked is whether other <br>
filesystems and raw block devices are also affected. If they are, this is <br>
due to changes in the block layer (of which there have been many more in <br>
the target time period than changes to ext4), and Ted is blameless.<br>
<p>
TBH their PostgreSQL results are indicative of a misconfiguration of some <br>
kind more than anything else. Do you think no PostgreSQL users anywhere <br>
would have noticed a *factor of four slowdown* between .31 and .32 and <br>
mentioned it on the kernel list?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370901/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370904"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2010 14:02 UTC (Sun)
                               by <b>kronos</b> (subscriber, #55879)
                              [<a href="/Articles/370904/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; TBH their PostgreSQL results are indicative of a misconfiguration of some</font><br>
<font class="QuotedText">&gt; kind more than anything else.</font><br>
AFAIK the difference is caused by barriers being enabled by default in .32, the change is deliberate.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370904/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2010 14:32 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/370905/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can see no sign of that in the ext4 git changelog. AFAIK barriers were <br>
always enabled for ext4... but commit <br>
5f3481e9a80c240f169b36ea886e2325b9aeb745 causes an fdatasync() in the <br>
middle of an already-allocated file to always flush its blocks out (with a <br>
barrier). PostgreSQL would be 'bitten' by this hard (really bitten by the <br>
bug it fixes): almost all its writes are in the middle of <br>
already-allocated files, and before this change the fdatasync() wouldn't <br>
actually have synced anything but the inode, AFAICS.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2010 16:07 UTC (Sun)
                               by <b>patrick_g</b> (subscriber, #44470)
                              [<a href="/Articles/370908/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      Perhaps...but from 1069 transactions per second (2.6.31) in pgbench to only 280 (2.6.32) the cost is gigantic!<br>
See <a href="http://www.phoronix.com/scan.php?page=article&item=linux_perf_regressions&num=1">this page</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/370908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370920"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who knows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 24, 2010 23:17 UTC (Sun)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/370920/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      And who can tell if the change is really worth it after the previous <a href="http://lwn.net/Articles/322823/">ext4 fiasco</a>?
      
          <div class="CommentReplyButton">
            <form action="/Articles/370920/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor370931"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who knows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2010 8:12 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/370931/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMNSHO, anything that fscks as fast as ext4 is worth it, no matter what <br>
else has changed :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/370931/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor371147"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 26, 2010 8:02 UTC (Tue)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/371147/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
280 transactions per second sounds about right for a system with spinning disks attached. A transaction is committed when the data hits the log and in general you can do this once per revolution of the disk platter. If there are simultaneous transactions they can commit together.<br>
<p>
Anyone who gets thousands of transactions per second either has a battery backed cache on the hard disk controller, or does not have the D in ACID. Or is running on SSD disks. <br>
<p>
The fact that disks and operating systems have silently been ignoring fsync requests has gotten people used to completely unrealistic numbers. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/371147/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor371201"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 26, 2010 15:00 UTC (Tue)
                               by <b>ricwheeler</b> (subscriber, #4980)
                              [<a href="/Articles/371201/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree in general with the comment, but have to point out that the transaction rate depends a lots of things. <br>
<p>
You can get a rough idea of how many transactions your storage can do by timing the fsync()'s per second of a dirty file. On a S-ATA drive, that number is around 30-40 per second, on an enterprise class array it can jump up to 700/sec over fibre channel and with something like a PCI-e SSD device it can go beyond that.<br>
<p>
Note that you can also try and batch multiple transactions  into one commit - ext4 supports batching for multi-threaded writers for fsync for example.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/371201/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor371211"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Performances of ext4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 26, 2010 15:30 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/371211/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SATA drives can do better than that.<br>
<p>
for rotating media, figure the drive can do one fsync per rotation when writing to sequential file, for 7200 rpm drives this is ~120/sec.<br>
<p>
if you are getting thousands of transactions/sec from a database test, you have some buffering going on, and unless that buffering is battery backed, you will loose it in power outages.<br>
<p>
the one exception is that if you have multiple transactions going in parallel, you may be able to have different transactions complete their syncs in the same disk rotation, so you may get # threads * (rpm/60) syncs/sec.<br>
<p>
enterprise storage arrays have large battery backed ram buffers, which do wonders for your transaction rate, up until the point where those buffers are filled (although even then they give you a benefit as multiple transactions can be batched and written at once, reducing the number of writes to the drives)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/371211/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
