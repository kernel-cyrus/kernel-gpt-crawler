        <!DOCTYPE html>
        <html lang="en">
        <head><title>Why glibc's fstat() is slow [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/944214/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/944437/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/944214/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Why glibc's fstat() is slow</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 14, 2023</br>
           </div>
The <a
href="https://man7.org/linux/man-pages/man2/stat.2.html"><tt>fstat()</tt></a>
system call retrieves some of the metadata — owner, size, protections,
timestamps, and so on — associated with an open file descriptor.  One might
not think of it as a performance-critical system call, but there are
workloads that make a lot of <tt>fstat()</tt> calls; it is not something
that should be slowed unnecessarily.  As it turns out, though, the GNU C
Library (glibc) has been doing exactly that, but a fix is in the works.
<p>
Mateusz Guzik has been working on a number of x86-related performance
issues recently.  As part of that work, he <a
href="/ml/linux-kernel/CAGudoHH95OKVgf0jW5pz_Nt2ab0HTnt3H9hbmU=aSHozOS5B0Q@mail.gmail.com/">stumbled
into</a> the realization that glibc's implementation of <tt>fstat()</tt> is
expressed in terms of <a
href="https://man7.org/linux/man-pages/man3/fstatat.3p.html"><tt>fstatat()</tt></a>.
Specifically, a call like:
<p>
<pre>
    result = fstat(fd, &amp;stat_buf);
</pre>
<p>
is turned into:
<p>
<pre>
    result = fstatat(fd, "", &amp;stat_buf, AT_EMPTY_PATH);
</pre>
<p>
These calls are semantically equivalent; by the POSIX definition, a call to
<tt>fstatat()</tt> providing an empty string for the path and the
<tt>AT_EMPTY_PATH</tt> flag operates directly on the provided file
descriptor.  But the difference in the kernel is significant; implementing
<tt>fstat()</tt> in this way is significantly slower, for a couple of
reasons.
<p>
One of those is that <tt>fstatat()</tt> is a more complex system call, so
it does preparatory work that is not useful for the simple <tt>fstat()</tt>
case.  Once alerted to the problem, Linus Torvalds <a
href="/ml/linux-kernel/CAHk-=wg6bzTdQHSsswHPYFUbb1DfszyWTZ97hZv7bYxaNHVkHw@mail.gmail.com/">posted
a patch</a> that detects this case and avoids that extra work.  But the
result is still, <a
href="/ml/linux-kernel/20230903204858.lv7i3kqvw6eamhgz@f/">according to
Guzik's measurements</a>, about 12% slower than calling <tt>fstat()</tt>
directly.
<p>
That performance loss is the result of the second problem:
<tt>fstatat()</tt> must check the provided path and ensure that it is
empty.  One might think that it makes no sense to even look at the path
when the user has provided a flag (<tt>AT_EMPTY_PATH</tt>) that says there
is nothing to be seen there but, as Al Viro <a
href="/ml/linux-kernel/20230903232802.GO3390869@ZenIV/">pointed out</a>,
POSIX mandates this behavior.  Checking the path means accessing user-space
data from the kernel; that, in turn, can require disabling guardrails like
<a href="/Articles/517475/">supervisor mode access prevention</a>.  It all
adds up to a significant amount of overhead to check an empty string.
<p>
Torvalds <a
href="/ml/linux-kernel/CAHk-=wh+=W2k1V_0Om=_=QpPAN_VgHzdZ4FLXSfcyTSK7xo0Eg@mail.gmail.com/">made
it clear</a> that he thought glibc's behavior made no sense and wondered
why things were done that way.  A bit later, though, he <a
href="/ml/linux-kernel/CAHk-=wjrvn+J=z0_schGSROK0HCK-xs4wgky6pRKy7kVLhDeLg@mail.gmail.com/">found
a plausible explanation</a> for this choice.  On an x86-64 system, the
kernel exports a number of related system calls, including <tt>fstat()</tt>
(number&nbsp;5) and <tt>newfstatat()</tt> (number 262).  Torvalds
concluded:
<p>
<blockquote class="bq">
	The glibc people found a "__NR_newfstatat", and thought it was a
	newer version of 'stat', and didn't find any new versions of the
	basic stat/fstat/lstat functions at all. So they thought that
	everything else was implemented using that 'newfstatat()'
	entrypoint.
<p>
	But on x86-64 (and most half-way newer architectures), the regular
	__NR_stat *is* that "new" stat.
</blockquote>
<p>
The "new" <tt>fstat()</tt>, after all, came about in the 0.97 release in
1992, so there was no reason for the x86-64 architecture (which arrived
rather later than that) to use anything else.  But, if Torvalds's
explanation reflects reality, the glibc developers were fooled by the "new"
part of the <tt>newfstatat</tt> name and passed over the entry point they
should have used to implement <tt>fstat()</tt>.
<p>
There are a few observations that
one could make from this little bit of confusion:
<p>
<ul class="spacylist">
<li> The system calls (and their names) provided at the kernel boundary are
     not the same as those expected by user-space programmers.  The glibc
     people know this better than anybody else, since part of their job is
     to provide the glue between those two interfaces, but confusion still
     seems to happen.
<li> The fact that the kernel's documentation of the interface it presents
     to user space is ... mostly nonexistent ... certainly does not help
     prevent confusion of this type.
<li> Using qualifiers like "new" in the naming of functions, products, or
     one's offspring tends to be unwise; what is new today is old tomorrow.
     </ul>
<p>
Be that as it may, even with Torvalds's change (which was <a
href="https://git.kernel.org/linus/9013c51c630a">merged</a> for the 6.6-rc1
release and will presumably show up in a near-term stable update),
<tt>fstat()</tt> is slower than it needs to be when glibc is being used.
In an attempt to improve the situation, Guzik <a
href="/ml/libc-alpha/CAGudoHG83bsjmsy9nvmqUGrSORRdnu0D8tQDRq=qm8+WWT00Eg@mail.gmail.com/">raised
the issue</a> on the libc-alpha list.  Adhemerval Zanella Netto <a
href="/ml/libc-alpha/680b330d-6ef3-adc5-9ba6-cf74dd53e422@linaro.org/">responded</a>
that the library developers are trying to simplify their code by using the
more generic system calls whenever possible, that the
<tt>AT_EMPTY_PATH</tt> problem is likely to affect all of the
<tt>*at()</tt> system calls, and that, as a consequence, the problem would
be "<q>better fixed in the kernel</q>".
<p>
Torvalds <a
href="/ml/libc-alpha/CAHk-=wg_6CYB0qDQ9eDfjZSsqzgKcF2ZMd2DObfeFc_N-PxUjg@mail.gmail.com/">pointed
out</a> that, while other system calls have to handle
<tt>AT_EMPTY_PATH</tt>, <tt>fstatat()</tt> is the only one that is likely
to matter from a performance perspective; none of the others should be expected to
show up as problems in real-world programs.  Meanwhile, despite the
misgivings expressed previously, Zanella <a
href="/ml/libc-alpha/6d0e4e9e-ab69-0c73-bb9d-ce344b4a043b@linaro.org/">put
together a patch</a> causing glibc to use ordinary <tt>fstat()</tt> when
appropriate.  Torvalds <a
href="/ml/libc-alpha/CAHk-=wgkKHn9_aG8wTz8BkxtC2g=+93vN29HNVnC_s+cPCOteA@mail.gmail.com/">agreed
that it looked correct</a>, but complained that the implementation was
messy; he seemed to <a
href="/ml/libc-alpha/CAHk-=wgfHhF=kZtGmWKckrcbJuO=_gTa=EzMoTeirkRv-3ZR2Q@mail.gmail.com/">prefer</a>
an <a
href="/ml/libc-alpha/b22fcbd5-eb69-7755-c76a-01706006b3cd@linaro.org/">alternative
implementation</a> that Zanella posted later.
<p>
As of this writing, neither version of the patch has found its way into the
glibc repository; the latter version is <a
href="/ml/libc-alpha/20230905203421.2127750-1-adhemerval.zanella@linaro.org/">under
consideration</a>.  It is probably safe to assume that a version of this
patch will be applied at some point; nobody has an interest in glibc being
slower than it needs to be.  This particular story has a happy ending, but
it does stand as an example of what can happen in the absence of clarity
around the interfaces between software components.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls">System calls</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/944214/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor944499"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2023 17:37 UTC (Thu)
                               by <b>wsy</b> (subscriber, #121706)
                              [<a href="/Articles/944499/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
glibc's localtime() is slow without TZ environment variable.<br>
<p>
<a href="https://blog.packagecloud.io/set-environment-variable-save-thousands-of-system-calls/">https://blog.packagecloud.io/set-environment-variable-sav...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944499/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944507"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2023 19:07 UTC (Thu)
                               by <b>brenns10</b> (subscriber, #112114)
                              [<a href="/Articles/944507/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's wild how many places that pops up! I fixed that in procps-ng where it would do a stat(/etc/local time) multiple times *per process* because of the printf formats being used. I'm sure tons of software, especially multithreaded apps, are experiencing this and slowdowns associated with it.<br>
<p>
<a href="https://gitlab.com/procps-ng/procps/-/merge_requests/119">https://gitlab.com/procps-ng/procps/-/merge_requests/119</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944507/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2023 21:56 UTC (Thu)
                               by <b>guillemj</b> (subscriber, #49706)
                              [<a href="/Articles/944519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is <a href="https://sourceware.org/bugzilla/show_bug.cgi?id=24004">https://sourceware.org/bugzilla/show_bug.cgi?id=24004</a> with a patch attached. You can use localtime_r(3) to avoid this problem. And at least for multithreaded code I'd expect it to be using that already, but otherwise other code might indeed suffer from this issue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor944599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">speed of repeated localtime() etc.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2023 0:30 UTC (Sat)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/944599/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Software which appends entries to a log file can call <tt>localtime</tt> (or its relatives) once per event, and there can be dozens or hundreds of events per second, for instance <tt>open()</tt>. In most cases the speed of logging can be improved by remembering the <tt>headway</tt> between the current <tt>gettimeofday()</tt> and the next future <tt>gettimeofday()</tt> when the relevant portion of <tt>localtime()</tt> can change.  For an output format of HH:mm:ss, then the headway is limited to at most 1 second.  For the local timezone, the minimum headway can be up to 30 minutes.  If <tt>gettimeofday()</tt>still is within the headway, then there is no need to consult any any external authority.









      
          <div class="CommentReplyButton">
            <form action="/Articles/944599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor944515"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2023 21:18 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/944515/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I despise the fact that POSIX insisted on standardizing the ugly TZ env variable as the standard interface for controlling timezones. It makes some amount of sense to have a process-wide value for "the local timezone." It makes considerably less sense to make that the *only* way of doing tz-aware calculations. If I want to know "what time is it in [some specific part of] Australia?", it does not necessarily follow that I want the whole process to think it is actually in Australia.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944515/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 0:42 UTC (Fri)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/944525/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
tzalloc, tzfree, localtime_rz, ctime_rz (and a few others) would seem like fit candidates for POSIX standardization.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor946525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 4, 2023 16:31 UTC (Wed)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/946525/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
POSIX was documenting a standard with compromise between vendors, not generally a group of developers, creating new specs.<br>
Commercial vendors tend to embrace and extend which resulted in fragmenting the UNIX user base.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/946525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor944508"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2023 20:00 UTC (Thu)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/944508/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For newer architectures (riscv32, loongarch), the simpler fstat syscall doesn't exist at all[1], and statx is the only option to implement fstat, forcing the useless path check. So no, it's not just a glibc problem, at least if we're looking beyond x86-64.<br>
<p>
[1] <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/asm-generic/unistd.h?h=v6.5#n209">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944508/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 6:23 UTC (Fri)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/944532/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I find it very strange that this depends on the CPU architecture at all. The fstat() and its relatives work on the file system, which is at much higher level than what architecture differences would naturally affect.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 14:08 UTC (Fri)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/944554/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is not due to architectural differences, but due to the standard kernel policy of supporting only the most general version of the syscall[1]. In this case, apparently, performance implications of having only statx were not considered.<br>
<p>
[1] <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/asm-generic/unistd.h?h=v6.5#n9">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944555"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 14:51 UTC (Fri)
                               by <b>hmh</b> (subscriber, #3838)
                              [<a href="/Articles/944555/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looks like it would be easy enough to fix, if there's a will to do so.   In fact, now would be the ideal time to do it, since you also want to ensure any libc that is ported to those arches will try to use the faster syscall instead of the generic one [where available].<br>
<p>
I wonder if people looked at what glibc would use when they were bootstrapping these two arches, and decided to not implement the more specialized, less-generic (but faster!) members of the stat family of syscalls because glibc would not use them...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944555/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944754"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 18, 2023 13:13 UTC (Mon)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/944754/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote><i>I wonder if people looked at what glibc would use when they were bootstrapping these two arches, </i></blockquote>
<p>
What I don't get is why would they have to think about that code at all when bootstrapping. There is an architecturally neutral implementation of fstat() and friends, and all the person working on the porting should need to do is to connect each system call implementation to the low-level mechanism the particular architecture employs to jump from userland to the kernel.



      
          <div class="CommentReplyButton">
            <form action="/Articles/944754/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor946982"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2023 14:54 UTC (Sat)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/946982/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I looked a bit further, and it turns out that the original statx implementation did support passing NULL filename to emulate fstat, but this support was explicitly dropped in [1].<br>
<p>
It feels really weird that Linus bashed glibc for "being silly" but merged this change... OTOH back in 2017 archs without fstat syscall didn't exist, so it wasn't a problem for C libraries.<br>
<p>
[1] <a href="https://git.kernel.org/torvalds/c/1e2f82d1e9d12223b4cbd1feb3f2b5596f8049eb">https://git.kernel.org/torvalds/c/1e2f82d1e9d12223b4cbd1f...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/946982/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor945516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 25, 2023 18:29 UTC (Mon)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/945516/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The statx() system call is also the only Y2038-safe stat system call on 32-bit architectures (aside from x32).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor944512"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">AT_EMPTY_PATH and NULL</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2023 20:48 UTC (Thu)
                               by <b>geofft</b> (subscriber, #59789)
                              [<a href="/Articles/944512/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; One might think that it makes no sense to even look at the path when the user has provided a flag (<tt>AT_EMPTY_PATH</tt>) that says there is nothing to be seen there but, as Al Viro <a href="https://lwn.net/ml/linux-kernel/20230903232802.GO3390869@ZenIV/">pointed out</a>, POSIX mandates this behavior. </font>
<p>
I think this is a misreading of Viro's (terse) message. He doesn't say anything about POSIX, the <a href="https://man7.org/linux/man-pages/man2/stat.2.html">Linux man page</a> says that <tt>AT_EMPTY_PATH</tt> is a non-portable Linux extension, and just to be sure I don't see it in POSIX at all.
<p>
I think what he meant is that Linux itself effectively mandates this behavior, in that the current implementation of <tt>fstatat(fd, NULL, &amp;stat_buf, AT_EMPTY_PATH</tt> is to return <tt>-EFAULT</tt>, and so userspace libraries like glibc don't have the option of setting it to <tt>NULL</tt>. That is, the problem is not that glibc is being weird by passing a non-NULL pointer to an empty string that the kernel has to go look at, the problem is that glibc has no choice but to pass a non-NULL pointer to an empty string.
<p>
But it seems to me (as a non-expert) that this is something Linux could relax - if you notice that the pointer is <tt>NULL</tt>, check for <tt>AT_EMPTY_PATH</tt> before throwing <tt>-EFAULT</tt>. It wouldn't help glibc for a long while, but it would be worth doing for several years from now, when glibc has inevitably dropped support for existing kernel versions for other reasons.
<p>
To the more general point, that the kernel shouldn't be looking at the pointer at all when <tt>AT_EMPTY_PATH</tt> is specified even if it's non-<tt>NULL</tt>, as the parent messages in that subthread point out, the kernel defines a specific non-error behavior for that case, which is to ignore <tt>AT_EMPTY_PATH</tt> and actually use the provided path, and that behavior could not be changed without technically breaking backwards compatibility for userspace - even though it's hard to imagine that anyone is relying on it. But I believe an error case (getting <tt>-EFAULT</tt> when passing <tt>NULL</tt>) can be turned into a non-error case without violating the kernel's promises about breaking userspace.




      
          <div class="CommentReplyButton">
            <form action="/Articles/944512/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor944534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 6:38 UTC (Fri)
                               by <b>NN</b> (subscriber, #163788)
                              [<a href="/Articles/944534/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On an adjacent topic, GNU coreutils also uses fstat in a way which seems unnecessary, e.g., compare the usage in its version of wc: <a href="https://github.com/coreutils/coreutils/blob/master/src/wc.c">https://github.com/coreutils/coreutils/blob/master/src/wc.c</a>, heavily wrapping and processing fstat, with the busybox version (<a href="https://github.com/brgl/busybox/blob/master/libbb/wfopen_input.c">https://github.com/brgl/busybox/blob/master/libbb/wfopen_...</a>), which reads from stdin by default or if if receives a "-" as the sole arg (see the definition of fopen_or_warn_stdin here: <a href="https://github.com/brgl/busybox/blob/master/libbb/wfopen_input.c">https://github.com/brgl/busybox/blob/master/libbb/wfopen_...</a>).<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor944538"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 8:58 UTC (Fri)
                               by <b>Homer512</b> (subscriber, #85295)
                              [<a href="/Articles/944538/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So … does nobody run statistics on what system calls are used? Not even as a measure to see where effort should be focused? Or just to see where "linux system still boots fine" counts as basic test coverage?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944538/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944549"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 13:41 UTC (Fri)
                               by <b>smoogen</b> (subscriber, #97)
                              [<a href="/Articles/944549/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are plenty of statistics run by different groups all focused on their use-case. The issue is that use-cases vary all over and you end up with people focusing efforts on sometime 'speed' and sometimes 'this gets used a lot a little differently.. maybe just make the call handle more cases'. Then you end up cleaning up some places for one thing, and other places for another. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944549/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor944539"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 9:18 UTC (Fri)
                               by <b>dottedmag</b> (subscriber, #18590)
                              [<a href="/Articles/944539/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Every time I see "this is to simplify code" I flinch. People so often lose the sight of what they are doing: any software project is producing software to be used by the users, and that's the main goal. The secondary, subordinate, goal is to make the developers' lifes as easier as possible. For such a fundamental library as libc any inefficiency is multiplied gazillion times every day. In my opinion it is cruel to put developers' time above users' in this particular codebase.<br>
<p>
Admittedly, C is such a footgun that sacrificing some performance in some rare corner cases to significantly decrease amount of code is acceptable, but selecting one syscall over another in stat, is it really so complicated?<br>
<p>
P.S: I'm not ordering anyone to do anything, I'm posting my observations and describe attitude I try to put into my work. I thank all maintainers who put their work into the code we all benefit from, often without renumeration and in their spare time, and I try to pay it back in kind.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944539/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor944674"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2023 15:14 UTC (Sat)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/944674/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I mean, they didn’t realize it was slower.<br>
<p>
Simpler code is a net good, freeing up time and making bugs less likely, and if you can get it without trade offs, you should do it.  It seems reasonable to believe the perf would be ~the same, which they did.<br>
<p>
So maybe they need better testing but they didn’t do anything *wrong* and certainly didn’t knowingly prioritize convenience over performance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944674/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor944550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 15, 2023 13:49 UTC (Fri)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/944550/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I glanced at the rustix linux-raw backend, and it seems to get it right:<br>
<p>
<a href="https://github.com/bytecodealliance/rustix/blob/93c95474e0ef70ba1c10b163d05dc89ba1b74b2d/src/backend/linux_raw/fs/syscalls.rs#L460">https://github.com/bytecodealliance/rustix/blob/93c95474e...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor944613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2023 7:20 UTC (Sat)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/944613/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure if our beloved editor understands naming.<br>
<p>
The answer to all this confusion is:<br>
<p>
newnewfstat(...)<br>
<p>
Clearly ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/944613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945216"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 21, 2023 15:13 UTC (Thu)
                               by <b>gutschke</b> (subscriber, #27910)
                              [<a href="/Articles/945216/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're not taking all the possible future needs for extensions into account.<br>
<p>
We really should standardize on names like: fstat_new$_2006revB.2_2023revA()<br>
<p>
Just increment dates and revisions every time you propose a patch, and document the history by keeping track of precursors of the updated API.<br>
<p>
I'm torn between this proposal and adding full Git hashes to all symbols...<br>
<p>
/s<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945216/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor945765"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">patch mergins status - Why glibc's fstat() is slow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2023 14:16 UTC (Thu)
                               by <b>fabiop</b> (guest, #24661)
                              [<a href="/Articles/945765/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
glibc patch was merged yesterday:<br>
<a rel="nofollow" href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=551101e8240b7514fc646d1722f8b79c90362b8f">https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=55...</a><br>
I suppose master branch is for glibc 2.39, right? (Other branches still don't have the patch)<br>
<p>
kernel side, the patch only looks to be in 6.6:<br>
<a rel="nofollow" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9013c51c630a">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
But still not in 6.1.55, 6.4.16 or 6.5.5.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945765/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2023, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
