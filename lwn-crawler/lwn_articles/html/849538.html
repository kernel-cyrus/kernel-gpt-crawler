        <!DOCTYPE html>
        <html lang="en">
        <head><title>Clarifying memory management with page folios [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/849538/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/849739/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/849538/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Clarifying memory management with page folios</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 18, 2021</br>
           </div>
Memory management generally works at the level of pages, which typically
contain 4,096 bytes but may be larger.  The kernel, though, has extended
the concept of pages to include compound pages, which are groups of
contiguous single pages.  That, in turn, has made the definition of
what a "page" is a bit fuzzy.  Matthew Wilcox has been working since last
year on a concept called "page folios" which is meant to bring the picture
back into focus; whether the memory-management community will accept it
remains unclear, though.
<p>
At the lowest level, pages are a concept implemented by the hardware; the
tracking of memory and whether it is present in RAM or not is done at page
granularity.  Any given CPU architecture may offer a
limited selection of page sizes, but one "base" page size must be chosen,
and the most common choice remains 4,096 bytes — the same as it was when
the first Linux kernels were released 30&nbsp;years ago.
<p>
The kernel, though, often has reason to work with memory in larger chunks.
One example is the management of "huge pages" which, once again, are
implemented by 
the hardware.  The x86 architecture, for example, can work with 2MB huge
pages, and there are performance advantages to using them where they are
applicable.  The kernel will also allocate groups of pages in other sizes,
though, typically for DMA buffers or other uses where a set of physically
contiguous pages is needed.  This sort of grouping of pages is known as a
"compound page" in the kernel.
<p>
Every base page of memory managed by the kernel is represented by a <a
href="/Articles/565097/"><tt>page</tt> structure</a> in the system memory
map.  When a compound page is created out of a set of base pages, the
<tt>page</tt> structure for the first page in the set (the "head page") is
specially marked to make its compound nature explicit.  The other
information in that structure refers to the compound page as a whole.
All of the other
pages (the "tail pages") are marked as such, with a pointer to the
<tt>page</tt> structure for the associated head page.  See <a
href="/Articles/619514/">this article</a> for details on how compound pages
are organized.
<p>
This mechanism makes it easy to go from the <tt>page</tt> structure of a
tail page to the head page for the compound page.  Many interfaces within
the kernel make use of that feature, but it creates a fundamental
ambiguity: if a function is passed a pointer to a <tt>page</tt> structure
for a tail page, is it expected to act on that tail page or on the compound
page as a whole?  Or, as Wilcox put it in <a
href="/ml/linux-kernel/20201216182335.27227-1-willy@infradead.org/">the
first posting of the folio series</a> in December:
<p>
<blockquote class="bq">
	A function which has a struct page argument might be expecting a
	head or base page and will BUG if given a tail page.  It might work
	with any kind of page and operate on PAGE_SIZE bytes.  It might
	work with any kind of page and operate on page_size() bytes if
	given a head page but PAGE_SIZE bytes if given a base or tail page.
	It might operate on page_size() bytes if passed a head or tail
	page.  We have examples of all of these today.
</blockquote>
<p>
(<tt>PAGE_SIZE</tt> is the size of a base page, while <tt>page_size()</tt>
returns the full size of a — possibly compound — page.)
There does not seem to be an extensive history of bugs resulting from this
particular API, but an interface that is this poorly defined seems likely
to encourage problems sooner or later.
<p>
In an attempt to clarify the situation, Wilcox has come up with the concept
of a "page folio", which is really just a <tt>page</tt> structure that is
guaranteed not to be a tail page.  Any function accepting a folio will
operate on the full compound page (if, indeed, it is a compound page) with
no ambiguity.  The result is greater clarity in the kernel's
memory-management subsystem; as functions are converted to take folios as
arguments, it will become clear that they are not meant to operate on tail
pages.
<p>
When Wilcox first posted
this patch series, though, he emphasized a different
benefit from the change.  Any function that might be passed a tail page,
but which must operate on the full compound page  containing that tail page,
must exchange any pointers to tail-page <tt>page</tt> structures
for pointers to the head page instead.  That is typically done with a call
to:
<p>
<pre>
    struct page *compound_head(struct page *page);
</pre>
<p>
This function is relatively cheap, but it may be called many times over the
course of a single operation on a page.  That makes the kernel bigger
(since it's an inline function) and slows things down.  A function that
accepts a folio, instead, knows that it is not dealing with a tail page; 
thus it need not call <tt>compound_head()</tt>.  That saves both time and
memory.
<p>
The folio type itself is defined as a simple wrapper structure:
<p>
<pre>
    struct folio {
        struct page page;
    };
</pre>
<p>
From there, a new set of infrastructure is built up.  For example,
<tt>get_folio()</tt> and <tt>put_folio()</tt> will manage references to the
folio much like <tt>get_page()</tt> and <tt>put_page()</tt>, but without
the unneeded calls to <tt>compound_head()</tt>.  A whole set of
higher-level functions follows from there.  Much of the real work, though,
will be in converting various kernel subsystems to use the new type; Wilcox
didn't sugarcoat the nature of that task:
<p>
<blockquote class="bq">
	This is going to be a ton of work, and massively disruptive.  It'll
	touch every filesystem, and a good few device drivers!  But I think
	it's worth it.
</blockquote>
<p>
By the time the <a
href="/ml/linux-kernel/20210305041901.2396498-1-willy@infradead.org/">fourth
version of this patch set</a> was posted on March&nbsp;5, the core patches
and the conversions (which Wilcox didn't post) added up to about 100
commits, which is a fair amount to review.
<p>
Perhaps as a result of the size of the patch series, the previous postings
did not elicit that much discussion.  In response to the latest one,
though, Andrew Morton <a
href="/ml/linux-kernel/20210313123658.ad2dcf79a113a8619c19c33b@linux-foundation.org/">took
a look</a> and was worried by what he saw:
<p>
<blockquote class="bq">
	Geeze it's a lot of noise.  More things to remember and we'll
	forever have a mismash of `page' and `folio' and code everywhere
	converting from one to the other.  Ongoing addition of folio
	accessors/manipulators to overlay the existing page
	accessors/manipulators, etc.
	<p>
	It's unclear to me that it's all really worth it.
</blockquote>
<p>
Hugh Dickins, too, <a
href="/ml/linux-kernel/alpine.LSU.2.11.2103131842590.14125@eggly.anvils/">expressed
a lack of enthusiasm</a> for this work.  On the other hand, <a
href="/ml/linux-kernel/20210315115501.7rmzaan2hxsqowgq@box/">Kirill
Shutemov</a> and <a
href="/ml/linux-kernel/YE9VLGl50hLIJHci@dhcp22.suse.cz/">Michal Hocko</a>
both expressed support for it, in concept at least.  Dave Chinner <a
href="/ml/linux-kernel/20210315222708.GA349301@dread.disaster.area/">said</a>
that "<q>this abstraction is absolutely necessary</q>" for filesystem
developers, especially if and when the page cache gains the ability to
manage compound pages of multiple sizes.
<p>
So, in other words, there is currently no consensus among the core
developers regarding whether this work improves the kernel or not.  That
may change over time as more people look at it and its advantages (or the
lack thereof) become more clear.  But change tends to happen slowly in the
memory-management subsystem in general, even when the patch set in question
is not so large and messy.  One should also bear in mind that there is an
inevitable discussion on naming to be had; it is already clear that "folio"
is not popular, though alternatives are currently thin on the ground.  One
conclusion is thus clear: the
kernel may well get folios or something like them, but it seems unlikely to
happen soon.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Folios">Memory management/Folios</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/849538/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor849767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 17:24 UTC (Thu)
                               by <b>logang</b> (subscriber, #127618)
                              [<a href="/Articles/849767/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I thought the folio name was rather clever as the definition is a great fit. But maybe clever isn&#x27;t always a good thing.<br>
<p>
In any case, if it gets in as named, it&#x27;s only a matter of time before we can start describing compound pages as foliolate (having compound leaves) and someone is sure to come up with a case for a &#x27;struct portfolio&#x27;. ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 20:14 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/849779/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I like &quot;ream&quot; personally. Not sure if that&#x27;s come up in the discussion already.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849804"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 3:17 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/849804/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I threw out a bunch of options early on: ream, sheaf and album didn&#x27;t make it.  Nor did quarto, aigle, quire, leaf, octavo or any number of other options ;-)<br>
<p>
<a href="https://lore.kernel.org/linux-fsdevel/20201113174409.GH17076@casper.infradead.org/">https://lore.kernel.org/linux-fsdevel/20201113174409.GH17...</a><br>
<p>
Criteria: Must be easily greppable (book is bad), must be short, shouldn&#x27;t be too cutesy (banqyet by analogy with byte was not under consideration).<br>
<p>
Online thesauri are your friends, but at the end of the day it&#x27;s always a matter of taste.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849804/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 4:38 UTC (Fri)
                               by <b>jonas.bonn</b> (subscriber, #47561)
                              [<a href="/Articles/849807/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I like the name folio, but as a North American it&#x27;s just got Shakespeare written all over it and has little intrinsic meaning; I understand where the reluctance towards the name is coming from...<br>
<p>
Normally, pages are created by folding a &#x27;sheet&#x27;... so there you go!<br>
<p>
<a href="https://en.wikipedia.org/wiki/Paper_size#/media/File:A_size_illustration2.svg">https://en.wikipedia.org/wiki/Paper_size#/media/File:A_si...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 9:32 UTC (Fri)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/849823/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As a non-native English speaker, I had to look up most of the rejected options, so IMHO they must be fairly obscure...<br>
<p>
BTW, &quot;aigle&quot; is not known by &quot;dict&quot;, nor by my paper dictionary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849825"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 11:10 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/849825/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Aigle is a French paper size: <a href="https://en.wikipedia.org/wiki/Paper_size">https://en.wikipedia.org/wiki/Paper_size</a><br>
<p>
<a href="https://en.wikipedia.org/wiki/Units_of_paper_quantity">https://en.wikipedia.org/wiki/Units_of_paper_quantity</a> is also a good source of names.<br>
<p>
Honestly, I&#x27;m 120 patches in at this point.  Someone&#x27;s going to have to be really convincing to have a better name than folio.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849825/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849827"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 11:17 UTC (Fri)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/849827/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks, folio is fine! ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849827/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor851458"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2021 11:13 UTC (Fri)
                               by <b>Hi-Angel</b> (guest, #110915)
                              [<a href="/Articles/851458/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Honestly, I&#x27;m 120 patches in at this point. Someone&#x27;s going to have to be really convincing to have a better name than folio.</font><br>
<p>
A little trick: doing a rename over all of the 120 patches might be done in just under a minute ;) What I&#x27;d do here is:<br>
<p>
```<br>
    git format-patch -120 --stdout &gt; 1.patch<br>
    sp folio my_better_name<br>
    git am -3 1.patch<br>
```<br>
<p>
Read `sp` as `sed`.<br>
<p>
For the sake of completeness: sp is my alias to sed_perl, which in turn is a wrapper over perl to replace text in files <a rel="nofollow" href="https://github.com/Hi-Angel/dotfiles/blob/140c7895150275404b8124484e09d34023b57964/.zshrc#L114-L121">https://github.com/Hi-Angel/dotfiles/blob/140c78951502754...</a> I was at some point annoyed by discrepancies in behavior between grep, sed, awk, and what not, and migrated to using perl + ack (a perl version of  grep). Never looked back.<br>
<p>
So… hopefully this will help.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851458/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor849785"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 18, 2021 21:47 UTC (Thu)
                               by <b>unixbhaskar</b> (guest, #44758)
                              [<a href="/Articles/849785/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Okay, I have had the uncanny habit of touching the triviality and it reflects on my work ...anyway...this point in the article :<br>
<p>
&quot;One should also bear in mind that there is an inevitable discussion on naming to be had; it is already clear that &quot;folio&quot; is not popular, though alternatives are currently thin on the ground. One conclusion is thus clear: the kernel may well get folios or something like them, but it seems unlikely to happen soon.&quot;<br>
<p>
Matthew and Jon, how about a simple name(well, kernel is a bloody complex thing, it doesn&#x27;t mean, it has to have a complex or artistic name,does it?) like &quot;page_access&quot; ? (I am sure that I missed  certain things, a plethora of kernel API/ABI should have checked before preaching  ...:) , which I haven&#x27;t done so. But ......<br>
<p>
Stop fretting at my naivety ....    :) ..please...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849785/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849805"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 3:21 UTC (Fri)
                               by <b>guillemj</b> (subscriber, #49706)
                              [<a href="/Articles/849805/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, that brought up old memories of viengoos (<a href="https://git.savannah.gnu.org/gitweb/?p=hurd/viengoos.git;a=blob;f=libviengoos/viengoos/folio.h;hb=HEAD">https://git.savannah.gnu.org/gitweb/?p=hurd/viengoos.git;...</a>).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849805/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor849806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 4:10 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/849806/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
New version of patch series:<br>
<p>
<a href="https://git.infradead.org/users/willy/pagecache.git/shortlog/refs/heads/folio">https://git.infradead.org/users/willy/pagecache.git/short...</a><br>
<p>
I&#x27;ll do the changelog / cover letter / ... in the morning.<br>
<p>
<p>
BTW, I do want to emphasize that real workloads see a performance improvement.  With the previous work, based on using Transparent Huge Pages, we saw a 7% performance improvement on kernel compiles, and that was with a very naive untuned algorithm for scaling up the THP size.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849821"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 9:12 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/849821/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Rather than doing everything in one go, couldn&#x27;t a transparent union argument type and _Generic be used, variously, for certain critical functions and highly-trafficked interfaces? I image much of the performance improvements come from a relatively small subset of the changes. Those could be nailed down in a smaller patch series, and the remainder fixed over time.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849821/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849826"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 11:29 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/849826/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Have you looked at the patch series?  I don&#x27;t do everything in one go.  Essentially I&#x27;m going one function at a time.  It&#x27;s pretty straightforward to convert between pages and folios.  If you have a page and want the folio that contains it, that&#x27;s spelled page_folio(page).  If you have a folio and want the head page, that&#x27;s &amp;folio-&gt;page.  If you have a folio and want the page that corresponds to a particular file index, that&#x27;s folio_file_page(folio, index).<br>
<p>
If you have a folio and want the n&#x27;th page, that&#x27;s nth_page(&amp;folio-&gt;page, n).  Nobody&#x27;s needed that one yet (and only people with really weird physical memory layouts need to do that ... alloc_folio() won&#x27;t return a folio that you need to do that to.  Others are working on maybe disallowing those from existing entirely, in which case (&amp;folio-&gt;page + n) will do fine.<br>
<p>
The performance improvements do not come from a small subset of the changes.  You have to make the entire filesystem safe to handle memory in folios (no more references to, eg, PAGE_SIZE, unless you can prove they&#x27;re safe, calls to kmap() have to be scrutinised.  copy_(to|from)_iter() calls need care and attention, etc, etc).  Once the filesystem declares itself safe by setting a bit in the fs_flags then the page cache can start handing it folios instead of pages.<br>
<p>
I think what you&#x27;re suggesting is essentially what I did here:<br>
<a href="https://git.infradead.org/users/willy/pagecache.git/shortlog/refs/tags/thp-5.10-rc1">https://git.infradead.org/users/willy/pagecache.git/short...</a><br>
<p>
I&#x27;ve given up on that approach because it&#x27;s hard to find all the bugs.  &quot;Oh this interface takes a struct page.  Does it take any struct page, or do I need to call it once for each tail page in the compound page?&quot;  I invite you to consider the various implementations of flush_dcache_page() ... and if you can figure out the answer, please let me know.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849826/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor850606"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 25, 2021 23:00 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/850606/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
7% is pretty impressive, considering that getting any performance improvement out of the mm code in this day and age is like drawing blood from a stone! <br>
<p>
I vaguely remember getting excited over the original THP patchset because I&#x27;d measured a consistent 3-4% improvement in memory-heavy workloads…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/850606/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor849848"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 14:08 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/849848/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m confused.  It&#x27;s a compound page, why not call it compound_page?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849848/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849873"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 16:57 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/849873/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are you suggesting calling it &#x27;struct compound_page&#x27;?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849873/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849874"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 17:01 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/849874/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not?            <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849874/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849875"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 17:02 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/849875/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because that&#x27;s an extra 9 characters over &#x27;struct page&#x27;.  Short is generally better for something that&#x27;s common.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849875/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor849877"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2021 17:16 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/849877/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well then, I must respectfully disagree.  IMO, the obvious name should not be ignored because it is &quot;too long&quot;.  This is not the 1960s, we can afford clarity of naming in code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849877/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor850134"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 22, 2021 23:48 UTC (Mon)
                               by <b>milesrout</b> (subscriber, #126894)
                              [<a href="/Articles/850134/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn&#x27;t matter one bit which year it is. This &quot;oh my god it&#x27;s 2021 come on people&quot; attitude is really silly. Long names are inconvenient to read and to write, and encourage code to be split over many lines to fit regardless of how many years it&#x27;s been since Jesus was born.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/850134/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor869350"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 16, 2021 8:10 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/869350/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Names need to be long enough to distinguish the thing named from other things it might otherwise have been and (if you exercise any foresight) also things it will not be.<br>
<p>
How long that name needs to be depends on the scope of the names.<br>
<p>
In C, lacking any mechanism for namespacing, a practical name *often* must be unpleasantly long. That is a fault of the language, not (usually) of the person choosing the name; although some people confuse names with specifications, and so invent stupidly long names. <br>
<p>
&quot;Compound_page&quot; is not, in any universe, stupidly long for a C struct tag.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/869350/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor849974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 21, 2021 20:38 UTC (Sun)
                               by <b>kiryl</b> (subscriber, #41516)
                              [<a href="/Articles/849974/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is not a compound page, but rather a head of compound page or a non-compound page. Compound page would be totally misleading.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/849974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor859780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 15, 2021 12:23 UTC (Tue)
                               by <b>DavideRepetto</b> (guest, #152795)
                              [<a href="/Articles/859780/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about &quot;bundle&quot;?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/859780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor864966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 3, 2021 8:40 UTC (Tue)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/864966/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds like folio is basically what Haskell or Rust would call a newtype over page that indicates that certain precondition checks have already been performed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/864966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor868980"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 12, 2021 9:37 UTC (Sun)
                               by <b>deepfire</b> (guest, #26138)
                              [<a href="/Articles/868980/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Bingo!<br>
<p>
..and it&#x27;s surprising how much resistance does this encounter, given the improvements.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/868980/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1015495"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 26, 2025 15:42 UTC (Wed)
                               by <b>fest3er</b> (guest, #60379)
                              [<a href="/Articles/1015495/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Late, but have to add me tuppence, recalling the proverbial bit bucket that sat on the floor next to mainframes of old.<br>
<p>
'Bucket-o-bytes', which shortens to 'bob'.<br>
<p>
And Bob's yer uncle.<br>
<p>
OK. Maybe not.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1015495/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor873113"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 16, 2021 9:05 UTC (Sat)
                               by <b>hidave</b> (subscriber, #18406)
                              [<a href="/Articles/873113/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another recommendation maybe not known in English world : juan, it means something like &quot;volume&quot;<br>
<a href="https://en.wikipedia.org/wiki/Juan">https://en.wikipedia.org/wiki/Juan</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/873113/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor873114"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Clarifying memory management with page folios</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 16, 2021 10:24 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/873114/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed, almost nobody in the Anglosphere is going to think of a word from any of the languages of China when they see &quot;juan&quot;.<br>
<p>
If anything comes to mind at all, it&#x27;s most likely to be the Spanish form of the Hebrew name יוֹחָנָן‎ (Yôḥānān), equivalent to English John, German Johann, Russian Иван, French Jean, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/873114/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
