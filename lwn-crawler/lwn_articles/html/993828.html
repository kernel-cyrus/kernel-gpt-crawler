        <!DOCTYPE html>
        <html lang="en">
        <head><title>Kernel optimization with BOLT [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/993828/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/995491/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/993828/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Kernel optimization with BOLT</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>October 25, 2024</br>
           <hr>
<a href="/Archives/ConferenceIndex/#Linux_Plumbers_Conference-2024">LPC</a>
</div>
<p>
A pair of talks in the <a
href="https://lpc.events/event/18/sessions/180/#20240918">toolchains
track</a> at the <a
href="https://lpc.events/event/18/page/224-lpc-2024-overview">2024 Linux
Plumbers Conference</a> covered different tools that can be used to
optimize the kernel.  First up was Maksim Panchenko to describe the <a
href="https://github.com/llvm/llvm-project/tree/main/bolt#bolt">binary
optimization and layout tool</a> (BOLT) that Meta uses on its production
kernels.  It optimizes the kernel binary by rearranging it to improve its
code locality for
better performance.  A <a href="/Articles/995397/">subsequent article</a> will cover the second talk, which
looked at  <a
href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45290.pdf">automatic
feedback-directed optimization</a> (AutoFDO) and other related techniques
that are used to optimize Google's kernels.
</p>

<p>
Panchenko began with a slide
showing a handful of companies and projects that use BOLT, which can be
seen in his <a
href="https://lpc.events/event/18/contributions/1921/attachments/1465/3154/BOLT%20for%20Linux%20Kernel%20LPC%202024%20Final.pdf">slides</a>
or the
<a href="https://www.youtube.com/watch?v=p-u3e-1frnw&t=57s">YouTube
video</a> of the talk.  It was designed
at first for large applications at Meta, but it turned out to also
accelerate compilers.  So, for example, it is used by Python since version&nbsp;3.12; it is also used by LLVM, Rust, and others.
</p>

<p>
If you look back to ten years ago in the open-source world, getting the
maximum performance  from an application was a
matter of using GCC or Clang with <tt>-O3</tt>, <a
href="https://en.wikipedia.org/wiki/Profile-guided_optimization">profile-guided
optimization</a> (PGO), and <a
href="https://en.wikipedia.org/wiki/Interprocedural_optimization">link-time
optimization</a> (LTO).  But applying PGO was "<q>kind of painful</q>", he
said, so only those who cared a lot about performance were using it.
Applying PGO to the kernel was even more painful, so most companies just used
<tt>-O2</tt> or <tt>-O3</tt> on their kernels.
</p>

<p>
The main Meta application is a virtual machine running PHP code; around&nbsp;2015, developers there came up with the idea of a binary optimizer that
would work with both GCC and Clang to speed up the generated code.  BOLT
turned out to exceed developers' expectations;
it gave large gains and was able to accelerate the compilers themselves.
It has been used at Meta since&nbsp;2016; "<q>most of the cycles are spent in
binaries optimized by BOLT</q>" throughout the Meta fleet.  BOLT was
released as open source, under the Apache&nbsp;2.0 license, in&nbsp;2018 and has been part of LLVM since&nbsp;2022.
</p>

<a href="/Articles/995370/">
<img src="https://static.lwn.net/images/2024/lpc-panchenko-sm.png" border=0 hspace=5 align="left"
alt="[Maksim Panchenko]" title="Maksim Panchenko" width=239 height=280>
</a>

<p>
Generally, developers think about how the data structures for their programs will be
arranged in memory; it is less common for them to consider how the code
is arranged.  There are exceptions, including the Linux kernel developers,
but most times the focus is on the data cache.  The instruction cache is
much smaller than the data cache and has not grown much over time,
maybe doubling from 32KB to 64KB on Intel CPUs over the last 20&nbsp;years.
But, for large applications that do not spend most of their time in tight
loops, the layout of code in memory matters a lot, so BOLT can make a major
difference, he said.
</p>

<p>
Compilers do not have enough information to optimally place code, even when
they have profiling information; it turns out that inlining functions
changes the profile.  The profile information may point to a function
<tt>foo()</tt> that is called a lot, but when it is inlined, that
information is not present.  BOLT operates on the binary to observe the
code that is being frequently executed so that all of it can be placed
close together in memory. Once the <a
href="https://research.facebook.com/publications/bolt-a-practical-binary-optimizer-for-data-centers-and-beyond/">BOLT
paper</a> was released in&nbsp;2019, he said, other efforts, including
<a
href="https://research.google/pubs/propeller-a-profile-guided-relinking-optimizer-for-warehouse-scale-applications/">Propeller</a>, have come about; they are generally tied to a single toolchain,
though, while BOLT can be used with GCC or Clang and with different
linkers.
</p>

<p>
He showed a sort of heat map of the memory layout of the <a
href="https://hhvm.com/">HHVM</a> runtime, which is what is used by Meta
for most of its workloads.  One image showed hot code spread
all over, while the post-BOLT image showed all of the hot code
confined to the same small region of memory.  That drastically reduces
instruction-cache misses, translation-lookaside buffer (TLB) misses, and
CPU time; for HHVM, BOLT produced a 7%&nbsp;performance increase, Panchenko said.
</p>

<p>
BOLT is a post-link optimizer that runs on ELF binaries, such as
<tt>vmlinux</tt>.  Even though it is part of the LLVM project, BOLT still
supports GCC code; it also supports the "<q>most popular</q>"
architectures: x86_64, Arm64, and RISC-V.
</p>

<p>
Applying BOLT to the kernel took some time, mostly in the form of ensuring
that the resulting kernel would run and not crash.  One of the big problems
encountered was in finding a good benchmark to use to measure the impact of
BOLT.  There are lots of different micro-benchmarks available, but "<q>I
couldn't find any scalable, large-scale benchmark</q>".  In the end, he
used the <a
href="https://github.com/facebook/rocksdb/wiki/Benchmarking-tools">RocksDB
db_bench fillseq</a> benchmark, which showed a 2.5%&nbsp;improvement just by
switching to a BOLT-optimized kernel.  He and others at Meta ran one
of the company's main services on a BOLT-optimized kernel that produced a 2%&nbsp;queries-per-second (QPS) improvement, "<q>which was quite significant</q>". 
</p>

<p>
BOLT only changes branches and the location of the <a href="https://en.wikipedia.org/wiki/Basic_block">basic blocks</a> in the
binary to achieve its improvements.  Most of the time, there is no need to
recompile applications in order to apply BOLT; the exception is for
programs built with <a
href="https://lists.llvm.org/pipermail/llvm-dev/2020-August/144012.html">split
functions</a>, which BOLT can do better than the compiler.  The application
does need to be relinked in order to produce relocation information.  With
that, and a profile of the kernel running a representative workload, BOLT
will only take around four seconds to optimize <tt>vmlinux</tt>, he said.
</p>

<p>
The profile can be generated with a variety of mechanisms, including the
last branch record (LBR) feature on Intel platforms and similar
branch-sampling features on other architectures.  If that is not available,
the code can be instrumented to gather the needed information, but that has
higher overhead than using LBR and the like.  There are other options, but
the profile quality, thus the BOLT optimizations, will not be as good.
</p>

<p>
BOLT needs an unstripped <tt>vmlinux</tt> binary because it uses the symbol
names for code discovery, Panchenko said.  BOLT can easily identify the
boundaries of code and data in the ELF binary using the text and data
segments that are defined.  The segments are further divided into sections
and BOLT uses the symbol-table information to identify the individual
functions therein.
</p>

<p>
Then BOLT disassembles the functions, though, unlike <a
href="https://man7.org/linux/man-pages/man1/objdump.1.html">objdump</a>,
it will "<q>symbolize the operands of the instructions</q>".
Distinguishing between constants and addresses in the instructions
can be a problem, however.  The relocation information that is inserted by the
linker helps with that; it can be used to "<q>effectively do symbolic
disassembly</q>" of the code.  
</p>

<p>
The resulting instruction stream can be optimized
using normal techniques, such as peephole optimization, but "<q>this is not
very efficient</q>".  In order to do more optimizations on the code, an
intermediate representation (IR) of some kind is needed. The IR used is
"<q>essentially a control-flow graph on top of MC instructions</q>",
Panchenko said; he was referring to the <a
href="https://blog.llvm.org/2010/04/intro-to-llvm-mc-project.html">LLVM
machine code (MC) project</a>, which provides a number of tools and
libraries that BOLT uses.  The instructions look much like the assembly
code, but some may be annotated or modified to identify tail calls versus
other kinds of jumps, for example. "<q>So if you look at BOLT disassembly,
you will have a much better idea of what's happening in your application
compared to regular objdump</q>".
</p>

<p>
BOLT uses the profile information for the basic blocks in the control-flow graph
in order to determine where the hot code resides.  To make the best
code-layout decisions, though, having weights on the edges, rather than
just execution counts for the basic blocks, would be useful.  The LBR
profiling can provide that information, but BOLT can recover some
information about edge weights even without it.
</p>

<p>
Then the graph is used to optimize the code; "<q>The main optimization that 
gives us most of the gains is code reordering.</q>"  The basic blocks can
be grouped together to reduce the instruction-cache footprint of the code.
That is done by breaking up the functions into fragments, some of which are
hot code and others that are rarely or never executed (e.g. error-handling
code).  Compilers already do reordering, but on the function level; BOLT
takes it one step further and reorders these function fragments.
</p>

<p>
Once the new code is generated, there is a question about where to put it,
he said.  Unless there is a big concern about disk space, it is more efficient to simply create a new text segment that
contains the hot code, which will generally be quite a bit smaller (for a
binary that is huge, "<q>hundreds of megabytes</q>", 20MB or less of hot
code would end up in the new segment).  So it is not much overhead, in
terms of disk space, and "<q>you get a <i>much</i> faster
application</q>".
</p>

<p>
Adding another
text segment to the kernel binary may not be viable, he said, so he turned
to an alternative that is "<q>much more feasible</q>".
BOLT
will simply rewrite the existing functions in the binary; those functions are already
ordered by the compiler based on its analysis, so BOLT effectively uses
that.  BOLT could do a bit better function ordering based on the profile, but
that small gain can be sacrificed in order to easily get the basic-block
reordering, he said.  It also helps avoid over-specializing the code for
only the workload measured by the profile; for other workloads that were
not measured, some of the cold code will be executed, but it will still be
located nearby due to the compiler choices.
</p>

<p>
The kernel provides other challenges, because its code is modified at boot
time and also while it is running.  He spent a good chunk of the talk going
into the details of how that type of code is handled.  Things like static
calls,
SMP locks (that are patched out on uniprocessor systems), static keys, and alternative instructions for different
subarchitectures are handled with annotations in the disassembled code, which
is part of the metadata that BOLT uses to do its job.  For some, BOLT
simply does not operate on them, while others have mechanisms that the
optimizer can use on them.  All of that metadata can be dumped using BOLT tools.
</p>

<p>
Panchenko said that he was skipping over some topics, such as continuous
profiling, which can be applied to BOLT-optimized binaries as they run;
a new version of a binary can be produced that will reflect changes
in the code and the workload.  He also did not cover any of the other
optimizations that BOLT applies.  He finished by showing some of the output
that running BOLT produces, noting that a four-second demo of it operating would
not be all that interesting.
</p>

<p>
[ I would like to thank LWN's travel sponsor, the Linux Foundation, for
travel assistance to Vienna for the Linux Plumbers Conference. ]
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Optimization_tools">Optimization tools</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Linux_Plumbers_Conference-2024">Linux Plumbers Conference/2024</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/993828/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor995882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2024 0:33 UTC (Sat)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/995882/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It only took 25 years to replace<br>
<p>
<a href="https://lwn.net/1998/1029/als/rope.html">https://lwn.net/1998/1029/als/rope.html</a><br>
<p>
(Not sure why it never got released ...)<br>
<p>
And, damn, that name and the "jokes" being made ... I think we're a bit better now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor995903"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2024 8:08 UTC (Sat)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/995903/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Alan Cox has grabbed Miguel and forced him to sit down. The two of them are heading to the front. Apparently the harassment in the hallway had reached too high a level. No! He's escaped! </span><br>
<span class="QuotedText">&gt; "rope" is a pun on "cord" but then creates a great word combined with GNU</span><br>
<p>
yeah this whole thing is just one yikes after another. jesus christ. As uncomfortable as I still am visiting events like this today, at least it's no longer... whatever this is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995903/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor995905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2024 9:06 UTC (Sat)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/995905/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And the problem with these “uncomfortable” “yikes” “whatever this is”, besides people having apparently light-hearted fun, is exactly… what?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor995906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2024 9:22 UTC (Sat)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/995906/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sorry, if your idea of "lighthearted fun" is getting "harassed" (direct quote) and physically assaulted into watching a presentation about how proud the author is about his sexual assault joke, I'd like to please stay as far away from you as possible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor995907"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2024 10:01 UTC (Sat)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/995907/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is nothing the quote or in the original text that would suggest that any kind of _actual_ harasssment, "physical assault", or, worse, "sexual assault" has taken place.<br>
<p>
<span class="QuotedText">&gt; I'd like to please stay as far away from you as possible.</span><br>
<p>
The feeling is thus mutual.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995907/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor996087"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2024 14:33 UTC (Mon)
                               by <b>LtWorf</b> (subscriber, #124958)
                              [<a href="/Articles/996087/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Moralists never have fun, so hold a grudge against others who have fun instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/996087/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor996169"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2024 10:13 UTC (Tue)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/996169/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it is very amusing how fast I flip from being a filthy degenerate that must be kept away from society for their debauchery to a funless prude as soon as I impinge on peoples Sacred ability to make rape "jokes" and non-consenually touch people at conferences. Oh well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/996169/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor997259"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 6, 2024 23:35 UTC (Wed)
                               by <b>cmkrnl</b> (guest, #59973)
                              [<a href="/Articles/997259/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would have sounded lighthearted and witty to a close-knit group of young people in 1998, but today it just sounds juvenile an immature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997259/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997297"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Grope</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 7, 2024 15:15 UTC (Thu)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/997297/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The free software community in 1998 was largely young people - from late teen students to 30-somethings (Linus was 29). So they're now in their 40s to 60s.<br>
<p>
I.e., the set of young people who enjoyed mildly vulgar/shocking-to-norms puns then, are mostly the same set of people as the older set who today find it juvenile.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997297/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor995909"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Intriguing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2024 12:35 UTC (Sat)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/995909/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would seem like there are now quite an array of tools for optimising in various ways.<br>
<p>
But one optimisation can potentially interact with another optimisation, and optimal binary reordering may be affected by compiler optimisation which may in turn be potentially affected by optimal binary reordering.<br>
<p>
I'm trying to figure out from this article how, exactly, you get the most out of this.<br>
<p>
I'd also be intrigued to know if this technique could be used effectively with the Verified Software Toolchain. VST is fine for producing provably correct binaries, but there's obvious drawbacks to this - there's not a whole lot of optimising you can do and still be certain the binaries are correct.<br>
<p>
If you can greatly accelerate VST-produced binaries without impacting the proof of correctness in any way, I could imagine scenarios where this could actually be useful.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995909/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Intriguing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 6, 2024 12:41 UTC (Wed)
                               by <b>rolandog</b> (subscriber, #151303)
                              [<a href="/Articles/997126/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm also curious as to whether BOLT is smart enough to distinguish functions that need to run in constant time to prevent timing attacks.  (Gotta watch the presentation, though... Maybe it's addressed there).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor995941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Other BOLT weirdness</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2024 4:35 UTC (Sun)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/995941/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is some other BOLT behavior that derives from its use for HHVM: it can replace functions that use AVX512 intrinsics with traps.  This is probably not useful for anyone aside from HHVM.<br>
<p>
<a href="https://github.com/llvm/llvm-project/blob/7b88e7530d4329ff0c7c8638f69b39fa1e540218/bolt/docs/CommandLineArgumentReference.md?plain=1#L352-L355">https://github.com/llvm/llvm-project/blob/7b88e7530d4329f...</a><br>
<p>
Also, this is ... kind of insane, for library source code?  You can use the compile-time feature detection support and identify the compiler target supports AVX512 (-mavx512 or whatever).  You can use runtime cpuid feature bit detection and identify the running CPU supports AVX512.  But if your binaries have been though BOLT with the -trap-avx512 flag, your AVX-accelerated function will just trap with a ud2 instruction.<br>
<p>
If you find yourself needing to detect, at runtime, this BOLT bastardization of the binary, this ugly hack seems to work: <a href="https://github.com/facebook/folly/blob/d5e10f9d076838374fb7458fa25844ea93e3538f/folly/detail/TrapOnAvx512.cpp#L32-L34">https://github.com/facebook/folly/blob/d5e10f9d076838374f...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor995942"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Other BOLT weirdness</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2024 5:57 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/995942/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  You can use runtime cpuid feature bit detection and identify the running CPU supports AVX512</span><br>
<p>
AVX-512 is stupid. It doesn't work on efficiency cores on Alder Lake. Even though P-cores support it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995942/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor995944"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Other BOLT weirdness</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2024 6:59 UTC (Sun)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/995944/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; AVX-512 is stupid. It doesn't work on efficiency cores on Alder Lake</span><br>
<p>
Perhaps it rather means that Alder Lake is stupid?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/995944/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor996727"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Other BOLT weirdness</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 1, 2024 18:20 UTC (Fri)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/996727/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The P-cores of Alder Lake don't support AVX-512 (implemented but disabled), either, unless you are using some early firmware.  It's a pity that Intel completely disabled that, even in Xeon-E24xx CPUs where the E-cores are disabled.  But don't worry, buy an AMD CPU with a Zen4 or Zen5 core, and you will get AVX-512.


      
          <div class="CommentReplyButton">
            <form action="/Articles/996727/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor996729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Cache sizes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 1, 2024 18:46 UTC (Fri)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/996729/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      The claims made in the article (maybe in the talk) about cache sizes are mostly wrong.

<p>I-cache and D-cache typically have similar size, and if they differ, it's not always the D-cache that is larger.  E.g., Zen4 has 32KB I-cache and 32KB D-cache, Zen5 and Raptor Cove have 32KB I-cache and 48KB D-cache, and Gracemont has 64KB I-cache and 32KB D-cache.

<p>The sizes of L1 caches generally have not grown in the last 20 years; e.g., the 2003 Athlon 64 has 64KB I-cache and 64KB D-cache, and the 2003 Pentium M has 32KB I-cache and 32KB D-cache.  Instead, they have added an L3 cache since that time. A number of cores have a microoperation cache in addition to the I-cache, but the sizes are hard to compare.



      
          <div class="CommentReplyButton">
            <form action="/Articles/996729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor996840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Cache sizes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 4, 2024 10:45 UTC (Mon)
                               by <b>paulj</b> (subscriber, #341)
                              [<a href="/Articles/996840/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hell, the AMD *K6* had 32 KiB I and D cache!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/996840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor996963"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Cache sizes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 4, 2024 23:48 UTC (Mon)
                               by <b>himi</b> (subscriber, #340)
                              [<a href="/Articles/996963/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Out of curiosity, how much of that is because larger I and D caches didn't provide as much of a gain as increasing L3 caches? Particularly since the L1 caches are tightly coupled to each core rather than shared across the ever-increasing number of cores - devoting transistors to increasing L1 caches is going to have a very different cost/benefit mix than devoting them to more computational units or shared caches . . .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/996963/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor996978"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Cache sizes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 5, 2024 8:06 UTC (Tue)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/996978/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      The L2 cache of many cores is dedicated to the core, too (e.g., on Intel's P-cores for over a decade and on AMD's Zen-Zen5 cores).

<p>The reason for keeping the L1 cache small is latency.  If the cache grows, the miss rate decreases, but the latency increases.  You can see the longer latency nicely in the comparison of L2 sizes and latencies in <a href="https://old.chipsandcheese.com/2024/09/27/lion-cove-intels-p-core-roars/">this article</a>.

<p>One reason is that the wires get longer, which increases the time that signals travel. 

<p>You also want to use a virtually-indexed physically-tagged (VIPT) cache as L1 cache, which allows to perform the TLB access and the cache access in parallel, i.e., with low latency.  But that means that the size of a cache way is at most as large as a page; the number of ways is limited (you typically don't see more than 16-way set-associative caches, and a lower number of ways is common in L1 caches), the page size is 4KB on AMD64, which limits the L1 cache sizes to 64KB (and 32KB or 48KB is more common).  Apple's Firestorm (M1 P-core) has larger caches (192KB I-cache, 128KB D-cache), but also 16KB pages, which allows a VIPT cache implementation with a 12-way (I) or 8-way (D) set-associative cache.




      
          <div class="CommentReplyButton">
            <form action="/Articles/996978/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997481"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Cache sizes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 14:42 UTC (Fri)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/997481/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Some of what you describe is the fact that while software people sort of sort of imagine the computer operates in a virtual realm of abstract logic, hardware is actually a physical electrical device and you can't just abstractly put "more cache" on it the way you could refactor a software program because of the physical reality of electrical circuits and wiring that is the computer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997481/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
