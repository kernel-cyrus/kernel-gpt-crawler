        <!DOCTYPE html>
        <html lang="en">
        <head><title>A generic ring buffer for the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/976836/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/977366/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/976836/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A generic ring buffer for the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>June 6, 2024</br>
           </div>
The kernel's user-space ABI does not lack for ring buffers; they have been
defined for subsystems like <a
href="https://docs.kernel.org/6.6/bpf/ringbuf.html">BPF</a>, <a
href="/Articles/776703/">io_uring</a>, <a
href="https://docs.kernel.org/next/userspace-api/perf_ring_buffer.html">perf</a>,
and <a
href="https://docs.kernel.org/trace/ring-buffer-map.html">tracing</a>, for
example.  Naturally, each of those ring buffers is unique, with no common
interface between them.  The natural response to this ABI proliferation is,
of course, to add yet another ring buffer as the generic option; that is
the intent of <a
href="/ml/linux-kernel/20240603003306.2030491-1-kent.overstreet@linux.dev">this
patch series</a> from Kent Overstreet adding a new set of system calls for
ring buffers.
<p>
A ring buffer is simply a circular buffer, maintained in memory, that is
shared between user space and the kernel.  One side of a data stream writes
data into the buffer, while the other consumes it; as long as the buffer
neither overflows nor underflows, data can be transferred with no system
calls at all.  The addition of a ring buffer can, thus, enable highly
efficient data transfer in situations where the data rates are relatively
high.  Overstreet thinks that other kernel subsystems could benefit from
ring-buffer interfaces, and would like to make it possible to add those
interfaces without reinventing the wheel.
<p>
<h4>The user-space interface</h4>
<p>
On the user-space side, with the proposed interface, a ring buffer is
always associated with a file descriptor, so the first step will be to open
the object (such as a file, a device, or a pipe) to which the ring buffer
will be attached. Then, the ring buffer is established with the new
system call:
<p>
<pre>
    int ringbuffer(unsigned int fd, int rw, u32 size, void **buffer);
</pre>
<p>
This call will request the creation of a ring buffer associated with the
open file descriptor <tt>fd</tt>; the <tt>rw</tt> should be set to zero for
read access, or anything else for write.  The requested size of the buffer
is passed in <tt>size</tt>.  On a successful return, the address for the
buffer will be stored in <tt>buffer</tt>.
<p>
Note that it is up to the subsystem implementing the ring buffer to decide
whether to respond to this call by creating a new buffer, or by mapping an
existing buffer into the caller's address space.  The intent in the latter
case is to allow a single ring buffer to be shared between multiple
processes.
<p>
There is no <tt>flags</tt> argument in this version of the system call;
that seems likely to change before any eventual merging into the mainline. 
<p>
The returned pointer will be aimed at a region of memory starting with a
copy of this structure:
<p>
<pre>
    struct ringbuffer_ptrs {
	__u32		head;
	__u32		tail;
	__u32		size;	/* always a power of two */
	__u32		mask;	/* size - 1 */
	__u32		data_offset;
    };
</pre>
<p>
The buffer itself will begin at <tt>data_offset</tt> from the returned
pointer; in practice, that offset will likely always be one page.  The
actual size of the buffer will be stored in <tt>size</tt>; as noted, it
will always be a power of two for reasons that will soon become clear.  The
<tt>head</tt> offset is the writing position, while <tt>tail</tt> is the
read position.  If <tt>head</tt> and <tt>tail</tt> are equal, the buffer is
empty.
<p>
Both <tt>head</tt> and <tt>tail</tt> are incremented unconditionally when
data is added or consumed; there are no tests for wrapping around.
Instead, these values must be ANDed with the <tt>mask</tt> value to obtain
an actual offset into the buffer.  This technique eliminates the need for
branches in the increment path, but it also means that a little care is
needed when working with the head and tail values.  Testing for emptiness
is easy, since the two values will always be equal in this case.  A proper
test for fullness looks like:
<p>
<pre>
    if ((head - tail) &gt;= size)
        /* buffer is full, can't write to it */
</pre>
<p>
(This test has been simplified; a properly written test must use atomic
operations to avoid memory-ordering problems; see <a
href="/ml/linux-kernel/20240603003306.2030491-6-kent.overstreet@linux.dev">this
test program</a> for an example).
<p>
A process writing to a ring buffer can continue to feed data into it until
the buffer fills, at which point it must stop.  The writer could poll the
<tt>tail</tt> value to detect when the reader has caught up and more space
is available, but that would not be efficient.  A similar situation applies
to a reader that has emptied the buffer.  Either way, the process can wait
for the situation to change with:
<P>
<pre>
    int ringbuffer_wait(unsigned int fd, int rw);
</pre>
<p>
Where <tt>fd</tt> is the file descriptor associated with the ring buffer,
and <tt>rw</tt> indicates whether read or write access is needed.  Either
way, the calling process will block until the situation with the ring
changes.  Indicating such a change is the responsibility of user space as
well; a writer that has put data into a previously empty buffer, or a
reader that has consumed data from a previously full buffer should call:
<p>
<pre>
    int ringbuffer_wakeup(unsigned int fd, int rw);
</pre>
<p>
In the cover letter, Overstreet suggests that <tt>ringbuffer_wait()</tt>
and <tt>ringbuffer_wakeup()</tt> might eventually be replaced with futex
operations.  <a
href="/ml/linux-kernel/20240603003306.2030491-4-kent.overstreet@linux.dev">This
patch</a> also mentions the need to improve <tt>ringbuffer_wait()</tt> to
allow for a timeout or to specify the minimum amount of data that must be
written to (or read from) the buffer before a wakeup should happen.
<p>
<h4>The kernel side</h4>
<p>
To add ring-buffer support to a subsystem, the new <tt>ringbuffer()</tt>
function in the <tt>file_operations</tt> structure should be provided:
<p>
<pre>
    struct ringbuffer *(*ringbuffer)(struct file *file, int rw);
</pre>
<p>
This function will be called in response to a <tt>ringbuffer()</tt> call
from user space.
There is a whole set of meticulously undocumented support functions
available to drivers for working with ring buffers, including
<tt>ringbuffer_alloc()</tt> to create one, <tt>ringbuffer_read_iter()</tt>
and <tt>ringbuffer_write_iter()</tt> to move data out of or into a ring
buffer, etc.  <a
href="/ml/linux-kernel/20240603003306.2030491-5-kent.overstreet@linux.dev">This
patch</a> provides a test driver showing the basics of implementing a ring
buffer in kernel space.
<p>
Other than the test device, there are no in-kernel users submitted with
this patch set.  In the cover letter, Overstreet says that the first such
user will be the filesystems in user space (FUSE) subsystem, but pipes and
sockets may follow thereafter.  The performance benefits of the ring-buffer
approach are said to be significant: "<q>reading/writing from the
ringbuffer 16 bytes at a time is ~7x faster than using read/write
syscalls</q>".
<p>
As of this writing, there have been no responses to this submission.  This
work is in an early state and seems likely to need to evolve somewhat
before it could be considered for merging; developers are also likely to
want to see a real user in the kernel.  Even more interesting might be a
demonstration of how some of the existing kernel ring-buffer interfaces
could have been implemented using this abstraction (not that they will
change now). If this work achieves its goals, it might, in a highly
optimistic view, be the last ring-buffer interface added to the
kernel.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-ringbuffer">System calls/ringbuffer()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/976836/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor977466"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XKCD Standards?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 17:41 UTC (Thu)
                               by <b>andy_shev</b> (subscriber, #75870)
                              [<a href="/Articles/977466/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Obligatory reference to XKCD #927.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977466/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977503"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XKCD Standards?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 22:08 UTC (Thu)
                               by <b>devnull13</b> (subscriber, #18626)
                              [<a href="/Articles/977503/">Link</a>] 
      </p>
      
      </div>
      </summary>
      https://xkcd.com/927/


      
          <div class="CommentReplyButton">
            <form action="/Articles/977503/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XKCD Standards?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 9:25 UTC (Fri)
                               by <b>bojan</b> (subscriber, #14302)
                              [<a href="/Articles/977525/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No LOTR reference? One ring (buffer) to bind them...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977536"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LOTR reference</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 12:48 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/977536/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The working title for this article was exactly that, but then I realized that <a href="/Articles/388978/">we had already used it</a> back in 2010.


      
          <div class="CommentReplyButton">
            <form action="/Articles/977536/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977578"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XKCD Standards?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 14:28 UTC (Fri)
                               by <b>MortenSickel</b> (subscriber, #3238)
                              [<a href="/Articles/977578/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One ring to buffer them all<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977578/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor977473"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fuse</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 18:25 UTC (Thu)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/977473/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wasn't committing to doing fuse myself, pipes are the more interesting one to me, but now that Jon's committed me I guess I'll have to follow through :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977473/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977483"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">fuse</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 18:31 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/977483/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Hey, I like how that works.  I have a whole long list of other things to add to your dance card in the near future :)


      
          <div class="CommentReplyButton">
            <form action="/Articles/977483/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977488"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Meticulously undocumented</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 19:30 UTC (Thu)
                               by <b>sdalley</b> (subscriber, #18550)
                              [<a href="/Articles/977488/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'll bet that list includes plenty of documentation items...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977488/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor977489"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Flags</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 19:46 UTC (Thu)
                               by <b>randomguy3</b> (subscriber, #71063)
                              [<a href="/Articles/977489/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>There is no flags argument in this version of the system call; that seems likely to change before any eventual merging into the mainline.</blockquote>

Before I even got to this line, I was thinking that if there's anything years of reading LWN has taught me, it's that system calls should have flags arguments, and that accepting "any other value" will cause pain in the future. So I'd guess that the "int rw" argument will become a flags argument.


      
          <div class="CommentReplyButton">
            <form action="/Articles/977489/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Flags</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 13:22 UTC (Fri)
                               by <b>rrolls</b> (subscriber, #151126)
                              [<a href="/Articles/977556/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hope so!<br>
<p>
"int rw" (which appears in not just one, but all four function signatures mentioned in this article) really just contains a boolean value, so all of these should be converted to "int flags" and a constant to indicate r/w direction.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977581"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Flags</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 15:17 UTC (Fri)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/977581/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yes, so we don't get another O_RDWR!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977581/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor977491"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Further reading on the wraparound pattern</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2024 19:58 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/977491/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This article's a pretty clear explanation (with diagrams) of how it works:<br>
<a href="https://www.snellman.net/blog/archive/2016-12-13-ring-buffers/">https://www.snellman.net/blog/archive/2016-12-13-ring-buf...</a><br>
<p>
There's a link in there to a lkml thread from 2004, and it may be even older than that given how it's mentioned in an offhand way there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977491/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A generic ring buffer - increment size and mutiple readers and or writters</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 8:23 UTC (Fri)
                               by <b>ppisa</b> (subscriber, #67307)
                              [<a href="/Articles/977519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In general, ring buffer API has sense and is solution for many lock less designs. But I miss the increment size in the shared header. Even if the buffer is intended only to pass pointer referring to other location then there is problem that variants for 32-bit user-space handling on 64-bit system has to be solved by kernel or the ring buffer needs to store only offsets into another mapped region.<br>
<p>
Another problem are multiple readers and writers,  because only hardware transactional memory support allows to keep write of pointer/offset increment to ringbuffer_ptrs-&gt;head and write of data to previous head location atomically in respect of other writers CPUs. If the writer is limited to single thread, then it is not a problem, writer check for size, then writes data and the last step is head increment in memory model release mode.<br>
<p>
Even more complicated is case when multiple writers and variable size of the data are allowed and puzzle gets even more interesting when space allocate operation should be non blocking if there is a space or relaxed condition that allocation can be blocking but only for allocation duration but not during data fill operation which could require access to other resources which can block or memory which can be swapped out. But preventing such blocking is the must if the buffer is shared and used by tasks with different priorities and some of them fall into real-time critical domain.<br>
<p>
I have tried to solve most of above problems in my ul_cbuff implementation. Even the data area is separated from mapping of the buffer control structures which can include even required mutexes and semaphores. The implementation allows and have been tested with multiple writers from multiple tasks, the data in the buffer are visible to readers only when all previously allocated entries are released by writers. Readers can be of the categories, for one, it is guaranteed that no data are lost, that is buffer is marked as full until last of such readers releases its data, or reader can be snapshot maker who has guarantee that receives only complete available messages from the head side but does not block following writes.<br>
<p>
The system has been used for logging in critical systems like hospital infusion system based on RTEMS RTOS <a href="https://devel.rtems.org/wiki/TBR/UserApp/AMV_Technic_I">https://devel.rtems.org/wiki/TBR/UserApp/AMV_Technic_I</a> but the test code evaluated it even on GNU/Linux in multiple memory address spaces/processes environment.<br>
<p>
See the files<br>
<p>
<a href="https://gitlab.com/pikron/sw-base/ulut/-/blob/master/ulut/ul_cbuff.h">https://gitlab.com/pikron/sw-base/ulut/-/blob/master/ulut...</a><br>
<p>
<a href="https://gitlab.com/pikron/sw-base/ulut/-/blob/master/ulut/ul_cbuff.c">https://gitlab.com/pikron/sw-base/ulut/-/blob/master/ulut...</a><br>
<p>
at the repository<br>
<p>
<a href="https://gitlab.com/pikron/sw-base/ulut/-/tree/master/ulut">https://gitlab.com/pikron/sw-base/ulut/-/tree/master/ulut</a><br>
<p>
or<br>
<p>
<a href="https://sourceforge.net/p/ulan/ulut/ci/master/tree/">https://sourceforge.net/p/ulan/ulut/ci/master/tree/</a><br>
<p>
I can post even test code.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977522"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Syscall interface details</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 8:42 UTC (Fri)
                               by <b>zev</b> (subscriber, #88455)
                              [<a href="/Articles/977522/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What's the reason for the size argument to ringbuffer() being a u32 instead of something size_t-ish like unsigned long?  A &gt;4GB buffer does seem kind of huge, and I can't think of anything offhand that would need/want one, but it doesn't seem *entirely* inconceivable that something someday some years hence might have a non-absurd reason to want it.  At first I thought it might be due to needing a DCAS operation or something for operating on the members of struct ringbuffer_ptrs, but from a quick look at the example code it doesn't appear to involve anything beyond basic scalar atomics.<br>
<p>
And on a different note, would it be possible to obviate the need for an explicit ringbuffer_wakeup() operation by setting the page containing struct ringbuffer_ptrs read-only and trapping the store that updates it?  I suppose the page-table updates and fault-handling involved might end up making it slower in the case where it's actually used, but not having to explicitly check for it in the (hopefully?) common case of not needing it is at least aesthetically appealing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977522/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Portable atomics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 17:35 UTC (Fri)
                               by <b>Tobu</b> (subscriber, #24111)
                              [<a href="/Articles/977600/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>This is addressed in a comment inside the struct:
<pre>
	 * We use u32s because this type is shared between the kernel and
	 * userspace - ulong/size_t won't work here, we might be 32bit userland
	 * and 64 bit kernel, and u64 would be preferable (reduced probability
	 * of ABA) but not all architectures can atomically read/write to a u64;
	 * we need to avoid torn reads/writes.
</pre>
(from the <a href="https://lore.kernel.org/all/20240603003306.2030491-1-kent.overstreet@linux.dev/T/#u">lkml thread</a>)

<p>Apparently, u32 is atomic on architectures where u64 isn't.



      
          <div class="CommentReplyButton">
            <form action="/Articles/977600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977633"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Portable atomics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2024 18:49 UTC (Sat)
                               by <b>zev</b> (subscriber, #88455)
                              [<a href="/Articles/977633/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Okay, so u64 doesn't work because not all 32-bit machines can do 64-bit atomics...still, given the existence of 32-bit syscalls on 64-bit kernels, it seems like we could have ringbuffer32() that would use u32s where needed and let 64-bit userspace use u64?  It would complicate things a bit of course, but it seems like it might be worthwhile to avoid saddling future code with largely artificial 32-bit compat constraints.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977633/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977678"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Portable atomics</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2024 22:32 UTC (Sat)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/977678/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except you can have mixed 32 bit and 64 bit applications on a 64 bit kernel, so it'd be a problem if a 64 bit application created a ringbuffer, then a 32 bit application tried to use it.<br>
<p>
32 bits is enough; ringbuffers generally aren't supposed to be huge, they're a transport mechanism. We could add 64 bit ringbuffers, but there'd be no reason to use them most of the time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977678/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor977588"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ABI</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 16:38 UTC (Fri)
                               by <b>meyert</b> (subscriber, #32097)
                              [<a href="/Articles/977588/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder what a generic ring buffer means for ABI stability?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977588/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977595"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">stdout?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 16:59 UTC (Fri)
                               by <b>glenn</b> (subscriber, #102223)
                              [<a href="/Articles/977595/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd be thrilled to be able to send stdout to a ring buffer file in a tmpfs.  It would give me more confidence that I won't overflow my tmpfs.  Folks who want to (try) to retain the entire file could "tail -f" the ring buffer file to disk.  This approach has worked well for the ftrace buffers.  I've tried transforming and sending stdout to ftrace instance-bufers as trace markers, but the solution was pretty janky.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977595/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">stdout?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 18:00 UTC (Fri)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/977603/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have used an out-of-tree kernel module called emlog for this:<br>
<p>
<a href="https://www.circlemud.org/jelson/software/emlog/">https://www.circlemud.org/jelson/software/emlog/</a><br>
<p>
Although the site does not appear responsive at the moment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor977605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">stdout?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 18:02 UTC (Fri)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/977605/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Working link:<br>
<p>
<a href="https://github.com/nicupavel/emlog">https://github.com/nicupavel/emlog</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor977613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">stdout?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 18:59 UTC (Fri)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/977613/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
so you want to map a ringbuffer where the buffer (not the head/tail pointer page) is mapped from another file?<br>
<p>
that'd be interesting<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor977617"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">unsigned file descriptors?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2024 19:42 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/977617/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; unsigned int fd</span><br>
<p>
What's the rationale for using `unsigned` here? Is it possible to get a valid fd above 2³¹? AFAIK, all fd-creating syscalls return `int`. Why make invalid fds detectable behind a sign-change cast (or pretend that high-bit-set fd values are valid)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977617/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor977989"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">why are ringbuffers bound to an existing file descriptor?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2024 18:46 UTC (Tue)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/977989/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I apologize, if these are naive questions.<br>
<p>
Why are these ringbuffers implemented as attachments to existing file descriptors of arbitrary types and not as standalone objects which could, for example, be referenced by dedicated file descriptors of a new pseudo-filesystem? That way, epoll and friends could be used for the wait operations. I fail to see why there must be a one-to-one relation between a ringbuffer and an existing file descriptor. Is the only expected application a read/write substitute? <br>
<p>
Another question: The original motivation seems to be communication between userspace and kernelspace. But is the implementation now also a proper tool for userspace-only communication between threads? Maybe this second question clarifies the first one: Where would I get my noop-type filedescriptor which only purpose would be to hold a ringbuffer.<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/977989/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor978246"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">why are ringbuffers bound to an existing file descriptor?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 13, 2024 13:42 UTC (Thu)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/978246/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Excluding the ringbuffer_wait and ringbuffer_wait syscalls, a ringbuffer is just a region of memory.<br>
<p>
So once we switch to futex operations for wait/wake, you'll be able to make your own ringbuffer in shared memory, no kernel involvement.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/978246/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor978447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">why are ringbuffers bound to an existing file descriptor?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2024 17:12 UTC (Fri)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/978447/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks.<br>
<p>
I was just curious whether an unconventional use of the proposed ringbuffer API for userspace to userspace communication would work, assuming that whatever the kernel does with the ringbuffer for the chosen file type doesn't interfere or is taken into account. It's not sensible or needed, though, because that can be done right now and you only need help from the kernel for the non-spinning wait, e.g., via  futex, which is available. <br>
<p>
Regarding my first question, why a ringbuffer needs to be associated with a file descriptor: Do you expect ringbuffers will only be used as an alternative api to the same data channels as accessible by reading/writing the file descriptors? Is this why there is no standalone ringbuffer? Any kernel feature which supports ringbuffer communication should also support conventional I/O on the same descriptor?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/978447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor978468"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">why are ringbuffers bound to an existing file descriptor?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2024 18:52 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/978468/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are now FDs that don't support regular reading/writing. For example, pidfd().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/978468/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor980905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">thread safe?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 16:58 UTC (Fri)
                               by <b>DanilaBerezin</b> (guest, #168271)
                              [<a href="/Articles/980905/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am pretty curious as to the purpose of the atomic operations. If multiple threads are reading and writing to the same ring buffer/header, surely synchronizing the state of the head and tail elements and preventing torn reads and writes to the actual buffer is the biggest problem. A problem that, at least to my understanding, doesn't seem to be solved by simply doing atomic reads and writes to the tail and head elements. And I'm honestly not quite sure what memory reordering issues those atomic operations are even solving. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
