        <!DOCTYPE html>
        <html lang="en">
        <head><title>The &quot;too small to fail&quot; memory-allocation rule [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/627419/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/626792/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/627419/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The &quot;too small to fail&quot; memory-allocation rule</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 23, 2014</br>
           </div>
Kernel developers have long been told that, with few exceptions, attempts
to allocate memory can fail if the system does not have sufficient
resources.  As a result, in well-written code, every call to a function
like <tt>kmalloc()</tt>, <tt>vmalloc()</tt>, or <tt>__get_free_pages()</tt>
is accompanied by carefully thought-out error-handling code.  It turns out,
though, the behavior actually implemented in the memory-management
subsystem is a bit different from what is written in the brochure.  That
difference can lead to unfortunate run-time behavior, but the fix might
just be worse.
<p>
A discussion on the topic began when Tetsuo Handa posted <a
href="/Articles/627420/">a question</a> on how to handle a particular
problem that had come up.  The sequence of events was something like this:
<p>
<ol>
<li> A process that is currently using relatively little memory invokes
     an XFS filesystem operation that, in turn, needs to perform an
     allocation to      proceed.
<p>
<li> The memory management subsystem tries to satisfy the allocation, but
     finds that there is no memory available.  It responds by first trying
     direct reclaim (forcing pages out of memory to free them), then, if
     that doesn't produce the needed free memory, it falls back to the
     out-of-memory (OOM) killer.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
<li> The OOM killer picks its victim and attempts to kill it.
<p>
<li> To be able to exit, the victim must perform some operations on the
     same XFS filesystem.  That involves acquiring locks that, as it
     happens, the process attempting to perform the problematic memory
     allocation is currently holding.  Everything comes to a halt.
</ol>
<p>
In other words, the allocating process cannot proceed because it is waiting
for its 
allocation call to return.  That call cannot return until memory is freed,
which requires the victim process to exit.  The OOM killer will also wait
for the victim to exit before (possibly) choosing a second process to
kill.  But the victim process cannot exit
because it needs locks held by the allocating process.  The system locks up
and the owner of the system starts to seriously consider a switch to
some version of BSD.
<p>
When asked about this problem, XFS maintainer Dave Chinner quickly <a
href="/Articles/627432/">wondered</a> why the memory-management code was
resorting to the OOM killer rather than just failing the problematic memory
allocation.  The XFS code, he said, is nicely prepared to deal with an
allocation failure; to him, using that code seems better than killing random
processes and locking up the system as a whole.  That is when memory
management maintainer Michal Hocko <a href="/Articles/627434/">dropped a
bomb</a> by saying:
<p>
<div class="BigQuote">
	Well, it has been an unwritten rule that GFP_KERNEL allocations for
	low-order (&lt;=PAGE_ALLOC_COSTLY_ORDER) never fail. This is a long
	ago decision which would be tricky to fix now without silently
	breaking a lot of code. Sad...
</div>
<p>
The resulting explosion could be heard in <a
href="/Articles/627435/">Dave's incredulous reply</a>:
<p>
<div class="BigQuote">
	We have *always* been told memory allocations are not guaranteed to
	succeed, ever, unless __GFP_NOFAIL is set, but that's deprecated
	and nobody is allowed to use it any more.
<p>
	Lots of code has dependencies on memory allocation making progress
	or failing for the system to work in low memory situations. The
	page cache is one of them, which means all filesystems have that
	dependency. We don't explicitly ask memory allocations to fail, we
	*expect* the memory allocation failures will occur in low memory
	conditions. We've been designing and writing code with this in mind
	for the past 15 years.
</div>
<p>
A "too small to fail" allocation is, in most kernels, one of eight
contiguous pages or less — relatively big, in other words.  Nobody really
knows when the rule that these allocations could not fail went into the
kernel; it predates the Git era.  As Johannes Weiner <a
href="/Articles/627436/">explained</a>, the idea was that, if such small
allocations could not be satisfied, the system was going to be so unusable
that there was no practical alternative to invoking the OOM killer.
That may be the case, but locking up the system in a situation where the
kernel is prepared to cope with an allocation failure also leads to a
situation where things are unusable.
<p>
One alternative that was mentioned in the discussion was to add the
<tt>__GFP_NORETRY</tt> flag to specific allocation requests.  That flag
causes even small allocation requests to fail if the resources are not
available.  But, as Dave noted, trying to fix potentially deadlocking
requests with <tt>__GFP_NORETRY</tt> is a game of Whack-A-Mole; there are
always more moles, and they tend to win in the end.
<p>
The alternative would be to get rid of the "too small to fail" rule and
make the allocation functions work the way most kernel developers expect
them to.  Johannes's message included a patch moving things in that
direction; it causes the endless reclaim loop to exit (and fail an
allocation request) if attempts at direct reclaim do not succeed in
actually freeing any memory.  But, as he put it, "<q>the thought of
failing order-0 allocations after such a long time is scary.</q>"
<p>
It is scary for a couple of reasons.  One is that not all kernel developers
are diligent about checking every memory allocation and thinking about a
proper recovery path.  But it is worse than that: since small allocations
do not fail, almost none of the thousands of error-recovery paths in the
kernel now are ever exercised.  They could be tested if developers were to
make use of the the kernel's <a href="/Articles/209257/">fault injection
framework</a>, but, in practice, it seems that few developers do so.  So
those error-recovery paths are not just unused and subject to bit rot;
chances are that a discouragingly large portion of them have never been
tested in the first place.
<p>
If the unwritten "too small to fail" rule were to be repealed, all of those
error-recovery paths would become live code for the first time.  In a sense,
the kernel would gain thousands of lines of untested code that only run in
rare circumstances where things are already going wrong.  There can be no
doubt that a number of obscure bugs and potential security problems would
result.
<p>
That leaves memory-management developers in a bit of a bind.  Causing
memory allocation functions to behave as advertised seems certain to
introduce difficult-to-debug problems into the kernel.  But the status quo
has downsides of its own, and they could get worse as kernel locking
becomes more complicated.  It also wastes the considerable development time
that goes toward the creation of error-recovery code that will never be
executed.  Even so, introducing low-order memory-allocation failures at
this late date may well prove too scary to be attempted, even if the
long-term result would be a better kernel.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Page_allocator">Memory management/Page allocator</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/627419/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor627452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Small allocations and OOM killer</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 22:44 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627452/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If a few kilobytes of memory are requested, but unavailable, is it even worth trying to run the OOM killer?  Since the victim process will most likely require some memory allocations in order to exit, as happened here.<br>
<p>
I can understand running the OOM killer to free a few hundred megs, but if the system is so short of memory that even a 20kbyte request wasn't satisfied, breaking out the OOM machinery sounds like it will make things worse instead of better.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627454"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 22:55 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/627454/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All this talk of barely tested error-recovery paths reminded me of the following parable:<br>
<p>
<font class="QuotedText">&gt; We went to lunch afterward, and I remarked to Dennis that easily half the code I was writing in Multics was error recovery code. He said, "We left all that stuff out. If there's an error, we have this routine called panic, and when it is called, the machine crashes, and you holler down the hall, 'Hey, reboot it.'"</font><br>
<p>
-- <a href="http://www.multicians.org/unix.html">http://www.multicians.org/unix.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627454/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 7:39 UTC (Wed)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/627516/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; easily half the code I was writing in Multics was error recovery code. He said, "We left all that stuff out. If there's an error, we have this routine called panic</font><br>
<p>
And now in Linux we have both! :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627622"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 21:07 UTC (Wed)
                               by <b>agrover</b> (guest, #55381)
                              [<a href="/Articles/627622/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We've all been writing, reviewing, and debugging error-handling code in the kernel, hundreds of programmer-years of effort. It's a little insulting that it doesn't even get used. Seems to me the sooner we pull off the band-aid and enable all allocations to fail, the better.<br>
<p>
If there are bugs that are "too scary" to contemplate fixing the right way, then we are all in BIG trouble.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627622/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627750"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:28 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627750/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The terminology used is unfortunate.  It is not that small allocations "cannot fail".  Of course if the memory is unavailable, any memory allocation will fail.  The question is what failure mode happens.  Is it by a false status being returned to the caller, or is it some other kind of failure such as a kernel panic or hard lockup?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627750/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 0:16 UTC (Sat)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/627871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; And now in Linux we have both! :)</font><br>
<p>
If only we didn't have all that code we may be able to satisfy that small allocation request.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 18:24 UTC (Fri)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/627841/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I used to think this was an indictment of Unix, but if you look at modern cloud systems with their multiple virtual machines, any one of which is expected to fail without affecting the service.  Or Erlang with its philosophy of failing early and recovering failed processes.  Well, now it's writing all that error handling code which looks stupid.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628034"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 14:09 UTC (Mon)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/628034/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, because the next time your mobile phone crashes you can seamlessly switch to one of the cloud of redundant phones you carry with you at all times...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628034/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628133"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 21:58 UTC (Mon)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/628133/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You obviously don't understand how erlang works. Not many do which I guess explains the state of programming these days.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628133/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628160"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 10:31 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/628160/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm sure Erlang works reliably, but the kernel cannot be written in Erlang.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628160/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor630422"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2015 9:03 UTC (Fri)
                               by <b>Frej</b> (guest, #4165)
                              [<a href="/Articles/630422/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No but the philosophy could be followed. In many ways it is the just the micro vs monolith kernel. If subsystems could be completely separate, you could just restart the subsystem and retry the request. But it's never quite that simple, and especially so for the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/630422/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor628164"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 15:59 UTC (Tue)
                               by <b>rgmoore</b> (<b>&#x272D; supporter &#x272D;</b>, #75)
                              [<a href="/Articles/628164/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>OTOH, Android expects its apps to be able to handle crashes cleanly.  When it needs to free up memory, it just kills something in the background, and it's up to the app not to have problems from that.  Seamless recovery from being killed is mandatory.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628164/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628167"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error recovery (was: The &quot;too small to fail&quot; memory-allocation rule)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 16:40 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/628167/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is sound design to make the application handle crashes cleanly, so it can recover without losing more than a tiny bit of work in progress.  And that applies to the kernel too: journalling filesystems are designed so that even a hard crash will not lose data.<br>
<p>
That doesn't really mean you can do without error handling code in the kernel, though.  It's great if your filesystem doesn't get horribly corrupted when the machine crashes, but still the crash is not appreciated by the user.  Yes, if you are running a farm of several machines then you can fail over to another and the service stays up; that doesn't really work as a remedy for your laptop locking up, unless you happen to carry around a redundant laptop with you at all times.<br>
<p>
And in the case of Android, the apps are killed and restarted, but it would not be acceptable for the kernel itself to just panic on any error condition and require restarting the phone.  Which is what we are talking about here: *kernel* error recovery.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628167/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628178"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: OTOH, Android expects its apps to be able to handle crashes cleanly.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 20:47 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628178/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <P>Not quite. The framework will always explicitly call <A HREF="http://developer.android.com/reference/android/app/Activity.html#onDestroy()"><TT>onDestroy()</TT></A> before killing your Activity. If this is happening because the system is running low on resources, <I>not because of direct user action</I>, then <A HREF="http://developer.android.com/reference/android/app/Activity.html#onSaveInstanceState(android.os.Bundle)"><TT>onSaveInstanceState()</TT></A> will be called before that so you can save whatever is necessary of the state of your UI so, when the user returns to your app, it can be transparently restarted to make it look like it never stopped.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628178/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628185"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: OTOH, Android expects its apps to be able to handle crashes cleanly.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 21:41 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628185/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not true, see drivers/staging/android/lowmemorykiller.c. It directly sends SIGKILL to the process, without calling any Java function.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628185/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627456"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 22:56 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/627456/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This isn't the first time I've seen memory management problems and XFS mentioned in the same article. Is that just a side effect of more eyes on the code compared to other FSes, or is there something more to it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627456/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 23:07 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/627459/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I hope I didn't create the wrong impression; XFS is not the problem here, it just happened to be the filesystem that was in use.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627493"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 3:45 UTC (Wed)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/627493/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, you didn't at all!<br>
<p>
And I don't mean to sound negative either. If there's any conclusion to be made here, it's that XFS is really good at provoking improvements everyone can benefit from.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627493/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627462"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 23:20 UTC (Tue)
                               by <b>xorbe</b> (guest, #3165)
                              [<a href="/Articles/627462/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Of all the file systems, iirc ZFS would be the memory offender.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627462/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627531"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 10:40 UTC (Wed)
                               by <b>yoe</b> (guest, #25743)
                              [<a href="/Articles/627531/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ZFS is not a 'memory offender'; it simply has a different approach to caching. Where other file systems assume they're not the only users of the system, ZFS in its default setting assumes the system is a file server and will hard-allocate most of the available RAM as cache. While that does leave little room for other processes, that is an appropriate thing to do if the system is, indeed, a file server and there aren't many other processes. If there are, however, it's only a default which can be changed.<br>
<p>
I personally run ZFS on a system with 'only' 2G of ram and a single hard disk. It's not as fast as ZFS can be, but it runs perfectly well, with room to spare in its RAM for plenty of other stuff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627531/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627721"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 18:38 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/627721/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why does ZFS need its own cache? Page cache should be sufficient and system-global. If you want a particular installation to prefer file-backed pages to swap-backed pages at reclaim time, fine, but I don't see why this policy should have to be tied to a specific filesystem. It feels like a step backward from the unified cache era.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627721/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627749"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:33 UTC (Thu)
                               by <b>yoe</b> (guest, #25743)
                              [<a href="/Articles/627749/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ZFS doesn't necessarily need its own cache, I suppose, but the algorithms involved can be more efficient if they have knowledge of the actual storage layout (which *does* require that they are part of the ZFS code, if done to the extreme). E.g., ZFS has the ability to store a second-level cache on SSDs; if the first-level (in-memory) cache needs to drop something, it may prefer to drop something which it knows to also be stored on the SSD cache over something which isn't. The global page cache doesn't have the intricate knowledge of the storage backend which is required for that sort of thing.<br>
<p>
I suppose that's a step backwards if what you want is "mediocre cache performance, but similar performance for *all* file systems". That's not what ZFS is about, though; ZFS wants to provide excellent performance at all costs. That does mean it's not the best choice for all workloads, but it does beat the pants off of most other solutions in the workloads that it was meant for.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627749/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627821"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 16:11 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/627821/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're talking about ZFS, but the post was talking about XFS. They are very different things.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627821/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627900"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 13:09 UTC (Sat)
                               by <b>yoe</b> (guest, #25743)
                              [<a href="/Articles/627900/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know.<br>
<p>
The article was about XFS, but the comment that I replied to was very much about ZFS, not XFS.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627900/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor628622"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2015 20:40 UTC (Tue)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/628622/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I thought ZFS was a heavy user of RAM mostly when deduplication is enabled.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628622/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor635169"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 28, 2015 13:59 UTC (Sat)
                               by <b>yoe</b> (guest, #25743)
                              [<a href="/Articles/635169/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Dedup is a large memory eater, yes, but doesn't have an influence on how much memory gets used (it just gets terribly slow if you don't have enough...)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/635169/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor627461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 23:22 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/627461/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This isn't the first time I've seen memory management problems and XFS mentioned in the same article. Is that just a side effect of more eyes on the code compared to other FSes, or is there something more to it?</font><br>
<p>
I'd guess it's a side effect of XFS's focus on performance and code quality. As a high-performance filesystem, it puts more stress on the VM subsystem. And as for code quality, there's a reason why the filesystem testing tool every filesystem uses is called "xfstests".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 23:25 UTC (Tue)
                               by <b>alan</b> (subscriber, #4018)
                              [<a href="/Articles/627464/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With XFS as the new default filesystem in RHEL systems, you may see it mentioned even more.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627501"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 5:13 UTC (Wed)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/627501/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This isn't the first time I've seen memory management problems and XFS mentioned in the same article. Is that just a side effect of more eyes on the code compared to other FSes, or is there something more to it?</font><br>
<p>
If you're comparing XFS to vfat or ext3, remember that those are really simple filesystems.  Almost everything is in fixed-size arrays or bitmaps, and disk blocks have a 1:1 relationship with page cache.  Not much interesting for MM to do.<br>
<p>
Comparing XFS to reiserfs, NTFS, ZFS:  these filesystems have similar complexity, but they're not developed any more, or their best implementations are not in the Linux kernel proper, so their developers don't have newsworthy interactions with MM developers.<br>
<p>
Comparing XFS to btrfs:  btrfs has MM bugs. but it also has lots of other kinds of bugs, so the MM bugs don't stand out as much.  ;)<br>
<p>
If you count up lines of code and commits in the last two years, XFS is one of the most actively developed filesystems in Linux, second only to btrfs among non-network filesystems by those crude metrics.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627501/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627863"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 22:56 UTC (Fri)
                               by <b>dgc</b> (subscriber, #6611)
                              [<a href="/Articles/627863/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It more that XFS is more deeply intertwined with memory allocation and reclaim architecture than other filesystems. We've long had problems with memory reclaim recursion doing things like deadlocking and/or blowing the stack, but over the past few years XFS has made use of the shrinker subsystem to vastly expand scalability and performance above what the generic memory reclaim algorithms can provide.<br>
<p>
To do this, we have to have some idea of how the MM subsystem works, how it is architected, the rules we have to play under, the capabilities and deficiencies it has, etc. Just because we work on filesystems doesn't mean we only understand filesystems...<br>
<p>
Further, most XFS developers come from a strong engineering background where we are taught to understand and solve the root cause of whatever issue is occurring, not just slap a band-aid over the symptom being reported. Hence you see us pointing out warts in other parts of the system that haven't been well thought out, work around some issue or are just plain broken.<br>
<p>
This thread was a prime example - "XFS deadlocked under low memory conditions" was the bug report, but a little bit of investigation of the report points out the underlying cause of the hang is not a filesystem problem at all...<br>
<p>
-Dave.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627863/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627458"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 23:15 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/627458/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; That leaves memory-management developers in a bit of a bind. Causing memory allocation functions to behave as advertised seems certain to introduce difficult-to-debug problems into the kernel. But the status quo has downsides of its own, and they could get worse as kernel locking becomes more complicated.</font><br>
<p>
If I understood it correctly, the problem is a "recursive locking" deadlock: the filesystem does a memory allocation under a lock, which waits for a process to exit, which calls into the filesystem, which needs the same lock again.<br>
<p>
Doesn't the kernel already have a way of saying "I'm the filesystem, do not call the filesystem to free memory", that is, GFP_NOFS (and the related GFP_NOIO)? Couldn't the meaning of that flag be extended to also mean "don't wait for the OOM killer even for small allocations", since filesystem and memory management code have a higher probability of having a good quality error recovery code?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627458/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627491"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 3:13 UTC (Wed)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/627491/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This looks to me to be a valid and relevant observation.<br>
<p>
The allocation is question is __GFP_NOWAIT which is equivalent to GFP_NOIO.<br>
Such an allocation must not risk waiting for FS or IO activity.  Yet waiting for the OOM killer can clearly do that.  This is a violation of the interface whether you accept the "too small to fail" rule or not.<br>
<p>
Invoking the OOM killer is reasonable, waiting a little while is reasonable, but waiting for the killed processes to flush data or close files is not.....  Hmmm.  The out_of_memory() function chooses a processes, kills it, then waits one second ("schedule_timeout_killable(1);"), so it seems to be behaving as I would expect.<br>
<p>
Reading more of the email threads it seems that  TIF_MEMDIE is an important part of the problem.  This is set on a thread when it has been chosen to die.  As long as any thread has this set, "select_bad_process()" will not select anything else so nothing else gets killed.<br>
<p>
So the "real" problem seems to be that if a process with TIF_MEMDIE set enters filesystem (or IO) code and blocks, a GFP_NOIO allocation can be made to wait for that filesystem code to complete - which could deadlock.<br>
<p>
Looking at the original patch which started this: <a href="http://marc.info/?l=linux-mm&amp;m=141839249819519&amp;w=2">http://marc.info/?l=linux-mm&amp;m=141839249819519&amp;w=2</a> the problem seems to involve a process with TIF_MEMDIE set, which has already released its memory, but is now stuck in the filesystem, probably closing some files.<br>
<p>
As it has TIF_MEMDIE set, nothing else will be killed.  So no memory will become available, so it will stay stuck in the filesystem...<br>
<p>
This deadlock could possibly be avoided by having oom_scan_process_thread() not abort the scan if TIF_MEMDIE is set on a process which has already dropped its memory. Then another process can be killed even if the first one blocked<br>
<p>
But that analysis was very hasty and probably misses something important.  "Here be dragons" is how I would mark this code on a map of Linux.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627491/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor629704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 15, 2015 19:40 UTC (Thu)
                               by <b>ksandstr</b> (guest, #60862)
                              [<a href="/Articles/629704/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed it's bizarre that an automatic attempt to avert malloc failure would potentially re-enter its caller and therefore guarantee a lock-ordering violation. First, the allocator is at all called with a lock held, implying that allocation length follows from state which the lock is used to guard; which in turn implies overly eager design.<br>
<p>
Second, that the allocator enters the OOM killer on its own volition, changing malloc's locking behaviour from "only ever the heap lock" to "everything an asynchronous OOM killer might end up with". That might well cover all of the kernel, when the caller is expecting malloc to be atomic by itself.<br>
<p>
What's surprising isn't so much the reams of untested malloc-failure handling code, but that this bug comes up as late as 2014.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/629704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 23, 2014 23:41 UTC (Tue)
                               by <b>xorbe</b> (guest, #3165)
                              [<a href="/Articles/627467/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
An important piece of code such as XFS should reserve the minimal needed memory on driver load.  Then, it should have local management of its own resources.  It could have optional dynamic reservation for non-critical purposes, such as caching, where it doesn't matter if the data is dropped (only a performance impact).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627472"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 0:54 UTC (Wed)
                               by <b>cwillu</b> (guest, #67268)
                              [<a href="/Articles/627472/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem isn't that xfs can't deal with the memory allocation failing; the problem is that the allocation routines don't give it an opportunity to handle a failure before they've already gone ahead and tried to kill a process (at which point they've deadlocked).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627472/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627515"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 7:35 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627515/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the OP's point may have been that ideally cleanup tasks like killing a process should not require fresh allocations.  Sufficient memory should be allocated in advance, so you can always close files (etc) without allocating.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627515/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor627499"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 4:35 UTC (Wed)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/627499/">Link</a>] (24 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; XFS maintainer Dave Chinner quickly wondered why the memory-management code was resorting to the OOM killer rather than just failing the problematic memory allocation.</font><br>
<p>
I wonder this too, and have done so for as long as the OOM killer has existed.  It seems that instead of returning ENOMEM or calling panic(), we've decided that inflicting a Chaos Monkey on userspace (and adding a bunch of latency for the allocating process) is somehow the best of all feasible alternatives.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627499/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 7:53 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/627513/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OOM killer is a consequence of memory overcommit which in turn originated in copy-on-write semantics of the fork.<br>
<p>
For example, Linux allows to fork a process even if its image has more then halve the memory on the system. The assumption is that the child process most likely would either use exec soon or parent/child would use the allocated memory in read-only way. Now consider what should happen when the  processes start to write to the memory. That may lead to OOM errors. Now, who should be blamed for it? The child or parent? In addition, applications are typically not prepared to deal with a situation when an arbitrary write may trigger OOM. So OOM killer is pretty reasonable solution.<br>
<p>
Compare that with Windows where overcommit is not available (lack of fork in Windows API allows for that). Immediately memory accounting becomes simple and OS can guarantee that if a process has a pointer to writable memory, then memory is always available for writing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627521"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 9:23 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627521/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
fork-exec is one of the aspects of classical Unix which looks really neat in a textbook but hasn't held up quite so well in the real world.  Remembering that 'things should be as simple as possible, but no simpler', it is just a bit too simple.  POSIX does define spawn functions which userspace code might call instead.<br>
<p>
Essentially, when you fork() the kernel has no way of knowing that you are just about to call exec() immediately afterwards, so it has to either reserve space for a complete copy of all your process's memory, or end up overcommitting and resorting to an OOM killer if it guessed wrong.  If userland can give the kernel a bit more information then the kernel can do its job better.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627521/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627522"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 9:35 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/627522/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One great feature of the fork()/exec() model is that you can set up the child's environment by running code in the child before exec --- setting resource limits, manipulating file descriptors, dropping privileges, etc. It's easy to do this in a race-free way. With Windows' CreateProcess you can't do this, so it takes 10 parameters including a flags word with 16 flags and a STARTUPINFO struct with over a dozen members, and it's still less flexible than fork()/exec().<br>
<p>
Also, copy-on-write fork()ing has other valuable uses. In rr we use it to create checkpoints very efficiently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627522/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627524"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 9:54 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627524/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is true.  But the manipulation of file descriptors shouldn't require a complete copy of the parent process's memory.  It would be handy if you could fork passing a buffer of memory and a function pointer.  The child process will be given a copy of that buffer and will jump to the function given.  Then you have some flexibility in what you can do before exec() but you can still be frugal in memory usage without relying on overcommit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627524/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627722"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 18:44 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/627722/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The child process will be given a copy of that buffer and will jump to the function given</font><br>
<p>
vfork does what you want. The "child" shares memory with the parent until it calls exec, so you avoid not only the commit charge catastrophe of copy-on-write fork, but also gain a significant performance boost from not having to copy the page tables.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627722/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627746"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: shouldn't require a complete copy of the parent process's memory</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:18 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627746/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      That issue was solved a long time ago, which is why the <TT>vfork</TT>(2) hack is obsolete nowadays.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627746/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: shouldn't require a complete copy of the parent process's memory</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 7:33 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627797/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sorry what issue are you referring to?  The conjecture so far is that there is a problem, since a forked process gets a copy of its parent's address space, which requires either reserving enough memory (RAM or swap) to provide that, or else overcommitting and crossing your fingers (with OOM killer for when you get it wrong).  It is true that copy-on-write means the kernel doesn't have to copy all the pages straight away, but that is just a time saving; it doesn't resolve the underlying issue of needing overcommit.<br>
<p>
vfork() doesn't make a copy of the address space and so doesn't require either over-caution or over-committing.  But it has other limitations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor627530"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 10:18 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/627530/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One great feature of the fork()/exec() model is that you can set up the child's environment by running code in the child before exec </font><br>
<p>
To customize the child before exec one does not need full fork, vfork is enough and does not require overcommit.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627530/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627535"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 11:34 UTC (Wed)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/627535/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Only in Linux.  The POSIX description is "you can store the return value from vfork(), then you have to call _exit or exec".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627535/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627538"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 12:31 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/627538/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linux semantic of vfork is one of the most usable as it blocks only the thread in parent that calls it. Thus one can get rather safe and efficient alternative to fork/exec by creating a new thread, calling vfork from it, preparing the child and calling the exec. Compare that with, say, FreeBSD or Solaris that, according to the manual pages, suspends the whole parent process during the vfork call.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627538/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628145"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 0:04 UTC (Tue)
                               by <b>klossner</b> (subscriber, #30046)
                              [<a href="/Articles/628145/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
By "create a new thread" do you mean call pthread_create?  That just ends up in do_fork(), which creates a new process with which to call vfork(), which ends up in do_fork() to create another new process.  Safe, okay, but not really efficient.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628145/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627548"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 14:27 UTC (Wed)
                               by <b>justincormack</b> (subscriber, #70439)
                              [<a href="/Articles/627548/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Most versions allow you to do more than this though, not just the Linux one. Makes it all rather non portable though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627548/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 14:12 UTC (Wed)
                               by <b>patrakov</b> (subscriber, #97174)
                              [<a href="/Articles/627546/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This phrase is not 100% accurate:<br>
<p>
"overcommit is not available (lack of fork in Windows API allows for that)"<br>
<p>
It is not the lack of fork() that makes overcommit "unneeded", but an explicit decision. Windows MapViewOfFile() API allows creation of copy-on-write mappings (which are usually the basis for overcommit) through the FILE_MAP_COPY flag. Although, as documented, Windows does always reserve the whole size of the memory region in the pagefile.<br>
<p>
See <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366761%28v=vs.85%29.aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/a...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627557"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 15:33 UTC (Wed)
                               by <b>dumain</b> (subscriber, #82016)
                              [<a href="/Articles/627557/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The copy-on-write fork semantics don't have to lead to the OOM killer.  Selecting strategy 2 in /proc/sys/vm/overcommit_memory should allow a linux box to overcommit real memory without overcommiting virtual memory.  The penalty for actually using the memory then becomes swapping rather than random process death.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627557/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 18:50 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/627724/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
overcommit=2 is not usable in practice on general-purpose systems: MAP_NORESERVE is ignored in that mode. Many programs (like the JVM) reserve large chunks of address space on startup and internally allocate out of that. Because the kernel ignores [1] MAP_NORESERVE, these address space reservations become actual *commit charge* claims on the system and require resource allocations far in excess of what's actually needed even ignoring COW fork considerations.<br>
<p>
MAP_NORESERVE being ignored when overcommit=2 isn't a "gotcha". It's fundamental brokenness.<br>
<p>
[1] <a href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting">https://www.kernel.org/doc/Documentation/vm/overcommit-ac...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627728"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 19:04 UTC (Thu)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/627728/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OpenJDK has been fixed and uses PROT_NONE mappings to reserve uncommitted address space (which is then committed with mprotect calls, as needed).<br>
<p>
MAP_NORESERVE is not named appropriately, but it does what it does.  The problem is that programmers do not know about overcommit mode 2, do not test with it, and hence never realize the need for the PROT_NONE approach.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627728/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627733"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 19:58 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/627733/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agreed on the lack of testing --- but what bugs me is that MAP_NORESERVE is documented as doing the right thing, and doesn't. That means that programs written by the few well-intentioned developers are aware of overcommit issues frequently don't end up working correctly. <br>
<p>
Sadly, the commit charge implications of MAP_NORESERVE are documented but silently broken, but the commit charge implications of PROT_NONE are undocumented and in theory mutable in future releases. All this gives mmap(2) a Rusty Russel score of around -4.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627733/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 20:14 UTC (Thu)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/627735/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which documentation?  The manual page talks about error reporting through SIGSEGV, which should be sufficiently discouraging to anyone who actually reads it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 20:23 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/627736/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      The man page says this about MAP_NORESERVE:

<blockquote>             
 Do not reserve swap space for this mapping.  When swap space  is  reserved,
              one has the guarantee that it is possible to modify the mapping.  When swap
              space is not reserved one might get SIGSEGV upon a  write  if  no  physical
              memory   is   available.    See   also   the   discussion   of   the   file
              /proc/sys/vm/overcommit_memory in proc(5).  In  kernels  before  2.6,  this
              flag had effect only for private writable mappings.
</blockquote>

That looks a lot like a a flag for mapping that doesn't reserve commit charge. There's no mention of the flag not actually working; there's no reference to better techniques. MAP_NORESERVE is just an attractive nuisance.
<p>
There's just <a href="https://sourceware.org/ml/libc-alpha/2012-08/msg00185.html">tremendous confusion</a> over exactly Linux does with commit charge even among people well-versed in memory management fundamentals. There's no clarity in the API either. MAP_NORESERVE is dangerous because it's the only publicly-documented knob for managing commit charge and it's a broken knob nobody is interested in fixing.
<p>
(And no, SIGSEGV is not something that will discourage use. Those who know what they're doing can write code that recovers perfectly safely from SIGSEGV.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/627736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor786196"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 18, 2019 6:36 UTC (Thu)
                               by <b>thestinger</b> (guest, #91827)
                              [<a href="/Articles/786196/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In case anyone comes across this old comment, the official documentation is at <a href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting">https://www.kernel.org/doc/Documentation/vm/overcommit-ac...</a> and is accurate. It covers the rules properly.<br>
<p>
The linux-man-pages project is not the official kernel documentation and has often been inaccurate about important things for many years. MAP_NORESERVE doesn't work as it describes at all.<br>
<p>
It has no impact in the full overcommit mode or the memory accounting mode, which makes sense. It only has an impact in the heuristic overcommit mode, where it disables the heuristic for causing immediate failure.<br>
<p>
Note how a read-only (or PROT_NONE) mapping with not data has no accounting cost:<br>
<p>
For an anonymous or /dev/zero map<br>
	SHARED			-	size of mapping<br>
	PRIVATE READ-only	-	0 cost (but of little use)<br>
	PRIVATE WRITABLE	-	size of mapping per instance<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/786196/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627632"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 22:24 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627632/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's not exactly true. Windows supports overcommit just fine. There are two main ways to overcommit:<br>
<p>
1) Map a file with copy-on-write semantics from several processes. Windows does this just fine with the MapViewOfFile function.<br>
<p>
2) Reserve a large amount of virtual RAM but don't actually allocate physical pages for it. It's also supported with MEM_RESERVE flag for the VirtualAllocEx function ( <a rel="nofollow" href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366890%28v=vs.85%29.aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/a...</a> )<br>
<p>
The main distinction is that Windows programs by default try to avoid OOM situations. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627632/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 23:32 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/627635/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
These are not the overcommit in the Linux sense.<br>
<p>
On Windows after MEM_RESERVE the memory is not available. One has to explicitly commit it using MEM_COMMIT. As for copy-on-write for mmap files Windows explicitly reserves the allocated memory in advance. In both cases Windows ensure as long as a program has a pointer to a writable memory, that memory is always available. That is, on Windows OOM failure can only happen during allocation calls, not during an arbitrary write in a program as it happens on Linux<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 19:17 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/627725/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Your comment is incorrect according to a conventional understanding of "overcommit". The misunderstanding probably stems from a general confusion even among very senior Linux developers between allocating address space and allocating memory. In Linux, programs call mmap and expect that operations on the memory returned will never[2] fail. There is no distinction in practice [1] between setting aside a N pages of virtual addresses and reserving storage for N distinct pages of information.<br>
<p>
In NT, the operations are separate. A program can set aside N pages of its address space, but it's only when it commits some of those pages that the kernel guarantees that it will be able to provide M, M&lt;=N, distinct pages of information. After a commit operation succeeds, the system guarantees that it will be able to provide the requested pages. There is no OOM killer because the kernel can never work itself into a position where one might be necessary. While it's true that a process can reserve more address space than memory exists on the system, in order to use that memory, it must first make a commit system call, and *that call* can fail. That's not overcommit. That's sane, strict accounting. Your second point is based on a misunderstanding.<br>
<p>
Your first point is also based on a misunderstanding. If two processes have mapped writable sections of a file, these mappings are either shared or private (and copy-on-write). Shared mappings do not incur a commit charge overhead because the pages in file-backed shared mappings are backed by the mapped files themselves. Private mappings are copy-on-write, but the entire commit charge for a copy-on-write mapping is assessed *at the time the mapping is created*, and operations that create file mappings can fail. Once they succeed, COW mappings are as committed as any other private, pagefile-backed mapping of equal size. Again, no overcommit. Just regular strict accounting.<br>
<p>
From MSDN:<br>
<p>
"When copy-on-write access is specified, the system and process commit charge taken is for the entire view because the calling process can potentially write to every page in the view, making all pages private. The contents of the new page are never written back to the original file and are lost when the view is unmapped."<br>
<p>
The key problem with the Linux scheme is that, in NT terms, all mappings are SEC_RESERVE and are made SEC_COMMIT lazily on first access, and the penalty for a failed commit operation is sudden death of your process or a randomly chosen other process on the system. IMHO, Linux gets all this tragically wrong, and NT gets it right.<br>
<p>
[1] Yes MAP_NORESERVE exists. Few people use it. Why bother? It's broken anyway, especially with overcommit off, when you most care about MAP_NORESERVE in the first place!<br>
<p>
[2] Sure, the OOM killer might run in response to a page fault, but the result will either be the death of some *other* process or the death of the process performing the page fault.  Either way, that process never observes a failure, in the latter case because it's dead already. Let's ignore file-backed memory on volatile media too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor627519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 8:01 UTC (Wed)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/627519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I wonder this too, and have done so for as long as the OOM killer has existed.</font><br>
<p>
That's all about promises. When you call malloc(), and it returns a success, the kernel promises that the memory will be available. But then there's overcommit, which means that the kernel might be making empty promises - "don't worry, I know things are tight right now, but trust me, I *will* have the money^Hmemory". And when things are really tight, it scrambles and goes to the pawn shop to fence some memory of some poor innocent process. Because at this point there's no other way - malloc() was reported as success and the process is trying to use this supposedly allocated memory by simply accessing it. But it's not there.<br>
<p>
But it looks like this particular case is a different thing. There's no overcommit for the kernel allocations, right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627512"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 24, 2014 7:15 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/627512/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The fear of untested OOM recovery code reminded me about OOM errors in Java. Formally recovery is possible, but in practice at least in earlier Java those error popping up in arbitrary places could easily lead to unexpected states from which the system could not recover.<br>
<p>
What helped on a memory-constrained system was to preallocate a buffer and monitor available memory. When it became low, the buffer was dropped with a global flag set indicating for the application to switch to a recovery mode. In that mode most of normal activities lead to errors. The application remained in it until enough memory was freed to be able to allocate the buffer back.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627512/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 19:07 UTC (Thu)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/627729/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OutOfMemoryError is an VirtualMachineError, not an exception.  You can catch it, but the specification about that error says it indicates “the Java Virtual Machine is broken or has run out of resources necessary for it to continue operating”, i.e., VM restart is required.  So even formally, you cannot recover from it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627740"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 21:19 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627740/">Link</a>] (117 responses)
      </p>
      
      </div>
      </summary>
      <P>I have written a lot of code according to the following paradigm:
<BLOCKQUOTE><TT>ptr = NULL;</TT><BR>
<I>... similarly initialize any other pointers ...</I>
<TT>do /*once*/</TT><BR>
<TT>&nbsp;&nbsp;{</TT></BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>...</I><BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>allocate </I><TT>ptr;</TT><BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;if (</TT><I>failure</I><TT>)</TT><BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</TT><BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>...</I><BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>futher processing, including further pointer allocations as necessary</I><BR>
<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>...</I><BR>
<TT>&nbsp;&nbsp;}</TT></BR>
<TT>while (false);</TT><BR>
<TT>free(ptr);</TT><BR>
<I>... free any other allocations ...</I>
</BLOCKQUOTE>

<P>This kind of thing makes it easy to convince yourself, by visual inspection, that the allocated storage will be freed once, and only once, no matter what control path is taken. A key simplifying point is that the <TT>free</TT>(3) call is <I>idempotent</I>: freeing a NULL pointer is a no-op.

<P>If you want to see a more elaborate example, including loops and nested do-once-within-do-once, have a look at this <A HREF="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c"><TT>spuhelper.c</TT></A> Python extension module.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627740/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627741"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 21:34 UTC (Thu)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/627741/">Link</a>] (66 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; do {</font><br>
<font class="QuotedText">&gt;   if (failure)</font><br>
<font class="QuotedText">&gt;     break;</font><br>
<font class="QuotedText">&gt; } while (false);</font><br>
<p>
Wouldn't it be simpler and more readable to use a goto instead of a pseudo-loop?<br>
<p>
(The Linux kernel does use the "set pointers to NULL and on error free them if they are not NULL" paradigm, of course using a "goto error" instead of a pseudo-loop, but the error-recovery paths being discussed are not merely "freeing locally allocated memory"; they can also have things like "unlocking a mutex" or "updating the filesystem block allocation structures to mark as free the blocks which had been reserved for this task".)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627741/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627745"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Wouldn't it be simpler and more readable to use a goto instead of a pseudo-loop?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:08 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627745/">Link</a>] (65 responses)
      </p>
      
      </div>
      </summary>
      <B>No!</B> No <TT>GOTO</TT>s. They don’t nest easily, and they lead to spaghetti code.

Look at the example code I linked above, and think how it would look with <TT>GOTO</TT>s all over the place. Avoid <TT>GOTO</TT>s!
      
          <div class="CommentReplyButton">
            <form action="/Articles/627745/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627748"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Wouldn't it be simpler and more readable to use a goto instead of a pseudo-loop?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:23 UTC (Thu)
                               by <b>mchapman</b> (subscriber, #66589)
                              [<a href="/Articles/627748/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Look at the example code I linked above, and think how it would look with GOTOs all over the place.</font><br>
<p>
There would be precisely as many "goto" statements as you have "break" statements. It's much of a muchness, in my opinion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627748/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 23:07 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627755/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <P>And you would need a different label for each. And the extra visual burden of ensuring that each <TT>goto</TT> is paired with the right label. Which is unnecessary with a <TT>break</TT>, since that can only ever terminate one enclosing construct.

<P>And the further burden of getting things wrong when you try refactoring the code.

<P>Like I said: <B>NO GOTOs</B>!
      
          <div class="CommentReplyButton">
            <form action="/Articles/627755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627762"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 0:01 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627762/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except that NOW you have an extra burden to check that break actually breaks out of a right loop.<br>
<p>
So, YES to gotos for error handling!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627762/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: So, YES to gotos for error handling!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 0:37 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627767/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Put your money where your mouth is. You have my code; go rewrite it!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor627798"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 7:38 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/627798/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perl allows 'last' (its equivalent of 'break') to take a loop label.  That would be a useful enhancement to C.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627798/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627799"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 7:43 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627799/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's a different issue - exit from multiple nested loops. In languages lacking labeled loops (C, C++) it's often a place where 'goto' is used.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627799/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor629753"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 16, 2015 5:10 UTC (Fri)
                               by <b>CameronNemo</b> (guest, #94700)
                              [<a href="/Articles/629753/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Rust got that recently. It is interesting, but a little strange/complicated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/629753/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor629844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 16, 2015 18:23 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/629844/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whenever I got to wanting labeled blocks in C, I sat down (OK,really I was already sitting down) and decided to add another function instead.<br>
<p>
That almost always made the code cleaner, and let me exit the block (which was now a function) with a simple "return."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/629844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor627796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 7:34 UTC (Fri)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/627796/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <p>Um... since when?</p>

<pre>if (error1) {
  goto label;
}

/* ... more code ... */

if (error2) {
  goto label;
}

/* ... more code ... */

label: free(pointer);</pre>

<p>You can use a single label for any number of goto's, so each label is specifically describing it's use case (freeAndExit perhaps, or whatever semantic name you want to give it) and there's no more/less lines than your <tt>do{}while(false);</tt> construct but copy-pasting code inside/outside the strcture can't break it as easily.</p>

<p>Just saying you're wrong about the claim of needing a billion labels, goto is many-to-one not one-to-one in that regard.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/627796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627853"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: you're wrong about the claim of needing a billion labels</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 21:15 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627853/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fine. Try reworking the example I gave above, then. That has allocations nested up to three levels deep, as well as loops. See how well that works using GOTOs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627853/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627874"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: you're wrong about the claim of needing a billion labels</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 0:47 UTC (Sat)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/627874/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
GOTO statements are fine.  I like them and find it leads to cleaner, easier to understand code.  The speghetti code thing is a myth with plenty of examples to disprove it in the Linux kernel.<br>
<p>
The deeply nested allocations example *should* be solved by factoring out local/static helper functions...In other words: if your code is too complicated to use GOTO's properly for cleanup, then your code is too complicated.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627874/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: deeply nested allocations example *should* be solved by factoring out</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:42 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627917/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fine. I have offered my example; feel free to rewrite it to prove your point, and then we can compare.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627921"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: deeply nested allocations example *should* be solved by factoring out</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:56 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627921/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I rewrote a sample. It's shorter and easier to read and understand. I provided you a sample of non-trivial cleanup logic from a big project.<br>
<p>
What else do you want?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627921/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627942"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: What else do you want?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 21:33 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627942/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
An example that proves that you can deal gracefully with all the cases that my code manages.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627942/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor628254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: deeply nested allocations example *should* be solved by factoring out</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 0:27 UTC (Thu)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/628254/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please keep an eye out for pull requests...<br>
<p>
<a href="https://github.com/ldo/dvd_menu_animator/pull/2">https://github.com/ldo/dvd_menu_animator/pull/2</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: deeply nested allocations example *should* be solved by factoring out</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 4:23 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/628261/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Methinks the crank is polishing his résumé to go apply for GNOME commit access.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: deeply nested allocations example *should* be solved by factoring out</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 4:40 UTC (Thu)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/628262/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there an open position?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor723509"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: deeply nested allocations example *should* be solved by factoring out</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2017 13:10 UTC (Tue)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/723509/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interestingly enough, this got *deleted* (probably by ldo?).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723509/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor627906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">goto bike shed</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 17:44 UTC (Sat)
                               by <b>itvirta</b> (guest, #49997)
                              [<a href="/Articles/627906/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; No! No GOTOs. They don’t nest easily, and they lead to spaghetti code. Look at the</font><br>
<font class="QuotedText">&gt; example code I linked above, and think how it would look with GOTOs all over the place.</font><br>
<font class="QuotedText">&gt; Avoid GOTOs!</font><br>
<p>
<font class="QuotedText">&gt; for(...) {</font><br>
<font class="QuotedText">&gt;   if (PyErr_Occurred()) break;</font><br>
<font class="QuotedText">&gt; }</font><br>
<font class="QuotedText">&gt; if (PyErr_Occurred()) break;</font><br>
<p>
I'm not sure I'd agree that breaking out of a loop just to test the same error condition, <br>
to then only break out of another loop is any clearer than just jumping out directly.<br>
<p>
Like someone mentioned, some other programming languages have dedicated constructs<br>
(like exceptions) that can break out of multiple loops. It's not very different from what goto<br>
was recommended for in this case.<br>
<p>
(The thing with absolute rules is, that they absolutely forbid one from thinking. That usually<br>
doesn't lead to anything good, so I would advise against it.)<br>
<p>
<font class="QuotedText">&gt; Fine. Try reworking the example I gave above, then. That has allocations nested up to three levels</font><br>
<font class="QuotedText">&gt; deep, as well as loops. See how well that works using GOTOs.</font><br>
<p>
Reducing the nesting level and using a less space-hungry indenting style would be what I'd start with,<br>
if I were to do this exercise for you.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: not sure I'd agree that breaking out of a loop just to test the same error condition</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:46 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627919/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you look at my code, you will see that each nested level has to do its own cleanup before propagating the error condition onwards. That is the whole point of the nesting.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: not sure I'd agree that breaking out of a loop just to test the same error condition</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:57 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627923/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Really? What cleanup is performed here: <a rel="nofollow" href="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c#L280">https://github.com/ldo/dvd_menu_animator/blob/master/spuh...</a> ?<br>
<p>
Or here: <a rel="nofollow" href="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c#L393">https://github.com/ldo/dvd_menu_animator/blob/master/spuh...</a> ?<br>
<p>
I actually don't see complicated cleanups anywhere in your code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627943"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: What cleanup is performed here:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 21:36 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627943/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Try <A HREF="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c#L661">here</A> or <A HREF="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c#L789">here</A>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627943/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor627958"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: not sure I'd agree that breaking out of a loop just to test the same error condition</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 3:27 UTC (Sun)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/627958/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; If you look at my code, you will see that each nested level has to do its own cleanup before</font><br>
<font class="QuotedText">&gt;&gt; propagating the error condition onwards. That is the whole point of the nesting.</font><br>
<p>
Better yet, use a function for each of those nested levels.  Worried about spaghetti code? Then factor out the nesting and call smaller functions with less looping and less nested resource management.  Use the return value to propagate error conditions onward.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627958/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Better yet, use a function for each of those nested levels.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:34 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627970/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fine. Rewrite some suitably representative part of my code to show us an example of what you mean. There seems to be an enormous reluctance among you so-called programmers to actually do this. Perhaps because every time you try it, you get it wrong.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628010"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Better yet, use a function for each of those nested levels.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 2:58 UTC (Mon)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/628010/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps we're on vacation and, even if we weren't, we have better things to do..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628010/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628013"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Better yet, use a function for each of those nested levels.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 3:19 UTC (Mon)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/628013/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting use of the word "us".  The royal we?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628013/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Better yet, use a function for each of those nested levels.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 17:30 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/628104/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Probably the millions of lurkers who support him in email, using his fabulously readable coding style. I know I've encountered it everywhere! (... wait, that should be "nowhere".)<br>
<p>
The argument from popularity is not a good one, but if something is not popular it is not terribly wise to imply that in fact it is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor723508"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: There would be precisely as many &quot;goto&quot; statements</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2017 13:09 UTC (Tue)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/723508/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It’d even be _easier_ in the case of nested loops, as something like shell’s “break 2” does not exist in C. A sole goto, to the shared exit path.<br>
<p>
Avoiding GOTO at all cost is overreacting. The “rule” is probably good to teach to novice programmers, but experts are beyond it. Error handling is *the* prime example in favour of GOTO, although I agree there may be others.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723508/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor627752"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Wouldn't it be simpler and more readable to use a goto instead of a pseudo-loop?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:36 UTC (Thu)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/627752/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <p>Please, no knee-jerk "no goto ever" reactions, go read Knuth's "Structured programming with goto statements", ACM Computing Surveys 6(4), dec 1974, pp 261-301. Check how goto is used in the kernel, write up gotoless code doing the same. You'll find that the gotoless code is easier to understand and often significantly more efficient.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/627752/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Please, no knee-jerk &quot;no goto ever&quot; reactions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 23:08 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627756/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fine. Go and rewrite my code to use GOTOs, and see how you do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628151"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Please, no knee-jerk &quot;no goto ever&quot; reactions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 2:10 UTC (Tue)
                               by <b>filipjoelsson</b> (guest, #2622)
                              [<a href="/Articles/628151/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>I thought it would be a fun exercise to rewrite your code with the exact same structure that you used. But instead of the <code>do { /* code */ } while (false);</code> construct - I'd use <code>goto cleanup</code>. The point of this would have been to prove to you that what you are doing is in fact to use goto, but in a circumspect manner.</p>

<p>You do realize that your construct will optimize to exactly the same code, when compiled, right? So, that all you do is add empty words and pointless levels of indent, that may or may not help compilers and other programmers understand what you mean?</p>

<p>So I took a dive into your code, stripped out all the comments and newlines, ran it through indent, and tried again.</p>

<p>And I must say that I believe that <code>do { /* code */ } while (false);</code> is one of your smaller sins!</p>

<p>Why the f*ck do you for instance do things like this?</p>
<code>for (i=0;;) { <br/>
if (i == nrcolors) break; <br/>
/* code */ <br/>
++i;<br/>
}</code>
<p>Breaking expectations like that do not anything of value, and makes sure nobody else will want to bother helping out on your project.</p>

<p>You also have nuggets like:</p>
<code>if (nrhistentries &lt;= 4 || /* other condition */)<br/>
      {<br/>
        if (nrhistentries &gt; 0) {<br/>
          histogram[0].index = 0;<br/>
          if (nrhistentries &gt; 1) {<br/>
            histogram[1].index = 1;<br/>
            if (nrhistentries &gt; 2) {<br/>
              histogram[2].index = 2;<br/>
              if (nrhistentries &gt; 3) {<br/>
                histogram[3].index = 3;<br/>
              }<br/>
            }<br/>
          }<br/>
        }</code>
<p>Which I would like to replace with:</p>
<code>
int max_histentries = (nrhistentries&gt;4)?4:nrhistentries;<br/>
for (i=0; i&lt;max_histentries; ++i) {<br/>
    histogram[i].index = i;<br/>
}</code>
<p>I also wonder what the point is of putting semicolons after comments.</p>
<p>In conclusion: I was in your camp until this discussion started - I really never ever use goto. You, however, have convinced me that there are reasonable exceptions to that rule.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/628151/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628177"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Why the f*ck do you for instance do things like this?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 20:42 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628177/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <P>I have this convention: if one of the exits from a loop is via an explicit <TT>break</TT>, then <I>all</I> exits from the loop shall be via explicit <TT>break</TT>s. That way you don’t have to look for more than one kind of termination condition, just look for the <TT>break</TT>s. Only if there are none will there be something like a <TT>for</TT>-loop termination condition. Never mix the two.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628177/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628184"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Why the f*ck do you for instance do things like this?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 21:12 UTC (Tue)
                               by <b>filipjoelsson</b> (guest, #2622)
                              [<a href="/Articles/628184/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then don't use a for-loop for that. Use a do-while-loop. A for-loop is for iterating until a certain condition is met. The compiler is built to warn on relevant error patterns. Since you use the for-loop in this unexpected way - no one but you can contribute to your project. In effect it's only so much dead code. <br>
<p>
Is there any construct that you use as intended?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628184/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor628154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Please, no knee-jerk &quot;no goto ever&quot; reactions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 3:00 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/628154/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Your code already uses gotos - albeit each one rendered with an indented, gaudy costume of do-break-while-0 euphemism.<br>
<p>
But the compiler can see your royal highness is stark naked. And so can we.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628159"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Please, no knee-jerk &quot;no goto ever&quot; reactions</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 9:47 UTC (Tue)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/628159/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>
GOTO used to be a real problem when it was all that people had for control flow (think 1960s-era FORTRAN).
</p>
<p>
Right now with the proper discipline I don't have a huge problem with “goto” in C. As far as I'm concerned it is way less of a problem for program structure than the style that ldo is advocating. ldo's style also seems to presuppose that “cleanup” consists exclusively of undoing earlier things in reverse order; in general one might have to do things in an error branch that one might not have to do during normal flow, and sorting these cases out just serves to make the code even more convoluted on top of all the extraneous “do { … } while (0)” and “if (…) break” constructs.
</p>
<p>
I teach programming as my day job (some of the time, anyway), and I can guarantee that anybody who came to me with code like ldo's would get a very stern talking-to.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/628159/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628180"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: in general one might have to do things in an error branch that one might not have to do during normal flow</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 20:53 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628180/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe this is another instance of the “cleanup” versus “rollback” argument made elsewhere. See my comments about idempotency of deallocation routines and NULLing subsumed pointers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628180/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627747"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Wouldn't it be simpler and more readable to use a goto instead of a pseudo-loop?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 22:41 UTC (Thu)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/627747/">Link</a>] (28 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't get religious, please.  goto can easily be abused, but your cute trick with do-while(false) is no better - it avoids the Bad Word(tm), but it's limited to idempotent cleanups (i.e. you'll end up breeding a bunch of flags for "do I need to drop this lock", etc., and it makes for hard-to-verify logics just as easy as goto abuse) *and* it's asking for trouble when you modify the code around that break.  E.g. a loop or switch added, with location in question ending up inside the body.<br>
<p>
It's both unidiomatic and brittle.  Avoiding goto is generally a good idea, but this isn't a good way to do it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627747/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: E.g. a loop or switch added,</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 25, 2014 23:10 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627757/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <P>That code already has plenty of loops in it, and you can see for yourself how to keep the interactions simple in that situation.

<P>This isn’t a question of “religion”, it’s one of “bitter experience”. Learn from it!
      
          <div class="CommentReplyButton">
            <form action="/Articles/627757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627763"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: E.g. a loop or switch added,</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 0:03 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627763/">Link</a>] (26 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, no. That's a religion.<br>
<p>
Experience shows that idiomatic "goto error_exit" is far better than the alternatives with fake loops and flags.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627763/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Experience shows that idiomatic &quot;goto error_exit&quot; is far better than the alternatives with fake loops and flags.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 0:36 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627766/">Link</a>] (25 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Prove it. You have my code. Go rewrite it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627768"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Experience shows that idiomatic &quot;goto error_exit&quot; is far better than the alternatives with fake loops and flags.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 1:32 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627768/">Link</a>] (24 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This particular piece? In ANSI C it'll be something like the code below. In a more sane language I'd use automatic resource management (even in C with GCC extensions).<br>
<p>
I won't bother to rewrite all of the code, so only for ParseColorTuple: <a rel="nofollow" href="https://gist.github.com/Cyberax/4546471dcb026c141369">https://gist.github.com/Cyberax/4546471dcb026c141369</a> (sorry for possible issues with indentation).<br>
<p>
It's now 10 lines less and much more concise (WTF are you incrementing the for-loop variable manually and then manually check conditions?).<br>
<p>
I've also fixed a bug in line 246 (failure to check error immediately).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627768/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627776"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: I won't bother to rewrite all of the code, so only for ParseColorTuple:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 2:12 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627776/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      <P>At least you made the effort, even if you “fixed” a non-bug and succeeded in introducing a real bug.

<P>This was a simple, almost trivial case. Now try a more complex one. Elsewhere you will see do-once constructs nested up to 3 deep. And then there’s loops. Try and see how well your <TT>goto</TT> constructs scale up to those complexities.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627776/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627787"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: I won't bother to rewrite all of the code, so only for ParseColorTuple:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 4:59 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627787/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; and succeeded in introducing a real bug. </font><br>
Where?<br>
<p>
<font class="QuotedText">&gt; This was a simple, almost trivial case. Now try a more complex one. </font><br>
You can do it _automatically_ by rewriting do-nothing loops into 'goto cleanup' and merging cleanup actions if needed.<br>
<p>
<font class="QuotedText">&gt; Elsewhere you will see do-once constructs nested up to 3 deep. </font><br>
That's not something to be proud of, you know. It means that you've failed to decompose your logic into smaller fragments.<br>
<p>
And the rest of your code... <br>
<p>
It pretty much falls into the 'unmaintainable crap' bin. Everything is just perfect: eclectic code style, exotic constructs (inner functions in... C?), profligate usage of goto disguised as do..nothing loops, functions spanning hundreds of lines, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627787/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: It pretty much falls into the 'unmaintainable crap' bin</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 5:34 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627791/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Too bad, that your programming ideas only work with toy examples, not with real-world code.<br>
<p>
Come back when you’ve learned a bit more about programming.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627792"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: It pretty much falls into the 'unmaintainable crap' bin</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 5:40 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627792/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Too bad, that your programming ideas only work with toy examples, not with _real-world code_.</font><br>
Like... I don't know, say an OS kernel?<br>
<p>
Or perhaps an audio codec? Nah, can't write those with gotos: <a rel="nofollow" href="https://git.xiph.org/?p=opus.git;a=blob;f=src/opus_encoder.c;h=cdcee083dfd926f93e62f45eb6ba3ec56d8ac45e;hb=refs/heads/master#l2100">https://git.xiph.org/?p=opus.git;a=blob;f=src/opus_encoder.c;...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627792/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Or perhaps an audio codec?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 21:21 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627855/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <P>While I’m sure it is quite complex code, it doesn’t seem to do much with dynamic storage: I found just two calls to <TT>opus_free</TT> in those 2500-odd lines.

<P>While my example is half that size, it has 39 calls to <TT>PY_{</TT>,<TT>X</TT>}<TT>DECREF</TT>.

<P>Come back when you can cope with that kind of complexity.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627857"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Or perhaps an audio codec?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 21:25 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627857/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Your wish is my command: <a rel="nofollow" href="http://lxr.free-electrons.com/source/drivers/net/tun.c#L1741">http://lxr.free-electrons.com/source/drivers/net/tun.c#L1741</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627857/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627922"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Your wish is my command</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:56 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627922/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Now try one with a loop.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627922/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627924"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Your wish is my command</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:58 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627924/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What do you mean by "with a loop"? And feel free to try it yourself, since you're such a religious fanatic of do-nothing loops. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627924/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627944"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: What do you mean by &quot;with a loop&quot;?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 21:43 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627944/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My code has examples of loops where errors can occur in them. So I need to deal gracefully with that. Let’s see you offer an example that does the same.<br>
<p>
And while we’re at it, your tun.c example fails to recover if it cannot create its sysfs device files.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627944/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627945"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: What do you mean by &quot;with a loop&quot;?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 22:01 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627945/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; My code has examples of loops where errors can occur in them. So I need to deal gracefully with that. </font><br>
No you don't. Just split them up into free-standing functions, instead of 300-line monstrosities.<br>
<p>
The Linux kernel manages to do that just fine, somehow.<br>
<p>
In particular, your block near line 480 will look like this: <br>
<a rel="nofollow" href="https://gist.github.com/Cyberax/3a7796231be66d0f64cc">https://gist.github.com/Cyberax/3a7796231be66d0f64cc</a><br>
(no, I'm not going to check it in details). It's pretty clear that simply by splitting some logic into a function you can decrease nesting level by 3.<br>
<p>
And let me reiterate, your code is a mess. For example, you use 'break' to normally exit the outer loop from within the 'if' statement here: <a rel="nofollow" href="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c#L520">https://github.com/ldo/dvd_menu_animator/blob/master/spuh...</a><br>
<p>
Why do you even bother with 'for' loops?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627945/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627967"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:  And let me reiterate, your code is a mess. </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:29 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627967/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <P>At least it works, unlike your code.
<UL>
<LI>Your <TT>for</TT>-loop will never iterate.
<LI>Where is <TT>PixBuf</TT> supposed to be local to?
</UL>
<P>Pot calling the kettle black, as it were?
      
          <div class="CommentReplyButton">
            <form action="/Articles/627967/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627968"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:  And let me reiterate, your code is a mess. </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:31 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627968/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have not claimed that my code works (as I wrote it on a dumb web form without even automatic indentation). But it's far easier to understand and fix than your mess of twisty little loops, all alike.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627968/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: I have not claimed that my code works</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:36 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627971/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then what is the point? I thought you were trying to demonstrate that you could do the same thing more simply and/or clearly than I could. But instead you have totally stuffed it up.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627972"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: I have not claimed that my code works</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:41 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627972/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't really care to try to understand what your code actually means. It's so convoluted that it's absolute unmaintainable.<br>
<p>
If you can make a reasonable description of what it does - I can guarantee that it's possible to write it far cleaner then what you have.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627972/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: If you can make a reasonable description of what it does</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 21:33 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627995/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Did you not read the comments? There are even Python docstrings; did you not see those?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627999"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: If you can make a reasonable description of what it does</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 22:37 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627999/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, they don't describe the algorithm. Please, provide a coherent description in a natural language (I understand English, Russian, Ukrainian, German and Polish) then I can provide you its implementation that will be more compact and easy-to-understand than yours.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627999/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628102"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Please, provide a coherent description</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 17:26 UTC (Mon)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628102/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Funny, I didn’t see any such thing in the code examples you saw fit to refer me to. Yet you expected me to cope with them. And my code already has far more comments than they did.<br>
<p>
What’s good for the goose, eh?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628102/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: It pretty much falls into the 'unmaintainable crap' bin</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 16:14 UTC (Fri)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/627820/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Too bad, that your programming ideas only work with toy examples, not with real-world code.</font><br>
<p>
This is like the guy complaining about _all_ those damn ghost drivers on the highway.<br>
<p>
Huge projects use goto for error handling successfully. See the Linux kernel for instance.<br>
And your "nested pseudo loops error handler" argument is void, because thouse unmaintainable monsters should be split into sub-routines anyway. And then it can use plain gotos. Which gains the additional opportunity to write structured error paths instead of "one must handle all errors" error paths.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Huge projects use goto for error handling successfully</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 21:15 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627854/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or perhaps not so successfully. Otherwise we would not have this article.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627894"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Huge projects use goto for error handling successfully</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 11:32 UTC (Sat)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/627894/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The article talks (as a side note) about untested error paths.<br>
Your complex pseudo-loop can't help here at all. It just adds extra complexity. The error paths will still be untested.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627894/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: The error paths will still be untested.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:40 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627916/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It makes them easier to see. That helps in writing the code in the first place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627948"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: The error paths will still be untested.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 23:14 UTC (Sat)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/627948/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>The pseudo-loops <em>hide</em> the error processing in a structure that could be anything else, and which BTW I haven't seen anywhere else either. ln comparison, the "label: &lt;error handling code&gt;" pattern is easy to spot.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/627948/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627969"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: The pseudo-loops hide the error processing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:33 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627969/">Link</a>] 
      </p>
      
      </div>
      </summary>
      No, the cleanups always happen <I>after</I> the <TT>do-once</TT> constructs. <B>That’s how you can be sure they will always be executed.</B>
      
          <div class="CommentReplyButton">
            <form action="/Articles/627969/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627825"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: I won't bother to rewrite all of the code, so only for ParseColorTuple:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 16:30 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/627825/">Link</a>] 
      </p>
      
      </div>
      </summary>
      (do/once constructs nested up to three deep)
<blockquote>
That's not something to be proud of, you know. It means that you've failed to decompose your logic into smaller fragments.
</blockquote>

Actually it means he's probably trying to do multiple things which need unwinding, but because he can't use three goto labels and rely on fallthrough he has to add a layer of almost-entirely-redundant nesting for each one.
<p>
This is not something that you'd call out as an advantage and a sign of great experience unless you didn't actually have much. (But it's been worth reading this thread anyway: it's not every day you see people telling Al Viro that he doesn't have enough experience to judge the relative worth of exception-handling goto versus other techniques!)
      
          <div class="CommentReplyButton">
            <form action="/Articles/627825/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor627764"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 0:08 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627764/">Link</a>] (42 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If you want to see a more elaborate example, including loops and nested do-once-within-do-once, have a look at this spuhelper.c Python extension module. </font><br>
Ugh. This is an unmaintainable mess.<br>
<p>
For example: <a rel="nofollow" href="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c#L264">https://github.com/ldo/dvd_menu_animator/blob/master/spuh...</a> - does this 'break' exits the loop or is it simply an error exit?<br>
<p>
Also, it looks like the outer loop will still do additional steps since 'break' only affects the inner loop, possibly causing more errors.<br>
<p>
And what then? Ah, there's a dependency on a hidden state ('PyErr_Occurred').<br>
<p>
Ugh once more.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627764/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: does this 'break' exits the loop or is it simply an error exit?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 0:38 UTC (Fri)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627769/">Link</a>] (41 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hint: check the condition.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627877"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: does this 'break' exits the loop or is it simply an error exit?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 1:10 UTC (Sat)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/627877/">Link</a>] (40 responses)
      </p>
      
      </div>
      </summary>
      Are you choosing this...

<pre>
for (i = 0; i &lt; MAX; ++i) {
   do { /*once*/
       if (err) {
           i = MAX;
           break;
       }
   } while (false);
}
</pre>

over this?

<pre>
goto cleanup;
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/627877/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627879"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: does this 'break' exits the loop or is it simply an error exit?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 1:24 UTC (Sat)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/627879/">Link</a>] (39 responses)
      </p>
      
      </div>
      </summary>
      This isn't good...

<pre>
for (i = 0; i &lt; IMAX; ++i)
{
    for (j = 0; j &lt; JMAX; ++j)
    {
        do { /* once */
            if (PyErr_Occurred())
                break;
        } while (false);
        if (PyErr_Occurred())
            break;
    }
    if (PyErr_Occurred())
        break;
}
</pre>


This is far better...

<pre>
for (i = 0; i &lt; IMAX; ++i)
{
    for (j = 0; j &lt; JMAX; ++j)
    {
        if (PyErr_Occurred())
            goto done;
    }
}

done:
</pre>

Dealing with complexity means splitting a complex problem up into simple things people can understand.  Good programmers don't write complex code.

Good programmers write simple code.


Also, the *ONLY* time you should use a pseudo-loop like this is in a macro so the compiler will accept the semi-colon following it...

<pre>
#define COMPLEX_MACRO_SHOULD_BE_A_FUNC(x) do { \
    /* complex macro code isn't good either */ \
} while (0)
</pre>

later...

<pre>
COMPLEX_MACRO_SHOULD_BE_A_FUNC("hello world");
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/627879/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: This is far better... </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:44 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627918/">Link</a>] (38 responses)
      </p>
      
      </div>
      </summary>
      You <B>do</B> realize that <TT>PyErr_Occurred()</TT> is checking for an error from <I>other</I> API calls, right? So where do you put these API calls in your example?
      
          <div class="CommentReplyButton">
            <form action="/Articles/627918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627920"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: This is far better... </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 20:55 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/627920/">Link</a>] (37 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right before the PyErr_Occurred.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627920/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Right before the PyErr_Occurred.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 27, 2014 21:32 UTC (Sat)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627941/">Link</a>] (36 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You need to fill in your example some more. Try, say, your version of the block beginning on line 480.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627960"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Right before the PyErr_Occurred.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 3:51 UTC (Sun)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/627960/">Link</a>] (35 responses)
      </p>
      
      </div>
      </summary>
      <pre>
for (i = 0; i &lt; IMAX; ++i)
{
    for (j = 0; j &lt; JMAX; ++j)
    {
        /* Some Python C calls, allocations, etc */

        if (PyErr_Occurred())
            goto done;
    }
}

done:
    free(whatever);
    if (fileptr)
        fclose(fileptr);

</pre>

Don't fight it.  Embrace goto statements.  Goto is clearly better than calling PyErr_Occurred multiple times.  For all we know, PyErr_Occurred checks the entire state of the Python interpreter (possible a non-trivial, expensive, operation).  goto done will emit one machine instruction.  Don't abuse other language constructions (do nothing loops) just to avoid using a goto...especially when you're effectively doing the same thing.  Try it.  You'll like it.
      
          <div class="CommentReplyButton">
            <form action="/Articles/627960/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627966"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Right before the PyErr_Occurred.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 6:19 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627966/">Link</a>] (34 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You need to make it more explicit. Rewrite the part of my code that I pointed you to, so we can compare and see which is better.<br>
<p>
There seems to be a marked reluctance among most of you nay-sayers to do this. But that is the only way you can prove that there is something to your point, more than mere hand-waving hot air.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627966/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Right before the PyErr_Occurred.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 12:44 UTC (Sun)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/627981/">Link</a>] (33 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Laurence - discussion of goto usage is historically well trodden territory and this thread seems a little off topic and repetitive.  <br>
<p>
Did you read the LWN Christmas/end of year message?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627996"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 22:17 UTC (Sun)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/627996/">Link</a>] (32 responses)
      </p>
      
      </div>
      </summary>
      <P>For those who just came in, and are too lazy to read the rest of the thread before sticking their oar in:

<P><UL>
<LI>The article is about an assumption about (lack of) possible failures of certain memory allocations, which has somehow baked itself into many parts of the Linux kernel since long before anyone can now remember.
<LI>This assumption now seems to be unwise. However, it is going to be hard to remove, because of the complexity of error-recovery paths right through the kernel.
<LI>I offered up a general technique for simplifying such error-recovery paths, and gave a decently non-trivial <A HREF="https://github.com/ldo/dvd_menu_animator/blob/master/spuhelper.c">example</A> to illustrate it in action, solving a reasonably complex, real-world problem. A key part of the technique is that it avoids <TT>goto</TT>s. This way, you can be sure that cleanups will always execute, no matter which way the flow of control goes.
<LI>My efforts so far have been met with fear, hostility, and just plain prejudice. Several people have tried to claim that using <TT>goto</TT>s would be preferable to my technique.
<LI>Yet, when challenged, they are unable to actually prove their point, by offering simpler alternatives to my code.
<LI>So they resort to trying to cast aspersions on the quality of my code.
<LI>But that just brings us back to the same point: if they think my code is too complicated or just plain crap, why can’t they do better? <B>Why can they not come up with something simpler to solve the same real-world problem?</B> But they cannot.
</UL>

<P>Any questions?

      
          <div class="CommentReplyButton">
            <form action="/Articles/627996/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor627998"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 22:56 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/627998/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      The problem in the kernel is not an inability to be sure that cleanups will execute. With the goto exception-handling technique, unless you omit a goto, they always execute, and if your cleanups are executed in the normal path (i.e. there is no return before the goto label) they will execute even if you omit a goto. This is *exactly the same* as in your technique.
<p>
The problem in the kernel is an inability to be sure that what those code paths do on error is even sane. They will execute if triggered, but because of this "too small to fail* rule, many of them have never executed, even when the system is out of memory.
<p>
Your digression on an idiosyncratic (and IMNHSO needlessly verbose and unreadable) technique to replace gotos is not relevant to this problem so cannot solve it.
<p>
To me, the technique appears similar to the panic that strikes people who started with one-return languages like Pascal when they are faced with languages that allow multiple returns. Yes, if carelessly used this can lead to unreadable spaghetti, but that doesn't mean the right answer is to ban it! It's amazing how many of my functions these days reduce to
<p>
<pre>
int err = -1;

if (do-nothing-fastpath-test)
    return 0; /* early */

stuff that allocates memory or does other things needing cleanup in both success and failure cases
if (error check)
   goto cleanup_stuff;

stuff that doesn't need cleanup but can fail
if (error check)
   goto cleanup_stuff;

more stuff
if (error check)
   goto cleanup_more_stuff;

...

err = 0; /* success */

cleanup_more_stuff:
undo 'more stuff'

cleanup_stuff:
undo 'stuff'

return err;
</pre>

It is clear that in this code -- other than in the early-fast-exit case -- the cleanups will always execute. You don't have to have a 'return' before them! The normal flow of control passes smoothly through them at all times: it's just that the cleanups can skip some of that flow (the parts relating to things they did that don't need cleanup, and where the cleanup is not something like free() that is harmless to do on something that was never allocated).
<p>
Notice how little code error handling includes here -- I've replaced the actual work with pseudocode, but even in the real code the error unwinding is *two lines per check*, one an unavoidable conditional, plus optional extra work in those conditionals to do error-specific stuff first. The cleanup is no extra code: it's just a couple of goto labels, and if you miss one of them out or somehow manage to do some cleanup at a too-deeply-nested level you get a nice easy-to-spot syntax error.
<p>
This is ever so much neater than your false-loops approach and involves much less spurious nesting. It's linear in the normal case, just like the actual code flow, with branches only in exceptional conditions, while your code makes *loops* look like the normal condition, even though those loops actually never happen. Plus, spurious break and continue are both correctly diagnosed as syntax errors: in your approach, they cause a silent and erroneous change in control flow, as if an error had happened. It is much easier to mistakenly type or transpose 'break' outside e.g. a switch than it is to accidentally type 'goto some_cleanup'!
<p>
In my view it is you who has manifestly failed to understand the merits of our approach, which is quite clearly beneficial on every metric I can see other than the unthinking one which assigns an infinite automatic negative value to any use of 'goto' regardless, even uses which only jump forward in control flow to the end of a function and are thus precisely equivalent to a block with a cleanup in it and then a return. Spaghetti code this is not! It is much less spaghetti than yours.
<p>
Note: I came from a Pascal background and was at first violently anti-goto *and* anti-multiple-returns. When I look at my code from those long-ago days the contorted control flow is almost unreadable. Almost all the time a nice linear flow is preferable. Save loops for things that can actually *loop* at least once -- and for the while (0) macro trick.

      
          <div class="CommentReplyButton">
            <form action="/Articles/627998/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628004"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 0:41 UTC (Mon)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/628004/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>That is exactly the point: With the Linux goto usage the <em>normal</em> code path is linear and clear for all to see, <em>failure</em> exceptional code paths are kept apart, for separate analysis (which they require, as "normal situation" isn't guaranteed in them).</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/628004/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628015"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 4:20 UTC (Mon)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/628015/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
TBH, my impression is that ldo either has never bothered to read any of the relevant papers (Dijkstra, Hoare, etc.) *or* has confused the proofs that goto doesn't add any expressive power (e.g. compared to mutual (tail) recursion) with the discussions of the reasons why goto often leads to brittle code that is hard to reason about.  And these are very different things - by the very nature of such proofs, feeding them a hard-to-analyse ball of spaghetti yields an equally hard to analyse goto-free equivalent, so they actually demonstrate both that goto can be avoided *and* that avoiding goto doesn't guarantee avoiding the problems usually associated with it.<br>
<p>
BTW, from the control flow graph decomposition POV, break is an atrocity almost equal to multiple returns (and if you add break &lt;number of levels&gt;<br>
a-la sh(1), it becomes _worse_ than multiple returns).  Not to mention its inconsistency between if() and switch(), etc.<br>
<p>
Frankly, this sort of attitude is best cured by careful reading of the standard papers circa late 60s--early 70s *plus* sorting through the usual fare on lambda-lifting, supercombinators and related stuff (circa early 80s) *plus* that on the monads sensu Peyton-Jones et.al.  Attitude re goto-phobia, that is - "my code is perfect, whaddya mean, idiosyncrasies?" one is cured only by sufficiently convincing LART...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628015/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: ldo either has never bothered to read any of the relevant papers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 20:57 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628181/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or maybe you never bothered to look at my code?<br>
<p>
Feel free to try any of the error-recovery-within-loop cases. That is where the rubber hits the road, and where all the goto-ists have come a cropper.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor628000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 23:33 UTC (Sun)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628000/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This way, you can be sure that cleanups will always execute, no matter which way the flow of control goes.</font><br>
<p>
Stop right here. The problem is not with cleanups which should always be executed; these are already well-tested. The problem is with cleanups which should *never* be executed, unless an error happens.<br>
<p>
In exception-handling terms, what you are talking about is a "finally" block, which executes both on success and on failure. The error-recovery paths in question, however, are "except" blocks, which execute only on failure.<br>
<p>
For a filesystem-related example, since we're supposed to be talking about filesystems: let's say a user program just appended something into a file, and you're in the function which will submit the newly appended data to the block subsystem. As part of that, it has to allocate space for the new data, updating several of the filesystem's control structures, and allocate the control structures for the block subsystem.<br>
<p>
If any allocation fails in the middle of this complex process, you have to unwind all the bookkeeping updates, otherwise the filesystem gets into an inconsistent state. If no allocation fails, however, the bookkeeping changes must be kept, since they represent the new state of the filesystem.<br>
<p>
Is the pseudo-loop technique able to do the equivalent of an "except" block without getting even uglier? Remember that the rewind will have to be called from many places, since any of the allocations can fail, and that the failure can also be in the middle of the the initial update of the control structures, so the rewind might be partial.<br>
<p>
The traditional way of doing this in the Linux kernel is somewhat like the following:<br>
<p>
int foo(...)<br>
{<br>
  int err = 0;<br>
  /* do stuff */<br>
  err = bar(...);<br>
  if (err)<br>
    goto error;<br>
  /* do even more stuff */<br>
  err = baz(...);<br>
  if (err)<br>
    goto error;<br>
  /* do yet more stuff */<br>
out:<br>
  /* free temporary memory and unlock mutexes */<br>
  return err;<br>
error:<br>
  /* unwind state updates */<br>
  goto out;<br>
}<br>
<p>
The kernel developers are pragmatic. If a kernel developer feels that using a "pseudo-loop" results in cleaner code, they do use it. However, for error handling the usual design pattern is either a "goto error" (single error label, pointers initialized to NULL) or a "goto error_foo" (many error labels, each falling through to the next, releasing resources in reverse order). On success, either the unlock is duplicated (it's usually just a unlock, memory is rarely allocated just for the duration of one function), or the error handling does a "goto out" like in the example above.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: The problem is with cleanups which should *never* be executed, unless an error happens.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 17:35 UTC (Mon)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628106/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <P>This is why cleanups should be idempotent--pass the cleanup routine a NULL argument, and it does nothing. So the steps become something like
<UL>
<LI>Allocate the first thing needing cleanup; abort on failure
<LI>Allocate the second thing needing cleanup; abort on failure
<LI>If the second thing subsumes the first thing (so cleaning up the second thing automatically cleans up the first thing), then you can set the first thing to NULL at this point, to avoid a double cleanup.
<LI>And so on.
</UL>
<P>So when you get to the end, you simply execute all the relevant cleanups unconditionally, and the ones with NULL arguments turn into no-ops.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: The problem is with cleanups which should *never* be executed, unless an error happens.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 18:14 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628110/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If the second thing subsumes the first thing (so cleaning up the second thing automatically cleans up the first thing), then you can set the first thing to NULL at this point, to avoid a double cleanup.</font><br>
<p>
You still are in the "cleanup" mentality. But the problem with filesystems is not "cleanup", it's "rollback". There's nothing to subsume the relevant code, and it subsumes nothing else; it's really something which executes only on failure.<br>
<p>
<font class="QuotedText">&gt; So when you get to the end, you simply execute all the relevant cleanups unconditionally, and the ones with NULL arguments turn into no-ops.</font><br>
<p>
That doesn't help with the situation in question, where the memory allocation routines never return "failure". The relevant error-recovery code would always get passed NULL, and so the branch which is called when it receives a non-NULL never gets tested.<br>
<p>
Sure, you *called* the code unconditionally, but it doesn't change the fact that it *executes* conditionally. Whether the branch point is outside or inside it is immaterial. For instance, it's well-known that the standard "free(void *ptr)" function does nothing when called with a NULL argument, but that's because it begins with a conditional branch: "if (!ptr) return;". If it were always called with a NULL pointer, the most complex part of its code would never be exercised.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: You still are in the &quot;cleanup&quot; mentality.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 20:34 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628175/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <P>That’s right. You keep insisting that “cleanup” and “rollback” are entirely different, whereas they are really two aspects of the same thing, and can be treated as such.

<P>&gt; That doesn't help with the situation in question, where the memory<BR>
&gt; allocation routines never return "failure".

<P>Returning <TT>NULL</TT> from an allocation request <I>is</I> a failure.

<P>&gt; Sure, you *called* the code unconditionally, but it doesn't change<BR>
&gt; the fact that it *executes* conditionally.

<P>Do you know what “abstraction” means?
      
          <div class="CommentReplyButton">
            <form action="/Articles/628175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628190"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: You still are in the &quot;cleanup&quot; mentality.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 22:33 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628190/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; &gt; That doesn't help with the situation in question, where the memory allocation routines never return "failure". </font><br>
<font class="QuotedText">&gt; Returning NULL from an allocation request is a failure.</font><br>
<p>
Please, reread the article this comment thread is attached to.<br>
<p>
The whole issue is that, under certain conditions, the allocation requests were *never* returning NULL, even when they should!<br>
<p>
<font class="QuotedText">&gt; &gt; Sure, you *called* the code unconditionally, but it doesn't change the fact that it *executes* conditionally. </font><br>
<font class="QuotedText">&gt; Do you know what “abstraction” means?</font><br>
<p>
Please, reread the article this comment thread is attached to.<br>
<p>
Abstraction or not, it doesn't change the fact that, since the allocation requests were *never* returning NULL, even when they should, the error handling code was *never* being executed. It doesn't matter whether it has been abstracted away or not, untested code is untested code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628190/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: requests were *never* returning NULL, even when they should!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 21:00 UTC (Wed)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628242/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Precisely the point. And changing them to return NULL is fraught, because the error-handling paths in the callers are quite likely riddled with omissions where they should be dealing with this case. And finding and fixing those omissions is hard, because the error-handling paths are so complex.<br>
<p>
Which is why I am advocating simpler error-handling paths, as in my example.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor628001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 28, 2014 23:59 UTC (Sun)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/628001/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You think that, just because nobody wants to refactor your 1300-line hellishly-nested file with way-too-long functions, you win the argument?<br>
<p>
Hardly.  Reread Cyberax's replies with an open mind this time.  He's right: carefully applied gotos would take care of your "do /* once */ {} while(false)" nesting and ambiguous breaks.  If you want to make your code more readable, this would be a great first step.  After that, you could give it a good scrubbing with <a href="https://www.kernel.org/doc/Documentation/CodingStyle">https://www.kernel.org/doc/Documentation/CodingStyle</a><br>
<p>
But, from your aggressive writing style, it sounds like you'd rather argue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: you win the argument?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 17:28 UTC (Mon)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628103/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes.<br>
<p>
I took the trouble to write all that code which proves my point. If you want to prove yours, you have to do the same.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor628003"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 0:35 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628003/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; So they resort to trying to cast aspersions on the quality of my code.</font><br>
<p>
Taking a look at that code, it's easy to see why. It has a rather unorthodox coding style, which can make coders used only to common coding styles for both C *and* Python recoil in horror.<br>
<p>
The code layout is the first thing one unavoidably notices when first looking at a new source code file, so even before even they can even consider the actual code quality, your code already has a negative score in their minds.<br>
<p>
In particular, Python does have a standard coding style for C code: <a href="https://www.python.org/dev/peps/pep-0007/">https://www.python.org/dev/peps/pep-0007/</a>. When in Rome...<br>
<p>
Here are, in no particular order, a few of the things which made *me* recoil in horror on a quick look at that code:<br>
<p>
* The placement of the parameters in a function definition.<br>
* The placement of the comment describing the function. Its traditional location (and the one all code-documentation tools expect) is before the function; you placed it just before the opening brace, where the parameters types were declared in pre-standard C.<br>
* The unorthodox indentation of a multi-line expression, which placed each operator in its own line (instead of, as usually done, either at the end or at the beginning of a line).<br>
* The use of an "end comment" for control structures. An actual example from that code file:<br>
<p>
for (; i &lt; 4; ++i)<br>
{<br>
/* ... */<br>
} /*if*/<br>
<p>
Yes, the comment doesn't match the control structure it's attached to. This is why most people don't bother with these sorts of comments: unless they are part of the language (and thus forced to be correct by the compiler), they can and will end up being wrong.<br>
<p>
None of that affects the quality of the compiled code; it's all stripped by the compiler (even the "dummy loops" are optimized out). The exception is all the PyErr_Occurred() calls; your code has redundant calls to that function (it's not a macro, so it won't be optimized out), which probably wouldn't happen with a more standard coding style.<br>
<p>
Your code might or might not have a good quality; the strange coding style makes it unnecessarily hard to tell. And as others have noted, it has a few "code smells" (<a href="https://en.wikipedia.org/wiki/Code_smell">https://en.wikipedia.org/wiki/Code_smell</a>), like excessively long functions, which usually correlate with a lower code quality.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628003/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628021"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 9:39 UTC (Mon)
                               by <b>itvirta</b> (guest, #49997)
                              [<a href="/Articles/628021/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;The article is about an assumption about (lack of) possible failures of certain memory allocations,</font><br>
<font class="QuotedText">&gt;which has somehow baked itself into many parts of the Linux kernel since long before anyone can now remember.</font><br>
<p>
About errors promised, but not returned, and the numerous error paths that are untested<br>
because of that (plus a nice lock-up), if I got it right. The actual coding style of the error<br>
paths seems unrelated.<br>
<p>
<font class="QuotedText">&gt; Yet, when challenged, they are unable to actually prove their point, by offering simpler</font><br>
<font class="QuotedText">&gt; alternatives to my code.</font><br>
<font class="QuotedText">&gt; So they resort to trying to cast aspersions on the quality of my code.</font><br>
<p>
You've repeated about five times the suggestion that someone _else_ should prove their<br>
way by reorganising _your_ code. Given that everyone else, including the Linux kernel folks<br>
seem to be happy with their gotos against your suggestion, it seems that the numbers are<br>
against you, and I've seen no proof for your way other than your personal (and persistent) <br>
assertion.<br>
<p>
Not that mere numbers prove everything, but it makes one wonder. As does the fact that<br>
someone tried to rework your code, but made mistakes. Doesn't that also reflect badly on your<br>
code? Perhaps it isn't as well-readable as you assert? Some specific issues about the coding<br>
style have been mentioned, but I haven't seen any real arguments to defend them, except the<br>
dogmatic anti-goto attitude. (And you accuse others of prejudice!)<br>
<p>
I stumbled upon a rather apt quote attributed to Dijkstra regarding his well-known article<br>
about not using goto. Perhaps you should ponder on it for a moment: <br>
"I have the uncomfortable feeling that others are making a religion out of it, as if the conceptual<br>
problems of programming could be solved by a single trick, by a simple form of coding discipline!"<br>
<p>
<font class="QuotedText">&gt; But that just brings us back to the same point: if they think my code is too complicated or just</font><br>
<font class="QuotedText">&gt; plain crap, why can’t they do better? Why can they not come up with something simpler to solve</font><br>
<font class="QuotedText">&gt; the same real-world problem? But they cannot.</font><br>
<p>
If this is just an exercise, perhaps a smaller one would do. Also of course, you could do your<br>
part in comparing the options. It's not like anyone has a responsibility to attend to exercises<br>
someone else gives on the Internet. If you want to take the lack of submissions as proof of<br>
your superior position,  you are of course free to do so. But it doesn't mean you are right, <br>
or that others will want to talk to you after that.<br>
<p>
<p>
Somehow, I'm starting to hope you are just trolling. That would at least _explain_ all of this. :)<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628021/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628182"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: If this is just an exercise, perhaps a smaller one would do</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 21:00 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628182/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My sample code already includes both simple cases and complex ones. Others have already tackled the simple cases, and frankly, I don’t think they prove anything either way. But that is the nature of classroom exercises; they never quite prepare you for real-world code.<br>
<p>
It is the complex cases that demonstrate the scalability of my technique over GOTOs. This is evidenced by the fact that no one can come up with an equivalent using GOTOs that is even correct.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628182/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628192"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: If this is just an exercise, perhaps a smaller one would do</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 22:56 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628192/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; This is evidenced by the fact that no one can come up with an equivalent using GOTOs that is even correct.</font><br>
<p>
Absence of evidence is not evidence of absence.<br>
<p>
You posted a large block of source code, without any testcases, written in an unorthodox coding style. To do a decent rewrite, first one would have to understand the code, which is made harder by the uncommon code style and by the fact that it's a mathematical algorithm; experienced programmers tend to "pattern match" the source code visually to skip unimportant details, but this can only happen if one is familiar with the coding style. Then one would have to carefully reformat each function, converting the do-nothing loops into straight code without breaking the do-something loops; this is made harder because the same keyword (break) is being used to exit both. Finally, one would have to refactor the code into a more traditional style, being very careful to not break anything (since there are no testcases).<br>
<p>
That's a lot of work for something which would be used solely to score a rhetorical point and then thrown away; the maintainer of the code (you) would not accept the changed code, since you're being so dogmatic about your coding style.<br>
<p>
It could be worth doing the exercise if there was any chance that it would not be a wasted effort. Since there isn't, there are better uses for our time, and that's probably why nobody's bothering.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628192/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Absence of evidence is not evidence of absence.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 21:01 UTC (Wed)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628243/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <B>*Yawn*</B> More content-free hand-waving hot air. <B>Show us the code!</B>
      
          <div class="CommentReplyButton">
            <form action="/Articles/628243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Absence of evidence is not evidence of absence.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 22:25 UTC (Wed)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/628247/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you want something to be rewritten so bad, why don't you rewrite the goto-laden kernel examples cesarb posted?  It should be easy to demonstrate how much more readable your technique is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628277"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: why don't you rewrite the goto-laden kernel examples cesarb posted?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 21:46 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628277/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Because they’re just <A HREF="http://lwn.net/Articles/628276/">not that interesting</A>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628277/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor628121"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Story So Far...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 18:36 UTC (Mon)
                               by <b>acollins</b> (guest, #94471)
                              [<a href="/Articles/628121/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looking at your spuhelper.c example has convinced me of the exact opposite.  I find your error paths nearly unreadable.<br>
<p>
A goto label would provide a clear indication of where error handling takes place, instead, in your code I have to look at all the surrounding context to figure out what on earth "break" means in that particular context (is it exiting a real loop normally or is it a do-nothing loop to avoid a goto?).  You mix error handling and normal loop control flow in a very confusing manner.<br>
<p>
Contrast this with far more complex kernel code I've read that is much more understandable at first glance, largely due to readable error handling.<br>
<p>
A number of people have already replied with similar thoughts but I'll reiterate, instead of lashing out, perhaps take a look at the feedback and reconsider your code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628121/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628176"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Contrast this with far more complex kernel code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 20:36 UTC (Tue)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628176/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I’d be curious to know if anybody can point to an example in the kernel which has to deal with error recovery from inside a loop, similar to my code.<br>
<p>
That is the one case where the goto-ists have so far fallen flat on their faces when trying to “improve” my code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628176/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628186"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Contrast this with far more complex kernel code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 22:27 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628186/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I’d be curious to know if anybody can point to an example in the kernel which has to deal with error recovery from inside a loop, similar to my code.</font><br>
<p>
Sure. A very simple one, which should be easy to follow: the deeply nested unuse_mm() loop, which can be found at mm/swapfile.c. This is one I'm familiar with, other kernel developers most certainly know of better examples.<br>
<p>
The first thing to notice is that, for better readability, it's split into several functions, one for each nesting level of the loop. The outermost loop, within unuse_mm, loops over the vmas and calls unuse_vma for each one. The next level, within unuse_vma, calls unuse_pud_range for each pgd; unuse_pud_range calls unuse_pmd_range for each pud; unuse_pmd_range calls unuse_pte_range for each pmd; and unuse_pte_range calls unuse_pte for each pte. Finally, unuse_pte does the real work, and it's where an error can happen.<br>
<p>
Yes, we have a 5-level nested loop here, 4 of them looping over the 4-level abstract page table, with errors propagating outward from the innermost loop. Since each loop is in its own function, it doesn't use even need a "goto"; it can use a straight "return". But the innermost function (unuse_pte) does have an example of the traditional "cleanup" use of goto.<br>
<p>
Now how about an example from XFS, since we're supposed to be talking about XFS? I randomly looked at its source code, and found xlog_alloc_log. That function has to deal with error recovery from before the loop, from after the loop, and from within the loop, and the error recovery must be run only on failure. It's an allocation function; if there's no failure, it must keep everything it allocated, and if there's any failure, it must release everything it has allocated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628186/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Finally, unuse_pte does the real work, and it's where an error can happen.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 21:56 UTC (Wed)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628244/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <P>Speaking of which, I notice there is no error checking on <A HREF="http://lxr.free-electrons.com/source/mm/swapfile.c#L1111">this call</A> to <TT>pte_offset_map_lock</TT>. Can that never fail?

<P>And what happens if <TT>unuse_pte</TT> returns an error, anyway? Do the outer routines abort, and leave their work half-done? Is this supposed to be cleanup code, or not?
      
          <div class="CommentReplyButton">
            <form action="/Articles/628244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628246"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: Finally, unuse_pte does the real work, and it's where an error can happen.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 22:56 UTC (Wed)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628246/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Speaking of which, I notice there is no error checking on this call to pte_offset_map_lock. Can that never fail?</font><br>
<p>
Looking at how it's implemented, that call does two things: it temporarily maps the page table, in a way which won't fail (in some architectures, it's a simple arithmetic operation, and in others, it uses a mechanism which has a number of slots reserved for temporary mappings), and it locks a spinlock. If the spinlock is unlocked, it can't fail; if the spinlock is locked, it will wait until its current owner unlocks it, so again it can't fail.<br>
<p>
<font class="QuotedText">&gt; And what happens if unuse_pte returns an error, anyway? Do the outer routines abort, and leave their work half-done?</font><br>
<p>
The answer here is yes!<br>
<p>
This code is ultimately called from within the swapoff system call (further down in the same file). There's in fact another outermost loop, try_to_unuse, which loops over the swapfile's pages and tries to unuse (yeah...) each one in turn. Here is where it's called:<br>
<p>
1872         set_current_oom_origin();<br>
1873         err = try_to_unuse(p-&gt;type, false, 0); /* force unuse all pages */<br>
1874         clear_current_oom_origin();<br>
1875 <br>
1876         if (err) {<br>
1877                 /* re-insert swap space back into swap_list */<br>
1878                 reinsert_swap_info(p);<br>
1879                 goto out_dput;<br>
1880         }<br>
<p>
Just before this fragment of code, the swapfile (or swap partition) is marked as disabled on the list of swapfiles. The try_to_unuse function then tries to move all the pages which currently reside into that swapfile back into the main memory, and make all page tables which pointed to these pages on the swap point to them in main memory, so the swapfile can be safely removed.<br>
<p>
If try_to_unuse fails (usually because there's not enough memory to hold what's currently on the swapfile to be removed), this code enables the swapfile again (this part of the code used to be almost a duplicate of the corresponding part of the swapon code; I refactored it into a separate function used by both). It doesn't try to swap out again the pages it swapped in; if there's a need to free some of the main memory, the normal memory management code will swap them out again.<br>
<p>
If try_to_unuse succeeds, on the other hand, the swapfile is now empty; the code after the fragment of code I pasted above releases all the resources which were allocated by the swapon system call for this swapfile, and returns success to the userspace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628246/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628276"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 21:44 UTC (Thu)
                               by <b>ldo</b> (guest, #40946)
                              [<a href="/Articles/628276/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <P>In that case, this code is not very interesting. The interesting case would be the construction of a complex data structure, piece by piece, where each individual piece construction could fail. If any failures occur, then <I>all</I> the partially-constructed pieces so far need to be freed before returning an error indication to the caller. Only if all the construction steps succeed can the complete object be returned to the caller.

<P>In my opinion, this would be just about the ultimate stress test of your error-recovery technique.

<P>Search through my example for the comment “so I don't dispose of it yet” to see how I deal with this. You should find three instances.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628276/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 22:51 UTC (Thu)
                               by <b>reubenhwk</b> (guest, #75803)
                              [<a href="/Articles/628283/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems like the vars around /* so I don't dispose of it yet */ are used as local variable where you're building/using something, and at a point (where the assignment of result is) is where you're ready to call this data structure complete and ready to return.  I do something similar.  When I can I try to ensure that a function either completely fails or completely succeeds with no in-between.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 23:12 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/628285/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There have been multiple worked examples of exactly this shown to you already.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628289"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2015 1:56 UTC (Fri)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628289/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In that case, this code is not very interesting. The interesting case would be the construction of a complex data structure, piece by piece, where each individual piece construction could fail.</font><br>
<p>
Well, swapoff is the destruction of a complex data structure, not its construction. Its construction is the swapon system call, further down in the same file.<br>
<p>
The same design pattern can be found all over the Linux kernel: there's a construction function, which constructs whatever complex data structure the module needs, and a destruction function, which releases it.<br>
<p>
<font class="QuotedText">&gt; If any failures occur, then all the partially-constructed pieces so far need to be freed before returning an error indication to the caller. Only if all the construction steps succeed can the complete object be returned to the caller.</font><br>
<p>
In the swapon system call, there's a single error handling label "bad_swap" which frees all the partially-constructed data structures, undoes block device configuration, closes the opened file, and so on. It falls through to the "out" label, used for both the success and failure cases, which releases any temporarily used resources.<br>
<p>
<font class="QuotedText">&gt; Search through my example for the comment “so I don't dispose of it yet” to see how I deal with this. You should find three instances.</font><br>
<p>
I see. You have two variables for the return value of the function: one which has its reference counter decremented at the end, and one which is actually returned from the function. You keep the allocated structure at the first one, and when everything's ready, you swap it with the second one. So in the failure case, the reference counter is decremented and it returns NULL; in the success case, the reference counter is not decremented and it returns the pointer to the structure.<br>
<p>
It's an elegant way of doing it (though I'm annoyed at your inconsistency: twice you called it "result" and once you called it "Result"). It's also orthogonal to the use of goto versus pseudo-loop for cleanup: this trick can help simplify the code in both cases.<br>
<p>
What you did is actually a design pattern in modern C++:<br>
<p>
std::unique_ptr&lt;foo&gt; fn(/*args*/)<br>
{<br>
  auto ret = std::make_unique&lt;foo&gt;(/*args*/);<br>
  /* ...code which can throw an exception... */<br>
  return ret;<br>
}<br>
<p>
Here, "ret" is a std::unique_ptr&lt;foo&gt;, which contains a pointer to a "foo". When this variable gets out of scope, which will happen if an exception is thrown, whatever is pointed to by "ret" will be deleted. When it reaches the "return ret", however, the pointer is moved (as in std::move) to the return value of the function, so when it leaves the scope, "ret" is pointing to NULL, and the returned object isn't deleted.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628289/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor723510"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2017 13:21 UTC (Tue)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/723510/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What, you don’t initialise them to NUL and just free them afterwards?<br>
<p>
struct foo *foo = calloc(1, sizeof(foo));<br>
<p>
if (!(foo-&gt;a = geta()))<br>
        goto out;<br>
if (!(foo-&gt;b = getb()))<br>
        goto out;<br>
if (!(foo-&gt;c = getc()))<br>
        goto out;<br>
if (!(foo-&gt;d = getd()))<br>
        goto out;<br>
return (foo);<br>
<p>
out:<br>
free(foo-&gt;d);<br>
free(foo-&gt;c);<br>
free(foo-&gt;b);<br>
free(foo-&gt;a);<br>
return (NULL); /* error */<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723510/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723511"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2017 14:08 UTC (Tue)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/723511/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>
This sort of thing may work most of the time, but just for the record, while calloc() fills the whole structure in question with all-bits-zero bytes, there is no guarantee in the C standard that an individual structure entry like <tt>foo-&gt;a</tt> will in fact turn out to be a valid null pointer afterwards. (The C language does not require the null pointer to be “all bits zero”, even though expressions like “<tt>!(foo-&gt;a = geta())</tt>” must still return 1, as in “true”, if the <tt>geta()</tt> call yields a null pointer.)
</p>
<p>
If you're unlucky this means that if, say, you error out when trying to allocate <tt>foo-&gt;b</tt>, the “<tt>free(foo-&gt;d);</tt>” at the beginning of the <tt>out:</tt> path might try to free something at the all-bits-zero-address-that-isn't-a-null-pointer that hasn't previously be allocated, which isn't allowed. This shortcut looks enticingly convenient and probably works on most platforms today but people who are interested in safe, portable, and standard-conforming C code shouldn't be using it.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/723511/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723852"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2017 9:55 UTC (Fri)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/723852/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, but that can be implementation-defined, and POSIX does do this (in the next version):<br>
<p>
<a href="http://austingroupbugs.net/view.php?id=940#c2696">http://austingroupbugs.net/view.php?id=940#c2696</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723852/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723958"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re:The answer here is yes!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2017 23:06 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723958/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Note the freedom which still exists: there can be *other* bit patterns that also represent the null pointer. :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723958/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor628126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 19:14 UTC (Mon)
                               by <b>rleigh</b> (guest, #14622)
                              [<a href="/Articles/628126/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Nowadays I'd do this:
<br><br>
<tt>
std::unique_ptr&lt;a&gt; ptra(std::make_unique&lt;a&gt;(args)); // a instance allocated
<br>
std::unique_ptr&lt;b&gt; ptrb(std::make_unique&lt;b&gt;(args)); // b instance allocated
<br>
<br>
// stuff that might fail.
<br>
ptrb-&gt;foo(ptra-&gt;bar());
<br>
<br>
// Cleanup of ptra a instance and ptrb b instance is automatic
</tt>
<br><br>
I know this isn't going to be acceptable in the kernel, but in userspace this gives you guaranteed correct behaviour on error, and will clean up correctly on allocation failure of either instance, returns at any point and also exceptions at any point.  No need for complex conditionals.  No need for gotos.  It's all automatically handled.
<br><br>
Unless you really want to suffer with C, you can just have it all handled if you use the facilities C++ offers you.  The worry that you've missed some special case is taken care of by RAII, and it does lead to simpler, more readable, more maintainable and more robust code.
      
          <div class="CommentReplyButton">
            <form action="/Articles/628126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 19:23 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628128/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Unless you really want to suffer with C, you can just have it all handled if you use the facilities C++ offers you.</font><br>
<p>
If you are willing to use GNU extensions, you can have it on C too via __attribute__((__cleanup__(...))). One well-known project which uses it is systemd.<br>
<p>
But I agree that it's not going to be acceptable in the kernel, since it introduces implicit calls to the cleanup functions, and kernel developers prefer to be explicit.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628137"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 29, 2014 23:11 UTC (Mon)
                               by <b>rleigh</b> (guest, #14622)
                              [<a href="/Articles/628137/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is certainly a partial solution for C.  It's akin to a shared_ptr custom deleter.  It's not really a great alternative to C++ destructors, because the cleanup still needs specifying by hand for each type instance and it's not really encapsulated as well since the cleanup function is either local to the translation unit or effectively public without additional measures, but it's probably the best you're going to get out of C.  If you're going this far into the nonportable and nonstandard with C, I'd argue you'd be better off using standard and portable C++.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628137/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628194"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2014 23:28 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/628194/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn't it be more like a unique_ptr custom deleter instead of a shared_ptr custom deleter?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628194/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628203"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 11:17 UTC (Wed)
                               by <b>rleigh</b> (guest, #14622)
                              [<a href="/Articles/628203/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, either works for the example above (I originally wrote it to use shared_ptr but updated the example to use unique_ptr).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628203/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor629148"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 12, 2015 0:54 UTC (Mon)
                               by <b>Kamilion</b> (subscriber, #42576)
                              [<a href="/Articles/629148/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I want to thank everyone participating in this thread for providing their opinions, I'm an embedded HW guy but I've been starting out in python recently and just learned a *WHOLE* lot from this discussion thread.<br>
<p>
I've been wondering how to interact between high level languages like python and low level languages like C, C++, and Rust for a good long time.<br>
<p>
This has been a great window into some traps and pitfalls and how-times-have-changed situations.<br>
<p>
Does anyone know of any coding contests where a body of decent coders critique intentionally terribly written code (as opposed to, say, Obfuscated C) in a manner such as this thread? I'm vaguely aware of code-golf from seeing sidebar-links on the stackoverflow network, which I guess could be close, but can anyone offer anything else similar?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/629148/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor629195"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Or You Could Simplify The Error-Recovery Paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 12, 2015 12:53 UTC (Mon)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/629195/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's the Underhanded C contest.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/629195/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor627772"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Find and fix by exhaustion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2014 1:38 UTC (Fri)
                               by <b>davecb</b> (subscriber, #1574)
                              [<a href="/Articles/627772/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For each caller of an allocator, record it's name and address<br>
For each of these, start a standard regression test.<br>
When the allocator is called<br>
- turn on coverage tracking<br>
- return error from the allocator<br>
- run for another 10 instructions or so<br>
- stop and mail the tcov results to the subsystem maintainer.<br>
continue the loop with the next call<br>
<p>
The maintainers then see if their error-handers work.<br>
<p>
We used to a variant on this in Solaris, specifically using interposers  to catch, report and continue after some #%#^!!! unwise person wrote<br>
if (*p != '\0') instead of if (p != NULL &amp; *p != '\0').<br>
<p>
The trick is generalizable, so you can run in can't-fail mode on individual calls until they're all converted to handling failures properly.<br>
It takes lots of calendar time, but not much time per individual maintainer, so it scales.<br>
<p>
--dave<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/627772/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628198"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 2:23 UTC (Wed)
                               by <b>gerdesj</b> (subscriber, #5446)
                              [<a href="/Articles/628198/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I rather enjoyed reading the comments here.  I have my own views, as a sysadmin, on the finer points of programming constructs ...<br>
<p>
Many here are experts in some way or another.  Some are regarded as de-facto experts by most of their peers.  I think we might all learn by listening even when the speaker is clearly wrong by our own measure.<br>
<p>
This article was about long held assumptions being shown to not be quite right and that seems somehow appropriate in the comments final analysis.  <br>
<p>
Cheers<br>
Jon<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628198/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628201"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2014 8:50 UTC (Wed)
                               by <b>cyronin</b> (guest, #99592)
                              [<a href="/Articles/628201/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I feel like this is a nice analysis of this page. while the goto versus do-break-while() discussion seemed frustratingly pointless and off topic, I gained a refreshing insight of the rationale behind coding style decisions that you don't often see in coding style documentation. <br>
<p>
I've often been told that the best way to learn something is to assert the wrong thing to experts, and they will give a clearer rationale on that topic than you will ever get from any other source. As a bonus, you might even cause a previously unnoticed rational inconsistency to become obvious, via the rubber duck effect.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628201/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628256"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 1:05 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/628256/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
I've often been told that the best way to learn something is to assert the wrong thing to experts, and they will give a clearer rationale on that topic than you will ever get from any other source.
</blockquote>
It's even better if you can manage to accidentally manage this trick when your interlocutor is the original inventor of whatever-it-is. Particularly if you didn't realise it. (This was much easier before the days of web search engines, but if you don't think to check it can happen these days too.)
<p>
It's a highly efficient way to become rapidly convinced that you are still below the Dunning-Kruger bound on whatever it is. :)
<p>
(I have, of course, been there. More than once...)
      
          <div class="CommentReplyButton">
            <form action="/Articles/628256/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628275"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2015 21:16 UTC (Thu)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/628275/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I've often been told that the best way to learn something is to assert the wrong thing to experts, and they will give a clearer rationale on that topic than you will ever get from any other source.</font><br>
<p>
This may be true but to do it on purpose only wastes the expert's time and make them stop wanting to talk to anyone.<br>
<p>
In my opinion this is why discussions on comp.lang.c eventually turned every thread into "Read the FAQ" and for a while StackOverflow every new question was turned into a duplicate, until it became too much work to even find the duplicate for each stupid question and now the site is mostly junk. In my opinion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628275/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor628298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2015 3:12 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/628298/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; and now the site is mostly junk</font><br>
<p>
Who reads the entire site and cares?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor628464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial static analysis of error paths</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2015 10:06 UTC (Mon)
                               by <b>mtorni</b> (guest, #3618)
                              [<a href="/Articles/628464/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn't static analysis of error-handling code help with checking some of those error paths?<br>
<p>
I was thinking of checking all the execution paths (disregarding loops)<br>
and producing a report of all possible cases of remaining allocations and not-rolled-back actions. For a simple function the report would be the "happy case" (several allocations in effect, perhaps a lock) and "failure" (no allocations and locks in effect after exit). If the function had error-handling bugs, there would be also be partial exit cases (some allocations in force, perhaps a lock).<br>
<p>
Might be some work to implement, but the reports could be great for verification of code before commits.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/628464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor628791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2015 13:41 UTC (Thu)
                               by <b>pebolle</b> (guest, #35204)
                              [<a href="/Articles/628791/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
"Nobody really knows when the rule that these allocations could not fail went into the kernel; it predates the Git era."
</p>
<p>
This triggered me to try to uncover that history. I think I managed to do that. These are the highlights. I won't actually analyze these highligths: just finding them already cost me quite a bit of time!
</p>
<p>
It appears to start at v2.4.10 which included a "major rewrite of the VM code" by Andrea Arcangeli. That apparently <a rel="nofollow" href="http://lwn.net/2001/0927/kernel.php3">"came as a bit of a surprise"</a> to most kernel developers . As far as I understand quite a few threads on lkml discuss the exiting bugs people hit in that code.
</p>
<p>
One of the tweaks to that code was added in v2.4.11-pre6. It added
<pre>
       /* Don't let big-order allocations loop */
       if (order)
               return NULL;
</pre>
to mm/page_alloc.c:__alloc_pages(). This appears to be added by Linus himself. I have not (yet) found any public discussion of this change.
</p>
<p>
In v2.4.13-pre5 these lines were changed to
<pre>
       /* Don't let big-order allocations loop */
       if (order &gt; 1)
               return NULL;
</pre>
</p>
<p>
(I haven't tried to link this change to a patch or a public discussion.)
</p>
<p>
Then between v2.4.14-pre8 and v2.4.14 these were changed to
<pre>
       /* Don't let big-order allocations loop */
       if (order &gt; 3)
               return NULL;
</pre>
This seems to done again by Linus himself.
</p>
<p>
Fast forward to v2.5.46. It included a patch by Andrew Morton titled "disable PF_MEMALLOC for interrupt allocations". It "tidies things up a little in there" by changing the code to
<pre>
      /*
       * Don't let big-order allocations loop.  Yield for kswapd, try again.
       */
      if (order &lt;= 3) {
              yield();
              goto rebalance;
      }
</pre>
<p>
Andrew Morton again cleaned up the code quite a bit in v2.5.69 with the patch called "implement __GFP_REPEAT, __GFP_NOFAIL, __GFP_NORETRY". I won't quote the new code.
</p>
<p>
And, finally, in the git era "3" was changed in v2.6.23 to "PAGE_ALLOC_COSTLY_ORDER" by Andy Whitcroft's commit 5ad333eb66ff ("Lumpy Reclaim V4").
</p>
<p>
Anyone with access to a Linux git repository can easily follow the subsequent changes to that code. But hopefully this shows the history before the Git era (ie, before v2.6.12). Unless, of course, this isn't actually the code discussed in this article!
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/628791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor629958"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2015 15:53 UTC (Mon)
                               by <b>pal</b> (guest, #57253)
                              [<a href="/Articles/629958/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
there is a well-known rule: never call foreign code while holding a lock. which is violated by calling memory allocation in xfs. changing memory allocation behavior instead of following this simple rule is a whack-a-mole game itself<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/629958/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor630007"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2015 18:33 UTC (Mon)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/630007/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have never seen this rule (or at least not in that form). What I have seen is a guideline that hints that the code protected by a lock should be as small and straightforward as possible.<br>
<p>
Your rule actually makes a lot of sense. Locks exists to ensure concurrent access to a shared resource in a coherent way. If you're calling "foreign" code, then your code is not just accessing the shared resource, and thus it is protecting too much. Probably the "right" thing to do is to move all resource allocations (including memory) outside the lock scope, and only acquire the lock once all the needed resources are ready.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/630007/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor633051"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2015 13:30 UTC (Thu)
                               by <b>wenhua.yu</b> (guest, #100439)
                              [<a href="/Articles/633051/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
讨论这么热烈，<br>
我就看看<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/633051/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor633677"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2015 19:43 UTC (Tue)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/633677/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It really was.  I'm hoping there will be another article summarizing the comments.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/633677/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor637028"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 17, 2015 16:55 UTC (Tue)
                               by <b>meuh</b> (guest, #22042)
                              [<a href="/Articles/637028/">Link</a>] 
      </p>
      
      </div>
      </summary>
      According to some <a href="https://translate.google.fr/#auto/en/%E8%AE%A8%E8%AE%BA%E8%BF%99%E4%B9%88%E7%83%AD%E7%83%88%EF%BC%8C%0A%E6%88%91%E5%B0%B1%E7%9C%8B%E7%9C%8B">online translator</a>:

<cite>
"So lively discussion,
I'll take a look".
</cite>

      
          <div class="CommentReplyButton">
            <form action="/Articles/637028/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor896576"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;too small to fail&quot; memory-allocation rule</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2022 13:28 UTC (Mon)
                               by <b>huxiaoming</b> (guest, #158793)
                              [<a href="/Articles/896576/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
check <a rel="nofollow" href="https://lwn.net/Articles/668126/">https://lwn.net/Articles/668126/</a> for the following up<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/896576/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2014, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
