        <!DOCTYPE html>
        <html lang="en">
        <head><title>Pitchforks for RDSEED [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/961121/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/961332/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/961121/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Pitchforks for RDSEED</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 8, 2024</br>
           </div>
The generation of random (or, at least, unpredictable) numbers is key to
many security technologies.  For this reason, the provision of random data
as a CPU feature has drawn a lot of attention over the years.  A proper
hardware-based random-number generator can address the problems that make
randomness hard to obtain in some systems, but only if the manufacturer can
be trusted to not have compromised that generator in some way.  A recent
discussion has brought to light a different problem, though: what happens
if a hardware random-number generator can be simply driven into exhaustion?
<p>
As background, it is worth looking at two related instructions provided on
x86 systems:
<P>
<ul class="spacylist">
<li> <b><tt>RDSEED</tt></b> is a true random-number generator; it reads
     entropy collected from the environment and stores a random bit pattern
     into a CPU register.  It is provided primarily for the seeding of
     pseudo-random number generators or other applications where the
     highest-quality randomness is needed.
<li> <b><tt>RDRAND</tt></b> obtains a random pattern from a deterministic
     random-number generator built into the hardware and stores it into a
     register.  The generator used by <tt>RDRAND</tt> is periodically
     reseeded from the source used by <tt>RDSEED</tt>.
</ul>
<p>
<tt>RDRAND</tt> is recommended for most uses; it is faster and can
significantly stretch the amount of entropy that is available to the
system.  Within the kernel, <tt>RDSEED</tt> is used to seed the kernel's
random-number generator, but for little else.  An important point to note
is that neither of these instructions is privileged; they are equally
available to user-space code.  Also important is the fact that either
instruction can fail if there is not sufficient entropy available.  (See <a
href="https://www.intel.com/content/www/us/en/developer/articles/guide/intel-digital-random-number-generator-drng-software-implementation-guide.html">this
page</a> for lots of details on how these instructions work).
<p>
On the x86 architecture, the kernel has a pair of functions, <a
href="https://elixir.bootlin.com/linux/v6.7.4/source/arch/x86/include/asm/archrandom.h#L18"><tt>rdseed_long()</tt>
and <tt>rdrand_long()</tt></a>, that make use of the above instructions.
Kirill Shutemov recently observed that, while <tt>rdrand_long()</tt> will
retry ten times if <tt>RDRAND</tt> fails, <tt>rdseed_long()</tt> gives up
immediately.  He posted <a
href="/ml/linux-kernel/20240130083007.1876787-1-kirill.shutemov@linux.intel.com/">a
patch</a> adding a retry loop to <tt>rdseed_long()</tt>, and <a
href="/ml/linux-kernel/20240130083007.1876787-2-kirill.shutemov@linux.intel.com/">another</a>
to issue a warning if even ten tries were not enough to get a successful result.
That is where the discussion began.
<p>
<h4>Can they fail (and do we care)?</h4>
<p>
Initially, there was some uncertainty over whether those instructions can
fail at all.  <tt>RDSEED</tt> is able to produce entropy at a high rate,
and <tt>RDRAND</tt> multiplies that entropy considerably, so exhausting
them seems unlikely.  Jason Donenfeld, who maintains the kernel's
random-number generator, <a
href="/ml/linux-kernel/CAHmME9qsfOdOEHHw_MOBmt6YAtncbbqP9LPK2dRjuOp1CrHzRA@mail.gmail.com/">worried</a>
that, if the CPU's random-number generator could be driven to failure, that
denial-of-service problems could result.  Dave Hansen, though, thought that
such worries were misplaced; he <a
href="/ml/linux-kernel/88a72370-e300-4bbc-8077-acd1cc831fe7@intel.com/">spoke
authoritatively</a>:
<p>
<blockquote class="bq">
	Despite the SDM allowing it, we (software) need RDRAND/RDSEED
	failures to be exceedingly rare by design.  If they're not, we're
	going to get our trusty torches and pitchforks and go after the
	folks who built the broken hardware.
<p>
	Repeat after me:
<p>
<blockquote>
	Regular RDRAND/RDSEED failures only occur on broken hardware
</blockquote>
</blockquote>
<p>
It seems, though, that there may just be a use for those pitchforks.  Donenfeld <a
href="/ml/linux-kernel/Zbjw5hRHr_E6k18r@zx2c4.com/">wrote a little
program</a> to stress the hardware by repeatedly executing <tt>RDRAND</tt>
and <tt>RDSEED</tt> instructions; he observed that <tt>RDSEED</tt> failed
nearly 30% of the time — with a single-threaded test.  The hardware
random-number generator, though, is shared between all CPUs in a socket, so
a multi-threaded test can be expected to show worse results.  Indeed,
Daniel P. Berrangé <a
href="/ml/linux-kernel/Zbk6h0ogqeInLa_1@redhat.com/">reported</a> that,
with a multi-threaded test, <tt>RDSEED</tt> only succeeded 3% of the time.
Nobody was able to demonstrate <tt>RDRAND</tt> failures but, as Berrangé <a
href="/ml/linux-kernel/Zbt7mXg9p6IOdcqp@redhat.com/">pointed out</a> later
in the discussion, that situation could change with a larger number of
threads.  Elena Reshetova also <a
href="/ml/linux-kernel/DM8PR11MB575052B985CA97B29A443F9AE77C2@DM8PR11MB5750.namprd11.prod.outlook.com/">acknowledged</a>
that it may be possible to force <tt>RDRAND</tt> to fail.
<p>
The clear outcome is that, with a determined effort, <tt>RDSEED</tt> can be
made to fail and the reliability of <tt>RDRAND</tt> is not guaranteed.  The
logical next question is: how much of a concern is this?  For most use
cases, there is little to worry about.  The kernel's random-number
generator will continue to produce unpredictable output if the hardware
random-number generator fails occasionally, even in the absence of other
entropy sources.  As Ted Ts'o <a
href="/ml/linux-kernel/20240201044735.GC2356784@mit.edu/">pointed out</a>,
the kernel makes use of any other entropy sources it can find (such as the
variation in interrupt timings) and is intended to be robust even if
<tt>RDRAND</tt> were to turn out to be entirely compromised.  Since most
applications get their random data from the kernel, even an unreliable
<tt>RDRAND</tt> should not be a concern.
<p>
There is, however, one noteworthy exception: the use case known as <a
href="https://en.wikipedia.org/wiki/Confidential_computing">confidential
computing</a> (sometimes referred to as "CoCo"), which is intended to
guarantee the security and confidentiality of virtual machines even if they
are running on a compromised or hostile host computer.  Techniques like
secure enclaves and encrypted memory have been developed to protect virtual
machines from a prying host; these technologies may, someday, work as
intended, but they are absolutely dependent on the availability of
trustworthy random data.  If a "confidential" virtual machine can be
launched with a known random seed, the game may be over before it starts.
<p>
Availability of entropy at boot time has long been a problem for Linux
systems, so a number of mechanisms have been developed to seed the
random-number generator as quickly as possible.  These can include using
random data injected by the bootloader and collecting entropy from the
environment.  A confidential-computing system, though, cannot trust inputs
like that.  The bootloader is under the host's control, but so is
environmental entropy.  As Reshetova <a
href="/ml/linux-kernel/DM8PR11MB5750B861F7A105886AA5FCE4E77C2@DM8PR11MB5750.namprd11.prod.outlook.com/">explained</a>,
the host is able to control events like the expiration of timers and the
delivery of interrupts.  The only source of entropy that is not, at least
theoretically, under the host's control is the hardware random-number
generator.  If that, too, is compromised, the entire confidential-computing
dream falls apart.
<p>
<h4>What to do</h4>
<p>
That dream has been somewhat controversial in kernel circles from the
beginning, and this revelation has not helped; at one point Donenfeld <a
href="/ml/linux-kernel/CAHmME9qMO7=RDR60bKJvpDTRokcKed_i0+7BbFD53_7o2OJ6-g@mail.gmail.com/">asked</a>
directly: "<q>Is this CoCo VM stuff even real? Is protecting guests from
hosts actually possible in the end?</q>"  Most of the ensuing discussion,
though, was focused on what the appropriate response should be.
<p>
Outside of the confidential-computing use case, the consensus seems to be
that little needs to be done.  Adding a warning if <tt>RDSEED</tt> or
<tt>RDRAND</tt> fail (as Shutemov proposed at the beginning of the
discussion) is being considered, but even that is not clearly the right
thing to do.  Many systems run with <a
href="https://docs.kernel.org/admin-guide/sysctl/kernel.html#panic-on-warn"><tt>panic_on_warn</tt></a>
enabled; on such systems, a warning will cause a system crash.  That would
turn a random-number-generator failure into a denial-of-service problem.
Even in this case, though, a failure during early boot seems worth a
warning; if that happens, either the random-number-generator is simply
broken, or there is clearly some sort of attack underway.
<p>
When the system is running in a confidential-computing mode, though, the
situation is a bit more complicated.  Among other things, that is not a
mode that the kernel as a whole recognizes; Ts'o <a
href="/ml/linux-kernel/20240202153927.GA119530@mit.edu/">suggested</a>
adding a global flag for this purpose, since other parts of the kernel are
eventually likely to need it as well.  But, even with that in place, there
are a number of alternatives to consider; Donenfeld <a
href="/ml/linux-kernel/CAHmME9oqM2a766dBK22-yKr8=2-icg=UkQzmBOF8G5Zh_Y9E9w@mail.gmail.com/">spelled
them out in detail</a>.  They come down to whether the kernel should warn
(or panic) on failure, whether that should happen at any time or only
during early boot, and whether this response should change in
"confidential-computing mode".

<p>
The emerging consensus would seem to be that the first step is simply
retrying a failing operation, as is already done for <tt>RDRAND</tt>.  Even
if a single <tt>RDRAND</tt> can be made to fail, doing so ten times in a
row is a more difficult prospect.  That said, one should remember that, as
Reshetova <a
href="/ml/linux-kernel/DM8PR11MB5750FDC379F54F8591246DF0E7432@DM8PR11MB5750.namprd11.prod.outlook.com/">pointed
out</a>, the host controls a guest's scheduling and could, in theory,
interfere with a retry loop as well.  If retries are forced to happen when
the random-number generator is exhausted, they will never succeed.
<p>
At a minimum, a warning should be issued if these instructions fail during
early boot, since that is a clear sign that something is going wrong.  For
the confidential-computing case, a randomness failure means that the system
is unable to provide the guarantees upon which the whole edifice is built,
so the system should simply refuse to run.  That could be achieved with a
panic, or by simply looping on <tt>RDRAND</tt> indefinitely, locking up the
virtual machine if the instruction never succeeds.
<p>
Beyond that, there is not a whole lot that needs to be done.
<p>
There is one part of the discussion that is not visible, though: this
concern seems to have created a scramble within the CPU vendors to
characterize the extent of the problem and figure out what, if anything,
needs to be done about it.  Lest one think this is an Intel-specific issue,
Berrangé <a
href="/ml/linux-kernel/ZcHoKUElwXGPzrWb@redhat.com/">reported</a> the
ability to force high failure rates on some AMD processors as well.  The
outcome of those discussions may be some combination of documentation,
microcode updates, and design changes in future processors.
<p>
Meanwhile, the prospect of random-number-generator exhaustion need not be a
big worry for most users; it seems unlikely that it can be used to threaten
real-world systems.  For the confidential-computing crowd, it is just
another one of what is sure to be an unending list of potential threats
that need to be mitigated.  Fixes will be put into place, and we can all
put our pitchforks away and go back to watching the argument over whether
confidential computing is achievable in the first place.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Architectures-x86">Architectures/x86</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Confidential_computing">Confidential computing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Random_numbers">Random numbers</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Random_number_generation">Linux kernel/Random number generation</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/961121/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor961400"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2024 18:27 UTC (Thu)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/961400/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Many systems run with panic_on_warn enabled; on such systems, a warning will cause a system crash. That would turn a random-number-generator failure into a denial-of-service problem.</span><br>
<p>
Sorry but this is a bad statement. The if the system is running with panic_on_warn then the system has explicitly been told to panic (effectively go offline) on a warning event. Which means that it can't be a "denial-of-service" when it is behaving exactly the way the admins[0] requested. Additionally, panic_on_warn turns any ability to generate warnings into a DoS by that definition. <br>
<p>
Would you call an admin ssh-ing in running a "sudo reboot" a "denial of service". If so, that makes the term so broad as to be useless.<br>
<p>
Further more: If this is occurring after a retry loop of 10 (which, if I did my math right, has less than a 0.001% chance of happening if a 'normal' RDSEED has a failure rate of 30%), then most likely the best case is someone is simply probing you system (or your host) for weaknesses. In the worst case, there's an actual attack in progress. Immediately an panic might be the correct response.<br>
<p>
<p>
[0] Alternately a non-"admin" managed to control your kernel command line (or equivalent), but if that is the case, you have other, very different, and much worse problems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961400/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961401"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">panic_on_warn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2024 18:29 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/961401/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Yes, the system is behaving as configured in that setting.  Still, developers need to be (and are) aware that issuing warnings can have that effect in a fairly wide swath of deployed systems and consider warnings carefully.


      
          <div class="CommentReplyButton">
            <form action="/Articles/961401/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 0:08 UTC (Fri)
                               by <b>Jannes</b> (subscriber, #80396)
                              [<a href="/Articles/961464/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I understood this as an *unprivileged* process being able to bring down the entire machine. That's probably not the admin's intention.<br>
<p>
A misbehaving app should just crash itself, not bring down the entire kernel and thereby DOSsing all other apps.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor963514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2024 15:14 UTC (Sat)
                               by <b>DanilaBerezin</b> (guest, #168271)
                              [<a href="/Articles/963514/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But the process isn't bringing down the machine, a failing `RDSEED` -- which is kernel functionality -- is. I think a warning is warranted in this case especially when the only known cause for this is a deliberate attack on the randomness subsystem. If crash on warn is enabled and this warning causes the system to crash, that would be the admins fault.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/963514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961500"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 10:42 UTC (Fri)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/961500/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think you can calculate the probability of repeated failures in the retry loop like that. It is not as if they are independent events. If entropy is exhausted in one RDSEED instruction it will not be just as likely to be restored to a usable level if the next CPU instruction is another RDSEED as it would be for a random RDSEED occurring after many other instructions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961500/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 13:58 UTC (Fri)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/961528/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was actually just thinking about that.<br>
<p>
I think you MIGHT be able to maintain that probably format, if there's a change (possibly delays) you can make to make the next RDSEED mostly unrelated to the first. Also note that isn't not necessary to try accounting for things like another thread attempting to drain entropy (since that would be an attack, in which case a warning, or panic if panic_on_warn, is a perfectly sane response)<br>
<p>
IF that's possible[0], then you just need to pick a loop count that makes the likelyhood of successive failures unreasonably small. <br>
<p>
<p>
Although, honestly I think the sanest course of action would simply to  dedicated hardware (that requires privilege to access to use) in the non-cloud case. In my humble opinion the whole notion of confidential cloud compute is intractable, so I have no proposed solutions for it .<br>
<p>
<p>
<p>
<p>
[0] I think it should be, but have no proof. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 10, 2024 15:26 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/961684/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; If this is occurring after a retry loop of 10 (which, if I did my math right, has less than a 0.001% chance of happening if a 'normal' RDSEED has a failure rate of 30%)</span><br>
<p>
That sounds like you're assuming events are independent. I feel like there's some level of dependence when one is right after another (i.e., failures will cluster).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961408"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2024 19:24 UTC (Thu)
                               by <b>vstinner</b> (subscriber, #42675)
                              [<a href="/Articles/961408/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; he observed that RDSEED failed nearly 30% of the time</span><br>
<p>
"Result on my i7-11850H: RDRAND: 100.00%, RDSEED: 29.26%"<br>
<p>
So RDRAND has a success rate of 100% (and 0% failure), and RDSEED has a success rate of 29.26% which means around 70% of failure, no?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961408/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2024 19:24 UTC (Thu)
                               by <b>corsac</b> (subscriber, #49696)
                              [<a href="/Articles/961409/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems that on my older system (i5-5200U) rdseed never fails<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961496"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 10:12 UTC (Fri)
                               by <b>adobriyan</b> (subscriber, #30858)
                              [<a href="/Articles/961496/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
5950X (microcode 0xa20120e) doesn't seem to fail rdseed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961496/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961493"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 9:44 UTC (Fri)
                               by <b>james</b> (subscriber, #1325)
                              [<a href="/Articles/961493/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
...the host controls a guest's scheduling and could, in theory, interfere with a retry loop as well. If retries are forced to happen when the random-number generator is exhausted, they will never succeed. </blockquote>
Or the host could just never let the guest run? Same effect?



      
          <div class="CommentReplyButton">
            <form action="/Articles/961493/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961510"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 11:37 UTC (Fri)
                               by <b>spacefrogg</b> (subscriber, #119608)
                              [<a href="/Articles/961510/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have worked in the field of hardware true random number generation and I can tell you with confidence: However you build a system that contains a TRNG, you will always find a significant amount of instances in which the TRNG will fail at some point.<br>
<p>
Any expectation that the OS can just assume (or even assert) that it is an error that a TRNG fails at some point, is severely misguided.<br>
<p>
I can even deliver a mathematical argument if you desire. Any functionality test of a TRNG must restrict itself to use a limited amount of TRNG output to draw its conclusion. Otherwise it would never finish. Any TRNG must eventually produce a sequence, by chance(!), that contradicts the functionality test. Otherwise it would not be completely random, because it would specifically avoid the test patterns. Conclusion: Every TRNG that does not fail from time to time is already failing.<br>
<p>
Yes you can shift the probabilities etc. pp., but you cannot avoid the fundamental mechanics. By delivering billions of CPUs each running for thousands of hours, you will find those instances.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961510/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 12:18 UTC (Fri)
                               by <b>zx2c4</b> (subscriber, #82519)
                              [<a href="/Articles/961516/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The issue isn't that it fails but that one trust domain can potentially force failures in another. If it would "eventually succeed", one could try again and again until success. But if a different domain can induce perpetual failure, then we've now got two problems. So solutions include making RDRAND keep generating stream output without fail, or imposing some sort of cross-domain fairness with regards to failures. The threads on LKML discuss this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 12:42 UTC (Fri)
                               by <b>spacefrogg</b> (subscriber, #119608)
                              [<a href="/Articles/961519/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
True, I was not arguing against that. It came across in the article that Dave Hansen suggested to consider failing TRNGs to signify broken hardware, which is not a proper way to look at the issue.<br>
<p>
Cross-domain fairness seems to be hard to achieve when I think about it, especially because entropy is such a scarce resource. Access to the entropy source should be exclusive to the kernel(s). Applications should have to make due with derived PRNG values. But I am just thinking out loud...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961524"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 12:59 UTC (Fri)
                               by <b>spacefrogg</b> (subscriber, #119608)
                              [<a href="/Articles/961524/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thinking about it further, entropy is like CPU time. Once consumed by a process, you cannot get it back (opposed to memory), but you have to let time pass. So, an entropy-access scheduler seems to be one solution. Processes would need to announce to the kernel that they want to be part of the list of entropy users and get a scheduled and limited amount of RDSEED calls. Obviously, this needs close monitoring of the systems entropy state, which might be hard to do and may end up to be as good as limiting calls to x/sec.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961524/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 13:28 UTC (Fri)
                               by <b>zx2c4</b> (subscriber, #82519)
                              [<a href="/Articles/961525/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      These are unprivileged CPU instructions. This isn't a kernel scheduler issue.


      
          <div class="CommentReplyButton">
            <form action="/Articles/961525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961542"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 14:31 UTC (Fri)
                               by <b>spacefrogg</b> (subscriber, #119608)
                              [<a href="/Articles/961542/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then the CPUs are actually broken. You must guard your entropy state or its useless to you.<br>
<p>
Daniel J. Bernstein has an excellent write-up about how you could potentially mis-use an entropy source to force your encryption scheme to leak your private key alongside your ciphertext while making it look perfectly fine. I just fail to find it right now. (It was concentrating on why encryption schemes should not mindlessly access entropy)<br>
<p>
The argument is quite simple: You do know how the encryption scheme distributes bits. If you control the entropy bits and the encryption scheme, you can hide the private key in the entropy bits and make the ciphertext partially predictable, enough to recover the private key and thus the original message.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961542/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor961518"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 12:30 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/961518/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure – but you can make this number of instances less significant than, well, any arbitrary probability you desire. Simply retry often enough so that it only happens once per century, assuming that a billion CPUs do nothing but call RDSEED.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961518/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961522"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 12:47 UTC (Fri)
                               by <b>spacefrogg</b> (subscriber, #119608)
                              [<a href="/Articles/961522/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think you understand the relations. You cannot, be assured. (At least not by the way of waving your hands).<br>
<p>
If you really must and invest a lot of money, the best you can currently achieve is the quality level (very high), speed (kbit/s), chip size (10mm^2) and usage intervals (&lt;100 per day) of smartcards.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961522/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961523"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 12:52 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/961523/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And I think you need to study some statistics. There's a reason buses come in threes ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961523/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 13:43 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/961526/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I completely misunderstood the article in that case. By the instruction ‘failing’ I thought it meant generating some kind of fault or trap, and not giving any value back. If it appears to work, but the values are no longer random enough for practical use (they have become predictable) then that is a much harder kind of failure to detect and handle. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor961544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Instruction failure</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 14:31 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/961544/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The RD* instructions do not fail silently; the CPU sets the carry flag to indicate whether they succeed or not.


      
          <div class="CommentReplyButton">
            <form action="/Articles/961544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 14:01 UTC (Fri)
                               by <b>DemiMarie</b> (subscriber, #164188)
                              [<a href="/Articles/961527/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>The problem is that there is usually very little software can do to handle that failure.
</p><p>
Many random number generation APIs are infallible: they promise to always succeed.  <i>Always.</i> The simplest way for software to handle this is to busy-spin until success.  If the RNG is working, this succeeds with probability 1, and the likelihood of more retry loops being needed decreases exponentially with time.</p>
<p>I’d much rather have RDAND use a CSPRNG like Fortuna that never runs out of entropy once seeded, block the boot until the RNG <i>is</i> seeded, and reseed with entropy from the TRNG whenever possible.  Fortuna is designed to be secure even if the new entropy is malicious, so one can feed raw output from the TRNG without any further conditioning.  Entropy estimation is then only needed to determine when, and if, RDRAND needs to block.  There would be no error returns for software to check: if the TRNG is not working for long enough, you get a machine check exception.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/961527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961536"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 14:22 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/961536/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; I have worked in the field of hardware true random number generation and I can tell you with confidence: However you build a system that contains a TRNG, you will always find a significant amount of instances in which the TRNG will fail at some point.</font>

<p>Nope. Or, rather: technically yes, practically no.</p>

<p>You are forgetting one fundamental truth: there's non-zero probability (around 10⁻¹² or something like that) that <b>anything at all</b> would fail in a computer. Even simple <code>jz test_passed</code> may jump to a wrong place once-in-a-while.</p>

<font class="QuotedText">&gt; Conclusion: Every TRNG that does not fail from time to time is already failing.</font>

<p>Why should it fail significantly more often than once per 10¹² calls, though? <b>That</b> is the question and I don't see why that would be the case.</p>

<p>We ignore probabilities smaller than these (simply because we don't really, have much choice) and if we do that than making non-fallible (in a practical sense) TRNG should be possible.</p>


      
          <div class="CommentReplyButton">
            <form action="/Articles/961536/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor961604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2024 16:54 UTC (Fri)
                               by <b>zx2c4</b> (subscriber, #82519)
                              [<a href="/Articles/961604/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This didn't make it in time for publication, but here's the latest patch on the matter: <a href="https://lore.kernel.org/all/20240209164946.4164052-1-Jason@zx2c4.com/">https://lore.kernel.org/all/20240209164946.4164052-1-Jaso...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor961905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pitchforks for RDSEED</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 13, 2024 4:49 UTC (Tue)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/961905/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are (shockingly) architectures beyond x86. I know! It's surprising isn't it ;) But anyway, this isn't a unique problem. However, on at least one other architecture we do have some platform implementation guidance around rate of reseed and consideration for denial of service from bad actors sharing a socket.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/961905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
