        <!DOCTYPE html>
        <html lang="en">
        <head><title>The Next3 filesystem [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/387231/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/386540/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/387231/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The Next3 filesystem</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 11, 2010</br>
           </div>
The ext3 filesystem is tried and true, but it lacks a number of features
deemed interesting by contemporary users.  Snapshots - the ability to
quickly capture the state of the filesystem at an arbitrary time - is at
the top of many lists.  It is currently possible to use the LVM
snapshotting feature with ext3, but snapshots taken through LVM have some
significant limitations.  The <a
href="http://sourceforge.net/apps/mediawiki/next3/index.php?title=Main_Page">Next3
filesystem</a> offers an approach which might prove easier and more
flexible: snapshots implemented directly in ext3.
<p>

Next3 was developed by CTERA Networks, which has started shipping it on its <a
href="http://www.ctera.com/home/ctera-c200.html">C200 network-attached
storage device</a>.  This code has also been posted on SourceForge and
proposed for merging into the mainline kernel.  The Next3 filesystem adds a
simple snapshot feature to ext3 in ways which are (mostly) compatible with
the existing on-disk format.  It looks like a useful feature, but its path
into the mainline looks to be longer than its implementers might have
hoped.
<p>

The Next3 filesystem is a new filesystem type - it's not just an addition
to ext3.  At its core, it works by creating a special, magic file to
represent a snapshot of the filesystem.  The files have the same apparent
size as the storage volume as a whole, but they are sparse files, so they
take almost no space at the outset.  When a change is made to a block on
disk, the filesystem must first check to see whether that block has been
saved in the most recent snapshot already.  If not, the affected block is
moved over to the snapshot file, and a new block is allocated to replace
it.  Thus, over time, disk blocks migrate to the snapshot file as they are
rewritten with new contents.

<p>

Gaining read-only access to a snapshot is a simple matter of doing a
loopback mount of the snapshot file as an ext2 filesystem.  The snapshot
file is sufficiently magic that any attempts to read blocks in the holes
(which represent blocks that have not been changed since the snapshot was
taken) will be satisfied from a later snapshot - which will have captured
the contents of that block when it was eventually changed - or from
the underlying storage device.  Deleting a snapshot requires moving changed
blocks into the previous snapshot, if it exists, because the deleted
snapshot holds blocks which are logically part of the earlier snapshots.
<p>

The changes to the ext3 on-disk format are minimal, to the point that a Next3
filesystem can be mounted by the ordinary ext3 code.  If snapshots exist,
though, ext3 cannot be allowed to modify the filesystem, lest the changed
blocks fail to be saved in the snapshot.  So, when snapshots exist on the
filesystem, it will be marked with a feature flag which forces ext3 to
mount the filesystem readonly.
<p>

On the performance side, the news is said to be mostly good.  Writes will
take a little longer due to the need to move the old block to a snapshot
file.  The worst performance impact is seemingly on truncate operations;
these may have to save a large number of blocks and can get a lot slower.
It is also worth noting that the moving of modified blocks to the snapshot
file will, over time, wreck the nice, contiguous on-disk format that ext3
tries so hard to create, with an unfortunate effect on streaming read
performance.  Files which must not be fragmented can be marked with a
special flag which will cause blocks to be copied into the snapshot file
rather than moved; that will slow writes further, but will keep the file
contiguous on disk.
<p>

Next3 developer Amir Goldstein requested relatively quick review of the
patches because he is trying to finalize some of the on-disk formatting.
The <a href="/Articles/387240/">answer</a> he got from Ted Ts'o was
probably not quite what he was looking for:
<p>
<div class="BigQuote">
	Ext4 is where new development takes place in the ext2/3/4 series.
	So enhancements such as Next3 will probably not be received with
	great welcome into ext3.
</div>
<p>
Amir's response was that, while porting the patches to ext4 is on the
"we'll get around to it someday" list, that port is not an easy thing to
do.  The biggest problem, apparently, is making the movement of blocks into
the snapshot file work properly with ext4's extent-oriented format.  Beyond
that, Amir says, he's not actually trying to get the changes into ext3 - he
wants to merge a separate filesystem called Next3 which happens to be
mostly compatible with ext3.
<p>
The "separate Next3" approach is unlikely to fly very far, though.  As Ted
<a href="/Articles/387241/">put it</a>, ext2, ext3, and ext4 are really
just different implementations of the same basic filesystem format; this
format has never really been forked.  Next3, as a separate filesystem,
would be a fork of the format.  The fact that Next3 has taken over some
data structure fields which are used to different purpose in ext4 has not
helped matters:
<p>
<div class="BigQuote">
	The "ext" in ext2 stands for "extended", as in the "the second
	extended file system" for Linux.   It perhaps would be better if we
	had used the term "extensible", since that's the main thing about
	ext2/3/4 that has given it so much staying power.  We've been able
	to add, in very carefully backwards and forwards compatible way,
	new features to the file system format.  This is why I object to
	why Next3 uses some fields that overlaps with ext4.   It means that
	e2fsprogs, which supports _one_ and _only_ _one_ file system
	format, will now need to support two file system formats.  And
	that's not something I want to do. 
</div>
<p>
The answer appears fairly clear: patches adding the snapshot feature might
be welcome, but not as a fork of the ext3 filesystem.  At a bare minimum,
the filesystem format will have to be changed to avoid conflicts with ext4,
but the real solution appears to be simply implementing the patches on top
of ext4 instead of ext3.  That is a fair amount of extra work which might
have been avoided had the Next3 developers talked with the community prior
to starting to code.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ext3">Filesystems/ext3</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/387231/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor387514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 4:56 UTC (Thu)
                               by <b>spotter</b> (guest, #12199)
                              [<a href="/Articles/387514/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
wondering how this differs from Zachary Peterson's ext3cow<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 7:16 UTC (Thu)
                               by <b>amir73il</b> (subscriber, #66165)
                              [<a href="/Articles/387519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ext3cow has inspired Next3, but the final result is fundamentally different.<br>
On top of the differences list is compatibility, or in other words:<br>
Delete the Next3 snapshot files and you are back to plain old Ext3.<br>
<p>
See also:<br>
<a rel="nofollow" href="http://sourceforge.net/apps/mediawiki/next3/index.php?title=FAQ#Is_Next3_related_to_Ext3cow.3F">http://sourceforge.net/apps/mediawiki/next3/index.php?tit...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor387525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 9:03 UTC (Thu)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/387525/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
NTFS snapshots (volume shadow copies) are the one thing I really miss as a Linux server admin. LVM snapshots do *not* cut it for all purposes:<br>
<p>
- They require LVM, which has its own issues and isn't always desirable<br>
<p>
- They require storage to be reserved for them and allocated to them in advance<br>
<p>
- They don't gracefully age out and aren't quietly removed when they run out of backing store. In fact, I recently had a server fail to boot because of an LVM snapshot that'd filled up.<br>
<p>
- They need the file system to be capable of being mounted read-only from a dirty state. Not all file systems can handle this.<br>
<p>
<p>
I find LVM snapshots to be well suited to taking backups, where I need to snapshot a volume, read the snapshot contents, unmount the snapshot and destroy it.<br>
<p>
I find them rather less than ideal for when I just want to keep a few snapshots around to provide coarse versioning, as it's so useful for on a Windows server with VSS. An in-filesystem snapshot faclility would be really, really nice for this sort of thing, and one that didn't require loopback mounts (instead providing virtual directory access or the like) would be truly fantastic for backups.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSS = Visual SourceSafe?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 11:44 UTC (Thu)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/387550/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If that's the correct expansion, just say no. It should be a give away when you find you need "coarse versioning" for your version control system that what you have is a liability. Rather than thrash around trying to find ways to keep VSS sort-of working it should be a priority to migrate away from it.<br>
<p>
This isn't some partisan thing, I don't care if you migrate to git or Perforce or even Team Foundation Server. But get off Visual SourceSafe. Once you're safely running a real version control system you'll find that your headache goes away without any need for "coarse versioning" using snapshots.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSS = Volume Shadow copy Service (Yes, I know)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 13:27 UTC (Thu)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/387570/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Argh! That acronym collision drives me nuts.<br>
<p>
Here, VSS = "Volume Shadow copy Service". Yes, Microsoft uses the acronym "VSS" for Volume Shadow Copy Service despite having an existing claim on that TLA via Visual Source Safe ie VSS.<br>
<p>
You'd think they'd refer to it as VSCS, but no....<br>
<p>
<p>
What I'm talking about is a facility in Microsoft servers (and client operating systems, but it's less important there) that's based on the Volume Shadow Copy Service where they can make automatic snapshots of their file systems on a schedule, and retain them until the total size of all snapshots reaches an admin-configured limit, at which point the oldest snapshot is dropped to make room.<br>
<p>
The same underlying snapshot service is used to provide efficient image-based backup. In fact, on Win2k8 you can have the server maintain a bootable backup disk image of its self on a raw disk - I use an iSCSI volume on my Linux backup server. The server uses the volume shadow copy service to only update dirty parts of the image at each backup run. It's nice to have for a Windows-based server OS where unlike Linux/BSD you can't just rsync the whole file system contents to another box and expect to be able to boot it.<br>
<p>
<p>
<p>
(For what it's worth, I use svn heavily, though am drifting git-wards now that I've started actually using it and discovered how seriously nice it is these days. You won't catch me near Visual Source Safe unless it's with an axe. In an amusing confluence of these two topics, I now maintain all my servers /etc in git and git-push them to the backup server every night, 'cos it's more convenient than Bacula when reverting changes).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387574"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSS = Volume Shadow copy Service (Yes, I know)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 13:48 UTC (Thu)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/387574/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Here, VSS = "Volume Shadow copy Service". Yes, Microsoft uses the acronym "VSS" for Volume Shadow Copy Service despite having an existing claim on that TLA via Visual Source Safe ie VSS.</font><br>
<p>
<font class="QuotedText">&gt;You'd think they'd refer to it as VSCS, but no....</font><br>
<p>
That would be 'Volume Snapshot Service', supposedly. The acronym collision probably never occurred to anyone at Microsoft since (it is widely held, at least) nobody at Microsoft actually uses Visual Source Safe.<br>
<p>
It's one of those things that was bought, mangled, and re-released to fill a gap in their product line, targetted at those people who must use all-Microsoft, all-the-time even if MS themselves think the tool is worthless.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387574/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor387732"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 15:36 UTC (Fri)
                               by <b>mebrown</b> (subscriber, #7960)
                              [<a href="/Articles/387732/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
BTRFS has exactly what you describe (VSS) at the filesystem level, and is widely held to be the heir-apparent of the Linux Filesystem of the Future(TM) crown.<br>
<p>
In fact, in Fedora 13, there is a yum plugin that will snapshot the system before every yum transaction, meaning you can rollback to any previous system state if an upgrade goes awry.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387732/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor387544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 10:16 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387544/">Link</a>] (46 responses)
      </p>
      
      </div>
      </summary>
      I would really like to use snapshots, so I would like to see Next3 in
the mainline.

<p>As for ext4 being the future: It does not have a single feature
that I want.  Worse, it has the misfeature of worse crash consistency.
So I am happy that Next3 is based on ext3, not ext4, so I don't have
to choose between snapshots and crash consistency.

      
          <div class="CommentReplyButton">
            <form action="/Articles/387544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387549"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 11:16 UTC (Thu)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/387549/">Link</a>] (45 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
crash consistency = consistently crashing?  :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387549/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 13:42 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387575/">Link</a>] (44 responses)
      </p>
      
      </div>
      </summary>
      Data consistency after crashes or power outages.
      
          <div class="CommentReplyButton">
            <form action="/Articles/387575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 16:57 UTC (Thu)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/387607/">Link</a>] (33 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The zero-sized files after a crash? I thought those issues were resolved quite some time ago.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387623"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 18:38 UTC (Thu)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387623/">Link</a>] (32 responses)
      </p>
      
      </div>
      </summary>
      Ted T'so still believes that data consistency on OS crashes (not
application crashes) is the job of the applications (with fsync()
etc.), not of the file system.  And most applications don't do that, and those few that try it
are probably not well tested against that (because that's extremely
hard).

<p>He fixed one particularly frequent cause of data loss in ext4 (involving
writing a file, then renaming it across an old one), but nothing else.
So people will see data loss with ext4 less frequently than before,
but not as infrequently as with ext3 (or has this data loss feature
been backported from ext4 to ext3 to give us fewer reasons to stick
with ext3?).

      
          <div class="CommentReplyButton">
            <form action="/Articles/387623/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387636"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 20:08 UTC (Thu)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/387636/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are clearly overstating the case and the position. There were several issues fixed.  Not just one.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387636/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387713"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 12:54 UTC (Fri)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387713/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      Am I?  That's Ted T'so's position as reported on, e.g., LWN.  But
maybe you can show me where I was wrong in my statement of his
position.  And my impression is that if it was just up to him, he
would not have made the rename fix.

      
          <div class="CommentReplyButton">
            <form action="/Articles/387713/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387722"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 14:00 UTC (Fri)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/387722/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You said there was only one fix.  There were several and there are other Ext4 filesystem developers as well.  What your state as his position is leaving out a lot of naunced arguments in a complex topic and making it sound very simplistic.  If you can actually show a single case where Ext4 performs less robustly than Ext3, I would be interested.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387722/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor388716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 15:08 UTC (Fri)
                               by <b>Duncan</b> (guest, #6647)
                              [<a href="/Articles/388716/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What bothers me is how they reduced the guarantees and stability of the long mature ext3 filesystem in the aftermath of all this, by defaulting it to data=writeback, a change from the old default data=ordered.<br>
<p>
Presumably you used tun2fs or simply fstab to ensure your ext3 mounts remain stable with data=ordered after the kernel in question (was it 2.6.30 or 2.6.31?), right?<br>
<p>
What'd be interesting to see would be how the distributions have handled it, since.  Did they go with the new ext3 data=writeback default, or have they either reverted either that commit or now default their userspace to specify data=ordered by default?<br>
<p>
I know at least one guy who was complaining of ext3 instability after installing a new kernel due to that, that went away when he returned to data=ordered for his ext3 volumes.  The context of that discussion was the pan (nntp client) user list, IIRC.<br>
<p>
Me, I've been on reiserfs for years on both my main system and (more recently) my netbook, and have been extremely happy with it since data=ordered became its default (2.6.6 according to a google hit on another LWN comment of mine).  My most recent experience with extX is on no-journal ext4 formatted USB flash-based thumbdrives, where journaling isn't a good idea.  I've been following btrfs with interest, and expect I'll upgrade to it once a few more of the kinks get worked out.  (I've seen hints that the current 2.6.35 cycle will reduce the strength of the warning for its kernel config item, but I don't follow the btrfs list or lkml, and any detail of even plans has been harder to come by on the broader community sites such as LWN, HO, LXer, etc, that I follow.)<br>
<p>
Duncan<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2010 19:15 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/388807/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <blockquote> What bothers me is how they reduced the guarantees and
stability of the long mature ext3 filesystem in the aftermath of all
this, by defaulting it to data=writeback, a change from the old
default data=ordered.
</blockquote>

Yes, that's what was at the back of my mind when I wrote about
"backporting the data loss feature from ext4 to ext3".

<blockquote>
Presumably you used tun2fs or simply fstab to ensure your
ext3 mounts remain stable with data=ordered after the kernel in
question (was it 2.6.30 or 2.6.31?), right?
</blockquote>

The youngest kernel we have is 2.6.30, and according to /proc/mounts
it mounts our ext3 file systems with data=ordered.  I guess we will go
the fstab route once we get a kernel that defaults to data=writeback.

<p>I am a little worried, though, because of what happened after
data=journal was no longer the default; I then read that using
data=journal resulted in corrupt file systems; I read that for a
significant amount of time, and never read that this bug has been
fixed (but haven't seen such reports for some time).

<p>So if they made data=ordered non-default in 2.6.31 or some kernel,
will they really care if it works?  My confidence is limited.  We
should probably better stick with 2.6.30 until we migrate off extx file
systems completely.

      
          <div class="CommentReplyButton">
            <form action="/Articles/388807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2010 20:36 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/388812/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sticking with 2.6.30 is foolish. Bugs are fixed in ext[34] all the time, sometimes data loss bugs: by sticking with 2.6.30, you're depriving yourself of all of those.<br>
<p>
(btw, you can put mount options in the superblock, and avoid modifying /etc/fstab.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388833"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 11:44 UTC (Sun)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/388833/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      And new bugs are introduced, and if they are for a non-default option
like (now) data=ordered, they won't get noticed in time, and they
won't get fixed for quite some time; at least that's what the
non-default data=journal episode teaches.  So what's higher: the risk
of data loss from a well-known kernel, or from a new kernel in a
non-default setting?  Choosing the latter seems foolish to me.

<p>Modifying fstab is not a big deal, why would I want to avoid it.
The problem with doing it in the superblock is that I have to do it
again when I transfer the system to another disk.

      
          <div class="CommentReplyButton">
            <form action="/Articles/388833/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 11:50 UTC (Sun)
                               by <b>cortana</b> (subscriber, #24596)
                              [<a href="/Articles/388837/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How can I check whether my distribution has changed the default value of the option in its kernels?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 13:29 UTC (Sun)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/388840/">Link</a>] 
      </p>
      
      </div>
      </summary>
      One way is to mount such a file system with the default value (without
overriding the default with tune2fs or in fstab), and the checking the
actual options in /proc/mounts.  That is what I do.

<p>Another way would be to check CONFIG_EXT3_DEFAULTS_TO_ORDERED in
the kernel config file.

      
          <div class="CommentReplyButton">
            <form action="/Articles/388840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor388842"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 13:55 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/388842/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, OK, you're quite within your rights to stick with an old kernel: but I hope you encounter no other security bugs, or stability bugs, or new hardware, or *anything* else that might require a new kernel!<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388842/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor387635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 20:19 UTC (Thu)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/387635/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is no file system in Linux that tries to assure that renames are atomic functions. <br>
<p>
Ext3, Ext4, XFS, JFS, etc etc.. all of these have the same consistency problems your complaining about. <br>
<p>
The difference is that due to a fluke to Ext3's design the window that the 'zero length files' would be created on improper shutdown is much shorter then the same window for Ext4 (or XFS or whatever)<br>
<p>
What is more with 2.6.30 a patch was added to Ext4 that attempted to detect and then replicate the same behavior in Ext3 in order to maintain backwards compatibility with application developer's assumptions on file system behavior with regards to renames. <br>
<p>
So ya.. apparently that 'fsync' was always needed by application developers if they wanted to ensure that data was written to disk in a timely fashion.<br>
<p>
---------------------------<br>
<p>
I know that this issue has cropped up again due to the fact that in Ubuntu the dpkg program detects if it's running on Ext4 and goes into paranoid mode were it runs 'fsync' were as with Ext3 it does not. This causes Ubuntu installs to last significantly longer if you choose 'Ext4' file system. <br>
<p>
If the dpkg folks were smart they'd enable paranoid mode on all file systems, except maybe Ext3 (due to Ext3's poor ability to handle that sort of workloads)<br>
<p>
As far as my personal opinion this is a advantage for using Ext4 over Ext3 since upgrades will be much safer on my laptop...<br>
<p>
---------------------------<br>
<p>
<p>
The one feature that I like about Ext4 is that it takes a minute or two to run a full fsck on my home directory versus upwards to 15-20 minutes for the same operation on Ext3.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387638"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 20:45 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/387638/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>The difference is that due to a fluke to Ext3's design the window that the 'zero length files' would be created on improper shutdown is much shorter then the same window for Ext4 (or XFS or whatever)</blockquote>That window must be vanishingly small because neither I nor anyone else has <b>ever</b> been able to make ext3 crease zero-length files in the way you describe. Quirk or not, rename atomicity is an important feature that works just fine on a running filesystem, and filesystems ought to preserve its qualities on a restart.

Allowing random garbage to exist on the filesystem after a restart is terrible policy and reflects a profound ignorance on the part of filesystem developrse as to how applications and users expect their systems to work.

      
          <div class="CommentReplyButton">
            <form action="/Articles/387638/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387657"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 23:07 UTC (Thu)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/387657/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And ext4 now has rename atomicity over crashes. I also think that this is the right decision, but I wince when I see people tear into filesystem developers over this; if anything, it seems to reflect a profound ignorance of the difficulty of the trade-offs fs developers have to make, the disparity between what people want from a fs and what fs's have historically provided, etc. Keep in mind that if you go two web-pages over, you can find people tearing into POSIX for providing *too* strong guarantees and how we absolutely need to relax them for real-world usage (atime is the obvious example, but there are others). So I can hardly blame fs developers for being *cautious* about introducing strong *new* guarantees.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387657/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 13:43 UTC (Fri)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387716/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
[...] trade-offs fs developers have to make, the disparity between what
people want from a fs and what fs's have historically provided, etc.
</blockquote>

Yes, different people expect different things from file systems.

<p>E.g., I expect data consistency from a file system; Linux file
systems don't give any guarantee on that, but at least ext3 does ok in
most cases; some people may consider this a fluke (but is Stephen
Tweedie, the creator of ext3 among them?), but that's the reality.

<p>Other people expect maximum speed.  And for these people Linux
provides tmpfs and ext4.

<p>Given this choice, ext4 is certainly not a replacemet of ext3 for
me.

<blockquote> Keep in mind that if you go two web-pages over, you can
find people tearing into POSIX for providing *too* strong guarantees
and how we absolutely need to relax them for real-world usage (atime
is the obvious example, but there are others).
</blockquote>

Yes, there are different kinds of users.  I lost quite a bit of time
because Linux does not follow POSIX atime semantics by default
anymore.  I find them useful in my real-world usage.  Those who don't
want atime have been able to use noatime for a long time, and now
there is relatime, but making it the default (especially with mounts
that don't know about strictatime) is a bad practice.

      
          <div class="CommentReplyButton">
            <form action="/Articles/387716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 15:53 UTC (Fri)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/387735/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What on earth do you use atime for?  Personally, the last time I ever needed to worry about atime was in the 1990s, and it was very easy to replace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2010 8:36 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387806/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      I use atime to check whether some complex software really does access
the files that I think it does.

      
          <div class="CommentReplyButton">
            <form action="/Articles/387806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2010 19:23 UTC (Thu)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/388603/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I use atime to check whether some complex software really does access the files that I think it does.</font><br>
<p>
Wouldn't "strace -f" be handier for that kind of thing?  With that you notice also a lot of other stuff that the SW does.<br>
<p>
Strace-account script gives an overview of file accesses in the strace output:<br>
  <a rel="nofollow" href="http://blogs.gnome.org/mortenw/2005/12/14/strace-account/">http://blogs.gnome.org/mortenw/2005/12/14/strace-account/</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388686"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 12:04 UTC (Fri)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/388686/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      It would not be handier exactly because it tells me a huge amount of other stuff the software does and that I am not interested in.
      
          <div class="CommentReplyButton">
            <form action="/Articles/388686/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391352"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2010 22:17 UTC (Tue)
                               by <b>elanthis</b> (guest, #6227)
                              [<a href="/Articles/391352/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Meet grep.  Grep is your friend.  Grep can make your life much easier.  Grep is here to help you.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/391352/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391382"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2010 9:06 UTC (Wed)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/391382/">Link</a>] 
      </p>
      
      </div>
      </summary>
      And how is that handier than just doing "stat &lt;file&gt;"?
      
          <div class="CommentReplyButton">
            <form action="/Articles/391382/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor387749"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 17:33 UTC (Fri)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/387749/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not aware of any common filesystem that provides "data consistency" in any coherent sense, unless you do weird things like mount -o sync. Speed is too important -- Stephen Tweedie didn't make data=journal the default, either. At most you get guarantees in particular situations -- e.g., both ext3 and ext4 guarantee that a rename will not be committed to disk until writes to the file being renamed have been committed to disk. They even both try to guarantee that programmers who do horrible things like truncating the file and *then* rewriting it are somewhat protected from their incompetence.<br>
<p>
But maybe there are other cases where ext3 does better than ext4. You must have some excellent ones in mind to lump ext4 in with tmpfs... can you give any examples?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387749/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387811"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2010 9:19 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387811/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
Speed is too important
</blockquote>

For whom?  For me data consistency is much more important.  Before
barriers were supported, we ran ext3 on IDE disks without write
caching, and that's really slow.  The file system was still fast
enough.

<blockquote>
Stephen Tweedie didn't make data=journal the default, either.
</blockquote>

Actually he did, at least at the start.  Later it got changed (by
whom?) to data=ordered; that still has the potential to provide data
consistency unless existing files are overwritten.

<p>As for an example: Consider a process writing file A and then file
B.  With ext4 I expect that it can happen that after recovery B is
present and A is not or is empty.  With ext3 I expect that this does
not happen.  But given that I did not find any documented guarantees
in Documentation/filesystems/ext3.fs, maybe we should lump ext3 with
tmpfs, too.

<p>Still, my search brought up a Linux file system that gives
guarantees: In nilfs2.txt it says:

<pre>
order=strict	Apply strict in-order semantics that preserves sequence
		of all file operations including overwriting of data
		blocks.  That means, it is guaranteed that no
		overtaking of events occurs in the recovered file
		system after a crash.
</pre>

Yes, that's exactly the guarantee I want to see.  This means that any
application that keeps its files consistent as visible from other
processes will also have consistent files after an OS crash.
      
          <div class="CommentReplyButton">
            <form action="/Articles/387811/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387851"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2010 3:57 UTC (Sun)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/387851/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; For whom? For me data consistency is much more important</font><br>
<p>
That's fine. I'd like data consistency too. But I still don't mount my disks with -o sync, nor does pretty much anyone else, even most of the people who say they want data consistency. That's the reality that fs developers live in.<br>
<p>
Maybe on SSD (where nilfs2 is designed to live), we'll be able to get guaranteed data consistency as a matter of course. That'll be nice if it happens.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387851/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor387641"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2010 21:23 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/387641/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <i>The difference is that due to a fluke to Ext3's design the window that the 'zero length files' would be created on improper shutdown is much shorter then the same window for Ext4 (or XFS or whatever)</i><p>
My understanding is that ext3 would always have allocated the blocks for the new file and written it before the rename would occur. The 0-length file issue was due to ext4 performing delayed allocation and performing the rename before the data ever got written.
<p>
<i>So ya.. apparently that 'fsync' was always needed by application developers if they wanted to ensure that data was written to disk in a timely fashion.</i><p>
This is a misunderstanding. The desired behaviour was that operations occur in order. It's not terribly important to a user if they lose the configuration changes they made before a crash - it's pretty significant if the rename was performed before the data hit disk, resulting in the complete loss of their configuration.
<p>
It's true that POSIX doesn't require that filesystems behave this way. There's many things that POSIX doesn't require but which we expect anyway because the alternative is misery.
      
          <div class="CommentReplyButton">
            <form action="/Articles/387641/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387711"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 12:32 UTC (Fri)
                               by <b>ricwheeler</b> (subscriber, #4980)
                              [<a href="/Articles/387711/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You need to be careful not to confuse the rename issue specifically with the need to use fsync() properly to make sure that data is on disk.<br>
<p>
Applications still have to understand when to use fsync() properly to move data from the page cache out to persistent storage (on disk, ssd, etc). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387711/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor387715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 13:21 UTC (Fri)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387715/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <blockquote> There is no file system in Linux that tries to assure
that renames are atomic functions.
</blockquote>

That may be true (wrt. what happens on crashes; I do hope that they
are all atomic wrt state visible to other processes in regular
operations); I certainly have never seen any Linux file system give
any guarantees about data consistency on crashes.  Not doing renames
properly would be pretty poor of Linux, though, given that this is a
case where even the old BSD FFS goes to extra lengths to ensure at
least meta-data consistency (it never cares about your data).

<p>Concerning Linux file systems, I am pretty sure that ext3 with the
default data=ordered mode can result in an inconsistent data state if
file overwriting is happening, but data consistency would be
achievable for files that are freshly created (I don't know if ext3
actually achieves it, though).  For ext4 I don't expect any data
consistency.

<blockquote> So ya.. apparently that 'fsync' was always needed by
application developers if they wanted to ensure that data was written
to disk in a timely fashion.
</blockquote>

Yes, but that's neither necessary nor sufficient for data consistency.

<blockquote> [...] in Ubuntu the dpkg program detects if it's running on
Ext4 and goes into paranoid mode were it runs 'fsync' were as with
Ext3 it does not. This causes Ubuntu installs to last significantly
longer if you choose 'Ext4' file system.
</blockquote>

Oh, really?  We have dozens of Debian systems running on ext3
(presumably without paranoid mode), and we have not had a single
problem with a dpkg database corrupted by the file system.  What does
Ubuntu do with dpkg that makes a <em>significant</em> difference in
the length of the installation life?  And where can I find the
statistics on which you base this claim?

      
          <div class="CommentReplyButton">
            <form action="/Articles/387715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 17:50 UTC (Fri)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/387758/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; We have dozens of Debian systems running on ext3 (presumably without paranoid mode), and we have not had a single problem with a dpkg database corrupted by the file system.</font><br>
<p>
No filesystem goes out and corrupts the dpkg database, but dpkg failing to properly ensure on-disk consistency might make it possible for an untimely power failure (or whatever) to trash its database. How often do you pull the plug while dpkg is running?<br>
<p>
That's why robustness is so hard -- it's almost impossible to test. That doesn't mean it isn't important. All it takes is one power failure with just the right timing to trash a datastore. Which is, of course, the whole problem here -- it means that as users we have to rely on external signals, like how I still don't really trust MySQL, because sure, I know they have transactions now, but do I *really* trust a group who was at one point talking about how useless they are to later have the necessary mind-numbing paranoia to catch every edge case? And hey, over here there's Postgres, whose developers clearly *are* absurdly paranoid, excellent...<br>
<p>
Or, how you don't trust ext4, even though you have no statistics on it either, because of how Ted T'so's messages came across. It's just a mystery to me how his basically sensible posts gave you (and others) this image of him as some kind of data-eating monster.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387774"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 19:15 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/387774/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
That's why robustness is so hard -- it's almost impossible to test. That doesn't mean it isn't important. All it takes is one power failure with just the right timing to trash a datastore.
</blockquote>

Virtualization and CoW should have made this much, much easier to test in a finegrained fashion; halt the VM you're using to do the testing, CoW the file, start a new VM using the CoWed copy and mount it; note if it failed and if so how, kill the VM, remove the CoWed copy of the file and let the VM run for another few milliseconds (or, if you're being completely pedantic, another instruction!)

      
          <div class="CommentReplyButton">
            <form action="/Articles/387774/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 19:36 UTC (Fri)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/387780/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's a neat idea. I don't think we have cycle-accurate VMs in FOSS yet, but it doesn't matter for this, you can do the halt/check after every disk write, not every instruction. It still doesn't solve a major part of the problem -- you also need to exercise all the weird corner cases that only arise under certain sorts of memory pressure, or what happens if the disk is fragmented in *this* way and has *this* queue write depth and that makes the elevator algorithm tempted to reorder writes in an unfortunate way, etc. -- but it'd be really useful!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/387780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor387784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2010 20:41 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/387784/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
I don't think we have cycle-accurate VMs in FOSS yet
</blockquote>
They just need to be accurate enough that stuff works. We're not trying to make Second Reality run, here. I can't think of anything that runs on Core 2 but not AMD Phenom because of differing instruction timings!
<blockquote>
all the weird corner cases that only arise under certain sorts of memory pressure
</blockquote>
Seems to me that the balloon driver is what we want; it can add memory to the guest on command, can't it also take it away? I don't see why we can't do an analogue of what SQLite does in its testing procedures (use a customized allocator that forces specific allocations to fail). The disk-fragmentation stuff would take a lot more work, probably a custom block allocator, which is a bit tough since the block allocator is one of the things we're trying to test!
      
          <div class="CommentReplyButton">
            <form action="/Articles/387784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor387812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2010 9:57 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/387812/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote> No filesystem goes out and corrupts the dpkg database,
but dpkg failing to properly ensure on-disk consistency might make it
possible for an untimely power failure (or whatever) to trash its
database.
</blockquote>

The file system does not have to go out to do it, because it was
entrusted with that data; so it can just fail to keep it consistent
while staying at home.  A good file system will properly ensure
on-disk consistency without extra help from applications (beyond
applications keeping the files consistent from the view of other
processes).

<blockquote>
How often do you pull the plug while dpkg is running?
</blockquote>

Never.  And I doubt it happens in a significant number of cases for
Ubuntu users, either.  And the subset of cases where ext3 corrupts the
database is even smaller.  That's why I questioned the drag's claim.

<blockquote>
That's why robustness is so hard -- it's almost impossible to test.
</blockquote>

And that's why I find the attitude that not the file system, but
applications should be responsible for data consistency in case of an
OS crash or power outage absurd.  Instead of testing one or a few file
systems, thousands of applications would have to be tested.

      
          <div class="CommentReplyButton">
            <form action="/Articles/387812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor392599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ext4 and data consistency with dpkg</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 18, 2010 5:38 UTC (Fri)
                               by <b>guillemj</b> (subscriber, #49706)
                              [<a href="/Articles/392599/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I know that this issue has cropped up again due to the fact that in</font><br>
<font class="QuotedText">&gt; Ubuntu the dpkg program detects if it's running on Ext4 and goes into</font><br>
<font class="QuotedText">&gt; paranoid mode were it runs 'fsync' were as with Ext3 it does not. This</font><br>
<font class="QuotedText">&gt; causes Ubuntu installs to last significantly longer if you choose</font><br>
<font class="QuotedText">&gt; 'Ext4' file system.</font><br>
&gt;<br>
<font class="QuotedText">&gt; If the dpkg folks were smart they'd enable paranoid mode on all file</font><br>
<font class="QuotedText">&gt; systems, except maybe Ext3 (due to Ext3's poor ability to handle that</font><br>
<font class="QuotedText">&gt; sort of workloads)</font><br>
<p>
dpkg has always done fsync() on the internal database, it was only<br>
missing doing fsync() for the extracted control files from a package<br>
to be installed/upgraded (which include maintainer scripts for example).<br>
<p>
As of recently, dpkg started doing fsync() before rename on *all*<br>
file systems for all extracted files from a package (there's actually<br>
never been any kind of file system detection or special "paranoid mode").<br>
It also does now fsync() on all database related directories.<br>
<p>
The reason for this has been mainly the zero-length issues with ext4<br>
(appearing even with the recent rename heuristic fixes), as we've had<br>
no previous bug reports of broken systems due to zero-length files on<br>
any other file system. But I consider it was still a bug for something<br>
like dpkg to not fsync() files, just because the package status would<br>
not match the package installed data, which is an issue, but not as<br>
grave as having empty files left around (think boot loader, kernel or<br>
libc as example).<br>
<p>
But those changes produced major performance regressions *only* on<br>
ext4 (that we know as of now), so we implemented per package delayed<br>
fsync()s + rename()s, which helped a bit with ext4, but not enough. We<br>
have now switched to use delayed sync() + rename()s *only* on Linux<br>
(because it's the only place were sync() is synchronous) which brings<br>
performance closer to the initial values. ext3 didn't have a noticable<br>
performance degradation during the implementation iterations.<br>
<p>
The still present zero-length issues and performance issues with fsync()<br>
have been reported to ext4 upstream, the solutions offered were to either<br>
not use fsync() because it's slow and it's not feasible to make it faster,<br>
use non-portable sync() or ignore the problem as it's not a usual case...<br>
(most of the hundreds of duped reports in Ubuntu, which happens to have<br>
ext4 as default file system in latest releases, were due to sudden power<br>
off, and not to system crash which were a minority).<br>
<p>
Not to mention this will be an issue if someone happens to port ext4 to<br>
any non-Linux kernel where sync() is asynchronous, then the only options<br>
for developers are either massive performance degradation or possible<br>
data loss in case of abrupt system crashes/shutdown...<br>
<p>
<font class="QuotedText">&gt; As far as my personal opinion this is a advantage for using Ext4 over</font><br>
<font class="QuotedText">&gt; Ext3 since upgrades will be much safer on my laptop...</font><br>
<p>
Well, whatever happens in maintainer scripts for example is not synced,<br>
so there's still room for data loss with dpkg on ext4...<br>
<p>
I've just checked if rpm is doing any kind of sync for extracted files<br>
before rename() and it does not seem so, I'm guessing other packaging<br>
systems might be susceptible to this issue too, but I've not checked.<br>
This is something they might also want to consider doing, in case those<br>
systems start offering ext4 as installation file system, or they might<br>
start suffering the same kind of bug reports as Ubuntu saw. :/<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/392599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor391370"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2010 2:01 UTC (Wed)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/391370/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't know if it's true or not, so condider the following as a bit of FUD in it's literal meaning.<br>
<p>
I have read horror histories about I/O controllers and discs messing commands queues when a power failure occurs. This is something that cannot be fixed in any sane way by the OS, the only protecction is a good recent backup. Wouldn't it be that the best solution for your case too?.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/391370/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2010 8:32 UTC (Wed)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/391380/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      I have done <a
href="http://www.complang.tuwien.ac.at/anton/hdtest/">experiments on
what disks do on power failure</a>, but barriers or turning off disk
write cacheing should help against these reorderings.  I have also
seen <a href="http://www.complang.tuwien.ac.at/anton/mergedisks/">disks that destroy old data and the low-level
formatting on power failure</a>.  And there are other modes in which
you can lose data, so having a good backup is a good idea in any case.

<p>Sure, if we are ready to restore our data from backup every time
there is a power failure or OS crash, we can use file systems like
tmpfs and ext4 for these data.  But many of us want to avoid that
hassle in the common case when the disk behaves properly, and we need
a file system for that case that behaves properly, too.  And just
like IBM (now Hitachi) and Maxtor (now Seagate) drives are on my
don't-buy list after the problems mentioned above, ext4 is on my
don't-use list.

      
          <div class="CommentReplyButton">
            <form action="/Articles/391380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391507"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 10, 2010 0:36 UTC (Thu)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/391507/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Sure, if we are ready to restore our data from backup every time there is </font><br>
<font class="QuotedText">&gt; a power failure or OS crash, we can use file systems like tmpfs and ext4 </font><br>
<font class="QuotedText">&gt; for these data.</font><br>
<p>
This is a trollish statement. I have lost power and had OS crashes many times with ext4 and never had to restore from backups.<br>
<p>
<font class="QuotedText">&gt; But many of us want to avoid that hassle in the common </font><br>
<font class="QuotedText">&gt; case when the disk behaves properly, and we need a file system for that </font><br>
<font class="QuotedText">&gt; case that behaves properly, too. And just like IBM (now Hitachi) and </font><br>
<font class="QuotedText">&gt; Maxtor (now Seagate) drives are on my don't-buy list after the problems </font><br>
<font class="QuotedText">&gt; mentioned above, ext4 is on my don't-use list. </font><br>
<p>
Even if you had a filesystem that met all of your requirements (and it's unclear if any real filesystem actually does), no consumer-grade hardware guarantees sane behavior in the event of power loss. Some hard disks are better than others, but a lot have serious problems. Some lie about when data has been flushed to disk. Others corrupt data randomly when power is lost.<br>
<p>
Even if you buy only certain brands of drives, manufacturers re-brand hard drives all the time. It's hard to know what you're actually buying.<br>
<p>
So *if* your hard drive doesn't ruin power-loss for you anyway, *and* your application is written sloppily enough that it doesn't fsync, *and* this application is critical to your system, then ext3 *might* be more reliable, maybe. Is it possible that you're overreacting?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/391507/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2010 14:01 UTC (Mon)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/391981/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You are lucky - the user of one Linux PC that I manage had an unfortunate habit of nudging the reset button when sitting down ...  This is rather a pathological case but it resulted in serious data loss on two separate filesystems on different physical disks (one PATA and one SATA), despite no actual power loss.  I was using an ext3 plus LVM setup and I'm convinced that the use of hard disk write caching was the problem.<br>
<p>
<a href="http://lwn.net/Articles/343425/">http://lwn.net/Articles/343425/</a> has more details.  Haven't had any more problems since stopping use of write caching and making some other changes such as ext3 data=journal.  I also stopped using LVM but I don't think that's a factor - on other PCs I now just use data=journal and turn off hard disk write caching, and still use LVM.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/391981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor392070"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 15, 2010 10:07 UTC (Tue)
                               by <b>etienne</b> (guest, #25256)
                              [<a href="/Articles/392070/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That is strange: the reset button is not (and has never) been connected to the hard disk, i.e. the hard disk is only aware of the reset button been pressed when the BIOS re-initialises the ATA/SATA interface (so a long time after). There isn't any "reset wire" on ATA or SATA connector.<br>
Historically, that has lead to strange bugs - like LILO was able to start after running Windows 3.1 but not from a cold boot (or the opposite), because the hard disk was reconfigured with a different number of heads and sector per track (BIOS only times, no LBA).<br>
For all what I can see, it is exactly the same nowadays.<br>
The reason has always been to give time to the hard disk to finish and write back its cache.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/392070/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor392147"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 15, 2010 20:33 UTC (Tue)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/392147/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My mistake - it was actually the power button not reset that was pressed repeatedly.  So there was power loss which is probably what caused the problem due to hard disk write caching.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/392147/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor393204"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 23, 2010 1:41 UTC (Wed)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/393204/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Up until Linux 2.6.31, write barriers were always disabled while using LVM. So it's unlikely that journaling would have been very effective at preventing data loss in a system using something like ext3 + LVM + Linux 2.6.28.<br>
<p>
Personally, I use rsync for monthly backup, every month, and hope for the best. And when you see that first I/O error come out of /dev/sda... throw that thing in the trash. I've never seen a disk "get better" after starting to give I/O timeouts and errors.<br>
<p>
C.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/393204/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor393205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 23, 2010 1:49 UTC (Wed)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/393205/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just to clarify. I've never had to restore my data from backup drives. I have had hard disks go "funny" on me. This happened on two disks. Files started becoming unreadable some of the time (but not all) and I/O timeouts started happening. In both cases, I copied over my data from the affected disk to a new disk.<br>
<p>
I haven't ever lost data as a result of a power outage, partly because I'm a compulsive user of the save button / command. I also didn't get bitten by the ext4 rename bug / controversy because I was using ext3 at the time. I don't have a UPS at home or work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/393205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor393237"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 23, 2010 12:16 UTC (Wed)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/393237/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Since I turn off disk write caching that <a href="http://lwn.net/Articles/283460/">bypasses the problem</a> of write barriers being disabled in such kernels.

For backups, I use DAR (like tar but with granular checksums for easier recovery from corruption) and <a href="http://rsnapshot.org/">rsnapshot</a>, which is rsync-based, but a true backup system as it saves multiple versions and runs very fast, like rsync - works very well as long as you don't have very large files that change frequently.
      
          <div class="CommentReplyButton">
            <form action="/Articles/393237/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor393251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Next3 filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 23, 2010 13:30 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/393251/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
DAR (like tar but with granular checksums for easier recovery from corruption)
</blockquote>
Actually par2 provides that feature. What dar gives you is multi-storage-medium support via running arbitrary scripts to change medium. tar has nothing like it.
<blockquote>
works very well as long as you don't have very large files that change frequently
</blockquote>
Like, uh, VM images? I hear they're quite common these days.
<p>
(If you've got a lot of those, try rdiff-backup. It's slower than rsnapshot, but when a file changes it stores rdiff-format compressed deltas from the new file to the old one, rather than resaving the entire old file all over again.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/393251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor391353"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Filesystem Independence</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2010 22:35 UTC (Tue)
                               by <b>BrucePerens</b> (guest, #2510)
                              [<a href="/Articles/391353/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Why do this at the filesystem level? It's possible to do a copy-on-write image as a block device. Then you'd have filesystem independence. It would be sensitive to changes in filesystem metadata: time stamps, free block lists, inodes, etc., but I'm not convinced this would be a tremendous overhead unless you compact the filesystem or do something else that causes all blocks to be written.
      
          <div class="CommentReplyButton">
            <form action="/Articles/391353/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Filesystem Independence</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2010 22:45 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/391356/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
one possible reason (and I don't know if it's true in this case) would be that by doing this at the filesystem level they can be smarter than something at the block level could be.<br>
<p>
some things could be implemented as a journal ('timestamp on this file changed from X at time T' is much shorter than duplicating the entire block)<br>
<p>
the filesystem can also be smarter about the location of blocks when it's accessing a block device more directly. One problem with doing snapshots at the block level is that you very quickly end up with a lot of seeking. The filesystem can be smarter about this.<br>
<p>
in practice it may or may not matter, but there are enough places where it could matter that it's worth exploring.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/391356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391357"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Filesystem Independence</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2010 23:02 UTC (Tue)
                               by <b>BrucePerens</b> (guest, #2510)
                              [<a href="/Articles/391357/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p><blockquote><i>one possible reason (and I don't know if it's true in this case) would be that by doing this at the filesystem level they can be smarter than something at the block level could be.</i></blockquote><p>Yes, of course. At the filesystem level, you can ignore everything except for the data content of directories, files, and symlinks, and some of the metadata that would be returned by stat.<p>
What I don't have so far is proof that being smarter is really smart this time. There is a cost per filesystem format, is it more than 10% greater than the cost of doing this at the block image level?<p>10% seems like a low cost compared to dealing with Ted, Linus, etc. And if you get filesystem independence too, it's a deal!
      
          <div class="CommentReplyButton">
            <form action="/Articles/391357/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor391360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Filesystem Independence</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2010 23:05 UTC (Tue)
                               by <b>BrucePerens</b> (guest, #2510)
                              [<a href="/Articles/391360/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Oops, I mean is the cost of doing this at the block level more than 10% greater than doing it at the filesystem level. I wrote the reverse.
      
          <div class="CommentReplyButton">
            <form action="/Articles/391360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
