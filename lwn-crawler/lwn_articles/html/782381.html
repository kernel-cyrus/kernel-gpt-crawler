        <!DOCTYPE html>
        <html lang="en">
        <head><title>The Thunderclap vulnerabilities [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/782381/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/780941/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/782381/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The Thunderclap vulnerabilities</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>March 6, 2019</br>
           </div>
<p>
It should come as no surprise that plugging untrusted devices into a
computer system can lead to a wide variety of bad outcomes—though often
enough it works just fine.  We have reported on a number of these kinds of
vulnerabilities (e.g. <a href="/Articles/608503/">BadUSB in 2014</a>) along
the way.  So it will not shock readers to find out that another
vulnerability of this type has been
discovered, though it may not sit well that, even after years of vulnerable
plug-in buses, there are still no solid protections against these rogue
devices.  This most-recent entrant into this space targets the <a
href="https://en.wikipedia.org/wiki/Thunderbolt_(interface)">Thunderbolt</a>
interface; the
vulnerabilities found have been dubbed "Thunderclap". 
</p>

<p>
There are several different versions of Thunderbolt, either using Mini
DisplayPort connectors (Thunderbolt&nbsp;1 and&nbsp;2) or USB Type-C
(Thunderbolt&nbsp;3).  According to the long list of researchers behind
Thunderclap, all of those are vulnerable to the problems they found.
Beyond that, <a href="https://en.wikipedia.org/wiki/PCI_Express">PCI
Express</a> (PCIe) peripherals are also able to exploit the Thunderclap
vulnerabilities, though they are a bit less prone to hotplugging.
Thunderclap is the subject of a <a
href="https://thunderclap.io/thunderclap-paper-ndss2019.pdf">paper
[PDF]</a> and <a href="https://thunderclap.io/">web site</a>.  It is more
than just a bunch of vulnerabilities, however, as there is a <a
href="https://github.com/thunderclap-io">hardware and software research
platform</a> 
that they have 
developed and released. A high-level <a
href="https://www.lightbluetouchpaper.org/2019/02/26/struck-by-a-thunderbolt/">summary
of the Thunderclap paper</a> was posted to the Light Blue Touchpaper blog
by Theo Markettos, one of the researchers, at the end of February.
</p>

<p>
At its core, Thunderclap exploits the ability of devices with direct
memory access 
(DMA) capability to read system memory, including memory that is not at all
related to the supposed function of the device.  That memory could easily
have sensitive information, such as encryption keys or login credentials,
that the user probably does not realize they are exposing.  In addition,
because USB Type-C connectors are used for charging these days, it
will be highly surprising that a "charger" may actually also be a
Thunderbolt device—with all of the access that implies.  Many users may not
realize their "innocuous" charging port is really much more than that. 
</p>

<p>
The primary hardware defense against rogue DMA devices is the <a
href="https://en.wikipedia.org/wiki/Input%E2%80%93output_memory_management_unit">I/O 
memory-management unit</a> (IOMMU), but many operating systems do not even
enable it.  Windows, Linux, and FreeBSD do not enable the IOMMU for
Thunderbolt, though 
Linux has added <a
href="/ml/linux-kernel/20181112160628.86620-1-mika.westerberg%40linux.intel.com/">some
support</a> in&nbsp;5.0. But even for macOS, which does enable the IOMMU,
there are significant holes.  The researchers created a fake Thunderbolt
network card 
that had far more access than expected on the systems that they
tested. Markettos described it this way (some of which found its way into
last week's <a href="/Articles/780816/">Security quotes of the week</a>):
<div class="BigQuote">
We found the attack surface available to a network card was much richer and
more nuanced than was previously thought. By examining the memory it was
given access to while sending and receiving packets, our device was able to
read traffic from networks that it wasn't supposed to. This included VPN
plaintext and traffic from Unix domain sockets that should never leave the
machine. 
<p>
On MacOS and FreeBSD, our network card was able to start arbitrary programs
as the system administrator, and on Linux it had access to sensitive kernel
data structures. Additionally, on MacOS devices are not protected from one
another, so a network card is allowed to read the display contents and
keystrokes from a USB keyboard. 
<p>
Worst of all, on Linux we could completely bypass the enabled IOMMU, simply
by setting a few option fields in the messages that our malicious network
card sent. 
</div>
</p>

<p>
In theory, the IOMMU could provide the full protection needed, but the
current implementations in today's operating systems are lacking:
<div class="BigQuote">
Existing strategies for using the IOMMU to protect against DMA attacks come
with a high performance cost. This cost has led current operating systems
to trade off security for performance gains - in some cases even disabling
the IOMMU by default. Current operating systems also put sensitive data in
the same regions of memory used for peripheral device communication, which
facilitates attacks even when the IOMMU is enabled.
</div>
</p>

<p>
Markettos likens the situation with the IOMMU to that of the system-call
interface.  The latter has undergone lots of testing and hardening over the
years, but that process is just starting for the IOMMU:
<div class="BigQuote">
More generally, since this is a new space of many vulnerabilities, rather
than a specific example, we believe all operating systems are vulnerable to
similar attacks, and that more substantial design changes will be needed to
remedy these problems. We noticed similarities between the vulnerability
surface available to malicious peripherals in the face of IOMMU protections
and that of the kernel system call interface, long a source of operating
system vulnerabilities. The kernel system call interface has been subjected
to much scrutiny, security analysis, and code hardening over the years,
which must now be applied to the interface between peripherals and the
IOMMU.
</div>

<p>
Linux does have <a
href="https://christian.kellner.me/2017/12/14/introducing-bolt-thunderbolt-3-security-levels-for-gnulinux/">support</a>
for Thunderbolt&nbsp;3 security levels (or access controls), though those
are fairly coarse 
controls. The security levels affect whether certain types of devices can
be used with the system, but do not restrict the access of authorized
devices.  There is <a href="https://gitlab.freedesktop.org/bolt/bolt">a
user-space daemon and a command-line program</a> to work with the security
levels, as well as <a
href="https://christian.kellner.me/2019/02/27/thunderclap-and-linux/">GNOME
integration</a>.   These security levels are also
governed by the identification string provided by the device itself, so
spoofing is certainly a possibility. 
</p>

<p>
Protections against the Thunderclap vulnerabilities range from the drastic
 to more prosaic mechanisms:
<div class="BigQuote">
More generally, however, we have discovered a larger vulnerability space
that is not fully addressed by mitigations for specific attacks. The best
way to fully protect yourself is to disable the Thunderbolt ports on your
machine. However, the need to charge and connect legitimate peripheral
devices makes doing so infeasible in general. PCs often allow disabling
Thunderbolt in firmware (BIOS/UEFI) settings, while permitting power, video
and USB. Externally, a USB hub/docking station without Thunderbolt support
should suffice to prevent a USB-C port being switched into Thunderbolt
mode.
<p>
You can also protect yourself by not leaving your computer unattended in
public and not using public USB-C charging stations. Be wary of connecting
an unknown device to the Thunderbolt port of your machine, even chargers
and projectors that may seem harmless.
</p>
</div>
</p>

<p>
The advice about unattended computers is true for regular USB ports—and <a
href="/Articles/359145/">in 
general</a>—as well.  With each new hardware feature, it seems, the
physical security of our computers and other devices becomes ever more
important. In some sense, Thunderclap isn't really new, but is simply yet
another reminder of the perils of hardware (in)security.  While our
software has its share of problems, of course, the hardware folks aren't
making the security story any easier.  
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Vulnerabilities">Security/Vulnerabilities</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Hardware_vulnerabilities">Hardware vulnerabilities</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/782381/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor782514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 0:42 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/782514/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yet another Intel-designed thing full of holes? What a shocker.<br>
<p>
It's pretty shameful that these exploits are happening over and over after the industry's had approximately two decades to learn the risks of giving DMA to external peripherals. The kernel even advertises Firewire debugging as a *feature*!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782515"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 2:15 UTC (Thu)
                               by <b>arekkusu</b> (subscriber, #54092)
                              [<a href="/Articles/782515/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Nothing new with DMA being dangerous (and also useful of debugging). However we're in 2019 and I think providing unrestricted DMA to external device should not be acceptable.<br>
<p>
What constitute an external or internal interface might not be obvious for some attack. For example the SATA port on my ThinkPad UltraBay is quite accessible. Disabling FireWire and other unused port in the BIOS is something I've been doing for a long time.<br>
<p>
But a USB Type-C connector is something everyone will be using. Considering Thunderbolt 3 will become USB4, it is a real concern. And just telling user to not plug in "untrusted device" is not good enough.<br>
<p>
And my understanding is that this can not be fully fixed at the OS level:<br>
<p>
"Kernel DMA Protection only protects against drive-by DMA attacks after the OS is loaded. It is the responsibility of the system firmware/BIOS to protect against attacks via the Thunderbolt™ 3 ports during boot."<br>
Ref:  <a href="https://docs.microsoft.com/en-us/windows/security/information-protection/kernel-dma-protection-for-thunderbolt">https://docs.microsoft.com/en-us/windows/security/informa...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782515/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 8:35 UTC (Thu)
                               by <b>mangix</b> (guest, #126006)
                              [<a href="/Articles/782528/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually there will be a USB 3.2 which brings the same speed as thunderbolt 3 but for USB (so no DMA).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782589"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 17:39 UTC (Thu)
                               by <b>mebrown</b> (subscriber, #7960)
                              [<a href="/Articles/782589/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thunderbolt 3 - 40Gbps top speed<br>
USB 3.2 2x2 superspeed - 20Gbps top speed<br>
<p>
We don't get equivalent top speeds until USB4 is released.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782589/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor782519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 2:50 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/782519/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How is it Intel's fault that Linux puts function pointers in the same page as network packets?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 13:58 UTC (Thu)
                               by <b>robclark</b> (subscriber, #74945)
                              [<a href="/Articles/782544/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems like we need the concept of a "less trusted" dma capable device that both sits behind iommu plus gets bounce buffer for things smaller than a page..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor782597"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 20:49 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/782597/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One could argue that Intel wrote the e1000 driver which uses kmalloc to allocate 2K areas which thereby enables the malicious device to access what's in the other 2K of the page the buffer resides in. Shockingly, other kernel code also uses kmalloc, hence, this can lead to a variety of interesting observations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782597/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782685"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2019 1:34 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/782685/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In Intel's defence, "I allocated 2K of memory rather than a full page" is not exactly an *obvious* equivalent to "now externally-connected peripherals can spy on kernel data structures". Developers do generally assume kernel memory is only readable by the kernel, and that the PCIe bus is trusted -- both of which are, it is true, questionable assumptions, but it's damn hard to write useful code at that level without making at least one of them. (And the e1000e driver is much older than Spectre and other similar families of oh-just-blow-away-access-protection attacks.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782685/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782726"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2019 0:17 UTC (Mon)
                               by <b>mtaht</b> (subscriber, #11087)
                              [<a href="/Articles/782726/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Millcomputing's PLB is the only way out. ( <a href="http://millcomputing.com/wiki/Protection">http://millcomputing.com/wiki/Protection</a> )<br>
<p>
Too bad I don't have a spare billion $ to get it past plausible promise.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782726/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor782794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 11, 2019 19:50 UTC (Mon)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/782794/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The point was supposed to be that "Linux" doesn't "put function pointers in the same page as network packets" in the way this statement suggests. <br>
<p>
Linux has a general purpose kernel memory allocator. This is  a power-of-2-freelist allocator sitting atop the page allocator (more precisely it's implemented as set of object caches for objects whose sizes are powers-of-two). As detailed in the paper, the e1000 driver allocates skbs via kmalloc. This means its network buffers will usually occupy some part of a page. An access control mechanism with page granularity thus cannot prevent malicious devices from accessing the remaining part of the page. As that's just one of the pages currently allocated to one of the kmalloc caches, any other part of the kernel which uses kmalloc could end up using this "remaining part of the page".<br>
<p>
The gist of this is that a (page-based) IOMMU can only prevent malicious devices from accessing data they're aren't supposed to access if the devices drivers used for such devices do their own memory management based getting complete pages from the page allocator.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 11:02 UTC (Tue)
                               by <b>westeri</b> (subscriber, #62678)
                              [<a href="/Articles/782819/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is now a patch series from Lu Baolu aiming to fix the remaining issues here:<br>
<p>
  <a href="https://lore.kernel.org/lkml/20190312060005.12189-1-baolu.lu@linux.intel.com/">https://lore.kernel.org/lkml/20190312060005.12189-1-baolu...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782826"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 14:25 UTC (Tue)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/782826/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Copy the data into a dedicated page" is an ugly workaround for the issue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782826/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 16:16 UTC (Tue)
                               by <b>westeri</b> (subscriber, #62678)
                              [<a href="/Articles/782855/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Feel free to propose a better one that does not involve fixing all the possible PCI drivers using DMA ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 19:48 UTC (Tue)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/782858/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Don't buy devices from the people who wrote the paper"?<br>
<p>
Assuming that memory protection/ accesss control with page granularity is available, DMA buffers used by untrusted devices (and this should really be all kinds of devices) must not share memory pages with code whose information said untrusted devices are not supposed to access if the access control is supposed to be used effectively.  This means *if* such a facility is to be used in a sensible way, DMA buffer allocation must be per-device and separate from all other allocations, including other DMA buffer allocation.<br>
<p>
There are obviously tradeoffs here as most real-world devices won't be untrusted but singling out a certain kind of devices and adding an additional DMA buffer allocation system working on top of the existing DMA buffer allocation systems is a technically seriously unpleasant workaround for a highly unlikely fringe case.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782873"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 21:01 UTC (Tue)
                               by <b>westeri</b> (subscriber, #62678)
                              [<a href="/Articles/782873/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem here is that you can essentially plug in any PCIe device to a Thunderbolt enclosure (as they come with one or multiple PCIe slots). This means that you would need to fix each and every PCI driver to make sure they only do DMA to/from buffers that fill the whole page (the minimum IOMMU window size). Doing it in the IOMMU driver allows us to prevent the DMA attack now without need to modify all the PCI drivers. Since it only bounces buffers not filling the whole page so when a driver gets "fixed" it won't bounce anymore and eventually we can turn the bouncing off completely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782873/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782875"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 21:50 UTC (Tue)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/782875/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The problem here is that you can essentially plug in any PCIe device to a Thunderbolt enclosure (as they come with one or multiple &gt; PCIe slots). This means that you would need to fix each and every PCI driver</font><br>
<p>
Yes. I thought I already wrote this ("this should really be all kinds of devices"): If this issue is supposed to be mitigated by the IOMMU, any driver which supports DMA would need to use its own DMA buffer backing pages cache. There's no need for individual buffers  to span a complete page (or some number of complete pages) provided management information used by a driver isn't kept in the unused parts of some page a part of which is currently used as DMA buffer, at least not in a way where corruption could go unnoticed. Malicious device snooping on itself sounds pretty harmless to me ;-).<br>
<p>
Assuming that fixing this is considered desirable (the underlying issue has existed forever --- there's no reason why hardware designed by an unknown entity ought to be trustworthy, especially not if this 'hardware' is in itself complicated enough to contain a general purpose CPU running some decidedly non-trivial software), this cries out for some sort of infrastructure support for DMA buffer allocation drivers could easily make use of.<br>
<p>
NB: I understand the benefits of the existing approach. But that's still just life-patching of a more fundamentally deficient (in this respect) memory management model.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782875/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782927"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2019 15:21 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/782927/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; any driver which supports DMA would need to use its own DMA buffer backing pages cache</font><br>
<p>
The page cache would need to be separate for each *device*, not each driver. A device snooping on itself may be harmless, but the same is not necessarily true for snooping on other devices managed by the same driver. Besides the fact that one driver might manage multiple brands and models of devices, some more trustworthy than others, one can also envision e.g. a system with two identical NICs surreptitiously snooping on each other and transmitting internal network data over the external network.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782927/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782947"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 13, 2019 19:17 UTC (Wed)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/782947/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; any driver which supports DMA would need to use its own DMA buffer backing pages cache</font><br>
<font class="QuotedText">&gt; The page cache would need to be separate for each *device*, not each driver. </font><br>
<p>
A driver capable of managing more than one device would obviously need one cache per currently managed device. Do you think somebody wouldn't immediately recognize this if such a driver was under discussion?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782947/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor783443"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2019 13:31 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/783443/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It feels to me like a pooled allocator is what you want: each DMA-capable device gets a separate pool, and memory the allocator gives back to a given pool uses pages distinct from that used by all other pools; memory is zeroed before being placed in the pool. That way, a hostile device can only spy on memory it itself has populated (assuming that page-level protection still functions properly: so even this still needs a working IOMMU).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/783443/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor782721"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2019 19:07 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/782721/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; How is it Intel's fault that Linux puts function pointers in the same page as network packets?</font><br>
<p>
It's a brand new Remote Procedure Call technology; did you read the article? :-)<br>
<p>
Remember: code is data and data is code <a href="https://lwn.net/Articles/778550/">https://lwn.net/Articles/778550/</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782721/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor782525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 7:34 UTC (Thu)
                               by <b>halla</b> (subscriber, #14185)
                              [<a href="/Articles/782525/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
" In addition, because USB Type-C connectors are used for charging these days, it will be highly surprising that a "charger" may actually also be a Thunderbolt device—with all of the access that implies."<br>
<p>
I think there's a 'not' missing between 'will' and 'be'. At least, I was not highly surprised.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782671"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2019 21:58 UTC (Fri)
                               by <b>cpitrat</b> (subscriber, #116459)
                              [<a href="/Articles/782671/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It will be highly surprising for the average user I guess.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782671/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor782687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2019 8:39 UTC (Sat)
                               by <b>nivedita76</b> (guest, #121790)
                              [<a href="/Articles/782687/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Really? You wouldn’t find it highly surprising that what looks like a wall wart is reading out your laptop’s memory?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor783200"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">standard plug and play security convenience tradeoff thing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 16, 2019 1:51 UTC (Sat)
                               by <b>Garak</b> (guest, #99377)
                              [<a href="/Articles/783200/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Not for at least 5 years,-<br/>
<br/>
<a rel="nofollow" href="https://arstechnica.com/information-technology/2013/12/inside-the-nsas-leaked-catalog-of-surveillance-magic/">https://arstechnica.com/information-technology/2013/12/inside-the-nsas-leaked-catalog-of-surveillance-magic/</a><br/>
<blockquote>the NSA has built and deployed its own USB cables at target locations—complete with spy hardware and radio transceiver packed inside."</blockquote>
I also recall a few articles from those key early Snowden days where one of the oddly louder complaints from the government about Snowden's leak related to them having to replace a large number of cables.
<blockquote>The COTTONMOUTH series of implants are USB devices that provide a covert wireless bridge into a target network. They can be integrated into any USB plug, so check your mouse.</blockquote>
      
          <div class="CommentReplyButton">
            <form action="/Articles/783200/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor782541"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">using hardware filters...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 10:35 UTC (Thu)
                               by <b>Herve5</b> (subscriber, #115399)
                              [<a href="/Articles/782541/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I for one have been happily using a couple of "USG" filters (<a href="https://github.com/robertfisk/USG">https://github.com/robertfisk/USG</a>), which work absolutely well for USB1; I see now the author builds USB2 filters (faster, but not fully open anymore apparently)<br>
<p>
This may become an opportunity to prepare something for USB3/Thunderbolt?<br>
<p>
H.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782541/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor782555"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 15:29 UTC (Thu)
                               by <b>dirkhh</b> (subscriber, #50216)
                              [<a href="/Articles/782555/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ever since buying my first Mac with USB-C charging I wondered if there's a simple way to have a hardware dongle that allows JUST the charging, but none of the data access. I.e., male/female USB-C connector with enough electronics in between to enable charging, but nothing else.<br>
<p>
Obviously that would be equally useful when charging your USB-C phone.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782555/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782559"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 15:42 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/782559/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      I have a "USB condom" for USB A that, naturally, can be used with an A-to-C cable for charging (and I do just that).  I haven't seen such a thing for native USB C yet.
      
          <div class="CommentReplyButton">
            <form action="/Articles/782559/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782561"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2019 15:52 UTC (Thu)
                               by <b>dirkhh</b> (subscriber, #50216)
                              [<a href="/Articles/782561/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi Jon,<br>
<p>
The problem with that is the USB A would limit you to something like 12.5W, right? And for a modern phone that's disappointing whereas for a MacBook Pro that isn't even enough to keep it from discharging while idle...<br>
<p>
But yes, it sounds like we need a "USB C condom"... <br>
Having that name actually gives me more interesting Google result - but from what I can see so far there have been quite a few requests similar to mine, but only USB-A versions appear to actually exist.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782561/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782677"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2019 23:33 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/782677/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Basic USB2 is limited to 5V@500mA - 2.5W. There's fast charging “standards” that go up to 900mA or more and most of them use passive components to signal it.<br>
<p>
USB-C power negotiation however… makes the Linux x86 early-boot code sound simple and reasonable in comparison. Cables have their own CPUs, voltages aren't fixed, the hardware has to be prepared to put up to 100 watts into a tiny, fully bidirectional connector (and it's already infamous for doing it in the wrong direction too often - your phone will probably make a futile attempt to charge your laptop at some point). The technology's a disaster at every level.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782677/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor782720"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 10, 2019 17:35 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/782720/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Probably the best technical blog about Type-C<br>
<a href="https://plus.google.com/collection/0Vdov">https://plus.google.com/collection/0Vdov</a><br>
moving to <a href="https://medium.com/@leung.benson">https://medium.com/@leung.benson</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782720/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor782860"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2019 17:18 UTC (Tue)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/782860/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think this complexity doesn't prevent categorically the idea of a device which tries to limit the interaction to charging.  However, it does make it challenging, and fairly hard to imagine proving it safe.  <br>
<p>
Which is probably what you were getting at.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782860/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor782663"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The Thunderclap vulnerabilities</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 8, 2019 18:53 UTC (Fri)
                               by <b>JFlorian</b> (guest, #49650)
                              [<a href="/Articles/782663/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems like a good time to mention usbguard [<a href="https://usbguard.github.io/">https://usbguard.github.io/</a>].  Obviously this is only one attack surface but it helps.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/782663/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
