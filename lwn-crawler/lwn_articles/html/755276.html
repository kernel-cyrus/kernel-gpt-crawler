        <!DOCTYPE html>
        <html lang="en">
        <head><title>An update on bcachefs [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/755276/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/754734/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/755276/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>An update on bcachefs</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 23, 2018</br>
           <hr>
<a href="/Articles/lsfmm2018/">LSFMM</a>
</div>
<p>
The <a href="https://bcachefs.org/">bcachefs filesystem</a> has been under
development for a number of years now; according to lead developer Kent
Overstreet, it is time to start talking about getting the code upstream.
He came to the 2018 Linux Storage, Filesystem, and Memory-Management Summit
(LSFMM) to discuss that in a combined filesystem and storage
session.  Bcachefs grew out of <a
href="https://bcache.evilpiepirate.org/">bcache</a>, which is a block layer
cache that was merged into Linux&nbsp;3.10 in mid-2013.
</p>

<p>
Five or six years ago, when he was still at Google, creating bcachefs from
bcache seemed like it would take a year and 15,000 lines of code,
Overstreet said.  Now, six years and 50,000 lines of code later, it is a
real filesystem.  It "turned out really well", he said.
</p>

<a href="/Articles/755291/">
<img src="https://static.lwn.net/images/2018/lsf-overstreet-sm.jpg" border=0 hspace=5
align="left" alt="[Kent Overstreet]" title="Kent Overstreet" width=219
height=300>
</a>

<p>
Bcachefs is a general-purpose copy-on-write filesystem with lots of
features, including 
checksumming for blocks, compression, encryption, multiple device support,
and, of course, caching.  Jens Axboe asked if there was still a clean
separation between bcachefs and bcache.  Overstreet said that there was;
roughly 80% of the code is shared.  He has taken out the bcache interfaces
in his development tree because there is no need for them as bcachefs can
handle all of what bcache can do (and more).
</p>

<p>
Hannes Reinecke asked about the long-term expectation for bcache and
bcachefs; will they coexist or will bcache be removed in favor of
bcachefs.  Overstreet said that bcache is the prototype for all of the
ideas in bcachefs.  As part of developing bcachefs, the B-tree code has
been fleshed out and polished.  Bcache was fast in most cases, but there
were some corner cases where it was not; all of that has been fixed in
bcachefs. 
</p>

<p>
He said that he would like get users off of bcache and onto bcachefs.  The
filesystem has an <tt>fsck</tt> available to detect and repair problems.  A
block layer cache does not get the same level of testing that a full
filesystem does.  By creating and upstreaming bcachefs, he will in some
sense be turning it into a real project.
</p>

<p>
He would prefer not have both the block layer and filesystem interfaces,
since that doesn't really provide anything extra.  One major disadvantage
of bcache is that writes to the backing device are not copy on write
so there are cache coherency issues.  Bcache had ways to deal with those
problems, but bcachefs simply eliminates them entirely.
</p>

<p>
Ted Ts'o asked how many users of bcache there are; how much of a problem
is it to get rid of bcache?  Axboe said that there are users and a
community has formed to develop and maintain it.  Ts'o said he would be in
favor of eliminating bcache, but if there are users of the
feature, that really cannot happen.  Reinecke said that SUSE supports
bcache in its distributions, so it will need to be maintained for a few
years.
</p>

<p>
The on-disk format is different between bcache and bcachefs, similar to how
ext2, ext3, and ext4 have evolved, Overstreet said.  If he brought back the
block device 
interfaces into bcachefs, then the filesystem could be a drop-in
replacement for bcache.  Ts'o noted that before ext3 and ext2 could be
dropped, ext4 was able to handle the other two; if bcachefs can support the
older bcache devices, the same could be done.  Axboe said that perhaps an
offline conversion tool could be written.  Reinecke said that SUSE will
still need bcache as a device for some time, but doesn't care if it is
provided by the bcache code or by bcachefs.
</p>

<p>
Amir Goldstein asked about support for reflink, but Overstreet said that
bcachefs does not have that yet.  It is one of the easier things on the
to-do list, however.  Other things on that list include erasure coding and
then snapshots further out.  The reflink feature uses the same design as is
in XFS, he said.  Dave Chinner said that reflink is a major feature to be
missing from a filesystem these days.  Overstreet said that he has gotten
much of it working, but space accounting is not right yet.
</p>

<p>
Chinner asked if there would be an on-disk format changes that would
require "forklift upgrades".  The snapshot feature will require on-disk
format changes, Overstreet said, but the other features should not.  There
has not been a need to change the on-disk format for quite some time, which
is part of why he thinks it is ready to go upstream.
</p>

<p>
Chinner wondered where bcachefs is aimed; what are its target users?
Overstreet said that the killer feature is performance.
The latency tail is "really really
good", he said.  In tests, it has gotten 14GB/sec writes without major CPU
impact and mixed read/write workloads also do well.  On every workload the
project can find, bcachefs performs as fast as the hardware should go.
</p>

<p>
Both small and large users will benefit from the filesystem, he said.  He
has been using it as his root filesystem for several years, there are users
running it on servers, and the company that is funding him to work on
bcachefs is using it on NAS boxes with up to 60 spindles.  He was asked
about shingled magnetic recording (SMR) support; both bcache and bcachefs
do file data allocation in terms of 1-2MB buckets, which they write to
once.  That 
should be fairly SMR-friendly, but he has not worked out how to deal with
metadata on SMR devices yet.
</p>

<p>
Ts'o wondered about the diversity of devices that had been used in the
benchmarking; that would be useful in determining what the strengths and
weaknesses of bcachefs are.  Has it been tried on older hardware, low-end flash
devices, small disks, etc.?  From what he has heard, it "starts to sound
like snake oil". 
It has been tested on big RAID devices, high-end NVMe devices, and various
other options, but has not been tested on some of the lower-end
devices that were asked about, Overstreet said.
</p>

<p>
The discussion then shifted to whether it was time to get bcachefs into the
mainline and how that process would work.  Axboe was concerned that the
on-disk format may still change to support snapshots and wondered if it
made sense to wait until that work was completed.  But filesystems can
support multiple on-disk formats; Btrfs does it, as Josef Bacik pointed
out, and XFS has been doing it for 20 years, Chinner said.  Overstreet said that
filesystems using the current on-disk format would still be fully
supported, just that they would not be able to take snapshots.
</p>

<p>
Ts'o asked about xfstests and Overstreet said that he uses them all the
time; there is a 30-line patch needed to support bcachefs.  Once that is
added, Ts'o said, he would be happy to add bcachefs to his automated
testing regime.
</p>

<p>
Bacik said that the filesystem and storage developers need to see the code
and know that he will be around to maintain it, at least until there are
others who will pick it up.  He said that Overstreet had hit all the high
points, so Bacik said he was comfortable with starting the review process.
</p>

<p>
Overstreet said he would <a href="/Articles/753979/">post his patches</a>
shortly after LSFMM, but that it is 50,000 lines of code.  Chinner said
that it needs to be broken up into sane chunks.  Bacik agreed, saying that
he mostly cared about the interfaces, not the internal B-tree stuff.
Chinner said that the user-space APIs and the on-disk format were two
places to start; people make "obvious mistakes" in those areas.  Next would
be the interface to the VFS; generally, reviewers are going to be most
interested in things at the periphery.   Ts'o suggested that since
Overstreet knows the code best, he should highlight places where he is
making assumptions about various other parts of the kernel (e.g. the dentry
cache, the memory-management subsystem); that would allow reviewers to
scrutinize that code.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-bcachefs">Filesystems/bcachefs</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2018">Storage, Filesystem, and Memory-Management Summit/2018</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/755276/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor755445"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 22:54 UTC (Wed)
                               by <b>harlequin</b> (guest, #119081)
                              [<a href="/Articles/755445/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm really looking forward to have bcachefs upstreamed. Thank you Kent for your perseverance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755445/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 0:10 UTC (Fri)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/755599/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks, I appreciate it :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755446"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 23:26 UTC (Wed)
                               by <b>doublez13</b> (guest, #122213)
                              [<a href="/Articles/755446/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does anyone know of a good comparison between the implemented/expected features of bcachefs and btrfs?<br>
<p>
Bcachefs is starting to sound like a very promising fs, but btrfs has a hell of a head start. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755446/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 23:29 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/755447/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
By now btrfs' head start is probably a negative. It's been around for 10 years and is still not quite ready for the prime-time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755448"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 23:51 UTC (Wed)
                               by <b>rahvin</b> (guest, #16953)
                              [<a href="/Articles/755448/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are a lot of people using it day to day including myself. <br>
<p>
btrfs gets a bad rap for reasons I don't quite understand. All these new filesystems end up with tons of corner cases once they get broad deployment, btrfs was moving pretty fast until it got pushed out of beta then it slowed down as they spent and continue to spend tons of time fixing all these corner/edge cases. Although I'd argue significant prior available resources were pulled away when Oracle bought Sun as they were a prime backer. <br>
<p>
Personally I'll be surprised if bcachefs doesn't run into the same long tail of corner cases once it's mainlined. I remember reading something saying it takes at least 10 years after a filesystem is mainlined before they deal with all these issues, after all it was pretty much 10 years after XFS was brought in before it really got stable. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755448/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 1:21 UTC (Thu)
                               by <b>simcop2387</b> (subscriber, #101710)
                              [<a href="/Articles/755452/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think a lot of the bad rap came not from the btrfs developers themselves, but a few distros that started supporting it in production a bit too early.  This caused a number of people to start using it and then experience those corner cases.  It got a lot of testing but left a bad taste in people's mouths.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755480"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 10:30 UTC (Thu)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/755480/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Corner cases" my right foot.  The reason for the bad taste is that btrfs would completely eat itself even when using supposedly stable/fully-supported configurations on stable hardware.<br>
<p>
I've had two [might-as-well-be-]total filesystem losses with btrfs, both after clean shutdown/reboot cycles on lightly-loaded, battery-backed hardware that hasn't so much as hiccupped before or since.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755480/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 15:54 UTC (Fri)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/755672/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are two major times my personal Linux boxes ate my data...<br>
<p>
1st time was when my cat yanked out a PCI card that wasn't screwed in. Corrupted xfs metadata, had to sort through tens of thousands of files in the recovery bin. <br>
<p>
2nd time was while using btrfs. <br>
<p>
There was also a couple times while using btrfs on external storage device I expanded it wedged itself into a corner. Ran out of inodes or something like that.  It was a long time ago. Didn't lose data, but the file system was effectively rendered worthless and needed to be rebuilt. <br>
<p>
Now these things are all partially my fault, but I have used Linux on garbage-level (sometimes literally) hardware for years and it's been proven to be tough. <br>
<p>
<p>
I am looking forward to bcachefs getting support from various distro installers. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755491"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 13:11 UTC (Thu)
                               by <b>dcg</b> (subscriber, #9198)
                              [<a href="/Articles/755491/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think being unstable was really that much of a problem at first; people expected btrfs to be unstable anyway. The problem is that it kept being unstable because there weren't developers that would focus on fixing that. There were developers that worked on adding features (often not cleanly, eg qgroups were very unstable and still today they impact performance so much that people recommends not using them unless it's necessary), but the core was left unattended. Which is the reason why, still today and after so many years, btrfs does not have clean, ZFS-class RAID5/6 support, or integrated encryption. The lack of improvement in some key fields seem to be making people feel that btrfs is stagnating, and who would blame them? It is in fact one of the motivations behind bcachefs.<br>
<p>
As someone who has been using btrfs for many years without problems I also feel that btrfs is not appreciated enough (and that bcachefs is over-hyped - Overstreet has criticized btrfs for its stability, but I have seen several cases of people having corruption issues in the bcachefs IRC channel). But I wonder how much can that last if btrfs keeps not progressing in basic features like RAID5/6?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755491/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 6:14 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/755459/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A show-stopping bug in BTRFS RAIDs was discovered only _last_ _year_, after BTRFS had been marked as production-ready for at least a couple of years.<br>
<p>
From my experience, I'm using BTRFS on my personal external RAID tower. It got corrupted every single time I tried its multi-device support. Mostly because of botched RAID rebuilds after power failures or disk replacements. <br>
<p>
I've got tired of this and switched to a good old MD-based RAID. I'm still using BTFS for snapshots, but there's no way in hell I'm going to touch its multi-device snapshot within the next 5 years or so.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755466"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 7:48 UTC (Thu)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/755466/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Have BTRFS developers ever claimed that it's RAID code is production-ready? AFAIK it was always maked red (== experimental, don't use yet) in their table.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755466/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755468"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 7:53 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/755468/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This page cheerfully says that it's OK: <a href="https://btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices#Current_status">https://btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_...</a> Back then this page also looked nice and cheerful: <a href="https://btrfs.wiki.kernel.org/index.php?title=RAID56&amp;oldid=30429">https://btrfs.wiki.kernel.org/index.php?title=RAID56&amp;...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755468/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755693"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 19:26 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/755693/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <p>Ok, I'll bite. You say that "back then" page looked nice and cheerful. Here's the <a href="https://btrfs.wiki.kernel.org/index.php?title=Status&action=history">full history</a>.

<p>When exactly RAID56 wasn't marked with red and word "Unstable"?

<p>When you are ignoring warnings written in red... bad things happen... that's just how life is it...
      
          <div class="CommentReplyButton">
            <form action="/Articles/755693/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 20:54 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/755701/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Write hole still exists" is a far cry from "will corrupt your data irrevocably on rebuild".<br>
<p>
Also, I wasn't aware of this page's existence. RAID56 search on Google gives another page that looked OK. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor756198"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2018 21:45 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/756198/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To be fair, fixing the write hole is tricky - in fact it seems to me that it is inherent and unavoidable in a simple raid 5 implementation.<br>
<p>
Even md raid has only just fixed it, with the addition of a journal (a feature that might still be experimental). The journal is intended primarily as an optimisation, flushing updates to SSD before saving them to the full raid on spinning rust. It fixes the write hole almost as a side-effect.<br>
<p>
(Note, understanding the journal is on my to-do list, I need to learn more about it before I can document it ... :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/756198/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor756337"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2018 17:52 UTC (Sat)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/756337/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except btrfs is copy on write - the raid5 hole exists because of doing updates in place on existing stripes, so why btrfs is doing it that way I have no idea.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/756337/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor755585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 21:50 UTC (Thu)
                               by <b>rahvin</b> (guest, #16953)
                              [<a href="/Articles/755585/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know it's had issues but it's this bad rap history that follows it around that I think does more reputation damage than the current code deserves. This is one of the reasons it bothers me so much that Redhat decided to devote resources to expanding feature to XFS instead of spending those resources stabilizing btrfs. Btrfs could be IMO the best filesystem Linux has ever had if we could get experienced filesystem developers working on it instead of everyone developing their own filesystem. Which is probably why Redhat's decision bothers me. <br>
<p>
It just seems like everyone wants to work on something new rather than try to fix what we've got. I get that, fixing bugs is hard and boring rather than developing something new and shiny. But that new and shiny is still going to take 10 years to stabilize just like every filesystem Linux has had. <br>
<p>
This is actually a question I'd like to see answered at one of these filesystem conventions, Why is it so hard to get experienced developers to work stabilizing the fs's we have rather than building new ones?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755592"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 22:51 UTC (Thu)
                               by <b>nivedita76</b> (guest, #121790)
                              [<a href="/Articles/755592/">Link</a>] 
      </p>
      
      </div>
      </summary>
      XFS is around 25 years old, and has been in Linux since the early 00's, not new and shiny. BTRFS is the "new and shiny" fs by comparison.

<a href="https://en.wikipedia.org/wiki/XFS#History">XFS history</a>


      
          <div class="CommentReplyButton">
            <form action="/Articles/755592/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor755463"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 7:18 UTC (Thu)
                               by <b>vadim</b> (subscriber, #35271)
                              [<a href="/Articles/755463/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Probably because BTRFS got merged too early and had serious gotchas for the cool features.<br>
<p>
Eg, the "raid1 volumes only mountable once RW if degraded" issue was there until very recently and is not the kind of thing one wants to deal with on a RAID setup.<br>
<p>
Compression until recently came with warnings.<br>
<p>
Compression is still quite half-assed on the UI side. Why can't I easily check how well a file is being compressed? Why do I have to 'defrag' to compress, on a SSD? I don't care if it's fragmented, I just want it compressed. There's no need to move already compressed data around.<br>
<p>
Snapshots are in theory very cool, but in practice easily cause horrible performance issues. Eg, I unwisely had installed snapper and allowed DNF to make a couple dozen snapshots of my filesystem. Cleaning that up took an entire day, on an SSD, with the first snapshots taking hours to remove and completely locking up the machine. I don't want to imagine how that would work on an HDD.<br>
<p>
Despite my best efforts so far I haven't figured out a way to do a btrfs scrub in such a way that it doesn't make the entire desktop lag, on a computer with a SSD.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755463/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 2:03 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/755602/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
One thing to point out about slow btrfs scrubs is that it depends on your IO scheduler. Use the standard CFQ or BFQ. If you use deadline or noop then of course the scrub is going to use up all the IO because nothing will stop it. <br>
<p>
It still causes some extra latency. On my email server I use multi-queue BFQ and I can feel a bit of extra delay when loading each IMAP message from it during a scrub, but I don't think it's that serious.<br>
<p>
And on my laptop with NVMe SSD the btrfs scrub is done in about 30 seconds, so it isn't a big deal there either. It reads and verifies at hundreds of megabytes per second.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor755449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2018 23:49 UTC (Wed)
                               by <b>EdwardConnolly</b> (guest, #123865)
                              [<a href="/Articles/755449/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Personally, until bcachefs catches up to Btrfs in regard to snapshots it's going to be a non-starter for me. That said, I'm excited to see another next generation filesystem in the works.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755457"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 6:00 UTC (Thu)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/755457/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Everyone needs something else from filesystems ;) I'm not interested in snapshots at all. The main thing btrfs has for me is checksuming and self-healing of bitrotten files (in raid1/10 deployments). That's the killer feature.<br>
Incidentally, my main setup is bcache+btrfs ( <a href="https://enotty.pipebreaker.pl/dżogstaff/2016.05.25-opcja2.svg">https://enotty.pipebreaker.pl/dżogstaff/2016.05.25-opcja2...</a> ) but it doesn't seem that bcachefs could be a feature-complete replacement.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755457/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755486"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 11:36 UTC (Thu)
                               by <b>mchouque</b> (subscriber, #62087)
                              [<a href="/Articles/755486/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One confusing thing about RAID1/10 in btrfs is that it's not really what you think it is.<br>
<p>
If you do RAID 1 on more than 2 devices (say n devices), btrfs only guarantees you have 2 copies of your data, not n.<br>
<a href="https://btrfs.wiki.kernel.org/index.php/FAQ#What_are_the_differences_among_MD-RAID_.2F_device_mapper_.2F_btrfs_raid.3F">https://btrfs.wiki.kernel.org/index.php/FAQ#What_are_the_...</a><br>
<p>
More over, you only read from one disk (IIRC I think they do load balancing with the PID or something like that so you really use RAID 1 / 10 for redundancy more than performance).<br>
<p>
When you loose a device in RAID1, you can mount the FS but only once... <a href="https://btrfs.wiki.kernel.org/index.php/Gotchas#raid1_volumes_only_mountable_once_RW_if_degraded">https://btrfs.wiki.kernel.org/index.php/Gotchas#raid1_vol...</a><br>
<p>
As for RAID10, it inherits the design features of RAID1. From the doc, it says "RAID-10 is built on top of these definitions. Every stripe is split across to exactly 2 RAID-1 sets and those RAID-1 sets are written to exactly 2 devices". The issue is you do not control on which devices your stripe is mirrored.<br>
<p>
So a double disk failure on a btrfs RAID10 is more likely to end up with data loss data than on a traditional RAID-10.<br>
<p>
There was a long discussion about that years ago: <a href="https://www.mail-archive.com/linux-btrfs@vger.kernel.org/msg40608.html">https://www.mail-archive.com/linux-btrfs@vger.kernel.org/...</a><br>
<p>
<font class="QuotedText">&gt;The example below is probably a pathological case - but here goes. Let's say in this 4-disk example that chunks are &gt;striped as d1,d2,d1,d2 where d1 is the first bit of data and d2 is the second:</font><br>
<font class="QuotedText">&gt;Chunk 1 might be striped across disks A,B,C,D d1,d2,d1,d2</font><br>
<font class="QuotedText">&gt;Chunk 2 might be striped across disks B,C,A,D d3,d4,d3,d4</font><br>
<font class="QuotedText">&gt;Chunk 3 might be striped across disks D,A,C,B d5,d6,d5,d6</font><br>
<font class="QuotedText">&gt;Chunk 4 might be striped across disks A,C,B,D d7,d8,d7,d8</font><br>
<font class="QuotedText">&gt;Chunk 5 might be striped across disks A,C,D,B d9,d10,d9,d10</font><br>
&gt;<br>
<font class="QuotedText">&gt;Lose any two disks and you have a 50% chance on *each* chunk to have lost that chunk. With traditional RAID10 you &gt;have a 50% chance of losing the array entirely. With btrfs, the more data you have stored, the chances get closer to 100% &gt;of losing *some* data in a 2-disk failure.</font><br>
&gt;<br>
<font class="QuotedText">&gt;In the above example, losing A and B means you lose d3, d6, and d7 (which ends up being 60% of all chunks).</font><br>
<font class="QuotedText">&gt;Losing A and C means you lose d1 (20% of all chunks).</font><br>
<font class="QuotedText">&gt;Losing A and D means you lose d9 (20% of all chunks).</font><br>
<font class="QuotedText">&gt;Losing B and C means you lose d10 (20% of all chunks).</font><br>
<font class="QuotedText">&gt;Losing B and D means you lose d2 (20% of all chunks).</font><br>
<font class="QuotedText">&gt;Losing C and D means you lose d4,d5, AND d8 (60% of all chunks)</font><br>
<p>
<font class="QuotedText">&gt;The above skewed example has an average of 40% of all chunks failed. As you add more data and randomise the &gt;allocation, this will approach 50% - BUT, the chances of losing *some* data is already clearly shown to be very close to &gt;100%.</font><br>
<p>
The bottom line is RAID1 or 10 as defined by btrfs is not what you think they are if you haven't read the fine prints...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755486/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor756199"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2018 21:50 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/756199/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
note that btrfs probably got this from mdraid.<br>
<p>
I won't say more than that mdraid-10 is NOT raid 1+0. Look it up if you can be bothered.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/756199/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor755478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bcache block interface ongoing support</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 10:09 UTC (Thu)
                               by <b>TimSmall</b> (guest, #96681)
                              [<a href="/Articles/755478/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I support various systems using ext4, XFS and btrfs on top of bcache.<br>
<p>
If continuing to support the existing block device interface is not favoured, then perhaps user space tools to allow users to migrate to dm-cache (which I understand got some performance fixes last year in 4.12) would be possible....<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755492"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bcache block interface ongoing support</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 12:30 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/755492/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That might be quite difficult because you can layer bcache at almost any point in the block hierarchy, and because its header is on the front, either rewriting of all data or careful movement of the layer above (LVM, partitions or whatever, which requires knowledge of that layer) is required. And then there are clever bastards like me with an LVM PV on bcache on md, and a VG layered across both bcached and non-bcached PVs, on two md arrays on the same physical disks, and lots of LVs underneath that... changing *that* to the one-lvm-cache-device-per-LV model used by dm-cache without screwing alignment completely or risking data loss seems likely to be terribly difficult.<br>
<p>
No, I fear the same rule applies to this as to any fs: people rely on it, so you can't rip it out or randomly change the data format -- though for non-writeback bcache volumes it is probably more practical to change the cache device format, you don't want to require changes to the backing device: even writeback bcaches probably just need to write all the data back and then freely change the cache device: it would be nice if this didn't require downtime for those of us with rootfses on bcache, too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755492/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755496"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bcache block interface ongoing support</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 12:54 UTC (Thu)
                               by <b>TimSmall</b> (guest, #96681)
                              [<a href="/Articles/755496/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was assuming that this would not involve the lvm tool set (or metadata etc.), but instead that a user space bcache-specific tool could be written to setup device mapper mappings to use dm-cache directly (within the constraints of dm-cache).  This would involve fully draining (write-back → write-through → nocache) and discarding the cache device contents - so that there's a way to end up with the same (cached) content without moving the entire contents of the backing store (but keeping the bcache metadata headers etc. on the backing store device).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755496/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor755546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bcache block interface ongoing support</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2018 14:53 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/755546/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thinking about it, you could do that in the dynamic state of the system with just a dm-linear that skips the start of the device. You'd definitely need something to get that set up though (with low enough requirements that it could run from an initramfs and link against musl etc). It would not exactly be entirely transparent, unless "bcache" remains as a block device that just does that and passes everything through, or that thunks to dm-cache for everything (now *that* would be neat, get any improvements with that layer without compatibility problems!).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor755600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bcache block interface ongoing support</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 0:11 UTC (Fri)
                               by <b>koverstreet</b> (subscriber, #4296)
                              [<a href="/Articles/755600/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
bcache is still getting maintained - and once bcachefs is upstreamed there are tentative plans for bringing back the old style bcache block device interface to provide an upgrade path for existing bcache users.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor755607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">bcache block interface ongoing support</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 6:50 UTC (Fri)
                               by <b>nilsmeyer</b> (guest, #122604)
                              [<a href="/Articles/755607/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suppose once this is mainlined most of those systems running bcache you're supporting would be phased out or re-installed. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor755608"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2018 6:52 UTC (Fri)
                               by <b>nilsmeyer</b> (guest, #122604)
                              [<a href="/Articles/755608/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Great effort by Kent, I've been following the project for quite a while (also as a Patreon supporter). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755608/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor755742"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2018 21:35 UTC (Sun)
                               by <b>meyert</b> (subscriber, #32097)
                              [<a href="/Articles/755742/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wait, wasn't bcache a cache that would enable an small SSD to act as cache for an bigger rotating disk?<br>
How did this turn into a filesystem? Could bcachefs still act as an SSD cache for a bigger spinning disk?<br>
What is the best solution nowadays to use a small SSD as an cache for an bigger spinning disk?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/755742/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor756200"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2018 21:59 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/756200/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  What is the best solution nowadays to use a small SSD as an cache for an bigger spinning disk?</font><br>
<p>
Use it as a journal for an md raid?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/756200/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor756292"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2018 23:11 UTC (Fri)
                               by <b>Pc5Y9sbv</b> (guest, #41328)
                              [<a href="/Articles/756292/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you use LVM, you can have an SSD-based PV and an HDD-based PV and then form a cached LV based on a small chunk of the SSD and a big chunk of the HDD. The terminology in LVM is to create a cached LV using a backing LV and a cache pool.<br>
<p>
You can enjoy the usual benefits of LVM to allocate portions of the SSD or HDD for different purposes, migrating LV content between backing devices, etc.  You might make an SSD-only filesystem as well as an SSD-cached filesystem with a larger HDD. You can also drop and add cache on an existing LV without having to reformat the backing filesystem, in case you change your mind about how much SSD to allocate for caching.<br>
<p>
I think the cache management commands can be done while a filesystem in the LV is online, but I actually haven't done that yet.  I've set up a write-back cached volume using 60GB of SSD for 2TB of nearline disk.  My system RAM provides enough buffer cache for reads, so this is mostly to give me a durable write buffer so my programs don't wait for the HDD to complete writes as often.<br>
<p>
I'm a little old-fashioned, so I do my RAID mirroring via mdraid and treat those as PVs for LVM.  So, I have an SSD mirror backing some small filesystems and cache pool, and an HDD mirror backing bulk filesystems with some cached and some uncached.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/756292/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor756324"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2018 13:34 UTC (Sat)
                               by <b>meyert</b> (subscriber, #32097)
                              [<a href="/Articles/756324/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cool, thanks for the pointers!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/756324/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor757707"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">An update on bcachefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 18, 2018 12:40 UTC (Mon)
                               by <b>poelzi</b> (guest, #14953)
                              [<a href="/Articles/757707/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; bcache-stats</font><br>
--- bcache ---<br>
Device                      /dev/dm-3 (254:3)<br>
UUID                        ec13b555-309c-4c03-a34f-10ffbe9d51d2<br>
Block Size                  0.50KiB<br>
Bucket Size                 2.00MiB<br>
Congested?                  False<br>
Read Congestion             2.0ms<br>
Write Congestion            20.0ms<br>
Total Cache Size            80.00GiB<br>
Total Cache Used            80.00GiB    (100%)<br>
Total Cache Unused          0B  (0%)<br>
Dirty Data                  0B  (0%)<br>
Evictable Cache             80.00GiB    (100%)<br>
Replacement Policy          [lru] fifo random<br>
Cache Mode                  writethrough [writeback] writearound none<br>
Total Hits                  9573        (67%)<br>
Total Misses                4685                                                                                                                                                                                   <br>
Total Bypass Hits           3422        (15%)                                                                                                                                                                      <br>
Total Bypass Misses         18947                                                                                                                                                                                  <br>
Total Bypassed              2.70GiB <br>
<p>
<p>
bcache works like charm (rebooted yesterday, usually I have ~80% hit rate ...). It caches my 2TB media hdd on my notebook trough a 80gb SSD partition. I also use it on my home server to cache /home.<br>
I'm looking forward to bcachefs as I'm quite disappointed by btrfs and zfs.<br>
Bcache + ext4 still has proven the most stable and pleasantly fast solution so far, thank you very much for this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/757707/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
