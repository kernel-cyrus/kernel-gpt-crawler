        <!DOCTYPE html>
        <html lang="en">
        <head><title>Preventing information leaks from ext4 filesystems [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/854054/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/853955/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/854054/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Preventing information leaks from ext4 filesystems</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 27, 2021</br>
           </div>
A filesystem's role is to store information and retrieve it in its original
form on request.  But filesystems are also expected to prevent the
retrieval of information by people who should not see it.  That requirement
extends to data that has been deleted; users expect that data to be truly
gone and will not welcome its reappearance in surprising places.  Some work
being done with ext4 shows the kind of measures that are required to live
up to that expectation.
<p>
In early April, Leah Rumancik posted <a
href="/ml/linux-ext4/20210407154202.1527941-1-leah.rumancik@gmail.com/">a
two-patch series</a> making a couple of small changes to the ext4
filesystem implementation.  The first
of those caused the filesystem to, after a file is deleted, overwrite the
space (on disk) where that
file's name was stored.  In response to a question
about why this was needed, ext4 maintainer Ted Ts'o <a
href="/ml/linux-ext4/YG59GE+8bhtVLOQr@mit.edu/">explained</a> that it was
meant to deal with the case where users were storing personally identifiable
information (PII) in the names of files.  When a file of that nature is
removed, the user would like to be sure that the PII is no longer stored on
the disk; that means wiping out the file names as well.
<p>
Dave Chinner quickly <a
href="/ml/linux-ext4/20210408052155.GK1990290@dread.disaster.area/">objected</a>
to this explanation.  The real problem, he argued, is that users are
storing PII as 
clear text; wiping directory entries is not a real solution to that
problem:
<p>
<blockquote class="bq">
	This sounds more and more like "Don't encode PII in clear text
	anywhere" is a best practice that should be enforced with a big
	hammer. Filenames get everywhere and there's no easy way to prevent
	that because path lookups can be done by anyone in the kernel. This
	so much sounds like you're starting a game of whack-a-mole that can
	never be won.
<p>
	From a security perspective, this is just bad design. Storing PII
	in clear text filenames pretty much guarantees that the PII will
	leak because it can't be scrubbed/contained within application
	controlled boundaries. Trying to contain the spread of filenames
	within random kernel subsystems sounds like a fool's errand to me,
	especially given how few kernel developers will even know that
	filenames are considered sensitive information from a security
	perspective...
</blockquote>
<p>
The problem with that approach, as Ts'o <a
href="/ml/linux-ext4/YG9YqkHfslwAdh2%2F@mit.edu/">explained</a>, is that
the people involved may not even know what their "<q>legacy
workloads</q>" are doing in this regard.  Rather than risk the
possibility of exposing PII that nobody even knew was there, he said, it is
better to simply clear the file names.
<p>
Of course, if a file's name constitutes PII, its contents are likely to be
interesting as well.  It is possible, though expensive, to overwrite the
data in files when they are deleted.  An alternative, on modern storage
devices at least, is to use the <a href="/Articles/417809/"><tt>FITRIM</tt>
<tt>ioctl()</tt> command</a> to tell the drive to discard the data.  Even
if this operation does not physically erase that data, it should make the
data inaccessible afterward.  For this reason (and others), administrators
who are concerned about the persistence of deleted data tend to arrange for
<tt>FITRIM</tt> operations to be run regularly.
<p>
There is one little remaining issue, though, for the truly paranoid.  Ext4,
like many contemporary filesystems, uses journaling to ensure that the
filesystem remains consistent even if the system is interrupted at an
inopportune time.  To implement that sort of robustness, metadata written
to ext4 filesystems is also written to 
the journal (and file data can optionally be written there too), so the
possibility exists that the journal will contain PII even after all traces
of it have been removed from the rest of the filesystem.  A bad actor who
gains access to the disk could harvest that data from the journal, even
though it had already been deleted from the filesystem.
<p>
To address this problem, Rumancik's second patch adds a new
<tt>ioctl()</tt> command, called <tt>FS_IOC_CHKPT_JRNL</tt>, that forces
the journal to be flushed out to persistent storage.  There is an optional
flag, <tt>CHKPT_JRNL_DISCARD</tt>, which causes the filesystem to run the
equivalent of a <tt>FITRIM</tt> operation on the journal itself once the
flush is complete.  That ensures that no PII remains in the journal itself.
<p>
Chinner (in the same email linked above) suggested that this behavior
should be an option on the <tt>FITRIM</tt> operation rather than a separate
command â€” before noting that <tt>FITRIM</tt> has no "flags" field and,
thus, cannot be extended.  Perhaps, he suggested, it is time for a separate
<tt>fstrim()</tt> system call that could also trim the journal on request.
A separate system call would also, by default, make the functionality
available to all filesystems rather than being an ext4-specific feature.
<p>
The two patches together are intended to help administrators ensure that
data that has been deleted from a filesystem truly disappears.
It looks like they will be taking separate paths into the kernel from here,
though.  Rumancik recently posted <a
href="/ml/linux-ext4/20210422180834.2242353-1-leah.rumancik@gmail.com/">a
new version of the file-name overwrite patch</a> on its own, and Ts'o
subsequently <a href="/ml/linux-ext4/YIHknqxngB1sUdie@mit.edu/">applied
it</a>.  The journal side of the problem, Ts'o <a
href="/ml/linux-ext4/YIHVWySvaECveV4l@mit.edu/">said</a>, is going to
require some more discussion.  Eventually, though, one can expect solutions
to both problems to find their way into the kernel.  That will help prevent
the accidental disclosure of sensitive information from ext4 filesystems,
even if the user is storing it in ill-advised ways.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ext4">Filesystems/ext4</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Information_leak">Information leak</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/854054/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor854630"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 16:23 UTC (Tue)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/854630/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This sounds like it would be better solved by marking the containing dir as having encrypted contents, and then just encrypting the file names (in addition to the file contents). <br>
<p>
That would let also protect the file contents, and it would clearly mark the data as &#x27;to-be-scrubbed&#x27;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854630/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854673"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 22:18 UTC (Tue)
                               by <b>dcg</b> (subscriber, #9198)
                              [<a href="/Articles/854673/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is what APFS (Apple&#x27;s new file system) does. I don&#x27;t remember the details well, but IIRC there is a per-subvolume key that is used to encrypt the data in that volume (there are other cryptographic features whose keys are mixed with this one in some way, I think) . The key is kept in some special metadata block, and the act of deleting all the data securely consists in simply erasing that key - no need to overwrite all the blocks.<br>
<p>
This method potentially be implemented in a per-file basis, but the metadata overhead would be too much, I guess.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854673/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor855564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 6, 2021 7:40 UTC (Thu)
                               by <b>bluss</b> (subscriber, #47454)
                              [<a href="/Articles/855564/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
for fsck and repair, I hope they have some copies of that key or the superblock, so that you can&#x27;t lose the whole disk in one bit flip?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/855564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor854684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 0:10 UTC (Wed)
                               by <b>jlayton</b> (subscriber, #31672)
                              [<a href="/Articles/854684/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is actually available on ext4 as well via fscrypt, and I&#x27;m surprised no one has suggested it. Surely the truly paranoid should use fscrypt (or maybe LUKS if that&#x27;s an option).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854689"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 0:42 UTC (Wed)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854689/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It was suggested, and the reason why encryption is not always the bests answer was described both on the ext4 mailing list, as well as further down in the comment for this article.<br>
<p>
The short version is, where and how to you store the encryption key, especially for a cloud VM, which is the target use case for this feature?     Ext4 encryption, which was later generalized to fscrypt, is designed to protect against off-line attacks, such as the &quot;evil hotel maid&quot; attack where you leave your mobile handset in the hotel room and someone carries out an off-line attack against the storage attack.   The use case for zero&#x27;ing out the directory entry when it is unlinked is to make sure any sensitive information is removed the moment it is no longer necessary.  This is more of an on-line property.<br>
<p>
The tradeoff is that you can no longer as easily use debugfs&#x27;s &quot;lsdel&quot; command to find deleted directory entries.   On the other hand, because of how ext3 handles truncates, we&#x27;ve made finding the data blocks of deleted inodes impractical for decades, and no one has really complained (see the ext4 mailing list for all of the details).    So if you can no longer find the data blocks easily, is finding the inode number from a deleted directory entry all that important?    For modern file systems, &quot;rm is forever&quot; and the solution for accidental deletion of files is to refer to your backups.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854689/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854708"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 9:48 UTC (Wed)
                               by <b>dullfire</b> (guest, #111432)
                              [<a href="/Articles/854708/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The short version is, where and how to you store the encryption key, especially for a cloud VM, which is the target use case for this feature?</font><br>
<p>
So just going to stop right here to point out: If you are attempting to prevent the machine owners from getting PII because you stuck it, in the clear, in a file name, you are screwed so many ways that it doesnt really matter how the fs scrubs the file name. (backups, the vm&#x27;s virtual HD uses any sort of remapping, the list could go on an on).<br>
<p>
If someone really wants to do this: the only sane thing is to encrypt it, and stuff the key in the inode itself (after all it&#x27;s not really secret to the system.... your kernel will always know what files its direct child processes are accessing).  Obviously if keys to be deleted they are always scrub... because it&#x27;s a key.<br>
<p>
Basically don&#x27;t store PII in a clear fs that anyone can access. It&#x27;s a terrible idea. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854708/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854709"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 9:53 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/854709/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  So just going to stop right here to point out: If you are attempting to prevent the machine owners from getting PII because you stuck it, in the clear, in a file name, you are screwed so many ways that it doesnt really matter how the fs scrubs the file name. (backups, the vm&#x27;s virtual HD uses any sort of remapping, the list could go on an on).</font><br>
The problem is not hiding the PII from the machine&#x27;s owner, but making sure it&#x27;s truly deleted when the user requests that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854709/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 11:43 UTC (Wed)
                               by <b>lsl</b> (subscriber, #86508)
                              [<a href="/Articles/854714/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does overwriting file names actually accomplish that, though? That depends on the cloud&#x27;s block storage implementation.<br>
<p>
In other words, this feature&#x27;s usefulness is to the cloud operator who&#x27;s in a position to assess the effect this overwriting has on the actual stored data.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 11:47 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/854715/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Does overwriting file names actually accomplish that, though? </font><br>
It&#x27;s a part of the overall puzzle.<br>
<p>
For data block cleanup, TRIM is supposed to make the data inaccessible (except maybe through a very thorough forensic scan). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 11:13 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854841/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; &gt; Does overwriting file names actually accomplish that, though?</font><br>
<p>
<font class="QuotedText">&gt; It&#x27;s a part of the overall puzzle.</font><br>
<p>
Yup. What everybody seems to be missing is that ext* is saying &quot;I&#x27;ve done my bit, it&#x27;s not my problem any more&quot;.<br>
<p>
Ext can&#x27;t provide guarantees ELSEWHERE in the stack, but it can provide its own guarantees, which is the intent here. It&#x27;s not passing the buck, it&#x27;s taking responsibility for what it can. If others shirk their responsibility, it&#x27;s not ext&#x27;s problem.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor855812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2021 3:15 UTC (Sat)
                               by <b>SomeOtherGuy</b> (guest, #151918)
                              [<a href="/Articles/855812/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Encryption on a directory-per-directory or file-by-file basis is not that good, but as pretty much every CPU (for us x86-64 users anyway) has AES (cat /proc/cpuinfo | grep aes) we&#x27;re good, IIRC the Sandy Bridge i3&#x27;s didn&#x27;t have it, Skylake i3s do, not sure about the middle<br>
<p>
There&#x27;s really no reason not to use it, but even then we should write random crap to the drive first (but this hurts SSDs) most of us probably dont and this means sectors filled with 0s leaks &quot;there&#x27;s no data here&quot;, an attacker that can image the drive even if you write random crap first can see where sectors are changing at least<br>
<p>
This has its own problems like watermarking attacks but that was a thing that was solved in the 2.63 or even older kernels, however it can still leak some information<br>
<p>
File names, I&#x27;ve gotta say, with directory names and that should not be &quot;scrubbed&quot; - I&#x27;m not even sure we over-write the data (I don&#x27;t think we do?) - but obviously if a file is allocated a range that should be 0ed or otherwise not-actually-read by the file until it writes there.<br>
<p>
TheTimeIDidTheCrime.txt - if that sensitive should be on an encrypted drive<br>
<p>
A netbook of mine was once stolen (good riddance, hated that fad and the tiny keyboard and the Atom CPU) - full disk encryption means I get to write about it with a smile not worrying about whatever was on there being a problem for me (not to sound dodgy but you see what I mean)<br>
<p>
If we did do this, symlinks may also need protecting, or NFS/sshfs type deals, it&#x27;d be bad <br>
<p>
So I doubt encryption-in-the-fs would be safe anyway it&#x27;d certainly complicate things (see the watermarking attack I mentioned) - I really like our block device solution of LUKS and the like letting ext4 operate on /dev/mapper/whatever as if it were a drive<br>
<p>
We also can pass through trim and stuff like that (at the cost of the drive now contains zeros) - but it helps our SSDs.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/855812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor854634"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 17:35 UTC (Tue)
                               by <b>dxin</b> (guest, #136611)
                              [<a href="/Articles/854634/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This together with case-insensitive file names and other legacy-oriented anti-feature is making ext4 more and more complex and at the same time, less interesting.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854634/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 21:33 UTC (Tue)
                               by <b>ddevault</b> (subscriber, #99589)
                              [<a href="/Articles/854664/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Full agreement regarding case insensitivity. But this is a case that I&#x27;d like to see addressed, as a service operator. I am obligated by law to ensure that personal information is deleted properly, and having better tools to be sure of this is a welcome change. Aye, data should be encrypted - but the most secure data is data that you don&#x27;t have.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854696"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 6:45 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/854696/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A case-insensitive file system is very helpful for cross-compiling Windows code on Linux. Include statements in that code often contains wrong case, like include &lt;windows.h&gt; where it should be Windows.h. <br>
<p>
Now, one can fix it with various workarounds like using symlinks for all case variations used in code but I am glad that I do not need to do that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854696/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854698"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 7:05 UTC (Wed)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/854698/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Applying case-insensitive semantics to a filesystem for use-cases like this seems like something that should be part of a separate layer on top of existing filesystems similar to bindfs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854698/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854950"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 22:54 UTC (Thu)
                               by <b>sandsmark</b> (guest, #62172)
                              [<a href="/Articles/854950/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn&#x27;t winegcc etc. already do this?<br>
<p>
And last time I had to clean up this kind of mess, &quot;automatically&quot; letting it handle case-insensitivity would have broken things, since the first include in the checked paths wasn&#x27;t always the right one if you checked case insensitively.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854950/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor854636"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 17:46 UTC (Tue)
                               by <b>ikm</b> (guest, #493)
                              [<a href="/Articles/854636/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This seems wrong on so many levels. Why is this specifically about PII? There&#x27;s no shortage of other sensitive types of information that can be stored. Why is this ext4-specific? Other filesystems would happily leak the same information. Instead of trying to scrub the data from all the places where it could possibly linger, why not just store it encrypted? Looks like someone is trying to solve a specific problem of their own in the wrong place. I for one certainly don&#x27;t want to always spend resources scrubbing file names when files are deleted - on a CI server, for instance, it would be a colossal waste.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854636/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854655"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 20:01 UTC (Tue)
                               by <b>SLi</b> (subscriber, #53131)
                              [<a href="/Articles/854655/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How do you ensure you lose the ability to decrypt it without wiping it and without losing the ability to decrypt names of files that haven&#x27;t been deleted?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854655/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854653"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 20:12 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/854653/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Why is this specifically about PII? There&#x27;s no shortage of other sensitive types of information that can be stored.</font><br>
<p>
1. PII is subject to GDPR and other laws and regulations. While other types of information are also subject to such regulation, GDPR is explicitly a *general* regulation that applies to all businesses that transact in PII (in practice, most of them).<br>
2. Lots of things are PII despite seemingly not being &quot;sensitive&quot; - GDPR uses a rather generous interpretation which includes basically anything connected to a specific, identifiable individual, such as an IP address.<br>
3. If a file pertains to a specific individual, it is difficult to imagine a scheme in which a name could be assigned to that file without that name becoming PII itself. Even a randomly-generated opaque identifier is generally considered PII if it is linked to a specific individual.<br>
4. Encrypted filenames must still be unique, and are therefore still unique identifiers and might still be subject to GDPR (depending on which lawyers you ask).<br>
<p>
As a result, PII is a pervasive and highly common type of sensitive information that can easily find itself in metadata or other ancillary storage, which might not have the same level of protection as the underlying data. It is also very difficult to handle from &quot;inside the system,&quot; because of point (4).<br>
<p>
<font class="QuotedText">&gt; Why is this ext4-specific? Other filesystems would happily leak the same information.</font><br>
<p>
Because everyone uses ext4. But fixing other filesystems is probably a good idea, too.<br>
<p>
<font class="QuotedText">&gt; Instead of trying to scrub the data from all the places where it could possibly linger, why not just store it encrypted?</font><br>
<p>
Full-disk encryption is probably a good idea. But it has the problem of being imprecise; it may be desirable to hand out privileges in a finer-grained manner than &quot;either you can read the whole disk, or you can&#x27;t.&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854653/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854662"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 21:39 UTC (Tue)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854662/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
First of all, encryption is not free.   There is real cost in encrypting file names, and the encryption key needs to be available when the file system is mounted.   Where are you going to store the key?  In /etc/fstab as a mount option?   How do you prevent an attacker from gaining access to it?<br>
<p>
Secondly, the cost of zero&#x27;ing the directory entry is negligible compared to the cost of writing the directory block to disk, which we have to do anyway.   Even with the fastest SSD, writing zeroes to memory is going to be super-small in comparson.    Main memory access is order ~100 nanoseconds.   SSD access is order ~150 microseconds.   So we&#x27;re talking 2 or 3 orders of magnitude.<br>
<p>
This is why we&#x27;re not gating this on a mount option.  It&#x27;s just not worth it, because it would be a mount option we would have to support forever, compared to the overhead of zeroing directory entries which won&#x27;t be measurable in benchmarks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854662/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor854638"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 17:57 UTC (Tue)
                               by <b>re:fi.64</b> (subscriber, #132628)
                              [<a href="/Articles/854638/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This seems like a terrible default, at least it can be flipped off I guess...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854638/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 18:04 UTC (Tue)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/854637/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This seems like a rather fragile solution, especially when using a SSD, where discard operations are usually (nearly always?) best-effort with respect to the content of the actual backing flash chips.<br>
<p>
It&#x27;s rather surprising to see this feature in ext4 specifically as this filesystem is one of the very few that support filesystem-level encryption.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854668"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 21:55 UTC (Tue)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854668/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Geting deleted information from an SSD requires physical access to the storage device or the ability to somehow install evil firmware into the device.  Neither attack is particularly trivial, compared to being able to send read requests using standard SATA/SCSI/NVMe requests from the host OS.<br>
<p>
On virtual machines in Cloud Platforms such as Google&#x27;s GCP, Amazon&#x27;s AWS, Microsoft&#x27;s Azure, etc. you don&#x27;t get access to the raw block devices; most of these hyperscale cloud providers don&#x27;t SSD&#x27;s and HDD&#x27;s leave the data center except in tiny pieces[1].    So for that use case, zero&#x27;ing the directory entries is quite sufficient and robuest in terms of protecting them against information leaks.<br>
<p>
[1] <a href="https://youtu.be/kd33UVZhnAA?t=291">https://youtu.be/kd33UVZhnAA?t=291</a><br>
<p>
(And, no, companies shouldn&#x27;t be using social security numbers as filenames.... but enterprise customers do the darnedest things.  And even if they don&#x27;t, it&#x27;s a lot easier for them to tell their compliance auditors that they are using file systems that protect them even if they _do_ have some legacy software somewhere in their enterprise software stack that might be doing something stupid....)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854668/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor854640"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 18:10 UTC (Tue)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/854640/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hope that this can be turned off.  For a machine that is internal to a company, there&#x27;s no reason to waste any cycles making file deletion more expensive.  The disk can be scrubbed when it is disposed of.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854640/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854644"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 19:13 UTC (Tue)
                               by <b>james</b> (subscriber, #1325)
                              [<a href="/Articles/854644/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Depends on your legal system and regulatory framework: <a href="https://ec.europa.eu/info/law/law-topic/data-protection/reform/rules-business-and-organisations/principles-gdpr/how-long-can-data-be-kept-and-it-necessary-update-it_en">GDPR</a> says "Data must be stored for the shortest time possible.".
<p>
Having said that, insisting that deleted data is then scrubbed would be a very exacting interpretation of a law that's widely ignored. Other regulatory regimes might be actually enforced.
      
          <div class="CommentReplyButton">
            <form action="/Articles/854644/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854661"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 21:37 UTC (Tue)
                               by <b>JoeBuck</b> (subscriber, #2330)
                              [<a href="/Articles/854661/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The file names I&#x27;m thinking of are mainly randomly generated temporary file names, in very large numbers, that do not refer to people but that are used to distribute jobs over a compute grid.  In cases where data protection laws are relevant, the filesystem code is the wrong level of abstraction to handle the problem, and if there&#x27;s an issue, zeroing out the filename but leaving the deleted data on disk won&#x27;t do.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854661/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854707"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 9:04 UTC (Wed)
                               by <b>james</b> (subscriber, #1325)
                              [<a href="/Articles/854707/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Fascinating to see the use-cases people come up with.<p>
You can come up with whatever naming standards you want for inside an organisation, but if you're receiving documents about people from partner organisations (for example, over HTTPS or email) that's going to be handled by users using conventional desktop programs, the filesystem is what you have to work with.
<p>
Also, encryption doesn't help when the regulation insists <em>you</em> can't get the data back -- not without some complicated key rotation scheme (read: likely to cause problems). (And the fine article handles the case of deleting file data.)
      
          <div class="CommentReplyButton">
            <form action="/Articles/854707/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor854639"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 18:14 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854639/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; To address this problem, Rumancik&#x27;s second patch adds a new ioctl() command, called FS_IOC_CHKPT_JRNL, that forces the journal to be flushed out to persistent storage.</font><br>
<p>
As someone interested in this stuff ... this feels just so wrong to me that it hasn&#x27;t been implemented before! How many filesystems don&#x27;t flush the journal even on shutdown? How much stuff can you have in the journal that hasn&#x27;t been flushed to &quot;permanent storage&quot;? And if you so have a serious problem, how much grief will it cause you if you have to not only hexedit the filesystem to recover, but to hexedit the journal on top!<br>
<p>
There seems to be (I may be wrong) this assumption that &quot;once it&#x27;s flushed to journal it&#x27;s safe&quot;. It&#x27;s almost as if they think that you could store the entire filesystem in the journal without actually ever flushing anything to permanent storage!<br>
<p>
Ntfs, XFS, how many others? all seem to require you to &quot;rerun the journal&quot; on boot to get a working filesystem, even after a clean shutdown!?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854639/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854642"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 18:53 UTC (Tue)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/854642/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;It&#x27;s almost as if they think that you could store the entire filesystem in the journal without actually ever flushing anything to permanent storage!</font><br>
<p>
Sure, that&#x27;s a completely valid approach to a filesystem: <a href="https://en.wikipedia.org/wiki/Log-structured_file_system">https://en.wikipedia.org/wiki/Log-structured_file_system</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854642/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854842"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 11:15 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854842/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No problem with that, if the *user* asks for a filesystem like that. It&#x27;s when the journal is a half-way stage that breaks guarantees the user thought they had.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854842/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor854665"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 21:35 UTC (Tue)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/854665/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Journals are flushed to permanent storage all the time.  Journals are assumed to be permanent in general.  I think - I would love to be corrected here, though - this is more about windows where the journal has not been committed yet.<br>
<p>
Iâ€™m a little confused about the framing of this all together, to be honest.  If the journal isnâ€™t going to permanent storage what is it even *for*?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854665/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854666"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 21:41 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/854666/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      My phrasing was a bit sloppy there, sorry.
<p>
What was meant by "flushing the journal" was "playing the journal out to the filesystem proper".  Yes, the journal is written to persistent storage before any other filesystem metadata changes are made.  Once the data is in the journal, though, finishing the job becomes less important - the data is saved and won't be lost.  The new <tt>ioctl()</tt> forces the journal to be reflected in the filesystem metadata, then optionally does <tt>FITRIM</tt> to clear the data from the journal.
      
          <div class="CommentReplyButton">
            <form action="/Articles/854666/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854669"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 22:05 UTC (Tue)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854669/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If we want to be super nit-picky, what we are doing is &quot;checkpointing the journal&quot;.   This means assuring that everything is written to the final location on disk, so that it is no longer necessary to replay the journal after a crash.    We checkpoint the journal when we freeze a file system before taking a snapshot, and as the last step before unmounting the file system.<br>
<p>
It&#x27;s not really a case of replaying the journal, because we don&#x27;t actually read the data back from the journal.   The dirty blocks (dirty because they haven&#x27;t been written to the disk yet) are still in the buffer cache, so we are writing the contents of those blocks from the buffer cache.   Once all of the dirty metadata blocks are written out, then it is safe to truncate the journal, as the journal is no longer needed any more.<br>
<p>
After a crash, or an unplanned power cycle, that&#x27;s when we replay the journal.  In that case, we are reading the contents of the blocks from the journal, and then writing them back to their correct locations in the file system.  Since we are reading from the journal, that&#x27;s why we are calling it &quot;playback&quot; or &quot;replay&quot;.<br>
<p>
Why yes, file system developers are sometimes really anal-retentive.  Why do you ask?  :-)<br>
 <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854669/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854674"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 22:25 UTC (Tue)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/854674/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks (both) for the clarification, that&#x27;s roughly what I figured but it&#x27;s nice to have that clarified and detailed.<br>
<p>
&quot;Why yes, file system developers are sometimes really anal-retentive. Why do you ask? :-)&quot;<br>
Speaking as one, I have no idea. ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854674/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 3:20 UTC (Thu)
                               by <b>dgc</b> (subscriber, #6611)
                              [<a href="/Articles/854820/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If we want to be super nit-picky, what we are doing is &quot;checkpointing the journal&quot;.</font><br>
<p>
If we want to be super nit-picky, this is what *ext4 developers* call &quot;checkpointing the journal&quot;. :/<br>
<p>
In XFS, a &quot;journal checkpoint&quot; is what we write to the journal (XFS_TRANS_CHECKPOINT) and recover from the journal during replay. What you&#x27;ve defined as &quot;checkpointing the journal&quot; is called &quot;quiescing the log&quot; in XFS. See xfs_log_quiesce() for details.<br>
<p>
And, if we are really going to pick nits, what does &quot;checkpoint the journal&quot; mean to a filesystem with copy-on-write metadata and no journal? <br>
<p>
-Dave.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854827"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 3:48 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854827/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s not just ext4 developers.   It&#x27;s also the terminology used by SQLite and Postgres when using write-ahead logging:<br>
<p>
&quot;Of course, one wants to eventually transfer all the transactions that are appended in the WAL file back into the original database. Moving the WAL file transactions back into the database is called a &quot;checkpoint&quot; -- <a href="https://sqlite.org/wal.html">https://sqlite.org/wal.html</a><br>
<p>
&quot;Put simply, a checkpoint is a point in the transaction sequence at which all data files (where tables and indexes reside) are guaranteed to be written and flushed to disk to reflect the data modified in memory by regular operation. All those changes have previously been written and flushed to WAL.&quot;  <a href="https://www.commandprompt.com/blog/the_write_ahead_log/">https://www.commandprompt.com/blog/the_write_ahead_log/</a><br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854827/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854843"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 11:23 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854843/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So to use tytso&#x27;s terminology, between the file i/o layer, and the file system checkpointing the journal, A MIRRORED FILE SYSTEM IS IN DANGER. That&#x27;s what I was getting at - I get the impression (maybe I&#x27;m wrong, because of all the confusing terminology thrown around like Humpty Dumpty) that some filesystems can take absolutely ages to run their checkpoint.<br>
<p>
If I&#x27;ve got a couple of hour&#x27;s data waiting to be checkpointed, I would be well pissed off if the journal drive died and I discovered that work from a long time ago hadn&#x27;t made it to the mirror ...<br>
<p>
I appreciate it&#x27;s not easy, but users expect every layer to complete in the shortest time practical, not hang around on a &quot;why bother rushing&quot; basis.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854843/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 17:28 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854914/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Um, no.  There&#x27;s no danger.   While we are checkpointing, we are forcing the dirty metadata blocks to be written to the file system.   Only *after* all of the dirty metadata blocks are written, do we truncate the journal. <br>
<p>
In general, file systems should not take ages to checkpoint a transaction.   On average, we will force a journal commit every 5 seconds (or perhaps sooner if fsync is called).    As part of the commit processing, once the commit block is written, all of the metadata buffers will be marked dirty, and 30 seconds later, the normal buffer cache writeback will start.   Hence in practice, the only writes that we need to do when doing a full checkpoint are the metadata blocks that were touched in the last 30 seconds, plus any pending writeback.<br>
<p>
Also, normally, we don&#x27;t actually try to checkpoint all completed transactions.   If we checkpoint a transaction that completed, say, 50 seconds ago, and all of its dirty buffers have been writen back (or taken over by a newer transaction), then we don&#x27;t need to do any I/O before we declare, &quot;yep, this transaction is no longer needs to be kept in the journal; we can reuse that space for newer transactions&quot;.    So normally, we just try to checkpoint all old transactions without needing to do any I/O, and we can move the tail of the journal without needing to do any synchronous I/O.  <br>
<p>
Now, if the journal is too small, or the block device is too slow, it&#x27;s possible that this will not free enough space in the journal for newer transactions.   In that case, we will need to do a synchronous checkpoint where we actually force the buffers to be written back so we can free space in the journal.    While this is happening, file system mutations are blocked, so this is terrible for file system performance.    Fortunately, this rarely happens, and in modern versions of mke2fs, we create file systems with larger journals to prevent this from happening.<br>
<p>
The only time we need to do a full, synchronous checkpoint, to completely empty the journal, is when we unmount the file system, or if we are trying to freeze the file system in order to take a snapshot.    But even then, it&#x27;s perfectly safe, because we don&#x27;t actually truncate the journal until the metadata writeback is complete.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2021 0:30 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854957/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Hence in practice, the only writes that we need to do when doing a full checkpoint are the metadata blocks that were touched in the last 30 seconds, plus any pending writeback.</font><br>
<p>
So you&#x27;re saying that - in normal circumstances - ext has a maximum of 30 secs of writes in flight. Anything older than that SHOULD have been flushed through to the underlying layers (or binned as having been overwritten :-)<br>
<p>
That&#x27;s good news from ext. I&#x27;m just wondering whether other filesystems and layers provide similar guarantees. It may just be mis-understanding the terminology, but I just don&#x27;t know ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2021 4:21 UTC (Fri)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854964/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, &quot;maximum of 30 seconds in flight&quot; isn&#x27;t guaranteed&quot;. After 30 seconds, we will start the writeback.  However, writeback is not instaneous.   Sumchronous reads are higher priority than background write operations.   So if there are processes that are continuously reading files in order to do useful work, those will be prioritized ahead of the write backs. <br>
<p>
Secondly, if the metadata block is modified so it&#x27;s part of a newer check point, that block&#x27;s write back will be suppressed.   So if a particular inode table block is getting constantly modified every ten seconds, that inode table block won&#x27;t get written back.   So.... if you are appending to a log file every five seconds, such that the inode size is changing, then that inode table block will be involved in every journal transaction (assuming no fsyncs).   So if you have a super-reliable file system device, and a super-UN-reliable external journal device, then yeah, it&#x27;s possible that if the unreliable external journal device explodes, you might lose the inode table block.   But that&#x27;s a stupid, stupid configuration.   Don&#x27;t do that.   (And indeed, most people don&#x27;t use external journals, so this is really an unrealistic, or at least uncommon, configuration.)<br>
<p>
You could also complain that if you had a RAID 0 configuration, where one disk is super-reliable, and the other disk is super-fragile, the chances of data loss is much larger.  So is having 3 tires in a car that are brand new, and one front tire which has complete threads worn out and broken steel belts sticking out the size; that could kill people, even though 3 of the tires are expensive, brand new tires.    But there are always unwise ways you can configure any system, and the fault is not that you chose to use 3 expensive brand new tires.   It&#x27;s the fact that one of the other tires is not like the others.   :-)<br>
<p>
As far as other systems are concerned, in general, the journal is a circular buffer, and it&#x27;s not the case that a file system or database would wait until the write-ahead log is 100% full, and then all useful work stops while the log is written to the file system or database, and then the log is truncated down to be completely empty.   People would be really unhappy with the performance, for one thing --- imagine how you would feel if you were using a web browser, and all of sudden, KER-CHUNK --- checkpointing now, and the web browser freezes until the checkpoint is done.    As they say, that would not be a great user experience.   :-)   So in general, writeback happens in the background, in parallel with other file system or database operations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor854917"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 17:43 UTC (Thu)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/854917/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When people want lots of reliability they also mirror any journal devices in the system.<br>
<p>
For example, the ZFS SLOG is often a single Flash or Optane or NVRAM device. And for many situations this works very well.<br>
<p>
However, for installations that can&#x27;t allow losing the transactions within a 5 second window during failure of that single SLOG device, you can use two. Or three.<br>
<p>
This same consideration needs to be done for external EXT4 journals. Usually the journal is on the same device, so if the data is mirrored the journal is also mirrored.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854917/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 20:21 UTC (Thu)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854935/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, I was really unclear about what Wol was concerned about.   A mirrored file system doesn&#x27;t make things more unsafe.   If you have an external journal, the fact that you have an external journal does add an extra point of failure, sure.  But that has nothing to do with the mirrored file system.<br>
<p>
As I said in my direct reply to Wol, after 30 seconds, a dirtied metadata block will be subject to writeback.   So if you are using an external journal device, and it dies, then there will certainly be some metadata that may have only been written to the journal, but which hasn&#x27;t been written back to the file system, where you may end up losing that metadata update.   But taking hours of data waiting to be checkpointed?   I&#x27;m not sure when that would *ever* be the case.    I guess if you had a super slow USB thumb drive, it might take a while to sync the file system and unmount the file system, but that&#x27;s mainly the data blocks which is taking all of the time, not the journal checkpoint.   But even with the slowest USB thumb drive, it&#x27;s never taken me an hour to writeout everything so the unmount can proceed.   So I&#x27;m not sure what Wol was talking about in that case.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854958"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2021 0:37 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854958/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Right, I was really unclear about what Wol was concerned about. A mirrored file system doesn&#x27;t make things more unsafe. If you have an external journal, the fact that you have an external journal does add an extra point of failure, sure. But that has nothing to do with the mirrored file system.</font><br>
<p>
Yup, that was it. If stuff gets delayed in the journal and not flushed to the mirror, you have a single point of failure. From what you&#x27;ve said ext only has a minimal risk window, which is great :-)<br>
<p>
Maybe I&#x27;m naive (probably am :-) but I was thinking of journals as being a simplistic &quot;write log, write to permanent storage, delete log&quot;, and thinking &quot;if stuff gets to the log and the system is tardy about the next step, then that&#x27;s not good ...&quot;<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854958/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor854702"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 8:01 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854702/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And, as the OP who started this thread, and who is also interested in RAID :-), I&#x27;m thinking of situations where we have the file system on a mirror, and the journal on a single disk ...<br>
<p>
The longer it takes for the journal to flush, the longer the user is being misled as to the safety of said data ...<br>
<p>
(And yes, I know disasters are unlikely, but would you like to lose hours or days of supposedly mirrored data because your single journal disk died ...?)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854702/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Journal flushing</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 14:29 UTC (Wed)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/854719/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wol,<br>
<p>
The journal has always been able to remain in this state for arbitrary lengths of time.  This is in fact a change to do this in new circumstances.<br>
<p>
And, the journal not being flushed doesnâ€™t mean the data/metadata isnâ€™t on the primary storage/written to the main file system.  It is, itâ€™s just also recorded in the journal.  This is - as I understand it - essentially a journal â€œcleanâ€ or â€œpurgeâ€.  At a time when the journal and the disk are known to be in accord, the journal is purged because itâ€™s known to be not necessary.  (The journal handles the case of crashing when there is data/metadata that is not known to have reached permanent storage in the actual file system.)<br>
<p>
If there *are* any outstanding changes to the file system, I would guess this also ensures those reach permanent storage on the primary file system, and then purges the associated journal entries, but thatâ€™s a transient state while operations are in progress.<br>
<p>
The journal is not kept forever.  This is just making sure itâ€™s gone at certain times.  (Hope Iâ€™ve got that right. ;) )<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor854921"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 17:42 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/854921/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; How many filesystems don&#x27;t flush the journal even on shutdown? </font><br>
[...]<br>
<font class="QuotedText">&gt; There seems to be (I may be wrong) this assumption that &quot;once it&#x27;s flushed to journal it&#x27;s safe&quot;.</font><br>
<p>
Yes, that is what the journal is for :) the journal has to be able to be usable to produce a filesystem in a consistent state on a power failure at any time, or it&#x27;s useless: therefore, once it&#x27;s flushed to journal, metadata *is* safe. Given that, flushing the journal on shutdown rather than replaying it on startup is a more-or-less arbitrary decision which filesystem developers can and do make in either direction (ext4 goes one way, xfs goes the other).<br>
<p>
(Obviously, things like data which are rarely journalled do have to get flushed to disk on shutdown. The data has to go *somewhere* persistent or it&#x27;s lost.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854921/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854960"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2021 0:44 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854960/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; (Obviously, things like data which are rarely journalled do have to get flushed to disk on shutdown. The data has to go *somewhere* persistent or it&#x27;s lost.)</font><br>
<p>
And this is my peeve with filesystem developers. Okay, I do understand that if metadata isn&#x27;t saved then the data is toast, but as a user I don&#x27;t give a monkeys about the metadata - it&#x27;s the DATA that pays for the computer!<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854960/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854978"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2021 9:24 UTC (Fri)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/854978/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>The metadata matters a lot more than the data because a loss of the metadata loses you all files on the filesystem, even older files. A loss of data loses recently written data, but leaves older data alone.
<p>That said, ext3/4 have data=journal to get the exact same guarantees for data as metadata, and the default data=ordered which does not write metadata to the journal until the data is written to its final resting place. It's only data=writeback (which is fastest) that has an ordering issue.
<p>Similarly, btrfs's default mode is equivalent to data=ordered (but with data checksums to detect bitflips), and it offers a flushoncommit mount option that gets you the same guarantees for your data as btrfs has for its metadata.
<p>Basically, FS developers really do care about the data - it just doesn't seem like that because the metadata is needed to keep all the data safe, where the data is less critical to keeping all data safe.
      
          <div class="CommentReplyButton">
            <form action="/Articles/854978/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor854682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 27, 2021 23:58 UTC (Tue)
                               by <b>gus3</b> (guest, #61103)
                              [<a href="/Articles/854682/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ext4 and f2fs already have native support for encrypting files (and filenames). I don&#x27;t understand why this is a problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 6:59 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/854697/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As others have already pointed out above, encryption does not help with possible future malware infection that will look at deleted information. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854700"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 7:50 UTC (Wed)
                               by <b>comicfans</b> (subscriber, #117233)
                              [<a href="/Articles/854700/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To my knowledge, if a malware can look at deleted information even with encryption enabled (as said &#x27;encryption does not help &#x27;) , it must be a running time attack (since encryption prevent cold attack), and if it can bypass OS fs layer restriction (because you can not access a already deleted file info through normal fs api), it must gain raw disk read permission (at least some level administrator permission, for example access debugfs ).  in such situation,  if without encryption , malware can parse whole filesystem already, no just a filename. with encryption enabled, malware at least need to obtain encryption key (otherwise encryption still worked).  and if malware can obtain encryption key (no matter from kernel, or from a bad-placed-plain-text-password), then whole system already being cracked (almostly). that means:  if such malware do exist and make encryption useless, then whole os already insecure. it can leak much more than just a filename.  encryption at least makes crack harder.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854700/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 21:46 UTC (Wed)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/854807/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was talking about defense against future infection that can recover deleted information. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854808"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 22:10 UTC (Wed)
                               by <b>gus3</b> (guest, #61103)
                              [<a href="/Articles/854808/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks to both of you for your comments. I see your points.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854808/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor854688"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 0:31 UTC (Wed)
                               by <b>comicfans</b> (subscriber, #117233)
                              [<a href="/Articles/854688/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Emm... what if user delete a file with important-information-as-filename by mistake and want to restore it ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854688/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 0:45 UTC (Wed)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/854690/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See <a href="https://lwn.net/Articles/854689/">https://lwn.net/Articles/854689/</a> for the answer to your question.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854692"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 2:05 UTC (Wed)
                               by <b>comicfans</b> (subscriber, #117233)
                              [<a href="/Articles/854692/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
# &quot;rm is forever&quot; and the solution for accidental deletion of files is to refer to your backups.<br>
<p>
I think if this is true, then clear filename is not solution for sensitive information leak prevention should be also true . takes cloud VM as example, no matter you trust provider or not , every memory bit is transparent. I can not see any advantage filename-clear over encryption (they both not work). If you&#x27;re just afraid of sibling VM of others (hardware sidechannel attack maybe), this may reduce the attack window, but still not resolve problem.  if such attach exists, they can read more than just filename. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854692/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor854711"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 10:32 UTC (Wed)
                               by <b>hummassa</b> (guest, #307)
                              [<a href="/Articles/854711/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This seems to me a clear case of &quot;wants A, does B&quot;. What is *wanted* is guaranteeing the PII protections on the law. I don&#x27;t think this can be done on the filesystem level. The proposed &quot;solutions&quot; either don&#x27;t work and leave breadcrumbs all over the system or are just akin to scrub the whole volume, all the time, and good luck with your SSDs. PII protections laws would be much better satisfied with policies of &quot;collect less data&quot; and &quot;compartmentalize PII data whenever possible&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854711/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor854717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 28, 2021 13:42 UTC (Wed)
                               by <b>nim-nim</b> (subscriber, #34454)
                              [<a href="/Articles/854717/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
PII tends to leak everywhere, the more so because some apps take years to be re-engineered, while (evil) data miners are demonstrating every week their ability to extract more info from the smallest sliver of data.<br>
<p>
Ultimately, because the goal posts change all the time, everything will need to be treated like PII with strong just-in-time erasure requirements.<br>
<p>
This is no different from the general deprecation of http in favor of https.<br>
<p>
The social costs of big data are mounting every day, but who has a reasonable plan to put horses back in the barn? The next years are going to out-Orwell the worst nightmare people imagined.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 11:28 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/854845/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I don&#x27;t think this can be done on the filesystem level.</font><br>
<p>
The point is, some information can be leaked at the filesystem level. So the filesystem taking responsibility for those things it has control over is a GOOD THING.<br>
<p>
All it&#x27;s doing is providing a guarantee that when a file is deleted, *all trace* of said file is deleted from the file system. Traces elsewhere, well the filesystem can&#x27;t do anything about that. The file system can&#x27;t be blamed for the existence of backups ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor854887"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 29, 2021 14:03 UTC (Thu)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/854887/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  PII protections laws would be much better satisfied with policies of &quot;collect less data&quot; and &quot;compartmentalize PII data whenever possible&quot;.</font><br>
<p>
This is precisely what happens though.<br>
<p>
The story goes that when GDPR was originally passed there were many people that were asking where the checklists were so they could validate their systems. The answer of course is there is no such checklist. You are expected to analyse your own business processes, determine what could be considered PII, justify why you actually need that data and how you&#x27;re going to protect it and then publish that information for customers.<br>
<p>
The process is the important part and it does make rigorous enforcement hard. On the other, it has made a lot of businesses think, for the first time, why their business process is the way it is.<br>
<p>
There is still room for improvement though. My pet peeve is sites asking for your date of birth when what they really want to know is if you&#x27;re over 18. Just use a checkbox please.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/854887/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor855158"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Preventing information leaks from ext4 filesystems</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 3, 2021 13:01 UTC (Mon)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/855158/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; PII protections laws would be much better satisfied with policies of &quot;collect less data&quot; and &quot;compartmentalize PII data whenever possible&quot;.</font><br>
<p>
<font class="QuotedText">&gt; This is precisely what happens though.</font><br>
<p>
And I&#x27;ll add to that: that was precisely the intent of GDPR. Though not spelled explicitly, because how would you do it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/855158/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
