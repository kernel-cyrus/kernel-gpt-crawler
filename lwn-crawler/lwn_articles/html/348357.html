        <!DOCTYPE html>
        <html lang="en">
        <head><title>In brief [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/348357/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/347815/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/348357/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>In brief</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 26, 2009</br>
           </div>
<b>What is direct I/O, really?</b>  Linux, like many operating systems,
supports direct I/O operations to block devices.  But how, exactly, should
programmers expect direct I/O to work?  As <a href="/Articles/348739/">a
recent document</a> posted by Ted Ts'o notes, there is no real
specification for what direct I/O means:
<p>
<div class="BigQuote">
	It is not a part of POSIX, or SUS, or any other formal standards
	specification. The exact meaning of O_DIRECT has historically been
	negotiated in non-public discussions between powerful enterprise
	database companies and proprietary Unix systems, and its behaviour
	has generally been passed down as oral lore rather than as a formal
	set of requirements and specifications.
</div>
<p>
Ted's document is an attempt to better specify what is really going on when
a process requests a direct I/O operation.  It is currently focused on the
ext4 filesystem, but the hope is to forge a consensus among Linux
filesystem developers so that consistent semantics can be obtained on all
filesystems.
<p>

<b>Can you thaw out TuxOnIce?</b>  TuxOnIce is the perennially out-of-tree
hibernation implementation.  It has a number of nice features which are
not available with the mainstream version; these features have never
managed to get into a form where they could be merged.  TuxOnIce developer
Nigel Cunningham has recently <a href="/Articles/348741/">concluded</a>
that it looks like this merger is not going to happen because the relevant
people are simply too busy.  He says:
<p>
<div class="BigQuote">
	Given that this has been the outcome so far, I see no reason to
	imagine that we're going to make any serious progress any time
	soon.
</div>
<p>
In response, he is now actively looking for developers who would like to
take on the task of getting TuxOnIce (or, at least, parts of it) into the
mainline.  He has put together <a href="/Articles/348743/">a "todo"
list</a> for potentially interested parties.
<p>
<b>Lazy workqueues</b>.  Kernel developers have been concerned for years
that the number of kernel threads was growing beyond reason; see, for
example, <a href="http://lwn.net/Articles/229873/">this article</a> from
2007.  Jens Axboe recently became concerned himself when he noticed that
his system (a modest 64-processor box) had 531 kernel threads running on
it.  Enough, he decided, was enough.
<p>
His response was the <a href="http://lwn.net/Articles/347822/">lazy
workqueue</a> concept.  As might be expected, this patch is an extension of
the workqueue mechanism.  A "lazy" workqueue can be created with
<tt>create_lazy_workqueue()</tt>; it will be established with a single
worker thread.  Unlike single-threaded workqueues, though, lazy workqueues
still try to preserve the concept of dedicated, per-CPU worker threads.
Whenever a task is submitted to a lazy workqueue, the kernel will direct it
toward the thread running on the submitting CPU; if no such thread exists,
the kernel will create it.  These threads will exit if they are idle for a
sufficient period.
<p>
The end result was a halving of the number of kernel threads on Jens's
system.  That still seems like too many threads, but it's a good step in
the right direction.
<p>

<b>Embedded x86</b>.  Thomas Gleixner started <a
href="http://lwn.net/Articles/348244/">his patch series</a> with a note
that the "embedded nightmare" has finally come to the x86 architecture.
The key development here is a new set of patches intended to support
Intel's new "Moorestown" processor series; these patches added a bunch of
code to deal with the new quirks in this processor.  Rather than further
clutter the x86 architecture code, Thomas decided that it was time for a
major cleanup.
<p>
The result is a new, global <tt>platform_setup</tt> structure designed to
tell the architecture code how to set up the current processor.  It
includes a set of function pointers which handle platform-specific tasks
like locating BIOS ROMs, setting up interrupt handling, initializing
clocks, and much more; it is a 32-part patch in all.  This new structure is
able to encapsulate many of the initialization-time differences between the
32-bit and 64-bit x86 architectures, the new "Moorestown" architecture, and
various virtualized variants as well.  It is also runtime-configurable, so
a single kernel should be able to run efficiently on any of the supported
systems. 
<p>

<b>O_NOSTD</b>.  Longstanding Unix practice dictates that applications are
started with the standard input, output, and error I/O streams on file
descriptors&nbsp;0, 1, and&nbsp;2, respectively.  The assumption that these file
descriptors will be properly set up is so strong that most developers never think to
check them.  So interesting things can happen if an application is run with
one or more of the standard file descriptors closed.  
<p>
Consider, for example, running a program with file
descriptor&nbsp;2 closed.  The next file the program opens will be assigned that
descriptor.  If something then causes the program to write to (what it
thinks is) the standard error stream, that output will, instead, go to the
other file which had been opened, probably corrupting that file.  A
malicious user can easily make messes this way; when setuid programs are
involved, the potential consequences are worse.
<p>
There are a number of ways to avoid falling into this trap.  An application
can, on startup, ensure that the first three file descriptors are open.  Or
it can check the returned file descriptor from <tt>open()</tt> calls and
use <tt>dup()</tt> to change the descriptor if need be.  But these options
are expensive, especially considering that, almost all of the time, the
standard file descriptors are set up just as they should be.
<p>
Eric  Blake has proposed a new alternative in the form of the <a
href="http://lwn.net/Articles/348331/"><tt>O_NOSTD</tt></a> flag.  The
semantics are simple: if this flag is provided to an <tt>open()</tt> call,
the kernel will not return one of the "standard" file descriptors.  If this
patch goes in (and there does not seem to be any opposition to that),
application developers will be able to use it to ensure that they are not
getting any file descriptor surprises without additional runtime cost.
<p>
There is a cost, of course, in the form of a non-standard flag that will
not be supported on all platforms.  One could almost argue that it would be
better to add a specific flag for cases where a file descriptor in the
[0..2] range is desired.  But that would be a major ABI change to say the
least; it's not an idea that would be well received.
<p>

<b>Linux-ARM mailing lists</b>.  Russell King has <a href="/Articles/348043/">announced</a> that the
ARM-related mailing lists on arm.linux.kernel.org will be shut down
immediately.  He is, it seems, not happy about some of the criticism he has
received about the operation of those lists.  So the lists will be moving,
though exactly where is not entirely clear.  David Woodhouse has <a
href="/Articles/348044/">created a new set of lists</a> on infradead; he
appears to have moved the subscriber lists over as well.  There is also a
push to <a href="/Articles/348046/">move the list traffic to vger</a>, but
the preservation of the full set of lists and their subscribers suggests
that the infradead lists are the ones which will actually get used.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Workqueues-Lazy">Workqueues/Lazy</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/348357/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor349011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 0:23 UTC (Thu)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/349011/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <p><font face="monospace">O_NOSTD</font> seems like an odd hack... Any longtime Unix hacker would <i>assume</i> that file descriptors 0, 1, and 2 refer to <font face="monospace">stdin</font>, <font face="monospace">stdout</font>, and <font face="monospace">stderr</font>, respectively&mdash;I'm surprised that these aren't in the SUS or POSIX standards... How na&iuml;ve am I. :-\</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/349011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 1:50 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/349020/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      That's the point: those file descriptors <i>are</i> defined in the standards.  That's why application programmers expect them to be set up correctly.  But nothing forces that to happen, and other standard-ordained behavior says that new files are always assigned the lowest available file descriptor.
      
          <div class="CommentReplyButton">
            <form action="/Articles/349020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 2:13 UTC (Thu)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/349024/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SUS also says that exec() of a setuid executable may assign file descriptors 0, 1, and 2 to unspecified files if they are not already assigned.<br>
<p>
O_NOSTD is utterly pointless as it would need to be added all over the place, including libraries outside the application programmer's control.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349083"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 9:47 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/349083/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think if the kernel developers don't have the guts to just turn on O_NOSTD<br>
for all open() calls by default, then maybe the C library will.  (With an<br>
O_ALLOW_STD flag for those cases like the shell where you really do want to<br>
fiddle with the standard file descriptors.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349083/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349423"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 0:53 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/349423/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This was already fixed years ago after Chuck Lever came up with the problem originally.  Try running a setuid program with a standard file descriptor closed.  You'll find that libcrt0 opens them again.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349423/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor349036"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 2:54 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/349036/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      Indeed. It, O_NOSTD, like O_CLOEXEC before it, are almost entirely pointless extensions that 
basically only gnu coreutils and glibc can ever use. And when I think of all the functions that 
needed extra arguments added just to be able to pass the O_CLOEXEC flag...ugh.
<p>
IMO, Instead of O_CLOEXEC, glibc should have added a function to close all but a specified list of 
fds. And apps or libraries could call this themselves after fork, before exec. Obviously you can 
write this yourself already by iterating over the files in /proc/self/fds, but I just want to write:
<p>
<pre>int keep_fds[] = {0,1,2,-1}; close_everything_but(keep_fds);</pre>
<p>
and be done with it! The list of fds to keep across a given call to exec is *always* going to be 
small, and known to the program calling exec. And then, it's also trivial to write the compatibility 
library for non-glibc platforms...
<p>
Sigh. And now this O_NOSTD...so instead of just calling a single function at program startup, I 
have to change every open call in every library that I use to use O_NOSTD? Yeah, right.
<p>
If they're that concerned about number-of-syscalls-per-program-start, why not just make a 
single syscall for "make sure I have fds 0,1, and 2 open to a fd, otherwise open /dev/null there". 
Yay, now I only have a single syscall on program startup. That'd make <i>much</i> more sense 
than this proposal...
      
          <div class="CommentReplyButton">
            <form action="/Articles/349036/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349093"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 11:34 UTC (Thu)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/349093/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <em><blockquote>And now this O_NOSTD...so instead of just calling a single function at program startup, I have to change every open call in every library that I use to use O_NOSTD? Yeah, right.</blockquote></em>
<p>
There's nothing that forces you to use O_NOSTD. If you want to manually make sure that your fd's are numbered properly -- which has to be a bit of a kludge considering the nature of the problem of having regular fd's with a special meaning -- then it should still work as before.
<p>
<em><blockquote>If they're that concerned about number-of-syscalls-per-program-start, why not just make a single syscall for "make sure I have fds 0,1, and 2 open to a fd, otherwise open /dev/null there". Yay, now I only have a single syscall on program startup. That'd make much more sense than this proposal... 
</blockquote></em>
<p>
Then all we'd need is CAP_DO_WHAT_I_MEAN and O_NOSH*T. There's no fun in that. 
      
          <div class="CommentReplyButton">
            <form action="/Articles/349093/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor349155"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 16:31 UTC (Thu)
                               by <b>daney</b> (guest, #24551)
                              [<a href="/Articles/349155/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For a multi-threaded program, O_CLOEXEC is required if you want race free operation.  Hardly pointless.<br>
<p>
The O_NOSTD problem, on the other hand, can be worked around entirely in user space.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349155/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349188"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 18:09 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/349188/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; For a multi-threaded program, O_CLOEXEC is required if you want race free operation.</font><br>
<font class="QuotedText">&gt; Hardly pointless.</font><br>
<p>
No, it's not required. After a fork, your program is no longer multi-threaded, and you can at your <br>
leisure close all file descriptors except those necessary for program you're about to exec, with no <br>
race condition.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349188/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:24 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/349250/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      The problem is then that a third-party library might not be notified between a call to fork() and exec(). That's what <a href="http://www.opengroup.org/onlinepubs/009695399/functions/pthread_atfork.html">pthread_atfork</a> is for, but not everyone links against libpthread.
<p>
Even with pthread_atfork, however, you can race. Consider:
<pre>
[library code]
static int fd = -1;
void mylib_atfork() {
    close(fd);
}

void mylib_dosomething() {
    fd = open(...);
    do_something_with_fd(fd);
}
</pre>
<p>
If the fork happens between the return from <code>open()</code> and the assignment to <code>fd</code>, then you race and leak the file descriptor.
<p>
The <i>real</i> userspace solution would be for programs to just close unknown file descriptors between <code>fork</code> and <code>exec</code>. But they don't, so <code>O_CLOEXEC</code> is a decent facility for defensive library programing.
<p>Now, on the other hand, this O_NOSTD business is pure junk that will uselessly take up a valuable flag bit for all eternity.
      
          <div class="CommentReplyButton">
            <form action="/Articles/349250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 21:33 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/349307/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>The real userspace solution would be for programs to just close unknown file 
descriptors between fork and exec. But they don't, so O_CLOEXEC is a decent facility for defensive 
library programing.</blockquote>
<p>
Yes, this is what I've been saying -- see previous comment regarding "close_everything_but". The 
bug is in the code that calls fork/exec, not the code that opens a file descriptor!
<p>
Comments like <a href="https://lists.launchpad.net/drizzle-discuss/msg04629.html ">this 
one</a> just show how insane this whole thing is. The *bug* there is that libuuid doesn't close fds 
before execing a long-lived daemon! It should not be the responsibility of everyone to open all 
their fds with O_NOEXEC.
      
          <div class="CommentReplyButton">
            <form action="/Articles/349307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor349315"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 21:51 UTC (Thu)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/349315/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <p>
I don't see it.  Never mind pthread_atfork() -- after all, the issue is exec, not fork.  The alternative to O_CLOEXEC for a library that opens files under the covers would seem to be a prepare_for_exec() function exported by the library.  The user makes sure he calls that before any exec().
<p>
As for the multithreaded program, it already has to serialize access to these file-descriptor-using functions anyway (you wouldn't want two threads opening that file at the same time), so it might as well synchronize prepare_for_exec() with those.  This serialization could be done either in the library (i.e. the library is thread-safe), or outside.
Oh, and here comes pthread_atfork(): it can make sure the serialization mechanism survives a fork that may precede the exec.

      
          <div class="CommentReplyButton">
            <form action="/Articles/349315/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349369"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 22:54 UTC (Thu)
                               by <b>Los__D</b> (guest, #15263)
                              [<a href="/Articles/349369/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Besides "prepare_for_exec()" being a horrible interface, do you really think that programmers that doesn't care to close unknown fds, would care to call it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349369/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349433"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 1:44 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/349433/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
Besides "prepare_for_exec()" being a horrible interface, do you really think that programmers that doesn't care to close unknown fds, would care to call it?
</blockquote>
<p>
That's beside the point.  I was responding to a claim that there is no way to write a correct multithread program involving a third party library that opens files without O_CLOEXEC.  And that that distinguishes O_CLOEXEC from the proposed O_NOSTD.
<p>
If on the other hand you just want to argue that O_CLOEXEC is convenient, with or without threads, then you're putting it in the same class as O_NOSTD.

      
          <div class="CommentReplyButton">
            <form action="/Articles/349433/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349475"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 5:39 UTC (Fri)
                               by <b>Los__D</b> (guest, #15263)
                              [<a href="/Articles/349475/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is no other way for the library author to make sure that his library opened fds are safe.<br>
<p>
It is hardly "convenience", but good library programming style, to make sure that internal data stays internal.<br>
<p>
I would go so far as argue, that the na√Øve library user that doesn't close the fds, isn't entirely an idiot for expecting not to be responsible for library data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349475/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor349377"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 23:10 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/349377/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Or you just do this (error checks omitted):


<pre>
#include &lt;pthread.h&gt;

static int fd = -1;
static pthread_mutex_t fd_lock = PTHREAD_MUTEX_INITIALIZER;

static void mylib_beforefork() {
    pthread_mutex_lock(&amp;fd_lock);
}

static void mylib_afterfork() {
    pthread_mutex_unlock(&amp;fd_lock);
}

void mylib_dosomething() {
    pthread_mutex_lock(&amp;fd_lock);
    if(fd == -1) {
        pthread_atfork(mylib_beforefork, 
                       mylib_afterfork, 
                       mylib_afterfork);
        fd = open(...);
        fcntl(fd, F_SETFD, O_CLOEXEC);
    }
    pthread_mutex_unlock(&amp;fd_lock);

    do_something(fd);
}

</pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349377/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Third-party libraries</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 8, 2009 9:06 UTC (Tue)
                               by <b>jlokier</b> (guest, #52227)
                              [<a href="/Articles/351380/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doesn't work if the thread uses vfork() :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor349241"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:11 UTC (Thu)
                               by <b>kjp</b> (guest, #39639)
                              [<a href="/Articles/349241/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Finally a voice of reason.<br>
<p>
O_NOSTD is a joke.  WAAAAAAAAAAAH I don't want to call some syscalls in gnu coreutils cp.  So yeah, lets add more flags to open and freaking *socket* while we're at it?<br>
<p>
WAAAAAAAAAAAAAAH I don't want to close fds in my pre exec code so I need CLOEXEC added to Everything.  Jeez, even a per process flag to say no inherit by default would be better than that crap.  <br>
<p>
God, Linux is turning into Windows crapware.  Please Linus...axe this crap.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349241/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">O_NOSTD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 8, 2009 8:56 UTC (Tue)
                               by <b>jlokier</b> (guest, #52227)
                              [<a href="/Articles/351378/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I proposed that per-process cloexec-by-default flag some years ago, and it was (rightly) shot down for breaking third party libraries that internally create descriptors, spawn child processes and _expect_ those processes to inherit those descriptors.<br>
<p>
Personally I'd rather break those libraries than have descriptor leaks, security holes and more complicated APIs.  After all what we're doing now pretty much requires all libraries to be changed anyway, only this way, it's silent breakage in the meantime.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor349117"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Old and well-known</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 14:18 UTC (Thu)
                               by <b>dwheeler</b> (guest, #1216)
                              [<a href="/Articles/349117/">Link</a>] 
      </p>
      
      </div>
      </summary>
      The issue this patch is trying to address is noted in <a href="http://www.dwheeler.com/secure-programs/Secure-Programs-HOWTO/file-descriptors.html">"Secure Programming for Linux and Unix HOWTO", section 5.3 (File Descriptors)</a>:
"[do] not assume that standard input (stdin), standard output (stdout), and standard error (stderr) refer to a terminal or are even open."
I don't know if this is the best way to go about it, but I applaud the idea of trying to make it easier to write correct software.


      
          <div class="CommentReplyButton">
            <form action="/Articles/349117/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor349018"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In brief</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 1:16 UTC (Thu)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/349018/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Speaking of O_DIRECT, For the lazy among us, it would be a good idea to <br>
abstain from putting single and double quotes in URLs, because browsers like <br>
Chrome assume that those are URL terminating characters.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349018/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349084"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In brief</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 9:56 UTC (Thu)
                               by <b>pebolle</b> (guest, #35204)
                              [<a href="/Articles/349084/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Firefox 3.5.x claims the link you seem to refer to is formatted like this:<br>
<p>
&lt;a href="http://ext4.wiki.kernel.org/index.php/Clarifying_Direct_IO"&gt;<a href="http://ext4.wiki.kernel.org/index.php/Clarifying_Direct_IO&lt;/a">http://ext4.wiki.kernel.org/index.php/Clarifying_Direct_I...</a>&gt;'s_Semantics<br>
<p>
Even with my limited knowledge of HTML it is easy to see why that link doesn't work as expected.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349084/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349085"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In brief</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 9:59 UTC (Thu)
                               by <b>pebolle</b> (guest, #35204)
                              [<a href="/Articles/349085/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That comment was, of course, mangled. In short it seems the closing "&lt;/a&gt;" tag was put somewhere in the middle of the URL (presumably by the HTML generating system used to generate that page).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349085/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor349088"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 10:51 UTC (Thu)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/349088/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Couldn't the O_NOSTD checks be implemented in glibc just as well?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349088/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:16 UTC (Thu)
                               by <b>kjp</b> (guest, #39639)
                              [<a href="/Articles/349248/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, but that would require 'syscalls' according to the person who wants the code added to the kernel.  The new motto is if it can go in the kernel, it should.  You're behind the times.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor349259"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:27 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/349259/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But, like, that's a performance hit and maybe another system call dude. But, like, if you pass a flag to the kernel, then oh man, that conditional branch in the kernel doesn't, you know, count. So it's really like cool and nonstandard and stuff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349259/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349265"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:35 UTC (Thu)
                               by <b>kjp</b> (guest, #39639)
                              [<a href="/Articles/349265/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah. and it's much easier, robust, and secure to do this:<br>
<p>
* Change every open() or socket() line in every library that my super robust 'fooutils' program uses to use NOSTD<br>
<p>
than:<br>
<p>
* Change my main() code to open 0,1,2 to /dev/null ...<br>
<p>
<p>
Just like it's SO error prone to read /proc/self/fd/ and close what you don't want, than using CLOEXEC *in every library you'd ever think about using or be LD_PRELOAD'd with*<br>
<p>
<p>
<p>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349265/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349279"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:40 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/349279/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      I actually agree with you. Well-written programs should close file descriptors before <code>exec</code>. <b>Additionally</b>, well-written libraries should mark their file descriptors close-on-exec. That way, at least one component will be well-written and the correct behavior will result.
      
          <div class="CommentReplyButton">
            <form action="/Articles/349279/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349457"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 3:54 UTC (Fri)
                               by <b>kjp</b> (guest, #39639)
                              [<a href="/Articles/349457/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about libraries that use fopen() anywhere?  There is no way for them to set CLOEXEC race free..or even pass NOSTD for that matter.  The people who thought these hacks up didn't think it through.  If you use open(2) you should be able to realize you don't need these hacks.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349457/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 4:05 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/349461/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Your argument is spot-on. That's why I <a href="http://lkml.org/lkml/2007/6/8/158">proposed</a>, way back when, that O_CLOEXEC be a thread flag. I'm glad to see that people finally realize I was right.
      
          <div class="CommentReplyButton">
            <form action="/Articles/349461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor349467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">nostd in userspace?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 4:53 UTC (Fri)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/349467/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If only linux would implement this:<br>
<a href="http://docs.sun.com/app/docs/doc/816-5168/closefrom-3c?a=view">http://docs.sun.com/app/docs/doc/816-5168/closefrom-3c?a=...</a><br>
....*that* would be a welcome addition.<br>
<p>
Oh look, this was already discussed. :)<br>
<a href="http://lwn.net/Articles/292674/">http://lwn.net/Articles/292674/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor349261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel threads - so what?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2009 20:29 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/349261/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Err, so what if there are over 500 kernel threads? What makes 500 kernel threads "too many"? If there's a problem here, it's that the system doesn't scale to having thousands of processes, <b>not</b> that there are "too many" processes. A process is a fundamentally useful abstraction that a kernel would support well. The solution to poor performance isn't to hack around the problem.
      
          <div class="CommentReplyButton">
            <form action="/Articles/349261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349668"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel threads - so what?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 20:19 UTC (Fri)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/349668/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Threads obviously have an overhead (scheduling, task struct etc).  The <br>
less overhead you have, the better it scales.<br>
<p>
Besides, it clutters your "ps" output.  Having more kernel threads running <br>
than the actual user-space processes for which they do stuff, sounds <br>
wrong.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349668/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor349679"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel threads - so what?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 28, 2009 20:49 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/349679/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
computers can easily track several thousand inactive threads with very little overhead, but the sysadmin trying to examine ps or top output to figure out what's happening has a much lower threshold <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/349679/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor351379"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel threads - so what?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 8, 2009 9:04 UTC (Tue)
                               by <b>jlokier</b> (guest, #52227)
                              [<a href="/Articles/351379/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Obvious solution is to hide kernel threads in ps/pstree/top.<br>
<p>
It would be nice if the kernel threads had lazy stacks too, to save a bit of memory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/351379/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
