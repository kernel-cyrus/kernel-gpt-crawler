        <!DOCTYPE html>
        <html lang="en">
        <head><title>Killing off /dev/kmem [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/851531/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/851383/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/851531/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Killing off /dev/kmem</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 5, 2021</br>
           </div>
The recent <a
href="/ml/linux-kernel/20210319143452.25948-1-david@redhat.com/">proposal</a>
from David Hildenbrand to remove support for the <tt>/dev/kmem</tt> special
file has not sparked a lot of discussion.  Perhaps that is because today's
youngsters, lacking an understanding of history, may be wondering
what that file is in the first place and, thus, be unclear on why it may
matter.  Chances are that <tt>/dev/kmem</tt> will not be missed, but in
passing it takes away a venerable part of the Unix kernel interface.
<p>
<tt>/dev/kmem</tt> provides access to the kernel's address space; it can be
read from or written to like an ordinary file, or mapped into a
process's address space.  Needless to say, there are some mild security
implications arising from providing that sort of access; even read access
to this file is generally enough to expose credentials and allow an
attacker to take over a
system.  As a result, protections on <tt>/dev/kmem</tt> have always tended
to be restrictive, but it remains the sort of open back door into the
kernel that makes anybody who worries about security worry even more.
<p>
It is a rare Linux system that enables <tt>/dev/kmem</tt> now.  As of the
2.6.26 kernel release in July 2008, the kernel only implements this special
file if the <tt>CONFIG_DEVKMEM</tt> configuration option is enabled.  One
will have to look long and hard for a distributor that enables this option
in 2021; most of them disabled it many years ago.  So its disappearance
from the kernel is unlikely to create much discomfort.
<p>
It's worth noting that Linux systems still support <tt>/dev/mem</tt>
(without the "<tt>k</tt>"), which once provided similar access to
<i>all</i> of the memory in the system.  It has long been restricted to I/O
memory; system RAM is off limits.  The occasional user-space device driver
still needs <tt>/dev/mem</tt> to function, but it's otherwise unused.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
One may well wonder why  a dangerous interface like <tt>/dev/kmem</tt> existed in the
first place.  The kernel goes out of its way to hide its memory from the
rest of the system; creating a special file to circumvent that hiding seems
like a step in the wrong direction.  The answer, in short, is that once
there was no other way to get many types of information out of the kernel.
<p>
As an example, consider the "load average" numbers printed by tools like
<tt>top</tt>, <tt>uptime</tt>, or <tt>w</tt>; they indicate the average
length of the CPU run queues over periods of one, five, and 15 minutes.  In
the distant past, when computers were scarce and it was common to run
many tasks on the same machine, jobs that were not time-critical would
often consult the load average and defer their work if it was too high.  It
was the sort of courtesy that was much appreciated by the other users of
the machine, of which there may have been dozens.
<p>
But how does one determine the current load average?  Unix kernels have
maintained those statistics for decades, but they originally kept that
information to themselves.  User-space code that wanted to know this number
would have to do the following:
<p>
<ul class="spacylist">
<li> Read the symbol table from the executable image of the current kernel
     to determine the location of the <tt>avenrun</tt> array.
<li> Open <tt>/dev/kmem</tt> and seek to that location.
<li> Read the <tt>avenrun</tt> array into a user-space buffer.
</ul>
<p>
Code from that era can be hard to find, but the truly masochistic can wade
through what must be one of the deeper circles of <tt>#ifdef</tt> hell to
find an implementation toward the bottom of <a
href="https://opensource.apple.com/source/gnumake/gnumake-131/getloadavg.c.auto.html">this
version of <tt>getloadavg()</tt></a> from an early GNU <tt>make</tt>
release.  In a current Linux system, instead, all that is needed is to read
a line from <tt>/proc/loadavg</tt>.
<p>
This kind of grubbing around in kernel memory was not limited to the
load-average array.  Tools with more complex information requirements also
had to dig around in <tt>/dev/kmem</tt>; see, for example, <a
href="https://www.tuhs.org/cgi-bin/utree.pl?file=2.9BSD/usr/src/cmd/ps/ps.c">the
2.9BSD implementation of <tt>ps</tt></a>.  That was just how things were
done in those days.
<p>
Rooting through the kernel's memory for information about the system has a
number of problems beyond the need to implement <tt>/dev/kmem</tt>.
Changes to the kernel could break user space in surprising ways.  Multiple
reads were often needed to get a complete picture, but that picture could
change while the reads were taking place, leading to more surprises.  The
move away from <tt>/dev/kmem</tt> and toward well-defined kernel
interfaces, such as <tt>/proc</tt>, sysfs, and various system calls, has
cleaned this situation up — and made it possible to disable
<tt>/dev/kmem</tt>.
<p>
Now, it seems that <tt>/dev/kmem</tt> will go away entirely.  Linus
Torvalds <a
href="/ml/linux-kernel/CAHk-=wg1HTbXkjdMYA4zADEiE8HwpZ0=uWy0ujZTJYVT-KCehQ@mail.gmail.com/">said</a>
that he would "<q>happily do this for the next merge window</q>", but
he wanted confirmation that distributors are, indeed, not enabling it now.
There have been a few responses for specific distributions, but nobody has
said that <tt>/dev/kmem</tt> is still in use anywhere.  If there <i>are</i>
users of this interface out there, they will want to make their existence
known in the near future.  Failing that, this back door into kernel memory
will soon be removed entirely — but, then, your editor <a
href="/Articles/147901/">once predicted</a> that it would be removed for
2.6.14, so one never knows.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#devkmem">/dev/kmem</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/851531/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor851650"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 16:04 UTC (Mon)
                               by <b>michaelkjohnson</b> (subscriber, #41438)
                              [<a href="/Articles/851650/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, that took a while.<br>
<p>
Not needing /dev/kmem was one of the points when I first created procps lo these many years ago.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851650/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851660"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 17:31 UTC (Mon)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/851660/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Did you call it &quot;procps&quot; because it&#x27;s a ps that uses /proc rather than other methods?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851660/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, procps from /proc ps</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 20:30 UTC (Mon)
                               by <b>michaelkjohnson</b> (subscriber, #41438)
                              [<a href="/Articles/851684/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, that was the source of the name.<br>
<p>
The original ps for Linux, often requiring rebuild after a new kernel build, if any of the structures had changed, used /dev/kmem. And after procps was released, the original ps was sometimes referred to as &quot;kmem ps&quot; to differentiate.<br>
<p>
The original proc filesystem did not have enough functionality for a full replacement version of ps. I modified it to have all the necessary data for ps and uptime, and then wrote procps as a suite of programs that used the new functionality.<br>
<p>
The output was formatted compactly (keep in mind this was when a 386sx16 was a decent machine) and I separated the stat and statm files because of the expense of producing the statm data, then in ps I kept track of whether statm needed to be read in order to produce the output.<br>
<p>
As far as I know, my original procps was the original implementation of ps that defaulted to sorted output. All versions of ps that directly read /dev/kmem, as far as I know, listed the data in the order it happened to find it in the kernel memory it was digging through, and I was tired of juggling sort arguments when invoking ps.<br>
<p>
I believe my original procps was also among the first, if not the first, to just recognize both BSD or SysV command line arguments and do what you meant, rather than requiring you to remember which syntax you needed to use on this particular system.<br>
<p>
In any case, I don&#x27;t know whether I was actually the first to introduce either or both of sorting internally and honoring both BSD and SysV arguments, or if one or both were previously invented and I unknowingly reimplemented ideas that already existed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, procps from /proc ps</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 11:40 UTC (Tue)
                               by <b>lyda</b> (subscriber, #7429)
                              [<a href="/Articles/851725/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can&#x27;t remember exactly why, but I had to look for a process in C on SCO once and discovered that the two ways to do it were to pull it out of /dev/kmem or to parse ps output. Massive gaping hole in libc in my mind. The /proc fs is a good unix-y solution.<br>
<p>
I can imagine switching to it saved a massive amount of hassle.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851880"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, procps from /proc ps</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2021 17:05 UTC (Wed)
                               by <b>quanstro</b> (guest, #77996)
                              [<a href="/Articles/851880/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
procfs goes back to at least 8ed in 1984, and was included (and expanded) in plan 9 from the beginning.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851880/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851895"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux proc influence</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2021 0:58 UTC (Thu)
                               by <b>michaelkjohnson</b> (subscriber, #41438)
                              [<a href="/Articles/851895/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My confident recollection is that the initial implementation of the Linux proc filesystem was explicitly inspired by plan 9&#x27;s proc filesystem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851895/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor852134"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux proc influence</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 9, 2021 17:49 UTC (Fri)
                               by <b>quanstro</b> (guest, #77996)
                              [<a href="/Articles/852134/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
i recall that as well.  at the time, nobody had access to plan 9.  so linux /proc was inspired by _papers_ about plan9&#x27;s /proc.  one of the things linux missed---perhaps because the plan 9 implementation was not visible---was a dirt cheep way to have lots of little single-job file systems.  so linux /proc acquired a few warts.  there is more to implement in a linux file system than 9p.  but perhaps the 9p subset is good enough for most cases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/852134/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor851905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Yes, procps from /proc ps</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2021 3:52 UTC (Thu)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/851905/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given variations in proc, ps is still the portable solution, sadly.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor851716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">how I remember the history</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 13:09 UTC (Tue)
                               by <b>acahalan</b> (guest, #151496)
                              [<a href="/Articles/851716/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Somebody wrote the original ps.<br>
<p>
Based on that, Michael K Johnson wrote the procps.<br>
<p>
Somebody else ended up maintaining procps for a while, adding color to the output, but then not much happened.<br>
<p>
Michael K Johnson, then at Red Hat, decided (was told?) to maintain procps. He reverted to the pre-color version of the code. He put out a call for help, and Albert Cahalan responded with the suggestion that ps support both BSD and SysV syntax like OSF/1 (later renamed Tru64 then Digital UNIX) and AIX did. This would have been 1996 probably, or perhaps 1997. Sorted output was possible, but I don&#x27;t believe it was the default. It should not be the default, mainly because ps is often used when a system is low on memory but also because partial output is desirable when running on a failing kernel. Sorting with the &quot;O&quot; option appears to have a BSD origin.<br>
<p>
Albert Cahalan rewrote procps, initially just to prove that it would be possible to go beyond what OSF/1 and AIX could do, parsing mixed BSD and SysV options. (OSF/1 could only do one or the other, not mixed) There was then some human conflict relating to &quot;ps -aux&quot; printing a warning. Craig Small over at Debian started using Albert Cahalan&#x27;s new code. This code definitely did not sort by default.<br>
<p>
Michael K Johnson turned over a CVS repository to Rick van Riel and Ingo Molnar, excluding Albert Cahalan without explanation. This was almost certainly in 1997. Albert Cahalan then put a version 3.x.x on sourceforge, where he maintained procps for about a decade. At some point the 2.x.x version was made unreliable, grouping processes as threads if they happened to share various attributes as procps non-atomically looked at them. Albert Cahalan instead enhanced the /proc filesystem by adding the /proc/*/task/ directories and the thread counts. All distributions, including Red Hat, switched over to Albert Cahalan&#x27;s procps 3.x.x code.<br>
<p>
After about a decade maintaining procps, Albert Cahalan became too busy due to a large family. Also, he was demotivated because he found that it was impossible to stop Red Hat from hacking things up in ways that would add bugs and ill-considered compatibility troubles. This led to Craig Small, the Debian package maintainer, joining up with some other people to start the 4.x.x version series elsewhere.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851827"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Well, we remember some different things...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2021 2:10 UTC (Wed)
                               by <b>michaelkjohnson</b> (subscriber, #41438)
                              [<a href="/Articles/851827/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I found some old tarballs to refresh my memory. ☺<br>
<p>
Branko Lankester built kmem ps that came earlier.<br>
<p>
In the earliest procps version I found (0.7), I already tried to honor at least SysV arguments e and f for people whose fingers had been trained on SysV, but provided BSD-style output regardless. Your rewrite implemented multiple personalities, which was naturally much better.<br>
<p>
It looks like I introduced sorting output in version 0.93 in April 1994, later than I recalled, but before I was aware of you doing work on procps. That version definitely sorts by default, and the &quot;o&quot; option toggles sorting. I also clearly failed to update the man page along with that new feature.<br>
<p>
Your memory of the transition is different from mine. I was doing a poor job of being maintainer (slow to apply patches and do new releases) but I certainly didn&#x27;t &quot;revert&quot; color support, though I suspect it was there in a patch or fork that I hadn&#x27;t adopted. A fork was the obvious response to an unresponsive maintainer, so no complaints there! I did finally step back formally.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851827/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor852025"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Well, we remember some different things...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2021 21:17 UTC (Thu)
                               by <b>Kamilion</b> (subscriber, #42576)
                              [<a href="/Articles/852025/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wow, big thanks to Albert Cahalan and Michael K. Johnson for showing up and taking the time to explain to us johnny-come-latelys.<br>
<p>
Took me a moment to look at the poster&#x27;s names and realize they were the very people involved.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/852025/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor851906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">how I remember the history</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 8, 2021 3:58 UTC (Thu)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/851906/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The warning on ps -aux led to<br>
<p>
export I_WANT_A_BROKEN_PS=shutup<br>
<p>
Being part of my .profile on Linux for many years. At some point around 2012 I realized I didn&#x27;t need it anymore.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor851665"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 17:56 UTC (Mon)
                               by <b>nickodell</b> (subscriber, #125165)
                              [<a href="/Articles/851665/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But how does one determine the current load average? Unix kernels have maintained those statistics for decades, but they originally kept that information to themselves. User-space code that wanted to know this number would have to do the following:</font><br>
<p>
<font class="QuotedText">&gt; * Read the symbol table from the executable image of the current kernel to determine the location of the avenrun array.</font><br>
<font class="QuotedText">&gt; * Open /dev/kmem and seek to that location.</font><br>
<font class="QuotedText">&gt; * Read the avenrun array into a user-space buffer.</font><br>
<p>
How did unprivileged code determine the load average? Were unprivileged users allowed to read /dev/kmem in the past?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851665/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851673"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 18:15 UTC (Mon)
                               by <b>sjfriedl</b> (<b>&#x272D; supporter &#x272D;</b>, #10111)
                              [<a href="/Articles/851673/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; How did unprivileged code determine the load average?</font><br>
<p>
I think the `ps` command was setuid root; what could go wrong? :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851673/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor851715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 3:56 UTC (Tue)
                               by <b>markh</b> (subscriber, #33984)
                              [<a href="/Articles/851715/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
/dev/kmem was readable by group kmem, so programs requiring access to it could be made setgid kmem.  (That is still the case for /dev/mem and /dev/port.)  It&#x27;s still a security concern, but better than requiring setuid root.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851728"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">group kmem ~= root</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 12:08 UTC (Tue)
                               by <b>michaelkjohnson</b> (subscriber, #41438)
                              [<a href="/Articles/851728/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Given the information available in /dev/kmem, setgid kmem is insignificantly different from setuid root. It <i>feels</i> better, but in the end it needs to be treated the same from a security perspective.
      
          <div class="CommentReplyButton">
            <form action="/Articles/851728/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor851734"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 13:53 UTC (Tue)
                               by <b>foxcrisp</b> (guest, #52781)
                              [<a href="/Articles/851734/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Earlier unixes required apps to read from /dev/kmem, and know the format of the kernel data structures and location. Linux changed all of that, by exposing most things via /proc - mostly simple text strings. In a security based world, /dev/mem and /dev/kmem are just holes to allow access to any part of memory. Whilst the early implementations used unix group permissions, that just meant delegating the security mechanisms to the group mechanisms. That simply opens up the surface area (either get your self root, or get access to the relevant group for reading /dev/kmem).<br>
<p>
In a sandboxed container, one doesnt need /dev/kmem, so, one could argue that if its not needed by some apps, it is not needed by any apps. <br>
<p>
It is a shame if we lose it, but few apps truly needed it (I used it for dtrace, a while back - but would have to research the proposed alternatives).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851734/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor852185"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 10, 2021 17:45 UTC (Sat)
                               by <b>quanstro</b> (guest, #77996)
                              [<a href="/Articles/852185/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
i suppose if you consider mainstream *nix variants, linux may have been first.  however, 8th edition unix introduced the concept of /proc.  and iirc, linux was inspired by plan 9, not 8th edition.  in plan 9 there is extra expressiveness.  for example, /proc allows inspection of another machine&#x27;s processes without endian/word size concerns via mount and bind.  this is how stats(1) works.  ioctl is similarly not included.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/852185/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor851676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 18:34 UTC (Mon)
                               by <b>ribalda</b> (subscriber, #58945)
                              [<a href="/Articles/851676/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Am I the only one that was using:<br>
<p>
cat /dev/kmem &gt; core<br>
gdb vmlinux core<br>
<p>
To debug the current state of the kernel/drivers?<br>
<p>
Of course, never enabled in production. But for bringup is extremely helpful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851678"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 18:43 UTC (Mon)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/851678/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can do that with /proc/kcore now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851678/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor851689"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 21:05 UTC (Mon)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/851689/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fortunately, eBPF can replace these legacy /dev/kmem uses.<br>
<p>
/me runs<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851689/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851731"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 12:39 UTC (Tue)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/851731/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
eBPF can feel pretty limiting sometimes. Thankfully there are Systemtap Guru scripts for all my &quot;poke at kernel structures without manually writing a module&quot; needs :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851731/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor851691"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 5, 2021 21:36 UTC (Mon)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/851691/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
“ but the truly masochistic can wade through what must be one of the deeper circles of #ifdef hell”<br>
My God.  You were *not* kidding about the ifdefs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851691/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 14:03 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/851735/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hah, that&#x27;s nothing! The original home of nightmares is xterm, and while there is no easily web-accessible canonical xterm source (only tarballs), there are random github mirrors I can point at. Look at main() here: <a href="https://github.com/joejulian/xterm/blob/master/main.c">https://github.com/joejulian/xterm/blob/master/main.c</a>. Look at the wonderful tangle in Tinput() here: <a href="https://github.com/joejulian/xterm/blob/master/Tekproc.c">https://github.com/joejulian/xterm/blob/master/Tekproc.c</a>. Then fear, for this is code people are still using. (Though it could be worse still. It could be procmail.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851859"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2021 14:52 UTC (Wed)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/851859/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh god, that is .... wow. 😂 <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851859/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor855218"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 3, 2021 17:31 UTC (Mon)
                               by <b>jjulian</b> (guest, #152040)
                              [<a href="/Articles/855218/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
* Disclaimer: I have nothing to do with any of this! :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/855218/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor851778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 16:17 UTC (Tue)
                               by <b>shakkhar</b> (guest, #117388)
                              [<a href="/Articles/851778/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In the distant past, when computers were scarce and it was common to run many tasks on the same machine, jobs that were not time-critical would often consult the load average and defer their work if it was too high. </font><br>
<p>
Can anyone share algorithm / code / doc which exemplifies this practice?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor851779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 16:24 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/851779/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Look at sendmail, for example; it will stop processing mail if the system gets too busy.
      
          <div class="CommentReplyButton">
            <form action="/Articles/851779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor851783"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 6, 2021 16:53 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/851783/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not Unix, but I worked on minis, and I set up a bunch of work queues with very strict limits, so if you wanted to fire off a load of jobs you could hammer the system without impacting everyone, My favourite was the &quot;quick&quot; queue, which ran at highest priority, but had a wall-clock-limit of 30 seconds. If it over-ran that it just got killed.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851783/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor851830"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 7, 2021 2:50 UTC (Wed)
                               by <b>songmaster</b> (subscriber, #1748)
                              [<a href="/Articles/851830/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This isn’t an example of reading the loadavg values, but for some code that goes delving into the internals of the OS to get data out of it I recommend looking at the legacy branch of the lsof program at <a href="https://github.com/lsof-org/lsof/tree/legacy">https://github.com/lsof-org/lsof/tree/legacy</a>. It supported many versions of Unix, and had to find and extract many different pieces of data to generate its output. The 00PORTING file at <a href="https://github.com/lsof-org/lsof/blob/legacy/00PORTING">https://github.com/lsof-org/lsof/blob/legacy/00PORTING</a> mentions briefly how it actually did that, and even takes a dig at “some down-sides to the Linux /proc-based lsof.”<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/851830/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor880731"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Killing off /dev/kmem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2022 16:11 UTC (Sat)
                               by <b>aCOSwt</b> (guest, #156120)
                              [<a href="/Articles/880731/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;The occasional user-space device driver still needs /dev/mem to function, but it&#x27;s otherwise unused.&quot;<br>
<p>
AFAIU lilo-24.2 (latest) would also be happy to use it :<br>
<p>
if ((fd=open(DEV_DIR &quot;/mem&quot;, O_RDONLY)) &lt; 0) return buf_valid=1;<br>
<p>
(from the fetch function in probe.c)<br>
<p>
this in order to determine misc. hardware (floppies / disks / video ) related information.<br>
<p>
OK no harm if it cannot, lilo will just print a warning.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880731/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
