        <!DOCTYPE html>
        <html lang="en">
        <head><title>Completing the pidfd API [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/794707/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/794647/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/794707/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Completing the pidfd API</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 26, 2019</br>
           </div>
Over the last few kernel releases, the kernel has gained the concept of a
"pidfd" — a file descriptor that represents a process.  What started as a
way of sending signals to processes without race conditions has evolved
into a more complete process-management interface.  Now one of the last
pieces is being put into place: the ability to wait for processes using
pidfds.  But, naturally, that API has had to go through some revisions
first.
<p>
<h4>A pidfd recap</h4>
<p>
Unix-like systems traditionally represent many objects as files, but
processes have always been an exception.  They are, instead, represented by
process IDs (PIDs), which are small integers — limited to 32767 by default,
though that limit can be raised on Linux systems.  There are a few problems
with this representation, but the biggest one is arguably that PIDs are
reused; when a process exits, its PID can be assigned to a new, unrelated
process, and this can happen quickly.  That creates a race condition where
code that operates on a process, most often by sending it a signal, might
end up performing an action on the wrong process.
<p>
A pidfd is, instead, a file descriptor that refers to an existing process.
Once the pidfd exists, it will only refer to that one process, so it can be
used to send signals without worry that the wrong process might end up
being the recipient.  This feature is valuable enough that some
process-management systems, most notably the one used by Android, are being
rewritten to take advantage of it.
<p>
There are two ways to create a pidfd.  The preferred method in most cases
will be to supply the <tt>CLONE_PIDFD</tt> flag to the <a
href="http://man7.org/linux/man-pages/man2/clone.2.html"><tt>clone()</tt></a>
system call (or perhaps <a href="/Articles/792628/"><tt>clone3()</tt></a>
in the future); upon successful process creation, a pidfd representing the
child will be returned to the parent.  It is also possible to create a
pidfd for an existing process with <a
href="/Articles/789023/"><tt>pidfd_open()</tt></a>, which was merged for
the 5.3 kernel.
<p>
A process holding a pidfd for a process can send a signal to that process
using <tt>pidfd_send_signal()</tt>:
<p>
<pre>
    int pidfd_send_signal(int pidfd, int signal, siginfo_t *info, unsigned int flags);
</pre>
<p>
The 5.3 kernel also adds the ability to pass a pidfd to <a
href="http://man7.org/linux/man-pages/man2/poll.2.html"><tt>poll()</tt></a>,
which will provide a notification when the process represented by that
pidfd exits.
<p>
<h4>Waiting on a pidfd</h4>
<p>
While it is now possible to use <tt>poll()</tt> to learn when a process has
exited, that is not a complete solution for process-management systems,
which need to be able to wait for specific processes and reap the exit
information once they are done.  That requires some sort of variant on the
<a
href="http://man7.org/linux/man-pages/man2/waitpid.2.html"><tt>wait()</tt></a>
system call.  To fill in that gap, Christian Brauner <a
href="/ml/linux-kernel/20190724144651.28272-1-christian@brauner.io/">proposed</a>
the addition of yet another new system call:
<p>
<pre>
    int pidfd_wait(int pidfd, int *stat_addr, siginfo_t *info,
    		   struct rusage *rusage, int states, int flags);
</pre>
<p>
This call would wait for the given <tt>pidfd</tt>; the <tt>states</tt>
parameter can be used to specify which state transitions (<tt>WSTOPPED</tt>
for when the process receives a stop signal, for example) to wait for.  The
<tt>flags</tt> field offers additional options, including <tt>WNOHANG</tt>
for non-blocking operation; see the above-linked patch cover letter for the
full list.
<p>
This call, Brauner said, is "<q>one of the few missing pieces to make it
possible to manage processes using only pidfds</q>".  It is destined to
remain missing, though, at least in that form; Linus Torvalds <a
href="/ml/linux-kernel/CAHk-=whZPKzbPQftNGFB=iaSZGTSXNkhUASWF2V53MwB+A4zAQ@mail.gmail.com/">made
it clear</a> that he didn't like it.  He had no objection to the desired
functionality, but questioned the need for a new system call; instead, he
said, the <tt>waitid()</tt> system call should simply be extended with a
new flag.
<p>
That is exactly what was done in <a
href="/ml/linux-kernel/20190726093934.13557-1-christian@brauner.io/">a new
patch series</a> posted by Brauner;  <tt>waitid()</tt> has gained a new
<tt>P_PIDFD</tt> ID-type value that causes the given ID to be interpreted
as a pidfd.  This approach ended up being a rather smaller patch that does
not need to add a new system call; there have been no responses to it as of
this writing, but it would be unsurprising if this change were to be merged
for 5.4.
<p>
Beyond the ability to unambiguously specify which process should be waited
for, this change will eventually enable another interesting feature: it
will make it possible 
to wait for a process that is not a child — something that
<tt>waitid()</tt> cannot do now.  Since a pidfd is a file descriptor, it
can be passed to another process via an <tt>SCM_RIGHTS</tt> datagram in the
usual manner.  The recipient of a pidfd will, once this functionality is
completed, be able to use it in most of the ways
that the parent can to operate on (or wait for) the associated process.
<p>
There was one other interesting piece in the original <tt>pidfd_wait()</tt>
proposal: <a
href="/ml/linux-kernel/20190724144651.28272-5-christian@brauner.io/">a new
<tt>clone()</tt> flag (<tt>CLONE_WAIT_PID</tt>)</a> that would
cause the newly created process to be invisible to most <tt>wait()</tt>
calls.  Only a variant of <tt>wait()</tt> that specified that process in
particular (by specifying its pidfd, for example) would be able to reap its
exit information.  There are a few use cases for this functionality; one
that was listed is a library that needs to create a helper process that
won't show up if the calling application calls <tt>wait()</tt>.  This
feature was not part of the second patch set, but is expected to show up in
a separate posting in the near future.
<p>
There will almost certainly be other pidfd-oriented enhancements in the
future; this feature is new and should not be considered to be complete.
But the ability to wait on a pidfd might be seen as the end of the first
round of development for the pidfd concept.  It has been a relatively quiet
set of changes, but the move to pidfds is a fundamental change in how
processes are managed on Linux systems.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#pidfd">pidfd</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/794707/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor794729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2019 21:10 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/794729/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it would be better to extent poll() to allow it to receive the exit information of the process (maybe read the exit info. from the pidfd).  That way, a thread could wait for process termination and socket activity at the same time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794733"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2019 22:42 UTC (Fri)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/794733/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, that seems like an obvious thing to want.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794733/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor794736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 2:45 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/794736/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
poll on pidfds already works<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794737"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 3:01 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/794737/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But not read() afterwards.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794737/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 3:15 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/794738/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, but doesn't pidfd_wait serve the role of read?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794739"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 3:19 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/794739/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, yes. But we're getting a waitid() flag instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794739/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794741"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 3:28 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/794741/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Spelling differences. Doesn't change the model.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794741/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794750"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 11:47 UTC (Sat)
                               by <b>ale2018</b> (guest, #128727)
                              [<a href="/Articles/794750/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Since it is an fd, it would seem natural to expect to be able to read or write to it.  Reading a bit when the process exits is not quite managing, say, a pipe.  A pipe?!  Hm...  stdpid?<br>
<p>
How do I know if the process is busy crunching, sleeping, or waiting for input?<br>
<p>
Just fooling...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794750/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2019 0:53 UTC (Sun)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/794779/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is not a useful comment. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor794874"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 30, 2019 9:21 UTC (Tue)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/794874/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We need to be very careful about adding read()/write() support to control-related fds -- because you can always spawn a setuid program with a different set of stdio fds and potentially trick it into reading/writing something that was not intended to the control fd (and if the permission checks aren't done on open()-time then you have just created a security bug).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794874/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795047"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 1, 2019 7:16 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/795047/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the lesson of this is probably not to introduce any new setuid programs anymore, and do privilege elevation only by IPC.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795047/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor795155"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2019 9:14 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/795155/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We should probably replace CAP_SYS_ADMIN programs (e.g. ffmpeg kmsgrab without running explicitly as root) with IPC first. setuid is less subversive, as at least it's visible in ls. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/795155/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor794780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2019 1:02 UTC (Sun)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/794780/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I see now.  Just poll() for whatever processes/sockets you want.  When the poll() returns saying the process has exited, use pidfd_wait() to get the result.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor794734"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2019 22:53 UTC (Fri)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/794734/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The discussion does not mention how this interacts with ptrace. rr could potentially benefit from the ability to hand ptrace control of a traced task from one ptracer process to another. I guess even if some pidfd-based API let other processes read wait statuses, those other process still wouldn't be able to execute ptrace() commands because they're not the (sole) ptracer of the traced tasks.<br>
<p>
Another question is whether this new API follows the ptrace/waitpid behavior, i.e. each ptraced thread of a process reports exit independently and is independently reaped. I really want that to be true, because that would give us a sane and reliable way to wait for some specific subset of all traced threads to exit, which is currently impossible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794734/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor797463"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2019 19:17 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/797463/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The fact that it's modelled on waitid() suggests not. waitid() throws away some of the ptrace()-necessary info waitpid() packs into its return value, so you can't use it if you're doing ptrace monitoring (though this is nowhere documented that I can see: you have to reverse-engineer it from the code and from the fact that the ptrace documentation never once mentions waitpid).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/797463/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor794770"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 20:07 UTC (Sat)
                               by <b>doublez13</b> (guest, #122213)
                              [<a href="/Articles/794770/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can we get a link to the patches/RFCs for the Android work mentioned? Thanks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794770/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 27, 2019 20:17 UTC (Sat)
                               by <b>brauner</b> (subscriber, #109349)
                              [<a href="/Articles/794771/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not sure about the actual LMKD work but the backports for the kernels at least do exist:<br>
<a href="https://android-review.googlesource.com/q/topic:%22pidfd+polling+support+4.9+backport%22">https://android-review.googlesource.com/q/topic:%22pidfd+...</a><br>
<a href="https://android-review.googlesource.com/q/topic:%22pidfd+polling+support+4.14+backport%22">https://android-review.googlesource.com/q/topic:%22pidfd+...</a><br>
<a href="https://android-review.googlesource.com/q/topic:%22pidfd+polling+support+4.19+backport%22">https://android-review.googlesource.com/q/topic:%22pidfd+...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2019 0:47 UTC (Sun)
                               by <b>doublez13</b> (guest, #122213)
                              [<a href="/Articles/794778/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you! :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor794812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 28, 2019 22:34 UTC (Sun)
                               by <b>naptastic</b> (guest, #60139)
                              [<a href="/Articles/794812/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm really excited to see this work happening, even though most of my work is far removed from the kernel.<br>
<p>
I think BSD saw the (valid, real) problems with /proc and took the wrong lesson, where Linux is now converging on something smarter: providing an even more UNIXy interface ("a process is now also a file") to the process space. I'm looking forward to using this functionality, even if only indirectly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 29, 2019 10:19 UTC (Mon)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/794817/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FreeBSD has had pdfork for almost 8 years (9.0 released Jan 2012): <a href="https://www.freebsd.org/cgi/man.cgi?query=pdfork&amp;sektion=2">https://www.freebsd.org/cgi/man.cgi?query=pdfork&amp;sekt...</a><br>
<p>
The real dilemma after this is how to acquire process fds when children fork. The BSD kqueue framework has permitted tracking forks and exits of descendants since almost the beginning[1], though there's still no mechanism to acquire a process fd for them.<br>
<p>
I mention this because there's no grand theory for a better process model, unless you count Capsicum from whence pdfork came. But in the Capsicum security model forking is normally disabled in descendants. Arguably one of the reasons it's taken Linux so long to get a process fd is precisely because of all the open ended questions about where to go next, which while unanswered have the effect of casting doubt on the utility of process fds, notwithstanding that most people agree that in the abstract they're a great idea.<br>
<p>
[1] Sometime between 1999, when kqueue was originally merged, and 2003, the earliest hit I got with a naive Google search.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor801597"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2019 2:45 UTC (Tue)
                               by <b>rvk</b> (guest, #111525)
                              [<a href="/Articles/801597/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would be nice to get this working with process events connector.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/801597/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor813850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2020 3:46 UTC (Thu)
                               by <b>re:fi.64</b> (subscriber, #132628)
                              [<a href="/Articles/813850/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Beyond the ability to unambiguously specify which process should be waited for, this change will eventually enable another interesting feature: it will make it possible to wait for a process that is not a child — something that waitid() cannot do now. </font><br>
<p>
I think this is false, at least having tried it waitid will always return ESRCH.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813851"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2020 3:50 UTC (Thu)
                               by <b>re:fi.64</b> (subscriber, #132628)
                              [<a href="/Articles/813851/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whoops, minor amendment: ECHILD, not ESRCH<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813851/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor934565"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2023 2:44 UTC (Wed)
                               by <b>jredfox_</b> (guest, #165585)
                              [<a href="/Articles/934565/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a quick fix for an invalid solution. the proper solution is the PID solution. you should have in the arguments PID-CREATIONTIME where creation time is MS preferably. I don't like JIFFIES or UNIX seconds it's not precise enough.<br>
<p>
Or an even better solution create a call called reservePID(unsigned long PID). this will reserve the PID until the process that called it is closed. For security reasons it should limit the number of reserves it can use to about 200 PID's for IPC(unrelated non child process's) per process and unlimited amount for child process's. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/934565/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor934568"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2023 5:07 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/934568/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; you should have in the arguments PID-CREATIONTIME where creation time is MS preferably. I don't like JIFFIES or UNIX seconds it's not precise enough.</span><br>
<p>
Why not UUIDs then?<br>
<p>
And pidreserve doesn't prevent all race attacks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/934568/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor934693"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 14, 2023 23:23 UTC (Wed)
                               by <b>jredfox_</b> (guest, #165585)
                              [<a href="/Articles/934693/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
UUIDS MS creation time is way over 700! Also UUID collisions can and have occurred. currentMS states the current ms the creation time was fetched and the creation time of the process never changes. UUID's are problematic <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/934693/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor934703"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 15, 2023 1:42 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/934703/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Version 1 and 2 UUIDs include system time, so they can't collide unless the kernel is compromised.<br>
<p>
But more practically, your system with time-based IDs is just ugly, just like UUIDs.<br>
<p>
And pidreserve() won't help against targeted wraparound attacks. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/934703/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor943711"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 6, 2023 16:59 UTC (Wed)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/943711/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Does this get rid of some shared data-structure in the kernel that maps PIDs to the actual resources of the process? I ask because I noticed that with pthreads one can write "pthread_detach(pthread_self())" to detach yourself, whereas presumably detaching yourself via a pidfd you got from "yourself" would be a no-op as any resources would be held open by the other pidfd opened by your parent thread. I noticed this when implementing pthreads/c11 threads on windows, where threads are represented by HANDLES that are recounted and work similarly to files. On windows I came to the conclusion that allowing threads to detach themselves would require a shared data-structure holding the mapping of PIDs to HANDLES.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/943711/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor994535"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Completing the pidfd API</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 17, 2024 0:34 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/994535/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;one can write "pthread_detach(pthread_self())" to detach yourself, whereas presumably detaching yourself via a pidfd you got from "yourself" would be a no-op</span><br>
<p>
In glibc-nptl, pthread_self and _detach are functions that involve just userspace. There is not going to be a deadlock/deadlock-avoiding-noop as you envisioned.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/994535/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
