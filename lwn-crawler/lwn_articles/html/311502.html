        <!DOCTYPE html>
        <html lang="en">
        <head><title>SLQB - and then there were four [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/311502/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/310739/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/311502/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>SLQB - and then there were four</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 16, 2008</br>
           </div>
The Linux kernel does not lack for low-level memory managers.  The
venerable slab allocator has been the engine behind functions like
<tt>kmalloc()</tt> and <tt>kmem_cache_alloc()</tt> for many years.  More
recently, SLOB was added as a pared-down allocator suitable for systems
which do not have a whole lot of memory to manage in the first place.  Even
more recently, <a href="http://lwn.net/Articles/229984/">SLUB</a> went in
as a proposed replacement for slab which, while being designed with very large
systems in mind, was meant to be applicable to smaller systems as well.  The consensus
for the last year or so has been that at least one of these allocators is surplus
to requirements and should go.  Typically, slab is seen as the odd
allocator out, but nagging doubts about SLUB (and some performance
regressions in specific situations) have kept slab in the game.
<p>
Given this situation, one would not necessarily think that the kernel needs
yet another allocator.  But
Nick Piggin thinks that, despite the surfeit of low-level memory managers,
there is always room for one more.  To that end, he has developed the <a
href="http://lwn.net/Articles/311093/">SLQB allocator</a> which he hopes to
eventually see merged into the mainline.  According to Nick:
<p>
<div class="BigQuote">
	I've kept working on SLQB slab allocator because I don't agree with
	the design choices in SLUB, and I'm worried about the push to make
	it the one true allocator.
</div>
<p>
Like the other slab-like allocators, SLQB sits on top of the page allocator
and provides for allocation of fixed-sized objects.  It has been designed
with an eye toward scalability on high-end systems; it also makes a real
effort to avoid the allocation of compound pages whenever possible.
Avoidance of higher-order (compound page) allocations can improve
reliability significantly when memory gets tight.
<p>
While there is a fair amount of tricky code in SLQB, the core algorithms
are not that hard to understand.  Like the other slab-like allocators, it
implements the abstraction of a "slab cache" - a lookaside cache from
which memory objects of a fixed size can be allocated.  Slab caches are
used directly when memory is allocated with <tt>kmem_cache_alloc()</tt>, or
indirectly through functions like <tt>kmalloc()</tt>.  In SLQB, a slab
cache is
represented by a data structure which looks very approximately like the
following:
<p>
<img src="https://static.lwn.net/images/ns/kernel/slqb.png" width=641 height=362 
     alt="[SLQB slab data structure]">
<p>
(Note that, to simplify the diagram, a number of things have been glossed over).

<p>
The main <tt>kmem_cache</tt> structure contains the expected global
parameters - the size of the objects being allocated, the order of page
allocations, the name of the cache, etc.  But scalability means separating
processors from each other, so the bulk of the <tt>kmem_cache</tt> data
structure is stored in per-CPU form.  In particular, there is one
<tt>kmem_cache_cpu</tt> structure for each processor on the system.
<p>
Within that per-CPU structure one will find a number of lists of objects.
One of those (<tt>freelist</tt>) contains a list of available objects; when
a request is made to allocate an object, the free list will be consulted
first.  When objects are freed, they are returned to this list.  Since this
list is part of a per-CPU data structure, objects normally remain on the
same processor, minimizing cache line bouncing.  More importantly, the
allocation decisions are all done per-CPU, with no bad cache behavior and
no locking required beyond the disabling of interrupts.  The free list is
managed as a stack, so allocation requests will return the most recently
freed objects; again, this approach is taken in an attempt to optimize
memory cache behavior.
<p>
SLQB gets its memory in the form of full pages from the page allocator.
When an allocation request is made and the free list is empty, SLQB will
allocate a new page and return an object from that page.  The remaining
space on the page is organized into a per-page free list (assuming the
objects are small enough to pack more than one onto a page, of course), and
the page is added to the <tt>partial</tt> list.  The other objects on the
page will be handed out in response to allocation requests, but only when
the free list is empty.  When the final object on a page is allocated, SLQB
will forget about the page - temporarily, at least.
<p>
Objects are, when freed, added to <tt>freelist</tt>.  It is easy to foresee
that this list could grow to be quite large after a burst of system
activity.  Allowing 
<tt>freelist</tt> to grow without bound would risk tying up a lot of system
memory doing 
nothing while it is possibly needed elsewhere.  So, once the size of the
free list passes a watermark (or when the page allocator starts asking for
help freeing memory), objects in the free list will be flushed back to
their containing pages.  Any partial pages which are completely filled with
freed objects will then be returned back to the page allocator for use
elsewhere.
<p>
There is an interesting situation which arises here, though: remember that
SLQB is fundamentally a per-CPU allocator.  But there is nothing that
requires objects to be freed on the same CPU which allocated them.  Indeed,
for suitably long-lived objects on a system with many processors, it
becomes probable that objects will be freed on a different CPU.  That
processor does not know anything about the partial pages those objects were
allocated from, and, thus, cannot free them.  So a different approach has
to be taken.
<p>
That approach involves the maintenance of two more object lists, called
<tt>rlist</tt> 
and <tt>remote_free</tt>.  When the allocator tries to flush a
"remote" object (one allocated on a different CPU) from its local
<tt>freelist</tt>, it will simply move that object over to <tt>rlist</tt>.
Occasionally, the allocator will reach across CPUs to take the objects from
its local <tt>rlist</tt> and put them on <tt>remote_free</tt> list of the
CPU which initially allocated those objects.  That CPU can then choose to
reuse the objects or free them back to their containing pages.
<p>
The cross-CPU list operation clearly requires locking, so a spinlock
protects <tt>remote_free</tt>.  Working with the <tt>remote_free</tt> lists
too often would thus risk cache line bouncing and lock contention, both of
which are not helpful when scalability is a goal.  That is why processors
accumulate a group of objects in their local <tt>rlist</tt> before adding
the entire list, in a single operation, to the appropriate
<tt>remote_free</tt> list.  On top of that, the allocator does not often
check for 
objects in its local <tt>remote_free</tt> list.  Instead, objects are
allowed to accumulate there until a watermark is exceeded, at which point
whichever processor added the final objects will set the
<tt>remote_free_check</tt> flag.  The processor owning the
<tt>remote_free</tt> list will only check that list when this flag is set,
with the result that  the management of the
<tt>remote_free</tt> list can be done with little in the way of lock or
cache line contention.
<p>
The SLQB code is relatively new, and is likely to need a considerable
amount of work before it may find its way into the mainline.  Nick claims
benchmark results which are roughly comparable with those obtained using
the other allocators.  But "roughly comparable" will not, by itself, be
enough to motivate the addition of yet another memory allocator.  So
pushing SLQB beyond comparable and toward "clearly better" is likely to be
Nick's next task.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Slab_allocators">Memory management/Slab allocators</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Slab_allocator">Slab allocator</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/311502/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor311672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SQLB: and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 19:58 UTC (Tue)
                               by <b>Los__D</b> (guest, #15263)
                              [<a href="/Articles/311672/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hehe, it would seem we have an editor at big too fond of SQL ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SQLB: and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 20:16 UTC (Tue)
                               by <b>Los__D</b> (guest, #15263)
                              [<a href="/Articles/311682/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, corrected now.<br>
<p>
And damn I need a new keyboard (Ok, new fingers), "at big too"????<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor311683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 20:29 UTC (Tue)
                               by <b>riddochc</b> (guest, #43)
                              [<a href="/Articles/311683/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting. This calls for an explanation of the difference between the various allocators - it sounds, from this article, that they have a fair amount in common with each other.<br>
<p>
Any suggestions on how to pronounce SLQB? :)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 20:33 UTC (Tue)
                               by <b>proski</b> (subscriber, #104)
                              [<a href="/Articles/311684/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Perhaps we need a "Grumpy Editor's guide to kernel memory allocators" :-)
      
          <div class="CommentReplyButton">
            <form action="/Articles/311684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor311686"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 20:35 UTC (Tue)
                               by <b>BlueLightning</b> (subscriber, #38978)
                              [<a href="/Articles/311686/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about "slickwib"?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311686/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor311690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 20:41 UTC (Tue)
                               by <b>flewellyn</b> (subscriber, #5047)
                              [<a href="/Articles/311690/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p><i>Any suggestions on how to pronounce SLQB? :)</i></p>

<p>"Guppie."</p>

<p>No real reason, it's just that, since SLQB is unpronounceable, and all the others are variations of "slab", this would serve to differentiate it.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/311690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311699"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 21:37 UTC (Tue)
                               by <b>tao</b> (subscriber, #17563)
                              [<a href="/Articles/311699/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SlCube. It's O(n²) in complexity, and was created specifically to make the other MM's look better in comparison :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311699/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor311688"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pronouncing SLQB</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 20:41 UTC (Tue)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/311688/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>How about &quot;SLICK-bee&quot;?  Or &quot;sluh-CUE-bee&quot;?</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/311688/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor311769"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 12:58 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/311769/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>Simple as that - [&#603;s][&#603;l][kju&#720;][bi&#720;] or, localized for Germany, [&#603;s][&#603;l][ku&#720;][be&#720;].</p>

<p>BTW, I condone the use of English approximations such as bee for, eh well, English sounds. It does not help non-English speakers at all and only makes for loads of confusion (yes, I am referring to that sibling post above this one). Because that's [be&#720;] for some (most?) people outside the realm of the English language. Please, just &#9839; use IPA.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/311769/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311774"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 14:01 UTC (Wed)
                               by <b>Los__D</b> (guest, #15263)
                              [<a href="/Articles/311774/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Since this is an english speaking forum, english approximations are fine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311774/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor312330"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 20, 2008 12:09 UTC (Sat)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/312330/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is a written forum, not a spoken one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312330/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor312324"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">condone?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 20, 2008 11:40 UTC (Sat)
                               by <b>BradReed</b> (subscriber, #5917)
                              [<a href="/Articles/312324/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds more like you condemn the use, rather than condone it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312324/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor312331"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">condone?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 20, 2008 12:10 UTC (Sat)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/312331/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed so.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312331/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor312072"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free your inner dyslexic:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2008 17:49 UTC (Thu)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/312072/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Quibbles"<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312072/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor312150"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free your inner dyslexic:</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 19, 2008 3:47 UTC (Fri)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/312150/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OK, "Quibbles" wins by acclamation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312150/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor311697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 21:26 UTC (Tue)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/311697/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I wonder how well this algorithm will do in real life, considering the number of tunable watermarks it needs (size of freelist, size of rlist, size of remote_free, &hellip;).<p>Will it be self-tuning?  Even if yes, will whatever heuristics are used for this tuning stand up to dynamic situations?
      
          <div class="CommentReplyButton">
            <form action="/Articles/311697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 9:39 UTC (Wed)
                               by <b>Nick</b> (guest, #15060)
                              [<a href="/Articles/311756/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The SLAB allocator effectively has similar tunables and watermarks (number of objects in an array-cache, number of objects in l3 lists, alien caches, etc), and it performs very well in very many real world situations.<br>
<p>
SLQB uses lists rather than arrays, so it is also more flexible to tune at runtime than SLAB. But in practice it is very difficult to adjust the sizing of these kinds of things at runtime. I've taken the dumb easy (SLAB) way out of it and periodically trim down some of the lists. That can cut back memory usage for unused slabs, and they can grow back if needed (and trim is relatively infrequent so it doesn't harm performance).<br>
<p>
Thanks for the article, BTW. I feel like I understand the thing better myself now too :)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor311687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who merges?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 16, 2008 21:38 UTC (Tue)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/311687/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am happy to see SQLB emerge.  I hope Nick is in close contact with Paul McKenney on this subject; Paul wrote the allocator for Sequent's Dynix, and has had decades to think about his design choices.  <br>
<p>
I wonder, though, about the choice to hand all objects back to the CPU that originally allocated them.  In particular, suppose we have a large collection of objects freed by CPU A long after they have passed out of B's cache -- e.g., allocated on behalf of a process that has migrated to A.  It might be objectively better for CPU B to work on their metadata while it remains in B's cache.  Maybe it's better to re-map a fully freed page to an address range that B manages; if we know that CPU A won't be touching that page anyway, it may be unmapped from A's page map at leisure.<br>
<p>
I wonder, too, about all these lists.  Are the list links adjacent to the actual storage of the objects?  Often when an object is freed it has long since passed out of the cache, and touching a list link would bring it back in.  A way to avoid touching the actual object is for the metadata to be obtainable by address arithmetic, e.g. masking off the low bits to obtain the address of a page header.  Some extra structure helps -- a segment of adjacent pages on (say) a megabyte or gigabyte boundary can share a common header and an array of page headers, so that the containing pages need not be touched, either, and the metadata concentrated in a few busy cache lines.  Segment headers pingponging between CPUs would be a bad thing, but each segment might reserve a few cache lines for annotations by other CPUs.<br>
<p>
A design appropriate for hundreds of CPUs and hundreds of GB is very different from one for a single CPU and under a GB.  It's not clear that any existing SL*B is right for either case, or that any one can be for all.  Plenty of room remains for improvement in all regimes, so consolidation seems way premature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who merges?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 9:49 UTC (Wed)
                               by <b>Nick</b> (guest, #15060)
                              [<a href="/Articles/311757/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I haven't talked to Paul. I didn't know that.. but I should, now you mention it!<br>
<p>
Actually, within the same node, CPUs can allocate objects they've freed which have come from another CPU (on that node). When freeing an object to our freelist, the test that is performed is whether the object's memory is on the same node as the node this CPU is on. This is similar to what SLAB does, and indeed is good for cache (and object management overhead).<br>
<p>
Except in very special cases of slabs (RCU-ish ones), the linked list is part of the object itself (when the object is freed, nobody else by definition is using the memory). _Often_ in the kernel I'd say that when an object is freed it is probably recently been touched by the freeing CPU. It would be an unusual situation eg. to have a refcount to the object residing somewhere other than the object itself.<br>
<p>
And yes, we have the struct page structure for every page in the system, which can be found with calculations on the object address. And yes, all the slab allocators use this struct page to manage their slabs of objects :)<br>
<p>
I agree with your last paragraph too...<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who merges?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2008 1:00 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/311919/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe it's a mistake to store the refcounts with the objects.  Very often an object is allocated and initialized, and then never modified again, except for the refcount, and perhaps not even looked at again, until freed when the owning process dies.  If the allocator provided centralized storage for refcounts, they could be yanked out of the objects, reducing cache churn.  Centralizing refcounting could have other benefits, such as allowing optimizations for small counts and for small fluctuations in counts to be abstracted.<br>
<p>
Integrating refcounting would change the SLAB interface, but generic refcounting services could be added to all the allocators, providing another way for them to differentiate themselves.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who merges?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2008 8:41 UTC (Thu)
                               by <b>Nick</b> (guest, #15060)
                              [<a href="/Articles/311956/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't know how common that really is. For things allocated with significant frequency, I think they should be fairly cache hot at free time (because if they are allocated frequently, they shouldn't have long lifespans).<br>
<p>
The exception are caches, that are reclaimed when memory gets low or a watermark is reached (eg. inode cache, dentry cache, etc). However, with these things, they still need to be found in order to be reclaimed, usually via an LRU list, so the object gets hot when it's found and taken off the list.<br>
<p>
OK, you could move the refcount and the lru list into another area... but the other problem with that is that in cache objects you expect to have multiple lookups over the lifetime of the object. And if your lookups have to increment a disjoint refcount object, then you increase your cacheline footprint per lookup by effectively an entire line per object. So you trade slower lookups for faster reclaim, which could easily be a bad tradeoff if the cache is effective (which the dcache is, 99% of the time).<br>
<p>
Did you have any particular situations in mind?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor312102"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who merges?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 18, 2008 21:37 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/312102/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is the danger of armchair coding; you're probably right.<br>
<p>
An optimized refcount scheme may take only a few bits per object, for most objects, so I was thinking one cache line might hold refcounts for a hundred objects.  Also, a dirty cache line is way more expensive than a clean one (because it must be written back, and isn't a candidate for replacement until that's done) so I meant to concentrate the refcount churn, and segregate it from the (commonly) mostly-unchanging objects.  This helps most where you have some semblance of locality.  Unfortunately things like inode caches don't.<br>
<p>
As always, there's no substitute for measuring, but you have to build it first.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312102/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor312561"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Who merges?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 22, 2008 20:23 UTC (Mon)
                               by <b>bgamsa</b> (guest, #33057)
                              [<a href="/Articles/312561/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The design also has some resemblance to work I did at the University of Toronto for NUMA multiprocessors, which in turn was also based on Paul McKenney's work, although enough time has past that I no longer remember all of the details (and I'm not surprised at the resemblance since the driving factors haven't really changed).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/312561/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor311752"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 9:09 UTC (Wed)
                               by <b>iq-0</b> (subscriber, #36655)
                              [<a href="/Articles/311752/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it's a pretty neat/clean design. Though it probably has more overhead on very large number of CPUs system than SLUB. But it's a long time ago that I read about SLUB internals to be really sure.<br>
<p>
The big question is:<br>
Why not allocate from 'rlist' when you're done with your own freelist? We don't have to update the metadata so it's a very cheap operation.<br>
<p>
Pherhaps it would even be better to put items on 'rlist' to also be put on the 'freelist', so we simply allocate the least recently used item first (probably cache-hot).<br>
Sure the remote item might be bounced back to the other CPU, but clearly the code using it doesn't seem to mind which CPU last used it and with the LRU logic it's just as likely still in our CPU cache. And if it did bounce back in te meanwhile it means we are probably dealing with a slab cache that's not that hard used (or it's usage should be optimized and this would be true for all slab allocaters).<br>
<p>
And without having looked at the code I'd assume that only one CPU at a time is cleaning up it's 'rlist' and that usage of the 'remote_free' lock is only a "best effort" locking scheme (try_lock()-ish) because maintenance should really be a background task with minimal overhead. Though this might have problems I overlook (or is already done that way).<br>
<p>
Just some thoughts I had reading this text, nothing really thoroughly thought through though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311752/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 10:11 UTC (Wed)
                               by <b>Nick</b> (guest, #15060)
                              [<a href="/Articles/311758/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See my above comment -- effectively we do allocate from rlist if it is from the same node. Actually, what really happens is that objects from the same node but different CPU are freed straight onto our freelist rather than our rlist -- they only get sent to rlist when our freelist is trimmed. So it's exactly as you suggest.<br>
<p>
The issue of cleaning up rlist is interesting. There are so many ways this can be done and it is about the most difficult part of a slab allocator... No, any CPU can be cleaning its rlist at any time, and yes they might all point to a single remote CPU. That's quite unlikely and the critical section is very short, so hopefully it won't be a problem. But I don't claim to know what the best way to do it is.<br>
<p>
Very large number of CPUs I am definitely interested in... so I'm hoping to be as good or better than the other allocators here, but we'll see.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor311761"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 10:59 UTC (Wed)
                               by <b>sdalley</b> (subscriber, #18550)
                              [<a href="/Articles/311761/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Just some thoughts I had reading this text, nothing really thoroughly thought through though.</font><br>
<p>
.. and it's even harder to plough through those details with a tough cough and hiccough ...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/311761/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor311771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2008 13:05 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/311771/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>That reminds me of the <a href="http://www.youtube.com/watch?v=9IzDbNFDdP4&fmt=18">Being Bilingual</a> sketch. And as I see it, sdalley cheated on all four <code>/^th/</code> words. <code>:-)</code></p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/311771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor316551"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">SLQB - and then there were four</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2009 12:25 UTC (Sun)
                               by <b>tej.parkash</b> (guest, #51084)
                              [<a href="/Articles/316551/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
can someone explain me how "remote_free_check" flags accomplish the scalability issue. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/316551/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2008, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
