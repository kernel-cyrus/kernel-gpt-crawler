        <!DOCTYPE html>
        <html lang="en">
        <head><title>The PuzzleFS container filesystem [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/945320/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/945212/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/945320/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The PuzzleFS container filesystem</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 25, 2023</br>
           <hr>
<a href="/Archives/ConferenceByYear/#2023-Kangrejos">Kangrejos</a>
</div>
The last year or so has seen the posting of a few new filesystem types that
are aimed at supporting container workloads.  PuzzleFS, presented at the
2023 <a href="https://kangrejos.com/">Kangrejos</a> gathering by Ariel
Miculas, is another contender in this area, but it has some features of its
own, including a novel compression mechanism and an implementation written
in Rust.
<p>
PuzzleFS, Miculas began, is an immutable (and thus read-only) filesystem
that shares design goals with the <a
href="https://github.com/opencontainers/image-spec">Open Container
Initiative (OCI) v2 image specification</a>.  It uses content-defined
chunking (discussed further shortly) and a content-addressed data store,
with file data and metadata stored separately from each other.  The project
was started by Tycho Andersen in 2021 as an attempt to create a successor
to <a href="https://github.com/anuvu/atomfs">atomfs</a>.
<p>
The first version of the OCI image specification, he said, had a
number of problems, many of which are described in <a
href="https://www.cyphar.com/blog/post/20190121-ociv2-images-i-tar">this
2019 blog post</a> by Aleksa Sarai.  At the base of those problems is the
dependence on tar archives to hold the layers in the filesystem.  Tar, as
it turns out, is not well suited to the container filesystem problem.
<p>
The format, he said, is defined poorly. It has no index; instead, there is
just a header leading directly into the content.  The compression mechanism
used means that the filesystem image is not seekable; as a result, the
entire filesystem must be decompressed even to extract one little file.
There is no deduplication; even a small change means re-downloading the
entire thing, though layers can be used to work around that problem to an
extent.  It is machine-dependent, in that directory entries can be shown
in a different order on different systems.  The lack of a canonical
representation has led to a lot of extensions, many of which are solving
the same problem.
<p>
PuzzleFS is intended to solve these problems.  A filesystem image itself
consists of a set of files placed on an underlying filesystem.  As with the
OCI image format, there is a top-level <tt>index.json</tt> file that
contains a set of tags, each of which represents a versioned filesystem and
points to a manifest file.  The manifest file, in turn, points to an image
configuration and the data stored in the actual image layers.  Everything
else is stored as a set of blobs in the <tt>blobs/sha256</tt> directory.
<p>
Most data in the filesystem is broken into variable-size chunks, then
stored as blobs using the SHA256 hash of the content as the file name.  The
chunking itself is done with the <a
href="https://www.usenix.org/conference/atc16/technical-sessions/presentation/xia">FastCDC
algorithm</a>, which finds "cut points" where a data stream can be split
into blobs of varying sizes.  Any given stream (the contents of a file, for
example) might be split into five or 50 chunks, depending on how those cut
points are determined; each chunk then lands as a separate blob under
<tt>blobs/sha256</tt>, and its hash is added to the manifest.
<p>
The cut-point algorithm itself uses a sliding-window technique.  The data
is stepped through, byte by byte, and the hash of the last 48&nbsp;bytes
(for example) is calculated.  If the N least-significant bytes of that hash
are zero, then a cut point has been found; the data to that point is
separated into a separate blob and the process starts anew.
<p>
This algorithm has some interesting characteristics, perhaps most notably
its ability to perform deduplication and compression.  Since each chunk is
stored using its hash as the file name, chunks that are common to multiple
files will automatically be shared.  In traditional schemes, an update to a
file will cause the entire new file to be stored; this is especially true
if any bytes are inserted or deleted.  Inserting a single byte into a
traditionally compressed file will make the entire file after the insertion
look different.  With content-defined chunking, only the chunk containing
the change will differ, while the rest of the file will contain the same
chunks, perhaps at a different offset.
<p>
The results can be seen in an experiment that Miculas carried out.  He
downloaded ten different versions of Ubuntu 22.04 from the Docker Hub; they required
766MB to store in that form.  Putting them into the OCI image format
with compression reduced that size to 282MB.  Placing them all into a
PuzzleFS instance, instead, reduced the size to 130MB — without using
compression.  Adding compression cut the whole thing down to 53MB, a
savings of 93% from the original size.
<p>
A goal of PuzzleFS was to always provide a canonical representation of the
filesystem.  Thus, for example, the traversal order of the source from
which it is generated is defined, with both directories and extended
attributes being sorted lexicographically.
Another goal was direct mounting support.  With tar-based formats, the
files must first be extracted to an on-disk representation, creating a
window where things could be changed before mounting the image.  Thus,
there is no guarantee that the files seen by the kernel are
the same as those that were in the tar archive.  PuzzleFS doesn't have that
extraction step, so that problem does not exist.
<p>
Data integrity is an important objective in general.  It is not possible to
use <a
href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/verity.html">dm-verity</a>
in this case to protect the whole volume; while the filesystem is
immutable, the underlying data store is not, since adding a new version or
layer requires the ability to add new data.  So, instead, <a
href="https://www.kernel.org/doc/html/latest/filesystems/fsverity.html">fs-verity</a>
is used to verify the integrity of the individual files in the data store.
When mounting a specific image, the hash of the manifest of interest is
given to the <tt>mount</tt> for verification.
<p>
An important objective behind this project was the avoidance of
memory-safety bugs.  For that reason, the filesystem implementation has
been written in Rust.  That choice has, he said, removed a lot of pain from
the development process.
<p>
There is a working FUSE implementation, and a <a
href="/ml/linux-kernel/20230726164535.230515-1-amiculas@cisco.com/">kernel
implementation</a> in a proof-of-concept state.  The kernel side depends on
a set of filesystem-interface abstractions that are being developed
separately, and which should be headed toward the mainline at some point.
Some other work is needed to get other dependencies, including the <a
href="https://capnproto.org/">Cap'n Proto library</a> used for metadata
storage, into proper shape for the kernel.  The work is progressing,
though; interested folks can find the current code in <a
href="https://github.com/project-machine/puzzlefs">this repository</a>.
<p>
One topic Miculas did not address is the resemblance between PuzzleFS and
<a href="/Articles/917097/">composefs</a>, which shares some similar goals.
Composefs has <a href="/Articles/933616/">run into difficulties</a> getting
into the mainline kernel — though other changes intended to support those
goals are going in.  PuzzleFS has some features that composefs lacks;
whether those will be enough to make its upstream path easier is unclear.
<p>
See <a href="https://kangrejos.com/2023/PuzzleFS.pdf">the slides from this
talk</a> for more information and details of the on-disk format.
<p>
[Thanks to the Linux Foundation for supporting our travel to this event.]<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems">Filesystems</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Kangrejos-2023">Kangrejos/2023</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/945320/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor945527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 5:49 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/945527/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
PuzzleFS seems really useful!<br>
<p>
I'm wondering how easily PuzzleFS could build atop a remote object store rather than a local one?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor945530"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 7:31 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945530/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
CDC isn't a new idea and typically used for backup archival programs (such as casync[1]).  For kernel filesystems, I guess they are designed more for performance (otherwise FUSE approaches are enough).  If data isn't encoded (e.g. compression) and metadata overhead of CDC approaches is sensitive to them (as mentioned in the FastCDC paper [2]), I think they will just use fixed-size block deduplication because of I/O friendly and no extra copy (out of raw block I/Os).<br>
<p>
Side note is that EROFS already supports a varient CDC with compression since Linux v6.1. It would be nice to make a comparsion too in some extent so I could know what people care about more for our further enhancements. I know people enjoy new stuffs all the time but it would be nice to get more hints why state-of-art projects don't work well except for Rust adaption.<br>
<p>
Similar to Christian said before [3],  AFAIK, there were already four container image approaches raised for Linux kernel in addition to Composefs:<br>
1. original Nydus [4], also called Dragonfly Image service in OCIv2 brainstorm [5] --- Actually they already had an in-kernel implementation of their RAFS v5 before I joined Alibaba Cloud, if needed, they could post the original kernel implementation at that time to the mailing list;<br>
2. TarFS [6];<br>
3. Overlaybd [7] --- Another QCOW2-like block driver approach from another team in Alibaba Cloud;<br>
4. Puzzlefs.<br>
I'm not sure if Linux could accept all of them for the same use case, anyway.<br>
<p>
[1] <a href="https://0pointer.net/blog/casync-a-tool-for-distributing-file-system-images.html">https://0pointer.net/blog/casync-a-tool-for-distributing-...</a><br>
[2] <a href="https://www.usenix.org/system/files/conference/atc16/atc16-paper-xia.pdf">https://www.usenix.org/system/files/conference/atc16/atc1...</a><br>
[3] <a href="https://lore.kernel.org/r/20230609-nachrangig-handwagen-375405d3b9f1@brauner">https://lore.kernel.org/r/20230609-nachrangig-handwagen-3...</a><br>
[4] <a href="https://github.com/opencontainers/.github/blob/master/meeting-notes/oci-weekly-notes-2020-apr-2021-mar.md">https://github.com/opencontainers/.github/blob/master/mee...</a><br>
     <a href="https://github.com/dragonflyoss/image-service/blob/master/docs/nydus-design.md">https://github.com/dragonflyoss/image-service/blob/master...</a><br>
[5] <a href="https://hackmd.io/@cyphar/ociv2-brainstorm">https://hackmd.io/@cyphar/ociv2-brainstorm</a><br>
[6] <a href="https://github.com/kata-containers/kata-containers/pull/7106">https://github.com/kata-containers/kata-containers/pull/7106</a><br>
     <a href="https://kangrejos.com/2023/Read-only%20FS%20abstractions%20&amp;%20tarfs.pdf">https://kangrejos.com/2023/Read-only%20FS%20abstractions%...</a><br>
[7] <a href="https://lore.kernel.org/r/9505927dabc3b6695d62dfe1be371b12f5bdebf7.1684491648.git.durui@linux.alibaba.com/">https://lore.kernel.org/r/9505927dabc3b6695d62dfe1be371b1...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945530/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945532"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 8:05 UTC (Tue)
                               by <b>alexl</b> (subscriber, #19068)
                              [<a href="/Articles/945532/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In addition to all the competing implementations of this I feel like this article misses one of the main points of composefs. <br>
<p>
PuzzleFS (as well as e.g. nydus, etc) does block-chunking de-duplication, whereas composefs does entire-file de-duplication. Yes, the block-chunking approach is more efficient during download (as you may reuse blocks when files are only partially the same), and will use less disk-space. <br>
<p>
However the entire-file dedup approach is more efficient at runtime.<br>
<p>
This is because the page cache, and things like vm address spaces, are tied to a single inode. You can't get a single inode out of the multiple chunk files. This means the chunked approach doubles the page cache use. Once to cache the chunk, and once to cache the merged file. You also can't share page cache use between different puzzlefs mounts even if they use shared base files. With composefs, the page caching *only* happens on the base file, and is shared between any composefs mounts using the same backing file. This allows better container density, as e.g. all the glibc mmaps shared between any running containers are the same in the page cache.<br>
<p>
I guess an optimal system would use a block-chunked approach for downloads, but expand into full-file dedup in the local storage.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945532/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 8:18 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945534/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; use a block-chunked approach for downloads, but expand into full-file dedup in the local storage.</span><br>
<p>
Yes, yet in that way, there are more effective backup/restore technologies such as delta compression (frequently discussed in several academic conferences such as ATC) to reduce I/Os than just do content-defined chunking. And not necessary in a real filesystem form to keep such delta compression archival format.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945606"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 13:52 UTC (Tue)
                               by <b>alexl</b> (subscriber, #19068)
                              [<a href="/Articles/945606/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
True, if you don't need the kernel-side to support it you can use arbitrary complex delta approaches to optimize the download.<br>
<p>
Also, you can use filesystem level compression (in e.g. btrfs) to compress the files in the backing dir. Or even use reflinks copy create backing files that share some (but not all) blocks.<br>
<p>
The sky is the limit, and all these approaches are compatible with using composefs to mount them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945606/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor945619"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 14:47 UTC (Tue)
                               by <b>tych0</b> (subscriber, #105844)
                              [<a href="/Articles/945619/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; You also can't share page cache use between different puzzlefs mounts even if they use shared base files. </span><br>
<p>
This is a great point. I guess it could be worked around with some core mm+fs fu, but it would definitely not be simple.<br>
<p>
<span class="QuotedText">&gt; I guess an optimal system would use a block-chunked approach for downloads, but expand into full-file dedup in the local storage.</span><br>
<p>
It was an explicit design goal of PuzzleFS not to have any translation step between the image that is pushed to the container registry and the one that's mounted+run on the host, so any translation step here would be a non-starter, which seems like you need to pick "one or the other" unfortunately.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945619/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945731"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2023 19:01 UTC (Wed)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/945731/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;&gt; You also can't share page cache use between different puzzlefs mounts even if they use shared base files. </span><br>
<span class="QuotedText">&gt; This is a great point. I guess it could be worked around with some core mm+fs fu, but it would definitely not be simple.</span><br>
<p>
Could KSM be extended to work on file-backed pages?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945731/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor945629"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 16:11 UTC (Tue)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/945629/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In theory too, one could have a hybrid system that operates I think a lot like git does with pack files (deduplicated files w/deltas) that can be dynamically materialized the first time they're referenced.  Or for files that you *know* will be shared or are "hot", materialize them automatically.   This would require FUSE userspace today though.  It's an interesting topic because for the in-kernel puzzlefs implementation you'd still probably (?) want a userspace system in control of optimizing things.<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945629/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945648"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 20:28 UTC (Tue)
                               by <b>rcampos</b> (subscriber, #59737)
                              [<a href="/Articles/945648/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The minute FUSE is involved, you lost any kind of performance game.<br>
<p>
There were some patches to FUSE to allow a passthrough in some cases, that is what I wish is used to do this in a reasonable way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945648/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor945601"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 12:45 UTC (Tue)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/945601/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Are there any plans to bring file-based runtime dedup to EROFS? Being able to combine that with dm-verity would be awesome<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945601/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 13:40 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945603/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Are there any plans to bring file-based runtime dedup to EROFS? Being able to combine that with dm-verity would be awesome</span><br>
<p>
Hi! Using EROFS + dm-verity + blockdevice + overlayfs (composefs-like model), you could already implement a clean file-based runtime dedup by using overlayfs.<br>
<p>
I understand that you mean EROFS self-contained file-based runtime dedupe across images as you mentioned in some previous article. Actually we already have an internal version for internal products by Jingbo, but it's still unclean for now. We will try to clean up and post it to fsdevel mailing list later, but not quite sure it could land smoothly, anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 14:17 UTC (Tue)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/945612/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes I mean directly in EROFS, that would be great to have and we'd use it immediately - unless I'm missing something, you can't really do this together with dm-verity in the overlayfs model, as the data storage is not actually in dm-verity, but it's in the blob storage layer?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945618"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 14:30 UTC (Tue)
                               by <b>alexl</b> (subscriber, #19068)
                              [<a href="/Articles/945618/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can use dm-verity to protect a composefs-style erofs image, but you would have to use fs-verity to verity the blob storage layer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945618/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945620"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 14:52 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945620/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; you would have to use fs-verity to verity the blob storage layer</span><br>
<p>
I think if some blob storage layer is just an EROFS image, you could directly apply dm-verity on these layers.<br>
And check dm-verity root digests of these layers before mounting. I think that would be in the same effect, anyway.<br>
<p>
We can also use fs-verity to verity the blob storage layers if these layers are on a RW fs (the current composefs does.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945620/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 15:02 UTC (Tue)
                               by <b>alexl</b> (subscriber, #19068)
                              [<a href="/Articles/945625/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, this is doable, but its kinda a weird way to store the blobs. The main goal of a system like this is to share the blobs between different images, and having the blob store be per-image is contrary to this goal.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945627"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 15:09 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945627/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, I know that is not composefs intended use cases.<br>
I'm not sure if some people really rely on layering concept (such as system using raw partitions/devices without real filesystem storage), anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945627/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor945617"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 14:35 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945617/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not quite sure if I got the point. With the current upstream overlayfs, you could actually make <br>
 - EROFS + dm-verity block device blobs as data only layers;<br>
 - a small overlayfs meta layer (with EROFS + dm-verity) to merge these data storage blobs into a merged rootfs.<br>
Thus all layers are under dm-verity protection, so the whole image won't be tampered.<br>
<p>
Alternatively, as an EROFS self-containerd approach, EROFS could share page cache if files with same data across images without relying on overlayfs, anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945617/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945631"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 15:57 UTC (Tue)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/945631/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How would that work in practice? Say I have an erofs image with a rootfs that contains /usr/foo/a, and other two extension erofs images that contain usr/foo/b and usr/foo/c respectively. I create two overlays, each with the base, and one of the extension, so that one has usr/foo/a+usr/foo/b and the other usr/foo/a+usr/foo/c. Is memory being deduplicated, given usr/foo/a is the same?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945631/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945633"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 16:08 UTC (Tue)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/945633/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; I have an erofs image with a rootfs that contains /usr/foo/a, and other two extension erofs images that contain usr/foo/b and usr/foo/c respectively. I create two overlays, each with the base, and one of the extension, so that one has usr/foo/a+usr/foo/b and the other usr/foo/a+usr/foo/c. Is memory being deduplicated, given usr/foo/a is the same?</span><br>
<p>
In that case, memory of /usr/foo/a is deduplicated according to how overlayfs works since /usr/foo/a is on the same EROFS instance.<br>
That already works without any extra built-in feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945633/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945636"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 16:57 UTC (Tue)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/945636/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, that's very nice, I didn't know that, thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945636/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor945535"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 8:39 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/945535/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Capnproto would be an interesting thing to have in the kernel. We use it in rr to specify the trace format and manage compatibility as we add things to the format over time. It's worked really well for us.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945535/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor945591"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 10:02 UTC (Tue)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/945591/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No dm-verity, no party!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945591/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor945599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 12:28 UTC (Tue)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/945599/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My goodness, is there so much duplication in the Ubuntu image?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 12:45 UTC (Tue)
                               by <b>smcv</b> (subscriber, #53363)
                              [<a href="/Articles/945600/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is if you download 10 slightly different versions of it - they'll all have the exact same binary for anything that didn't get a security update during the time window covered by those versions (for instance if glibc didn't get updated for a while, they'll all have identical glibc).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor945602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 13:04 UTC (Tue)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/945602/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Composefs has run into difficulties getting into the mainline kernel</span><br>
<p>
Not at all - the decision was that the *ingredients* for composefs (mainly overlayfs extensions) would be in the kernel, and "composefs" would be a userspace concept wiring those ingredients together - and this has all happened!<br>
<p>
Please see the README.md for <a href="https://github.com/containers/composefs">https://github.com/containers/composefs</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 13:38 UTC (Tue)
                               by <b>alexl</b> (subscriber, #19068)
                              [<a href="/Articles/945604/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In fact, we just released 1.0 as all the required pieces are merged into the upstream kernel:<br>
<a href="https://blogs.gnome.org/alexl/2023/09/26/announcing-composefs-1-0/">https://blogs.gnome.org/alexl/2023/09/26/announcing-compo...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor945613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The PuzzleFS container filesystem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 26, 2023 14:17 UTC (Tue)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/945613/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Congrats on the release!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/945613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2023, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
