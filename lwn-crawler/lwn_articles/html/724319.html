        <!DOCTYPE html>
        <html lang="en">
        <head><title>The &quot;rare write&quot; mechanism [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/724319/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/723753/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/724319/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The &quot;rare write&quot; mechanism</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="GAByline">
           <p>June 1, 2017</p>
           <p>This article was contributed by Nur Hussein</p>
           </div>
<p>One of the ways to harden the kernel is by tightening permissions on memory
to write-protect as much run-time data as possible. This means the
kernel makes some data structures read-only to prevent malicious or
accidental corruption. However, inevitably, most data structures need
read/write access at some point. Because of this, a blanket read-only
policy for these 
structures wouldn't work. Therefore, we need a mechanism that keeps
sensitive data structures read-only when "at rest", but allows writes when
the need arises.
<p>
Kees Cook <a
href="http://marc.info/?l=linux-kernel&m=149081147926918&w=2">proposed</a>
such a mechanism based on similar functionality that exists in the
PaX/grsecurity patch set. Cook calls it "rare write", but that is a bit of
misnomer considering that write access to some of the target data structures is
not always rare. The resulting discussion on the Linux kernel mailing list
fleshed out how the mechanism could be implemented, from a standpoint of
both architecture-neutrality and performance.</p> 

<p>Cook's proposed series of eleven patches for the <tt>rare_write()</tt>
infrastructure consists of sample implementations for x86 and ARM, plus
usage examples. Two new kernel configuration options,
<tt>HAVE_ARCH_RARE_WRITE</tt> and <tt>HAVE_ARCH_RARE_WRITE_MEMCPY</tt>, were
<a href="http://marc.info/?l=linux-kernel&m=149081147926916&w=2">added</a>
to let architectures define whether or not they have implemented the
new mechanism. Cook's implementation contains architecture-specific code
that relies on CPU features on x86 and ARM that selectively enable and
disable write access to areas of memory. Thus, the data write routines
cannot be preemptible, as interrupting the kernel after it
enables writing on read-only memory would result in leaving a window of
vulnerability open. Cook noted that his code is inlined to discourage
<a
href="https://en.wikipedia.org/wiki/Return-oriented_programming">return-oriented
programming</a> attacks on the write-enable routines, which
would otherwise be a juicy target for such attacks.</p> 

<p>The architecture-specific nature of the code became a point of
contention in the resulting discussion on the linux-kernel
and kernel-hardening mailing lists. But first, let's look at how Cook's
proposed mechanism works.
<p>
The kernel stores data in different ELF sections
depending on how that data will be accessed:
<tt>.data</tt> or <tt>.bss</tt> for normal, read-write data,  in
<tt>.rodata</tt> for read-only data, or in
<tt>.data..ro_after_init</tt> for data that will <a
href="/Articles/666550/">become read-only after initialization</a>. Cook's
newly 
introduced <tt>__wr_rare</tt> annotation, which for now is just a
<tt>#define</tt> alias for <tt>__ro_after_init</tt>, would
be used to mark data structures to be converted to read-only.
Write access would be enabled  via a new 
<tt>rare_write()</tt> macro, or in a critical section protected by
<tt>rare_write_begin()</tt> and <tt>rare_write_end()</tt> macros. Cook gave
a simple <a
href="http://marc.info/?l=linux-kernel&m=149081147926919&w=2">example</a>
of the usage of the single <tt>rare_write()</tt> call by converting a
function in <tt>net/core/sock_diag.c</tt> from:</p> 
<pre>
    sock_diag_handlers[family] = NULL;
</pre>
To:
<pre>
    rare_write(sock_diag_handlers[family], NULL);
</pre>
<p>There are also helper functions <a
href="http://marc.info/?l=linux-kernel&m=149081159026970&w=2">to deal with
linked lists</a> that utilize the <tt>rare_write_begin()</tt> and
<tt>rare_write_end()</tt> macro pair internally.
</p>

<h4>Implementation</h4>

<p>On x86 CPUs, read-only data is mapped onto pages marked with the
read-only bit set in their page-table entries. CR0 is a control register on
the x86 CPUs, and toggling the write-protect bit (bit&nbsp;16) of CR0 allows
this read-only protection to be either enabled or disabled. When the
write-protect bit has been cleared
on a CPU, any data, regardless of the page-table permissions, can be
written by the 
kernel when running on that CPU. After some back and forth discussion,
Cook's <a
href="http://marc.info/?l=linux-arm-kernel&m=149143768912131&w=2">implementation</a>
of the rare write functions on x86 became the following:

<pre>
    static __always_inline unsigned long __arch_rare_write_begin(void)
    {
           unsigned long cr0;

           cr0 = read_cr0() ^ X86_CR0_WP;
           BUG_ON(cr0 &amp; X86_CR0_WP);
           write_cr0(cr0);
           return cr0 ^ X86_CR0_WP;
    }

    static __always_inline unsigned long __arch_rare_write_end(void)
    {
           unsigned long cr0;

           cr0 = read_cr0() ^ X86_CR0_WP;
           BUG_ON(!(cr0 &amp; X86_CR0_WP));
           write_cr0(cr0);
           return cr0 ^ X86_CR0_WP;
    } 
</pre>

<p>Mathias Krause <a
href="http://marc.info/?l=linux-arm-kernel&m=149155411211517&w=2">raised a
concern</a> that non-maskable interrupts would still be able to interrupt
the CPU inside the critical section, and questioned <strike>if PaX's implementation
that Cook's patch was based on</strike> whether the implementation was
indeed correct. Thomas Gleixner <a 
href="http://marc.info/?l=linux-kernel&m=149155839912794&w=2">suggested</a>
that the proper way to handle writing to a read-only memory location
is to create a writable shadow mapping to that physical memory location, and
update the value of the data in that location through the shadow map.  This
approach 
would not require clearing the CR0 write-protect bit which, he suggested, is
too dangerous to ever do.  Gleixner provided this
piece of pseudocode to illustrate his idea:
</p>
<pre>
    write_rare(ptr, val)
    {
            mp = map_shadow_rw(ptr);
            *mp = val;
            unmap_shadow_rw(mp);
    }
</pre>
<p>He added:</p>
<div class="BigQuote">
<p>map_shadow_rw() is essentially the same thing as we do in the highmem case
where the kernel creates a shadow mapping of the user space pages via
kmap_atomic().</p>

<p>It's valid (at least on x86) to have a shadow map with the same page
attributes but write enabled. That does not require any fixups of CR0 and
just works.</p>
</div>

<p>After subsequent discussions on which method would be better with
regard to performance, Andy Lutomirski <a
href="http://marc.info/?l=linux-kernel&m=149158172821109&w=2">suggested</a>
setting up a separate <tt>mm_struct</tt> that had a writable alias of the target
read-only data and using <tt>use_mm()</tt> to access it. Lutomirski argued
this was more architecture-neutral and, if anyone was inclined to test its
performance, they could do so against the CR0-toggle method. While Mark Rutland
<a href="http://marc.info/?l=linux-kernel&m=149158221321267&w=2">agreed
with this approach</a>, Gleixner <a
href="http://marc.info/?l=linux-kernel&m=149159790526230&w=2">wasn't too
sure</a> if this was efficient. Cook <a
href="http://marc.info/?l=linux-kernel&m=149160005926868&w=2">replied</a>
that there was a need for performance and efficiency, as this mechanism
will be used for data structures that need extra protection, and not just
those are are written to rarely:

<div class="BigQuote">
<p>I probably chose the wrong name for this feature (write rarely).
That's _usually_ true, but "sensitive_write()" was getting rather
long. The things that we need to protect with this are certainly stuff
that doesn't get much writing, but some things are just plain
sensitive (like page tables) and we should still try to be as fast as
possible with them.</p>
</div>
<p>
PaX Team <a
href="http://marc.info/?l=linux-kernel&m=149176959725535&w=2">responded</a>
that the weakness of the <tt>use_mm()</tt>
approach is that it wouldn't scale, and that you couldn't use the approach
inside <tt>use_mm()</tt> and <tt>switch_mm()</tt> themselves. These limitations
<a href="http://marc.info/?l=linux-kernel&m=149185519506015&w=2">also
concerned</a> Cook:
<p>
<div class="BigQuote">
These are the limitations that concern me: what will we NOT be able to
make read-only as a result of the use_mm() design choice? My RFC
series included a simple case and a constify case, but I did not
include things like making page tables read-only, etc.
</div>
<p>
Lutomirski <a
href="http://marc.info/?l=linux-kernel&m=149185545706083&w=2">replied</a>
that page table writes aren't rare, so there may need to be "<q>multiple
levels of rareness</q>" to accommodate this.


<p>Cook also included an implementation for ARM-based
CPUs. The ARM architecture organizes memory into regions called "domains", and
each domain can have different access permissions. Cook <a
href="http://marc.info/?l=linux-kernel&m=149081159126973&w=2">created</a> a
domain called <tt>DOMAIN_WR_RARE</tt> to store read-only data;
whenever <tt>rare_write()</tt> is invoked on ARM, the code will <a
href="http://marc.info/?l=linux-kernel&m=149081159026972&w=2">modify</a>
the domain permissions of <tt>DOMAIN_WR_RARE</tt> to enable writes, and
disable them again after it is done.</p>


<h4>Conclusion</h4>

<p>After the various comments that were posted on the mailing list,
Cook is working on another iteration of his patch set. An open question is
how something like this can be implemented on architectures that do not
have architecture support for enabling or disabling writing to read-only
memory. Earlier, in his first RFC series on the kernel-hardening list, Cook
<a
href="http://www.openwall.com/lists/kernel-hardening/2017/02/28/9">stated</a>
that he isn't sure how to handle other architectures that do not have the
requisite hardware support, but he does plan to get a "viable interface"
for the architectures that do. Perhaps the way forward is to use the
suggested method of writing to read-only data sections via shadow mappings,
which can be implemented with <tt>kmap_atomic()</tt> as proposed by
Gleixner.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Kernel_hardening">Security/Kernel hardening</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Hardening">Linux kernel/Hardening</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Hussein_Nur">Hussein, Nur</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/724319/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor724388"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2017 21:39 UTC (Thu)
                               by <b>minipli</b> (guest, #69735)
                              [<a href="/Articles/724388/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The article only shows the x86 specific helpers and is missing the arch agnostic primitives. However, those are required to understand my concerns. Let me quote them here for completeness:<br>
<p>
static __always_inline rare_write_begin(void)<br>
{<br>
    preempt_disable();<br>
    local_irq_disable();<br>
    barrier();<br>
    __arch_rare_write_begin();<br>
    barrier();<br>
}<br>
<p>
static __always_inline rare_write_end(void)<br>
{<br>
    barrier();<br>
    __arch_rare_write_end();<br>
    barrier();<br>
    local_irq_enable();<br>
    preempt_enable_no_resched();<br>
}<br>
<p>
As can be seen, the rare_write_begin() primitive disables preemption and IRQ delivery on the local CPU. (The latter is a bug, actually, as the code could be called from a section that already had interrupts disabled (think of spin_lock_irqsave() et al.) and would wrongly re-enable them in rare_write_end(). But that's just another flaw of that code I don't want to focus on too much.) The point is, the local_irq_disable() doesn't prevent NMIs from interrupting a rare_write_begin()...rare_write_end() block. The NMI handler would run with CR0.WP disabled and, in turn, would allow an attacker to exploit this situation as mechanisms like COW won't work any more. So I raised that concern, as mentioned in the article, but I didn't question the implementation in PaX! In fact, well, let me just quote my email here as well:<br>
<p>
"""<br>
Well, doesn't look good to me. NMIs will still be able to interrupt<br>
this code and will run with CR0.WP = 0.<br>
<p>
Shouldn't you instead question yourself why PaX can do it "just" with<br>
preempt_disable() instead?!<br>
"""<br>
<p>
As I'm not a native speaker my understanding of the second sentence might differ from yours, but, what I wanted to say was: PaX's implementation doesn't need to disable interrupts, it does handle the NMI case (and IRQ case, for that matter) perfectly fine and has a working COW semantic even then. I wasn't questioning PaX's implementation, I was questioning Kees' proposal. In fact, my question was asking *him* why PaX can have such a simple implementation of the rare_write_begin() helper (called pax_open_kernel() in the PaX patch) that is correct while his is not. (Hint: He'd missed a few hunks while copy-paste-bike-shedding.) But that led nowhere, just to Thomas arguing CR0.WP is a bad arch hack to begin with and that it shouldn't be used at all. I didn't quite agree, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724388/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 14:07 UTC (Fri)
                               by <b>nurh</b> (guest, #114270)
                              [<a href="/Articles/724451/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I did misread the intent of your LKML post, and I apologize. We've corrected the error. Thank you for the clarification.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor724396"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 0:22 UTC (Fri)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/724396/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Dear LWN editors,<br>
<p>
can we please stop with these bullshit plagiarism based articles? most if not all of the code attributed to Kees in the article is basically mine (he said so himself in the very post you linked to), pointless renaming and introduced bugs aside.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724396/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724400"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 0:25 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/724400/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Dear PaX Team:

The provenance of the code in question is clearly described in the article itself.  It is, meanwhile, development work that is relevant to the kernel development community and worthy of coverage.  No bullshit, no plagiarism.  No stopping.
      
          <div class="CommentReplyButton">
            <form action="/Articles/724400/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724401"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 1:08 UTC (Fri)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/724401/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Dear Jon,<br>
<p>
you can't say you weren't warned. some specific examples of apparently wilfully misattributed authorship claims:<br>
<p>
<font class="QuotedText">&gt; Cook's implementation contains architecture-specific code that relies on CPU features on x86 and ARM that selectively</font><br>
<font class="QuotedText">&gt; enable and disable write access to areas of memory.</font><br>
<p>
the x86 specific code is mine, not his.<br>
<p>
<font class="QuotedText">&gt; Cook noted that his code is inlined [...]</font><br>
<p>
again, it's my code which he copied.<br>
<p>
<font class="QuotedText">&gt; Cook's newly introduced __wr_rare annotation[...]</font><br>
<p>
it's my __read_only attribute.<br>
<p>
<font class="QuotedText">&gt; Cook gave a simple example of the usage of the single rare_write() call by converting a function in net/core/sock_diag.c from:</font><br>
<p>
it's my code too.<br>
<p>
<font class="QuotedText">&gt; Cook's implementation of the rare write functions on x86 became the following: </font><br>
<p>
it's all my code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724401/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724424"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 7:02 UTC (Fri)
                               by <b>itvirta</b> (guest, #49997)
                              [<a href="/Articles/724424/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; the code is mine, not his.</font><br>
<p>
I think there might be more appropriate forums for copyright infringement claims than comments on a news site.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724424/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724445"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 13:02 UTC (Fri)
                               by <b>madscientist</b> (subscriber, #16861)
                              [<a href="/Articles/724445/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No one is talking about copyright infringement (which is good, since that's not a valid claim).  What's being discussed is attribution, and in particular attribution in the article (not attribution in the patches).  I think the comments section of the article is a valid place to discuss that.  I have no opinion on the merits.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724445/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor724405"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 1:39 UTC (Fri)
                               by <b>jeff_marshall</b> (subscriber, #49255)
                              [<a href="/Articles/724405/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
PaXTeam,<br>
<p>
The article seems to point this out in a straightforward (to me) manner:<br>
<p>
<font class="QuotedText">&gt; Kees Cook proposed such a mechanism based on similar functionality that exists in the PaX/grsecurity patch set</font><br>
<p>
What would you propose that the LWN editors do differently?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724405/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724431"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 10:09 UTC (Fri)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/724431/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just write 'The implementation' instead of 'Cook implementation' etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724431/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724547"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2017 0:44 UTC (Sun)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/724547/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      If the code is largely copied from the PaX/grsecurity patch set, saying that Cook proposed a mechanism based on functionality (or function) in that patch set is inadequate.  That says to me original code that does something similar to what the PaX/grsecurity code does. 

<p>If it's basically code copied with some renaming, and Cook said so in the talk as PaXTeam says, then "based on code in the PaX/grsecurity patch set" or "derived from code ..." would be less misleading, if not, "largely copied from ..."

      
          <div class="CommentReplyButton">
            <form action="/Articles/724547/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724590"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2017 7:00 UTC (Mon)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/724590/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can't judge the merits either but when I read the article my impression is that most of the code is written by Cook, merely inspired by the work pax did. If, in reality, 80-90% is copied from PAX and the patch is essentially a port and perhaps clean-up of PAX code to the current kernel I suggest the wording is indeed flawed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724590/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724657"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 3:17 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/724657/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can understand how something like that might be overlooked. If grsecurity wasn't de-facto proprietary anyone could do a diff instead of having to assume paxteam is once again acting in bad faith.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724657/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724660"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 10:56 UTC (Tue)
                               by <b>PaXTeam</b> (guest, #24616)
                              [<a href="/Articles/724660/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yeah man, makes one wonder where Kees could have possibly copied my code from if it was 'proprietary'. if you are unable to tell then Kees/LWN failed at properly attributing the origin of my code so complain to them instead of spewing ad hominem. of course, a smart cookie such as yourself could have also just looked at the test patch collection linked from, wait for it, the PaX homepage but then assuming that you failed to do that so that you can justify going on an irrelevant diatribe would be bad faith, wouldn't it? ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724660/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 17:32 UTC (Tue)
                               by <b>likryol</b> (guest, #115542)
                              [<a href="/Articles/724717/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why can't you (validly) point out that your code is easily available without attacking people? Your stance here is right, but the tone and delivery (on both sides of the argument to be fair) is why there is friction.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor724662"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 11:05 UTC (Tue)
                               by <b>minipli</b> (guest, #69735)
                              [<a href="/Articles/724662/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      The relevant code from the <a href="https://github.com/minipli/linux-grsec/blob/v4.9.24-pax/arch/x86/include/asm/pgtable.h#L100-L124">PaX Patch for v4.9.24</a> looks astonishingly similar to <a href="http://marc.info/?l=linux-kernel&m=149081159126975&w=2">Kees' proposal</a>, no?
</br>
So, now, please tell me this is not just a poor rip-off with minor bikeshedding applied!?
      
          <div class="CommentReplyButton">
            <form action="/Articles/724662/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 11:21 UTC (Tue)
                               by <b>tao</b> (subscriber, #17563)
                              [<a href="/Articles/724664/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Based on PaX's x86 pax_{open,close}_kernel() implementation, this<br>
allows HAVE_ARCH_RARE_WRITE to work on x86."<br>
<p>
I find it hard to say that it lacks proper attribution though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor726423"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 26, 2017 9:33 UTC (Mon)
                               by <b>jospoortvliet</b> (guest, #33164)
                              [<a href="/Articles/726423/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe that that wasn't disputed, Kees properly credited. The article, however, seems to suggest he wrote the code, merely inspired by the PAX feature, which is clearly not the case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/726423/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor724663"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 11:24 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/724663/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You say "a poor rip-off with minor bikeshedding": anyone else would say "changes of the sort routinely needed for upstreaming which PaXTeam is unwilling to do". If that makes a "poor rip-off", then the *entire kernel* is a "poor rip-off", which makes it odd that grsecurity is based on it. (This is a general problem with the grsecurity position: if the kernel is so all-around terrible and run by thieves, scoundrels, liars, incompetents and scum as they constantly claim, why on earth are they using it as a basis for their work? Perhaps because it's not anywhere near as bad as all that after all. Further, if it's thievery to take the grsecurity work and modify and upstream it, why on earth is it not thievery for grsecurity to take the kernel and modify it, particularly if they then accompany the result with contracts that try to restrict its further distribution? I mean, yes, both are legally permissible, but if I look for scurrilous behaviour here I do not see it in the kernel maintainers. Oh noes, they're giving people's work a wide audience and all you have to do in exchange for this is act like a decent human being!)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724663/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724723"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism - attribution</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2017 18:53 UTC (Tue)
                               by <b>minipli</b> (guest, #69735)
                              [<a href="/Articles/724723/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's a "poor rip-off" simply because Kees' code is broken. It introduces a Dirty COW alike bug and, ironically enough, this time brought to you by the team making Linux "more secure" -- well, not quite, in this case. ;)<br>
<p>
This is just a prime example that they don't understand what they're copying. How would such an approach gain Linux security in any sensible way? It's always the bloody details that count -- that little corner case that also needs to be taken care of to make a security feature complete. But so far KSPP has just copy-pasted PaX/grsec code without fully understanding the interconnections with other features and code changes. I'd say, they need to slow down and start reading the whole thing, trying to understand what they just read and repeat -- until no new "Ahhh!" moments appear any more. What happens now isn't much more than a grep 'n sed over the patch without understanding what those hunks really do -- what other changes they need the grep didn't catch.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724723/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor724468"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 15:03 UTC (Fri)
                               by <b>Tara_Li</b> (guest, #26706)
                              [<a href="/Articles/724468/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm thinking that "rare" in this case might be specifying more the ratio of writes to reads - something like a webpage with comments where the webpage is read a large number of times relative to the comments made to it - so it might make sense to just re-write the page as a static HTML page to add comments, rather than doing massive database look-ups each time the article is presented to users.  Of course the viability of this depends on the ratio between time spent reading and time spent writing - so maybe a range of solutions is needed such as write_1_in_100(), write_1_in_10000(), write_1_in_1m(), etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724468/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor724501"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2017 20:10 UTC (Fri)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/724501/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Shouldn't the nmi handler just save and clear, then restore the state of X86_CR0_WP or what ever architecture specific register to close that specific worry?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/724501/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor724541"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;rare write&quot; mechanism</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2017 15:52 UTC (Sat)
                               by <b>minipli</b> (guest, #69735)
                              [<a href="/Articles/724541/">Link</a>] 
      </p>
      
      </div>
      </summary>
      That might work, however, I don't see any such changes in the <a href="http://marc.info/?l=linux-kernel&m=149081159126975&w=2">proposed patch</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/724541/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2017, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
