        <!DOCTYPE html>
        <html lang="en">
        <head><title>The case of the overly anonymous anon_vma [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/383162/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/382742/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/383162/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The case of the overly anonymous anon_vma</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 13, 2010</br>
           </div>
During the stabilization phase of the kernel development cycle, the -rc
releases typically happen about once every week.  <a
href="http://lwn.net/Articles/383198/">2.6.34-rc4</a> is a clear
exception to that rule, coming nearly two weeks after the
preceding -rc3 release.  The holdup in this case was a nasty regression
which occupied a number of kernel developers nearly full time for days.
The hunt for this bug is a classic story of what can happen when the code
gets too complex.
<p>
Sending email to linux-kernel can be an intimidating prospect for a number
of reasons, one of which being that one never knows when a massive thread -
involving hundreds of messages copied back to the original sender - might
result.  Borislav Petkov's <a href="/Articles/383163/">2.6.34-rc3 bug
report</a> was one such posting.  In this case, though, the ensuing thread
was in no way inflammatory; it represents, instead, some of the most
intensive head-scratching which has been seen on the list for a while.
<p>
The bug, as reported by Borislav, was a null pointer dereference which
would happen reasonably reliably after hibernating (and restarting) the
system.  It was quickly recognized as being the same as <a
href="https://bugzilla.kernel.org/show_bug.cgi?id=15680">another bug
report</a> filed the same day by Steinar H. Gunderson, though this one did
not involve hibernation.  The common thread was null pointer dereferences
provoked by memory pressure.  The offending patch was <a
href="/Articles/383165/">identified by Linus</a> almost immediately; it's
worth taking a look at what that patch did.
<p>
Way back in 2004, LWN <a href="http://lwn.net/Articles/75198/">covered the
addition of the anon_vma code</a>; this patch was controversial at the time
because the upcoming 2.6.7 kernel was still expected to be an old-style
"stable, no new features" release.  This patch, a 40-part series which
fundamentally reworked the virtual memory subsystem, was not seen as stable
material, despite Linus's <a
href="http://lwn.net/Articles/86718/">attempt</a> to characterize it as an
"implementation detail."  Still, over time, this code has proved solid and
has not been changed significantly since - until now.
<p>

The problem solved by anon_vma was that of locating all
<tt>vm_area_struct</tt> (VMA) structures which reference a given anonymous
(heap or stack memory) page.  Anonymous pages are not normally shared
between processes, but every call to <tt>fork()</tt> will cause
all such pages to be shared between the parent and the new child; that
sharing will only be broken when one of the processes writes to the page,
causing a copy-on-write (COW) operation to take place.  Many pages are
never written, so the kernel must be able to locate multiple VMAs which
reference a given anonymous page.  Otherwise,  it would not be able to
unmap the page, meaning that 
the page could not be swapped out.  
<p>
The reverse mapping solution originally used in 2.6 proved to be far too
expensive, necessitating a rewrite.  This rewrite introduced the
<tt>anon_vma</tt> structure, which heads up a linked list of all VMAs which
might reference a given page.  So a <tt>fork()</tt> also causes every VMA in
the child process which contains anonymous pages to be added to a the list
maintained in the parent's <tt>anon_vma</tt> structure.  The
<tt>mapping</tt> pointer in <tt>struct page</tt> points to the
<tt>anon_vma</tt> structure, allowing the kernel to traverse the list and
find all of the relevant VMA structures.
<p>
This diagram, from the 2004 article, shows how this data structure looks:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/anonvma2.png" width=359 height=442 
 alt="[anonvma]">
</blockquote>
<p>
This solution scaled far better than its predecessor, but eventually the
world caught up.  So Rik van Riel set out to make things faster, writing <a
href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=5beb49305251e5669852ed541e8e2f2f7696c53e">this
patch</a>, which was merged for 2.6.34.  Rik describes the problem this
way:
<p>
<div class="BigQuote">
	In a workload with 1000 child processes and a VMA with 1000
	anonymous pages per process that get COWed, this leads to a system
	with a million anonymous pages in the same anon_vma, each of which
	is mapped in just one of the 1000 processes.  However, the current
	rmap code needs to walk them all, leading to O(N) scanning
	complexity for each page.
</div>
<p>
Essentially, by organizing all anonymous pages which originated in the same
parent under the same <tt>anon_vma</tt> structure, the kernel created a
monster data structure which it had to traverse every time it needed to
reverse-map a page.  That led to the kernel scanning large numbers of VMAs
which could not possibly reference the page, all while holding locks.  The
result, says Rik, was "catastrophic failure" when running the AIM
benchmark.
<p>
Rik's solution was to create an <tt>anon_vma</tt> structure for each
process and to link those together instead of the VMA structures.  This
linking is done with a new structure called <tt>anon_vma_chain</tt>:
<p>
<pre>
    struct anon_vma_chain {
	struct vm_area_struct *vma;
	struct anon_vma *anon_vma;
	struct list_head same_vma;
	struct list_head same_anon_vma;
    };
</pre>
<p>

Each <tt>anon_vma_chain</tt> entry (AVC) maintains two lists: all
<tt>anon_vma</tt> structures relevant to a given vma (<tt>same_vma</tt>),
and all VMAs which fall within the area covered by a given
<tt>anon_vma</tt> structure (<tt>same_anon_vma</tt>).    It gets
complicated, so some diagrams might help.  Initially, we have a single
process with one anonymous VMA:

<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain1.png" width=242 height=52 alt="[AV
Chain]">
</blockquote>
<p>
Here, "AV" is the <tt>anon_vma</tt> structure, and "AVC" is the
<tt>anon_vma_chain</tt> structure seen above.  The AVC links to both the
<tt>anon_vma</tt> and VMA structures through direct pointers.  The (blue)
linked list pointer is the <tt>same_anon_vma</tt> list, while the (red)
pointer is the <tt>same_vma</tt> list.  So far, so simple.
<p>
Imagine now that this process forks, causing the VMA to be copied in the
child; initially we have a lonely new VMA like this:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain2.png" width=342 height=212 alt="[AV
Chain]">
</blockquote>
<p>
The kernel needs to link this VMA to the parent's <tt>anon_vma</tt>
structure; that requires the addition of a new <tt>anon_vma_chain</tt>:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain3.png" width=342 height=212 alt="[AV
Chain]">
</blockquote>
<p>
Note that the new AVC has been added to the blue list of all VMAs
referencing a given <tt>anon_vma</tt> structure.  The new VMA also needs
its own <tt>anon_vma</tt>, though:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain4.png" width=342 height=212 alt="[AV
Chain]">
</blockquote>
<p>
Now there's yet another <tt>anon_vma_chain</tt> structure linking in the
new <tt>anon_vma</tt>.  The new red list has been expanded to contain all
of the AVCs which reference relevant <tt>anon_vma</tt> structures.  As your
editor said, it gets complicated; the diagram for the 1000-child scenario
which motivated this patch will be left as an exercise for the reader.
<p>

When the
<tt>fork()</tt> happens, all of the anonymous pages in the area point back to the
parent's <tt>anon_vma</tt> structure.  Whenever the child writes to a page
and causes a copy-on-write, 
though, the new page will map back to the child's <tt>anon_vma</tt>
structure instead.  Now, reverse-mapping that page can be done immediately,
with no need to scan through any other processes in the hierarchy.  That
makes the lock contention go away, making benchmarkers happy.
<p>

The only problem is that embarrassing oops issue.  Linus, Rik, Borislav,
and others chased after it, trying no end of changes.  For a while, it
seemed that a bug causing excessive reuse of <tt>anon_vma</tt> structures
when VMAs were merged could be the problem, but fixing the bug did not fix
this oops.  Sometimes, changing VMA boundaries with <tt>mprotect()</tt>
could cause the wrong <tt>anon_vma</tt> to be used, but fixing that one
didn't help either.  The reordering of chains when they were copied was
also noted as a problem...but it wasn't <i>the</i> problem.

<p>  

Linus was clearly beginning to <a href="/Articles/383170/">wonder</a> when
it might all end: "<q>Three independent bugs found and fixed, and still
no joy?</q>" He repeatedly considered just reverting the change
outright, but he was reluctant to do so; the solution seemed so
tantalizingly close.
Eventually he <a
href="/Articles/383171/">developed another hypothesis</a> which seemed
plausible.  An anonymous page shared between parent and child would
initially point to the parent's <tt>anon_vma</tt>:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain5.png" width=422 height=232 alt="[AV
Chain]">
</blockquote>
<p>


But, if both processes
were to unmap the page (as could happen during system hibernation, for
example), then the child referenced it first, it could end up pointing to
the child's <tt>anon_vma</tt> instead:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain6.png" width=422 height=232 alt="[AV
Chain]">
</blockquote>
<p>
If the parent mapped the page
later, then the child unmapped it (by exiting, perhaps), the parent would
be left with an 
anonymous page pointing to the child's <tt>anon_vma</tt> - which no longer
exists:
<p>
<blockquote>
<img src="https://static.lwn.net/images/ns/kernel/avchain7.png" width=322 height=192 alt="[AV
Chain]">
</blockquote>
<p>
Needless to say, that is a situation which is unlikely to lead to anything
good in the near future.  
<p>
The fix is straightforward; when linking an
existing page to an <tt>anon_vma</tt> structure, the kernel needs to pick
the one which is highest in the process hierarchy; that guarantees that the
<tt>anon_vma</tt> will not go away prematurely.

<a
href="/Articles/383172/">Early testing</a> suggests that the problem has
indeed been fixed.  In the process, three other problems have been fixed
and Linus has come to understand a tricky bit of code which, if he has his
way, will soon gain some improved documentation.  In other words, it would
appear to be an outcome worth waiting for.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#anon_vma">anon_vma</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Object-based_reverse_mapping">Memory management/Object-based reverse mapping</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/383162/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor383251"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 16:26 UTC (Tue)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/383251/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am in awe of Linus' debugging abilities!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383251/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 17:31 UTC (Tue)
                               by <b>Wummel</b> (subscriber, #7591)
                              [<a href="/Articles/383254/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      It is even more awesome as he seems just to be looking at the source and guesses what could be wrong with it (or does Linus use printf() or even kgdb nowadays for debugging?).

      
          <div class="CommentReplyButton">
            <form action="/Articles/383254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 17:49 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/383258/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
it was primarily looking at the source and thinking about what was happening.<br>
<p>
In the process three other bugs were found and fixed, and the section of code got significant documentation and cleanup improvements.<br>
<p>
Linus was unable to reliably replicate the bug, so printf, kgdb, etc could not be used.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 18:36 UTC (Tue)
                               by <b>brouhaha</b> (subscriber, #1698)
                              [<a href="/Articles/383262/">Link</a>] 
      </p>
      
      </div>
      </summary>
      "He fixes radios by <i>thinking</i>!"
<p>
-- someone whose radio was repaired by Richard Feynman

      
          <div class="CommentReplyButton">
            <form action="/Articles/383262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor383264"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 18:59 UTC (Tue)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/383264/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The part I found most impressive was when he identified that something was crashing in the first iteration of a loop by looking at the register contents and assembly decode from the oops report. Where other people would have needed to look at memory in a debugger, he could just look at registers and infer where the bad value was coming from.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383264/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383297"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2010 4:11 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/383297/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, wasn't that Boris that did the initial assembly dump interpretation? <br>
<p>
It's actually not so hard once you've done it a couple times.  I've had to chase down bugs in our C compiler at work (ah, the joys of running internal alpha builds!).  <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383297/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2010 4:44 UTC (Wed)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/383298/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The message I'm thinking of is &lt;alpine.LFD.2.00.1004061220270.3487@i5.linux-foundation.org&gt; from Apr 6 at 15:35; Linus looks at Steinar Gunderson's disassembly, where %rax is a kernel pointer and %rbx is not %rax+20 like it would be after running the loop, implying that "anon_vma-&gt;head.next" is NULL, not some other anon_vma_chain entry. Boris had worked out that there was some problem in the list previously, but Linus identified that the pointer from the anon_vma was bad, rather than the list further down being corrupt. This turned out to be important to the actual bug, which had to do with the anon_vma associated with the page being gone (and its memory reused) rather than some other anon_vma in the vma's chain being gone or something messing up the list. Boris picked up the stuff you'd get from a debugger that had registers but not core; Linus picked up an important detail that one would only normally get from a debugger by inspecting memory.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383303"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2010 4:57 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/383303/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, ok.  I hadn't seen that email.  Makes sense.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383303/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor383552"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2010 20:09 UTC (Thu)
                               by <b>Felix</b> (guest, #36445)
                              [<a href="/Articles/383552/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you mean this mail from Linus<br>
<a href="http://groups.google.co.id/group/linux.kernel/msg/130d3ea11ed7c8ff">http://groups.google.co.id/group/linux.kernel/msg/130d3ea...</a><br>
<p>
(it has a slightly different message id+time but seems to fit)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383552/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383553"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2010 20:17 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/383553/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, that's a similar message, but not the one I was thinking of. In that one, he says "So again, I can show that..." I was looking at the first time, and this is the second time. The one I'm thinking of is <a href="http://groups.google.com/group/linux.kernel/msg/f9c7ca848976b5cd">http://groups.google.com/group/linux.kernel/msg/f9c7ca848...</a> and has a more complete explanation of the middle steps.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383553/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor383404"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2010 19:00 UTC (Wed)
                               by <b>mrfredsmoothie</b> (guest, #3100)
                              [<a href="/Articles/383404/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's precisely the point of the Linus "don't rely on a tool" philosophy of bug-fixing.<br>
<p>
If your code cannot be reasoned about by a human, then it cannot be maintained by a human, either.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383404/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor383256"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 17:42 UTC (Tue)
                               by <b>Trelane</b> (subscriber, #56877)
                              [<a href="/Articles/383256/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Awesome. *This* is why I subscribe to lwn!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383256/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383328"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2010 11:37 UTC (Wed)
                               by <b>sorpigal</b> (guest, #36106)
                              [<a href="/Articles/383328/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hereby register one (1) classic "Me too," reply.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383328/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383351"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 14, 2010 15:04 UTC (Wed)
                               by <b>gwittenburg</b> (guest, #5080)
                              [<a href="/Articles/383351/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
+1, same here. Thanks, Jonathan!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383351/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor383472"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2010 12:07 UTC (Thu)
                               by <b>Darkmere</b> (subscriber, #53695)
                              [<a href="/Articles/383472/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just resubscribed. Still somewhat starving hacker, but it's better than nothing. Now to register a company account once I snipe a creditcard from someone ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383472/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor383277"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 13, 2010 20:22 UTC (Tue)
                               by <b>ewen</b> (subscriber, #4772)
                              [<a href="/Articles/383277/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><em>The fix is straightforward; when linking an existing page to an anon_vma structure, the kernel needs to pick the one which is highest in the process hierarchy; that guarantees that the anon_vma will not go away prematurely.</em></blockquote>

<p>That fix makes me wonder about the "daemon startup" situation, where the initial process fork()s at least once (sometimes twice), and then the parent process exits.  I assume that the structure in the parent of the hierachy is being chosen with the expectation that it'd be longest lived.  But in the "daemon startup" case the child ends up being longest lived.  Hopefully the other actions to becoming a daemon, such as disassociating itself with parent process (reparenting to process 1) and becoming a new process group mean that the relevant structures get migrated appropriately down into the child.</p>

<p>I'm also left wondering whether a simpler change from "linked list" to, eg, something indexed by page address, would have improved the situation dramatically without the same degree of code complexity, and hence bugs.  (Eg, O(n) over 1M pages is non-trivial, O(log n) over 1M pages is almost trivial.)</p>

<p>Ewen</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/383277/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384631"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 20:33 UTC (Sat)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/384631/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <i>"eg, something indexed by page address"</i><br>
<br>
That's what the page table is. But you can only index a fixed number of things from that, once you have a variable number of things (as there being any number of processes sharing that page), that's then another dimension, and can thus not be represented using a single dimension of the page address alone. A linked list might be slow for searching in, but in this case it looks like most operations are going to be either inserts (eg, at fork() time), deletes (at CoW or process termination time), and I guess possibly an action required on the whole group, although I couldn't suggest what. These seem like they'd all about as cheap on a linked list as you can get.

      
          <div class="CommentReplyButton">
            <form action="/Articles/384631/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384641"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 21:08 UTC (Sat)
                               by <b>ewen</b> (subscriber, #4772)
                              [<a href="/Articles/384641/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I had in mind replacing the linked list with, eg, a hash (with buckets, probably), which is O(n) average case, or some sort of tree structure, which is O(log n) average case.  Inserts are quick on a linked list if you don't bother to maintain any order, but searching and deletes are not; for most other structures inserts are a bit slower, but you get faster searching and deletes.<br>
<p>
Still if the tricky details of the new solution have been sorted out then there's no point in changing back now.  I guess time will tell.<br>
<p>
Ewen<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384641/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384644"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 21:46 UTC (Sat)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/384644/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Inserts are also quick if you do maintain order, simply by maintaining a pointer to the end of the list. You've only two pointers to update for the list (end of list and pointer to end of list) or am I forgetting something? Deletes could be sped up by making it double linked, and I can't think of why you'd ever need to perform a search... even if you needed to find a particular processes own structure for a page, seems like you'd start the search from that processes page table which can be done in a determinate amount of time, rather than from your own and then through the linked list.<br>
<p>
I don't know what other property you could be looking for, other than memory address or process id, that you could use as the value for an index or hash. If you were collecting a stat (such as the process that's using the page that runs the most, which could be a useful thing to know) you'd have to iterate through the lot. Maintaining an index of that value is loads more work that I can't see paying off. What other value, other than page address and process id, would you want to search on?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384644/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384649"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 22:21 UTC (Sat)
                               by <b>ewen</b> (subscriber, #4772)
                              [<a href="/Articles/384649/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you always insert at the start of the list, or always insert at the end of the list, then the order that you are maintaining is "order inserted" (either newest at start or newest at end).  This isn't necessarily what one means by an ordered list (except if you actually want a stack or a queue, both of which are "ordered by time").  Inserting anywhere else in the list, to order by a data value, requires finding that location, eg, page address, which requires either knowing the pointer to the immediately prior page address in the list, or going and finding same (O(n)).  (As you suggest deletes could be quick if you make the process track a pointer to the relevant entry in the link list, and use a double linked list, something I'd overlooked.)<br>
<p>
From what I can see "find by page address" is the only primitive that actually matters here (so you can find the references to that page); "find by process id" seems easiest done starting with the processes structures.  And the problem that we started with was a 1,000,000-long linked list which referenced multiple pages held by multiple processes.  So any structure which made it faster to find the entries for the appropriate page would help, providing its other overhead wasn't too high.<br>
<p>
Ewen<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384649/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor384633"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 20:45 UTC (Sat)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/384633/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <i>"That fix makes me wonder about the "daemon startup" situation"</i><br>
<br>
I don't think that matters (if I've interpreted what's said above correctly), as the page is unlikely to be unlinked from all the processes between the daemon fork()s taking place, as those initial processes are going to be pretty short lived. When the top process terminates, the next process down the list would have to take on the links, which will require some work, but no more than what would have to be done if this was done earlier in the game if you knew that the child was going to live longer. The only way it would save time would be if the memory was unlinked (eg, paged out), then paged back in and linked to the shorter running process - picking the longest running process would be more ideal. But yeah, for a process to be running long enough for this to happen probably rules out the ability to predict which is going to end sooner.


      
          <div class="CommentReplyButton">
            <form action="/Articles/384633/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor383442"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Anyone completed the exercise?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2010 6:08 UTC (Thu)
                               by <b>nikanth</b> (guest, #50093)
                              [<a href="/Articles/383442/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <code>the diagram for the 1000-child scenario which motivated this patch will be left as an exercise for the reader. </code><br/>

Has anyone completed the exercise. ;-)<br/>
Probably it shouldn't be daunting using the right tool + script. Even a video may be possible. :)
      
          <div class="CommentReplyButton">
            <form action="/Articles/383442/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor383605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Anyone completed the exercise?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 16, 2010 4:27 UTC (Fri)
                               by <b>pjm</b> (guest, #2080)
                              [<a href="/Articles/383605/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the point is just that standard tools like to avoid nodes overlapping each other, so if you have a million nodes on screen then each node must occupy only about 1 pixel, and you wouldn't be able to get any information about the problem other than a million sure is a big number, isn't it?.  But it wasn't really a serious suggestion for understanding the bug, which could be illustrated with just one or two child processes.<br>
<p>
(I was hoping to be able to point people to a certain impressive tool I've seen for interactively exploring large graphs, but I see that the code isn't yet publicly available.  However, it's expected to be redeveloped and GPL'd in a year or two, under the name Dunnart.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor383568"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 15, 2010 22:02 UTC (Thu)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/383568/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is it just me who's wondering whether all this complexity is worth it?<br>
<p>
What was it needed for again? To have a reverse mapping? Isn't that mostly useful for swapping and not much else? It seems silly to always add the overhead when it's almost never needed. Why not only have the overhead when actually swapping or whenever it's needed? Then this whole mess disappears from the common case and the complex stuff can be separated and isolated.<br>
<p>
I have to read more code and think more about it, preferably with a clear mind.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/383568/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384515"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2010 13:41 UTC (Fri)
                               by <b>rilder</b> (guest, #59804)
                              [<a href="/Articles/384515/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even I feel the same.  The scenario "In a workload with 1000 child processes and a VMA with 1000 anonymous pages per process that get COWed," -- may not arise in a normal desktop workload. In such as case won't this introduce additional overhead, unless this feature is introduced as a CONFIG variable which I don't think it is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384515/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384535"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 23, 2010 16:17 UTC (Fri)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/384535/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not only that, if the anon_vma isn't used for file caches, but only for anonymous pages then the whole thing seems dubious when swap is disabled.<br>
<p>
In addition to that, anon_vma apparently didn't solve the problem well, but instead of replacing it with something that does, more kludges are added on top of it. I got the feeling that there's some much more elegant solution waiting for someone to find it.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384535/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor384637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 20:59 UTC (Sat)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/384637/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
More complex doesn't necessarily mean less efficient. Having to search through all other pages belonging to all other processes, just to see who, if anyone, is sharing it with you, incures considerably more overhead. There're probably more reasons you'd want to do this than just at page swapout time too, maybe dealing with process memory limits - knowing who to charge the memory usage to, or with NUMA systems becoming more common, knowing whether it's worth moving a page to memory closer to the core running the majority of processes accessing it. Sure it's more complex to us, processing this extra information in our heads, but that little extra time can save a lot of time in the long run.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384650"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 22:48 UTC (Sat)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/384650/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're forgetting the memory overhead (including cache misses), not everything is pure CPU cycles. Besides that, this adds a cost to most memory operations, even if it turns out it was never necessary. Why slow down the common case to speed up special cases in rare situations?<br>
<p>
I don't have time to look further into the details, at least not this month. Hopefully next month.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384650/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384678"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 26, 2010 3:03 UTC (Mon)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/384678/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <i>"I don't have time to look further into the details"</i><br>
<br>
Well my guess is that they did, and that code that mostly slowed the memory manager down for savings only in a corner case would have been thrown out by Linus, as is often the way.


      
          <div class="CommentReplyButton">
            <form action="/Articles/384678/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor384719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 26, 2010 19:09 UTC (Mon)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/384719/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hope you're wrong. :-)<br>
<p>
This seems more a gradual development, with every thing on its own making sense at the time, but together still going in the wrong direction. It for sure isn't a big enough problem yet.<br>
<p>
It would be nice to know what the reverse mapping is used for besides swapping. It seems that the reverse mapping of files is a solved problem, but that all this complexity is only for anonymous memory. Which can only go away is you have swap enabled, or some obscure option like memory hotplug. (In the case of hibernation you need to scan all pages anyway, so no need for this either.) So I guess that my main complaint is that this is done even when not needed.<br>
<p>
For swap you only need a reverse mapping for pages that might get swapped out soon. I wonder if it's possible to create that mapping only for inactive pages instead of all of them all the time. Alternatively, swapping out can be done per-process, then there's no need for a reverse map. Shared pages are swapped out less quickly, but that's usually better anyway.<br>
<p>
The swapping system needs an overhaul anyway, it's very slow currently. This way both the VM and the swap systems can be improved.<br>
<p>
Improving the current code may not be easy, but it for sure is possible.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor385621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2010 20:02 UTC (Fri)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/385621/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm... I dunno, I would have thought that this isn't so much only needed for anonymous memory, but this may be the only reason why it's needed for anonymous memory, iyswim... that in other uses there are other reasons for it too, and so it can actually be simpler to just have it, than have it in some places and not in others. Anywhere you have copy-on-write pages it's going to be important, as the way you achieve that is to mark the pages read only. Someone tried to write to it, it causes a memory protection fault, which jumps into the VM code giving it the address of memory that the fault occured while trying to write. So where do you start if you don't have a back link to get from that address to the structures belonging to those using the page? You'd end up just doing loads of searching instead. The same goes for when it's something like memory mapped files, you need to know when the pages have been modified so you know it has to at some point be written back to disk. If you can't look up what's going on from the address it's going on at, things get way more complicated. Seems this is just basic accounting :-/<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/385621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor385722"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2010 12:17 UTC (Sat)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/385722/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is. Reverse mapping for file backed pages doesn't need anon_vma stuff, it's a lot simpler.<br>
<p>
You don't need a reverse mapping to do COW, when you get a pagefault you know the virtual address which caused it.<br>
<p>
Reverse mapping is needed to find all virtual pages belonging to a certain physical one. That isn't needed often for anonymous memory.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/385722/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor385910"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 3, 2010 16:51 UTC (Mon)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/385910/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're right about the page fault bit, my mistake, a reference count would be sufficient there, the reverse map would be for changing the backing for purposes of swap or migration in a NUMA or HIGHMEM system where quick knowledge page&lt;--&gt;active sets is required.<br>
Reverse mapping for file backed pages don't need anon_vma stuff obviously, because they're not anon. What they use isn't simpler though, as, for example, a library will often be shared by more address spaces than an anon page, it makes more sense to use a search tree (at least this used to be the case, according to a slightly dated early 2.6.x book detailing it. If it's now simpler than this, that would show kernel devs in fact simplifying things, not adding complexity).<br>
If you use none of these, go into your kernel conf and disable CONFIG_SWAP, CONFIG_NUMA and any CONFIG_HIGHMEM entries. If nothing else uses it, it'll either be removed, or worst case, a few greps will show you where the functions are being used elsewhere to throw a few #ifdef's around (I imagine embedded comunity would have interest in already doing this). <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/385910/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor384640"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The case of the overly anonymous anon_vma</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 24, 2010 21:15 UTC (Sat)
                               by <b>efexis</b> (guest, #26355)
                              [<a href="/Articles/384640/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fantastic. That last diagram is like a punchline, I wasn't completely with it until that last one which triggered what I refer to as a "cascade of realisation", which is like a nice brain massage :-) much appreciated.<br>
<p>
Not so appreciated though was the pointing to a 2004 article that I remember reading like it was just erm... 200err... 2007? Way to make me feel old for the first time ever ;-p<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/384640/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
