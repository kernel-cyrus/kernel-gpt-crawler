        <!DOCTYPE html>
        <html lang="en">
        <head><title>Link-time optimization for the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/512548/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/511725/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/512548/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Link-time optimization for the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 21, 2012</br>
           </div>
The kernel tends to place an upper limit on how quickly any given workload
can run, so it is unsurprising that kernel developers are always on the
lookout for ways to make the system go faster.  Significant amounts of work
can be put into optimizations that, on the surface, seem small.  So when
the opportunity comes to make the kernel go faster without the need to
rewrite any performance-critical code paths, there will naturally be a fair
amount of interest.  Whether the "link-time optimization" (LTO) feature
supported by recent versions of GCC is such an opportunity or not is yet to
be proved, but Andi Kleen is determined to find out.
<p>
The idea behind LTO is to examine the entire program after the individual
files have been compiled and exploit any additional optimization
opportunities that appear.  The most significant of those opportunities
appears to be the inlining of small functions across object files.  The
compiler can also be more aggressive about detecting and eliminating unused
code and data.  Under the hood, LTO works by dumping the compiler's
intermediate representation (the "GIMPLE" code) into the resulting object
file whenever a source file is compiled.  The actual LTO stage is then
carried out by loading all of the GIMPLE code into a single in-core image
and rewriting the (presumably) further-optimized object code.
<p>
The LTO feature first appeared in GCC 4.5, but it has only really started
to become useful in the 4.7 release.  It still has a number of limitations;
one of those is that all of the object files involved must be compiled with
the same set of command-line options.  That limitation turns out to be a
problem with the kernel, as will be seen below.
<p>
Andi's <a href="/Articles/512335/">LTO patch set</a> weighs in at 74
changesets â€” not a small or unintrusive change.  But it turns out that most
of the changes have the same basic scope: ensuring that the compiler knows
that specific symbols are needed even if they appear to be unused; that
prevents the LTO stage from optimizing them away.  For example, symbols
exported to modules may not have any callers in the core kernel itself, but
they need to be preserved for modules that may be loaded later.  
To that end, Andi's
first patch defines a new attribute (<tt>__visible</tt>) used to mark such
symbols; most of the remaining patches are dedicated to the addition of
<tt>__visible</tt> attributes where they are needed.
<p>
Beyond that, there is a small set of fixes for specific problems
encountered when building kernels with LTO.  It seems that functions with
long argument lists <a href="/Articles/512685/">can get their arguments
corrupted</a> if the functions are 
inlined during the LTO stage; avoiding that requires marking the functions
<tt>noinline</tt>.  Andi complains "<q>I wish there was a generic way to
handle this. Seems like a ticking time bomb problem.</q>"  In general,
he acknowledges the possibility that LTO may introduce new,
optimization-related bugs into the kernel; finding all of those could be a
challenge.
<p>
Then there is the requirement that all files be built with the same set of
options.  Current kernels are not built that way; different options are
used in different parts of the tree.  In some places, this problem can be
worked around by disabling specific optimizations that depend on different
compiler flags than are used in the rest of the kernel.  In others, though,
features must simply be disabled to use 
LTO.  These include the "modversions" feature (allowing kernel modules to
be used with more than one kernel version) and the function tracer.
Modversions seems to be fixable; getting ftrace to work may require changes
to GCC, though.
<p>
It is also necessary, of course, to change the build system to use the GCC
LTO feature.  As of this writing, one must have a current GCC release; it is
also necessary to install a development version of the binutils package for
LTO to work.  Even a minimal kernel requires about 4GB of memory for the
LTO pass; an "allyesconfig" build could require as much as 9GB.  Given
that, the use of 32-bit systems for LTO kernel builds is out of the
question; it is still possible, of course, to build a 32-bit kernel on a
64-bit system.  The build will also take between two and four times as long
as it does without LTO.  So developers are unlikely to make much use of LTO
for their own work, but it might be of interest to distributors and others
who are building production kernels.
<p>
The fact that most people will not want to do LTO builds actually poses a
bit of a problem.  Given the potential for LTO to introduce subtle bugs,
due either to optimization-related misunderstandings or simple bugs in the
new LTO feature itself, widespread testing is clearly called for before LTO
is used for production kernels.  But if developers and testers are
unwilling to do such heavyweight builds, that testing may be hard to come
by.  That will make it harder to achieve the level of confidence that will
be needed before LTO-built kernels can be used in real-world settings.
<p>
Given the above challenges, the size of the patch set, and the ongoing
maintenance burden of keeping LTO working, one might well wonder if it is
all worth it.  And that comes down entirely to the numbers: how much faster
does the kernel get when LTO is used?  Hard numbers are not readily
available at this time; the LTO patch set is new and there are still a lot
of things to be fixed.  Andi <a href="/Articles/512554/">reports</a> that
runs of the "hackbench" benchmark gain about 5%, while kernel builds don't
change much at all.  Some networking benchmarks improve as much as 18%.
There are also some unspecified "minor regressions."  The numbers are
rough, but Andi believes they are encouraging enough to justify further
work; he also expects the LTO implementation in GCC to improve over time.  
<p>
Andi also suggests that, in the long term, LTO could help to improve the
quality of the kernel code base by eliminating the need to put inline
functions into include files.
<p>
All told, this is a patch set in a very early stage of development; it
seems unlikely to be proposed for merging into a near-term kernel, even as
an experimental feature.  In the longer term, though, it could lead to
faster kernels; use of LTO in the kernel could also help to drive
improvements in the GCC implementation that would benefit all projects.  So
it is an effort that is worth keeping an eye on.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Build_system">Build system</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Optimization_tools">Optimization tools</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/512548/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor512700"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 14:40 UTC (Tue)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/512700/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Besides speed improvements, LTO is useful for PaX's GCC plugins aimed at reporting (e.g. k*alloc allocation size stats) and hardening (size overflow, KERNEXEC/amd64, constification of structures containing only function pointers unless they're marked __no_const or are detectably modified somewhere, etc.).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512700/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512714"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 15:25 UTC (Tue)
                               by <b>ewan</b> (guest, #5533)
                              [<a href="/Articles/512714/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <i>"The fact that most people will not want to do LTO builds actually poses a bit of a problem."</i>
<p>
As long as there are Gentoo users there will be someone to test massively resource intensive compiler optimisations of uncertain benefit.
      
          <div class="CommentReplyButton">
            <form action="/Articles/512714/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512750"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 16:29 UTC (Tue)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/512750/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You're trolling...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512750/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 16:59 UTC (Tue)
                               by <b>Homer512</b> (subscriber, #85295)
                              [<a href="/Articles/512755/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But not far from the truth:<br>
<a href="http://realnc.blogspot.de/2012/06/building-gentoo-linux-with-gcc-47-and.html">http://realnc.blogspot.de/2012/06/building-gentoo-linux-w...</a><br>
<p>
(Gentoo user myself, so this is not meant mockingly)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513008"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 0:53 UTC (Thu)
                               by <b>prometheanfire</b> (subscriber, #65683)
                              [<a href="/Articles/513008/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Someone has to find the bugs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513008/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor512754"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 17:08 UTC (Tue)
                               by <b>mikemol</b> (guest, #83507)
                              [<a href="/Articles/512754/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yet he's right. And I say this as an enthusiastic Gentoo user who's done some automation to find optimum configurations. :)<br>
<p>
In reality, though, building a kernel with LTO isn't going to take as long as, say, building LibreOffice, Firefox or Chromium. Those take sufficiently long that more than a few Gentoo users prefer to use binary ebuilds rather than build them themselves.<br>
<p>
What's really needed here, though, are automated regression tests to improve the confidence that the output of an LTO build isn't the most likely source of problems. That's the kind of thing that would need massive corporate sponsorship to get off the ground, though; there's a *ton* of code in the kernel, and while it's reasonably well-organized, that's still a lot of tests to write.<br>
<p>
It's also necessary to understand that you can't be 100% confident you've caught all possible compiler-introduced bugs. The best you might be able to do is identify the portions of the kernel which the LTO pass twiddled the most, and write additional tests to exercise that code from multiple angles.<br>
<p>
I wonder if such an "LTO hotspot" analysis could be used to do certain high-level reasoning about the code. Being able to answer questions like "given that LTO-active regions have some relation to a property of the APIs in that area, is that property something we want to see more or less of in our APIs?" would be interesting; it could help inform tradeoffs in future designs of APIs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512754/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor512758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial LTO?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 17:19 UTC (Tue)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/512758/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The kernel already does a lot of partial linking (ld -r) in its build. Could it do partial LTO too? That is, LTO a few of the major directories separately (kernel, mm, fs, net, arch - probably everything but drivers), and do not LTO the final link step. This would give smaller gains, but would also compile faster.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512831"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial LTO?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 4:50 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/512831/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At what granularity is it partially linking?  If it's of the sort where a library of functions gets partially linked separately of all the places that call that library, the impact of LTO should be noticeably lessened.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512831/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512883"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial LTO?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 13:23 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/512883/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's just ld -r, and it's done in every directory in the kernel tree (that has any .o files in it at all), generating either module.o or built-in.o files that are then linked together to generate final modules or the kernel proper (though the kernel proper also has a bunch of other object files, most of the bulk is in built-in.o files). The LTO sections should get carried along with this, and then at full link time the linker plugin should pick them up and do a full LTO.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512883/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512900"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial LTO?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 14:22 UTC (Wed)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/512900/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <P>I kinda figured it was something such as by-directory (it certainly appeared that way last time I built a kernel).  I was pretty sure the normal flow carried the serialized GIMPLE down to the end for the final LTO.  Where the boundary becomes important is if you try to implement cesarb's partial-LTO suggestion.
</P><P>
If you did a "partial LTO", where you munged all the GIMPLE together and generated a new object in place of the partially linked library, and <I>didn't</I> pass the GIMPLE up to the next level, you'd be leaving many of the most interesting optimizations aside if many come from optimizing library and core code into the bodies of drivers and other leaves.</P>
<P>It doesn't make sense to re-codegen at partial link time unless your intent is to throw away the GIMPLE, or provide a library that could be linked both with and without further LTO (which seems... weird?).</P>
      
          <div class="CommentReplyButton">
            <form action="/Articles/512900/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor513153"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial LTO?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 17:08 UTC (Thu)
                               by <b>rriggs</b> (guest, #11598)
                              [<a href="/Articles/513153/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you build and then load *any* kernel modules, it is, by definition, partial LTO.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513153/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513194"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Partial LTO?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 19:33 UTC (Thu)
                               by <b>jzbiciak</b> (guest, #5246)
                              [<a href="/Articles/513194/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <P>Fair enough, but only at the module boundary.  Isn't this the same as any DSO?  I mean, it's not as if LTO is bringing in libc and all the other shared libraries your other shared libraries when you use it in user-space, is it?
</P><P>
The point is, to get the full benefit of LTO in the kernel, you want to be able to inline or optimize across boundaries such as<TT> arch/arm/ </TT>and<TT> kernel/</TT>, for example.  (At least, if I understood correctly.)  If those are both LTO'd at their respective directory boundaries, and only linked traditionally at the last step, you lose those opportunities.
</P><P>
Sure, drivers built as modules miss out.  But, my gut feel (which may be wrong!) is that there's still plenty of things that are compiled in that ought to benefit that won't if you limit LTO to the partial link boundaries.</P>
      
          <div class="CommentReplyButton">
            <form action="/Articles/513194/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor512771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 18:09 UTC (Tue)
                               by <b>pj</b> (subscriber, #4506)
                              [<a href="/Articles/512771/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Andi reports that runs of the "hackbench" benchmark gain about 5%, while kernel builds don't change much at all. Some networking benchmarks improve as much as 18%.</font><br>
<p>
Does this help point out that the networking code could be better link-optimized, even if the rest of the kernel isn't?  I mean, if the kernel is being built with different gcc commandlines anyway, does this mean that the network-code-building bits could perhaps be better optimized?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 20:57 UTC (Tue)
                               by <b>maleadt</b> (guest, #59198)
                              [<a href="/Articles/512786/">Link</a>] 
      </p>
      
      </div>
      </summary>
      There has been done <a href="http://trappist.elis.ugent.be/~brdsutte/research/publications/bibtex.html#TECS07a">similar work</a> in my research lab, performing LTO-optimizations on 2.4 kernels, starting from ARM and x86 object files.
      
          <div class="CommentReplyButton">
            <form action="/Articles/512786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512791"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 22:16 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/512791/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As a minor point, GCC can decompose a good bit of the memory-hungry bit of LTO into pieces and then run them in parallel via the -flto={number} option: -flto=jobserver will participate in GNU Make's jobserver feature and run as many LTO instances as that permits (it does this without needing to understand the jobserver protocol via the rather nifty approach of writing a makefile to do the work, running make, and passing it the appropriate jobserver fds).<br>
<p>
This way, you can push the memory usage down about as far as a normal compilation for about 90% of the time. Some of the work is nonparallelizable, though, and that will still require a good bit of memory.<br>
<p>
(The description of what LTO does is also somewhat unclear. It works by serializing the GIMPLE intermediate representation into special sections in the object files before carrying out most optimization, then, at link time (via the compiler driver, or, for .a files, via a special linker plugin supported by gold and by recent versions of GNU ld) reading the whole lot back in and then running the whole lot through the optimizer almost as if it were a single source file. But that 'almost' covers a multitude of sins, and in order to be useful in practice the thing had to be parallelizable as well. It was a *lot* of work to make GCC capable of this, and I for one believed it could never be made to work reliably. I was wrong.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512791/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512808"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 23:22 UTC (Tue)
                               by <b>andikleen</b> (guest, #39006)
                              [<a href="/Articles/512808/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the article<br>
<p>
I should clarify that the sysycall argument problem in<br>
<a href="http://lwn.net/Articles/512685/">http://lwn.net/Articles/512685/</a><br>
is not LTO specific. It's a general problem that the 32bit kernel violates the ABI. It uses some stack arguments for syscalls inside the kernel. The actual syscall interface is defined with registers, but the interface between the syscall entry code and the actual syscall has stack arguments.<br>
<p>
The kernel entry code saves all registers on the stack. The same area also doubles as the stack arguments for syscalls.<br>
<p>
According to the ABI it's legal for the compiler to change arguments on the stack. But the 32bit kernel cannot tolerate this because it corrupts the saved user space registers.<br>
<p>
My 32bit LTO kernel just happened to hit this and the "noinline" is just a workaround to change the register allocation. But there's nothing wrong with inlining in LTO.<br>
<p>
The problem could happen without LTO too.<br>
<p>
64bit kernel don't have this problem because they pass all 6 syscall arguments in registers even inside the kernel.<br>
<p>
It was also not fun to debug.<br>
<p>
-Andi Kleen<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512808/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512821"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 1:56 UTC (Wed)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/512821/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds like it's not worth trying to support LTO for x86 kernels until it's a proven win on amd64.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512821/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 3:19 UTC (Wed)
                               by <b>andikleen</b> (guest, #39006)
                              [<a href="/Articles/512823/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think the problem is that common. We can work around it too.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor513040"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 8:07 UTC (Thu)
                               by <b>gb</b> (subscriber, #58328)
                              [<a href="/Articles/513040/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting experiment, but what's the point of building 32-bit kernels at this moment then 64-bit installations are more common than 32-bit?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513040/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513196"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 19:31 UTC (Thu)
                               by <b>stevenb</b> (guest, #11536)
                              [<a href="/Articles/513196/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is that really true in the mobile space? ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513196/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513312"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2012 12:14 UTC (Fri)
                               by <b>misiu_mp</b> (guest, #41936)
                              [<a href="/Articles/513312/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the mobile space we have arm and it has plenty of registers doesn't it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513312/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513542"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 26, 2012 4:05 UTC (Sun)
                               by <b>theICEBear</b> (guest, #23193)
                              [<a href="/Articles/513542/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It does and AArch64 is not far away, given rate of change within the mobile/pad fad-driven world the new chips will start hitting market sooner rather than later.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513542/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor513718"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 27, 2012 20:01 UTC (Mon)
                               by <b>stevenb</b> (guest, #11536)
                              [<a href="/Articles/513718/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was thinking more of 32-bits Atom.<br>
<p>
ARM Thumb wouldn't have many registers either, but I don't know whether you could (or could want to) build an ARM Thumb linux kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513718/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor514403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 30, 2012 19:20 UTC (Thu)
                               by <b>cibervicho</b> (guest, #52552)
                              [<a href="/Articles/514403/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>ARM Thumb wouldn't have many registers either, but I don't know whether you could (or could want to) build an ARM Thumb linux kernel.</blockquote>

Thumb and Thumb-2 have as many registers as ARM (32-bit).  You can build a Thumb-2 kernel with <tt>CONFIG_THUMB2_KERNEL=y</tt>
      
          <div class="CommentReplyButton">
            <form action="/Articles/514403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor512810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2012 23:29 UTC (Tue)
                               by <b>cavok</b> (subscriber, #33216)
                              [<a href="/Articles/512810/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Andi also suggests that, in the long term, LTO could help to improve the quality of the kernel code base by eliminating the need to put inline functions into include files."<br>
<p>
Looking at the quality of the kernel also supporting LLVM would help on the long term.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512824"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 3:30 UTC (Wed)
                               by <b>andikleen</b> (guest, #39006)
                              [<a href="/Articles/512824/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On 32bit LTO builds with 32bit compilers.<br>
<p>
I only tried it with a 64bit compiler.<br>
<p>
I didn't say needs at least 4GB actually, just that needs not more than 4GB.<br>
<p>
The limiting phase is the WPA step that merges all the types. That is a single process. The actual code generation runs with multiple processes later in the LTO-WHOPR build, so is just limited by how many -j* threads are used.<br>
<p>
The 32bit compiler will need less memory than the 64bit compiler because a large amount of the compiler memory is pointers, and those are only half as big. So there's a good chance that a normal modular or reasonable sized monolithic build will fit in ~2-3GB or so, which is the limit on a normal 32bit kernel with 32bit compiler<br>
<p>
Very large monolithic builds like allyes will not work <br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512824/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512880"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 13:19 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/512880/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
allyes, or enterprise distro kernels. I don't think we can really call them 'reasonable' either (2000+ modules, great ghu). Still, the enterprise distro people can surely do 64-&gt;32-bit cross-compilation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512880/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512881"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 13:21 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/512881/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And of course as soon as I post this I realise that having heaps of modules will pose no problem at all: LTO doesn't run over those and the kernel as a unit. I wish LWN let me delete things I posted for a few minutes after posting them...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512881/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512887"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 13:34 UTC (Wed)
                               by <b>andikleen</b> (guest, #39006)
                              [<a href="/Articles/512887/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Distro modular kernels should be ok, each module is LTOed on its own and the vmlinux is not too big. The limit is only the largest binary.<br>
<p>
That said I haven't actually tried it with a 32bit compiler. Testing welcome.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512887/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512936"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 18:25 UTC (Wed)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/512936/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This will create yet another advantage to having a monolithic kernel instead of using dozens of modules for your basic functions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512936/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513332"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2012 15:49 UTC (Fri)
                               by <b>malor</b> (guest, #2973)
                              [<a href="/Articles/513332/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do monolithic kernels even work anymore?  Back in the Stone Age, I used to compile my kernels statically to prevent module-load hacks, but as I recall, that support was mostly removed...  my memory is unclear, but I under the impression that it was no longer really possible to run Linux without using loadable modules. <br>
<p>
Is that incorrect?  Are static kernels actually reasonably possible?<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513332/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513338"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2012 16:12 UTC (Fri)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/513338/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They are, there's just little reason to use them - especially since you'll probably need to build in any loadable firmware, which may make the result undistributable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513338/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513402"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2012 23:01 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/513402/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that depends on the firmware on on your interpretation of the requirements for source for that firmware.<br>
<p>
I haven't seen anyone sued for the source of a firmware blob if the firmware blob itself didn't included GPL code in it. (as opposed to the firmware blob being used as data by GPL code and uploaded to a device)<br>
<p>
A lot of the linux kernel developers consider the splitting of the firmware out of the source tree to be a waste of time from a technical and legal point of view, but they don't fight it because it shuts up the people who think that it does matter from a legal point of view.<br>
<p>
besides, the GPL only comes in to play when you distribute the resulting binary. There's a huge amount of stuff that you can do (especially in a large company) without triggering this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513402/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 25, 2012 4:44 UTC (Sat)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/513459/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Which may make the result undistributable" - you appear to have just spent several paragraphs agreeing with me. What was your point?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor513464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">On LTO builds with 32bit compilers.</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 25, 2012 5:06 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/513464/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ok, "MAY" make the result undistributable, heavy emphasis and lots of doubt on the word MAY<br>
<p>
There are a LOT of people who don't think it would.<br>
<p>
Also, even if it did, it wouldn't matter for lots of people, because they don't distribute the resulting binaries.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor512846"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 8:15 UTC (Wed)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/512846/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
AFAIK there's another benefit of LTO: it can merge identical functions and data from multiple object files. This is especially beneficial for C++, where, for example, every time one #includes &lt;cstream&gt;, the compiler generates several stubs which turn out to be identical and unnecessarily duplicated. This and other optimizations usually result in about 10% reduction in the final binary's size.<br>
<p>
That said, I notice that the kernel actually grows with LTO. The modules do get smaller - especially large ones like GPU and filesystem drivers - but not vmlinuz.<br>
<p>
Oh, and the development version which will become GCC 4.8 reduces memory use even further. So much that it can actually build itself on my machine with 8 gigs of ram, although with some swapping :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512846/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 13:34 UTC (Wed)
                               by <b>jwakely</b> (subscriber, #60262)
                              [<a href="/Articles/512882/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; it can merge identical functions and data from multiple object files</font><br>
<p>
But in practice does it actually do so?<br>
<p>
<font class="QuotedText">&gt; every time one #includes &lt;cstream&gt;, the compiler generates several stubs which turn out to be identical and unnecessarily duplicated</font><br>
<p>
I assume you mean &lt;iostream&gt;, and AFAIK LTO doesn't change that situation at all (see <a href="http://gcc.gnu.org/bugzilla/show_bug.cgi?id=44952">http://gcc.gnu.org/bugzilla/show_bug.cgi?id=44952</a> for a suggestion to make it do so, and other suggestions that wouldn't rely on LTO.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 13:37 UTC (Wed)
                               by <b>andikleen</b> (guest, #39006)
                              [<a href="/Articles/512888/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don't think that works currently with LTO<br>
<p>
There were some linker based approaches for this though (it only really needs a checksum per function)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor512935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 18:19 UTC (Wed)
                               by <b>stevenb</b> (guest, #11536)
                              [<a href="/Articles/512935/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
GCC doesn't do this, but AFAIU the gold linker's icf.cc does this. From binutils-2.22:src/gold/icf.cc:<br>
<p>
// Identical Code Folding Algorithm<br>
// ----------------------------------<br>
// Detecting identical functions is done here and the basic algorithm<br>
// is as follows. A checksum is computed on each foldable section using<br>
// its contents and relocations. If the symbol name corresponding to<br>
// a relocation is known it is used to compute the checksum. If the<br>
// symbol name is not known the stringified name of the object and the<br>
// section number pointed to by the relocation is used. The checksums<br>
// are stored as keys in a hash map and a section is identical to some<br>
// other section if its checksum is already present in the hash map.<br>
// Checksum collisions are handled by using a multimap and explicitly<br>
// checking the contents when two sections have the same checksum.<br>
//<br>
// However, two functions A and B with identical text but with<br>
// relocations pointing to different foldable sections can be identical if<br>
// the corresponding foldable sections to which their relocations point to<br>
// turn out to be identical. Hence, this checksumming process must be<br>
// done repeatedly until convergence is obtained. <br>
<p>
Whether this works with LTO, I don't know. And I suppose it requires -ffunction-sections but I'm not sure about that either.<br>
<p>
Not a very helpful post, sorry ;-) <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor512992"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2012 22:43 UTC (Wed)
                               by <b>andikleen</b> (guest, #39006)
                              [<a href="/Articles/512992/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
gold unfortunately does not work with LTO kernel builds at the moment.<br>
You could only use it without.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/512992/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor513066"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 10:05 UTC (Thu)
                               by <b>jwakely</b> (subscriber, #60262)
                              [<a href="/Articles/513066/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No need to apologise, I'd somehow missed that gold did ICF and thought Microsoft's was the only mainstream linker to support it. Thanks, Steven!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513066/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor611528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2014 4:34 UTC (Thu)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/611528/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was just reading about Open Mirage<br>
<p>
<a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">http://anil.recoil.org/papers/2013-asplos-mirage.pdf</a><br>
<p>
and thinking about the security advantages of the "sealed" unikernel with its Write XOR Execute policy.  The paper comments about linking:<br>
<p>
"Unikernels link li-<br>
braries that would normally be provided by the host OS, allowing<br>
the Unikernel tools to produce highly compact binaries via the nor-<br>
mal linking mechanism. **Features that are not used in a particular<br>
compilation are not included** and whole-system optimization tech-<br>
niques can be used. In the most specialised mode, all configuration<br>
files are statically evaluated, enabling extensive dead-code elimi-<br>
nation at the cost of having to recompile to reconfigure the service."<br>
<p>
Reading that paragraph motivated me to revisit this LTO dicussion.   I can't figure out whether LTO commonly includes "dead-code elimination," meaning that functions from a statically linked library that are not anywhere used are not included in the final binary.   In other words, are functions either include in-line, or not included at all?   Thanks to any experts who wander by and know the answer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/611528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor612300"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2014 21:39 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/612300/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Functions that are used nowhere (and, if this is a shared library or a binary compiled with -Wl,--export-dynamic, are not in the external symbol table) are eliminated, but that doesn't mean all the rest are inlined. Most will not be inlined (indeed, some may be cloned without being inlined).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/612300/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor513069"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 23, 2012 10:19 UTC (Thu)
                               by <b>mgedmin</b> (subscriber, #34497)
                              [<a href="/Articles/513069/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wasn't there recently a post about a kernel bug caused by the compiler merging two different functions that turned out to contain identical code?  IIRC it was caused by a check of a function pointer in order to determine an object's type misfiring.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513069/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor513327"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2012 15:01 UTC (Fri)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/513327/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But it turns out that most of the changes have the same basic scope: ensuring that the compiler knows that specific symbols are needed even if they appear to be unused; that prevents the LTO stage from optimizing them away. For example, symbols exported to modules may not have any callers in the core kernel itself, but they need to be preserved for modules that may be loaded later. To that end, Andi's first patch defines a new attribute (__visible) used to mark such symbols</font><br>
<p>
One more thing... If I disable loadable modules (CONFIG_MODULES=n), does this also get disabled? I think I have nothing to fear from the symbol reaper if there's no way to use these symbols outside the core kernel :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/513327/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor514559"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Link-time optimization for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2012 19:05 UTC (Fri)
                               by <b>dbarnes</b> (guest, #75204)
                              [<a href="/Articles/514559/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Will existing patents on LTO (5966539, 5999737) affect this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/514559/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2012, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
