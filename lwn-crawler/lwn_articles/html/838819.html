        <!DOCTYPE html>
        <html lang="en">
        <head><title>XFS, stable kernels, and -rc releases [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/838819/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/838888/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/838819/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>XFS, stable kernels, and -rc releases</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 3, 2020</br>
           </div>
Ever since the stable-update process was created, there have been questions
about which patches are suitable for inclusion in those updates; usually,
these discussions are driven by people who think that the criteria should
be more restrictive.  A regression in the XFS filesystem that found its way
into the <a
href="/ml/linux-kernel/1605788188121239@kroah.com/">5.9.9</a>
stable update briefly rekindled this discussion.  In one sense, there was
little new ground covered in this iteration, but there was an interesting
point raised about the relationship between stable updates and the mainline
kernel -rc releases.
<p>
In the beginning, stable updates were restricted to critical fixes only,
but the rules were relaxed over time.  The patches merged for stable
updates now are often <a href="/Articles/764647/">automatically
selected</a> using a machine-learning system; others are picked because
they look like they fix something somewhere.  The result has been a massive
increase in the number of patches going into the stable updates; the 5.9.x
series has had over 1,900 patches applied through 5.9.11, while the delta
between 4.9 and 4.9.246 is well over 18,000 patches.
<p>
Incorporating all those patches undoubtedly has the effect of increasing the number
of useful fixes in the stable releases, which is a good thing.  But it also
increases the chances of merging bad patches that provide users with
something other than the problem-free experience they were looking for.
<p>
For example, <a
href="/ml/linux-xfs/160494584816.772693.2490433010759557816.stgit@magnolia/">this
XFS "fix"</a> was posted to the linux-xfs list on November&nbsp;9; it was
reviewed, applied, and eventually <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6ff646b2ceb0">pushed
to the mainline</a> four days later, where it appeared in the <a
href="/ml/linux-kernel/CAHk-=wjFfAktnadOPb_iV5nKh=V5Am1sG-gciYveswRtuEkrLQ@mail.gmail.com/">5.10-rc4</a>
release.  On the 17th, Greg Kroah-Hartman included this patch in the <a
href="/ml/linux-kernel/20201117122138.925150709@linuxfoundation.org/">5.9.9
review cycle</a>, along with 254 other fixes.  No objections were raised,
and the patch was part of the 5.9.9 release on the 19th, ten days after it
was originally posted.
<p>
It took three days for Nick Alcock to <a
href="/ml/linux-xfs/87lfetme3f.fsf@esperi.org.uk/">report</a> that he was
getting XFS corruption errors when running a current stable kernel.  Wong's
patch was the source of this problem — indeed, the XFS developers had
already <a href="https://git.kernel.org/linus/eb8409071a1d4">reverted
it</a> in the mainline for 5.10-rc5 (with Eric Sandeen credited for the
report).  That revert found its way into the <a 
href="/ml/linux-kernel/160623671354173@kroah.com/">5.9.11</a> update on
November&nbsp;24.  So there was a period of about five days when the
current stable 5.9 kernel had a bug that made XFS filesystems unusable in
some configurations.  It's worth noting that, even though XFS reported
corruption, no actual filesystems were corrupted; they simply refused to
mount.
<p>
That was the end of this incident — at least, until the stable-kernel
machine-learning system <a
href="/ml/linux-kernel/20201125153550.810101-33-sashal@kernel.org/">picked
another XFS patch</a> for a future 5.9.x release.  At that point, Dave
Chinner <a
href="/ml/linux-kernel/20201125215247.GD2842436@dread.disaster.area/">objected</a>:
<p>
<div class="BigQuote">
	We've already had one XFS upstream kernel regression in this -rc
	cycle propagated to the stable kernels in 5.9.9 because the stable
	process picked up a bunch of random XFS fixes within hours of them
	being merged by Linus. One of those commits was a result of a
	thinko, and despite the fact we found it and reverted it within a
	few days, users of stable kernels have been exposed to it for a
	couple of weeks. That *should never have happened*.
</div>
<p>
Chinner said that the stable process is cutting out some of the time that
is needed to find problems in patches merged into the mainline, and
requested that XFS patches not be selected for stable updates until after
they have appeared in a final mainline release.
<p>
Sasha Levin, who maintains the automated patch-selection system, <a
href="/ml/linux-kernel/20201125234654.GN643756@sasha-vm/">replied</a> that
the real failing was in the XFS quality-control process which, he said,
should never have let the buggy patch through in the first place.  By the
time something is in the mainline, he said, it is assumed to be correct:
<p>
<div class="BigQuote">
	The stable process assumes that commits that ended up upstream were
	reviewed and tested; the stable process doesn't offer much in the
	way of in-depth review of specific patches but mostly focuses on
	testing the product of backporting hundreds of patches into each
	stable branch.
</div>
<p>
Chinner <a
href="/ml/linux-kernel/20201126071323.GF2842436@dread.disaster.area/">took
strong exception</a> to Levin's attempt to pin the blame on the XFS side.
The bug, it seems, only manifests in settings where a newer user space is
interacting with an older kernel, which is not a scenario that is tested
prior to merging patches.  Follow-on testing done by the XFS developers did
eventually turn up the problem, at which point it was fixed.  It is not
reasonable, he said, to expect that every patch go through that degree of
testing before being applied.
<p>
The important point, he said, was that not all problems can realistically
be found before patches land in the mainline:
<p>
<div class="BigQuote">
	I'll repeat the lesson to be learned here: merging a commit into
	Linus's tree does not mean it is fully tested and production ready.
	It just means it's passed a wide range of unit tests without
	regressions and so is considered ready for wider integration
	testing by a larger population of developers and testers.
</div>
<p>
He said, again, that the stable process needs to slow down some to allow
for that wider testing to take place, and later <a
href="/ml/linux-kernel/20201202204045.GM2842436@dread.disaster.area/">repeated
this argument</a> in a separate discussion, drawing <a
href="/ml/linux-kernel/X8gBUc0fkdh6KK01@kroah.com/">an objection</a> from
Kroah-Hartman:
<p>
<div class="BigQuote">
	That means that the world would go for 3 months without some known
	fixes being applied to the tree?  That's not acceptable to me, as I
	started doing this because it was needed to be done, not just
	because I wanted to do more work...
</div>
<p>
Chinner then <a
href="/ml/linux-kernel/20201203015003.GN2842436@dread.disaster.area/">clarified</a>
that most subsystems, as he saw it, did not need this sort of delay.  He
also suggested that perhaps waiting for two -rc cycles would be
sufficient for subsystems where the risk of catastrophic regressions
(filesystems, for example) is high.

<p>
The need for more time to test patches before applying them to the stable
updates has been recognized in the past.  Initially, any 
patch that had made it into the mainline was considered fair game for
stable-update consideration.  Later on, though, the rule was changed to
require patches to appear in at least one -rc release first.  But that
still does not give a whole lot of time for problems in the mainline to
come to light.
<p>
The fact that -rc releases may contain bugs is implicit in the fact that
every development cycle involves seven or eight such releases.  Getting
into an -rc release is not deemed enough for a patch to appear in a final
mainline release; patches are expected to survive testing for a few -rc
releases first.  But the stable updates can ship those patches immediately
after they appear in an -rc release.
Thus, in a sense, the mainline, which is not considered
stable enough for most installations, has a more stringent requirement than
the stable releases, which are widely used.
<p>
The conversations ended at this point, with no indications that any minds
were changed.  There can be no doubt that this topic will return, though.
Bugs introduced into stable releases go against the reasons for using those
releases in the first place, so they can be expected to draw attention.
The number of such bugs will never be zero, though, regardless of how slow
or careful the process is.  A balance has to be found between the need to
get as many fixes as possible to users as quickly as possible and the need
to avoid regressions.  If the "after one -rc release" rule allows too many
regressions, then perhaps it is time for the community to more clearly
articulate what it means when a patch lands in the mainline and adjust the
stable-update selection process accordingly.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-Stable_tree">Development model/Stable tree</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-XFS">Filesystems/XFS</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/838819/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor838902"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2020 19:05 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/838902/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; merging a commit into Linus&#x27;s tree does not mean it is fully tested and production ready. It just means it&#x27;s passed a wide range of unit tests without regressions and so is considered ready for wider integration testing by a larger population of developers and testers. </font><br>
<p>
Maybe some people don&#x27;t want this to be true, but it clearly is.<br>
<p>
For example see<br>
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8ee74a91ac304ad2e9e794eb96ed76f0634dec40">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a><br>
<p>
<font class="QuotedText">&gt; proc: try to remove use of FOLL_FORCE entirely</font><br>
<font class="QuotedText">&gt; We fixed the bugs in it, but it&#x27;s still an ugly interface, so let&#x27;s see if anybody actually depends on it.</font><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838902/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor838905"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2020 20:43 UTC (Thu)
                               by <b>dxin</b> (guest, #136611)
                              [<a href="/Articles/838905/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;Sasha Levin, who maintains the automated patch-selection system, replied that the real failing was in the XFS quality-control process which, he said, should never have let the buggy patch through in the first place. By the time something is in the mainline, he said, it is assumed to be correct&quot;<br>
<p>
Truthful to not, this assumption is a little far from reality. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838905/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 0:16 UTC (Fri)
                               by <b>sashal</b> (<b>&#x272D; supporter &#x272D;</b>, #81842)
                              [<a href="/Articles/838914/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is because at the point the patch lands upstream, the relevant maintainers signed off on it, so the additional review in the stable process is not about the correctness of the patch itself but rather the relevancy of the patch of the stable branches as well as the correctness of the backport.<br>
<p>
My argument isn&#x27;t that patches that land upstream are 100% correct; if that was the case we wouldn&#x27;t need any of those pesky stable trees, right?<br>
<p>
The assumption is stable&#x27;s way of saying that we&#x27;ve subjected the patch to everything in our arsenal and we deem this patch to be at a good tradeoff point between assuring the stability of the tree vs shipping patches in a timely fashion.<br>
<p>
If you rely on the stable tree, please participate in the process by testing the -rc releases and reporting back of issues - we&#x27;ll never ship a release with known reported issues.<br>
<p>
I&#x27;ll maybe point to this article by LWN that did an analysis on regressions in the stable trees: <a href="https://lwn.net/Articles/812231/">https://lwn.net/Articles/812231/</a> , which seems to indicate that the current tradeoff seems to be a good one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor841269"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 26, 2020 2:52 UTC (Sat)
                               by <b>ILMostro</b> (guest, #105083)
                              [<a href="/Articles/841269/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Great points overall:<br>
<p>
* Increase the testing before it gets to stable<br>
* Testing increase can be accomplished through a combination of increased time and/or participation.<br>
<p>
I assume that there is a process in place that takes into account how serious or urgent a &quot;fix&quot; is, which can be used to expedite the process at times--rather than assuming everything should be merged with the same level of urgency all the time...<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/841269/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor838911"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 3, 2020 23:05 UTC (Thu)
                               by <b>dcg</b> (subscriber, #9198)
                              [<a href="/Articles/838911/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The stable process assumes that commits that ended up upstream were reviewed and tested;</font><br>
<p>
There goes your problem. The very reason why -stable releases exist, is because that does *not* happen. Buggy code was included in 5.9, and you expect that all commits that went into 5.10 are not? <br>
<p>
I understand that the -stable guys want to automate things and bring fixes to users ASAP, but I don&#x27;t think anyone is surprised that this automated patch picking thing does not work always well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838911/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor838921"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 5:02 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/838921/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; That means that the world would go for 3 months without some known fixes being applied to the tree?</font><br>
<p>
So what?  Every kernel has bugs.  Delaying some bug-fixes isn&#x27;t ipso-facto a bad thing.<br>
<p>
Of course, fixes don&#x27;t *have* to wait 3 months to land.  Or even until the the next stable release.<br>
<p>
If a known authority explicitly asks for a patch to go to stable, it should go immediately.<br>
<p>
If a patch lands in mainline with a &quot;Fixes&quot; or &quot;cc: stable&quot; tag, then it should go to stable soonish.  I&#x27;d leave it a week or two myself, but I don&#x27;t think it needs to wait for a release (though I do remember once when this would have saved me some heartache).<br>
<p>
If a patch is chosen by a non-authority (such as a machine-learning system), then delaying until the major release seems particularly sensible.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838921/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838927"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 8:25 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/838927/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There was another buggy patch[1] in the same batch of autoselected patches that Dave Chinner replied to. The stable kernel process is basically working by chance and based on the assumption that maintainers need to be second guessed.<br>
<p>
[1] <a href="https://lwn.net/ml/linux-kernel/9ec7dff6-d679-ce19-5e77-f7bcb5a63442@oracle.com/">https://lwn.net/ml/linux-kernel/9ec7dff6-d679-ce19-5e77-f...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838927/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor840495"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2020 8:21 UTC (Thu)
                               by <b>daenzer</b> (subscriber, #7050)
                              [<a href="/Articles/840495/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I had very similar thoughts, thanks for articulating them so well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/840495/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor838923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 7:24 UTC (Fri)
                               by <b>bangert</b> (subscriber, #28342)
                              [<a href="/Articles/838923/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Clearly what is missing here is a self-correcting heuristic:<br>
We not only have data on what gets applied to mainline, but also what gets reverted. Based on the number of reverts in a given time period, determine the wait time for each subsystem and allow a configurable subsystem add-on, so XFS can wait for +2 rc releases extra.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838928"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 8:31 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/838928/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There&#x27;s no need for heuristics at all. Maintainers mark patches as stable, just trust them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838928/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 10:05 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/838935/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And if the maintainer did NOT mark them as &quot;for stable&quot;, then the stable kernel guys need to accept responsibility for picking those patches.<br>
<p>
(Yep I know maintainers forget to mark patches, but what if they deliberately DIDN&#x27;T mark them ... ?)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor838987"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 17:00 UTC (Fri)
                               by <b>sashal</b> (<b>&#x272D; supporter &#x272D;</b>, #81842)
                              [<a href="/Articles/838987/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So I&#x27;m curious, I got pinged last month asking me to add a patch that seemed to be able to cause a host hang (<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=77377064c3a94911339f13ce113b3abf265e06da">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/...</a>) which also had a CVE id attached to it.<br>
<p>
Why didn&#x27;t it have a stable tag? Or not sent to us from the KVM maintainers?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838987/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838988"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 17:17 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/838988/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
- Because it cannot happen with SR-IOV devices; passthrough of non-SR-IOV devices is simply not used in circumstances where a host hang can have security consequences, while hobbyists that do use it (e.g. for gaming) tend to stay on bleeding edge kernels.<br>
<p>
- It has an easy workaround in userspace.<br>
<p>
So I considered it as a minor bug even though it has a CVE id attached.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838988/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838989"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 17:55 UTC (Fri)
                               by <b>sashal</b> (<b>&#x272D; supporter &#x272D;</b>, #81842)
                              [<a href="/Articles/838989/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think that your assumptions around who does GPU passthrough are a bit off :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838989/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 18:54 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/838991/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mediated pass-through aka vGPU is very different from PCI pass-through that you do for gaming.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor838994"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 20:39 UTC (Fri)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/838994/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And which one do you do for cryptocurrencies mining and machine learning?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838994/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor839001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 22:06 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/839001/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For Tesla you do mediated pass-through. Consumer hardware only does PCI pass-through (as far as I know that&#x27;s just driver-enforced market segmentation, but still).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/839001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor838961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 17:41 UTC (Fri)
                               by <b>zblaxell</b> (subscriber, #26385)
                              [<a href="/Articles/838961/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe it&#x27;s too obvious, but...isn&#x27;t this what integration trees are for?<br>
<p>
Filesystem code shouldn&#x27;t normally be landing in stable kernels after just a few weeks.  Patches should be soaking on a branch in a dev repo, periodically rebased on -rc kernels, until they&#x27;ve had a few _months_ of testing.  Not just automated unit tests, but users&#x27; regression test workloads that will catch bugs unit tests miss (especially corporate users that are already running full-stack regression tests in their devops sandboxes).<br>
<p>
I say &quot;normally&quot; because there should be exceptions for critical problems that are having verifiable user impact.  By all means, bypass the month-long soak test for the really bad bugs--but those fixes can only be chosen by human maintainers, unless the robots start reading bug reports or running their own regression tests.  Urgent patches can take an expedited path to the kernel, and it appears they already do when human maintainers push untagged fixes to -stable.  They don&#x27;t need to be mixed in with random untested changes.<br>
<p>
All that should be finished by the time Linus pulls the code into a -rc, so the -rc is only testing interactions between changes in the current merge window (e.g. subsystem X and subsystem Y change at the same time and introduce a bug that doesn&#x27;t exist with either change separately)--and ideally even then, subsystems with dependent changes would merge with each others&#x27; integration trees as part of their own testing _before_ either code lands in -rc.<br>
<p>
But...I thought all this was already happening?  What are all those *-next trees out there for, if not to enable and support exactly this process?  Or is it just xfs not doing this?<br>
<p>
A quick look at the git log timestamps indicates that xfs _does_ do this most of the time, so what happened with this one patch?  Why didn&#x27;t it wait for the next merge window?  All the bugs were 2-4 years old, and found by a fuzzer, not a user report, so there was no urgency (or at least none declared in the commit message).  There was urgency in the pull request though (&quot;Fix a fairly serious problem...&quot; in commit d9315f5634c94500b91039895f40051a7ac79e28) and so this patch landed in a -rc4 kernel, covered with labels to make it attractive to humans and robots, the robots picked it up (that&#x27;s what the robots are _for_), and the humans didn&#x27;t stop them because who would expect the xfs maintainer, of all people, to push code that wasn&#x27;t properly tested?<br>
<p>
Oh well.  Even human maintainers make mistakes.  This is an excellent example of _why_ it&#x27;s such a good idea to run code changes through months of testing before sending a pull request to Linus...<br>
<p>
To be fair, users by now should be expecting some bugs in stable kernels, because even the best maintainers still let some through.  Every kernel in the last 5 years has shipped with literally thousands of bugs, and the count is trending upwards--and those are just the known bugs with fixes found in the first 2 months after kernel release, so the true counts are probably higher.  We run our own 3-month soak after kernels are released from -stable before we start rolling them out, because it&#x27;s the only way we can be sure the soak happens and that use cases we care about are tested.  This works out to about 7 months on average from git author date to when we start running the code outside of a test environment.  We don&#x27;t always find bugs that impact us, but when we do, we&#x27;re usually glad that code didn&#x27;t get anywhere near our production fleet.  We also run regression tests on the public -next trees of kernel subsystems that have given us trouble in the past.  The early bug detection we get from all this is worth its weight in VM machine-days.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/838961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor838992"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 4, 2020 19:08 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/838992/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>The bug, it seems, only manifests in settings where a newer user space is interacting with an older kernel</blockquote>

As I understand it, that's when it was <i>spotted</i>: when they were testing the same code in the libxfs component of userspace, and it fell over when exposed to a kernel containing XFS filesystem code that did not have the same change in it. As I understand it, the same fault is evident when using a newer kernel and (at least some) <i>filesystems created by</i> older kernels -- that is to say, some subset of "essentially all of them". But tests that do a mkfs.xfs and then mess about in it using only the new kernel (as test runs usually do), are not going to observe the bug.
<p>
As the guy hit by this, I'm damn glad the verifiers stopped me from being burned more badly than I was (though I do have up-to-date backups so the ultimate consequences would just have been very unpleasant and not disastrous even if my biggest server's rootfs had vanished into the void).
<p>
If you ask me, though autosel is magical and wonderful and has had a huge positive effect, things that can affect persistent state need a lot more verification than autosel can possibly provide: filesystems should just not be exposed to its ministrations. Production filesystem code is usually very heavily tested over time, works very well (so most fixes affect only edge cases), but even small erroneous changes can do massive persistent damage, often triggered by changes in the on-disk state of already-existing filesystems -- and autosel can't test for that sort of thing, and of necessity no human will have tested the combination of fs changes autosel has pulled into the stable tree very much either (though I appreciate that some testing does happen in the stable prerelease phase).
<p>
So... small upside of the vast majority of fs stable fixes (probably very small given that significant fixes should have a stable tag anyway), huge downside if things go wrong, and nigh-impossible to spot when things are wrongly picked: autosel should just not run over fs/*/, at least not for writable persistent filesystems. It can't do much damage to squashfs, iso9660, or procfs, so there's no harm running autosel over that.

      
          <div class="CommentReplyButton">
            <form action="/Articles/838992/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor839106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 7, 2020 15:52 UTC (Mon)
                               by <b>wazoox</b> (subscriber, #69624)
                              [<a href="/Articles/839106/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; autosel should just not run over fs/*/</font><br>
<p>
I get your point, but doesn&#x27;t it apply equally to other sensitive things like drivers that may be lying in the path of your precious data, too? There were some painful, persistent bugs in some storage controller drivers a few years ago in stable kernels, under some configurations.<br>
<p>
All in all, we can very much doubt the sanity of importing &quot;fixes&quot; from -rc kernels into stable releases in an automated way...<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/839106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor839358"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2020 21:23 UTC (Tue)
                               by <b>dgc</b> (subscriber, #6611)
                              [<a href="/Articles/839358/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The difference is in the complexity of the code. drivers tend to pretty straight forward translations of kernel to hardware operations through a fairly narrow API. Functionality is rarely dependent on a huge matrix of user variable configuration or access mechanisms - they get tightly bound to do just what the hardware has to perform. Filesystems, OTOH, are some of the most complex structures and code in the kernel and have a huge API of user facing functions and configuration options they need to support.<br>
<p>
It&#x27;s the complexity of subsystems that drives the risk profile for the subsystem. The test matrix for a filesystem is -huge- once you consider the number of combinations of mount options, mkfs options and per-file options that can cause different code paths to run inside the filesystem. Last time I counted, XFS had about 20 mount options and 40 mkfs options that could be combined in several hundred different ways. Then we have forwards and backwards kernel/userspace version testing. Then we have different IO paths to test (e.g. DAX). Then we have different kernel configs to test. Then we have different architectures (x86-64, arm, ppc64le, etc) to test. Then we have different machine configs to test (high/low RAM, cpu count, slow storage vs fast storage, etc).<br>
<p>
While considering this huge test matrix, also keep in mind the amount of code needed to implement a complex filesystem. e.g. fs/btrfs has more code in it than the entire mm/ subsystem. The same is true for fs/xfs. There there is the userspace code (mkfs, fsck, etc) - xfsprogs is has twice the amount of code than is in fs/xfs in the kernel. xfsdump alone is the same code size as fs/xfs. IOWs, we&#x27;re talking hundreds of thousands of lines of code *per filesystem* to make them do what they do and the kernel component is really only a small piece of the overall code base. There are very few individual kernel subsystems that are of this size and complexity or have a larger userspace code base than the kernel code just to support the kernel code...<br>
<p>
For further consideration: a single fstests unit test run on a single configuration takes 3-4 hours on a fast machine, and that doesn&#x27;t cover the entire syscall or ioctl APIs. Add in an ltp run per configuration, then some performance testing, and you&#x27;re starting to talk about a single set of unit tests on a single configuration taking half a day to run. Now multiply that by *thousands* of unique configurations that _should_ be tested *per filesystem*.<br>
<p>
The complexity of the filesystem validation problem should be obvious by now. Not all subsystems have the same level of complexity, nor do they have the same level of disaster rating if something goes wrong in the subsystem. The amount of validation a filesystem requires is not something we can expect a single developer or maintainer can do by themselves. We don&#x27;t start to really exercise the wider test matrix until the code is merged into for-next and, for -rcX fixes, it gets into the mainline tree. We need that time in -rcX releases to actually get a solid test matrix coverage before the code is released to users.<br>
<p>
Filesystems, score at right at the top of the complexity, disaster risk and test matrix size scales. It is the risk of catastrophic regression and the time it takes to adequately test the new code that means we need to be much more conservative in backporting filesystem changes than probably any other subsystem. You can&#x27;t just reboot to fix corruption or data loss bugs...<br>
<p>
IOWs, a process that assumes that all subsystems have the same risk profile is making a fundamental mistake. This is something that is fairly simple to correct, but the stable maintainers are refusing to even acknowledge that risk is something they need to consider when running automated backports. And that&#x27;s a lose-lose-lose situation for users, developers and maintainers.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/839358/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor839756"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2020 20:51 UTC (Thu)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/839756/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>The difference is in the complexity of the code. drivers tend to pretty straight forward translations of kernel to hardware operations through a fairly narrow API.</blockquote>
<p>I think this is the "everyone else's problems are pretty simple" fallacy.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/839756/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor840494"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2020 8:19 UTC (Thu)
                               by <b>daenzer</b> (subscriber, #7050)
                              [<a href="/Articles/840494/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, similar things keep happening with DRM driver changes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/840494/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor840503"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 17, 2020 9:37 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/840503/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hey, DRM drivers just need to get the stream of commands from the userspace and give it to the GPU.<br>
<p>
What could POSSIBLY be complicated there?<br>
<p>
/sarcasm<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/840503/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor841000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">XFS, stable kernels, and -rc releases</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 21, 2020 22:24 UTC (Mon)
                               by <b>Mook</b> (subscriber, #71173)
                              [<a href="/Articles/841000/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Apologies for the ignorance, but is the purpose of the stable kernel documented anywhere? I see <a href="https://www.kernel.org/doc/html/latest/process/stable-kernel-rules.html">https://www.kernel.org/doc/html/latest/process/stable-ker...</a> which documents what patches go in, but that&#x27;s very different from its raison d&#x27;être. It sounds like different people want different things from it, hence the perpetual conflict.<br>
<p>
Note that I&#x27;m not actually asking for the purpose of the stable kernel; I&#x27;m asking for canonical documentation for it. After all, a random comment on an article (even from somebody obviously in the know) would not be helpful for the next time the mismatch occurs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/841000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
