        <!DOCTYPE html>
        <html lang="en">
        <head><title>Optimizing stable pages [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/528031/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/527554/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/528031/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Optimizing stable pages</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 5, 2012</br>
           </div>
The term "stable pages" refers to the concept that the system should not
modify the data in a page of memory while that page is being written out to
its backing store.  Much of the time, writing new data to in-flight pages
is not actively 
harmful; it just results in the writing of the newer data sooner than might
be expected.  But sometimes, modification of in-flight pages can create
trouble; examples include hardware where data integrity features are in
use, higher-level RAID implementations, or filesystem-implemented
compression schemes.  In those cases, unexpected data modification can
cause checksum failures or, possibly, data corruption.
<p>
To avoid these problems, the <a href="/Articles/442355/">stable pages
feature</a> was merged for the 3.0 development cycle.  This relatively
simple patch set simply ensures that any thread trying to modify an
under-writeback page blocks until the pending write operation is complete.
This patch set, by Darrick Wong, appeared to solve the problem; by blocking
inopportune data modifications, potential problems were avoided and
everybody would be happy.
<p>
Except that not everybody was happy.  In early 2012, some users started <a
href="/Articles/486311/">reporting performance problems</a> associated with
stable pages.  In retrospect, such reports are not entirely surprising;
any change that causes processes to block and wait for asynchronous events
is unlikely to make things go faster.  In any case, the reported problems
were more severe than anybody expected, with multi-second stalls being
observed at times.  As a result, some users (<a
href="/Articles/528032/">Google, for example</a>) have added patches to
their kernels to disable the feature.  The performance costs are too high,
and, in the absence of a use case like those described above, there is no
real advantage to using stable pages in the first place.
<p>
So now Darrick is back with <a href="/Articles/526094/">a new patch set</a>
aimed at improving this situation.  The core idea is simple enough: a new
flag (<tt>BDI_CAP_STABLE_WRITES</tt>) is added to the
<tt>backing_dev_info</tt> structure used to describe a storage device.  If
that flag is set, the memory management code will enforce stable pages as
is done in current kernels.  Without the flag, though, attempts to write a
page will not be forced to wait for any current writeback activity.  So the
flag gives the ability to choose between a slow (but maybe safer) mode or a
higher-performance mode.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
Much of the discussion around this patch set has focused on just how that
flag gets set.  One possibility is that the driver for the low-level
storage device will turn on stable pages; that can happen, for example,
when hardware data integrity features are in use.  Filesystem code could
also enable stable pages if, for example, it is compressing data
transparently as that data is written to disk.  Thus far, things work fine:
if either the storage device or the filesystem implementation requests
stable pages, they will be enforced; otherwise 
things will run in the faster mode.
<p>
The real question is whether the system administrator should be able to
change this setting.  Initial versions of the patch gave complete control over
stable pages to the user by way of a sysfs attribute, but a number of
developers complained about that option.  Neil Brown <a
href="/Articles/528035/">pointed out</a> that, if the flag could change at
any time, he could never rely on it within the MD RAID code; stable pages
that could disappear without warning at any time might as well not exist at
all.  So there was
little disagreement that users should never be able to turn off the
stable-pages flag.  That left the question of whether they should be able
to <i>enable</i> the feature, even if neither the hardware nor the
filesystem needs it, presumably because it would make them feel safer
somehow.   Darrick had left that capability in, <a
href="/Articles/528036/">saying</a>:
<p>
<div class="BigQuote">
	I dislike the idea that if a program is dirtying pages that are
	being written out, then I don't really know whether the disk will
	write the before or after version.  If the power goes out before
	the inevitable second write, how do you know which version you get?
	Sure would be nice if I could force on stable writes if I'm feeling
	paranoid.
</div>
<p>
Once again, the prevailing opinion seemed to be that there is no actual
value provided to the user in that case, so there is no point in making the
flag user-settable in either direction.  As a result, subsequent updates
from Darrick took that feature out.
<p>
Finally, there was some disagreement over how to handle the ext3
filesystem, which is capable of modifying journal pages during writeback
even when stable pages are enabled.  Darrick's patch changed the
filesystem's behavior in a significant way: if the underlying device
indicates that stable pages are needed and the filesystem is to be mounted
in the <tt>data=ordered</tt> mode, the filesystem will complain and mount
it read-only.  The idea was that, now that the kernel could determine that
a specific configuration was unsafe, it should refuse to operate in that
mode.
<p>
At this point, Neil <a href="/Articles/528037/">returned</a> to point out
that, with this behavior, he would not be able to set the "stable pages
required" flag in the MD RAID code.  Any system running an ext3 filesystem
over an MD volume would break, and he doesn't want to deal with the
subsequent bug reports.  Neil has requested a variant on the flag whereby
the storage level could request stable pages on an optional basis.  If
stable pages are available, the RAID code can depend on that behavior to
avoid copying the data internally.  But that code can still work without
stable pages (by copying the data, thus stabilizing it) as long as it knows
that stable pages are unavailable.
<p>
Thus far, no patches adding that feature have appeared;
Darrick did, however, post <a href="/Articles/528038/">a patch set</a>
aimed at simply fixing the ext3 problem.  It works by changing the stable
page mechanism to not depend on the <tt>PG_writeback</tt> page flag;
instead, it uses a new flag called <tt>PG_stable</tt>.  That allows the
journaling layer to mark its pages as being stable without making them look
like writeback pages, solving the problem.  Comments from developers have
pointed out some issues with the patches, not the least of which is that
page flags are in extremely short supply.  Using a flag to work around a
problem with a single, old filesystem may not survive the review process.
<p>
The end result is that, while the form of the solution to the stable page
performance issue is reasonably clear, there are still a few details to be
dealt  with.  There appears to be enough interest in fixing this problem
to get something worked out.  Needless to say, that will not happen for the
3.8 development cycle, but having something in place for 3.9 looks like a
reasonable goal.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Data_integrity">Data integrity</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Stable_pages">Stable pages</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/528031/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor528171"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 8:03 UTC (Thu)
                               by <b>djwong</b> (subscriber, #23506)
                              [<a href="/Articles/528171/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
At the moment, I'm trying to figure out if there's a sane way to fix jbd either by backporting what jbd2 does to flush out dirty data prior to committing a transaction, or by finding a way to have jbd set PG_writeback before calling submit_bh() on the file data.<br>
<p>
Or by removing fs/ext3/.  I suspect that would not be popular, however. ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528171/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528203"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 14:22 UTC (Thu)
                               by <b>Jonno</b> (subscriber, #49613)
                              [<a href="/Articles/528203/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Or by removing fs/ext3/.</font><br>
<p>
Honestly, removing fs/ext2, fs/ext3 and fs/jbd is probably the only sane thing to do in the long run, as fs/ext4 and fs/jbd2 supports everything they do, and is more well tested (at least on recent kernels, conservatives still using ext3 tend not to run -rc kernels).<br>
<p>
When the "long run" comes is of course up for debate, but I would say "immediately after Greg's next -longterm announcement", giving conservative users a minimum of two years to prepare, while letting the rest of us go on without the baggage.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528203/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528264"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 19:56 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528264/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are still times when the best filesystem to use is ext2<br>
<p>
one prime example would be the temporary storage on Amazon Cloud machines. If the system crashes, all the data disappears, so there's no value in having a journaling filesystem, and in many cases ext3 and ext4 can have significant overhead compared to ext2<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528264/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528278"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 20:58 UTC (Thu)
                               by <b>bjencks</b> (subscriber, #80303)
                              [<a href="/Articles/528278/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you're truly not worried about data integrity, why not just add all that disk space as swap and use tmpfs? (I haven't tried this; it could be that it actually works terribly, but it seems like it *should* be the optimal solution)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528278/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528282"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 21:18 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528282/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If you're truly not worried about data integrity, why not just add all that disk space as swap and use tmpfs?</font><br>
<p>
swap has horrible data locality, depending on how things get swapped out a single file could end up scattered all over the disk.<br>
<p>
In addition, you approach puts the file storage directly competing with all processes in terms of memory, you may end up swapping out program data because your file storage 'seems' more important.<br>
<p>
disk caching has a similar pressure, but the kernel knows that cache data is cache, and that it can therefor be thrown away if needed. tmpfs data isn't in that category.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528282/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor528321"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 22:38 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/528321/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ext4 can be used without journaling (you need to use tune2fs to set it up). Google added this feature for these use-cases specifically.<br>
<p>
We've benchmarked it on Amazon EC2 machines. ext4 without journaling is faster than ext2. There are really no more use cases for ext2/3.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528321/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor528329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2012 23:06 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/528329/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ISTM that the other improvements like extents, hashed directory lookups, delayed allocation and whatever already might offset the journal overhead by a good bit.<br>
<p>
Also - I haven't tried this though - shouldn't you be able to create an ext4 without a journal while keeping the other ext4 benefits? According to man tune2fs you can even remove the journal with -O^has_journal from an existing FS. The same is probably true for mkfs.ext4.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor528378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 7, 2012 10:22 UTC (Fri)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/528378/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But AFAIK, you can use an ext2 or ext3 filesystem with the ext4 filesystem driver, and it will work fine.<br>
<p>
IIRC, the default Fedora kernel was configured to always use the ext4 code, even when mounting ext2/ext3 filesystems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor528569"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2012 22:39 UTC (Sat)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/528569/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <blockquote type="cite">
one prime example would be the temporary storage on Amazon Cloud machines. If the system crashes, all the data disappears
</blockquote>
That is a common misconception, but it is not true. As this <a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/InstanceStorage.html">Amazon doc</a> explains, data in the local instance storage is not lost on a reboot. Quoting that page:
<blockquote>
However, data on instance store volumes is lost under the following circumstances:
<ul>
<li>    Failure of an underlying drive

<li> Stopping an Amazon EBS-backed instance

<li>    Terminating an instance
</ul>
</blockquote>
So it is not guaranteed but it is not ephemeral either: many instance types actually have their root on an instance store. Amazon teaches you to treat it as ephemeral so that users do not rely on it too much. But using ext2 on it is not a good idea unless it is truly ephemeral.
      
          <div class="CommentReplyButton">
            <form action="/Articles/528569/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528577"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2012 23:28 UTC (Sat)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528577/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
according to the Instructor in the class I've been in for the last three days, when an ex2 instance dies, nothing that you ever do will give you access to the data that you stored on the ephemeral drive. This is not EBS storage, this is the instance storage.<br>
<p>
Ignoring what they say and just looking at it from a practical point of view:<br>
<p>
<p>
The odds of any new EC2 instance you fire up starting on the same hardware, and therefor having access to the data are virtually nonexistant.<br>
<p>
If you can't get access to the drive again, journaling is not going to be any good at all.<br>
<p>
Add to this the fact that they probably have the hypervisor either do some form of transparent encryption, or make it so that they return all zeros if you read a block you haven't written to yet (to prevent you from seeing someone else's data) and you now have no reason to even try to use a journal on these drives.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528577/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528579"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 8, 2012 23:56 UTC (Sat)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/528579/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      I am not sure what "dies" means in this context. If the instance is stopped or terminated, then the instance storage is lost. If the instance is rebooted then the same instance storage is kept. Usually you reboot machines which "die" (i.e. crash or oops), so you don't lose instance storage.
<p>
In short: any new EC2 instance will of course get a new instance storage, but the same instance will get the same instance storage.
<p>
I understand your last paragraph even less. Why do transparent encryption? Just use regular filesystem options (i.e. don't use <a href="http://lwn.net/Articles/528107/">FALLOC_FL_NO_HIDE_STALE</a>) and you are good. I don't get what a journal has to do with it.
<p>
Again, keep in mind that many instance types keep their root filesystem on local instance storage. Would you run / without a journal? I would not.
      
          <div class="CommentReplyButton">
            <form action="/Articles/528579/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528581"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2012 1:11 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528581/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you don't do any sort of encryption, then when a new instance mounts the drives, it would be able to see whatever was written to the drive by the last instance used it.<br>
<p>
I would absolutely run / without a journal if / is on media that I won't be able to access after a shutdown (a ramdisk for example)<br>
<p>
I don't remember seeing anything in the AWS management console that would let you reboot an instance, are you talking about rebooting it from inside the instance? If you can do that you don't need a journal because you can still do a clean shutdown. I don't consider the system to have crashed. I count a crash as being when the system stops without being able to do any cleanup (kernel hang or power off on traditional hardware)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528581/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528583"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2012 1:18 UTC (Sun)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/528583/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      New instances should not see the contents of uninitialized (by them) disk sectors. That is the point of the recent discussion about <a href="http://lwn.net/Articles/528107/">FALLOC_FL_NO_HIDE_STALE</a>. The kernel will not allow one virtual machine to see the contents of another's disk, or at least that is what I understand.
<p>
The AWS console has an option to reboot a machine, between "Terminate" and "Stop". You can also do it programmatically using EC2 commands, e.g. if the machine stops responding.
      
          <div class="CommentReplyButton">
            <form action="/Articles/528583/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528587"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2012 1:50 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528587/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the correction about the ability to reboot an instance.<br>
<p>
I don't think this is what FALLOC_FL_NO_HIDE_STALE is about. FALLOC_FL_NO_HIDE_STALE is about not zeroing something that this filesystem has not allocated before, but if you have a disk that has a valid ext4 filesystem on it and plug that disk into another computer, you can just read the filesystem.<br>
<p>
When you delete a file, the data remains on the disk and root can go access the raw device and read the data that used to be in a file.<br>
<p>
by default, when a filesystem allocates a block to a new file, it zeros out the data on that block, it's this step that FALLOC_FL_NO_HIDE_STALE lets you skip.<br>
<p>
the If you really had raw access to the local instance storage without the hypervisor doing something, then you could just mount whatever filesystem the person before you left there. To avoid this Amazon would need to wipe the disks, and since it takes a long time to write a TB or so of data (even on SSDs), I'm guessing that they do something much easier, like doing some sort of encryption to make it so that one instance can't see data written by a prior instance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528587/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528598"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2012 12:04 UTC (Sun)
                               by <b>man_ls</b> (guest, #15091)
                              [<a href="/Articles/528598/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      When Amazon EC2 creates a new instance, it allocates a new instance storage with its own filesystem. This process includes formatting the filesystem, and sometimes copying files from the AMI (image file) to the new filesystem. So any previous filesystems are erased. It is here that zeroing unallocated blocks from the previous filesystem comes into place, which is what FALLOC_FL_NO_HIDE_STALE would mess up.
<p>
I don't know how Amazon (or the hypervisor) prevents access to the raw disk, where unallocated sectors might be found and scavenged even if the filesystem is erased. I guess they do something clever or we would have heard about people reading Zynga's customer database from a stale instance.
      
          <div class="CommentReplyButton">
            <form action="/Articles/528598/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2012 16:01 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/528605/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Uhm. Nope.<br>
<p>
Amazon doesn't care about your filesystem. AMIs are just dumps of block devices - Amazon simply unpacks them onto a suitable disk. You're free to use any filesystem you want (there might be problems with the bootloader, but they are not insurmountable).<br>
<p>
You certainly can access the underlying disk device.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor528652"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 1:07 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528652/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Amazon doesn't put a filesystem on the device, you do.<br>
<p>
<font class="QuotedText">&gt; I don't know how Amazon (or the hypervisor) prevents access to the raw disk, where unallocated sectors might be found and scavenged even if the filesystem is erased. I guess they do something clever or we would have heard about people reading Zynga's customer database from a stale instance. </font><br>
<p>
This is exactly what I'm talking about.<br>
<p>
There are basically three approaches to doing this without the cooperation of the OS running on the instance (which you don't have)<br>
<p>
1. the hypervisor zeros out the entire drive before the hardware is considered available again.<br>
<p>
2. the hypervisor does encryption of the blocks with a random key for each instance, loose the key and reading the blocks just returns garbage<br>
<p>
3. the hypervisor tracks what blocks have been written to and only returns valid data for those blocks.<br>
<p>
I would guess #1 or #2, and after thinking about it for a while would not bet either way<br>
<p>
#1 is simple, but it takes a while (unless the drive has direct support for trim and effectively implements #3 in the drive, SSDs may do this)<br>
<p>
#2 is more expensive, but it allows the system to be re-used faster<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528652/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528656"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 2:55 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/528656/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
They are using #3. The raw device reads on initialized areas return zeroes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528656/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528657"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 3:27 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528657/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that eliminates #2, but it could be #1 or #3<br>
<p>
It seems like trying to keep a map of if this block has been written to would be rather expensive to do at the hypervisor level, particularly if you are talking about large drives.<br>
<p>
Good to know that you should get zeros for uninitialized sectors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528657/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528658"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 3:30 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/528658/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
#1 is unlikely because local storage is quite large (4Tb on some nodes). It's not hard to keep track of dirtied blocks, they need it to support snapshots on EBS volumes anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528658/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528663"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 6:18 UTC (Mon)
                               by <b>bjencks</b> (subscriber, #80303)
                              [<a href="/Articles/528663/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just to be clear, there are two different ways of initializing storage: root filesystems are created from a full disk image that specifies every block, so there are no uninitialized blocks to worry about, while non-root instance storage and fresh EBS volumes are created in a blank state, returning zeros for every block.<br>
<p>
It's well documented that fresh EBS volumes keep track of touched blocks; to get full performance on random writes you need to touch every block first. That implies to me that they don't even allocate the block on the back end until it's written to.<br>
<p>
Not sure how instance storage initialization works, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528663/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">EC2 (local) instance storage</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 6:34 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528664/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
EBS storage is not simple disks, the size flexibility and performance you can get cannot be supported by providing raw access to drives or drive arrays.<br>
<p>
As you say, instance local storage is different.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor528585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 9, 2012 1:40 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/528585/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We use instance storage on the new SSD-based nodes for very fast PostgreSQL replicated nodes. It indeed survives reboots and oopses.<br>
<p>
It does not survive stopping the instance through the Amazon EC2 API.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor528704"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 16:51 UTC (Mon)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/528704/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given the incredibly severe performance issues the use of the stable pages feature may incur, it seems like the optimal long term solution would be to add copy on write capability for pages that are under writeout. <br>
<p>
Meaning that when a thread attempts to modify such a page, a duplicate physical page is created, the page structure and PTE are updated accordingly, and ownership of the physical page under writeout is transferred to the fs or device doing the writeout, for reclamation when the writeout completes.  That would be far superior in most cases than stalling a thread for an arbitrary period in the meantime, something that is the death of anything resembling real time response.  <br>
<p>
It would also be markedly superior to a copy-always policy by the FS or storage layer concerned.  The best of both worlds, essentially.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528704/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528722"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 17:27 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/528722/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
CoW using VM tricks is quite often _inferior_ in speed to simple copying.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528722/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor528729"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Optimizing stable pages</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2012 18:11 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/528729/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  CoW using VM tricks is quite often _inferior_ in speed to simple copying.</font><br>
<p>
COW is slower if the copy actually needs to take place, but faster if the copy is never needed.<br>
<p>
The question is how likely are you to need to do the copy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/528729/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2012, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
