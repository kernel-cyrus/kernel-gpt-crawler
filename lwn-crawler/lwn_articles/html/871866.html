        <!DOCTYPE html>
        <html lang="en">
        <head><title>A rough start for ksmbd [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/871866/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/872158/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/871866/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A rough start for ksmbd</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>October 7, 2021</br>
           </div>
Among the many new features pulled into the mainline during the 5.15 merge
window is the <a href="https://github.com/namjaejeon/ksmbd">ksmbd</a>
network filesystem server.  Ksmbd implements the <a
href="https://en.wikipedia.org/wiki/Server_Message_Block">SMB protocol</a>
(also known as CIFS, though that name has gone out of favor) that is
heavily used in the Windows world.  The creation of an in-kernel SMB server
is a bit surprising, given that Linux has benefited greatly from the
user-space <a href="https://www.samba.org/">Samba</a> solution since
shortly after the
beginning.  There are reasons for this move but, in the short term at
least, they risk being overshadowed by a worrisome stream of
security-related problems in ksmbd.

<p>
Why create an in-kernel SMB server at this point?  In a sense, ksmbd is not
meant to compete with Samba; indeed, it has been developed in cooperation
with the Samba project.  It is, however, meant to be a more performant and
focused solution than Samba is; at this point, Samba includes a great deal
of functionality beyond simple file serving.  Ksmbd claims significant
performance improvements on a wide range of benchmarks; the <a
href="https://github.com/namjaejeon/ksmbd#performance">graphs on this
page</a> show a doubling of performance on some tests.  An in-kernel server
is an easier place to support variants like <a
href="https://docs.microsoft.com/en-us/windows-server/storage/file-server/smb-direct">SMB
Direct</a>, which uses RDMA to transfer data between systems.  By drawing
more eyes to the code, merging into the mainline may also
facilitate faster development in general.  One other
reason — which tends to be spoken rather more quietly — is that a new
implementation can be licensed under GPLv2, while Samba is GPLv3.
<p>
Ksmbd was first <a
href="/ml/linux-kernel/20210322051344.1706-1-namjae.jeon@samsung.com/">posted
for review</a> (as "cifsd") by Namjae Jeon in late March; <a
href="/ml/linux-kernel/20210823025816.7496-1-namjae.jeon@samsung.com/">the
eighth revision</a> came out just before the opening of the 5.15 merge
window in late August.  The last version received no review comments, but
previous versions had clearly been looked at by a number of developers.
Nobody objected when Steve French <a
href="/ml/linux-kernel/CAH2r5msoKV7qAgoKipa%2BQNDJ%2BxR83YGuz%2Bhe%2BGH9sPTSzBMLHA%40mail.gmail.com/">asked
Linus Torvalds</a> to pull ksmbd into the mainline on August&nbsp;29.
<p>
It is not unusual for a new subsystem to receive a lot of fixes after its
entry into the mainline kernel.  Merging tends to draw a lot more attention
to the code, and the number of testers normally goes up, leading to the
discovery of more problems.  That is what the stabilization period after the
merge window is for, after all.  That said, the nature of the fixes being
applied can give some insight into the quality of the underlying code, and
the indications for ksmbd are not entirely good.
<p>
The <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/fs/ksmbd">commit
history for ksmbd</a> shows a steady stream of fixes, as expected.
Worryingly, though, many of the problems being fixed are clearly security
issues — not a good thing in a network filesystem implementation.  Examples
include:
<p>
<ul class="spacylist">
<li> The code to change ownership and permissions <a
     href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=e70e392fa768d46ca59f2f8c0e7374099c980622">did
     not check existing file permissions</a> first.
<li> <a
     href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=303fff2b8c77a85c62dbde3b27c24b084144c04c">Failure
     to validate data lengths</a> could lead to access to invalid data.
<li> The server would <a
     href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=4ea477988c423a57241ea4840b12832de6fabdfd">blindly
     follow symbolic links</a> during pathname lookup.
<li> Numerous failures to validate buffer lengths, such as <a
     href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=d72a9c158893d537d769a669a5837bc80b0f851c">this
     one</a> or <a
     href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/fs/ksmbd?id=9496e268e3af78a92778bf635488a8ec2dca8996">this
     one</a>.
</ul>
<p>
All of those fixes were applied after ksmbd landed in the mainline; there
are others that came before.  Currently, twelve fixes to ksmbd credit
Coverity scans in their changelogs.
<p>
Again, it would not be surprising for a security issue or three to turn up
in a new network-filesystem implementation.  But ksmbd has shown enough
problems to 
have raised a few eyebrows in the kernel community, though the discussion
of those problems was evidently held in private for some time.  When French
<a
href="/ml/linux-kernel/CAH2r5mvu5wTcgoR-EeXLcoZOvhEiMR0Lfmwt6gd1J1wvtTLDHA@mail.gmail.com/">pushed
another set of ksmbd fixes</a> in mid-September, though, Kees Cook <a
href="/ml/linux-kernel/202109221850.003A16EC1@keescook/">took the
discussion public</a>:
<p>
<blockquote class="bq">
	I was looking through the history[<a
	href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/log/fs/ksmbd">1</a>]
	of the ksmbd work, and I'm kind of surprised at some of the flaws
	being found here. This looks like new code being written, too, I
	think (I found[<a
	href="https://lore.kernel.org/lkml/20210322051344.1706-1-namjae.jeon@samsung.com/">0</a>])?
	Some of these flaws are pretty foundational filesystem security
	properties[<a
	href="https://git.kernel.org/linus/f58eae6c5fa882d6d0a6b7587a099602a59d57b5">2</a>]
	that weren't being tested for, besides the upsetting case of having
	buffer overflows[<a
	href="https://git.kernel.org/linus/6d56262c3d224699b29b9bb6b4ace8bab7d692c2">3</a>]
	in an in-kernel filesystem server.
<p>
	I'm concerned about code quality here, and I think something needs
	to change about the review and testing processes.
</blockquote>
<p>
French <a
href="/ml/linux-kernel/CAH2r5muNG4GvziyMG2unkYNjUiT4V+pz0pWUGkWQNxUZJnBadw@mail.gmail.com/">replied</a>
that he was surprised by some of the problems too.  He pointed to <a
href="https://wiki.samba.org/index.php/Ksmbd-review">a wiki page</a>
describing the ongoing security review for this code, which seems to have
acquired a new urgency.  A number of new procedures are being instituted,
he said, and there will be testing done at various interoperability
events.  French said he was "<q>pleased with the progress</span> that is
being made, but also conceded that ksmbd "<q>is not ready for production
use yet</q>".
<p>
There are also some things to look forward to on the security front, he
continued:
<p>
<blockquote class="bq">
	There is some good news (relating to security), once Namjae et al
	get past these buffer overflow etc. patches.
	<p>
	<ul>
	<li> he has already implemented the strongest encryption supported
	in SMB3.1.1 
	<li> he has implemented the man in the middle attack prevention features
	of the protocol
	<li> strong (Kerberos) authentication is implemented
	<li> he has removed support for weak older dialects (including SMB1 and
	SMB2) of the protocol
	<li>he will be removing support for weaker authentication
	(including NTLMv1)
	</ul>
</blockquote>
<p>
The NTLMv1 removal has <a
href="https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/commit/fs/ksmbd?id=ce812992f239f45e13c820a52455fec6eacbce1e">since
been merged</a> into the mainline.  On reading French's message, Cook <a
href="/ml/linux-kernel/202109231109.0AD3D5A@keescook/">responded</a>:
"<q>Thanks for making these recent changes; I feel much better about
ksmbd's direction</q>".
<p>
The work on cleaning up ksmbd proceeds; French <a
href="/ml/linux-kernel/CAH2r5muy3GtTQPoaVXiD_tU-cG4FAQk4SCmmiR8vS4_pWvPanw@mail.gmail.com/">pushed
another 11 fixes</a> on October&nbsp;1.
<p>
At this point, there is little doubt that ksmbd will be properly reviewed
and cleaned up; there are eyes on the code, and ksmbd itself is small
enough that a comprehensive review should be feasible.  At that point, the
kernel should have an SMB 
implementation that is feature-rich, performant, and secure.
That said, waiting
another kernel development cycle or two for the developers to "<q>get
past these buffer overflow etc. patches</q>" before deploying it might 
well be prudent.
<p>
This is all good, but it is still a little worrisome that this code got as
far as it did in the condition it was in.  It seems clear that security
concerns were not at the forefront when this code was being developed and
that the review it received before being merged failed in this regard as
well.  The 
addition of security features is great, but they do not help much in the
absence of a secure implementation.  If we ever want to reach a point where
we are not adding more security problems to the kernel than we are fixing,
we will need to do better than this.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-ksmbd">Filesystems/ksmbd</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-5.15">Releases/5.15</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/871866/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor872165"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 15:02 UTC (Thu)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/872165/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;meant to be a more performant [...] solution than Samba&quot;.<br>
<p>
Anyone who remembers khttpd? When it was merged, it was more performant than any existing userspace web server.<br>
It was removed from the kernel when userspace web servers had improved, surpassing khttpd&#x27;s performance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872165/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872172"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 15:24 UTC (Thu)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/872172/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On the other hand, we&#x27;ve still got knfsd.<br>
<p>
There&#x27;s also an actively developed userspace NFS server, Ganesha.  My impression is that it&#x27;s mainly focused on exporting userspace filesystem implementations.  It&#x27;s also capable of exporting filesystems implemented in the kernel--that&#x27;s what we have name_to_handle_at() and open_by_handle_at() syscalls for--but I think that&#x27;s still a little more difficult for it.  Most people exporting xfs or ext4 or btrfs are probably using knfsd.<br>
<p>
I believe Solaris has in-kernel NFS and SMB servers too.<br>
<p>
It&#x27;s not a simple decision, there are tradeoffs.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872172/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 5:15 UTC (Fri)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/872240/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Solaris choose in-kernel implementation mostly for authentication stuff – managing Windows SIDs natively in-kernel, ACLs and similar stuff. I/O performance was a side benefit. There are slides about Solaris:<br>
<p>
<a href="https://www.snia.org/sites/default/orig/sdc_archives/2008_presentations/tuesday/AlanWright_OpenSolaris_CIFS.pdf">https://www.snia.org/sites/default/orig/sdc_archives/2008...</a><br>
<p>
It&#x27;s interesting how it compares to ksmd rationale in Linux, over a decade later.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 14:36 UTC (Fri)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/872258/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the link, I hadn&#x27;t read those slides and they&#x27;re interesting.<br>
<p>
On p. 3, under &quot;Kernel based implementation&quot;, it says &quot;Better I/O performance.&quot;<br>
<p>
The other goals listed on that and the following slide--I don&#x27;t know, some look like they could be easier if the file server was in-kernel, with some (ACLs?) I don&#x27;t see off hand why that would help.<br>
<p>
Historically I think it&#x27;s true that in the case of knfsd the motivation has been the difficulty of providing correct semantics without deeper integration with the filesystems.  But I haven&#x27;t seen a good performance comparison recently.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 10, 2021 10:51 UTC (Sun)
                               by <b>iainn</b> (guest, #64312)
                              [<a href="/Articles/872409/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
TrueNAS (formerly: FreeNAS) uses Ganesha.<br>
<p>
TrueNAS is FreeBSD based, so using an in-kernel Linux implementation wouldn&#x27;t work so well.<br>
<p>
However, TrueNAS now also has a Linux port. (Of course, it&#x27;ll be easier to share the NFS config code between Linux and FreeBSD, by sticking with Ganesha.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872185"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 16:42 UTC (Thu)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/872185/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There&#x27;s also other options like only offloading parts of the protocol to reduce attack surface, as e.g. Kernel TLS does. I don&#x27;t know how feasible that is with something like smb though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872185/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872182"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 16:25 UTC (Thu)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/872182/">Link</a>] (30 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s unfortunate, but code is fixable. I&#x27;m optimistic about using this some day if it turns out to be more user-friendly than nfsd.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872182/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872199"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 19:31 UTC (Thu)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/872199/">Link</a>] (29 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
nfsd would be a lot more friendly if it let you map arbitrary users at arbitrary hosts to arbitrary local users....without having to set up a whole kerberos scheme to &quot;authenticate&quot; them.<br>
<p>
Maybe I just want to deploy nfs on my network after already having set up a bunch of computers, and maybe they all just happen to use slightly different usernames and IDs for the same users. Right now the only thing I can do is squash all the users from any particular host down to one user, but I&#x27;d really like to be able to map them. It works so long as I&#x27;m the only one using it, but I can see a multiuser future on the horizon (eg guests/family).<br>
<p>
/nfs_gripe<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872199/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872208"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 20:27 UTC (Thu)
                               by <b>ejr</b> (subscriber, #51652)
                              [<a href="/Articles/872208/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So if any one is compromised, it opens *every* user&#x27;s files by changing that local mapping.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872208/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872287"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 14:48 UTC (Fri)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/872287/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m not sure I understand your threat model here.<br>
<p>
In the absence of kerberos, the server&#x27;s mostly just trusting the clients to correctly represent who&#x27;s accessing the filesystem anyway.<br>
<p>
I seem to recall one or two people making an attempt at adding this kind of mapping, and it turning out to be more complicated than expected.  But that was a while ago.  I wonder if any of the container work done since then would be useful here.<br>
<p>
Anyway, there&#x27;d have to be someone willing to look into it and do the work.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872287/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872249"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 7:32 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/872249/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; nfsd would be a lot more friendly if it let you map arbitrary users at arbitrary hosts to arbitrary local users....without having to set up a whole kerberos scheme to &quot;authenticate&quot; them.</font><br>
<p>
How hard is it to set up LDAP? Can&#x27;t you implement some simple &quot;single sign on&quot;?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872249/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor872252"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 9:09 UTC (Fri)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/872252/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I only use NFS for root file systems on development boards.<br>
Less tech-savvy people (&quot;family&quot;) just use &quot;Connect to Server&quot; with &quot;sftp://nas/...&quot; in the GUI file manager.  No further setup needed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872252/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor872356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 9, 2021 11:50 UTC (Sat)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/872356/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Was it not done by rpc.ugidd ? what happened to that ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872485"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 11, 2021 13:19 UTC (Mon)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/872485/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, that&#x27;s interesting.  I&#x27;ve been working on nfs for almost 20 years and I don&#x27;t remember hearing about rpc.ugidd.<br>
<p>
Looking at old documentation: the old userspace nfsd daemon (which preceded both Ganesha and knfsd) supported a &quot;map_daemon&quot; export option.  When that was set, it would query the client&#x27;s rpc.ugidd for id mappings using an rpc protocol.  So you ran rpc.ugidd on the client.<br>
<p>
No distribution carries rpc.ugidd any more, and the map_daemon export option was never supported by knfsd.<br>
<p>
Might be interesting to know more of the history.  Digging through old nfs-utils tarballs (it predates git) might be one way to figure it out.<br>
<p>
If we were to support uid/gid mapping today, we&#x27;d do it some other way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872485/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872368"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 9, 2021 16:24 UTC (Sat)
                               by <b>Baughn</b> (subscriber, #124425)
                              [<a href="/Articles/872368/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn&#x27;t *really* answer your understandable gripe, but assuming you&#x27;re willing to run NixOS everywhere there&#x27;s at least one fix — use a central user database with assigned UIDs, like I do here: <a href="https://github.com/Baughn/machine-config/blob/master/modules/users.nix">https://github.com/Baughn/machine-config/blob/master/modu...</a><br>
<p>
It works.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872368/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor873894"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 25, 2021 10:12 UTC (Mon)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/873894/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Using the same [UG]IDs in your whole network is a far better idea, allowing arbitary user remapping is asking for a huge steaming mess<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/873894/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor873974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 25, 2021 17:37 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/873974/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Using the same [UG]IDs in your whole network is a far better idea…</font><br>
<p>
That advice just makes NFS utterly impractical in any situation where you don&#x27;t have absolute control over UID &amp; GID assignments for every system you want to export files to. (You want to export NFS shares to Android without remapping IDs? Good luck with that…)<br>
<p>
Every so often I start thinking that it would be nice to have a network filesystem without the overhead of FUSE, but the cost of setting up Kerberos (or doing without ID mapping) and the headaches of making that work reliably and securely when the systems may not always be on the same local network always send me back to SSHFS.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/873974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874054"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 26, 2021 17:45 UTC (Tue)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/874054/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No expert, but my understanding was that Android manages uid&#x27;s in a pretty non-traditional way, dynamically allocating uid&#x27;s one per app.  So there&#x27;s probably not any sensible way to map those individually.<br>
<p>
I&#x27;d think instead you want to map everyone to one user, and export with something like (all_squash,anonuid=MYID,anongid=MYGID).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874054/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874083"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2021 2:58 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874083/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I&#x27;d think instead you want to map everyone to one user, and export with something like (all_squash,anonuid=MYID,anongid=MYGID).</font><br>
<p>
Actually what I would want is not squashing all requests down to one UID/GID per export, but rather performing all accesses as the particular user whose credentials were used to authenticate to the server (like SSHFS does, or NFS with LDAP and Kerberos, or mount.cifs) without making any assumptions about the UID/GID (or username / group name(s)) on the client. There should also be options to control how the UIDs, GIDs, and permissions of files from the server are presented locally (again, like SSHFS with -o uid=X,gid=Y,umask=NNN).<br>
<p>
Or perhaps what I really want is just SSHFS with less overhead. (ksshfs?) Until something like that is available, the FUSE implementation works well enough that I don&#x27;t really see a need for NFS.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874083/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874086"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2021 7:06 UTC (Wed)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/874086/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All of what you want is what Samba (the project) can offer, and much more (e.g. forcing authenticated access to use a certain group or to use certain bits in the file permissions, making setting up a shared directory where all group members have full access to all files trivial).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874086/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2021 11:18 UTC (Wed)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/874096/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When I set up my shared filesystem, I first used CIFS, however the lack of support for arbitrary filenames and munging permissions was not suitable. Is there a way to say &quot;I don&#x27;t care about Windows, please do not mangle filenames it does not accept&quot; and &quot;please store and expose proper Unix permissions&quot;?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874098"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2021 11:28 UTC (Wed)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/874098/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I honestly don&#x27;t know the answer to the that, as I&#x27;m usually working in mixed environments, forcing me to forgo characters in file names not supported on Windows anyway. And I don&#x27;t usually use traditional Unix permission setups for stuff on CIFS shares.<br>
<p>
You can look into the &quot;unix extensions&quot; parameter on Samba.<br>
<p>
My comment was really just an answer to nybble41&#x27;s requirements, not a general endorsement to use CIFS as the one and only network file system. That being said, I&#x27;m still envious of the various fine-grained controls Samba offers whenever I run into the various limitations of what NFS can do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874098/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor874155"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2021 16:43 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874155/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can you use SMB/CIFS over the Internet these days (without a VPN), or is that still considered insecure? I used to run a Samba server for interoperability with Windows clients, just over the LAN, but the authentication requirements kept changing (on the Windows side) and I eventually decided it wasn&#x27;t worth the security risk. I always heard that one shouldn&#x27;t allow SMB connections outside the local network, but perhaps that&#x27;s changed.<br>
<p>
If the security were comparable to SSH (including authentication via public keys rather than passwords) then I would agree, CIFS has most of the other properties I&#x27;m looking for. You can even set up a multi-user mount point and have the kernel track per-user login credentials using the cifscreds utility.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874155/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874158"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 27, 2021 17:24 UTC (Wed)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/874158/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not sure, hopefully someone else can chime in. A quick Google search seems to suggest mostly everyone still recommending against it. I&#x27;m not aware of anything like ssh public key authentication for Samba (or the SMB protocol), even though it does use Kerberos — which is rather involved to set up manually, though.<br>
<p>
It surely isn&#x27;t trivial as you absolutely must restrict the protocol version to the latest one (SMB3.1 or so) due to security issues in earlier versions. Then again, you have to do that with all the usual services; one shouldn&#x27;t run HTTPS with SSL 1.0 anymore either, after all. And no, most Apache &amp; nginx default installations on current popular server distributions do not come with the best/tightest SSL/TLS security settings either.<br>
<p>
Things are… complicated. What I don&#x27;t get, though, is the naysayers offering things such as Nextcloud/Owncloud (web-based file hosting services) as a supposedly secure alternative. What&#x27;s more secure about it? Both run over protocols for which older versions have security issues. Samba-the-project has had a couple of well-known security issues, but then again so do Nextcloud/Owncloud. Both usually authenticate via user &amp; password (unless the server belongs to a company environment where Kerberos is used for Samba &amp; maybe SAML for NC/OC). They&#x27;re both… roughly identical. What am I missing here?<br>
<p>
I do use it regularly for backups that are encrypted on the client side, accessing my hosting provider&#x27;s storage via CIFS. There are two different layers  (factors) of security, and that suffices for me, and the other alternatives are NFS without any type of transport layer security and sshfs, being its usual slow and sometimes unreliable self. Meh.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874158/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor874180"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2021 0:44 UTC (Thu)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874180/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Replying to myself for follow-up.<br>
<p>
<font class="QuotedText">&gt; Can you use SMB/CIFS over the Internet these days (without a VPN), or is that still considered insecure?</font><br>
<p>
The only notable example I found of anything similar was the use of SMB 3.1.1 in Microsoft Azure, which isn&#x27;t exactly &quot;over the Internet&quot; but comes fairly close. But everywhere else the consensus seemed to be &quot;don&#x27;t use SMB, even SMB 3, over the Internet without a VPN.&quot;<br>
<p>
<font class="QuotedText">&gt; You can even set up a multi-user mount point and have the kernel track per-user login credentials using the cifscreds utility.</font><br>
<p>
Despite the warnings, I spent a few hours configuring the most secure Samba configuration I could come up with for Linux-to-Linux file sharing (forcing SMB 3.1.1, inhibiting anonymous / guest logins, disabling netbios) and attempted to make this work.<br>
<p>
The first obstacle I encountered was that Samba (or at least the latest version available in any Debian release: 4.13) doesn&#x27;t support Unix extensions in SMB 3 mode—or the POSIX extensions which are meant to replace them. The Linux kernel supports them, but the server does not. Easy enough to work around—just mount without Unix or POSIX extensions. But this means certain features are unavailable.<br>
<p>
The real problem, though, was that there does not appear to be any way to set up a mount point for a SMB 3 share in multiuser mode without providing a username and password at mount time for an account with access to that share. This completely defeats the point of the &quot;multiuser&quot; option. The credentials which can access the share(s) should only be provided by individual users via the cifscreds utility—they aren&#x27;t available when the share is mounted from /etc/fstab or a systemd mount unit. Which implies that the kernel should just set up the mount point locally and not actually connect to the server until a user comes along with login credentials, but in practice the kernel tries to connect immediately. Allowing that connection to succeed so that it will create the mount point would mean either storing one user&#x27;s credentials for the entire system to use or else opening up the share to guest users on the server, neither of which is an attractive option.<br>
<p>
Anyway, it was an interesting challenge and I learned a lot about configuring modern Samba versions, but I&#x27;ll be sticking with SSHFS for the foreseeable future.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874180/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874734"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2021 13:00 UTC (Tue)
                               by <b>JanC_</b> (guest, #34940)
                              [<a href="/Articles/874734/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You don&#x27;t have to automount from fstab to use a remote filesystem…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874734/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874867"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2021 20:48 UTC (Tue)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874867/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; You don&#x27;t have to automount from fstab to use a remote filesystem…</font><br>
<p>
Naturally. But if you&#x27;re setting up a mount point with -o multiuser then you&#x27;re probably doing so as root (with or without /etc/fstab) and not as one of the (locally) unprivileged users with the login credentials for that share on the server. The mechanics of -o multiuser are that when a user accesses the local mount point the kernel gets the credentials from that user&#x27;s keychain and establishes a new connection to the server for that user. It doesn&#x27;t make sense to require &quot;default credentials&quot; to set up the mount point.<br>
<p>
The alternative is to install mount.cifs with the SUID bit enabled and let each user mount their own shares, which works (more or less, if you&#x27;re okay with the Windows version of the SMB3 protocol without POSIX extensions) but isn&#x27;t as nice as having a common multi-user mount point.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874867/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor874736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 2, 2021 13:20 UTC (Tue)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/874736/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think the way &quot;-o multiuser&quot; is supposed to work is without automounting but with Kerberos credentials. The initial mount attempt will have to be made with the machine&#x27;s Kerberos key (keytab). All subsequent accesses by users to said mount point will then be made with the user&#x27;s Kerberos credentials, though.<br>
<p>
I&#x27;ve never set that up without Kerberos, though.<br>
<p>
[1] Maybe that initial mount could also be done via automounting, not at boot, though I don&#x27;t know whether or not that works when the initial request for a currently unmounted directory comes from a user process.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor874309"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2021 3:49 UTC (Fri)
                               by <b>Fowl</b> (subscriber, #65667)
                              [<a href="/Articles/874309/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well &quot;SMB over QUIC&quot; is now a thing apparently.<br>
<p>
 <a href="https://techcommunity.microsoft.com/t5/itops-talk-blog/smb-over-quic-files-without-the-vpn/ba-p/1183449">https://techcommunity.microsoft.com/t5/itops-talk-blog/sm...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874309/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor874181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2021 1:51 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/874181/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  but rather performing all accesses as the particular user whose credentials were used to authenticate to the server</font><br>
<p>
This doesn&#x27;t mean anything for NFS.  NFS doesn&#x27;t authenticate a connection, it authenticates each request.<br>
<p>
With NFSv4, there is a &quot;first&quot; request (EXCHANGE_ID I think in v4.1 and v4.2) and almost all other requests inherit a &quot;state&quot; from that.  This is mostly used for clear ordering and exactly-once semantics.<br>
You seem to be suggesting that the credentials used to authenticate all subsequent requests should be ignored, and the credentials of the &quot;first&quot; request should be used throughout.<br>
<p>
If don&#x27;t think that would be useful with any current NFS client, as they use &quot;machine&quot; credentials to authenticate the state management, and that doesn&#x27;t necessarily map to any UID.  Obviously you could change the NFS client to behave differently, but then you would just change it to send the credential you want the server to honour.<br>
<p>
What precisely is it that you want to achieve.  I&#x27;m in favour of making NFS useful for more use-cases, but we would need a clear description of what the use-case is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874222"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2021 17:19 UTC (Thu)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874222/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; NFS doesn&#x27;t authenticate a connection, it authenticates each request. … You seem to be suggesting that the credentials used to authenticate all subsequent requests should be ignored, and the credentials of the &quot;first&quot; request should be used throughout.</font><br>
<p>
Not exactly. The CIFS/SMB multiuser model is a closer fit, where the kernel maintains the credentials for each server in a per-user keyring. One would need to do something about the flaw that SMB multiuser mounts still require valid credentials for an account with access to the share at mount time[0], though perhaps an NFS-based equivalent wouldn&#x27;t have that problem. It doesn&#x27;t really matter whether there is a single connection or multiple connections as long the credentials are not tied to a specific shared UID or username between the client and the server and all access checks are enforced on the server (i.e. the client can be untrusted). And of course I&#x27;d rather have POSIX/Linux filesystem semantics like NFS as opposed to a protocol originally designed around the Windows VFS. The protocol would obviously need to be hardened and encrypted to be a suitable alternative to SSHFS (SFTP) over the Internet and not just LANs. Regarding authentication, I currently require public keys for all SSH logins on my server, and I&#x27;d rather not go back to passwords.<br>
<p>
The full use case is basically this: Given any random Linux server which can be accessed through SSH, I would like to be able to mount a filesystem from this server from a separately-administered client machine using a kernel-based filesystem module, with the full POSIX semantics available from NFSv4 mounts and without the overhead and limitations of FUSE. The same mount point should be available to multiple users on the client, with each user accessing files on the server through their own existing SSH login credentials. In other words: Starting with SMB-style multiuser mounts, allow mounting without any default credentials, use the NFS protocol for the actual filesystem operations, and add public-key authentication and secure encryption akin to SSH.<br>
<p>
(One option for the authentication would be to actually perform an SSH login in userspace when adding the credentials with a fixed command which, on success, registers a temporary session key which can be loaded into the client&#x27;s keyring and used for all further requests. This seems like it would be fairly ergonomic and wouldn&#x27;t require the kernel to implement all the different authentication types supported by SSH.)<br>
<p>
The existing SMB3 support would probably be &quot;good enough&quot;, though not ideal due to limited POSIX support, if it weren&#x27;t for the issue of requiring mount-time credentials. I could even emulate SSH authentication by scripting a remote smbpasswd command with a temporary password, though that only allows one client machine at a time for each account and might involve running smbpasswd as root (with restricted options) to allow a new temporary password to be set without knowing the old one.<br>
<p>
[0] <a href="https://lwn.net/Articles/874180/">https://lwn.net/Articles/874180/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874222/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2021 22:17 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/874296/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another way to emulate this stuff would be doing what sftp does: use SSH subsystems. An ordinary command that forks ssh -s $subsystem_name implements the client side, using FUSE; it serializes the requests, echoes them into the ssh -s process&#x27;s stdin. The server side of this is an ordinary filter forked by sshd just as it forks sftp-server; this takes the serialized requests from the client on stdin, does... whatever on the filesystem (using ordinary fs ops: no need for special permission magic or fsuids because you are *already* the right user, properly authenticated by ssh), then serializes the results over its stdout. The client-side program receives them from its ssh -s invocation and hands them back via FUSE.<br>
<p>
A place to start on the server side of this is already written in the form of the sftp subsystem, though it doesn&#x27;t implement remotely enough operations and probably the serialization protocol should be rethought, since we are not at all wedded to the sftp protocol. The biggest problem is that by default this thing would be single-threaded, but a multithreaded version is perfectly possible that fires up multiple worker threads (possibly in an expanding-as-needed thread pool), kicks off separate ssh -s&#x27;s for each one, and lets things rip accordingly.<br>
<p>
Nobody has written any of this, but it&#x27;s purely userspace coding, likely fairly humdrum, and the performance impact of FUSE is probably going to be ignorable compared to the unavoidable performance impact of, well, using SSH (and honestly for all but really big bulk ops or ops on machines with slow CPUs I think you won&#x27;t even notice that).<br>
<p>
... oh dammit I want to write this thing now. (Assuming nobody already has. I haven&#x27;t even looked, but given the number of people who seem to be even *aware* of SSH subsystems, let alone how damn useful they are for things like this, I do strongly suspect that nothing like this exists.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874315"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2021 6:04 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874315/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe you&#x27;re describing SSHFS[0], though perhaps with a richer subsystem then SFTP. SSHFS is great; I use it all the time. But it does tend to have some issues. FUSE filesystems are rarely as performant as their native equivalents. If nothing else you need several extra context switches for each operation (app -&gt; kernel -&gt; FUSE -&gt; kernel -&gt; app), and in my experience large file transfers without explicit bandwidth limits can make the rest of the filesystem non-responsive. The latter issue may be more of an implementation issue with SSHFS or SFTP rather than FUSE itself. It&#x27;s not strictly single-threaded, so you can still access other files, but it doesn&#x27;t seem to load-balance fairly. FUSE filesystems also run as ordinary users while servicing requests from the kernel, perhaps from other users or even root, which means they have some security issues to mitigate which may not apply to an in-kernel filesystem. And it would be difficult (though not impossible) to implement something like SMB3 multiuser mounts via FUSE where all local users see the same paths but access them with their own remote credentials.<br>
<p>
An SSHFS equivalent using something like the NFS protocol (without any NFS authentication, just acting as the logged-in user) through an SSH tunnel  instead of SFTP would be an interesting design, though it doesn&#x27;t address my main design goal of migrating the filesystem away from FUSE and into the kernel.<br>
<p>
[0] <a href="https://github.com/libfuse/sshfs">https://github.com/libfuse/sshfs</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874315/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2021 12:51 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/874336/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sort of. To minimize installation difficulties (since subsystems have to be configured on the server side with one line in sshd_config), sshfs doesn&#x27;t use the subsystem mechanism but implements its own transport, which means it has to encode everything passing over the wire and relies on the far side&#x27;s shell being set up sanely and the like. But sshfs is probably a good place to start from!<br>
<p>
A true multiuser permission-respecting filesystem... well, I guess if you ssh as root it could setfsuid as needed as requests came in. That&#x27;s what the fsuid is for, after all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874362"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2021 14:54 UTC (Fri)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/874362/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; sshfs doesn&#x27;t use the subsystem mechanism but implements its own transport</font><br>
<p>
The code in sshfs.c[0] appears to pass &quot;-s sftp&quot; to the SSH command by default (i.e. using the subsystem mechanism) unless the sftp_server option is set (with a path) or the SSHv1 protocol is selected.<br>
<p>
<font class="QuotedText">&gt; A true multiuser permission-respecting filesystem... well, I guess if you ssh as root it could setfsuid as needed as requests came in.</font><br>
<p>
The kernel SMB3 implementation creates a separate connection for each user, and I&#x27;d probably do the same thing here. Many systems, my own included, don&#x27;t allow direct root logins via SSH; ssh as root + setfsuid on the server would essentially mean trusting the client machine with root access to the server, and even with restrictions such as only allowing this one approved subsystem it could be used to bypass SSH login policies.<br>
<p>
The FUSE filesystem would need to be set up by root on the client with the allow_other option to permit shared access. You could have an interface for users to link their ssh-agent to the FUSE filesystem so it can connect on their behalf (using keys), though I&#x27;m sure there would be all sorts of interesting security and UX implications.<br>
<p>
[0] <a href="https://github.com/libfuse/sshfs/blob/master/sshfs.c">https://github.com/libfuse/sshfs/blob/master/sshfs.c</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874362/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor874392"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2021 17:32 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/874392/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The code in sshfs.c[0] appears to pass &quot;-s sftp&quot; to the SSH command by default (i.e. using the subsystem mechanism) unless the sftp_server option is set (with a path) or the SSHv1 protocol is selected.</font><br>
<p>
OK I&#x27;m too tired to think then, or simply can&#x27;t read. It really is there and really obvious :) I guess that shows I was thinking of the right design, since sshfs is already doing it!<br>
<p>
OK, so the right thing to do is to soup up sftp-server until it can do everything FUSE can be asked for, then soup up sshfs to talk to it and add a thread pool etc to it :) if this doesn&#x27;t work (rejected by upstream), sshfs could ship its own variant (under another name: sshfs-server) and use it if set up on a remote system.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874392/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor874310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2021 4:14 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/874310/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the extra context.<br>
<p>
I interpret your problem description as &quot;You want a key distribution protocol based on ssh rather than kerberos, and you want NFS to be able to work with the keys thus distributed&quot;.<br>
<p>
NFS is designed to have pluggable authentication systems, but krb5 wrapped in rpcsec/gss is the only one that is actually implemented.<br>
The kernel &quot;knows&quot; about krb5 certificates and encryption scheme, but out-sources to user-space for distributing those certificates and keys.<br>
<p>
I wonder if it would be possible to use an ssh-based scheme to distribute keys.  I have no knowledge of the internals of krb5 certificates, but my guess is that it isn&#x27;t completely out of the question.  You would need to modify or replace gssproxy on the server and rpc.gssd on the client.<br>
<p>
An alternate possible direction involves NFS over TLS.  This is a draft standard for this, and I think there is prototype code.  Whether the standard allows the credential for the connection to be used for FS requests, I don&#x27;t know.  If it did, then this might be a direction that could be standards-complient and so more likely to be implemented widely.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/874310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor872205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 19:44 UTC (Thu)
                               by <b>jokeyrhyme</b> (subscriber, #136576)
                              [<a href="/Articles/872205/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://paulmck.livejournal.com/62436.html">https://paulmck.livejournal.com/62436.html</a><br>
<p>
<font class="QuotedText">&gt; On the other hand, might the rumored sudden merge of the ksmdb driver (<a href="https://lwn.net/Articles/871098/">https://lwn.net/Articles/871098/</a>) have been due to the implicit threat of its being rewritten in Rust?</font><br>
<p>
I wasn&#x27;t aware that ksmbd had been &quot;rushed&quot;, but I hope fear of Rust isn&#x27;t a motivating factor in contributing C code to the kernel, haha<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor872217"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2021 21:54 UTC (Thu)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/872217/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Based on the work he has done on ksmbd, we invited Namjae to join the Samba Team, and he accepted ! Ralph is now taking a very close look at the ksmbd code, and I have high hopes the needed security review will get done. I wish it had been done *before* the merge was requested, but that&#x27;s another story :-).<br>
<p>
A small history lesson :-). The first bug I spotted in ksmbd (using ../../../ to escape from a share) I remember was demonstrated by tridge to Microsoft against a Windows NT server back in Redmond in 1996. They fixed it by checking for the specific &quot;../&quot; characters he was using - he swiftly demonstrated to them this wasn&#x27;t enough :-). That was a different time, and a different Microsoft.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872217/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872415"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 10, 2021 14:06 UTC (Sun)
                               by <b>Rudd-O</b> (guest, #61155)
                              [<a href="/Articles/872415/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the amazing software you guys create!  🤘<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872415/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 0:29 UTC (Fri)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/872227/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m sure ksmbd will turn out to be fine software, but it still feels a bit like surrender. In principle, shouldn&#x27;t it be possible, with appropriate APIs (e.g. io_uring, eBPF), to make a userspace implementation just as fast as a pure-kernel approach? The up-front investment in high-performance API design might require a bit more work than moving tons of server logic to the kernel, but it&#x27;ll pay off in the end by helping *every* program achieve good performance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872229"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 0:56 UTC (Fri)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/872229/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well the performance tests were done by the ksmbd developers, not by the Samba developers :-). We already have an io_uring module but Samba is a little more complex to configure, so it&#x27;s possible that the performance gap may not be so bad :-).<br>
<p>
See here:<br>
<p>
<a href="https://www.youtube.com/watch?v=eYxp8yJHpik">https://www.youtube.com/watch?v=eYxp8yJHpik</a><br>
<p>
for an excellent talk by Metze (Stefan Metzemacher) for the latest Samba performance data with io_uring.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872229/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872573"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 11, 2021 17:29 UTC (Mon)
                               by <b>slowfranklin</b> (guest, #134701)
                              [<a href="/Articles/872573/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, latest tests with io_uring shows Samba is actually *faster* then ksmbd at this point. Still working out the details, but generally I would say for streaming IO performance Samba and ksmbd should achieve similar numbers. For metadata oriented workloads ksmbd  is going to come out first.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872573/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor872232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 3:03 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/872232/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn&#x27;t feel to me like ksmbd was written with performance in mind.  It doesn&#x27;t make good use of kernel facilities.  It feels like it was written by someone who really doesn&#x27;t know much about the kernel.  I did a small amount of review before it went in (and the changes I asked for were made!), but I didn&#x27;t feel like it was good quality code.<br>
<p>
I don&#x27;t have time to do the thorough review I&#x27;d like to do.  Sorry.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor872237"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Supporting Microsoft filesystem server but not multicast IPC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 4:28 UTC (Fri)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/872237/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For years attempts to add D-BUS-like IPC into the kernel have failed:<br>
<p>
<a href="https://lwn.net/Articles/504970/">https://lwn.net/Articles/504970/</a><br>
<p>
As far as I know, the kernel still lacks a built-in multicast IPC facility.  Among the notable failed attempts are not only AF_BUS linked above, but also the subsequent KDBUS.     The principal objector the last time was Andy Lutomirski:<br>
<p>
<a href="https://lkml.org/lkml/2015/6/23/22">https://lkml.org/lkml/2015/6/23/22</a><br>
<p>
Part of the objection may have been to integration with systemd, which was more controversial in 2015 than now.   Lutomirski concluded:<br>
<p>
&quot;I think that a very high quality implementation of the<br>
kdbus concept and API would be a bit faster than a very high quality<br>
userspace implementation of dbus.  Other than that, I think it would<br>
actually be worse.  The kdbus proponents seem to be comparing the<br>
current kdbus implementation to the current userspace implementation,<br>
and a favorable comparison there is not a good reason to merge it.&quot;<br>
<p>
Perhaps Lutomirski, whom we should thank for years of hard work as a maintainer, did not have a chance to read the ksmbd patchset.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872237/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Supporting Microsoft filesystem server but not multicast IPC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 6:34 UTC (Fri)
                               by <b>PengZheng</b> (subscriber, #108006)
                              [<a href="/Articles/872244/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;ve followed all LWN reports on KDBUS/BUS1, but failed to find any clue of why these efforts failed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872295"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Supporting Microsoft filesystem server but not multicast IPC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 16:08 UTC (Fri)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/872295/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because we can&#x27;t have nice things. Instead, we need to do bad things in userspace to work around kernel deficiencies - like reinventing a different transport protocol from scratch (varlink) instead of having reliable kernel-backed early-boot IPC primitives.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872295/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor872323"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Supporting Microsoft filesystem server but not multicast IPC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2021 22:43 UTC (Fri)
                               by <b>atai</b> (subscriber, #10977)
                              [<a href="/Articles/872323/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Consider Android&#x27;s binder is not in the standard kernel also... it is not too bad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872323/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor873792"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Supporting Microsoft filesystem server but not multicast IPC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2021 13:54 UTC (Sat)
                               by <b>HelloWorld</b> (guest, #56129)
                              [<a href="/Articles/873792/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Binder is part of the mainline kernel since 3.19.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/873792/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor872349"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 9, 2021 9:32 UTC (Sat)
                               by <b>xophos</b> (subscriber, #75267)
                              [<a href="/Articles/872349/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Samba is best kept out of the network. Putting it into kernel space is completely bonkers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872349/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 11, 2021 8:47 UTC (Mon)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/872438/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
s/SAMBA/the SMB protocol/<br>
Do not shoot the implementer...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872583"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 11, 2021 18:55 UTC (Mon)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/872583/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s a natural mistake. Even Microsoft web pages have occasionally referenced &quot;the Samba protocol&quot; :-) :-). One of the hazards of being a well-known implementation I guess :-).<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872583/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor872771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 13, 2021 6:36 UTC (Wed)
                               by <b>xophos</b> (subscriber, #75267)
                              [<a href="/Articles/872771/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To me it&#x27;s a distiction without a difference anyway. I don&#x27;t think that something this complex can be implemented in a secure way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/872771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor901954"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A rough start for ksmbd</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 21, 2022 1:24 UTC (Thu)
                               by <b>llamafilm</b> (guest, #159799)
                              [<a href="/Articles/901954/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One of the main reasons stated for including in the kernel is for better RDMA support.  This is essential for speeds above 10Gbps.  SMB Direct on a Windows server can get pretty close to saturating a 100GbE connection with fairly low CPU usage.  (I haven&#x27;t tried more than one 100Gb connection yet).  I&#x27;m curious to hear if anyone has experience with high throughput RDMA in Samba vs ksmbd.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/901954/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
