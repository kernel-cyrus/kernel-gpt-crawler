        <!DOCTYPE html>
        <html lang="en">
        <head><title>A better btrfs [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/265257/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/264521/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/265257/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A better btrfs</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 15, 2008</br>
           </div>
Chris Mason has recently released <a
href="http://lwn.net/Articles/265199/">Btrfs v0.10</a>, which contains a
number of interesting new features.  In general, Btrfs has come a long way
since LWN first <a href="http://lwn.net/Articles/238923/">wrote about
it</a> last June.  Btrfs may, in some years, be the filesystem most of us
are using - at least, for those of us who will still be using rotating
storage then.  So it bears watching.
<p>

Btrfs, remember, is an entire new filesystem being developed by Chris
Mason.  It is a copy-on-write system which is capable of quickly creating
snapshots of the state of the filesystem at any time.  The snapshotting is
so fast, in fact, that it is used as the Btrfs transactional mechanism,
eliminating the need for a separate journal.  It supports subvolumes -
essentially the existence of multiple, independent filesystems on the same
device.  Btrfs is designed for speed, and also provides checksumming for
all stored data.
<p>

Some kernel patches show up and quickly find their way into production
use.  For example, one year ago, nobody (outside of the -ck list, perhaps) was talking
about fair scheduling; but, as of this writing, the CFS scheduler has been
shipping for a few months.  KVM also went from initial posting to merged
over the course of about two kernel release cycles.
Filesystems do not work that way, though.
Filesystem developers tend to be a cautious, conservative bunch; those who
aren't that way tend not to survive their first few encounters with users
who have lost data.  This is all a way of saying that, even though Btrfs is
advancing quickly, one should not plan on using it in any sort of
production role for a while yet.  As if to drive that point home, Btrfs
still crashes the system when the filesystem runs out of space.  The v0.10
patch, like its predecessors, also changes the on-disk format.
<p>

The on-disk format change is one of the key features in this version of the
Btrfs patch.  The format now includes back references on almost all objects
in the filesystem.  As a result, it is now easy to answer questions like
"to which file does this block belong?"  Back references have a few uses,
not the least of which is the addition of some redundant information which
can be used to check the integrity of the filesystem.  If a file claims to
own a set of blocks which, in turn, claim to belong to a different file,
then something is clearly wrong.  Back references can also be used to
quickly determine which files are affected when disk blocks turn bad.
<p>

Most users, however, will be more interested in another new feature which
has been enabled by the existence of back references: online resizing.  It
is now possible to change the size of a Btrfs filesystem while it is
mounted and busy - this includes shrinking the filesystem.  If the Btrfs
code has to give up some space, it can now quickly find the affected files
and move the necessary blocks out of the way.  So Btrfs should work nicely
with the device mapper code, growing or shrinking filesystems as conditions
require.
<p>

Another interesting feature in v0.10 is the associated in-place ext3
converter.  It is now possible to non-destructively convert an existing
ext3 filesystem to Btrfs - and to go back if need be.  The converter works
by stashing a copy of the ext3 metadata found at the beginning of the disk, then
creating a parallel directory tree in the free space on the filesystem.  So
the entire ext3 filesystem remains on the disk, taking up some space but
preserving a fallback should Btrfs not work out.  The actual file data is
shared between the two filesystems; since Btrfs does copy-on-write, the
original ext3 filesystem remains even after the Btrfs filesystem has been
changed.  Switching to Btrfs forevermore is a simple matter of deleting the
ext3 subvolume, recovering the extra disk space in the process.
<p>

Finally, the copy-on-write mechanism can be turned off now with a mount option.  For
certain types of workloads, copy-on-write just slows things down without
providing any real advantages.  Since (1)&nbsp;one of those workloads is
relational database management, and (2)&nbsp;Chris works for Oracle, the
only surprise here is that this option took as long as it did to arrive.
If multiple snapshots reference a given file, though, copy-on-write is
still performed; otherwise it would not be possible to keep the snapshots
independent of each other.
<p>

For those who are curious about where Btrfs will go from here, Chris has
posted <a
href="http://oss.oracle.com/projects/btrfs/dist/documentation/todo.html">a
timeline</a> describing what he plans to accomplish over the coming year.
Next on the list would appear to be "storage pools," allowing a Btrfs
filesystem to span multiple devices.  Once that's in place, striping and
mirroring will be implemented within the filesystem.  Longer-term projects
include per-directory snapshots, fine-grained locking (the filesystem
currently uses a single, global lock), built-in incremental backup support,
and online filesystem checking.  Fixing that pesky out-of-space problem
isn't on the list, but one assumes Chris has it in the back of his mind
somewhere.
<p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Btrfs">Btrfs</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Btrfs">Filesystems/Btrfs</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/265257/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor265438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 9:21 UTC (Thu)
                               by <b>Klavs</b> (guest, #10563)
                              [<a href="/Articles/265438/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I always hate when developers try to be the "do-all" solution. Btrfs sounds very nice, but it
is a but worrying that he wants to let the filesystem handle multiple device spanning and
striping and mirroring over these. 
We already have Logical Volume Manager for the multiple device spanning (which can also
mirror) and Linux also has raid support.
If, for some reason, they are lacking something he'd like to have - then it would be better to
extend those solutions to support it, to the benefit of all users of it - and not just
implement his own solutions for the benefit of Btrfs only.
I also expect that it would be hard to get LWM and mirroring support in the kernel - when it's
already there. But perhaps I'm missing something :)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265439"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 9:23 UTC (Thu)
                               by <b>Klavs</b> (guest, #10563)
                              [<a href="/Articles/265439/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
s/but worrying/bit worrying/ 

I look forward to the "edit your post" feature :)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265439/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">the &quot;edit your post&quot; feature?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 12:40 UTC (Fri)
                               by <b>bignose</b> (subscriber, #40)
                              [<a href="/Articles/265719/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt; I look forward to the "edit your post" feature :)</font>

It's already there. You get to edit your post as many times as you see fit; you're even denied
the opportunity to publish without a separate preview first. Fix any errors before anyone else
sees them.

Once you've published the post, I consider it a very desirable feature that you can't edit it
-- that way, the discussion follows chronologically instead of people going back and changing
what they said.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">the &quot;edit your post&quot; feature?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 18:55 UTC (Sat)
                               by <b>i3839</b> (guest, #31386)
                              [<a href="/Articles/265855/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Editing should only be allowed as long as no one replied yet, and as long as it's not too long
ago. That way silly typo's can be fixed (or embarrassing posts removed), but history not
rewritten.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 9:31 UTC (Thu)
                               by <b>Felix.Braun</b> (guest, #3032)
                              [<a href="/Articles/265440/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <p>Especially those "rampant layering violations" remind me a lot of Solaris' ZFS. Actually, the feature set promised by btrfs sounds like a re-implementation of ZFS. Seeing that btrfs is being developped at Oracle makes the competition-scenario between Oracle and Sun mentioned on the front page sound all the more plausible. I guess that means, ZFS won't be easily portable to Linux anytime soon... (Isn't ZFS GPLv3 only?)</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/265440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265444"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 9:55 UTC (Thu)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/265444/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
No, ZFS is CDDL only (Sun's "Common Development and Distribution License"), which is
incompatible with any version of GPL.

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265444/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor265676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 3:05 UTC (Fri)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/265676/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
The one ZFS feature I really want is checksumming of all disk blocks, which can detect disk
failures, bad cables, controller failures, etc.  As disks climb towards 1 TB being an average
size, the error rate per disk becomes surprisingly high...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265811"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 23:25 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/265811/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
As disks climb towards 1 TB being an average
size, the error rate per disk becomes surprisingly high...
</blockquote>
<p>
But who cares about error rate per disk?
<p>
Error rate per system administrator or per year or per gigabyte seems more interesting.

      
          <div class="CommentReplyButton">
            <form action="/Articles/265811/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265822"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 0:41 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/265822/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Hm, the former of those is interesting. `Why yes, you *can* reduce your 
error rate: just hire more sysadmins!'
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265822/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor266520"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pair admining?  Test driven administration?  XA (eXtreme Admin'ing)?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 25, 2008 21:00 UTC (Fri)
                               by <b>AnswerGuy</b> (guest, #1256)
                              [<a href="/Articles/266520/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
 "Just" hiring more sysadmins clearly wouldn't reduce your error rate.  By itself it would
almost certainly *increase* the number of systems administration errors.

 However, I have been mulling over the application of agile development methods to systems
administration.  (In fact I even gave a brief talk  on that idea at last years LinuxWorld in
San Francisco).

 Consider some of the possibilities:

 Test driven administration:  

 Configure monitoring for that new server before you configure the server.  Alarms should go
off; response procedures should be executed ... a service window should be scheduled (with
estimated date of completion), which should defer further alarms from that source.  (Same
applies to each service that's to be deployed).  Now you know that the monitoring is doing
something useful.  When the monitoring shows the service "going green" then you know you have
configured the service correctly (with respect to the monitoring system --- i.e. DNS or other
directory services, IP addressing, routing, etc).  (If you find a corner case --- where
monitoring gives a false "green" status --- try to improve the monitoring to more closely
model a service's *correct* functionality).

 Integrate imaging and system's restoration.  Image a system, configure it,  backup
configuration and initial (test) data, then create a new imaging profile to facilitate
automated re-imaging of the system with automated restore of the configuration and data.  Then
wipe the system and re-image it using that profile.  Repeat until the system's complete
configuration and data is restored automatically.  THEN put the system into production.

 There are a number of other ideas along similar veins.  One of them is that we might want to
institute a policy ... for critical production servers ... of having our admins work in pairs
(perhaps over a shared GNU screen session) where one of the admins types each command, then
the other confirms that it's safe/correct and hits [Enter] when they both concur.  (Better
admins among us have learned to pause before hitting [Enter] when working "live" on mission
critical servers ... take a deep breath ... re-read that command ... perhaps try the "echo" or
"--dry-run" version of it first ... consider the risks ... and *THEN* (maybe) hit [Enter].
But even the best of us gets in a hurry, gets flustered or tired, or just experiences cognitive
hiccoughs).

(In my case I was an electrician for years before embarking on my IT career --- working with
potentially live wiring offers similar lessons with potentially lethal and immediately painful
consequences for any lapse in due care!  And yes, despite all that I did occasionally get
zapped!)

JimD

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/266520/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor266645"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pair admining?  Test driven administration?  XA (eXtreme Admin'ing)?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 26, 2008 3:42 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/266645/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
 "Just" hiring more sysadmins clearly wouldn't reduce your error rate. 
</blockquote>
<p>
It would if the error rate you're using is disk errors per year per sysadmin, which is what we were talking about.
<p>
It underscores the point that there are lots of error rates you can define, and you have to pay attention to your denominators.
<p>
Nonetheless, your ideas about reducing errors per something by improving system administration methods are interesting.

      
          <div class="CommentReplyButton">
            <form action="/Articles/266645/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265840"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 12:19 UTC (Sat)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/265840/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
I care about error rate per disk - if each disk is very likely to have a bad block at any
time, as seems more likely to be the case with today's larger disks, then you start to really
need RAID, block checksumming, etc, simply to avoid losing data.

I believe that people are storing more and more data on a given system, and the fact that
p(error on this system) is going up should be of concern.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265840/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265851"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 19, 2008 17:54 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/265851/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
if each disk is very likely to have a bad block at any
time, as seems more likely to be the case with today's larger disks, then you start to really
need RAID, block checksumming, etc, simply to avoid losing data.
</blockquote>
<p>
That risk would be the same if you had 10 disks, each with one tenth the data and one tenth the error rate.
<p>
<blockquote>
I believe that people are storing more and more data on a given system, and the fact that
p(error on this system) is going up should be of concern.
</blockquote>
<p>
Now you're talking about error rate per system, not per disk.
<p>
And I'm not convinced that's important either.  Spreading data out across 10 systems doesn't make the data loss hurt any less.

      
          <div class="CommentReplyButton">
            <form action="/Articles/265851/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265889"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 20, 2008 18:08 UTC (Sun)
                               by <b>Cato</b> (guest, #7643)
                              [<a href="/Articles/265889/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Error rate per system is a better metric as you say - your original post said 'error rate per
system administrator' which was a bit confusing.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265889/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265891"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 20, 2008 20:57 UTC (Sun)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/265891/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I think error rate per system is more useful than error rate per disk, but as I said, even error rate per system isn't terribly useful.  Error rate per system administrator is considerably more useful.
<p>
If a major cost of disk errors is a system administrator having to replace a disk, restore from backup, recreate data, etc., then you care how many times a year the system administrator has to do that.  Consolidating data from two systems onto one doubles your error rate per system, but doesn't mean you have to increase your RAID redundancy and such because the error rate per system administrator is still the same.  On the other hand, piling a terabyte of movies onto the systems managed by a system administrator increases that error rate and might require some new method of dealing with the errors.

      
          <div class="CommentReplyButton">
            <form action="/Articles/265891/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor267125"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Error-rate / disk</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2008 3:11 UTC (Wed)
                               by <b>Max.Hyre</b> (subscriber, #1054)
                              [<a href="/Articles/267125/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>When the error requires taking the disk offline to fix it, I care.  Until I can access all of a Tbyte disk in the time it takes to access a, say, 200 
Gbytes, the downtime per spindle will be greater, and what you really care about is the downtime, for any problem.*

<p>It's bad enough waiting for a fsck on a 100 GB partition.
<hr>
<p>* Well, data loss figures in there somewhere, but lost data typically hurts a few users, but being offline affects everyone.

      
          <div class="CommentReplyButton">
            <form action="/Articles/267125/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor265450"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 10:35 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/265450/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt;We already have Logical Volume Manager for the multiple device spanning (which can also
mirror) and Linux also has raid support.</font>

*Clap* LVM or not, you need a filesystem that is shrinkable before you can make use of LVM
shrinking.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265450/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 16:29 UTC (Thu)
                               by <b>ttonino</b> (guest, #4073)
                              [<a href="/Articles/265540/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Doing mirroring in the file system would also allow mirroring of metadata and files that
warrant it. That big video temporary file could be striped on the other hand - and later
perhaps converted to mirrored with some kind of chattr command.

Cutting out the layering also enables better layout of data on the disk. When writing, a
single small write would be kept on the same disk, and not straddle a stripe boundary which
would lead to unneeded extra IOs. One could even write a file as raid5 or raid6 while other
files on the same FS are mirrored or striped, or just on a single device.

However, writing multiple files each to its own disk, and keeping track of the parity
independently is much more complex. That would be very good for read performance (only one
head moves for each file read), and raid 6 is better at protecting data than mirroring.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 18, 2008 23:36 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/265812/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
Though I'm usually a great champion of layering, I like RAID in the filesystem better than RAID under the filesystem.
<p>
In addition to the benefits already stated, it speeds up builds and rebuilds because the filesystem knows which blocks contain no useful data.  And the filesystem can avoid read-modify-write if it knows the stripe size.
<p>
RAID <em>above</em> the filesystem (RAIF) also has many of these features.
<p>
I think the main value of RAID in the block layer is that it works with a dumb filesystem.  <em>That</em>, of course, isn't an argument against putting RAID in the filesystem.

      
          <div class="CommentReplyButton">
            <form action="/Articles/265812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265461"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Wrong priorities / features</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 11:09 UTC (Thu)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/265461/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Agreed! I think fine-grained locking should be second on the list, just after the out-of-space
bugfix, then let's try it out on a big scale before adding any more features (I start sounding
like Andrew Morton, amn't I? :)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265461/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor265479"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 12:54 UTC (Thu)
                               by <b>sveinrn</b> (guest, #2827)
                              [<a href="/Articles/265479/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
To me it seems to solve all the stupid problems with md/lvm/ext3. Just as I am writing this,
the users of my system are waiting for a "resize2fs" to complete. With file systems at several
TB on a rather slow MSA 1500 this can take hours. SLES10 has a command for doing the resize
online, but every time I try, it complaints about an inode or data block in the wrong location
or something like that. (I have not tried lately, so I don't remember the exact error
message.) 

Being able to create a mirror of something that is not on an MD-device sounds great,
especially with lvm where a filesystem spans multiple volumes and is mixed up with lots of
other filesystems that don't need mirroring. pvmove offers some of the functionality, but has
caused some horrible system crashes, and I'm only allowed to use it during the night after the
backup has completed. 

One of the reasons I was allowed to replace HPUX as our NFS-server was that I told management
that Linux was at least equally flexible... :(

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265479/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265490"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 13:07 UTC (Thu)
                               by <b>sveinrn</b> (guest, #2827)
                              [<a href="/Articles/265490/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
OK, I see that in SLES10 there is a command called lvconvert which creates mirrors. I have not
needed the functionality after we upgraded from SLES9...

But still, the general feeling is that Linux lags several years behind other operating systems
when it comes to handling of large filesystems. 
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265490/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor265533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 15:59 UTC (Thu)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/265533/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Working nicely with LVM is a long term goal for Btrfs.  However, Btrfs will (optionally)
maintain duplicate copies of metadata so that it can find a valid copy when it notices
checksumming errors, or errors reading from the device.

This is something LVM cannot provide because it cannot maintain consistent checksums for the
FS.  Also, many admins will want to enable metadata mirroring even on single volume
filesystems where LVM isn't used.

When multiple devices are present, Btrfs will want to know it is mirroring on different
physical spindles.  This is a challenge with LVM since the locations of physical extents can
change without the FS knowing about it.  Even if there were hooks so the FS could know the
current extent mappings, it would end up duplicating a copy of the mappings internally.

So, the storage pool features are not trying to reimplement MD/LVM, but they are trying to
carve out the critical features that LVM cannot provide as efficiently as the FS can.  

Multipathing, raid3/5 etc, dm-crypt and most of the other fun things you can do with the
storage stack are not planned Btrfs features...

</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor266656"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 26, 2008 13:22 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/266656/">Link</a>] 
      </p>
      
      </div>
      </summary>
      It's nice to see that Btrfs is going forward.  I would really like to
see snapshots done properly.

<p>One other feature I would like to see in a file system, and which
should be relatively easy to implement in a copy-on-write file system
is (what I call) <a
href="http://www.complang.tuwien.ac.at/papers/czezatke%26ertl00/#sect-in-order">in-order
semantics</a>:

<blockquote>
The file system after recovery represents all write()s
(or other changes) that occurred before a specific point in time, and
no write() (or other change) that occurred afterwards. I.e., at most
you lose a minute or so of work.

<p>The value of this guarantee may not be immediately obvious. It
means that if an application ensures file data consistency in case of
its own unexpected termination by performing writes and other file
changes in the right order, its file data will also be consistent (but
possibly not up-to-date) in case of a system failure
</blockquote>

I note that your announcement and the timeline contains a feature
"data=ordered support", but it's not clear what kind of consistency
guarantee this entails (apart from "preventing null bytes in a file
after a crash").  Maybe you can implement in-order semantics as part
of the data=ordered support, or add it as another feature to the ToDo
list.

      
          <div class="CommentReplyButton">
            <form action="/Articles/266656/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor265448"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 10:33 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/265448/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
<font class="QuotedText">&gt;Most users, however, will be more interested in another new feature which has been enabled by
the existence of back references:</font>

Namely inotify. No more need to place one inotify-watch per directory. At least in theory.
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265448/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor265456"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 10:55 UTC (Thu)
                               by <b>Velmont</b> (guest, #46433)
                              [<a href="/Articles/265456/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
This will make a very good and easy backup solution for Desktops then? No-fuss and
«transparent» backup. Feel stupid to say it; but we might easily get something like OS X's
time machine. :-)
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265456/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265460"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A better btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 11:08 UTC (Thu)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/265460/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
OS X's Time Machine product is pretty straightforward -- it does do a weird trick with
hard-linking directories, but one could write a perfectly great desktop backup program without
any such hacks.  It's not really complicated and btrfs doesn't really make it any easier.  The
problem is that for some reason, people seem to only be interested in writing backup systems
that are either really grungy and low-level and often inadequate in practice, or all-singing
all-dancing incredibly complex things.  I guess this is because the two markets for backup so
far are "geeks who want to hack something together for personal use" and "full-time sysadmins
who get paid big-bucks to manage large networks".
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265460/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor265529"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backup progs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 17, 2008 15:34 UTC (Thu)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/265529/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment"><pre>
Can you please try mine then, and privately tell me (my e-mail is in the README file in the
source code tree) what you feel is positive/negative?

<a href="http://sf.net/projects/hbackup">http://sf.net/projects/hbackup</a>

Note: it's work in progress and a GUI should come one day...
</pre></div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/265529/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2008, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
