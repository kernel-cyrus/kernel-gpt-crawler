        <!DOCTYPE html>
        <html lang="en">
        <head><title>Debating composefs [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/922851/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/923505/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/922851/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Debating composefs</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 16, 2023</br>
           </div>
When LWN <a href="/Articles/917097/">looked at the composefs filesystem</a>
in December, we reported that there had been "little response" to the
patches.  That is no longer the case.  Whether composefs (or something like
it) should be merged has become the subject of an extended debate; at its
core, the discussion is over just how Linux should support certain types of
container workloads.
<p>
Composefs is an interesting sort of filesystem, in that a mounted
instance is an assembly of two independent parts.  One of those, an
"object store", is a directory tree filled with files of interest, perhaps
with names that reflect the hash of their contents; the object store
normally lives on a read-only filesystem of its own.  The other is a
"manifest" that maps human-readable names to the names of files in the
object store.  Composefs uses the manifest to create the filesystem that is
visible to users while keeping the object store hidden from view.  The
resulting filesystem is read-only.
<p>
This mechanism is intended to create the system image for containers.  When
designing a container, one might start with a base operating-system image,
then add a number of layers containing the packages needed for that
specific container's job.  With composefs, the object store contains all of
the files that might be of interest to any container the system might run,
and the composition of the image used for any specific container is done in
the manifest file.  The result is a flexible mechanism that can mount a
system image more quickly than the alternatives while allowing the object
store to be verified with <a
href="https://www.kernel.org/doc/html/latest/filesystems/fsverity.html">fs-verity</a>
and shared across all containers in the system.
<p>
<h4>The v3 discussion</h4>
<p>
<a href="/ml/linux-kernel/cover.1674227308.git.alexl@redhat.com/">Version 3
of the composefs patches</a> was posted in late January; it included a
number of improvements requested by reviewers of the previous versions.
Amir Goldstein <a
href="/ml/linux-kernel/CAOQ4uxgGc33_QVBXMbQTnmbpHio4amv=W7ax2vQ1UMet0k_KoA@mail.gmail.com/">was
not entirely happy</a> with the work that had been done, though; he
suggested that, rather than proposing composefs, the developers (Alexander
Larsson and Giuseppe Scrivano) should put their efforts into improving the
existing kernel subsystems (specifically <a
href="https://docs.kernel.org/filesystems/overlayfs.html">overlayfs</a> and
the <a href="https://docs.kernel.org/filesystems/erofs.html">EROFS
filesystem</a>) instead.
<p>
A long discussion of the value (or lack thereof) of composefs followed.
There are currently two alternatives to composefs that are used for
container use cases:
<p>
<ul class="spacylist">
<li> At container boot time, the system image is assembled by creating a
     large set of symbolic links to the places where the target files
     actually live.  This approach suffers from a lengthy startup time; at
     least one system call is required to create each of thousands of
     symbolic links, and that takes time.
<li> The container is given a base image on a read-only filesystem;
     overlayfs is then used to overlay one or more layers on top to create
     the container-specific image.
</ul>
<p>
The consensus seems to be that the symbolic-link approach, due to its
startup cost, is not a viable alternative to composefs.  Goldstein and
others do think that the overlayfs approach could be viable, though,
perhaps with a few changes to that filesystem.  The composefs developers
are not so sure.
<p>
<h4>Considering overlayfs</h4>
<p>
One current shortcoming with overlayfs, Scrivano <a
href="/ml/linux-kernel/87ilh0g88n.fsf@redhat.com/">said</a>, is that,
unlike composefs, it is unable to provide fs-verity protection for the
filesystem as a whole.  Any changes that affect the overlay layer would
bypass that protection.  Larsson <a
href="/ml/linux-kernel/1ea88c8d1e666b85342374ed7c0ddf7d661e0ee1.camel@redhat.com/">described</a>
an overlayfs configuration that could work (with some improvements to
overlayfs), but was unenthusiastic about that option:
<p>
<blockquote class="bq">
	However, the main issue I have with the overlayfs approach is that
	it is sort of clumsy and over-complex. Basically, the composefs
	approach is laser focused on read-only images, whereas the
	overlayfs approach just chains together technologies that happen to
	work, but also do a lot of other stuff.
</blockquote>
<p>
Among other things, he said, the extra complexity in the overlayfs solution
leads to worse performance.  The benchmark he used to show this was to
create a filesystem using both approaches, then measure the time required
to execute an "<tt>ls&nbsp;-lR</tt>" of the whole thing.  In the cold-cache
case, the overlayfs solution took about four times as long to run; the
performance in the warm-cache case was more comparable, but composefs was
still faster.
<p>
Goldstein <a
href="/ml/linux-kernel/CAOQ4uxinsBB-LpGh4h44m6Afv0VT5yWRveDG7sNvE2uJyEGOkg@mail.gmail.com/">strongly
contested</a> the characterization of the overlayfs solution; he also
started an extended sub-thread on whether the "<tt>ls&nbsp;-lR</tt>"
benchmark made sense.  He <a
href="/ml/linux-kernel/CAOQ4uxhGX9NVxwsiBMP0q21ZRot6-UA0nGPp1wGNjgmKBjjBBA@mail.gmail.com/">added</a>:
"<q>I see. composefs is really very optimized for ls -lR.  Now only need to
figure out if real users start a container and do ls -lR without reading
many files is a real life use case.</q>"
Dave Chinner <a
href="/ml/linux-kernel/20230125041835.GD937597@dread.disaster.area/">jumped
in</a> to defend this test:
<p>
<blockquote class="bq">
	Cold cache performance dominates the runtime of short lived
	containers as well as high density container hosts being run to
	their container level memory limits. `ls -lR` is just a
	microbenchmark that demonstrates how much better composefs cold
	cache behaviour is than the alternatives being proposed.
</blockquote>
<p>
He added that he has used similar tests to benchmark filesystems for many
years and has never had to justify it to anybody.  Larsson, meanwhile, <a
href="/ml/linux-kernel/b8601c976d6e5d3eccf6ef489da9768ad72f9571.camel@redhat.com/">explained</a>
the emphasis that is being placed on this performance metric (or "key
performance indicator" — KPI) this way:
<p>
<blockquote class="bq">
	My current work is in automotive, which wants to move to a
	containerized workload in the car. The primary KPI is cold boot
	performance, because there are legal requirements for the entire
	system to boot in 2 seconds. It is also quite typical to have
	shortlived containers in cloud workloads, and startup time there is
	very important. In fact, the last few months I've been primarily
	spending on optimizing container startup performance (as can be
	seen in the massive improvements to this in the upcoming podman
	4.4).
</blockquote>
<p>
Goldstein finally <a
href="/ml/linux-kernel/CAOQ4uxiPLHHnr2=XH4gN4bAjizH-=4mbZMe_sx99FKuPo-fDMQ@mail.gmail.com/">accepted</a>
the importance of this metric and suggested that overlayfs could be
changed to provide better cold-cache performance as well.  Larsson <a
href="/ml/linux-kernel/CAL7ro1Hc4npP9DQjzuWXJYPTi9H=arLstAJvsBgVKzd8Cx8_tg@mail.gmail.com/">answered</a>
that, if overlayfs could be modified to address the performance gap, it
might be the better solution; he also <a
href="/ml/linux-kernel/3d4b17795413a696b373553147935bf1560bb8c0.camel@redhat.com/">raised
doubts</a> as to whether the performance gap could really be closed and
whether it made sense to add more complexity to overlayfs.
<p>
The conclusion from this part of the discussion was that some
experimentation with overlayfs made sense to see whether it is a viable
option or not.  Overlayfs maintainer Miklos Szeredi has been mostly absent
from the discussion, but did briefly <a
href="/ml/linux-kernel/CAJfpeguczp-qOWJgsnKqx6CjCJLV49j1BOWs0Yxv93VUsTZ9AQ@mail.gmail.com/">indicate</a>
that some of the proposed changes might make sense.
<p>
<h4>The EROFS option</h4>
<p>
There was another option that came up a number of times in the discussion,
though: enhance the EROFS filesystem to include the functionality provided
by composefs.  This filesystem, which is designed for embedded, read-only
operation, already has fs-verity support.  EROFS developer Gao Xiang has
repeatedly <a
href="/ml/linux-kernel/3ae1205a-b666-3211-e649-ad402c69e724@linux.alibaba.com/">said</a>
that the filesystem could be enhanced to implement the features provided by
composefs; indeed, much of that functionality is already there as part of
the <a
href="https://github.com/dragonflyoss/image-service/blob/master/docs/nydus-design.md">Nydus</a>
mechanism.  Scrivano has <a
href="/ml/linux-kernel/878rhvg8ru.fsf@redhat.com/">questioned</a> this
idea, though:
<p>
<blockquote class="bq">
	Sure composefs is quite simple and you could embed the composefs
	features in EROFS and let EROFS behave as composefs when provided a
	similar manifest file.  But how is that any better than having a
	separate implementation that does just one thing well instead of
	merging different paradigms together?
</blockquote>
<p>
Gao has suggested that the composefs developers will, sooner or later, want
to add support for storing file data (rather than just the manifest
metadata), at which point composefs will start to look more like an ordinary
filesystem.  At such a point, the argument for separating it from other
filesystems would not be so strong.
<p>
A few performance issues in EROFS (for this use case) were identified in
the course of the discussion, and various fixes have been implemented.
Jingbo Xu has run <a
href="/ml/linux-kernel/a526afef-a5ce-ceec-d5b7-1da9fab1a18f@linux.alibaba.com/">a
number of benchmarks</a> to measure the results of patches to both EROFS
and overlayfs, but none yet have shown that either of the other two options
can outperform composefs.  That work is still in an early state, though.
<p>
As might be imagined, this sprawling conversation did not come to any sort
of consensus with regard to whether it makes sense to merge composefs or
to, instead, put development effort into one of the alternatives.  Chances
are that no such conclusion will be reached for the next few months.  This
is just the sort of decision that the upcoming <a
href="https://events.linuxfoundation.org/lsfmm/">LSFMM/BPF summit</a> was
created to resolve; chances are that there will be an interesting
discussion at that venue.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-composefs">Filesystems/composefs</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/922851/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor923527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 16:07 UTC (Thu)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/923527/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; One current shortcoming with overlayfs, Scrivano said, is that, unlike composefs, it is unable to provide fs-verity protection for the filesystem as a whole. Any changes that affect the overlay layer would bypass that protection.</span><br>
<p>
I don't follow this comment - you can very trivially setup a read-only overlayfs (by using multiple lowerdir=, and no upperdir=/workdir=) from multiple read-only volumes, each protected by dm-verity. What changes are there that could bypass this protection? I'm not aware of any.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923536"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 17:20 UTC (Thu)
                               by <b>gscrivano</b> (subscriber, #74830)
                              [<a href="/Articles/923536/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was commenting on using overlayfs alone, even if it gains support to fs verify the file payload referred by metacopy.  As you've pointed out, there is still a need for another read-only file system to protect the image.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923536/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 20:28 UTC (Thu)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/923556/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It depends on what you define as 'protection'. Even if the filesystems are writable, a read-only overlayfs will be, well, read-only (ie: no workdir/upperdir, only a series of lowerdir), so a tenant that only sees the overlay won't be able to modify it.<br>
If you want integrity and authentication on top of that, yes, you need the lower layers to provide that. But even there, with overlayfs + dm-verity the protection is so much stronger: you get cryptographic authentication enforced by the kernel (via roothash signature), which on top of everything else also allows to verify the volume _before_ using it, and without being vulnerable to TOCTOU/symlink chasing shenanigans. As the kernel devs love to remind us every time they can, fs drivers are not hardened against rogue filesystems, so for use cases where security is important, this is kinda fundamental to have these layers of defence in place.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923558"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 20:47 UTC (Thu)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/923558/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  fs drivers are not hardened against rogue filesystems, </span><br>
<p>
Yes, but you have that issue if you have *any* persistent locally mutable mounted Linux filesystems, whether or not they are used as the backing storage for container images.  I think in cases that would be deploying composefs, they'd already be using those anyways for local system state.<br>
<p>
I suspect going forward though what may be viable for these sorts of things is to do a fast "metadata only fsck" on boot - perhaps even from an isolated userspace process written in a memory-safe programming language.<br>
<p>
<span class="QuotedText">&gt; for use cases where security is important,</span><br>
<p>
Security is not a binary thing.  It depends on your threat model, and there's always costs/benefits to different approaches.  Let's please not imply that security isn't important to the people working on this.  It is.  You could instead say e.g. "Is vulnerable to local filesystem corruption attacks", not that it's "not secure".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923558/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923565"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 22:17 UTC (Thu)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/923565/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Yes, but you have that issue if you have *any* persistent locally mutable mounted Linux filesystems, whether or not they are used as the backing storage for container images. I think in cases that would be deploying composefs, they'd already be using those anyways for local system state.</span><br>
I suspect going forward though what may be viable for these sorts of things is to do a fast "metadata only fsck" on boot - perhaps even from an isolated userspace process written in a memory-safe programming language.<br>
<p>
Yes indeed, verification needs to extend to all volumes. On an immutable OS it's important that the root/usr partition is also dm-verity verified for the same reason. And writable storage should get the luks + attestation treatment. The only real gap we have is the ESP, because it needs to be readable by firmware - the hope there is that fat32 is so simple as a filesystem, that it's difficult to use such an attack vector.<br>
<p>
<span class="QuotedText">&gt; Security is not a binary thing. It depends on your threat model, and there's always costs/benefits to different approaches. Let's please not imply that security isn't important to the people working on this. It is. You could instead say e.g. "Is vulnerable to local filesystem corruption attacks", not that it's "not secure".</span><br>
<p>
Where did I say that it's not secure? As you correctly wrote, security is not binary, it's a spectrum. What I said is that the overlay + dm-verity model has stronger guarantees, ie, it sits further on that spectrum than what is being described in the article, and I've explained why I think so - which does not mean what the article describes is 'not secure' tout court.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923565/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923568"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 22:52 UTC (Thu)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/923568/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; And writable storage should get the luks + attestation treatment.</span><br>
<p>
The threat model I think many are concerned with (and definitely is in the composefs threat model AFAIK) is specifically "anti-persistence".  Assuming an attacker gets root on the node with e.g. a chain from web browser flaw to kernel flaw, can they persist across a reboot by mutating persistent state that will be read on the next boot?<br>
<p>
The <a href="https://chromium.googlesource.com/chromiumos/docs/+/master/security/noexec_shell_scripts.md#but-what-about-xxx_edge-case">https://chromium.googlesource.com/chromiumos/docs/+/maste...</a> gives one example.<br>
<p>
LUKS doesn't prevent code that has gained kernel mode execution from directly mutating the block device in such a way that the ext4/xfs/btrfs/whatever filesystem would get confused on the next boot and perform a double free or whatever and get chained into regaining kernel mode memory execution.   I'm not sure which type of attestation you're referring to but I don't think it will either.<br>
<p>
The other main threat is "evil maid" attacks (I really dislike that term but like "pets versus cattle" it's gained too much industry prominence to ignore) - i.e. the local attacker gaining access to the disk or physical console cases?  I believe this is covered too.<br>
<p>
What I'm saying in short is that I think composefs on a single persistent Linux filesystem provides the same protection that a system using a hybrid of dm-verity for OS state and a distinct persistent volume would.  (Applying the same chosen LUKS/dm-integrity/etc stack to the persistent volume(s))<br>
<p>
<span class="QuotedText">&gt; Where did I say that it's not secure? </span><br>
<p>
You didn't, but I think an objective observer would certainly feel it was reasonable to conclude you were strongly implying it by saying "so for use cases where security is important".<br>
<p>
Overall, I do enjoy talking with you in these LWN comment threads periodically, but it seems to me we have been getting a bit repetitive and I'm sure some readers feel the same way.  There's definitely been some email threads on e.g. fedora-devel@ where I could see the Subject: line and just from the names of the people replying I knew *exactly* what they were going to say (and was right 70% of the time).  Let's aim to not be those people ;)<br>
<p>
<span class="QuotedText">&gt; What I said is that the overlay + dm-verity model has stronger guarantees</span><br>
<p>
Yes, but I'm again saying that's moot if you have other persistent volumes that aren't dm-verity.  That's the specific claim, so let's try to really narrow in on this specifically - I admit I could be wrong, there is a lot of nuance and subtlety in all of this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923568/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923654"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2023 19:46 UTC (Fri)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/923654/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; What I'm saying in short is that I think composefs on a single persistent Linux filesystem provides the same protection that a system using a hybrid of dm-verity for OS state and a distinct persistent volume would. (Applying the same chosen LUKS/dm-integrity/etc stack to the persistent volume(s))</span><br>
<p>
It is absolutely true that if you can modify a local disk's filesystem superblock then you can in theory backdoor your way in. But that assumes you already have root privileges and arbitrary code execution on that system - ie, you need a separate, pre-existing attack vector. What I am pointing out is that images downloaded from the network and opened (like for containers) can be said attack vectors, when they are not accompanied with a signature that is checked by the kernel before opening them.<br>
<p>
The local persistent volume for local state is created from a known-good state (ie, by the trusted kernel/userspace on firstboot or provision), so the threat model is slightly different. That is not to say it's not a risk - it absolutely is, and any mitigations for that scenario are great. But it's a separate scenario.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923654/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923658"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2023 22:06 UTC (Fri)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/923658/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; What I am pointing out is that images downloaded from the network and opened (like for containers) can be said attack vectors, when they are not accompanied with a signature that is checked by the kernel before opening them.</span><br>
<p>
Hmm.  Re-reading the threads, sorry - I think it may have been me that took the conversation off in the wrong direction.  The overall article was about composefs, then you replied to a comment from giuseppe which was actually about the "overlayfs+erofs instead of composefs", and I sort of misread the comments as being about composefs.<br>
<p>
I honestly haven't dug completely into the overlayfs+erofs suggestion; it strikes me as a bit hacky but I also do see Amir's point about maintenance long term.  For composefs the semantics around verifying the image seem to me to be much clearer, and that's what I thought we were debating - sorry!<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923658/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor923563"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 22:04 UTC (Thu)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/923563/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; without being vulnerable to TOCTOU/symlink chasing shenanigans.</span><br>
<p>
Can you elaborate on this?  Where would be the check versus use here?  <br>
<p>
If you're talking about offline code swapping or creating a symlink for the underlying content files, composefs is going to detect that because it compares the expected fsverity digest with the one it found when opening the file, before returning to userspace.<br>
<p>
Looking at code and thinking about symlinks, perhaps <a href="https://github.com/containers/composefs/blob/18a6301a40aa8e14f35e8ef12a92dc37f61b306a/kernel/cfs.c#L500">https://github.com/containers/composefs/blob/18a6301a40aa...</a> should be passing O_NOFOLLOW, but per above I don't think that matters much.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923563/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923567"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 22:24 UTC (Thu)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/923567/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am specifically referring to signature checks. There is a school of thought (not related to the composefs work, recently I had to object to a proposal to remove/deprecate kernel signature support for fs-verity) that says it's enough to verify a verity roothash signature in userspace, and then later pass the verity object to the kernel for opening and using. To me this seems like a textbook case of toctou waiting to happen...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923567/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor923554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2023 19:10 UTC (Thu)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/923554/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Regardless of the outcome, I'm pleased to see attention to container start up times. I have a significant workload that uses 20GIB OCI images. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2023 12:14 UTC (Fri)
                               by <b>benlongo</b> (guest, #132381)
                              [<a href="/Articles/923605/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I’m curious what comprises that 20G - is it data or all binaries?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923702"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2023 21:58 UTC (Sat)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/923702/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is some test data but it is mostly internally built conda packages. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923702/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor923871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2023 13:29 UTC (Tue)
                               by <b>amarao</b> (subscriber, #87073)
                              [<a href="/Articles/923871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If someone makes containers starting 10 times faster,  someone will definitively find idea of running whole zoo of images at once attractive, and we will have 200Gb of images with the same start time constrains as now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor923585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2023 2:37 UTC (Fri)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/923585/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; This filesystem, which is designed for embedded, read-only operation, already has fs-verity support.</span><br>
<p>
Some little correction:<br>
"Currently, EROFS doesn't have a self-contained fs-verity like other local filesystems, but we'd like to support it later with some further discussion (like we'd like to provide a choise to verify bdev inodes or likewise rather than a regular inode).  since it could make merkle-tree built-in (Alexander Larsson have pointed out they also may dislike DM distribution) and shipped together with block/non-block-device (like pmem or file-based, or later mtd-based) cases.<br>
<p>
EROFS is not only designed for embedded use cases in the beginning and we've always landed EROFS+fsdax for secure containers (kata-containers) and EROFS+fscache for runC containers.  Nydus is just one of a current user-space example for such container use cases, but EROFS filesystem can also be used without Nydus as well."<br>
<p>
I really would like that (one day) in-kernel iomap infrastructure finally would support block-based, file-based distribution, and finally it could have a friendly connection with fscache + cachefiles to support in-kernel caching in addition to netfs. That makes the whole things less fragmented (many users don't like loopback devices for whatever reasons) and simplify the current EROFS fscache implementation a lot.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923652"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 17, 2023 19:22 UTC (Fri)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/923652/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is in-memory deduplication on your road map? E.g., imagine two processes running from two different EROFS images, that happen to both contain the exact same libc6. It would be really nice if only one copy of said libc6 was held in memory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923652/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor923663"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debating composefs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 18, 2023 0:58 UTC (Sat)
                               by <b>hsiangkao</b> (guest, #123981)
                              [<a href="/Articles/923663/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, we’ve already sent several versions of this feature,<br>
<a href="https://lore.kernel.org/linux-fsdevel/20230203030143.73105-1-jefflexu@linux.alibaba.com/">https://lore.kernel.org/linux-fsdevel/20230203030143.7310...</a><br>
<p>
Due to lunar new year vacation, I don’t have enough slot to review it. We have to delay it for the next merge window.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/923663/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2023, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
