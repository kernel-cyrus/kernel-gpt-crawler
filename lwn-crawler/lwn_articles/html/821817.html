        <!DOCTYPE html>
        <html lang="en">
        <head><title>Free user space for non-graphics drivers [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/821817/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/821683/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/821817/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Free user space for non-graphics drivers</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>June 3, 2020</br>
           </div>
<p>
In the kernel graphics world, there has been a longstanding "<a
href="/Articles/394702/">line in the sand</a>" that disallows merging
kernel drivers without a corresponding free-software user-space driver.  The idea is that
not having a way to test  the full functionality means that the kernel
developers cannot verify the proper functioning and security of the
driver; changes to the kernel driver may lead to unforeseen (and
untestable) problems on the user-space side.   More recently, though, we
have seen other types of devices with complex drivers, but no useful free
user-space piece, that have been proposed for inclusion into the kernel;
at least one was merged, but the tide has perhaps turned against those types
of drivers at this point—or some of them, anyway.
</p>

<p>
In mid-May, Jeffrey Hugo <a
href="/ml/linux-kernel/1589465266-20056-1-git-send-email-jhugo@codeaurora.org/">posted</a>
an RFC patch for the "Qualcomm Cloud AI 100" device, which is a PCIe card
with an application-specific integrated circuit (ASIC) that targets "deep
learning" workloads.  The device is also referred to as a QAIC device; it presents a <a
href="https://www.kernel.org/doc/html/latest/mhi/mhi.html">modem host
interface</a> (MHI) control path and a DMA engine for the data path.  These
are exposed in the driver as a Linux character device with
<tt>ioctl()</tt> commands to access the data path.
</p>

<p>
Dave Airlie, who drew the line in the sand back in 2010, <a
href="/ml/linux-kernel/CAPM=9txXskVu_yD3DNuR0HgSUsE2v1Pv98dm=AHGvv_z2XKTAQ@mail.gmail.com/">wondered</a>
how the QAIC driver was really any different.  It has a user-facing API
(which he calls the "uapi") with no open-source users and no tests for it.
<div class="BigQuote">
Although this isn't a graphics driver, and Greg [Kroah-Hartman] will likely merge
anything to the kernel you throw at him, I do wonder how to validate
the uapi from a security perspective. It's always interesting when
someone wraps a DMA engine with user ioctls, and without enough
information to decide if the DMA engine is secure against userspace
misprogramming it.
</div>
</p>

<p>
Hugo <a
href="/ml/linux-kernel/93238096-5861-c140-b94f-6137977c3d65@codeaurora.org/">said</a>
that he would like to put one of the devices "<q>into the hands of Linaro, so that
it can be put into KernelCI</q>".  In order to do that, he needs to get
permission from others at Qualcomm.  Beyond that, though, it will be
difficult to get anything particularly useful on the user-space side:
<div class="BigQuote">
Regarding what the community could do on its own, everything but the Linux
driver is considered proprietary - that includes the on device firmware and
the entire userspace stack.  This is a decision above my pay grade.
<p>
I've asked for authorization to develop and publish a simple userspace
application that might enable the community to do such testing, but
obtaining that authorization has been slow.
</div>
</p>

<p>
Perhaps to Airlie's surprise, though, Kroah-Hartman <a
href="/ml/linux-kernel/20200519174120.GC1158284@kroah.com/">said</a> that
he would not review the driver any further without that kind of information
(and code); furthermore, he would not merge it and he would actively
oppose anyone else merging it, as well.
<div class="BigQuote">
Ok, that's a decision you are going to have to push upward on, as we
really can't take this without a working, open, userspace.
<p>
Especially given the copyright owner of this code, that would be just
crazy and foolish to not have open userspace code as well.  Firmware
would also be wonderful as well, go poke your lawyers about derivative
work issues and the like for fun conversations :)
</div>
</p>

<p>
Hugo <a
href="/ml/linux-kernel/ce0e69ef-116c-df95-c136-d4714e02e96e@codeaurora.org/">said</a>
that he would try, but did not seem to have a lot of hope that he would be
able to deliver what the kernel developers are looking for.  On the other
hand, Daniel Vetter <a
href="/ml/linux-kernel/CAKMK7uG-oP-tcOcNz-ZzTmGondEo-17BCN1kpFBPwb7F8QcM5w@mail.gmail.com/">was
surprised</a> by Kroah-Hartman's position:
<div class="BigQuote">
So the merge criteria for drivers/accel (atm still drivers/misc but I
thought that was interim until more drivers showed up) isn't actually
"totally-not-a-gpu accel driver without open source userspace".
<p>
Instead it's "totally-not-a-gpu accel driver without open source
userspace" _and_ you have to be best buddies with Greg. Or at least
not be on the naughty company list. Since for habanalabs all you
wanted is a few test cases to exercise the ioctls. Not the entire
userspace.
</div>
</p>

<p>
Vetter is referring to the <a
href="/ml/linux-kernel/20190123000057.31477-1-oded.gabbay@gmail.com/">Habana
Labs kernel driver</a> that was merged over his, Airlie's, and others' objections.
The problems that were pointed out at the time are much the same as those
raised for the QAIC driver, but it would seem the outcome is going to be
different this time.  Kroah-Hartman <a
href="/ml/linux-kernel/20200520045900.GA2105777@kroah.com/">said</a> that
he was particularly concerned with "<q>the copyright owner of this
code</q>", which must be referring to Qualcomm.  The code is actually
copyrighted by the Linux Foundation (Kroah-Hartman's employer) and comes
from the <a href="https://www.codeaurora.org/">Code Aurora Forum</a>, which
is a Linux Foundation collaborative project; the Qualcomm Innovation Center
(QuIC) is a principal member of that organization.
</p>

<p>
He noted that Habana Labs has released its library code as open source
since the merge, so that situation has resolved.
But he did <a
href="/ml/linux-kernel/20200520051536.GA2141566@kroah.com/">admit</a> that
he was wrong about these types of
drivers:
<div class="BigQuote">
Also, to be fair, I have changed my mind after seeing the mess of
complexity that these "ioctls for everyone!" type of pass-through
these kinds of drivers are creating.  You were right, we need open
userspace code in order to be able to properly evaluate and figure out
what they are doing is right or not and be able to maintain things over
time correctly.
<p>
So I was wrong, and you were right, my apologies for my previous
stubbornness.
</div>
</p>

<p>
The recent submission of a <a href="https://en.wikipedia.org/wiki/DirectX">DirectX
driver</a> from Microsoft is in a similar position.  Sasha Levin <a
href="/ml/linux-kernel/20200519163234.226513-1-sashal@kernel.org/">posted</a>
an RFC patch on May&nbsp;19:
<div class="BigQuote">
The
driver exposes a paravirtualized GPU to user mode applications running
in a virtual machine on a Windows host. This enables hardware
acceleration in environment such as WSL (Windows Subsystem for Linux)
where the Linux virtual machine is able to share the GPU with the
Windows host.
</div>
</p>

<p>
The use case, at least for now, is not about graphics at all; it is meant
to provide a means for a Linux guest on a Windows system to access the GPU
for compute purposes.  But the <a
href="https://devblogs.microsoft.com/directx/directx-heart-linux/">blog
post</a> announcing the feature seems to indicate that graphics support is
at least on the horizon.  Vetter <a
href="/ml/linux-kernel/CAKMK7uGnSDHdZha-=dZN5ns0sJ2CEnK2693uix4tzqyZb9MXCQ@mail.gmail.com/">said</a>
that, as <a
href="https://dri.freedesktop.org/docs/drm/gpu/drm-uapi.html#open-source-userspace-requirements">documented</a>,
a graphics driver needs a free user-space before it can go upstream, but
that does not seem to be what is happening here:
<div class="BigQuote">
 From the blog it sounds like the userspace is all closed. That
includes the hw specific part and compiler chunks, all stuff we've
generally expected to be able to look [at] in the past for any kind of
other driver.
</div>
</p>

<p>
He suggested that since the driver is not targeting graphics it could move
elsewhere in the tree (such as <tt>drivers/hyperv</tt>).  Airlie <a
href="/ml/linux-kernel/CAPM=9txZpiCGkv3jiBC1F8pTe4A2pqWpQDyjRBXk2roFqw+0+Q@mail.gmail.com/">thought</a>
similarly:
<div class="BigQuote">
This is a driver that connects a binary blob interface in the Windows
kernel drivers to a binary blob that you run inside a Linux guest.
It's a binary transport between two binary pieces. Personally this
holds little of interest to me, I can see why it might be nice to have
this upstream, but I don't [foresee] any other Linux distributor ever
enabling it or having to ship it, it's purely a WSL2 pipe. I'm not
saying I'd be happy to see this in the tree, since I don't see the
value of maintaining it upstream, but it probably should just [exist]
in a drivers/hyperv type area.
</div>
</p>

<p>
He is concerned, though, that merging it in a Hyper-V-specific part of the
tree may lead to trouble down the road if graphics functionality gets added
to the driver.  But Microsoft's  Steve Pronovost <a
href="/ml/linux-kernel/MWHPR21MB0287145CD511A2FF6DA502A9C7B60@MWHPR21MB0287.namprd21.prod.outlook.com/">said</a>
that, while graphics support may be in the future, the driver being
proposed would not be used; it is strictly meant for the GPU-compute case.
There is work going on to support Linux GUI applications on WSL, but that
would be done using the <a
href="https://en.wikipedia.org/wiki/Remote_Desktop_Protocol">Remote Desktop
Protocol</a> (RDP) and a Wayland compositor; that work would be fully open
source, he said.
</p>

<p>
Levin <a href="/ml/linux-kernel/20200519203608.GG33628@sasha-vm/">noted</a>
that he would personally prefer that the user-space pieces needed for the
proposed driver were
available as open source "<q>and wish I could do something about
it</q>".  He is amenable to moving the driver outside of the graphics
tree, which would seem to be the path forward.  He also pointed out that
the RFC "<q>is not a case of 'we want it upstream NOW' but rather
'let's work together to figure out how to do it right' :)</q>".  
</p>

<p>
It would seem, then, that the QAIC driver is going to languish, while the
Microsoft driver may be able to find its way into the mainline, even though
neither has any significant free user-space code that can be used to test
it.  In part, that may be due to the difficult relationship Qualcomm has
had with the kernel development community over the years.  Beyond that, the
QAIC device seems to be a 
more complicated beast, with more ways that things can go wrong—invisibly.
But the Microsoft driver has not been merged yet; we will have to wait to
see whether its lack of a free user space holds it back—or not.
</p>

<p>
These are undoubtedly not the last drivers of this sort we will see. There
is a trend toward devices that are programmable from user space and the
kernel is simply used as a conduit to carry proprietary code and data
between user space and the device; only the device maker has any real view
into what is actually happening inside it.  There is clearly an advantage
for device makers to get their drivers into the mainline, but is there any
real gain for the community by doing so?
As Airlie said about the DirectX driver: "<q>[...] I don't see
the value this adds to the Linux ecosystem at all, and I think it's
important when putting a burden on upstream that you provide some
value.</q>"
</p>

<p>
Users who have these devices may
benefit from finding the driver in their distribution kernel, and the
device makers get "free maintenance" by the kernel developers, but the
community is left with a pile of code that is not particularly useful—and
could be fragile in ways that could cause problems in the future.  It does
not really sound like the usual free-software bargain.  Luckily, the kernel
developers provide a highly functioning platform that the device makers can
use to sell and run their devices; they may just have to maintain and
distribute their own drivers in order to do so.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-User-space_ABI">Development model/User-space ABI</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Device_drivers-Accelerators">Device drivers/Accelerators</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/821817/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor822180"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2020 21:05 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/822180/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hope these drivers at least expose enough information to know exactly which userspace memory is read or written by each ioctl (and in between ioctls as well). That information is essential for fuzzing, and also for rr.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822180/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822184"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2020 21:44 UTC (Wed)
                               by <b>blackwood</b> (guest, #44174)
                              [<a href="/Articles/822184/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not even close, which is the entire problem. These compute/gpu things run touring complete code with hw security features you have to take on faith, and between the ioctl stuff and the actual things you run there's generally a few layers of abstraction. E.g. on most gpus you just tell the kernel to run a buffer, which contains a cmdlist, which contains state packets, which contains pointers to more stuff, most of these containing the data, but some of it also containing the actual shaders/kernels you run on the gpu/compute hw. And this entire hairball is directly execute by hw.<br>
<p>
Reverse-engineering this with humans and specialized fuzzing/discover tools takes a few years. Forget doing any kind of security audit without that work being done, or having proper access to both the runtime and all the compilers in userspace. Ideally also hw specs.<br>
<p>
And all the kernel&lt;-&gt;userspace uapi is entirely custom to the hw, and the most leaky abstraction you can think of. Stuff like which automatic clock gating bits the kernel sets impacts which instruction scheduling workarounds the compiler needs to apply to prevent the entire thing from keeling over and crashing the compute workloads userspace submits.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822184/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822187"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2020 21:49 UTC (Wed)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/822187/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Too bad. I guess that means when one of these drivers is accessible you may as well assume complete kernel compromise.<br>
<p>
Being able to bound the user-space-visible effects of each system call seems like a good place to draw a line in the sand.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822187/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822188"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2020 22:08 UTC (Wed)
                               by <b>blackwood</b> (guest, #44174)
                              [<a href="/Articles/822188/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well this is why drivers/gpu requires fully open stack in the userspace side of things. Allows us to review the entire thing, figure out whether the security model has a reasonable chance of working. Backstop it with kernel-side validation if necessary, which has huge uapi impact since you can't validate Turing complete stuff, so you need to figure out a way to limit the Turing completeness to where it doesn't matter for security, without impacting the functionality exposed to userspace in a way that users care about.<br>
<p>
Plus when (this isn't an if in a post smeltdown world) the hw security features turn out to be more leaky than presumed, we have a fighting chance to fix up the mess going forward.<br>
<p>
But without all that it's indeed hopeless, and you might as well assume your kernel is compromised.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822188/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2020 15:48 UTC (Thu)
                               by <b>nivedita76</b> (guest, #121790)
                              [<a href="/Articles/822247/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not really close to this stuff, but I don't see how even getting open-source userspace is really enough for security. That tells you if the vendor-provided user-space library can be compromised, but you really need to get specifications for what the hardware is capable of doing, not just what the vendor-provided userspace uses it for, since a real attacker could do something completely different with the provided ioctl's.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2020 21:26 UTC (Thu)
                               by <b>blackwood</b> (guest, #44174)
                              [<a href="/Articles/822270/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even the hw spec doesn't give you security, the hw might not live up to it, see smeltdown.<br>
<p>
What an open stack allows you is to fix up the mess once you are aware of a security hole. Worst case you might end up with something like CONFIG_ENABLE_ROOTHOLES to not break existing uapi if the old one is unfixable. But going forward you can change both kernel and userspace driver parts to come up with something to work around the security holes. But often the breakage is really minor (like more gpu hangs in some corner case), so good enough if you just ship bugfixes on both sides. If one part is an opaque blob you can't really reason about, much less change, then that's all impossible. And vendors abandon their closed source stacks real fast, better if they sell you new hw with new drivers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor822393"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2020 8:26 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/822393/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; These compute/gpu things run touring complete code with hw security features you have to take on faith, ...</font><br>
<p>
So this is basically Asymetric Multi Processing (CPU and [GP]GPU) with one side running open-source (Linux) and the other side running random closed source code with little or no security boundary between the two processors. Correct?<br>
<p>
To be honest I'm not sure how that compares from a security perspective to loading a dozen /lib/firmwares without even a debug statement in the firmware loader showing every file loaded. Which is worse? There are has been for a long time more than two processors running closed source in any modern [D]SoC; how much isolation between them? Can the kernel even tell?<br>
<p>
[D] Distributed<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822393/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822404"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2020 21:49 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/822404/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; loading a dozen /lib/firmwares without even a debug statement in the firmware loader showing every file loaded.</font><br>
<p>
Of course /lib/firmware doesn't include a number of other closed-source bits loaded even before the kernel (generally because they play a role in... booting the kernel).<br>
<p>
<a href="https://www.ptsecurity.com/ww-en/analytics/disabling-intel-me-11-via-undocumented-mode/">https://www.ptsecurity.com/ww-en/analytics/disabling-inte...</a><br>
<p>
Now the security of these is different because they can't be  unsigned code, unlike most stuff in /lib/firmware I guess or the GPU/AI workloads mentioned above. But they're not open-source either.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822404/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor822406"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2020 22:11 UTC (Sun)
                               by <b>mfuzzey</b> (subscriber, #57966)
                              [<a href="/Articles/822406/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;I'm not sure how that compares from a security perspective to loading a dozen /lib/firmwares</font><br>
<p>
That depends what is done with the stuff loaded from lib/firmware.<br>
<p>
Normally it will be loaded onto some other device so the risk depends on the level of hardware access that device has to memory and the degree to which Linux can restrict it (by an IOMMU for example).<br>
<p>
So for example firmware loaded into an I2C connected touchscreen controller is unlikely to be able to do much harm since that bus provides no DMA capacity, worst case it could simulate clicks to enter false data (assuming it knows what is on the screen).<br>
<p>
On the other hand firmare for hardware with bus mastering DMA capabilities not restricted by an IOMMU basically has full system access.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822406/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 19:05 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/822519/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Normally it will be loaded onto some other device so the risk depends on the level of hardware access that device has to memory and the degree to which Linux can restrict it (by an IOMMU for example).</font><br>
<p>
IOMMU is apparently hit-and-miss: <a href="https://lwn.net/Articles/782381/">https://lwn.net/Articles/782381/</a><br>
<p>
<font class="QuotedText">&gt; On the other hand firmare for hardware with bus mastering DMA capabilities not restricted by an IOMMU basically has full system access.</font><br>
<p>
Thanks, so let's stop pretending the kernel cares about attack vectors from co-processors when it doesn't even log the filenames loaded from /lib/firmware/ by default [*]<br>
<p>
These attack vectors and pseudo-security concerns being out of the picture, that leaves only the maintenance (troubleshooting and refactoring) questions. I suspect the kernel &lt;-&gt; GPU interfaces are generally much more complex than the interfaces between the kernel and stuff in /lib/firmware, hence the reluctance. Is <br>
that higher GPU complexity why there is a "line in the sand" somewhere in the middle, do I get that right? Or because /lib/firmware has been causing fewer maintenance headaches in the past? Or both.<br>
<p>
<p>
[*] As the distributed system bootloader that it is, in an ideal world request_firmware() should check signatures. I digress.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822520"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 19:43 UTC (Mon)
                               by <b>mfuzzey</b> (subscriber, #57966)
                              [<a href="/Articles/822520/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I suspect the kernel &lt;-&gt; GPU interfaces are generally much more complex than the interfaces between the kernel and stuff in /lib/firmware, hence the reluctance.</font><br>
<p>
I think it's also a question of exposure of the interface to an attacker.<br>
<p>
On the general /lib/firmware side the issue is more potentially malicious firmware. <br>
<p>
Unpriveleged users can't (or shouldn't) be able to change the firmware files. Most of the time the firmware won't be receiving commands directly from userspace without the kernel sanitizing them first. In fact normally the uapi will be something standard on Linux for that subsystem and the commands sent to the firmware will be completely determined by the kernel driver.<br>
<p>
On the GPU side though it's a bit different as unpriveleged applications can submit commands to the GPU via /dev/dri (otherwise stuff like games wouldn't work). The kernel is mostly a pipe. So a malicious actor who has knowledge of a GPU exploit could submit crafted buffers to compromise the system.<br>
<p>
The kernel can't assume that userspace is Mesa or something trusted.<br>
<p>
But the existence of an open source userspace, even if it is bypassed by an attacker, means that the knowledge is available for the kernel to sanitize the commands. Up to a point at least because there could still exist undiscovered holes. But it's way better than an open source kernel driver accepting opaque command buffers with no idea what they do or the security implications.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822520/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor822426"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 2:32 UTC (Mon)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/822426/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is anyone working on reverse engineering /lib/firmware? There is precious little open firmware out there and it is mainly for increasingly obsolete hardware.<br>
<p>
<a href="https://wiki.debian.org/Firmware/Open">https://wiki.debian.org/Firmware/Open</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822426/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822439"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 12:40 UTC (Mon)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/822439/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As a general response, nobody is working on reverse-engineering the stuff in /lib/firmware, but there are some folks working on specific devices with varying degrees of success.<br>
<p>
The thing is, each device has to be independently reverse-engineered, a process so involved that by the time the effort yields something usable, the device will have been obsolete for a decade.<br>
<p>
(At least these days the embedded CPUs are usually an ARM variant, or some other licensed/documented core...)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822439/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 12:42 UTC (Mon)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/822440/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do you have some examples of the projects you mentioned?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822450"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 14:26 UTC (Mon)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/822450/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Offhand I can only think of three that saw success:<br>
<p>
 * Broadcom wifi f(openfwwf)<br>
 * Cypress FX/FX2 (fx2lib)<br>
 * EMU10K1 (Sound Blaster Live/Audigy)<br>
<p>
But there are others out there in varying stages of functionality.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822450/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822537"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2020 2:09 UTC (Tue)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/822537/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
openfwwf was already on the wiki, along with Prism54 FreeMAC, and the carl9170fw and open-ath9k-htc-firmware projects released by Atheros.<br>
<p>
<a href="http://netweb.ing.unibs.it/~openfwwf/">http://netweb.ing.unibs.it/~openfwwf/</a><br>
<a href="https://perso.m-labs.hk/sb/prism54/freemac.html">https://perso.m-labs.hk/sb/prism54/freemac.html</a><br>
<a href="https://perso.m-labs.hk/sb/prism54/snapshots/prism54_freemac.tar.gz">https://perso.m-labs.hk/sb/prism54/snapshots/prism54_free...</a><br>
<a href="https://github.com/qca/open-ath9k-htc-firmware">https://github.com/qca/open-ath9k-htc-firmware</a><br>
<a href="https://github.com/chunkeey/carl9170fw">https://github.com/chunkeey/carl9170fw</a><br>
<p>
I added fx2lib (and sigrok fx2lafw) to the wiki.<br>
<p>
<a href="https://github.com/djmuhlestein/fx2lib/">https://github.com/djmuhlestein/fx2lib/</a><br>
<a href="https://sigrok.org/wiki/Fx2lafw">https://sigrok.org/wiki/Fx2lafw</a><br>
<p>
I wasn't able to find anything about the EMU10K1 work you mentioned, only about the GPLed but sourceless blobs (sigh) in the alsa-firmware git repository:<br>
<p>
<a href="https://github.com/alsa-project/alsa-firmware/tree/master/emu">https://github.com/alsa-project/alsa-firmware/tree/master...</a><br>
<p>
If you have any links to the EMU10K1 work or the others, that would be welcome.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822537/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822539"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2020 2:40 UTC (Tue)
                               by <b>pizza</b> (subscriber, #46)
                              [<a href="/Articles/822539/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; <a href="https://perso.m-labs.hk/sb/prism54/freemac.html">https://perso.m-labs.hk/sb/prism54/freemac.html</a></font><br>
<p>
I'm not sure this really belongs on the list, as they don't know how to control anything beyond the basic ARM9 core and other off-the-shelf peripherals (eg PCI and USB cores).  Hardware timers and the radio itself are complete unknowns, So while technically there is "open firmware" it's good for little more than blinking LEDs.<br>
<p>
(In a former life, I had access to the firmware source code and low-level hardware documentation for the entire p54 "Arm MAC" family..)<br>
<p>
<font class="QuotedText">&gt; I wasn't able to find anything about the EMU10K1 work you mentioned, only about the GPLed but sourceless blobs (sigh) in the alsa-firmware git repository</font><br>
<p>
That firmware appears to be FPGA bitstreams for certain pro-grade E-MU hardware, and isn't needed for the prosumer SBLive/Audigy cards built on the EMU10K1/10K2 chips.<br>
<p>
(IIRC, if you plug in a SBLIve/Audigy card, it does not rely on any external firmware, though the driver uploads little DSP snippets to implement driver-exposed functionality such as multichannel mixing and other such things.  Those DSP programs were written using the 'as10k1' assembler, users could upload arbitrary programs if they so chose..)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822539/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2020 3:18 UTC (Tue)
                               by <b>pabs</b> (subscriber, #43278)
                              [<a href="/Articles/822540/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hmm, I can't find anything that uses as10k1. It seems instead the linux.git sound/pci/emu10k1/emufx.c driver has a couple of functions called by the OP/A_OP defines that use instruction set defines in the include/uapi/sound/emu10k1.h header.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor822182"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2020 21:28 UTC (Wed)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/822182/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems like Qualcomm ought to release open source user space code that programs the DMA engine and does some useless example computation. That wouldn't let people do deep learning techniques without using Qualcomm's proprietary code, but would let people verify that the driver and device are harmless.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822182/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822223"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2020 13:44 UTC (Thu)
                               by <b>brigdh</b> (subscriber, #137272)
                              [<a href="/Articles/822223/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I proposed that, and was rejected.  GregKH wants the actual library we use.  I'm running it up the chain to figure out what we can do, but I expect it to take time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822223/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 9, 2020 20:22 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/822607/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Has such dummy user space code already been released? I guess it could still be useful for people using kernel code not merged by Greg KH. I heard rumours that not everyone uses "pure upstream" kernel code all the time (unbelievable, I know)<br>
<p>
Maybe that limited but non-zero experience could even provide some useful lessons for all parties involved, who knows.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor822207"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2020 10:22 UTC (Thu)
                               by <b>daniels</b> (subscriber, #16193)
                              [<a href="/Articles/822207/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The Microsoft /dev/dxg interface is not really a 'DirectX driver' in the way that most people would interpret it. It is a direct port of their Windows DirectX kernel interfaces, but in analogue to Linux, this is DRM rather than OpenGL/Vulkan. Those interfaces allow you to allocate GPU hardware buffers (as in DRM), submit pre-compiled hardware bytecode shaders for execution (as in DRM), and synchronise against that execution (also as in DRM).<br>
<p>
It doesn't stream DirectX client API commands over the device boundary (as VirGL does for GL/GLES). WSL2 will use a proprietary libdirectx.so, and accompanying hardware-vendor drivers, to implement the DirectX graphics API, translate that into hardware-specific commands, and then submit those commands to the kernel interface.<br>
<p>
Pushing the comparison further, it would be entirely possible to port any of the Mesa hardware drivers - say Intel's ANV or AMD's RADV Vulkan drivers, or any of the Gallium OpenGL/GLES drivers - to run on top of /dev/dxg instead of on top of DRM kernel support.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822207/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor822255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 4, 2020 17:41 UTC (Thu)
                               by <b>kpfleming</b> (subscriber, #23250)
                              [<a href="/Articles/822255/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Since nothing else in tree interacts with this driver, and that situation seems unlikely to change in the foreseeable future, requiring users to obtain the driver separately and install it using DKMS seems completely reasonable to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2020 18:51 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/822380/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Couldn't you create a subdirectory for "vendorpipedrivers", and it's made abundantly clear that anything in that directory is (a) the vendor's problem, and (b) will not be enabled by default.<br>
<p>
Hopefully stuff will be upgraded as kernels change around it, but it can be freely redistributable GPL code, just not the kernel dev's problem - it's down to users and vendors.<br>
<p>
Or could that be setting a dangerous precedent ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822382"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 6, 2020 19:47 UTC (Sat)
                               by <b>jiiksteri</b> (subscriber, #75247)
                              [<a href="/Articles/822382/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Couldn't you create a subdirectory for "vendorpipedrivers", and it's made abundantly clear that anything in that directory is (a) the vendor's problem, and (b) will not be enabled by default.</font><br>
<p>
People will ignore such abundant clarity and enable it anyway. And if _anything_ breaks they will report the breakage to their distribution / upstream, only to be asked to reproduce the problem without the offending driver. Which they can't, and since nobody apart from the vendor can debug the problem, time is wasted and nobody's better off after the exercise.<br>
<p>
Isn't this what already happens / happened with the binary nvidia drivers and those weren't even shipped with the kernel :)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822382/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor822280"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2020 4:54 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/822280/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just can't see a use case for a proprietary DirectX API inside a Linux VM running on a Windows 10 box. We already have Vulkan, OpenGL 4.6, OpenCL, CUDA, and an *open* D3D stack in Mesa and Wine that regularly outperforms the one microserfs play with their toys on.<br>
<p>
Why would anyone waste the effort to write apps for a frankensteined-together mishmash of OSes that exists at the sole whim of a company infamous for its architectural ADHD? This'll be quietly left to bitrot in 3 years and all five downstream users will end up with a hard dep on Ubuntu 20.04 long after it's out of support.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822280/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2020 6:37 UTC (Fri)
                               by <b>tzafrir</b> (subscriber, #11501)
                              [<a href="/Articles/822283/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because Microsoft DRM would be even more confusing. See comment above: <a href="https://lwn.net/Articles/822207/">https://lwn.net/Articles/822207/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822287"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2020 7:28 UTC (Fri)
                               by <b>mfuzzey</b> (subscriber, #57966)
                              [<a href="/Articles/822287/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure but in that case why implement /dev/drx at all?<br>
<p>
Microsoft could, if the aim were GPU support in Linux guests running on a Windows host (though apparently it's not about that but just compute for the moment) implement a real Linux DRM kernel driver that talks to the Windows host kernel instead of hardware directly.<br>
<p>
That way the linux guest could use existing Mesa userspace drivers<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822287/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2020 13:39 UTC (Fri)
                               by <b>blackwood</b> (guest, #44174)
                              [<a href="/Articles/822336/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The main use-case is to run the nvidia blob for CUDA and that stuff. And to run that they dig a direct path from the windows kernel gpu driver to linux, but the code that runs in linux isn't a linux driver at all, it's a windows driver. Simply recompiled so it's an ELF .so instead of PE .dll.<br>
<p>
Even the mesa gl driver that could run on top of this is the brand new windows gl mesa driver that runs on top of directx. So really this is all about running the windows graphics stack, in linux, on top of windows. It'll never run on bare metal, and it won't look like a linux graphics stack. Hence why the wayland compositor is completely custom, and will use RDP to shovel the buffers over the wire to windows. Essentially microsoft is working on a wayland compositor for windows, using the windows directX stack and windows paravirt RDP desktop integration stuff, but then accidentally run that on linux. But still a windows graphics stack (just now also with wayland protocol support) end to end.<br>
<p>
Whether drivers/hyperv wants that or not in upstream is entirely different question.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor822343"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2020 14:31 UTC (Fri)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/822343/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Using DRM sounds like a lot of extra work for little benefit. The user-mode components which are being ported from Windows-only to cross-platform would have to support both DRM and D3DKMT kernel APIs, which I guess will have a lot of subtle differences and probably some major differences as they evolve and new GPU features are supported in one but not the other; then the Windows side would need to translate DRM back into D3DKMT. By using D3DKMT throughout, it's a simpler and much less bug-prone task of just proxying commands between the two kernels and recompiling the existing user-mode components for Linux with minimal API changes.<br>
<p>
One of the major use cases seems to be CUDA (e.g. for developing and testing CUDA applications on Windows with WSL, before deploying to a Linux cloud), which is only supported on Linux by the proprietary NVIDIA drivers, so Mesa is irrelevant there. For 3D graphics, I assume there's normally some tight integration between user-mode and kernel-mode drivers, and the real kernel-mode driver (in the Windows kernel) is going to be the proprietary NVIDIA/AMD/Intel one, so you'll need the matching proprietary user-mode driver on Linux - you wouldn't be able to use Nouveau with it even if they all supported DRM.<br>
<p>
D3D12 support on WSL doesn't sound directly useful for applications, because WSL seems like a development platform rather than a deployment platform, so games on Windows will use the native D3D12 API and games on native Linux can't use D3D12 at all (or at least Microsoft hasn't announced any plans for that yet). But D3D12 support means Microsoft can port their OpenGL-to-D3D12 translation layer (<a href="https://devblogs.microsoft.com/directx/in-the-works-opencl-and-opengl-mapping-layers-to-directx/">https://devblogs.microsoft.com/directx/in-the-works-openc...</a>) from Windows to Linux with little extra effort, meaning OpenGL-based applications can be developed on WSL then deployed on Linux. (Apparently that translation layer does use the higher-level parts of Mesa, with a driver that talks to libd3d12 instead of libdrm.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822343/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822881"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2020 16:58 UTC (Thu)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/822881/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One of the major use cases seems to be CUDA (e.g. for developing and testing CUDA applications on Windows with WSL, before deploying to a Linux cloud), which is only supported on Linux by the proprietary NVIDIA drivers, so Mesa is irrelevant there. For 3D graphics, I assume there's normally some tight integration between user-mode and kernel-mode drivers, and the real kernel-mode driver (in the Windows kernel) is going to be the proprietary NVIDIA/AMD/Intel one, so you'll need the matching proprietary user-mode driver on Linux - you wouldn't be able to use Nouveau with it even if they all supported DRM.</font><br>
<p>
<font class="QuotedText">&gt; D3D12 support on WSL doesn't sound directly useful for applications, because WSL seems like a development platform rather than a deployment platform</font><br>
<p>
The initial motivation for WSL appears to be just to turn Windows into a viable development platform (very successfully IMO), but I rather suspect that this specific feature is intended primarily for running real production workloads in Docker Linux containers on the same servers that are running Docker Windows containers, and with minimal (plausibly really could be negligible) performance impact.<br>
<p>
I'm not certain what applications people are running in Docker Windows containers, or why you would actually want to do that, but it's definitely a thing so clearly there are some use cases out there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822881/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822890"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2020 18:15 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/822890/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I'm not certain what applications people are running in Docker Windows containers</font><br>
<p>
CI processes :) . It's really nice to have a known-clean state to start from for CI. Without the unbearable slowdown/latency VMs tend to have.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822890/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor822364"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 5, 2020 19:43 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/822364/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; That way the linux guest could use existing Mesa userspace drivers</font><br>
That's not how DRM works. DRM basically is a "dumb pipe" for commands from userspace to the end device. So you still need a Mesa driver for that device.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822364/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor822392"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 7, 2020 8:10 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/822392/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; There is work going on to support Linux GUI applications on WSL, but that would be done using the Remote Desktop Protocol (RDP) and a Wayland compositor;</font><br>
<p>
BTW Xming worked with WSL1 last time I checked (&lt; 1 year ago). Just in case this sentence gave someone a wrong impression.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822392/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor822513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Free user space for non-graphics drivers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 8, 2020 16:19 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/822513/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, TCP/IP works from WSL1 so you can use GUI apps with Cygwin/X if you're OK with no hardware acceleration or even XSHM. Presumably the focus of the new development is on making it possible to accelerate the rendering of GUIs within WSL and efficiently composite the results onto the Windows desktop.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/822513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
