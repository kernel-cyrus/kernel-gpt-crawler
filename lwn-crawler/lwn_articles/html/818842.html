        <!DOCTYPE html>
        <html lang="en">
        <head><title>Authenticated Btrfs [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/818842/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/819089/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/818842/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Authenticated Btrfs</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>April 30, 2020</br>
           </div>
Developers who are concerned about system integrity often put a fair amount
of effort into ensuring that data stored on disk cannot be tampered with
without being detected.
Technologies like <a
href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/verity.html">dm-verity</a>
and <a href="/Articles/790185/">fs-verity</a> are attempts to solve this
problem, as is the recently covered <a href="/Articles/817472/">integrity
policy enforcement security module</a>.  More Recently, Johannes Thumshirn
has posted <a
href="/ml/linux-fsdevel/20200428105859.4719-1-jth@kernel.org/">a patch
series</a> adding filesystem-level authentication to Btrfs; it promises to
provide integrity with a surprisingly small amount of code.
<p>
Integrity-verification code at the filesystem or storage level generally
works by calculating (and storing) checksums of each block of data.  When
it comes time to read that data, the checksum is calculated anew and
compared to the stored value; if the two match, one can be confident that
the data has not been modified (or corrupted by the hardware) since the
checksum was calculated.  If there is reason to believe that the stored
checksum is what the creator of the data intended, then the data, too,
should be as intended.
<p>
Solutions like dm-verity and fs-verity work by storing checksums apart from
the data; fs-verity, for example, places the checksum data in a hidden area
past the end of
the file.  The developers of more modern filesystems, though, have
generally taken the idea that storage devices are untrustworthy (if not
downright malicious) to heart;
as a result, they design the ability to calculate, store, and compare
checksums into the filesystem from the beginning.  Btrfs is one such
filesystem; as can be seen from <a
href="https://btrfs.wiki.kernel.org/index.php/On-disk_Format">the on-disk
format documentation</a>, most structures on disk have a checksum built
into them.  Checksums for file data is stored in a separate tree.  So much
of the needed infrastructure is already there.
<p>
Checksums in Btrfs, though, were primarily intended to catch corruption
caused by storage hardware.  The thing about hardware is that, while it can
be creative indeed in finding new ways to mangle data, it's generally not
clever enough to adjust checksums to match.  Attackers tend to be a bit
more thorough.  So the fact that a block of data stored in a Btrfs
filesystem matches the stored checksum does not, by itself, give much
assurance that the data has not been messed with in a deliberate way.
<p>
To gain that assurance, Btrfs needs to use a checksum that cannot readily
be altered by an attacker.  Btrfs already supports a number of checksum
algorithms, but none of them have that property.  So the key to adding the
needed sort of authentication to Btrfs is to add another checksum algorithm
with the needed assurance.  Thumshirn chose to add an <a
href="https://en.wikipedia.org/wiki/HMAC">HMAC</a> checksum based on
SHA-256.
<p>
Calculating an HMAC checksum for a block of data requires a secret key;
without the key, the code can neither calculate checksums nor verify those
that exist.  This key must be provided when the filesystem is created; an
example from the patch set reads like this:
<p>
<pre>
    mkfs.btrfs --csum hmac-sha256 --auth-key 0123456 /dev/<i>disk</i>
</pre>
<p>
Here, <tt>0123456</tt> is the authentication key to be used with this
filesystem.
<p>
This key must also be provided when the filesystem is mounted; that does
not happen directly on the command line, though.  Instead, the key must be
stored in the kernel's trusted keyring; the name of that key is then
provided as a mount option.  This (hopefully) keeps the key itself from
appearing in scripts or configuration files; instead, the key must come
from a trusted source at system boot time.
<p>
That is really about all there is to it.  An attacker who lacks the trusted
key can still read the filesystem, but they cannot make changes without
breaking the checksums — and that will cause any such changes to be detected the
next time the affected data is read.  It is worth noting, though, that an
attacker who can compromise the kernel can access the key or just
have the kernel write the
desired changes directly to the filesystem.  Solutions like fs-verity,
instead, usually don't allow the key anywhere near production systems; that
makes the protected files read-only, but that is usually the intent
anyway.  So authenticated Btrfs is suitable for deterring offline attacks,
but it may not be able to protect against as wide a range of attacks as
some other technologies.
<p>
On the other hand, authenticated Btrfs requires minimal changes to the
Btrfs code, and doesn't require the interposition of any other layers
between the file system and the storage device.  It
may well prove useful for a range of use cases.  The patch set is
relatively young, though, and has not yet received much in the way of
review comments.  The real test will happen once developers find the time
to give these changes a close look.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Btrfs">Filesystems/Btrfs</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Integrity_verification">Security/Integrity verification</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/818842/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor819143"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 30, 2020 23:21 UTC (Thu)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/819143/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Has there been any thought to doing something similar to what ZFS does for their encryption? They also use a HMAC, but rather than replacing the entire checksum they split the checksum in half -- the top half is a normal SHA-512/256 checksum and the bottom half is the HMAC. The upside of this method is that it means that a user who doesn't have the HMAC key can still do some basic operations on the pool (the use-case for ZFS is sending encrypted ZFS snapshots to another system, but still allowing the receiving system to do ZFS scrubs).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819143/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819148"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2020 6:25 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/819148/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's a clever way of doing it. Shoehorning it into Btrfs may be tricky if possible at all though - `man 5 btrfs` says “metadata blocks have a fixed area up to 256bits (32 bytes)”, which gives me the impression it's limited to that size.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819148/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819150"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2020 6:46 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/819150/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ZFS has the same restriction (the checksum field in ZFS block pointers is 32 bytes long). The trick is that you take the first 16 bytes of SHA-256 and the first 16 bytes of HMAC-256, and the concatenation of both is your new 32 byte checksum. If you don't have the key, you can only verify half of the checksum but that is sufficient to detect data corruption. Obviously this is a workaround for fixed-size block pointers -- ideally you would just store both checksums.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819150/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819231"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2020 20:00 UTC (Fri)
                               by <b>dcg</b> (subscriber, #9198)
                              [<a href="/Articles/819231/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In Btrfs it would be theoretically possible to add yet another tree to the forest, so you could have both a csum tree and a hmac tree (it may even be possible to shoehorn the hmac items into the csum tree in some way). But I'm not sure how valuable are these features for developers, btrfs has already been pretty disappointing when it comes to encryption.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819231/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2020 20:15 UTC (Fri)
                               by <b>jeffm</b> (subscriber, #29341)
                              [<a href="/Articles/819232/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be possible to modify the csum tree (or create a new tree) to do this for data, but metadata checksums are in the header for every tree node.  Changing the size would be an incompatible disk format change.  It's not impossible but it's a big barrier.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor819157"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2020 9:39 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819157/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Technologies like dm-verity and fs-verity are attempts to solve this problem</font><br>
<p>
dm-verity has been in production for years, at least in Chromebooks:<br>
<a href="https://blog.chromium.org/2019/10/dm-verity-algorithm-change.html">https://blog.chromium.org/2019/10/dm-verity-algorithm-cha...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819157/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor819202"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2020 13:51 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/819202/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What mechanisms are available to add the secret to the keyring at boot? GRUB options, embedded in the initramfs? r is this something that is intended to be tied to a TPM of some sort? If so, how would one know what secret to use when creating the filesystem?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819202/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819332"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 0:57 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819332/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; What mechanisms are available to add the secret to the keyring at boot? Etc.</font><br>
<p>
Very good questions.<br>
<p>
The "bolted-on" nature of dm-verity aside, I'm afraid the article missed a much more important conceptual difference<br>
<p>
<font class="QuotedText">&gt; Solutions like dm-verity and fs-verity work by storing checksums apart from the data; [...]. The developers of more modern filesystems, [...] as a result, they design the ability to calculate, store, and compare checksums into the filesystem from the beginning</font><br>
<font class="QuotedText">&gt; [...]</font><br>
<font class="QuotedText">&gt; The secret key must also be provided when the filesystem is mounted;</font><br>
<p>
dm-verity doesn't not require any secret key for mounting because it's meant for read-only partitions created by someone else and the verification is performed thanks to an _asymmetric_ key pair. Fairly different use case isn't it? Not an expert; please correct me. <br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819332/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819333"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 1:07 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819333/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Doh! Next time I'll keep paying attention even after reading the sentence "That is really about all there is to it." Where's that "delete comment" button? For my defense: the article starts with a comparison with dm/fs-verity but waits until the end to mention it's very different use case; not very noob-friendly :-/<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819333/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor819334"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 1:12 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/819334/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can just use an asymmetric key to sign a symmetric key used to verify the data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819334/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 2:02 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819336/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If/when the local attacker gets hold of the symmetric key, she can generate authentic data. Doesn't matter much whether that symmetric signed or not, does it? Sorry if I'm missing something (again).<br>
<p>
The key difference (pun intended) is that this attack vector is not possible in dm-verity's read-only approach where nothing (firmware, kernel, ...) on the running system itself holds any secret needed to generate authentic data.<br>
<p>
The more I think about it, the bigger the difference between read-only and read-write seems to be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor825516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 7, 2020 18:52 UTC (Tue)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/825516/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, you can&#x27;t - an attacker can just read the symmetric key, then &quot;sign&quot; his own replacement data with that symmetric key.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/825516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor819339"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 7:00 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/819339/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm hoping to use dm-verity in the raid subsystem soon. Given that the purpose of dm-verity is simply to confirm that was is later read from disk, is exactly what was written to disk earlier, it doesn't need a secret.<br>
<p>
This is important for raid because, as things currently stand, it can quite happily recover from *missing* data, but it can't recover from *corrupt* data. If the ability to detect corrupt data is added, then it can just throw it away and treat it like it's missing.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819339/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 15:02 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819403/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How hard would it be for (software) RAID to check the parity even when the disks think everything is OK?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819430"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 18:33 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/819430/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Apart from raid 6, what does this gain you?<br>
<p>
Raid 5 has ONE parity block, which enables you to recover from ONE unknown. Corrupt  data is two unknowns - which block is corrupt? And what was the correct data?<br>
<p>
Raid 6 can recover from that, but you need to run a special program over it which necessitates taking the array off-line.<br>
<p>
And equally, if you have a mirror, how do you know which side of the mirror is correct.<br>
<p>
I'd like to add a mode whereby raid does check, but it would damage read performance noticeably, so there's no way it would get added unless the default (a) doesn't check, and more importantly (b) if the check is not enabled it mustn't impact performance.<br>
<p>
At present, if there is corruption, the raid code assumes the parity is corrupt (which is usually true) and just recalculates it.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819430/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819464"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 5, 2020 6:14 UTC (Tue)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819464/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Apart from raid 6, what does this gain you?</font><br>
<p>
What you asked earlier:<br>
<p>
<font class="QuotedText">&gt; &gt; &gt; If the ability to detect corrupt data is added, then it can just throw it away and treat it like it's missing.</font><br>
<p>
But know you say it's already there, so I'm confused:<br>
<p>
<font class="QuotedText">&gt; At present, if there is corruption, the raid code assumes the parity is corrupt (which is usually true) and just recalculates it.</font><br>
<p>
BTW why is the parity more likely to be corrupted then the data itself? I thought the disks were interchangeable.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819464/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819466"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 5, 2020 8:16 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/819466/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; &gt; Apart from raid 6, what does this gain you?</font><br>
<p>
<font class="QuotedText">&gt; What you asked earlier:</font><br>
<p>
Basically, raid-6 is the only raid that can recover from data corruption. 1 &amp; 5 can detect corruption but they can't do anything about it.<br>
<p>
<font class="QuotedText">&gt; &gt; If the ability to detect corrupt data is added, then it can just throw it away and treat it like it's missing.</font><br>
<p>
<font class="QuotedText">&gt; But know you say it's already there, so I'm confused:</font><br>
<p>
dm-integrity/dm-verity (I got confused) can detect the corruption before the raid sees it, so by deleting the corrupt data, raids 1 &amp; 5 can now recover.<br>
<p>
<font class="QuotedText">&gt; &gt; At present, if there is corruption, the raid code assumes the parity is corrupt (which is usually true) and just recalculates it.</font><br>
<p>
<font class="QuotedText">&gt; BTW why is the parity more likely to be corrupted then the data itself? I thought the disks were interchangeable.</font><br>
<p>
I haven't totally got my head around it, but it's something like everything happens at once so the data stripes are sent for writing, at the same time as the parity is calculated, which then comes down a bit later. So the statistics say that the majority of problems occur in the gap between writing data and parity so just rewriting parity is more likely to fix it than cause further problems. I don't properly get it, but that's what the people who know far more than I do say.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819466/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor819885"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2020 2:48 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/819885/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
<font class="QuotedText">&gt; &gt; At present, if there is corruption, the raid code assumes the parity is corrupt (which is usually true) and just recalculates it.</font><br>
<font class="QuotedText">&gt; </font><br>
<font class="QuotedText">&gt; BTW why is the parity more likely to be corrupted then the data itself? I thought the disks were interchangeable.</font><br>
<p>
This is misleading.<br>
<p>
The current (md/raid) code assumes that corruption is impossible at the block level, because any self-respecting storage medium would have a strong checksum, and any self respecting data path would equally have some redundancy to avoid errors creeping in (unfortunately our hardware is not even self-aware, so self-respecting appears to be too much to ask for).<br>
<p>
If two devices in a RAID1 do not contain identical data, or if the sum of the data in a RAID4/5/6 doesn't match the parity block(s), then this is an inconsistency, not a corruption.<br>
The most likely explanation is that multiple devices in the array were being written to when something went wrong (e.g. power loss) and some writes succeeded while others didn't.  It doesn't matter which succeeded and which didn't.<br>
<p>
In this case NEITHER BLOCK IS WRONG.  I need to say that again.  BOTH BLOCKS ARE CORRECT.  They are just correct at different points in time.<br>
There is NO CORRUPTION here, there is just an inconsistency.<br>
Each block will either contain the new data or the old data, and both are correct in some sense.<br>
(If a block got half-written to the device, which is possible if the device doesn't have a big enough capacitor, then you would get a read-error because the CRC wouldn't be correct.  When you get a CRC error, md/raid knows the data is wrong - and cannot even read the data anyway).<br>
<p>
In the case of RAID1 it REALLY DOESN'T MATTER which device is chosen to use and which device gets it's data replaced.  md arbitrarily chooses the earliest in the list of devices.<br>
In the case of a parity array it makes sense to use the data and ignore the parity because using the parity doesn't tell you which other device it is inconsistent with. (If you have reason to believe that the parity might not be consistent with the data, and one of the data block is missing - failed device - then you cannot use either date or parity, and you have a "write hole").<br>
<p>
I hope that clarifies the situation a little.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819885/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819898"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2020 4:27 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/819898/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I hope that clarifies the situation a little.</font><br>
<p>
It really does, thank you so much!<br>
<p>
So, the entire RAID implementation assumes blocks are either missing or old but never "corrupted" (intentionally or not), I think I got it. Combining RAID with solutions that _do_ deal with block corruption sounds like... perfect to confuse me ;-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819898/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor820529"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2020 13:57 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/820529/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've just started building my new system with raid on top of dm-verity. So hopefully this will soon be part of md-raid, but that depends on me getting familiar with mdadm ... :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/820529/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor820531"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2020 14:01 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/820531/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whoops - dm-integrity ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/820531/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor820607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2020 14:38 UTC (Fri)
                               by <b>zsitvaij</b> (guest, #66284)
                              [<a href="/Articles/820607/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Have you read this comparison on zfs/btrfs/dm-integrity+mdadm? It's a very detailed and fun read if such things interest you: <a rel="nofollow" href="https://www.unixsheikh.com/articles/battle-testing-data-integrity-verification-with-zfs-btrfs-and-mdadm-dm-integrity.html">https://www.unixsheikh.com/articles/battle-testing-data-i...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/820607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor820738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2020 15:18 UTC (Sun)
                               by <b>grifferz</b> (subscriber, #62128)
                              [<a href="/Articles/820738/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would be very interested in any benchmarks you are able to do, to see what use of dm-integrity costs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/820738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor820740"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2020 16:46 UTC (Sun)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/820740/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If I get the chance ...<br>
<p>
mind you, once my current machine gets demoted to testbed I need to buy a 4-port add-in SATA card to fit all the 1TB and 500GB disks I've acquired, so testing with and without dm-integrity shouldn't be too bad ...<br>
<p>
Cheers,<br>
Wol<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/820740/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor819432"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 20:04 UTC (Mon)
                               by <b>leromarinvit</b> (subscriber, #56850)
                              [<a href="/Articles/819432/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  I'm hoping to use dm-verity in the raid subsystem soon. Given that the purpose of dm-verity is simply to confirm that was is later read from disk, is exactly what was written to disk earlier, it doesn't need a secret.</font><br>
<p>
Isn't that exactly what dm-integrity can already do today? What would using dm-verity instead buy you, if you can't keep the private key secret because (presumably) you want to write to your array?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819432/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor819438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2020 20:43 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/819438/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Or am I mixing up up dm-integrity and dm-verity. Quite likely.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/819438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor820094"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Authenticated Btrfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 10, 2020 13:48 UTC (Sun)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/820094/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; What mechanisms are available to add the secret to the keyring at boot?</font><br>
<p>
I don't think I got an answer to this. It seems the other branch is way off-topic to me. Or I'm not knowledgeable enough to know that the answer has been given in that subthread :) .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/820094/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
