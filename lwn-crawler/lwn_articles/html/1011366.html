        <!DOCTYPE html>
        <html lang="en">
        <head><title>Guard pages for file-backed memory [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/1011366/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/1012148/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/1011366/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Guard pages for file-backed memory</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>March 3, 2025</br>
           </div>
One of the many new features packed into the 6.13 kernel release was guard
pages, a hardening mechanism that makes it possible to inject zero-access
pages into a process's address space in an efficient way.  That feature
only supports anonymous (user-space data) pages, though.  To make guard
pages more widely useful, Lorenzo Stoakes has put together <a
href="/ml/all/cover.1739469950.git.lorenzo.stoakes@oracle.com">a patch
set</a> enabling the feature for file-backed pages as well; in the process,
he examined and resolved a long list of potential problems that extending
the feature could encounter.  One potential problem was not on his list,
though.
<p>
The purpose of a guard page is to prevent buggy (or malicious) code from
overrunning a memory region.  An inaccessible page placed at the end of a
region will cause a segmentation fault should the running process try to
read or write to it; well-placed guard pages can trap a number of common
buffer overruns and similar problems.  Prior to 6.13, though, the only way
to put a guard page into a process's address space was to set the 
protections on one or more pages with <a
href="https://man7.org/linux/man-pages/man2/mprotect.2.html"><tt>mprotect()</tt></a>;
that works, but at the cost of creating a new virtual memory area (VMA) to
contain the affected page(s).  Placing a lot of guard pages will create a
lot of VMAs, which can slow down many memory-management functions.
<p>
The new guard-page feature addresses this problem by working at the
page-table level rather than creating a new VMA.  A process can create
guard pages with a call to <a
href="https://man7.org/linux/man-pages/man2/madvise.2.html"><tt>madvise()</tt></a>,
requesting the <tt>MADV_GUARD_INSTALL</tt> operation.  The indicated range
of memory will be rendered inaccessible; any data that might have been
stored there prior to the operation will be deleted.  There is an operation
(<tt>MADV_GUARD_REMOVE</tt>) to remove guard pages as well.
<p>
Placing guard pages in VMAs containing anonymous pages is the simplest
case, which is why anonymous pages were supported first.  These pages have
no connection to any file on disk, so there are relatively few hazards
involved with changing their behavior.  File-backed pages bring more
complexity, though, and a number of places where guard pages could cause
problems.  Stoakes goes through the list in detail in the patch posting.
<p>
For example, readahead is an important part of maintaining performance when
a process is working sequentially through a file.  As that process reads
some data from a file, the kernel can guess that the process will go on to
request the following data in the file in the near future.  By initiating a
read operation before user space gets around to asking for the data, the
kernel can ensure that this data is present (or at least on its way) when
the request arrives.  The presence of a guard page will stop readahead cold
at that point, since the page has been marked inaccessible.  As Stoakes
notes, this should not be a problem, since it would be unusual for a
process to map a file, place a guard page, then try to read through that
page.
<p>
Similar complications arise in other situations.  The kernel will often try to
"fault around" a page that has been faulted in, under the assumption that
nearby data will be of interest; guard pages will prevent that as well.  If
a file is truncated, the removed portion may include guard pages, but the
guard pages themselves will remain in place.  And so on; in each case,
Stoakes has ensured that the kernel's operation will be correct and make
sense.
<p>
There are still a couple of exceptions, though, one of which was known
about before the patches were posted, while the other was a surprise.  The
known issue is that guard pages cannot be placed in memory areas that have
been locked into RAM with <a
href="https://man7.org/linux/man-pages/man2/mlock.2.html"><tt>mlock()</tt></a>.
The problem, as Vlastimil Babka <a
href="/ml/all/fbfae348-909b-48fa-9083-67696b02f15e@suse.cz">pointed
out</a>, is that <tt>mlock()</tt> guarantees that the affected pages will
not be kicked out of RAM.  Installing a guard page, though, frees any data
stored there, which runs counter to the <tt>mlock()</tt> promise.  Stoakes
is <a
href="/ml/all/8d643393-ddc0-490d-8fad-ad0b2720afb1@lucifer.local">considering</a>
a new operation that would make this data destruction explicit in that case
but, as David Hildenbrand <a
href="/ml/all/37b606be-f1ef-4abf-83ff-c1f34567568e@redhat.com">said</a>,
"<q>mlock is weird</q>" and there are a number of other details that would
have to be managed there.
<p>
The unexpected issue was <a
href="/ml/all/CAC_TJveMB1_iAUt81D5-+z8gArbVcbfDM=djCZG_bRVaCEMRmg@mail.gmail.com">raised</a>
by Kalesh Singh, who wondered how the presence of guard pages would be
represented in <tt>/proc/<i>PID</i>/maps</tt> and
<tt>/proc/<i>PID</i>/smaps</tt>.  These files, which are documented in <a
href="https://docs.kernel.org/filesystems/proc.html">Documentation/filesystems.proc.html</a>,
describe a process's VMAs in detail.  Singh said:
<p>
<blockquote class="bq">
	In the field, I've found that many applications read the ranges
	from /proc/self/[s]maps to determine what they can access (usually
	related to obfuscation techniques). If they don't know of the guard
	regions it would cause them to crash; I think that we'll need
	similar entries to PROT_NONE (---p) for these, and generally to
	maintain consistency between the behavior and what is being said
	from /proc/*/[s]maps.
</blockquote>
<p>
It seems that banking apps running on Android are known for this sort of
behavior and could run into trouble if guard pages are installed — which is
something that the Android runtime might well want to do as a general
hardening measure.  Since those apps already read the indicated
<tt>/proc</tt> files, Singh thought that would be a logical place to
indicate the presence of the guard pages.
<p>
This request <a
href="/ml/all/45297010-a0a4-4a42-84e8-6f4764eab3b3@lucifer.local">took
Stoakes by surprise</a>, since he thought the topic had been discussed
previously and the situation understood.  That situation is that, since
those files describe VMAs, they are not a suitable place to put information
about guard pages which, by design, do not have their own VMAs.
Hildenbrand quickly <a
href="/ml/all/41af4ffb-0383-4d00-9639-0bf16e1f5f37@redhat.com">suggested</a>
that a bit in <tt>/proc/<i>PID</i>/pagemap</tt>, which provides page-level
data now, would be the best way to export that information to user space.
The conversation nonetheless became a little tense, seemingly mostly as a
result of misunderstandings rather than true disagreement.
<p>
In the end, though, it was agreed that <tt>pagemap</tt> was the right place
for this information.  Suren Baghdasaryan eventually <a
href="/ml/all/CAJuCfpHpchh0CzEgh5CKmRLwpscBLx32A-mGi4eudpir1wm=cQ@mail.gmail.com">joined
the conversation</a>, saying that some work would be needed to make this
information available to apps in the Android system, but that he would
start on that project.  Apologies and thanks were shared around, and
Stoakes <a
href="/ml/all/87bae232-b01d-4962-bbe1-3677b71ff752@lucifer.local">said</a>
that he would go ahead and implement the kernel side of the
<tt>pagemap</tt> solution.
<p>
With that issue seemingly resolved, there does not appear to be any serious
obstacles to this feature heading toward the mainline in the near future.
The patch series (minus the <tt>pagemap</tt> changes) is sitting in
linux-next now and could conceivably go upstream as soon as the 6.15 merge
window.  That should result in easier and cheaper user-space hardening,
which seems worth the trouble.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls-madvise">System calls/madvise()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/1011366/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor1012810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">pagemap change now in -next :)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2025 20:15 UTC (Mon)
                               by <b>ljsloz</b> (subscriber, #158382)
                              [<a href="/Articles/1012810/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Happy to report the pagemap part of this has now landed in linux-next also! :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1012820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Thanks for pointing MADV_GUARD_*</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2025 22:00 UTC (Mon)
                               by <b>wtarreau</b> (subscriber, #51152)
                              [<a href="/Articles/1012820/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for pointing MADV_GUARD_REMOVE/MADV_GUARD_INSTALL, I was making my own guard pages myself (like anyone I guess) and indeed it's a mess which triples the number of VMAs. I'll have a look, that can be very helpful, even if it's only supported since 6.13.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1012823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">more like this please :)</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2025 22:05 UTC (Mon)
                               by <b>jokeyrhyme</b> (subscriber, #136576)
                              [<a href="/Articles/1012823/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yay, i'd like more stories like this please: of kernel arguments that end in mutual understanding and forward progress :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1012818"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2025 22:06 UTC (Mon)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/1012818/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <p>We don't know <b>what exactly</b> banking apps need, but we know what they <b>want</b>: they just want to find out where in the address space lies the code of system libraries… to scan that code. Some would want to scan data segment, too, but most only care about code.</p>

<p>I don't think they even think in terms of VMAs or pagetables… they just need list of addresses they can safely peek into without triggering SIGSEGV… and currently it can be readily found in <code>/proc/PID/maps</code>.</p>

<p>This patch definitely breaks that API.</p>

<p>P.S. Of course on ARM64 there are an additional twist to all that madness: because normally libraries are mapped execute-only on Android not only these apps need to find these regions via <code>/proc/PID/maps</code>… they also need to make them <code>read+execute</code> (for investigation purposes) and then they make them <code>execute-only</code> again (if they are courteous… many leave mappings in <code>read+execute</code> state). I wonder what would happen when all these hardening techniques would meet on one place, though.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/1012818/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1012850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 1:01 UTC (Tue)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/1012850/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I mean... Linux "breaks" userspace when it's acting like a virus or malware, and the way many banking apps behave is very much crossing that line up to and including coming into direct conflict with the sandboxing Android itself attempts to enforce in newer versions at times so suddenly "Please use your browser if you have an Android XYZ device or newer." pops up or the app just silently throws a browser view up instead for you.<br>
<p>
There's quite a few that won't even load if you have Developer mode enabled on Android, doesn't matter if you're using it just to keep the screen on, or to override bluetooth versions to work with an older car radio, they just straight refuse to load.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1012855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 3:50 UTC (Tue)
                               by <b>wtarreau</b> (subscriber, #51152)
                              [<a href="/Articles/1012855/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, it's used as well for debugging, or by applications trying to perform introspection in back traces etc.<br>
<p>
We're still missing a portable way to attempt a safe kernel-assisted memory copy from one area to another that would simply return EFAULT when either area is not accessible. I'm using some hacks using syscalls when I need to do that but that's ugly. I suspect one could also use vmsplice() to move the data into a pipe then from it, though I have not tried.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1012865"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 8:41 UTC (Tue)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/1012865/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ideally, there would be routines in the vDSO we could use, and the kernel would just hide the faults (like it does in kernel space). Using process_vm_readv as a memcpy replacement seems a bit over the top.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012865/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1012873"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 9:38 UTC (Tue)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/1012873/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; I'm using some hacks using syscalls when I need to do that but that's ugly.</font>

<p>Well… using <code>write</code> for read looks a fit… quaint, but works well, in practice.</p>

<font class="QuotedText">&gt; We're still missing a portable way to attempt a safe kernel-assisted memory copy from one area to another that would simply return EFAULT when either area is not accessible.</font>

<p><code>pipe</code>, then <code>fork</code> with one side reading with <code>write</code> syscall (specify memory argument that you want to look into as buffer, pipe as target, kernel will return <code>EFAULT</code> if memory can not be read) and the other getting information from pipe… this trick is decades old and portable (even if I'm not sure how portable, but it certainly works fine with very old versions of Linux), but don't see why would it stop working… because of <code>fork</code> ?</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/1012873/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1013002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2025 4:36 UTC (Wed)
                               by <b>wtarreau</b> (subscriber, #51152)
                              [<a href="/Articles/1013002/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I totally agree, that's just what I mean by "ugly". Having to use a pipe + its 2 FDs + the double-copy. We could imagine having either mprotect(PROT_CHECK|PROT_READ) that would only return whether or not PROT_READ is present on all the area, or madvise(MADV_ZEROFILL) which would indicate that if not mapped, the area behaves as /dev/zero, or for threaded environments where this would not be safe, just a single syscall to perform a memcpy().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1013002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor1012871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 9:28 UTC (Tue)
                               by <b>vbabka</b> (subscriber, #91706)
                              [<a href="/Articles/1012871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Note the kernel does not break existing userspace just by introducing the new API.<br>
<p>
But yes, the new API gives you better efficiency (fewer VMAs) with the tradeoff for /proc/pid/(s)maps visibility, and having to deal with faults when you would want to scan the memory ranges and don't know where the guard pages are.<br>
<p>
So yes in practice that makes it harder to use the new APIs when some part of the userspace (i.e. libc or the android Zygote mechanism) would switch from PROT_NONE guard areas to the new functionality and thus break other parts of the userspace. But the kernel doesn't change anything to the existing userspace unless it opts-in to the new functionality, so "we don't break the userspace" is not affected here.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1012874"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 9:56 UTC (Tue)
                               by <b>ljsloz</b> (subscriber, #158382)
                              [<a href="/Articles/1012874/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; they just need list of addresses they can safely peek into without triggering SIGSEGV</span><br>
<p>
There's a series of assumptions being made about executable code being present and immutable, none of which are 'API'.<br>
<p>
It may be taken to probably be the case that it's fine, but it's in essence assuming internal implementation details.<br>
<p>
Note that executable segments are very unlikely to be reclaimed, but they might be, at which point your underlying file system may do strange things on fault (e.g. network fs etc.). It may be unlikely, certainly in an android case, but if one is going to call this an implicit 'API' you really need some solid basis to do so.<br>
<p>
What makes this more likely are for instance, obfuscation techniques and JIT which may result in 'strange' executable code relocation.<br>
<p>
Speaking from a philosophical standpoint, PROT_NONE is not a contract that guarantees 'hey this is the only means by which a guard region can be implemented', it is only, simply, a VMA that guarantees, at least right now, that accesses will cause a signal to arise.<br>
<p>
So I think right now these apps are making assumptions about internal implementation details, imagining implied contracts, which happen to be the case (at least _most_ of the time) right now, but, should implementers _choose_ to use this API, will no longer be in the future.<br>
<p>
So speaking _generally_ about /proc/$pid/maps, ranges shown there:<br>
<p>
- May SIGBUS.<br>
- May fault causing file systems to possibly do strange things (they have custom hooks), that could in theory result in SIGSEGV or do other broken things....<br>
- May trigger a uffd fault, where a broken userland app may cause an eternal sleep.<br>
- /proc/$pid/maps is racey, and you may see things out of order as you read left to right if there are aggregate (in userland) operations being performed.<br>
- May not exist any more, people may unmap/remap at any time.<br>
<p>
There is absolutely emphatically no guarantee you will not receive a signal (or brokenness) by accessing regions seen in /proc/$pid/maps. No such guarantee is documented anywhere, and cannot reasonably relied upon by userland.<br>
<p>
Linux isn't windows of yore, the commitment to not breaking userspace has very well been established as 'not breaking _reasonable_ userland if and only if there are users which actually specifically rely upon said reasonable interfaces'.<br>
<p>
The discussion on-list was that all of this was made abundantly clear throughout the implementation of this feature, and it was agreed that there was some miscommunication that led to this issue not being raised.<br>
<p>
But equally, it was agreed that it would be correct to instead of having the banking apps etc. simply rely upon _assumptions_ via /proc/$pid/maps, they could, instead, make use of an interface that explicitly provided this information. The provision of guard region information in /proc/$pid/pagemap provides the means for this. This should solve things for this very, very specific and unusual use case.<br>
<p>
Additionally I went to great lengths to try to find whatever means by which we could find to resolve this - since this is all moot, given this is a shipped feature which again - I emphasise does NOT break the 'do not break userland' concept, nor does it break any existing API.<br>
<p>
As @vbabka points out also, what is very clear is - this feature is opt-in. Nobody _has_ to use it, and continuing to use linux as-is will have no impact whatsoever with this feature present. So again, no API break, no never-break-userspace-break.<br>
<p>
The benefits of this feature are huge, as the kind of kernel memory that is used upon VMA proliferation is pure memory pressure - it cannot be reclaimed or migrated. At scale this can really, really add up.<br>
<p>
Also another point raised in the discussion is at no point could this feature exist AND something appear in /proc/$pid/maps. The feature emphatically requires the separation of page table-induced faulting behaviour vs. VMA metadata state. /proc/$pid/maps does not traverse page tables, so cannot obtain this information. It is expensive to do so. Adjustment of VMA metadata to show it here would cause VMA merge failure and thus render the feature useless.<br>
<p>
In the end we all reached a satisfactory agreement upon how to move forward sensibly :)<br>
<p>
People are very very keen to jump to 'oh the kernel broke userspace!' very quickly, but often things are more subtle and nuanced than they first appear. In this case it's understandable, but I would respectfully suggest you are mistaken in that assertion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012874/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1012878"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 11:04 UTC (Tue)
                               by <b>PeeWee</b> (subscriber, #175777)
                              [<a href="/Articles/1012878/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; As @vbabka points out also, what is very clear is - this feature is opt-in. Nobody _has_ to use it, and continuing to use linux as-is will have no impact whatsoever with this feature present. So again, no API break, no never-break-userspace-break.</span><br>
<p>
But what happens to such banking apps if they try to scan memory areas of applications that did opt-in to this? Wouldn't they then do &lt;funky stuff&gt; because their - quite questionable - assumptions don't hold anymore? Say, libc opts in and such an unmodified banking app wants to scan its memory, wouldn't it trip over this? So they don't need to opt-in to be affected by this, or am I missing/misunderstanding something here?<br>
<p>
On a related note, I believe such banking apps should not exist to begin with IMHO, because they essentially break 2FA and try to work around that by making sure no "hacker tools" are present by using this (and other?) technique. It used to be that one was strongly discouraged - by those very banks mind you - from using the same mobile device for entering transaction data AND receiving things like (transaction bound) TANs to validate said transaction, because a compromised device is able to manipulate both the transaction and the TAN that is only valid for this one transaction. I am a bit fuzzy on the exact details but that's the gist of it; TL;DR: if you can simply enter a transaction and don't have to do an actual additional validation (TAN) there is no 2FA and thus no guarantee that you are doing the transaction you actually want instead of the one the baddies want you to commit.<br>
<p>
What I am trying to say is that I think this should NOT be considered "reasonable userspace" and (maybe) SHOULD be broken, on purpose even. The kernel should definitely NOT accommodate such onerous app behaviour IMHO.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012878/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1012880"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2025 12:01 UTC (Tue)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/1012880/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;Say, libc opts in and such an unmodified banking app wants to scan its memory, wouldn't it trip over this?</span><br>
<p>
I think there's a reasonable interpretation where this is giving libc the tools, and libc can do something sensible with the feature without necessarily breaking everything.<br>
The kernel is giving userspace new APIs, but not breaking any pre-existing code; taking an old system and installing this new kernel will not by itself break the dodgy memory scanning code.<br>
<p>
Concretely, I think for Android libc could reasonably gate this on Android API level ("if your app declares targetSdkVersion &gt;= X, libc will make use guard pages"). Every so often, the Android team increases the minimum SDK version required on their play store. So they will eventually be able to turn on guard pages unconditionally, but without taking the authors of innocent m̶a̶l̶w̶a̶r̶e anti-debug obfuscation features by surprise.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1012880/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor1013141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2025 0:08 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/1013141/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In my book, these are debugging APIs. They're properly used to answer questions like "why am I segfaulting here?" You're not going to break on some existing app unless it has been compiled against (e.g.) a new libc that calls into the new API, at which point the answer is simple - update your gdb (or other debugger) when you update your libc.<br>
<p>
But even if it does break, it's not much of a breakage anyway. You just get a less-useful "ptrace said no" error message than you would otherwise. It doesn't prevent you from doing any of the things that you would otherwise be able to do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1013141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1013175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 6, 2025 11:58 UTC (Thu)
                               by <b>PeeWee</b> (subscriber, #175777)
                              [<a href="/Articles/1013175/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But besides debugging I was thinking about those banking apps. What they are doing does not fit the definition of debugging IMHO. I'd call it snooping, given the context that they try to see if some "evildoer" is present. I don't know enough about the matter to ascertain if a shared lib could transparently opt-in to this, i.e. no ABI breakage. But if that's the case then those banking apps and suchlike would be affected without doing anything, i.e. without opting in. I am also not quite sure if this is the correct example, since those apps seem to snoop in all memory regions they can read, even the ones totally unrelated to their own code. But I also don't know if that is even possible/allowed, as in: can any program read any memory region, sans kernel memory? I only have a vague memory of once reading about keystores such as Seahorse needing to go the extra mile to not expose their secrets to just anybody reading arbitrary memory regions, which makes me think that, by default, any memory is fair game for reading unless precautions are taken. And that would suggest that unrelated programs can be affected. But it is also more of an academic thought, since I believe that such programs (not debuggers) are employing malware practices.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1013175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1013466"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2025 0:51 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/1013466/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The default rule, to my understanding, is roughly as follows:<br>
<p>
* root can ptrace anybody.<br>
* You can ptrace your own processes. Or, to be more pedantically correct, processes running with the same UID can ptrace each other. (I have no idea if that is real UID, EUID, or some other UID-like thing entirely.)<br>
* Nobody else can ptrace anything, unless they have a special capability.<br>
* I imagine there might be a sysctl knob or something that applies further restrictions (such as turning off non-root ptracing altogether), but I don't know if such an interface really exists.<br>
<p>
My position is that none of this actually matters. What matters is that ptracing is a tool for developers to figure out why their app is broken. It is not a security mechanism. It is not, in fact, intended for random apps to ptrace each other just because they feel like it, or because somebody with the word "compliance" in their job title has decided that it's a good idea.<br>
<p>
When you go around poking your nose into somebody else's memory, at runtime, in production, on real hardware that is owned by a real user, any breakage is entirely your own problem. Nobody ever promised that you could do that, and there are numerous hardening measures that can trivially break it in one way or another (for example, the user could put you or the other app behind a container, or even just a separate UID), plus you have to consider more mundane problems like userspace ASLR, static linking and LTO, no debug symbols, and so on. The whole idea is monstrously fragile and it's a miracle if it works at all.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1013466/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor1013468"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">What happened to “we don't break the userspace” idea?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2025 8:31 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/1013468/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; It is not a security mechanism. It is not, in fact, intended for random apps to ptrace each other just because they feel like it</span><br>
<p>
Bank apps ptrace() _themselves_ to make sure there's nothing unusual injected into their address space.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/1013468/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2025, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
