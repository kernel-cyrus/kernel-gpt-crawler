        <!DOCTYPE html>
        <html lang="en">
        <head><title>Short sleeps suffering from slack [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/482168/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/481904/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/482168/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Short sleeps suffering from slack</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 17, 2012</br>
           </div>
As a general rule, kernel developers will go out of their way to avoid
breaking user-space code, even when that code is seen as being wrong and
already broken.  But 
there are exceptions; a recent discussion regarding timer behavior may
prove to be an example of how such exceptions can come about.
<p>
The C-library <tt>sleep()</tt> function is defined to put the calling
process to sleep for at least the number of seconds specified.  One might
think that calling <tt>sleep()</tt> with an argument of zero seconds would
make relatively little sense; why put a process to sleep for no time?  It
turns out, though, that some developers put such calls in as a way to
relinquish the CPU for a short period of time.  The idea is to be nice and
allow other processes to run briefly before continuing execution.
Applications that perform polling or are otherwise prone to consuming too
much CPU are often "fixed" with a zero-second sleep.
<p>
Once upon a time in Linux, <tt>sleep(0)</tt> would always put the calling
process to sleep for at least one clock tick.  When high-resolution timers
were added to the kernel, the behavior changed: if a process asked to sleep
on an already-expired timer (which is the case for a zero-second sleep),
the call simply returned directly back to the calling process.  Then came
the addition of timer slack, which can extend sleep periods to force
multiple processes to wake at the same time.  This behavior will cause
timers to run a little longer than requested, but the result is fewer
processor wakeups and, thus, a savings of power.  In the case of a
zero-second sleep, the addition of timer slack turns an expired timer into
one that is not expired, so the calling process will, once again, be put to
sleep.
<p>
The default timer slack, at 50&micro;s, is unlikely to cause visible
changes to the behavior of most applications.  But it seems that, on some
systems, the timer slack value is set quite high - 
on the order of seconds - to get the best power behavior possible.  That
can extend the length of a zero-second sleep accordingly, leading to
misbehaving applications.
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
Matthew Garrett, working under the notion that breaking applications is
bad, submitted <a href="/Articles/482178/">a patch</a> making a
special-case for zero-second sleeps.  The idea is simple: if the requested
sleep time is zero, timer slack will not be added and the process will not
be delayed indefinitely.  The problem with this approach is that the
process will still not get the desired result: rather than yielding the
processor, it will have simply performed a useless system call and gone
right back to whatever it was doing before.  Without timer slack, a request
to sleep on an expired timer will return directly to user space without
going through the scheduler at all.
<p>
An alternative would be to transform <tt>sleep(0)</tt> into a call to
<tt>sched_yield()</tt>.  But that idea is not hugely popular with the
scheduler developers, who think that calls to <tt>sched_yield()</tt> are
almost always a bad idea.  It is better, they say, to fix the applications
to stop polling or doing whatever else it is that they do that causes
developers to think that explicitly yielding the CPU is the right thing to
do.
<p>
<a href="/Articles/482180/">According to Matthew</a>, the number of
affected applications is not tiny:
<p>
<div class="BigQuote">
	Checking through an exploded Fedora kernel tree suggests around 125
	packages out of 11000 or so, so around 1% of userspace seems to use
	sleep(0) under certain circumstances. We can probably fix
	everything in the distribution, but that suggests that there's also
	going to be a significant amount of code in the outside world
	that's also broken.
</div>
<p>
Normal practice in kernel development would be to try to avoid breaking
those applications if possible.  Even in cases where applications are
relying on undefined and undocumented behavior - certainly the case here -
it is better if a kernel upgrade doesn't turn working code into broken
code.  Some participants have suggested that the same approach should be
taken in this case.
<p>
The situation with <tt>sleep(0)</tt> is a little different from others,
though.  Application developers cannot claim a long history of working
behavior in this case, since the kernel's response to a zero-second sleep
has already changed a few times over the course of the last decade.  And,
<a href="/Articles/482197/">according to Thomas Gleixner</a>, it is hard to
know when the special case applies or what should be done:
<p>
<div class="BigQuote">
	Dammit, we cannot come up with a reasonable definition for special
	casing that stuff simply because you cannot draw a clear boundary
	what to special case and what not. And there is no sensible
	definition for what to do - return right away or go through
	schedule() or what ever.
</div>
<p>
Thomas worries that there may be calls for special cases for similar calls
- single-nanosecond calls to <tt>nanosleep()</tt>, for example - and that
the result will be an accumulation of cruft in the core timer code.  So,
rather than try to define these cases and maintain the result indefinitely,
he thinks it is better just to let the affected code break in cases where
the timer slack has been set to a large value.  And that is where the
discussion faded away, suggesting that nothing will be done in the kernel
to reduce the effect of timer slack on zero-second sleeps.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_model-User-space_ABI">Development model/User-space ABI</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#hrtimer">hrtimer</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Timers">Timers</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/482168/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor483173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2012 5:24 UTC (Thu)
                               by <b>xorbe</b> (guest, #3165)
                              [<a href="/Articles/483173/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Seems like they could just add 1ns to all incoming values, and be done with it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483269"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2012 13:43 UTC (Thu)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/483269/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Or better use something like having a slack of 10% incomming value + 1ns</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/483269/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor483270"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2012 13:55 UTC (Thu)
                               by <b>Ben_P</b> (guest, #74247)
                              [<a href="/Articles/483270/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What types of applications break when sleep(0) just returns?  sleep(0) seems like it would be used to "fix" concurrency issues in an even more naive way than sched_yield()?  <br>
<p>
I've seen so many poorly written programs "fix" concurrency problems with yields that I'm quite cynically whenever I see them in code.  Unless it's in some very primitive concurrency or IO; yields only seem to delay incorrect code from breaking.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483270/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483773"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 23:02 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/483773/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
What types of applications break when sleep(0) just returns? ...
</blockquote>
<blockquote>
I've seen so many poorly written programs "fix" concurrency problems with yields ...
</blockquote>
<p>
It seems like you've answered your own question.
<p>
I have no trouble believing that these programs you've seen worked better after sleep(0) was added than before.  Maybe it's just within a narrow field of application, but that may be the only field that matters.   You might say these programs don't deserve to keep working, even in that narrow application, but you can't deny that making sleep() a no-op would do damage there.

      
          <div class="CommentReplyButton">
            <form action="/Articles/483773/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor483511"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 0:29 UTC (Fri)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/483511/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Ideal glibc implementation of sched_yield / sleep(0):<p>

<code>
void sched_yield(void) {<br>
    fprintf(stderr, "You are a bad developer.  Go away.\n");<br>
}<br>
</code>
      
          <div class="CommentReplyButton">
            <form action="/Articles/483511/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483862"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2012 21:08 UTC (Sat)
                               by <b>nevets</b> (subscriber, #11875)
                              [<a href="/Articles/483862/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I mostly agree with you but there are a small set of legitimate uses of sched_yield(). The only real use case I can think of is a set of real time threads that are simulating its own voluntary scheduler.<br>
<p>
If you have a set of threads all at the same priority, running FIFO and pinned to the same CPU, you can use sched_yield() to put yourself behind the other threads with the same priority and let them work. I've been on one project that did this.<br>
<p>
The kernel stop_machine mechanism use to do this. It used yield() to let its other threads get the scheduler (all running highest FIFO priority). It did this method up till v2.6.26, after that, the algorithm was changed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483862/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483925"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 26, 2012 22:48 UTC (Sun)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/483925/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not too familiar with SCHED_FIFO.  But can't you use select(0, NULL, NULL, NULL, 0) to do the same thing?  System calls are cancellation points, at least.<br>
<p>
Incidentally, I was around for the cooperative multitasking days on Mac OS 6.  It was not good.  I'm sure there's some rationale for simulating that kind of thing in userspace, but a lot of times it smells like doing something in userspace that you ought to be doing in the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483925/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483962"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 27, 2012 12:21 UTC (Mon)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/483962/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
select(timeout=0)? That's just as bad as sleep(0). sched_yield() looks a lot better, and since it is also a system call, there is your cancellation point.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483962/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor484625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Short sleeps suffering from slack</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2012 13:12 UTC (Thu)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/484625/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>There are two problem cases where that's a bad implementation:
<ol>
<li>sleep(0) where the 0 is not a hard-coded constant, but the result of a time calculation. The application doesn't actually mind that the sleep takes extra time, as it's aiming to do things like "sleep until the next work item is due to start", and can cope if it's late (e.g. a task scheduler aiming to kick off work every 60 seconds - if the work takes more than 60 seconds unexpectedly, it has to cope anyway). Such an application is probably doing a calculation of the form "next start time - current time"[2] to get the sleep time.
<li>sched_yield in a SCHED_FIFO context. While the POSIX definition of sched_yield doesn't require it to be anything other than a no-op, for the specific case of SCHED_FIFO there's a good reason to implement it as "let any other runnable task of same priority as this task run"; absent such an implementation, there is no way for multiple co-operating SCHED_FIFO tasks to say "I still want the CPU, but if another task of equal priority wants the CPU, let it have it".
</ol>
<p>Note that the second case is specific to SCHED_FIFO - other scheduling algorithms will preempt a CPU-bound task if something else of same priority needs the CPU. SCHED_FIFO specifically does not allow that to happen, so you need some sensible mechanism for a task to say "I'm still CPU-bound, but this is an appropriate point to preempt me if another task needs to run".
      
          <div class="CommentReplyButton">
            <form action="/Articles/484625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor483577"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 8:16 UTC (Fri)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/483577/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; on some systems, the timer slack value is set quite high - on the order of seconds</font><br>
<p>
So the problem is not just sleep(0) then! sleep(1) might sleep several seconds too... Isn't this the first issue to fix? Who decided my sleep(1) could wait several seconds and not just the 1 I coded?<br>
<p>
To me the problem is when the sleep requested period is less than the slack value, and that's what I would fix.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483577/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483584"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 8:45 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/483584/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the owner of the system set the slack value, why should an application programmer of some random application get to override this?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483584/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483596"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 9:29 UTC (Fri)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/483596/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Problem is:<br>
* app dev says it should sleep 1 second<br>
* sys owner says if you sleep, then you may sleep for 5 seconds<br>
<p>
What do we do? Either<br>
* sleep for 1 second, as requested, or<br>
* sleep for up to 5 seconds and break the application<br>
<p>
I think this calls for a new user-space API, such as:<br>
       unsigned int sleep_slack(unsigned int seconds, unsigned int slack);<br>
<p>
But sleep's behaviour should not be changed.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483596/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 9:55 UTC (Fri)
                               by <b>tglx</b> (subscriber, #31301)
                              [<a href="/Articles/483605/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But sleep's behaviour should not be changed.</font><br>
<p>
The kernel does not change sleep() behaviour. It's the sysadmins choice to set slack to something large. The kernel provides the mechanism, but not the policy.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor483612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 10:20 UTC (Fri)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/483612/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><em>Who decided my sleep(1) could wait several seconds and not just the 1 I coded?</em></blockquote>
<p>
The person who wrote the <a href="http://pubs.opengroup.org/onlinepubs/009604599/functions/sleep.html">spec for sleep()</a>, which says, among other things:
</p>
<blockquote>
The suspension time may be longer than requested due to the scheduling of other activity by the system.
</blockquote>
<p>
So if you believe that »sleep(1)« will sleep for exactly one second, you are mistaken about how sleep() works.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/483612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">oversleeping</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 22:57 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/483771/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I think it's more basic than the documented function of sleep().  In a non-realtime timeshared OS, the OS can take several seconds from you any time it wants, whether you did a sleep() or not.  If you get to run at all, you should be grateful.


      
          <div class="CommentReplyButton">
            <form action="/Articles/483771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor483899"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 26, 2012 10:44 UTC (Sun)
                               by <b>IkeTo</b> (subscriber, #2122)
                              [<a href="/Articles/483899/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; So if you believe that »sleep(1)« will sleep for exactly one second, you are mistaken about how sleep() works.</font><br>
<p>
Nobody has any doubt about "sleep(1)" sleeping 1.01 second, or sleeping 2 whole days if the user suspended the computer.  But that's a different proposition than expecting that "sleep(1)" would regularly sleep 10 seconds in a reasonably loaded system.  As a developer, if I know that if instead it sleeps 10 seconds, my program will not behave as it should, what other options do I have?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483899/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 27, 2012 10:50 UTC (Mon)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/483951/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      That would depend on whether your program breaking when the delay is 10 seconds instead of 1 second is justifiable. If it is, you'll just have to document that the user needs to turn down the timer slack setting on their system. If it isn't, <em>fix your buggy program</em>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/483951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor483977"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 27, 2012 15:51 UTC (Mon)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/483977/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"If it is, you'll just have to document that the user needs to turn down the timer slack setting on their system."<br>
<p>
So a single systemwide knob has to be fixed by the user's sysadmin?  That doesn't seem appropriate, just to retain previous capability.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/483977/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor484011"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 27, 2012 19:05 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/484011/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
it's not a "single systemwide knob", it's a per-cgroup knob<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/484011/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor484578"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2012 5:24 UTC (Thu)
                               by <b>kevinm</b> (guest, #69913)
                              [<a href="/Articles/484578/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If your program will work correctly when sleeping one second, but not when sleeping 10 seconds, then you either have a buggy program (which is probably already failing on heavily loaded systems) or a program that should be using a real-time scheduling class.<br>
<p>
A program that calls sleep(n) must already expect to sleep for at least n seconds.  The timer-slack is just making these bugs more visible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/484578/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor485001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2012 2:05 UTC (Sat)
                               by <b>IkeTo</b> (subscriber, #2122)
                              [<a href="/Articles/485001/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Say I want to create a stop-watch application, the user specify a number of seconds to wait until an alert is shown, and meanwhile the stop watch will keep displaying the amount of time remaining, in seconds intervals.  No user care if our display is updated 0.1 second too late, so the original sleep works perfectly.  There is no need of "real-time scheduling class" requirement.<br>
<p>
With the timer slack, all at a sudden users will see the timer being updated once fifteen seconds, and the final alert also late similarly.  No user will miss such a "bug".<br>
<p>
Now what option do I have?<br>
<p>
1. I can ask the user to setuid root the program so that the program can use real-time scheduling, hoping that they have root privileges, and making every security sensitive user to raise their eyebrow.<br>
<p>
2. I can ask the user to change the cgroup wide timer slack value, hoping that they have root privileges, and making the whole system wasting energy for all the time before the user/admin remember to reset the timer slack value, because they are now sleeping more than they do optimally.<br>
<p>
3. I can stop sleeping at all, and instead use a busy loop with a very high nice level.  Seems very drastic, waste a processor, waste power, make system load 1, but in a sense it is the best solution because it only affect the system for as long as the stop watch runs, and do not need root privileges.<br>
<p>
How's that sound?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/485001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor485680"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2012 17:22 UTC (Wed)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/485680/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>4. Write your program with a client/daemon architecture. The daemon can be activated as root by the system's daemon-managing services, then drop its privileges once it has given itself a real-time scheduling class. The client connects to the daemon via a socket, then sits in a blocking read() waiting for the once-a-second heartbeat packets from the daemon. If the daemon doesn't currently have any clients, it can just sit in a blocking accept() call until one shows up.</p>
<p>Admittedly this stops people on machines they don't administer from installing and using your application. However, if the user isn't trusted to have administrative access to the system, they probably shouldn't be self-installing applications that require policy violations to work as expected anyway.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/485680/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor486015"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2012 8:41 UTC (Fri)
                               by <b>Thomas</b> (subscriber, #39963)
                              [<a href="/Articles/486015/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Using a timer?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/486015/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor483611"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2012 10:26 UTC (Fri)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/483611/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>Who decided my sleep(1) could wait several seconds and not just the 1 I coded?</blockquote>
<p>Linus, by virtue of deciding in 1991 that his new kernel would be an ordinary preemptively multitasking kernel, rather than something more exotic. sleep() has <em>always</em> had the property on Unix-like OSes that your process might sleep <em>longer</em> than you expect.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/483611/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor484668"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Are we really chasing the right issue?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2012 13:29 UTC (Thu)
                               by <b>slashdot</b> (guest, #22014)
                              [<a href="/Articles/484668/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The timer slack must be at most around 1-10ms if the system is supposed to correctly run arbitrary software.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/484668/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2012, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
