        <!DOCTYPE html>
        <html lang="en">
        <head><title>Missing the AF_BUS [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/504970/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/504035/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/504970/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Missing the AF_BUS</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 3, 2012</br>
           </div>
The <a href="http://www.freedesktop.org/wiki/Software/dbus">D-Bus</a>
interprocess communication mechanism has, over the years, become a standard
component of the Linux desktop.  For almost as long, developers have been
trying to find ways to make D-Bus faster.  The latest attempt comes in the
form of a kernel patch set adding a new socket address family (called
<tt>AF_BUS</tt>) to the networking layer.  Significant performance
improvements are claimed, but, like previous attempts, this one may have a
hard time getting into the mainline kernel.
<p>
D-Bus implements a mechanism by which processes can send messages to each
other.  Multicast functionality is inherently a part of the protocol; one message can be
sent to multiple recipients.  D-Bus promises reliable delivery, where
"reliable" means that
messages arrive in the order in which they were sent and multicast messages
will either be delivered to all recipients or, if that is not possible, to
none.  There is a security model built into the protocol whereby messages
can be limited to specific recipients.  All of these features are used by
contemporary systems, which expect the system to be robust, secure, and
with as little latency and overhead as possible.
<p>
The current D-Bus implementation uses Unix-domain sockets and a central
routing daemon.  It works, but the routing daemon adds context switches,
overhead, and latency to each message it handles.  The kernel is unable to
help get high-priority messages delivered first, so all messages cause
wakeups that slow down the processing of the most important ones; see <a
href="/Articles/504984/">this message</a> for a description of how these
problems can affect a running system.  It has
been evident for some time to the developers involved that a better
solution must be found.
<p>
There have been a number of attempts in that direction.  The previous time
this topic came up, it was around <a href="/Articles/484203/">a set of
patches</a> adding multicast capabilities to Unix-domain sockets.  This
idea was rejected with the claim that the Unix-domain socket code is
already too complicated and there was not enough justification to make
things worse by adding multicast capabilities.  The D-Bus developers were
told to simply use IPv4 sockets, which already have multicast support,
instead.
<p>
What those developers actually did was to implement <a
href="/Articles/504722/">AF_BUS</a>, a new address family designed to meet
the needs of D-Bus.  It provides the reliable delivery that D-Bus requires;
it also has the ability to pass file descriptors and credentials from one
process to another.  The security mechanism is built in, with the netfilter
code (augmented with a new D-Bus message parser)  used to control which
messages can actually be delivered to any 
specific process.  The end result, it is claimed, is a significant
reduction in D-Bus overhead due to reduced system calls; submitter Vincent
Sanders claims "<q>a doubling in throughput and better than halving of
latency.</q>"  See <a href="/Articles/504988/">the associated
documentation</a> for details on how this address family works.
<p>
A factor-of-two improvement in a component that is widely used in Linux
systems would certainly be welcome.  The patch set, however, was not;
networking maintainer David Miller immediately <a
href="/Articles/504977/">stated his intention</a> to simply ignore the
patch set entirely.  His objections seem to be that IPv4 sockets are
sufficient for the task and that reliable delivery of multicast messages
cannot be done, even in the limited manner needed by D-Bus.  He expressed
doubts that the IPv4 approach had even been tried, and <a
href="/Articles/504978/">decreed</a>: "<q>We are not creating a full
address family in the kernel which exists for one, and only one, specific
and difficult user.</q>" 

<p>
Vincent <a href="/Articles/504979/">responded</a> that a number of
approaches have been tried and found wanting.  IPv4 sockets cannot provide
the needed delivery guarantees and do not allow for the passing of file
descriptors and credentials.  It is also important, he said, for D-Bus to
be up and running before the networking subsystem has been configured;
setting up IP interfaces on a contemporary system often requires
communication over D-Bus.  There really is no better solution, he said.
<p>
He found support from a few other developers, including <a
href="/Articles/504980/">Alan Cox</a>, who pointed out that there is no
shortage of interprocess communication systems out there with requirements
similar to D-Bus:
<p>
<div class="BigQuote">
	In fact if you look up the stack you'll find a large number of
	multicast messaging systems which do reliable transport built on
	top of IP. In fact Red Hat provides a high level messaging cluster
	service that does exactly this. (as well as dbus which does it on
	the desktop level) plus a ton of stuff on top of that (JGroups etc)
<p>
	Everybody at the application level has been using these 'receiver
	reliable' multicast services for years (Websphere MQ, TIBCO, RTPGM,
	OpenPGM, MS-PGM, you name it). There are even accelerators for PGM
	based protocols in things like Cisco routers and Solarflare can do
	much of it on the card for 10Gbit.
</div>
<p>
He added that latency concerns are paramount on contemporary systems and
that one of the best ways of reducing latency is to cut back on context
switches and middleman processes.  Chris Friesen <a
href="/Articles/504981/">added</a> that his company uses "<q>an
out-of-tree datagram multicast messaging protocol family based on
AF_UNIX</q>" that could almost certainly be replaced by something like
<tt>AF_BUS</tt>, were <tt>AF_BUS</tt> to be added to the mainline kernel.
<p>
There have been various other local messaging patch sets posted over the
years.  So it seems clear that there is a significant level of interest in
having this sort of capability built into the Linux kernel.  But interest
alone is not sufficient justification for the merging of a large patch set;
there must also be agreement from the developers who are charged with
ensuring that Linux has a top-quality networking stack in the long term.
That agreement is not yet there, so there may be a significant amount of
multicast interpersonal messaging required before we have multicast
interprocess messaging in the kernel.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#D-Bus">D-Bus</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Message_passing">Message passing</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking-D-Bus">Networking/D-Bus</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/504970/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor505225"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 4:39 UTC (Thu)
                               by <b>hp</b> (guest, #5220)
                              [<a href="/Articles/505225/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Do keep in mind that there are a number of avenues to improve D-Bus in userspace as well; I'm mystified why so much effort has gone into kernel changes and near zero into userspace:<br>
<a href="http://lists.freedesktop.org/archives/dbus/2012-March/015024.html">http://lists.freedesktop.org/archives/dbus/2012-March/015...</a><br>
<p>
but in any case the opportunity is there. My belief is that nobody is chasing this because for the vast majority of people D-Bus performance is not an actual problem. When I've asked for concrete examples of when it was a problem, things like Nokia N900 (iPhone 3G era hardware right?) come up, and poorly coded applications aren't ruled out and seem likely to be involved even in that case.<br>
<p>
basically there is just no need to performance tune the kind of stuff dbus is normally used for on a stock Linux desktop... if something is only 1% of user-visible speed, making it double fast isn't perceptible. <br>
<p>
people do show up on the mailing list using dbus on low resource embedded systems and needing ultra low latency or something, but in those cases dbus was pretty clearly a poor choice of hammer for the nail at hand.<br>
<p>
I don't think Alan is wrong though. the dbus semantics and guarantees that make it slow are also what make it convenient, and app developers generally want those guarantees and apps are less buggy if they have them. So it might be nice to make this genre of thing fast, even if the simple notifications etc. used by the desktop aren't performance critical, there are other domains that might benefit from ordered, reliable delivery, lifecycle tracking, etc. there's no question a faster implementation of dbus would be more broadly useful beyond just the desktop. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505225/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 5:32 UTC (Thu)
                               by <b>hp</b> (guest, #5220)
                              [<a href="/Articles/505235/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also it's worth noting again that the design tradeoffs in dbus are almost all copied from X11. Messages between two processes are guaranteed to stay in the order sent, network errors are handled by just disconnecting and starting over, there's a central server that all the apps use to talk to each other, it's a binary protocol, there's a "selection" (bus name) concept used to acquire/release/locate resources, similar authentication mechanisms, server is located via environment variable, blocking round trips are discouraged (mechanisms are provided to avoid them), people use both almost exclusively on same-machine or at least a LAN, etc.<br>
<p>
So most problems and solutions that apply to X11 will also apply to dbus.<br>
<p>
I think the tradeoffs and guarantees made here are a pretty good guide to what desktop/mobile app developers want when they're writing a UI that's implemented as a "swarm of processes" (as all the X desktops are). Framed another way, this is what a local IPC system has to provide in order to support relatively reliable application code in this context. However, these tradeoffs are probably inappropriate for systems distributed over the internet or even over a cluster.<br>
<p>
Based on dbus list traffic there seem to be development situations where similar tradeoffs make sense but the inherent slowdown of the central dispatch daemon is a problem. That's where kernel-accelerated dbus-like-thing would make sense maybe.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505287"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 9:17 UTC (Thu)
                               by <b>kyllikki</b> (guest, #4370)
                              [<a href="/Articles/505287/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Concerning your comments on userspace D-Bus improvements. Collabora employ one of the upstream D-Bus maintainers and pay for some of their time to work on D-Bus. <br>
<p>
We most definitely are committed to improving the userspace side of D-Bus in addition to the kernel work (which was a project for the GENIVI alliance) <br>
<p>
Our eventual aim using all the solutions is for a tripling in throughput and a significant reduction of latency for the general case.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505287/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505294"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 10:33 UTC (Thu)
                               by <b>smcv</b> (subscriber, #53363)
                              [<a href="/Articles/505294/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; poorly coded applications aren't ruled out</font><br>
<p>
On the system bus, which is a trust boundary, poorly- or even maliciously-coded applications can never be ruled out, unfortunately.<br>
<p>
<font class="QuotedText">&gt; in those cases dbus was pretty clearly a poor choice of hammer for the nail at hand</font><br>
<p>
People consider D-Bus to be a suitable transport for all sorts of things, desktop or not. The first sentence of the specification describes it as "a system for low-latency, low-overhead, easy to use interprocess communication", which probably contributes to the view that it's the right hammer for every nail - in practice, its current design tradeoffs tend to prioritize "easy to use" over low-latency.<br>
<p>
Improving its latency, and avoiding priority inversion between the dbus-daemon and its clients, certainly increases the number of situations where D-Bus can be used. They might not be necessary for "the desktop bus", but that's by no means the only thing people use D-Bus for.<br>
<p>
Improving the kernel-level transport is orthogonal to improving the user-space part (of which message (de)serialization is indeed likely to be the lowest-hanging fruit), and there's no reason they can't both happen.<br>
<p>
<font class="QuotedText">&gt; the dbus semantics and guarantees that make it slow are also what make it convenient</font><br>
<p>
I absolutely agree that the convenient semantics - multicast signals, total ordering, conventions for lifecycle tracking and so on - are what make D-Bus valuable, and if you're willing to sacrifice those convenient semantics for performance, that's a sign that D-Bus is not right for you. Having said that, given the constraints of those semantics, the more efficient the better, and AF_BUS proves that there is room for improvement.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505294/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505331"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 13:01 UTC (Thu)
                               by <b>hp</b> (guest, #5220)
                              [<a href="/Articles/505331/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; poorly- or even maliciously-coded applications can never be ruled out,</font><br>
<font class="QuotedText">&gt; unfortunately</font><br>
<p>
What I meant here was, an app with lots of round trips in its protocol design or that shovels loads of data over the bus is going to be a perf problem. As a practical matter if you have user-visible situation xyz that appears slow, fixing dorky app behavior can be the fastest way to fix xyz.<br>
<p>
<font class="QuotedText">&gt; there's no reason they can't both happen</font><br>
<p>
That's why I keep lobbying for the userspace changes to happen - a couple of them looked like they'd only take a few days of work. Hey, for all I know, someone did them already over the last few months. Anyway it's just bugging me (as you've no doubt gathered) that the kernel stuff is a kind of multi-year undertaking due to the difficult political issues, while the performance could be greatly improved without blocking on kernel devs...<br>
<p>
So I'm just trying to give the potential userspace tasks some PR. Maybe someone reading these comments will want to work on them, we can dream...<br>
<p>
(I know I'm telling those close to dbus things they already know. But it may not be apparent to those who aren't close to it that there's stuff they could do today.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505331/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor505416"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 17:15 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/505416/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Apparently people now try to do some things across DBus that require a higher data rate and lower latency than the traditional "huh, somebody plugged in a USB stick / wants root for aptitude/yum / left fpr lunch" events DBus handled in the past.<br>
<p>
Newfangled stuff like multi-touch. Or keyboard input (for Chinese and whatnot).<br>
<p>
You don't want that stuff to go through more context switches (and processes) than strictly necessary. So AF_BUS seems to be a Good Thing.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505416/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 19:26 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/505449/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems to me like the right solution for a lot of the low-latency or high-throughput applications is actually to send a socketpair endpoint over DBus, rather than using DBus for the actual data. Provided, of course, that that works. If nothing else, it would be very much worthwhile to save the packet framing when you have a logical data stream, and it's hard to beat a scheme where your Chinese user input can be turned into stdin with nothing more than dup2 and inherited by child processes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505456"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 19:53 UTC (Thu)
                               by <b>hp</b> (guest, #5220)
                              [<a href="/Articles/505456/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yep. You can even use the dbus protocol over that socketpair. libdbus could probably provide some nice convenience API to facilitate this where you'd basically get a DBusConnection back from a method call to the remote service.<br>
<p>
The downside is mostly that it's a fair bit more work for apps to do stuff like this. Services don't necessarily need to track "registered clients" right now but with this kind of setup they have to, in addition to dealing with the raw sockets and other extra work.<br>
<p>
A lot of the discussion of speeding up dbus is motivated by trying to make the easy thing work well for apps, instead of requiring app authors to sort out these tradeoffs.<br>
<p>
Especially with the higher-level API in say glib's dbus support, though, it might be possible to near-automatically put certain objects on dedicated sockets. Just a matter of programming...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505456/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 5:51 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/505519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be nice to be also able to use DBUS over the network. If you stick to DBUS-only protocol then it's not a problem.<br>
<p>
But the minute you start using socketpairs - it becomes impossible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505521"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 6:24 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/505521/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
socketpair-ing the sender and recipient would probably work, but it has a few downsides.<br>
<p>
* you lose the easy debugging and monitoring you now get with DBus (presumably, with AF_BUS you could use something like wireshark),<br>
<p>
* the client now has to juggle multiple file descriptors, that requires an API change<br>
<p>
* multiple file descriptors and reliable message ordering don't mix<br>
<p>
Too many downsides if you ask me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505521/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 6:58 UTC (Fri)
                               by <b>Fowl</b> (subscriber, #65667)
                              [<a href="/Articles/505526/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Surely libdbus could handle this all automatically?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505590"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 16:18 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/505590/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The multiple-file-descriptors problem is the killer,<br>
<p>
dbus_connection_get_unix_fd() returns exactly one file descriptor. If you open a direct connection to some application, you have more than one file descriptor. How do you make your application select()/poll() on both (or more) of these?<br>
Admittedly, on second thought, you could do it with epoll(). But it's still a change in semantics (you can't read from that file descriptor; worse, you can't write to it).<br>
<p>
How would you propose to handle the monitoring problem? Let the daemon send a "somebody's listening for messages X, so if you exchange any of those privately, kindly send me a copy" commands to each and every client? Owch.<br>
<p>
I'm not saying this cannot be done. I'm saying it's heaps more work, and more fragile, than simply moving the main chunk of this into the kernel, especially since there's already code which does that. And code is more authoritative than English.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505590/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor505595"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 17:32 UTC (Fri)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/505595/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think I was unclear: I'm not suggesting that DBus do some sort of socketpair thing to provide high-speed dbus links; I'm suggesting that use cases that don't really care about DBus, but need to negotiate with another program for their input, could get back to their normal operation (input from a fd) by having the other side send a fd back when it's all set up. That is, user input doesn't normally go over DBus, so applications are already designed around a non-DBus input path; even if you need IPC to set up your input device appropriately, it doesn't make too much sense to get user input over DBus, particularly if you can't get corresponding user input over DBus if the system doesn't have Chinese input or multi-touch.<br>
<p>
Of course, it's certainly possible that people will want high-speed IPC with DBus properties also, and it makes sense for DBus to be efficient regardless of whether it's running into performance constraints. But it doesn't make sense to use DBus for all communication, even if its performance could be made good enough.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505595/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor508327"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2012 22:41 UTC (Thu)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/508327/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; When I've asked for concrete examples of when it was a problem, things like Nokia N900 (iPhone 3G era hardware right?) come up</font><br>
<p>
One of the worst issues is D-BUS message delivery reliability.  All it needs is an app that subscribes for some frequent message (like device orientation) and then doesn't read its messages either because it was supended or just buggy.  As message delivery needs to be reliable, D-BUS will then just buffer the messages and get all the time slower and slower as it starts to swap.<br>
<p>
Second issue is too complicated D-BUS setup.  I think e.g. the N900 call handling goes through half a dozen daemons before the call UI pops up.  Each of these steps adds it's own socket buffering and process scheduling overhead in addition to other overheads (e.g. paging the processes in to RAM if they were swapped out etc).<br>
<p>
Then there's the D-BUS daemon code itself.  Ever wondered why something that's "just" supposed to read and write data from sockets is CPU bound instead of IO bound?  D-BUS daemon spends a lot of CPU on message content marshaling.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/508327/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor508333"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2012 22:57 UTC (Thu)
                               by <b>hp</b> (guest, #5220)
                              [<a href="/Articles/508333/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the tradeoffs in the first issue can be configured in the config<br>
file, it can throw errors when the buffer size is whatever you like. there are also some list/bug discussions of other behaviors that could be useful to support. <br>
<p>
the second issue is not dbus's fault. that kind of thing is often from making a daemon when a library would be better. it's a bug in the app design.<br>
<p>
the third issue I've mentioned repeatedly myself including in the threads I linked before. <br>
<p>
but none of these three thing are concrete examples of user visible operations. in most real world cases all three of these problems are gotten away with and it isn't perceptible. n900 is the most often mentioned case where they aren't and if you're correct here, N900 has at least one really bad setup with half a dozen daemons. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/508333/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor505232"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 4:55 UTC (Thu)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/505232/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      I can't help but feel David Miller's response is a tad hypocritical :(
<p>After all, he was the one who practically shoved a new address family (<tt>AF_ALG</tt>) down the throats of the community as a &ldquo;solution&rdquo; to connecting kernel crypto with userspace&mdash;said solution being such a poor fit that it isn't being used anywhere, but stifling any opportunity to integrate an actually suitable solution.
<p>
<em>(Yes, this is my personal hurtful spot, and I am grumpy.)</em>
      
          <div class="CommentReplyButton">
            <form action="/Articles/505232/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 5:47 UTC (Thu)
                               by <b>daniel</b> (guest, #3181)
                              [<a href="/Articles/505240/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Dave seems to be labouring under the misapprehension that his TCP stack is efficient. It isn't. It is a big rambling, inefficient pile of spaghetti.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 6:00 UTC (Thu)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/505242/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      In Dave's defense will note that the Linux TCP stack does appear to be extremely efficient compared to other OS'es&hellip; It's just not always the perfect hammer for the screws you may be using.
      
          <div class="CommentReplyButton">
            <form action="/Articles/505242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 6:10 UTC (Thu)
                               by <b>daniel</b> (guest, #3181)
                              [<a href="/Articles/505244/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Then the others must suck even more, but the Linux TCP stack still sucks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505418"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 17:10 UTC (Thu)
                               by <b>jond</b> (subscriber, #37669)
                              [<a href="/Articles/505418/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's the quality of discourse that keeps me coming back to LWN.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505418/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 7, 2012 1:40 UTC (Sat)
                               by <b>daniel</b> (guest, #3181)
                              [<a href="/Articles/505724/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Good point. But what exactly is the correct technical response to an argument of the form "it's ok if we suck because somebody else sucks even worse". Never mind that that premise is stated without support, whereas the premise that the Linux TCP stack is a big pile of spaghetti is easily verified.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor506637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 13, 2012 5:43 UTC (Fri)
                               by <b>Tov</b> (subscriber, #61080)
                              [<a href="/Articles/506637/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Easy! Instead of waving your hand and present your unfounded opinion, you present some facts...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor506784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 15, 2012 7:55 UTC (Sun)
                               by <b>philomath</b> (guest, #84172)
                              [<a href="/Articles/506784/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How easy? can you just give me a starter, please?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor505439"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 18:26 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/505439/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Would you mind providing (links to) more information, for people interested in learning about the purported inefficiencies in Linux's TCP stack?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505439/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505578"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 15:03 UTC (Fri)
                               by <b>pspinler</b> (subscriber, #2922)
                              [<a href="/Articles/505578/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure if linux's tcp stack is inefficient or not compared to other tcp stacks, but the networking stack is certainly is complex and multi-layered.  Consider all the basic tcp protocol code (reliability, packet frag and reassembly, etc), then layer on top netfilter, underneath it routing logic, the ip stack, and etc, and it's easy to construct packets that go through possibly significant code paths.<br>
<p>
Certainly all that complexity can't be great for performance.<br>
<p>
It's the argument I make for fibre channel v. iscsi.  It's true that iscsi hardware (being just standard networking stuff) is a lot cheaper and does the job 90-95% of the time.  But in the edge case, especially w.r.t latency, fibre still wins, largely because it's simple in comparison.<br>
<p>
-- Pat<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505578/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 2:35 UTC (Mon)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/505888/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Certainly all that complexity can't be great for performance.</font><br>
<p>
That's something worth testing, scientifically.<br>
<p>
<font class="QuotedText">&gt; It's the argument I make for fibre channel v. iscsi. It's true that iscsi hardware (being just standard networking stuff) is a lot cheaper and does the job 90-95% of the time. But in the edge case, especially w.r.t latency, fibre still wins, largely because it's simple in comparison.</font><br>
<p>
One thing about this example that I would like to point out.  FC implements much of the features of Ethernet and TCP/IP ... differently, so in that sense the complexity is at least comparable though probably not equal.  As far as the implementation complexity I think that FC can get off easier because as a practical matter it is used in closed networks often with all components from the same vendor.  Ethernet and TCP/IP have to deal with a lot more varied equipment and varied networks and have to be battle tested against _anything_ happening, all that extra implementation complexity has a real reason for being there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor505913"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 6:02 UTC (Mon)
                               by <b>daniel</b> (guest, #3181)
                              [<a href="/Articles/505913/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'll have to tell you about it, because the actual code is buried deep in somebody's trading engine and they would likely take issue with me posting it on the web. Profiling turned up some really bad CPU bumps in places you would not immediately suspect, like UDP send, which was taking nearly a microsecond per packet more than it should. I thought there would actually be some deep reason for that, but when I dug in I found that the reason was just sloppy, rambling code, pure and simple. I straightened it all out and cut the CPU overhead in half, consequently reducing the hop latency by that amount. I went on to analyze the rest of the stack to some extent and found it was all like that. You can too, all you need to do is go look at the code.<br>
<p>
Here's a lovely bit:<br>
<p>
<a href="http://lxr.linux.no/#linux+v3.4.4/net/ipv4/tcp_output.c#L796">http://lxr.linux.no/#linux+v3.4.4/net/ipv4/tcp_output.c#L796</a><br>
<p>
This is part of a call chain that goes about 20 levels deep. There is much worse in there. See, that stuff looks plausible and if you listen to the folklore it sounds fast. But it actually isn't, which I know beyond a shadow of a doubt.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505913/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 6:53 UTC (Mon)
                               by <b>daniel</b> (guest, #3181)
                              [<a href="/Articles/505918/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Here's a better example:<br>
<p>
<a href="http://lxr.linux.no/#linux+v3.4.4/net/ipv4/ip_output.c#L799">http://lxr.linux.no/#linux+v3.4.4/net/ipv4/ip_output.c#L799</a><br>
<p>
This code just kills efficiency by a thousand cuts. There is no single culprit, it is just that all that twisting and turning, calling lots of little helpers and layering everything through an skb editing API that successfully confuses the optimizer adds up to an embarrassing amount of overhead. First rule to remember? Function calls are not free. Not at the speeds networks operate these days.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505924"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 8:18 UTC (Mon)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/505924/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, predicted function calls *are* nearly free on modern CPUs. Of course, function calls stuck deep inside conditionals are less likely to be successfully predicted as taken -- and unpredicted/mispredicted function calls (like all other mispredicted, non-speculated branches) are expensive as hell. However, these days I don't believe there is much more reason to be concerned about function calls than there is to be concerned about any other conditional. (Specialists in deep x86 lore, which I am very much not and who I am merely reiterating from dim and vague memory, are welcome to contradict me, and probably will!)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505924/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor506062"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 23:06 UTC (Mon)
                               by <b>daglwn</b> (guest, #65432)
                              [<a href="/Articles/506062/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The call is cheap.  The saving/restoring of registers and lost optimization opportunities are not.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506062/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor506021"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 18:40 UTC (Mon)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/506021/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;This code just kills efficiency by a thousand cuts. There is no single culprit, it is just that all that twisting and turning, calling lots of little helpers...</font><br>
<p>
Much of the complexity of that function has to do with kernel support for fragmented skbs, which is required for packets that are larger than the page size.  That is the sort of thing that would go away if the kernel adopted a kernel page size larger than the hardware page size in cases where the latter is ridiculously small.<br>
<p>
I am not sure what the real benefits are of managing everything in terms of 4K pages is on a system with modern memory sizes.  Perhaps the idea of managing everything in terms of 64K pages (i.e. in groups of 16 hardware pages) could be revisited.  That would dramatically simplify much of the networking code, because support for fragmented skbs could be dropped.  No doubt it would have other benefits as well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506021/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor505930"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 9:11 UTC (Mon)
                               by <b>gioele</b> (subscriber, #61675)
                              [<a href="/Articles/505930/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I straightened it all out and cut the CPU overhead in half, consequently reducing the hop latency by that amount. I went on to analyze the rest of the stack to some extent and found it was all like that. You can too, all you need to do is go look at the code.</font><br>
<p>
<font class="QuotedText">&gt; This is part of a call chain that goes about 20 levels deep. There is much worse in there. See, that stuff looks plausible and if you listen to the folklore it sounds fast. But it actually isn't, which I know beyond a shadow of a doubt.</font><br>
<p>
Don't you have some notes, implementation ideas or performance tests that you want to share with the rest of the kernel community? I'm pretty sure that they would love to hear how to cut in half the CPU overhead of UDP messages without regressions in functionalities.<br>
<p>
This kind of impact would surely reduce the battery consumption of mobile applications, so, maybe the main developers will not interested, but devs of mobile-oriented forks like Android will surely be.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505930/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor506035"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 9, 2012 20:26 UTC (Mon)
                               by <b>butlerm</b> (subscriber, #13312)
                              [<a href="/Articles/506035/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I should add that fragmented skbs are used for zero copy support too, so if the idea is to simplify the networking stack by dropping them, zero copy would be out.  On the other hand, zero copy seems to be usable for sendfile() and not much else, so that doesn't sound like much of a loss if it improves the much more common case.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506035/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor505234"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 5:09 UTC (Thu)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/505234/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I wonder whether this effort can somehow be made useful for a saner version of the Android binder code as well&hellip;
      
          <div class="CommentReplyButton">
            <form action="/Articles/505234/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 10:50 UTC (Thu)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/505307/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; and that reliable delivery of multicast messages cannot be done, even in the limited manner needed by D-Bus</font><br>
<p>
I, too, was wondering how they (D-Bus) [expect to] achieve this...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor505337"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 13:11 UTC (Thu)
                               by <b>hp</b> (guest, #5220)
                              [<a href="/Articles/505337/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
People probably define some of the words (maybe one or more of "reliable delivery", "limited manner", "multicast") differently, and if they sat down to hash it out this debate would come down to people talking about different things.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505337/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505493"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2012 23:52 UTC (Thu)
                               by <b>Tester</b> (guest, #40675)
                              [<a href="/Articles/505493/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In kernel dbus, when the sender wants to send a message to N recipients, it first checks that there is space in the queue for each recipient. If there is, it puts the message there. If there isn't, then it returns an error. It's that simple.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505493/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor505513"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 4:45 UTC (Fri)
                               by <b>mgalgs</b> (guest, #85461)
                              [<a href="/Articles/505513/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Couldn't it still be a kernel module that dbus could use optionally?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505513/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor505564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Kernel module</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 6, 2012 12:42 UTC (Fri)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/505564/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It works, but the routing daemon adds context switches, overhead, and latency to each message it handles.</font><br>
<p>
Why not instead convert the dbus daemon into a kernel module, like has been done in the past with the http daemon? It would avoid having to context switch to and from the daemon, and need no changes to the networking subsystem.<br>
<p>
Note: I am joking.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/505564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor506125"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2012 9:59 UTC (Tue)
                               by <b>Hugne</b> (guest, #82663)
                              [<a href="/Articles/506125/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"so there may be a significant amount of multicast interpersonal messaging required before we have multicast interprocess messaging in the kernel."<br>
<p>
It's there already, with reliable delivery..  modprobe tipc.<br>
<p>
It does not pass SCM_RIGHTS or FD's, but a patchset that does this for node-local TIPC messaging will probably gain more acceptance than a new AF..<br>
<p>
I asked on netdev if they had considered this, but i never saw a reply why they didn't choose it.<br>
<p>
<p>
<p>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506125/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor506130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 10, 2012 10:55 UTC (Tue)
                               by <b>nhippi</b> (subscriber, #34640)
                              [<a href="/Articles/506130/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is rather depressing that the kernel people refuse to include in-kernel support for either of the extremely widely used Linux IPC systems: binder and d-bus.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor506449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 12, 2012 5:28 UTC (Thu)
                               by <b>slashdot</b> (guest, #22014)
                              [<a href="/Articles/506449/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why is a bus even needed?<br>
<p>
Make it so that the server creates a UNIX socket with the same it wants to take, and the client connects to it.<br>
<p>
One of those could be an enumeration/activation/etc. server (but not a message router!).<br>
<p>
For multicast, do the same and connect to all message broadcasters, using inotify to notice when new ones come up; the publisher just sends to all connected clients.<br>
<p>
ZeroMQ can automate most of this, if desired.<br>
<p>
The only kernel support that might be needed is support for having unlimited size Unix socket buffers and charging that memory to the receiver, so that the OOM killer/rlimit/etc. kills a non-responsive multicast receiver rather than the sender.<br>
<p>
A more sophisticated solution that doesn't duplicate the socket buffer for each subscriber would be even better, but probably doesn't matter for normal usage cases.<br>
<p>
Alternatively, get rid of signals, and instead have a key/value store abstraction where you can subscribe to value updates: this way, if the buffer space is full, you can just end an "overflow" packet and the client manually asks for the values of all its watched keys.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor506451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 12, 2012 5:57 UTC (Thu)
                               by <b>michelp</b> (guest, #44955)
                              [<a href="/Articles/506451/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is an effort to put ZeroMQ in the kernel as well.<br>
<p>
<a rel="nofollow" href="https://github.com/250bpm/linux/">https://github.com/250bpm/linux/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor506453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 12, 2012 6:31 UTC (Thu)
                               by <b>michelp</b> (guest, #44955)
                              [<a href="/Articles/506453/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess I should point out it's also going about it by implementing a protocol family similar to AF_BUS.  Why can't we have d-bus and more?  There are plenty of useful patterns out there and many available protocol family constants.  If it's well tested and performant and cleanly coded, then why reject it?  Is't that the purpose of having extensible protocol families?  It's not like it's going to screw up any existing code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor506454"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 12, 2012 6:57 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/506454/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don't under-estimate the maintenance burden of adding more code.<br>
<p>
It is true that we seem to add filesystems with gay abandon so maybe a similar case could be added for address families...<br>
<p>
The reason that I would avoid adding multiple address families for IPC is that someone would want a mix of features from one and features from another (e.g. multicast and fd passing from AF_INET and AF_UNIX).  So would we add yet another one that does both?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506454/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor506516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Missing the AF_BUS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 12, 2012 15:02 UTC (Thu)
                               by <b>michelp</b> (guest, #44955)
                              [<a href="/Articles/506516/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Don't under-estimate the maintenance burden of adding more code.</font><br>
<p>
Can you give me an example of who is burdened by what exactly in this case?<br>
<p>
<font class="QuotedText">&gt; The reason that I would avoid adding multiple address families for IPC is</font><br>
<font class="QuotedText">&gt; that someone would want a mix of features from one and features from</font><br>
<font class="QuotedText">&gt; another (e.g. multicast and fd passing from AF_INET and AF_UNIX). So</font><br>
<font class="QuotedText">&gt; would we add yet another one that does both?</font><br>
<p>
That seems like a speculative reason to reject existing and well established software patterns like d-bus, that are correctly leveraging a well established extension mechanism for adding new protocol families.  Again, if it wasn't meant to be extended, then why have protocol families at all?  Why was the 'sk is first member of the struct' pattern so well thought out from the beginning?  It was done this way to provide ways for the mechanism to grow and evolve.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/506516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2012, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
