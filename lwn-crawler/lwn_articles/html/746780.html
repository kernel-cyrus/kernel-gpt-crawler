        <!DOCTYPE html>
        <html lang="en">
        <head><title>Shrinking the kernel with an axe [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/746780/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/746879/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/746780/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Shrinking the kernel with an axe</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="GAByline">
           <p>February 8, 2018</p>
           <p>This article was contributed by Nicolas Pitre</p>
           </div>
<p>This is the third article of a series discussing various methods of
reducing the size of the Linux kernel to make it suitable for small
environments. The <a href="/Articles/741494/">first article</a>
provided a short rationale for this topic, and covered link-time
garbage collection.  The
<a href="/Articles/744507/">second article</a> covered link-time
optimization (LTO) and compared its results to link-time garbage
collection. In this article we'll explore ways to make LTO more
effective at optimizing kernel code away, as well as more assertive
strategies to achieve our goal.

<h4><a name="_kernel_module_carving"></a>Kernel module carving</h4>

<p>Many kernel drivers start by allocating memory and registering stuff;
then they sit
there waiting until something they're responsible for happens, if ever.
So the first course of action to reduce our kernel size is
to make things into modules. This way some code can sit on the
filesystem
until it is actually needed.

<p>Let's pick up the same kernel config and build environment as the one
from the previous article, and reduce it by carving out some modules. We
start with:

<p><pre>
    $ make stm32_defconfig
    $ make vmlinux
    $ size vmlinux
       text    data     bss     dec     hex filename
    1704024  144732  117660 1966416  1e0150 vmlinux</pre>


<p>Now let's enable module support and turn a couple things into modules:

<p><pre>
    $ ./scripts/config --enable MODULES
    $ ./scripts/config --module INPUT
    $ ./scripts/config --module I2C
    $ ./scripts/config --module NLS
    $ ./scripts/config --module CRYPTO
    $ make olddefconfig
    $ make &amp;&amp; size vmlinux
       text    data     bss     dec     hex filename
    1738586  137296  109180 1985062  1e4a26 vmlinux</pre>


<p>This is bad. Despite the <tt>.data</tt> and <tt>.bss</tt> sections
becoming 7,436 and 8,480 bytes smaller, respectively, the <tt>.text</tt>
segment is now 34,562 bytes larger despite a couple drivers being removed
from the core kernel. Is the module support code that big?

<p><pre>
    $ size kernel/module.o
     text    data     bss     dec     hex filename
    12452     248      77   12777    31e9 kernel/module.o
</pre>

<p>
So module support itself is only 12,452 bytes of text.
Extra code for module support is expected, however there are still
22,110 additional bytes that appeared from somewhere. Could LTO help here?

<p><pre>
    $ ./scripts/config --enable LTO_MENU
    $ make &amp;&amp; size vmlinux
       text    data     bss     dec     hex filename
    1653358  137356  104648 1895362  1cebc2 vmlinux
</pre>

<p>LTO improved things, but produced only a 4.5% size reduction.  We're far
from the 22% reduction we obtained previously when modules were
disabled. Why is module support so counter-productive?

<h4><a name="_the_tree_that_hides_the_forest"></a>The tree that hides the forest</h4>

<p>We've seen that LTO is very good at optimizing code away. It is
especially good at figuring out that some functions end up never being
called; their removal means that even more functions end up not being
called, and so on along the call graph down to the leaf functions. It is
like cutting a limb from a tree; every sub-branch and leaf on it
obviously won't be connected to the tree anymore and will fall to the ground.

But what LTO does is more like getting rid of branches that simply float
in the air without being connected to anything or which have become loose due to
optimization. Branches connected to the trunk won't be trimmed. Neither
will the trunk itself (the <tt>main()</tt> function) for obvious reasons.

<p>The kernel, unlike user-space programs that typically have only one
entry point, is different as it has multiple entry points. In fact it
has so many entry points that we may compare it to a forest rather than
a tree, with interlacing (interdependent) branches forming a dense
canopy. No wonder why it is so hard to obtain a <em>light</em> kernel.

<p>Among those kernel entry points we have:

<ul>

<li> 
<p>
The <tt>start_kernel()</tt> function which is equivalent to the <tt>main()</tt>
function in a user space program.


</li>

<li> 
<p>
Every system call (about 400 of them) is a kernel entry point.
Obviously some of them must be present for the kernel to be useful.


</li>

<li> 
<p>
Every <tt>EXPORT_SYMBOL()</tt> statement is declaring an entry point to the
kernel. Some of them designate data rather than code, but they create
a dependency link just the same.


</li>

<li> 
<p>
Every <tt>initcall()</tt> instance, of which there are multiple variants, is
yet another entry point of some sort, even though the caller remains
within the kernel itself. Still, they add call dependencies of their
own.


</li>

<li> 
<p>
And to a lesser extent in terms of code size, there are all those
parameter parsing functions attached to <tt>early_param()</tt> statements.


</li>
</ul>
<p>Normally, the <tt>initcall()</tt> and <tt>early_param()</tt> instantiated code is
marked with the <tt>__init</tt> qualifier and therefore evicted from memory
once the boot process is complete.

However, <tt>EXPORT_SYMBOL()</tt> really is a problem. Just by turning
<tt>CONFIG_MODULES</tt> on, we added a <em>lot</em> of tree trunks to our
kernel: 

<p><pre>
    $ wc -l Module.symvers
    3984 Module.symvers
    $ wc -l modules.order
    30 modules.order</pre>


<p>In plain text, that means that there are 3,984 exported symbols in this
kernel configuration 
for 30 configured modules. That means 3,984 additional entry points that
LTO can no longer optimize away. It is unlikely that our modules
need that many exported symbols. Let's find that out:

<p><pre>
    $ find . -name \*.ko -exec nm {} \; |
    &gt;      grep "^ *U" | sort | uniq | wc -l
    429</pre>


<p>So 429 symbols are needed for our set of modules, including those
symbols that are exported from other modules, meaning that in reality
we'd need less than 429 exported symbols from the kernel core.

<p>This is where the <a href="https://lwn.net/Articles/679934/">trimming of
unused exported kernel symbols</a> becomes especially useful. This is
activated with <tt>CONFIG_TRIM_UNUSED_KSYMS</tt>, available <a
href="https://git.kernel.org/torvalds/c/dbacb0ef670d057a">since Linux
v4.7</a>.  It works by gathering all required symbols from the set of
configured modules (similarly to what is done above), and storing them in
<tt>include/generated/autoksyms.h</tt> as a list of defines.
Those defines control whether their corresponding
<tt>EXPORT_SYMBOL()</tt> instance is activated or not. If
<tt>adjust_autoksyms.sh</tt> detects that the list of symbols doesn't match
the existing list, then it updates that list and triggers a rebuild of the
affected source files. The process is repeated until the list of exported
symbols becomes stable. Given <tt>autoksyms.h</tt> is initially empty, at
least one rebuild loop is needed.

<p>Let's see what we get from this:

<p><pre>
    $ ./scripts/config --enable TRIM_UNUSED_KSYMS
    $ make
    $ wc -l Module.symvers
    429
    $ size vmlinux
       text    data     bss     dec     hex filename
    1546209  137292  109172 1792673  1b5aa1 vmlinux</pre>


<p>Yes, we finally get a nice 9% size reduction. Let's activate LTO on top
of that:

<p><pre>
    $ ./scripts/config --enable LTO_MENU
    $ make
    $ wc -l Module.symvers
    294 Module.symvers
    $ size vmlinux
       text    data     bss     dec     hex filename
    1156851  136272  104512 1397635  155383 vmlinux</pre>

<p>Not only did we get a 29% size reduction, but thanks to LTO, the
compiler was able to optimize things so that in the end 135 fewer
exported symbols were needed. Great progress at last!

<h4><a name="_let_8217_s_cut_more_trees"></a>Let's cut more trees</h4>

<p>The next source of dependency trees, and potentially unused code, is
system calls.  Certainly we should be able to axe a couple of them. After
all, our tiny user space to go along with our tiny kernel probably won't
need most of them anyway.

<p>The kernel configuration system already provides some options to
enable or disable support for some system calls. Here are a few
examples that our user space certainly can live without:

<ul>

<li> 
<p>

<tt>CONFIG_SYSFS_SYSCALL</tt> for the obsolete <a
href="http://man7.org/linux/man-pages/man2/sysfs.2.html"><tt>sysfs()</tt></a>
system call (not to be confused with the sysfs filesystem).


</li>

<li> <p> <tt>CONFIG_ADVISE_SYSCALLS</tt> for the <a
href="http://man7.org/linux/man-pages/man2/madvise.2.html"><tt>madvise()</tt></a>
and <a
href="http://man7.org/linux/man-pages/man2/fadvise64.2.html"><tt>fadvise64()</tt></a>
system calls, which are not needed by many workloads.


</li>

<li> 
<p>
<tt>CONFIG_POSIX_TIMERS</tt> to <a href="https://lkml.org/lkml/2016/11/11/4">remove
most support for POSIX timers</a> while preserving the simplest cases.


</li>
</ul>
<p>Turning off the above options produces this:

<p><pre>
       text    data     bss     dec     hex filename
    1138567  135212  102404 1376183  14ffb7 vmlinux</pre>


<p>That means a 1.5% size reduction compared to our previous kernel. This
is not good if we need to rely on manual kernel configuration operations to get
about 1% each time.

What if we could scan our user space to automatically determine the list
of required system calls just like we did for exported symbols? Such a
scanning tool doesn't exist yet, but a simple lookup with <tt>objdump</tt> and
<tt>grep</tt> on my busybox-based user space reveals 74 system call invocations,
with some of them being duplicates of others.

<p>Of course we care about the environment and don't want to cut healthy
trees. But here we're talking about virtual trees that can be regrown with
a <tt>make</tt> command. So let's just do some clear-cutting in the system-call
forest to see how far this approach could go before investing more efforts
in a proper solution. Let's apply the following hack to our kernel to get
the compiler to
simply remove every system call:

<p><pre>
    --- a/include/linux/syscalls.h
    +++ b/include/linux/syscalls.h
    @@ -214,7 +214,9 @@
            asmlinkage long SyS##name(__MAP(x,__SC_LONG,__VA_ARGS__));      \
            asmlinkage long SyS##name(__MAP(x,__SC_LONG,__VA_ARGS__))       \
            {                                                               \
    -               long ret = SYSC##name(__MAP(x,__SC_CAST,__VA_ARGS__));  \
    +               long ret;                                               \
    +               if (1) return -ENOSYS;                                  \
    +               ret = SYSC##name(__MAP(x,__SC_CAST,__VA_ARGS__));       \
                    __MAP(x,__SC_TEST,__VA_ARGS__);                         \
                    __PROTECT(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__));       \
                    return ret;                                             \</pre>


<p>Rebuilding with the above hack applied and LTO still active produces
this:

<p><pre>
       text    data     bss     dec     hex filename
    1050735  135208  102348 1288291  13a863 vmlinux</pre>


<p>Removing <strong>all</strong> system calls reduces the kernel by a mere
7.8%. This is rather disappointing. It is probably not worth pursuing this angle
for now.

<h4><a name="_time_to_get_dirty"></a>Time to get dirty</h4>

<p>We have probably gotten to the point where the return on the investment with
automatic size reduction techniques is no longer worth the effort. Let's
move to more involved approaches now, using explicit kernel configuration
tweaking:

<ul>

<li> 
<p>
Tiny embedded systems
rarely have the luxury of a block device anyway, since they tend to be
running directly on flash memory. So <tt>CONFIG_BLOCK=n</tt>.


</li>

<li> 
<p>
The STM32 system-on-chip is a no-MMU target; therefore any attempt to
isolate users from each other is rather futile. So
<tt>CONFIG_MULTIUSER=n</tt>.


</li>

<li> 
<p>
Some other goodies that we won't use anyway, and which can thus be
disabled, include <tt>CONFIG_TIMERFD</tt>, <tt>CONFIG_MEMBARRIER</tt>,
<tt>CONFIG_COMPAT_BRK</tt>, <tt>CONFIG_PROC_SYSCTL</tt>, etc. 


</li>

<li> 
<p>
Let's select <tt>CONFIG_SLOB</tt> instead of <tt>CONFIG_SLUB</tt>; it
should be sufficient for managing a small amount of memory, and it has
smaller footprint too.


</li>

<li> 
<p>
With few user tasks, <tt>CONFIG_PREEMPT_NONE</tt> is most likely good
enough. This has the nice side effect of enabling <tt>CONFIG_TINY_RCU</tt>
and that sounds nice.


</li>

<li> 
<p>
We don't need all the kernel decompressors under the sun. So BZIP2,
LZMA, LZO, LZ4, XZ are all gone.


</li>
</ul>
<p>And then we get:

<p><pre>
       text    data     bss     dec     hex filename
     926250  129292  101172 1156714  11a66a vmlinux</pre>


<p>Okay! A 17% reduction compared to our last working kernel. Still, it
feels like we ought to be making much more progress at this point. We're
41% smaller than the kernel we started with, but this kernel is also
less capable.

<h4><a name="_time_to_get_nasty"></a>Time to get nasty</h4>

<p>There is a <tt>tinyconfig</tt> make target that produces the smallest
kernel possible. It doesn't boot on anything though. Still, this can be
used as a starting point for yet more aggressive code modularization and
axing.  Let's have a look:

<p><pre>
    $ make tinyconfig
    $ make vmlinux &amp;&amp; size vmlinux
       text    data     bss     dec     hex filename
     508792   93844   20956  623592   983e8 vmlinux</pre>

<p>This is getting nicely small now. However, this is still big for a
kernel that, by definition, has everything configured out. Let's see
where the bulk of the remaining code sits, with a little scripting:

<p><pre>
    $ for f in */built-in.o; do
    &gt;     size -t $f | tail -1 | sed "s|(TOTALS)|$f|"
    &gt; done | sort -nr
     141183   15705    9377  166265   28979 kernel/built-in.o
     111627     816    5436  117879   1cc77 fs/built-in.o
      82893    5250    3493   91636   165f4 mm/built-in.o
      79197    3173    1788   84158   148be drivers/built-in.o
      65043     124      82   65249    fee1 lib/built-in.o
       5078   13894      61   19033    4a59 init/built-in.o
       2381       0       0    2381     94d security/built-in.o</pre>


<p>That's our tinyconfig kernel. This is without LTO, otherwise it is much
more difficult to get a size breakdown per subsystem like the above. But
we've already seen that, even with a stripped-down kernel
configuration, LTO has its limits. Regardless, this still raises some
questions:

<ul>

<li> 
<p>
Why is there still 77KB of driver code when there are no drivers
configured in?


</li>

<li> 
<p>
Is it really necessary to entertain 80KB of memory-management support on a
MMU-less target?


</li>

<li> 
<p>
Can we get rid of some of that 110KB of filesystem infrastructure when
there is no need for a full-fledged filesystem support in our tiny
system?


</li>
</ul>
<p>Digging into the <tt>lib</tt> directory we can spot some low-hanging fruit:

<p><pre>
    $ size lib/crc32.o
       text    data     bss     dec     hex filename
      25528       0       0   25528    63b8 lib/crc32.o
</pre>
<p>
The CRC32 checksum implementation is not small; fortunately, a smaller
    alternative is available:
<p>
<pre>
    $ ./scripts/config --disable CRC32_SLICEBY8
    $ ./scripts/config --enable CRC32_BI
    $ make lib/ &amp;&amp; size lib/crc32.o
       text    data     bss     dec     hex filename
        340       0       0     340     154 lib/crc32.o</pre>


<p>Wonderful. Now could we do the same with the VFS layer with, for example,
an alternative implementation of the dentry-cache
code that has no hyper-parallelized algorithms that scale to thousands of
concurrent users? Perhaps it could be just some dumb code that preserves the
existing interface but which does the job fully serialized in the simplest way
possible&#8230; providing another 75x smaller footprint reduction maybe?
But there are other challenges to overcome before taking this approach.

<h4><a name="_when_the_winter_hits_the_forest"></a>When the winter hits the forest</h4>

<p>
Consider another possible opportunity for size reduction: the TTY layer.
Digging into 
the <tt>drivers/</tt> directory of our STM32 kernel, we can see this:

<p><pre>
     text    data     bss     dec     hex filename
    59572    1447    2713   63732    f8f4 drivers/tty/built-in.o</pre>


<p>Spending 60KB on kernel code and data to transfer bytes over a serial
port — not counting the dynamically allocated memory — seems
unnecessary in our tiny environment. An attempt
at an alternative TTY layer to that effect was proposed (see the associated
<a href="/Articles/721074/">LWN coverage</a>).
Making more pieces of the kernel optional was also attempted. The scheduler
is one
part of the kernel where significant parts can be carved out pretty easily
(also <a href="/Articles/725376/">covered by LWN</a>).

<p>Unfortunately, those attempts were welcomed with a cold headwind
that left me alone in the woods with frozen fingers.

<h4><a name="_a_different_angle"></a>A different angle</h4>

<p>One thing that usually mitigates the wind-chill effect in the community
is a working proof of concept. A prominent characteristic of tiny
microcontrollers is an amount of on-chip flash memory that is typically
a few times larger than the on-chip RAM. So to achieve our goal of
running Linux solely from the on-chip resources, we should stuff as much
code and data as possible into flash memory, and execute code directly from
there while keeping actual RAM usage to the bare minimum. This has to happen
for both the kernel <em>and</em> user space of course. Kernel
eXecute-In-Place (XIP) has been available for quite a while, but it's
another story when it comes to user space. That will be the subject of
<a href="/Articles/748198/">the next (and final) article</a>.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Embedded_systems">Embedded systems</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Pitre_Nicolas">Pitre, Nicolas</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/746780/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor746948"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 4:45 UTC (Fri)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/746948/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The CRC32 checksum implementation is not small; fortunately, a smaller alternative is available:</font><br>
<p>
Please submit a patch to make this the default in tinyconfig. (Or, ideally, to adapt the kernel configuration to add a CONFIG_CRC32_OPTIMIZED that's default y, depends on EXPERT, and gates the optimized implementations, so that this happens automatically rather than hardcoding it in tiny.config.)<br>
<p>
<font class="QuotedText">&gt; Consider another possible opportunity for size reduction: the TTY layer.</font><br>
<p>
You can compile *out* the entire TTY layer. Perhaps we could introduce a minimal serial driver that doesn't implement TTY at all, and just provides a trivial character device. Or implement an input-capable version of earlyprintk.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746948/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor746964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 12:32 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/746964/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If the "dumb" serial input needs to support a shell, you still need a small(ish) line discipline.<br>
Too bad the effort to include minitty got blocked, IMHO these days nobody still needs the full-scale TTY subsystem with its ancient and intractable code base. Hopefully it can be revived.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor746972"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 15:32 UTC (Fri)
                               by <b>bandrami</b> (guest, #94229)
                              [<a href="/Articles/746972/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whatever happened to kmscon? Wasn't the whole point of that that you could skip all of CONFIG_VT and let userland handle the line discipline? (It got famous because it could display Unicode on the console, but IIRC that was just a bonus)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746972/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747000"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 19:05 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/747000/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems abandoned. Would've been nice if it had gained popularity, since the other thing it had was OpenGL hardware rendering. The built in fbcon is abysmally slow to the point where you can slice seconds off boot time by just passing "quiet" on the cmdline.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747000/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747070"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2018 0:12 UTC (Mon)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/747070/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To the best of my knowledge, kmscon just worked like a terminal emulator, and it still required a pty device.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747070/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747071"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2018 3:07 UTC (Mon)
                               by <b>bandrami</b> (guest, #94229)
                              [<a href="/Articles/747071/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That may be fbterm you're thinking of?<br>
<p>
<a href="https://github.com/dvdhrm/kmscon/wiki/FAQ">https://github.com/dvdhrm/kmscon/wiki/FAQ</a><br>
<p>
Putting the entire VT stack in userland was the original reason for developing it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747071/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor747074"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2018 7:12 UTC (Mon)
                               by <b>vegard</b> (subscriber, #52330)
                              [<a href="/Articles/747074/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
minitty should be easily justified for security reasons. The TTY layer still has unfixed bugs that are easy to hit using syzkaller and apparently nobody is able (or willing) to wade through the mess of locking and ownership to figure it out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747074/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747286"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2018 2:29 UTC (Thu)
                               by <b>smoogen</b> (subscriber, #97)
                              [<a href="/Articles/747286/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Having looked through the hell that anyone who signs up for TTY layer maintenance has to take from every developer and other kernel developer when some fix broke their app... I almost think rejecting mintty was a "Listen kid, no really listen, you don't want to go in there. They ate Alan Cox alive.. they burnt out a couple more people. Just keep you liver and sanity and do this as your own project."<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747286/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor746953"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 7:42 UTC (Fri)
                               by <b>pclouds</b> (guest, #76590)
                              [<a href="/Articles/746953/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; those attempts were welcomed with a cold headwind that left me alone in the woods with frozen fingers.</font><br>
<p>
Poor Nico. I hope you keep trying and get these in mainline eventually.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746953/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor746974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 15:56 UTC (Fri)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/746974/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Getting changes like these in mainline requires time, money, energy, probably a sufficient number of interested users, and possibly overcoming some non-technical obstacles. Likewise for long-term maintenance of the simpler code paths after mainline integration. With the lukewarm reception of the initial attempts, I can understand why he's not eager to do it :)<br>
But I'm still glad that he's spending time making this series of quality articles for LWN.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor746990"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 17:03 UTC (Fri)
                               by <b>npitre</b> (subscriber, #5680)
                              [<a href="/Articles/746990/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you for your comment. Your observation is quite right, especially about interested users. The rest normally comes along with them.<br>
These articles are a way for this work not to completely go to waste.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746990/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 21:27 UTC (Fri)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/747002/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Your reasoning for reducing the footprint of the Linux kernel through simplified versions of the layers, which would enable Linux to target platforms it currently can't for technical reasons, and arguably help further lower the market share of the (partially) closed-source offerings (with GPL'ed software, even, though that's getting less popular), made perfect sense to me. It's probably even more relevant now, with the advent of efforts such as NERF... Hopefully, the simplified code would also provide lower attack surface.<br>
<p>
But how can individual users, or scattered groups thereof, efficiently signal their interest for e.g. tinified versions of the standard Linux kernel features - or, as far as I'm concerned, various features, fixes and improvements known from PaX/grsecurity, and other people have other interests - to the powers that be among the main Linux kernel maintainers ?<br>
<p>
Maintaining, evolving, testing out of tree Linux kernel code (theoretically less political interference, more technical work, but also clearly zero decision weight) over the long term is known to be exhausting - especially when done unpaid or under-paid on one's free time, as happens to most FLOSS maintainers...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747023"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 10, 2018 2:19 UTC (Sat)
                               by <b>npitre</b> (subscriber, #5680)
                              [<a href="/Articles/747023/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The word I get from microcontroller vendors (the marketing guys that is -- the engineers disagree) is that they have no demand for Linux support. What individual users or groups should do is to signal their interest to their vendor. If the market demand is there then I will no longer be the only one being paid to work on this, and upstream inclusion would be easier to advocate. Those articles are nice for sharing my knowledge and experience, but this is also an attempt at stirring up some interest or I'll eventually be paid to work on something else.<br>
<p>
If the market demand is there, then mainline acceptance becomes a purely technical issue. So far in my experience I always managed to sort out technical issues with upstream maintainers, but when they ask if the added maintenance burden is justified by an actual user base then they have a point.<br>
<p>
I think the issues with PaX/grsecurity are different. I'm not familiar enough with it to venture further comments though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747023/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor746991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 16:58 UTC (Fri)
                               by <b>rbrito</b> (guest, #66188)
                              [<a href="/Articles/746991/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Super thanks for this amazing series! Please, keep up with it!<br>
<p>
I have a small NAS here (a KuroBox HD, that is a powerpc machine) that only has 64MB of memory and not only the kernel is getting bigger all the time (even with equivalent configurations), but the userspace is getting larger each time.<br>
<p>
I think that it is time to drop distributions like Debian for such machines and switch to something like Arch or Gentoo (even though I know nothing about them), since the lots of dependencies that they pull in I will never use.<br>
<p>
This kernel work that you're showing is also likely to make booting speedier, if I understand things right.<br>
<p>
Thanks once again!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/746991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747006"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 20:21 UTC (Fri)
                               by <b>oldnpastit</b> (subscriber, #95303)
                              [<a href="/Articles/747006/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To keep userland size under control you might want to look at buildroot.<br>
<p>
Great article by the way, thanks!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747006/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747017"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 22:59 UTC (Fri)
                               by <b>rbrito</b> (guest, #66188)
                              [<a href="/Articles/747017/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I just skimmed the front page of <a href="https://buildroot.org/">https://buildroot.org/</a> and it looks very interesting indeed.<br>
<p>
Even some smaller/older desktops may benefit from this (and I have some).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747017/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor747012"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 22:00 UTC (Fri)
                               by <b>vadim</b> (subscriber, #35271)
                              [<a href="/Articles/747012/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Gentoo is likely unsuitable for such a purpose. Gentoo builds from source, and needs large amounts of processing power and memory to work usably. Gentoo's main selling point is eking out the last 5% of performance by optimizing for your specific configuration, but the way it works fits high end hardware best. With a 64MB RAM box chances are gcc or g++ will try allocating far more than that when building something big, and the entire machine will die from a lack of memory.<br>
<p>
That wouldn't really solve the problem anyway. To be secure in modern times you need to run modern software and not the swiss cheese from a decade ago. Modern software expects to be built in a modern, powerful desktop oriented environments, recent versions of gcc, etc. Something like Gentoo might be able to trim the fat somewhat, but current software is just fatter than the early versions were.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747012/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747016"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2018 22:56 UTC (Fri)
                               by <b>rbrito</b> (guest, #66188)
                              [<a href="/Articles/747016/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the reply.<br>
<p>
The idea here would be to build on a machine that has more RAM and, then, use the packages on that NAS...<br>
<p>
I don't know how easy Gentoo makes building and then transferring the packages/programs to another machine, though (or, perhaps, cross-compiling).<br>
<p>
I would appreciate any comments on that.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747016/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 10, 2018 8:17 UTC (Sat)
                               by <b>dirtyepic</b> (guest, #30178)
                              [<a href="/Articles/747024/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Gentoo has built-in support for cross compiling using crossdev.  It's all integrated into the package manager so building binaries for another architecture is no different than building for the native system.  There are also profiles for things like uClibc/musl if you want to go that direction.<br>
<br>
<a href="https://wiki.gentoo.org/wiki/Embedded_Handbook">https://wiki.gentoo.org/wiki/Embedded_Handbook</a><br>
<a href="https://wiki.gentoo.org/wiki/Cross_build_environment">https://wiki.gentoo.org/wiki/Cross_build_environment</a><br>
<br>
If you're just looking to offload compiling to a machine of the same architecture that has more resources, then Portage can be set up to use distcc as easily as setting a couple config options.<br>
<br>
I have to disagree with the parent comment.  Gentoo's main selling point is its flexibility.  It lets you build a system that has exactly what you need and nothing more.  In other words, it's shrinking <i>the distro</i> with an axe.  If anything performance is just a side effect of the method it uses to accomplish this.<br>
<br>
Of course, Gentoo's main downfall is also its flexibility.  It turns out that building a system that has exactly what you need requires you to know exactly what you need first.

      
          <div class="CommentReplyButton">
            <form action="/Articles/747024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor747056"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Executing from on-chip flash memory</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2018 16:41 UTC (Sun)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/747056/">Link</a>] 
      </p>
      
      </div>
      </summary>
       <i> ... an amount of on-chip flash memory that is typically a few times larger than the on-chip RAM.</i>
Such on-chip flash memory also might be a few times slower than on-chip RAM.
      
          <div class="CommentReplyButton">
            <form action="/Articles/747056/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747078"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2018 10:14 UTC (Mon)
                               by <b>pr1268</b> (subscriber, #24648)
                              [<a href="/Articles/747078/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>I propose that all SoC's these days be built with Arm64's.  Kernel 4.16's <a href="https://lwn.net/Articles/746499/">support for 52-bit physical addresses</a> on this arch/HW makes Nicolas' efforts moot. (Just kidding.)</p>

<p>Seriously, though, I still wonder sometimes how much benefit might be realized by Mr. Pitre's work.  At least if not for the size savings, then perhaps for the reduced attack vector of undiscovered vulnerabilities?</p>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747078/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747384"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Shrinking the kernel with an axe</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 15, 2018 21:37 UTC (Thu)
                               by <b>snajpa</b> (subscriber, #73467)
                              [<a href="/Articles/747384/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Let me just thank you for this effort, I and folks at base42 hackerspace appreciate it a lot. We’re looking forward to being able to spawn new projects at tubo speed, thanks to all the frameworks already available in Linux.<br>
Whether it’s stm32 or pic32, single package Linux with industrial temp ranges is something we’re missing right now.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747384/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747783"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">LTO doesn't guarantee anything</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 22, 2018 13:26 UTC (Thu)
                               by <b>davez</b> (guest, #104707)
                              [<a href="/Articles/747783/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just a reminder that LTO doesn't guarantee anything. One should always verify that LTO yields the desired result, be it smaller files or better performance. The output quality of LTO often just depends on inlining tradeoffs in the compiler.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747783/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
