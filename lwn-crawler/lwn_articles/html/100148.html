        <!DOCTYPE html>
        <html lang="en">
        <head><title>More notes on reiser4 [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/100148/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/99408/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/100148/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>More notes on reiser4</h1>
<div class="Byline">[Posted September 1, 2004 by corbet]
               <p>
               </div>
</div>
<div class="ArticleText">
The article on reiser4 which appeared here <a href="/Articles/98509/">last
week</a> drew a number of comments.  <a href="/Articles/99878/">One comment
from Hans Reiser</a> took LWN to task for not having started with a kernel
tarball which was created from a reiser4 filesystem to begin with.  It
seems that reiser4 is highly sensitive to the order in which files are
created, and using the wrong order does not show the filesystem in its best
light. 
<p>
Here is last week's table, with a new line for tests done starting with a
reiser4-built tarball:
<p>

<center>
<table cellspacing=3>
<tr class="Odd">
    <th rowspan=2>Filesystem</th>
    <th colspan=5>Test</th></tr>
<tr class="Odd">
    <th>Untar</th>
    <th>Build</th>
    <th>Grep</th>
    <th>find (name)</th>
    <th>find (stat)</th>
</tr>
<tr>
    <td>ext3</td>
    <td align="right">55/24</td>
    <td align="right">1400/217</td>
    <td align="right">62/8</td>
    <td align="right">10.4/1.1</td>
    <td align="right">12.1/2.5</td>
</tr>

<tr>
    <td>reiser4</td>
    <td align="right">67/41</td>
    <td align="right">1583/386</td>
    <td align="right">78/12</td>
    <td align="right">12.5/1.3</td>
    <td align="right">15.2/4.0</td>
</tr>

<tr>
	<td>reiser4 (new)</td>
	<td align="right">57/35</td>
	<td align="right">1445/393</td>
	<td align="right">58/9.9</td>
	<td align="right">8.4/1.3</td>
	<td align="right">11.1/4.0</td>
</tr>

</table>
</center>
<p>

The results do show a significant difference in performance when the files
are created in the right order - and the differences carry through all of
the operations performed on the filesystem, not just the untar.  In other
words, the performance benefits of reiser4 are only fully available to
those who manage to create their files in the right order.  Future plans
call for a "repacker" process to clean up after obnoxious users who insist
on creating files in something other than the optimal order, but that tool
is not yet available.  (For what it's worth, restoring from the reiser4
tarball did not noticeably change the ext3 results).

<p>

Last week, the discussion about reiser4 got off to a rather rough start.
Even so, it evolved into a lengthy but reasonably constructive technical
conversation touching on many of the issues raised by reiser4.  
<p>

At the top of the list is the general question of the expanded capabilities
offered by this filesystem; these include transactions, the combined
file/directory objects (and the general representation of metadata in the
filesystem namespace), and more.  The kernel developers are nervous about
changes to filesystem semantics, and they are seriously nervous about
creating these new semantics at the filesystem level.  The general feeling
is that any worthwhile enhancements offered by reiser4 should, instead, be
implemented at the virtual filesystem (VFS) level, so that more filesystems
could offer them.  Some developers want things done that way from the
start.  If there is a consensus, however, it would be along the lines <a
href="/Articles/100150/">laid out</a> by Andrew Morton: accept the new
features in reiser4 for now (once the other problems are addressed) with
the plan of shifting the worthwhile ones into the VFS layer.  The reiser4
implementation would thus be seen as a sort of prototype which could be
evolved into the true Linux version.
<p>
Hans Reiser <a href="/Articles/100154/">doesn't like this idea</a>:
<p>
<div class="BigQuote">
	Look guys, in 1993 I anticipated the battle would be here, and I
	build the foundation for a defensive tower right at the spot MS and
	Apple are now maneuvering towards.  Help me get the next level on
	the tower before they get here.  It is one hell of a foundation,
	they won't be able to shake it, their trees are not as powerful.
	Don't move reiser4 into vfs, use reiser4 as the vfs.  Don't write
	filesystems, write file plugins and disk format plugins and all the
	other kinds of plugins, and you won't be missing any expressive
	power that you really want....
</div>
<p>

Somehow, over the years, Hans has neglected to tell the developers that he
was, in fact, planning to replace the entire VFS.  That plan looks like a
difficult sell, but reiser4 could become the platform that is used to shift
the VFS in the directions he sees.

<p>
Meanwhile, the reiser4 approach to metadata has attracted a fair amount of
attention.  Imagine you have a reiser4 partition holding a kernel tree; at
the top of that tree is a file called <tt>CREDITS</tt>.  It's an ordinary
file, but it can be made to behave in extraordinary ways:
<p>
<blockquote><pre>
$ <b>tree CREDITS/metas</b>
CREDITS/metas
|-- bmap
|-- gid
|-- items
|-- key
|-- locality
|-- new
|-- nlink
|-- oid
|-- plugin
|   |-- compression
|   |-- crypto
|   |-- digest
|   |-- dir
|   |-- dir_item
|   |-- fibration
|   |-- file
|   |-- formatting
|   |-- hash
|   |-- perm
|   `-- sd
|-- pseudo
|-- readdir
|-- rwx
|-- size
`-- uid
 
1 directory, 24 files
</pre>
</blockquote>
<p>
You can also type "<tt>cd CREDITS; cat .</tt>" to view the file.  (One must
set execute permission on the file before any of this works).
<p>
What appears to be a plain file also looks like a directory containing a
number of other files.
Most of these files
contain information normally obtained with the <tt>stat()</tt> system call:
<tt>uid</tt> is the owner, <tt>size</tt> is the length in bytes,
<tt>rwx</tt> is the permissions mask, etc.  Some of the others
(<tt>bmap</tt>, <tt>items</tt>, <tt>oid</tt>) provide a window into how the
file is represented inside the filesystem.  This is all part of Hans
Reiser's vision of moving everything into the namespace; rather than using
a separate system call to learn about a file's metadata, just access the
right pseudo file.
<p>

One branch of the discussion took issue with the "<tt>metas</tt>" name.
Using reiser4 means that you cannot have any file named <tt>metas</tt>
anywhere within the filesystem.  Some people would like to change the name;
ideas like <tt>..metas</tt>, <tt>...</tt>, and <tt>@</tt> have been tossed
around, but Hans seems uninclined to change things.
<p>

Another branch, led by Al Viro, worries about the locking considerations of
this whole scheme.  Linux, like most Unix systems, has never allowed hard
links to directories for a number of reasons; one of those is locking.
Those interested in the details can see <a href="/Articles/100183/">this
rather dense explanation</a> from Al, or <a href="/Articles/100184/">a
translation</a> by Linus to something resembling technical English.
Linus's example is essentially this: imagine you have a directory
"<tt>a</tt>" containing two subdirectories <tt>dir1</tt> and <tt>dir2</tt>.
You also have "<tt>b</tt>", which is simply a link to <tt>a</tt>.  Imagine
that  two processes simultaneously attempt these commands:
<p>

<center>
<table cellspacing=3>
<tr><th>Process 1</th><th>&nbsp;&nbsp;&nbsp;&nbsp;</th><th>Process 2</th></tr>
<tr><td><tt>mv a/dir1 a/dir2/newdir</tt></td><td></td>
    <td><tt>mv b/dir2 b/dir1/newdir</tt></td></tr>
</table>
</center>
<p>

Both commands cannot succeed, or you will have just tied your filesystem
into a knot.  So some sort of locking is required to serialize the above
actions.  Doing that kind of locking is very hard when there are multiple
paths into the same directory; it is an invitation to deadlocks.  The
problem could be fixed by putting a monster lock around the entire
filesystem, but the performance cost would be prohibitive.  The usual
approach has been to simply disallow this form of aliasing on directory
names, and thus avoid the problem altogether.
<p>

In the reiser4 world, all files are also directories.  So hard links to
files become hard links to directories, and all of these deadlock issues
come to the foreground.  The concerns expressed by the kernel developers -
which appear to be legitimate - is that the reiser4 team has not thought
about these issues, and there is no plan to solve the problem.  Wiring the
right sort of mutual exclusion deeply into a filesystem is a hard thing to
do as an afterthought.  But something will have to be done; Al Viro has
made it clear that he will oppose merging reiser4 until the issue has been
addressed, and it is highly unlikely that it would go in over his
objections (<a href="/Articles/100271/">Linus</a>: "<q>This means that
if Al Viro asks about locking and aliasing issues, you don't ignore it, you
ask 'how high?'</q>")

<p>
One way of dealing with the locking issues (and various other bits of
confusion) would be to drop the "files as directories" idea and create a
namespace boundary there.  Files could still have attributes, but an
application which wished to access them would use a separate system call to
do so.  The <tt>openat()</tt> interface, which is <a
href="http://docs.sun.com/db/doc/816-0220/6m6nkorp9?a=view">how Solaris
solves the problem</a>, seems like the favored approach.  Pushing
attributes into their own namespace breaks the "everything in one
namespace" idea which is so fundamental to reiser4, but it would offer
compatibility with Solaris and make many of the implementation issues
easier to deal with.  On the other hand, applications would have to be
fixed to use <tt>openat()</tt> (or be run with <tt>runat</tt>).

<p>

Another contingent sees the reiser4 files-as-directories scheme as the way
to implement multi-stream files.  Linux is one of the few modern operating
systems without this concept.  The Samba developers, in particular, would
love to see a multi-stream implementation, since they have to export a
multi-stream interface to the rest of the world.  There are obvious simple
applications of multi-stream files, such as attaching icons to things.
Some people are ready to use the reiser4 plugin mechanism and go nuts,
however; they would like to add streams which present compressed views of
files, automatically produce and unpack archive files, etc.  Linus <a
href="/Articles/100185/">draws the line</a> at that sort of stuff, though:
<p>
<div class="BigQuote">

Which means that normally we really don't _want_ named streams. In 99% of
all cases we can use equally good - and _much_ simpler - tool-based
solutions.
<p>
Which means that the only _real_ technical issue for supporting named
streams really ends up being things like samba, which want named streams
just because the work they do fundamentally is about them, for externally
dictated reasons. Doing named streams for any other reason is likely just
being stupid.
<p>
Once you do decide that you have to do named streams, you might then 
decide to use them for convenient things like icons. But it should very 
much be a secondary issue at that point.
</div>
<p>

Yet another concern has to do with how user space will work with this
representation of file metadata.  Backup programs have no idea of how to
save the metadata; <tt>cp</tt> will not copy it, etc.  Fixing user space is
certainly an issue.   The fact is, however, that, if reiser4 or the VFS of
the future changes our idea of how a file behaves, the applications will be
modified to deal with the new way of doing things.  Meanwhile, it has been
pointed out that reiser4-style metadata is probably easier for applications
to work with than the current extended attribute interface, which is also
not understood by most applications.
<p>

The discussion looks likely to continue for some time.  Regardless of the
outcome, Hans Reiser will certainly have accomplished one of his goals: he
has gotten the wider community to start to really think about our
filesystems and how they affect our systems and how we use them.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Reiser4">Filesystems/Reiser4</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Named_streams">Named streams</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/100148/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor100447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">mount -t reiser4 -o posix</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 6:44 UTC (Thu)
                               by <b>larryr</b> (guest, #4030)
                              [<a href="/Articles/100447/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>I think it would be ok to have a mount flag which says I want POSIXy semantics when using POSIXy system calls like open/close/rename/link/symlink, and I am willing to lose the ability to access added intuitive but nevertheless non-POSIX behavior through those system calls.</p><p>From what I have seen of the VFS layer, it looked pretty tightly coupled to POSIXy semantics,
and not easy to shunt past to let the filesystem decide the semantics for itself, which sounds to me like a nice alternative to changing <em>or</em> replacing the VFS layer.
<p>
Larry
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor100449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 7:08 UTC (Thu)
                               by <b>walles</b> (guest, #954)
                              [<a href="/Articles/100449/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      Since hard links seem so problematic within ReiserFS, why not just remove support for them in ReiserFS entirely?<br>
<p>
Also, as I haven't used a hard link in all my life, can anybody tell me about any real-life situation where hard links matter?<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 8:52 UTC (Thu)
                               by <b>Klavs</b> (guest, #10563)
                              [<a href="/Articles/100459/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      Well vserver uses them to save space. If you have 10 vservers (virtual servers) on the same filesystem, mirrored from the same original - instead of having f.ex. 10*3gb of files - you would only have 3gb of files. And since vserver1 can't know of vserver2 or anything outside of the vserver - soft links would be bad.<br>
<p>
The other nice thing, that I'm not sure if symlinks could implement (seing past the issues of symlinks to outside a vserver not being a good idea :) - is the new vserver fileattribute "Immutable-unlink" which means you can make all files immutable+Unlink in all vservers(two flags as far as I remember Immutable and Immutable-Unlink flag) - and if one vserver tries to change a file marked Immutable-Unlink - it will simply get a new file - and the old hardlink will be removed - meaning the other 9 vservers still share the same file.<br>
<p>
To me this is clever use of hardlinks - but I'm no filesystem guru :)<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100468"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Space savings should use COW</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 9:48 UTC (Thu)
                               by <b>walles</b> (guest, #954)
                              [<a href="/Articles/100468/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      I think space savings would be better done by supporting copy-on-write semantics within the file system, which is just what you describe as Immutable-unlink.  I imagine COW should be less error-prone than hard links, but just like you I'm no fs guru (or I wouldn't be asking these questions :-).<br>
<p>
Something along these lines have been implemented at <a href="http://www.ext3cow.com/">http://www.ext3cow.com/</a> (which is a random project I found on Google, I don't know anything about it except what the web page says).<br>
<p>
So do you (or anybody else for that part) know of any other uses for hard symlinks that don't have anything to do with space savings?<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100468/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100528"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">My use of hard links</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 13:23 UTC (Thu)
                               by <b>utoddl</b> (guest, #1232)
                              [<a href="/Articles/100528/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I have a script that makes good use of hard links -- not for space saving so much as time saving, but it saves a lot of space as well. I keep a copy of my RedHat/Fedora/whatever ISO images, and occasionally use wget to grab all the updates into another directory. These updates contain all 19 gazillion versions of the updated packages -- way more than will fit on a CD -- when what I really want of course is the latest version of each. So I use cpio to make a hard link duplicate tree of all those updates (i.e. real directories, hard linked files). That's pretty quick, 'cause it's not moving any data, just creating dir entries.  Then my script throws out everything I don't want from that tree -- all the older versions of a given rpm -- and I'm left with a small enough set of rpms to fit onto a CD.  I add my own favorite goodies that aren't on the distro (config files, utilities, etc.), and burn an ISO from that.  That gives me the original distro CDs plus an extra CD with all current updates and my favorites all on CDs I can carry around so I can install on and update the various boxes I play with at home, work, friends' and family's houses, wherever. (Heck, I'll stick a copy of the scripts <a href="http://tarna.oit.unc.edu/~utoddl/updatecd/">here</a> if anybody wants to play with 'em.)

<p>Using hardlinks for this was a natural. Having said that, I recall only using hardlinks once before, a long time ago, and that was specifically for space savings.
      
          <div class="CommentReplyButton">
            <form action="/Articles/100528/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100562"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">My use of hard links</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 15:50 UTC (Thu)
                               by <b>fergal</b> (guest, #602)
                              [<a href="/Articles/100562/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I think you could have used symlinks for this too. Then mkisofs -f which tells it to follow symlinks (it might break something that really was meant to be a symlink though).<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100562/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor101533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Space savings should use COW</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2004 0:46 UTC (Fri)
                               by <b>roelofs</b> (guest, #2599)
                              [<a href="/Articles/101533/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <FONT COLOR="#772200"><I>So do you (or anybody else for that part) know of any other uses for hard symlinks that don't have anything to do with space savings?</I></FONT>

<P>
Assuming you really meant "hard links," I use them to avoid accidentally deleting local mail files.  Since such files get updated every day, usually several times a day, even daily incremental backups aren't sufficient to recover from an accidental deletion.  But with hard-linked copies in a separate directory (e.g., <TT>../.backups/foo.backup</TT>, etc.), you're safe.  (And when you really <I>do</I> want to nuke the file, just truncate it to zero bytes--I wrote a trivial "trunc" utility that simply uses <tt>truncate()</tt> or <tt>ftruncate()</tt> for this purpose.)  Of course, I suppose I could simply keep the "real" copy in the same hidden directory and use local symlinks to append to it...but with hard links you save one letter in every <tt>ls</tt>(1) command (i.e., <tt>-L</tt>). :-)

<P>
I've also occasionally used hard links to save a temporary MPEG or PDF file downloaded by Netscape; under some conditions, the temporary file will disappear as soon as the download is complete, but if you make a hard link at any point prior to that, the link will remain.  For multi-megabyte downloads, that can be convenient, albeit not absolutely critical...

<P>
Greg
      
          <div class="CommentReplyButton">
            <form action="/Articles/101533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor101672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Space savings should use COW</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2004 15:44 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/101672/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>And this too can be covered by COW files. The fact is in almost all cases where I think about hardlink I found what I really need is COW file and hardlink is just poor substitute.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor100467"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 9:40 UTC (Thu)
                               by <b>rjw</b> (guest, #10415)
                              [<a href="/Articles/100467/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      Mainly useful for things like chrooting nowadays AFAIK.<br>
<p>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100467/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100470"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 10:03 UTC (Thu)
                               by <b>walles</b> (guest, #954)
                              [<a href="/Articles/100470/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      Please forgive my ignorance, but what do hard links have to do with chrooting?  How exactly are hard links used together with chroot jails?<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100470/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100489"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 11:26 UTC (Thu)
                               by <b>hensema</b> (guest, #980)
                              [<a href="/Articles/100489/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      You cannot symlink to files outsides a chroot. So, if you want to create a chroot jail without hard links, then you'd have to copy all files you need inside the chroot, effectively duplicating those files.<br>
<p>
However, with hard links, you only need one instance of a file on disk, which saves space.<br>
<p>
Note that hard linking from inside a chroot to main system files (such as /bin/bash) is not a very smart thing to do, as chrooted users can then modify exactly the files you wanted to prevent them from modifying. So you always need two copies of a file.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100489/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100516"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 12:04 UTC (Thu)
                               by <b>flewellyn</b> (subscriber, #5047)
                              [<a href="/Articles/100516/">Link</a>] 
      </p>
      
      </div>
      </summary>
      So, in other words, security concerns make the space-saving of hardlinks in a chroot environment useless, since duplication is necessary anyway.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100516/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor100525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 12:52 UTC (Thu)
                               by <b>maniax</b> (subscriber, #4509)
                              [<a href="/Articles/100525/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Using hardlinks for chroot jails is a bad idea. Firstly, you don't have a good way to protect the file, and if you do some modifications on the chroot environment's structure, you'll have to update all it's users (or, if the tool that update software in it uses unlink() and then open(), you'll have to update the users of the env. on every update).<br>
Just use bind mounts, which will save more space, and make it possible to have the evironment mounted somewhere read-write for updates, and somewhere read-only, for use.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100590"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 16:35 UTC (Thu)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/100590/">Link</a>] 
      </p>
      
      </div>
      </summary>
      If the file is not writeable, there is no problem.  If the process running<br>
in the jail is under uid 0, then you aren't gaining anything by the jail<br>
anyway.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100590/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor100642"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 19:52 UTC (Thu)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/100642/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Good point would be that it's easier to get security updated versions of <br>
the libraries etc inside the chroots.  Same can of course achieved easier <br>
with mount --bind's from chroot "template" directory, but with hardlinks <br>
you can pick and choose what you put input chroots from the template <br>
directory structure. <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100642/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor100593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Slightly different suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 16:39 UTC (Thu)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/100593/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      How about this?<br>
<p>
rule 1: you can't create hard links to a file with streams<br>
rule 2: you can't create streams in a file with more than one directory entry (link)<br>
<p>
Problem solved.  You get both features on a per-file basis.  You just can't<br>
use them both at the same time.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100632"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Slightly different suggestion</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 18:34 UTC (Thu)
                               by <b>bronson</b> (subscriber, #4806)
                              [<a href="/Articles/100632/">Link</a>] 
      </p>
      
      </div>
      </summary>
      As streams become more and more popular, your proposed solution becomes more and more problematic.  Besides, I think that in reiser4 all files have streams.<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100632/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor100595"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 16:42 UTC (Thu)
                               by <b>piman</b> (guest, #8957)
                              [<a href="/Articles/100595/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Every regular file is a hard link to itself. . and .. are hard links to the directories you get when you cd to them.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100595/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor100617"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 19:24 UTC (Thu)
                               by <b>xtifr</b> (guest, #143)
                              [<a href="/Articles/100617/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      A hard link is basically just something (usually a name) that points directly to an inode, rather than linking indirectly to another name.  So pretty much every file on your system (except for the symlinks) is a hard link.  (Actually, even symlinks are usually hard links to inodes containing the symbolic reference, so every symlink is a hardlink - but I believe there are filesystems where symbolic references can be stored in the directory structure, so this is not a hard-and-fast rule.  But it is a common one.)<br>
<p>
If you mean that you never use more than one hard link per inode (not counting the automatic "." and ".." hardlinks that all directories have), well, even that's pretty tricky - when a process opens a file, it actually creates a new hard link, internal to the process (not associated with any name on the filesystem).  So, if you forbid multiple hard links, you lose the ability to open files (unless you delete them as you open them), which would make the files a bit useless.  :)<br>
<p>
Also, as others have mentioned, hard links are slightly smaller and faster than symlinks.  This may not matter to you but it does matter to some people, especially people working with small embedded systems, and the insane performance fanatics who take a wasted CPU cycle as a personal affront (I'll try not to mention any Gentoo fans by name here.:)<br>
<p>
Using symlinks also requires you to have a primary, privileged name (the main hard link).  Sometimes this isn't convenient.  For example, I'm not entirely sure how I want to organize my music: by artist or by genre.  Currently I have two directory trees populated with hard links to the same music files.  If I used symlinks, one of those trees would have to be privileged, and would be very hard to get rid of if I decided I didn't need it any more.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100617/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100640"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 19:44 UTC (Thu)
                               by <b>walles</b> (guest, #954)
                              [<a href="/Articles/100640/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; when a process opens a file, it actually creates a new hard link, internal </font><br>
<font class="QuotedText">&gt; to the process (not associated with any name on the filesystem)</font><br>
<p>
I'm not sure I'm following this.  The article text says that hard links to directories are forbidden, but libc still has an opendir() call.  If what you say above is correct, how come opendir() doesn't have to delete directories upon opening them?<br>
<p>
<font class="QuotedText">&gt; Using symlinks also requires you to have a primary, privileged name</font><br>
<p>
What do you mean with "privileged" name?  And why would such files be hard to get rid of?<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100640/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2004 16:41 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/100758/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>He's using a rather expansive definition of "hard link."  Usually, "hard link" refers only to a reference to a file from a directory entry.  The kind of reference you get when you open a file isn't called a hard link.  (It's just called a reference).
<p>
Incidentally, most of this thread is using "hard link" in a <em>too</em> restrictive way.  When you create a file 'foo', you create one hard link to the file (from the directory entry with name 'foo').  When you ln foo bar, you create a second hard link to the file.  Note that Unix files themselves <em>do not have names</em> -- not text ones anyway; they are traditionally named by inode number.
<p>
Directories have lots of hard links.  There's the one from the parent directory, the one from '.', and all the ones from the subdirectories' '..' entries.  In some modern models, '.' and '..' aren't actually considered directory entries, but you'll still see them -- for historical purposes -- in the directory's link count (e.g. from ls -l).
<p>
But you can't make an arbitrary hard link to a directory.  Only the specific ones described above are allowed to exist.

      
          <div class="CommentReplyButton">
            <form action="/Articles/100758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor100757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2004 16:46 UTC (Fri)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/100757/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <em>What do you mean with "privileged" name? And why would such files be hard to get rid of?</em>
<p>
I suppose what is meant is, that with symbolic links there is a distinction between the actual file and the link: removing the symbolic link leaves the file intact, while removing the file leaves you with a link pointing nowhere. This, of course, is because there are two separate inodes
(the entities that keep the metadata): a symbolic link has its own inode. With hard links, you merely remove one of the references to the file (this is a number in the inode that is increased whenever a hard link is created), leaving it intact until the last link is removed. In this respect, all link names are "equal" then.
<p>
Getting back to your original question: this is also one of the reasons why you would want to use hard links. (In practice, symbolic links are almost always preferable. You should really know what you're doing when using hard links.)

      
          <div class="CommentReplyButton">
            <form action="/Articles/100757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor100850"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 4, 2004 21:38 UTC (Sat)
                               by <b>Ross</b> (guest, #4065)
                              [<a href="/Articles/100850/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Because another process can't use that opened directory to traverse the<br>
filesystem (even /proc/self/cwd is just a symlink).  The same thing with<br>
open files.  They prevent the item from being removed from the disk, but<br>
they don't mess with the namespace.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100850/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor100853"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why not just not support hard links?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 4, 2004 22:39 UTC (Sat)
                               by <b>jmshh</b> (guest, #8257)
                              [<a href="/Articles/100853/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Here is another scenario, where hard links are useful:</p>  
<p>I had do make changes to a config file for a program. There was no  
source available, the program crashed on reading my version, and the crash  
handler removed any temporary stuff.</p>  
<p>So I started the program, made a hard link to the temporary output and  
waited for the crash. Now I could see how far the program got and  
immediately spotted the error.</p>  
<p>Disclaimer: Free software makes this unnecessary, good programs provide  
at least a debug option that makes temporary stuff survive, and even  
better programs give useful error messages. But one can't always choose  
the environment.  
</p>  
      
          <div class="CommentReplyButton">
            <form action="/Articles/100853/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor101671"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">hard links are a necessity</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2004 13:35 UTC (Sat)
                               by <b>job</b> (guest, #670)
                              [<a href="/Articles/101671/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Hard links is basically the same thing as a file name, so what you're <br>
saying is to limit files to having only one name. This would be to put an <br>
artificial restriction in the file system that people are not used to <br>
(except for the win32 crowd, their system is crippled to start with). <br>
 <br>
As an example I use hard links for my mp3 folder. Song.mp3 is placed both <br>
in mp3/genres/Pop and mp3/artists/Artist, that way I can browse my <br>
collection according to both artist and genre. But the ability to have <br>
several names (and paths) to one file is useful in lots of other places. <br>
 <br>
No, this has to be solved in a better way. <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101671/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor100523"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using // to access file attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 12:50 UTC (Thu)
                               by <b>exco</b> (guest, #4344)
                              [<a href="/Articles/100523/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Whatever is choosen to access file attributes it will broke some application. So why use // ?<br>
<p>
CREDITS//gid<br>
<p>
It sure will broke badly written application but it does not remove usable filename possibilities.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100523/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100543"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using // to access file attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 13:55 UTC (Thu)
                               by <b>elanthis</b> (guest, #6227)
                              [<a href="/Articles/100543/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Or just use a different system call, which makes sense, since we *already* have a system calls for file-system attributes...<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100543/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using // to access file attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 19:01 UTC (Thu)
                               by <b>pflugstad</b> (subscriber, #224)
                              [<a href="/Articles/100637/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Because if you can just use a special syntax to acess the extended attributes, that makes them immediately accessible to the shell, scripts of various types, and programs that don't know how to access the attributes natively. <br>
<p>
For example, clearcase is a (commercial) version control system.  It implements something like this by allowing you to append @@ to any file within it and from there see all the versions and branches that are available.  This is very powerful, as you can do things like using tab completion in BASH, direct scripting, etc.  It's very nice.  <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor101478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using // to access file attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2004 18:31 UTC (Thu)
                               by <b>nobrowser</b> (guest, #21196)
                              [<a href="/Articles/101478/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Apologize to RMS for implying Emacs is "badly written" :-)<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor101673"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using // to access file attributes</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2004 15:55 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/101673/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>There are no need: RMS freely admit there are <b>a lot of</b> cruft in Emacs and there are plans to reimplement everything in more sane ways for few years now</p>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/101673/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor100542"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">More notes on reiser4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 13:58 UTC (Thu)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/100542/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Aren't '.' and '..' the canonical example of hard link to directory ? <br>
How does the kernel handle locking for those two case ? <br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100542/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">More notes on reiser4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 15:54 UTC (Thu)
                               by <b>RobSeace</b> (subscriber, #4435)
                              [<a href="/Articles/100564/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Yeah, but those two are easily recognized, and can be special-cased, if<br>
necessary...  Basically, the only issue with those is first canonicalizing<br>
your pathname (a la realpath()), and then names will be the same, no matter<br>
what combinations of "." and ".." you use to reach the real destination...<br>
However, with arbitrarily named hard-links, you don't have the ability to<br>
recognize them...  Or, rather, I should say you don't have the ability to<br>
canonicalize them into any single specific format, since there is no "one<br>
true name" for them...  Ie: if you have "X" and "Y" as hard-links to the<br>
same exact file, which one is the canonical name??  There's no way to decide<br>
that...  But, since everyone knows about the special cases of "." and "..",<br>
those can be handled specially, with little trouble...<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor101675"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">More notes on reiser4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 11, 2004 15:57 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/101675/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Simple. It mostly ignores them when they are in present on disk (some filesystems do not even <b>have</b> "." and ".." on disk!) and handles them specially when in memory.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101675/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor100565"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">puzzled</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 15:52 UTC (Thu)
                               by <b>fergal</b> (guest, #602)
                              [<a href="/Articles/100565/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      Why is it that the first example here is a problem but the other 2 arent't?

<ul>
<li>
<pre>
mv a/dir1 a/dir2/newdir	 	mv b/dir2 b/dir1/newdir
</pre>
</li><li>
<pre>
mv a/dir1 a/dir2/newdir	 	mv a/dir2 a/dir1/newdir
</pre>
</li><li>
<pre>
cd a                            cd b
mv dir1 dir2/newdir	 	mv dir2 dir1/newdir
</pre>

</li>
</ul>


      
          <div class="CommentReplyButton">
            <form action="/Articles/100565/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100579"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">puzzled</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 16:27 UTC (Thu)
                               by <b>RobSeace</b> (subscriber, #4435)
                              [<a href="/Articles/100579/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Well, I don't pretend to know much about kernel internals, but I would assume<br>
the reason your case #2 isn't a problem is because the files canonicalize<br>
to the same exact pathnames in both processes, and presumably there must<br>
be some kernel-level synchronization of such things as renaming, based on<br>
the pathnames...  So, basically, either one or the other of those processes<br>
will succeed, and the second will fail, because the target director no longer<br>
exists at that point, because the first process beat it to the punch...  But,<br>
as I understand it, the issue with the arbitrarily-named hard-links is that<br>
there's no way to recognize that "a/dir1" is the exact same thing as "b/dir1",<br>
and hence no way to possibly synchronize these things, and prevent them from<br>
clashing with each other...  And, as such, I would think your example #3 is<br>
also a problem...<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100579/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor100599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: puzzled</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 17:23 UTC (Thu)
                               by <b>larryr</b> (guest, #4030)
                              [<a href="/Articles/100599/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>
I think maybe the problem is that unix style filesystem semantics
assume a tree structure, meaning one parent edge/entry for
each vertex/node, but having a hard link to a directory
violates that assumption.  I think if it was considered typical for
a directory to have multiple parent pointers, and there were
consistent conventions
for performing atomic locking on all the parents of a directory
at once, there might be no problem.  But if "the parent"
of a node is assumed by the implementation to be "the node corresponding to the path component to the left of
the path component referencing this node", locking "the parent" of "/x/a/dir1" could be different from locking "the parent" of "/x/b/dir1".
</p>
<p>Larry</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100686"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: puzzled</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2004 1:57 UTC (Fri)
                               by <b>vonbrand</b> (subscriber, #4458)
                              [<a href="/Articles/100686/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      No, the problem is <em>precisely</em> that if a diretory has several parents, you need to make sure nobody messes around with one of the paths while you are screwing up another one. For that you'd have to be able to find <em>all</em> parents and lock them before doing anything... and that will have a heavy cost if done naïvely. Al (and Linus) is asking how do they solve these problems. If the ReiserFS guys have good answers, symlinks (as second-class citizens) could be on the way out. I for one doubt they have the answers (or are able to come up with them). Time will tell.
      
          <div class="CommentReplyButton">
            <form action="/Articles/100686/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100741"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Re: puzzled</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2004 15:36 UTC (Fri)
                               by <b>larryr</b> (guest, #4030)
                              [<a href="/Articles/100741/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote><em>
 No, the problem is precisely that if a diretory has several parents[... ]you'd have to be able to find all parents and lock them before doing anything... and that will have a heavy cost if done naïvely. </em></blockquote>
<p>
I wrote:
</p>
<blockquote>
if it
was considered typical for a directory to have multiple
parent pointers, and there were consistent conventions for
performing atomic locking on all the parents of a directory
at once, there might be no problem.
</blockquote>
<p>
Larry
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100741/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor100648"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">More notes on reiser4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 2, 2004 21:51 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/100648/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      There are a number of different things going on. First is that the things Reiser4 puts in the attribute space of a file seem to me to be virtual files, in the sense that they replicate existing metadata in the filesystem in a different namespace. Obviously, "echo test &gt; CREDITS/metas/rwx" shouldn't act like that were an ordinary file, and "mv CREDITS/metas/uid CREDITS/metas/gid"  doesn't make any sense. Likewise, "ln CREDITS/metas/rwx MAINTAINERS/metas/rwx" seems like it shouldn't be expected to succeed. There's just more expressive power available in the filesystem interface than can be logically supported. The operations which are, from the point of view of the VFS, problematic seem to me to be exclusively ones which Reiser4's use of an extended namespace over files should prohibit anyway.<br>
<p>
It seems to me like prohibiting all the tricky operations in the attribute space would be fine. It's not like Reiser4 gets rid of directories and makes everything equivalent to attributes of the filesystem root.<br>
<p>
It should be fine to also prohibit file/.. (which would cause problems with hard-linked files; the same file can be in multiple directories).<br>
<p>
I think the more serious problem is how to distinguish the attributes of a directory (which is information about the directory) from the contents of the directory (which is really information about the contents). Personally, I think dir/.../attribute is best, since all of the cases in which I've heard of "..." being used, it hasn't been for files in directories.<br>
<p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/100648/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor100768"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">More notes on reiser4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 3, 2004 18:05 UTC (Fri)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/100768/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <em>Personally, I think dir/.../attribute is best, since all of the cases in which I've heard of "..." being used, it hasn't been for files in directories.</em>
<p>
For what it's worth, I think Tivoli Storage Manager uses ... as a wildcard in filenames. 
      
          <div class="CommentReplyButton">
            <form action="/Articles/100768/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor101437"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Trying to fit an hierarchical database inside the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 9, 2004 14:14 UTC (Thu)
                               by <b>leandro</b> (guest, #1460)
                              [<a href="/Articles/101437/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Looks like ReiserFS is getting too complicated and running into issues trying to extend POSIX functionality without breaking neither POSIX compatibility nor kernel internals.<br>
<p>
I propose all this is due to it actually amounting to trying to fit a hierarchical database management system inside the kernel.<br>
<p>
Now the reason why hierarchical databases lost to SQL is that SQL, even if not being really relational, by implementing some of the relational ideas was much simpler.<br>
<p>
So the US$1M question is, at this point wouldnt designing all data structures around the relational model make more sense?  Or at least all data storage.<br>
<p>
Obviously this doesnt amount to Oracle in the kernel, because SQL is much more complex than a relational implementation would be.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101437/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor101550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">More notes on reiser4</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2004 11:12 UTC (Fri)
                               by <b>dash2</b> (guest, #11869)
                              [<a href="/Articles/101550/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Comment from a non-technical user (non-technical at this level anyway).<br>
<p>
There is a well-known software development management meme out there called "beware of the guy in a room". (I think someone at Microsoft blogged about this recently.) That is, beware of the "genius" who sits on his own coding without communicating with the rest of the team: his ideas may be brilliant, but he may be more interested in implementing his ideas than in the project's needs.<br>
<p>
I think maybe Hans Reiser is like a very high level "guy in a room". He is clearly very smart, his ideas are deep - I love reading the namesys website even when I don't get it - but he's very much in love with those ideas, rather than being a pragmatist who just wants to make things work. Which is cool, because open source needs such guys, but... don't let them in the driving seat!<br>
<p>
Just my 2c, no disrespect meant to anyone.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor101642"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Log structured filesystems had similar benchmarking issues....</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 10, 2004 22:18 UTC (Fri)
                               by <b>tytso</b> (subscriber, #9993)
                              [<a href="/Articles/101642/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Some folks at Berkeley tried an abortive attempt at a related idea, called log-structured filesystems, and it similarly had the requirement for the filesystem to be periodically groomed using a "log cleaner" in order to repack and reoptimize the filesystem.  For small benchmarks where the log cleaner doesn't need to be run during the duration of the test, the results can look much better than under real-world use, where the cost of the log cleaner has to be included overhead of the filesystem.<br>
<p>
The benchmark I would suggest be tried against reiser4 is compiling a kernel tree from scratch.  If you have to tar and untar the kernel under reiser4 first, that's fine.  But then unmount and remount the filesystem (so none of the source files are in the page cache), and then try to do kernel compile.  My guess is that the results would be extremely enlightening --- and this would certainly be a fair and representative use scenario which every kernel developer would be familiar with, and indeed use every day.<br>
      
          <div class="CommentReplyButton">
            <form action="/Articles/101642/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2004, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
