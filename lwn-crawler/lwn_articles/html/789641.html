        <!DOCTYPE html>
        <html lang="en">
        <head><title>A kernel debugger in Python: drgn [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/789641/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/789232/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/789641/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A kernel debugger in Python: drgn</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 29, 2019</br>
           <hr>
<a href="/Articles/lsfmm2019/">LSFMM</a>
</div>
<p>
A kernel debugger that allows Python scripts to access data structures in
a running kernel was the topic of Omar Sandoval's plenary session at the
2019 Linux Storage, Filesystem, and Memory-Management Summit (LSFMM).  In
his day job at Facebook, Sandoval does a fair amount of kernel debugging
and he found the existing tools to be lacking.  That led him to build <a
href="https://github.com/osandov/drgn">drgn</a>, which is a debugger built
into a Python library.
</p>

<p>
Sandoval began with a quick demo of drgn (which is pronounced "dragon").
He was logged into a virtual machine (VM) and invoked the debugger on the
running kernel with
<tt>drgn&nbsp;-k</tt>.  With some simple Python code in the REPL (<a
href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">read-eval-print
loop</a>), he was able to examine the superblock of the root filesystem and
loop through the inodes cached in that superblock—with their paths.  Then
he did "something a little fancier" by only listing the inodes for files
that are larger than 1MB.  It showed some larger kernel modules, libraries,
systemd, and so on. 
</p>

<p>
He mostly works on Btrfs and the block layer, but he also tends to debug
random kernel problems.  Facebook has so many machines that there are
"super rare, one-in-a-million bugs"
showing up all the time.  He often volunteers to take a look.  In the
process he got used to tools like GDB, crash, and eBPF, but found that he
often wanted to be able to do arbitrarily complex analysis of kernel data
structures, which is why he ended up building drgn.
</p>

<a href="/Articles/789643/">
<img src="https://static.lwn.net/images/2019/lsf-sandoval-sm.jpg" border=0 hspace=5 align="right"
alt="[Omar Sandoval]" title="Omar Sandoval" width=213 height=300>
</a>

<p>
GDB has some nice features, he said, including the ability to pretty-print
types, variables, and expressions.  But it is focused on a breakpoint style
of debugging, which he cannot do on production systems.  It has a scripting
interface, but it is clunky and just wraps the existing GDB commands. 
</p>

<p>
<a href="http://man7.org/linux/man-pages/man8/crash.8.html">Crash</a> is
purpose built for kernel debugging; it knows about linked lists, 
structures, processes, and so on.  But if you try to go beyond those
things, you will hit a wall, Sandoval said.  It is not particularly
flexible; when he used it, he often had to dump a bunch of state and then
post-process it.
</p>

<p>
BPF and BCC are awesome and he uses them all the time, but they are limited to
times when you can reproduce the bug live.  Many of the bugs he looks at
are something that happened hours ago and locked up the machine, or he got
a core dump and wants to understand why.  BPF doesn't really cover this use
case; it is more for tracing and is not really an interactive debugger.
</p>

<p>
Drgn makes it possible to write actual programs in a real programming
language—depending on one's opinion
of Python, anyway.  It is much better than dumping things out to a text file
and using shell scripts to process them or to use the Python bindings for
GDB.  He sometimes calls drgn a "debugger as a library" because it doesn't
just provide a command prompt with a limited set of commands; instead, it
magically wraps the types, variables, and such so that you can do anything
you want with them.  The <a
href="https://drgn.readthedocs.io/en/latest/user_guide.html">User Guide</a>
and home page linked above are good places to start looking into all that
it can do.
</p>

<p>
He launched into another demo that showed some of the power of drgn.  It
has both interactive and scripting modes. He
started in an interactive session by looking at variables and noted that
drgn returns an object 
that represents the variable; that object has additional information like
the type (which is also an object), address, and, of course, value.  But
one can also implement list iteration, which he showed by following the
<tt>struct&nbsp;task_struct</tt> chain from the <tt>init</tt> task down to
its children.
</p>

<p>
While he had written the list iteration live in the demo, he pointed out
that it would get tedious if you had to do so all of the time.  Drgn
provides a bunch of <a
href="https://drgn.readthedocs.io/en/latest/helpers.html">helper
functions</a> that can do those kinds of things.  Currently, most of those
are filesystem and block-layer helpers, but more could be added for
networking and other subsystems.
</p>

<p>
He replayed an actual investigation that he and a colleague had done on a
production server 
in a VM where the bug was reproduced.  The production workload was a
storage server for cold data; on it, disks that have not been used in a
while are powered down to save power.  So its disks tend to turn on and off
a lot, which exposes kernel bugs.  The cold-storage service ran in a
container and it was reported that stopping the container would sometimes
take forever. 
</p>

<p>
When he started looking at it, he realized that the container would
eventually finish, but that it took a long time.  That suggested some kind
of a leak.  He showed the process of working his way down through the block
control group data structures and used the Python Set object type to track
the number of unique request queues associated with the block control groups.
He was also able to dig around in the radix tree associated with the <a
href="https://www.kernel.org/doc/html/v4.18/core-api/idr.html#ida-usage">ID
allocator</a> (IDA) used for identifying request queues to double check
some of his results.  In the end, it was determined that the request queues
were leaking due to a reference cycle.
</p>

<p>
He mentioned another case where he used drgn to debug a problem with Btrfs
unexpectedly returning <tt>ENOSPC</tt>.  It turned out that it was
reserving extra metadata space for orphaned files.  Once he determined
that, it was straightforward to figure out which application was creating
these orphaned files; it could be restarted periodically until a real
fix could be made to Btrfs.
In addition, when he
encounters 
a new subsystem in the kernel, he will often go in with drgn to figure out
how all of the pieces fit together.
</p>

<p>
The core of drgn is a C library called libdrgn.  If you hate Python and
like error handling, you can use it directly, he said.  There are pluggable
backends for reading memory of various sorts, including
<tt>/proc/kcore</tt> for the running kernel, a crash dump, or
<tt>/proc/<i>PID</i>/mem</tt> for a running program.  It uses <a
href="http://dwarfstd.org/">DWARF</a> to get the types and symbols, which
is not the most convenient format to work with.  He spent a surprising
amount of time optimizing the access to the DWARF data.  That interface is
also pluggable, but he has only implemented DWARF so far.
</p>

<p>
That optimization work allows drgn to come up in about half a second, while
crash takes around 15s.  Because drgn comes up quickly, it will get used
more; he still dreads having to start up crash.  
</p>

<p>
There is a subset of a C interpreter embedded into drgn.  That allows drgn
to properly handle a bunch of corner cases, such as implicit conversions
and integer promotion.  It is prickly and took some effort, but it means
that he has not run into any cases where the translated code does not work
the way it does in the kernel.
</p>

<p>
The biggest missing feature is backtrace support, he said.  You can only
access global variables at this point, which is not a huge limitation, but
he does sometimes have to use crash to get addresses and other information
to plug into drgn.  It is something that is "totally possible to do in
drgn", but he has not gotten there yet.
He would like to use <a
href="https://www.kernel.org/doc/html/latest/bpf/btf.html">BPF Type
Format</a> (BTF) instead of DWARF because it is much smaller and simpler.
But the main limitation is that BTF does not handle variables; if and when
it does, he will use it.  A repository of useful drgn scripts and tools is
in the works as well.
</p>

<p>
Integration with BPF and BCC is something that has been nagging at him. The
idea would be to use BPF for live debugging and drgn for after-the-fact
debugging in some way. There is some overlap between the two, which he has
not quite figured out how to unify.  BPF is somewhat painful to work with
due to its lack of loops, but drgn cannot really catch things as they
happen.  He has a "crazy insane idea" to have BPF breakpoints that call out to a
user-space drgn program, but he is not at all sure it is possible.
</p>

<p>
That was the last session I was able to sit in on and this article
completes LWN's 
LSFMM coverage.  The talk on drgn made a nice segue for me, as I had to leave to catch a
plane to (eventually) end up in Cleveland for <a
href="https://us.pycon.org/2019/">PyCon</a>.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Debugging">Debugging</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_tools-Kernel_debugging">Development tools/Kernel debugging</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_and_Memory-Management_Summit-2019">Storage, Filesystem, and Memory-Management Summit/2019</a></td></tr>
            <tr><td><a href="/Archives/PythonIndex/">Python</a></td><td><a href="/Archives/PythonIndex/#Applications">Applications</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/789641/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor789766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 22:16 UTC (Wed)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/789766/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am curious if epython/pykdump was mentioned?  It’s a freely available python extension for crash that works quite well and allows much of what he’s describing.  I wonder what Sandoval feels the advantages are of drgn...  it sounds quite similar.<br>
<p>
<a href="https://sourceforge.net/p/pykdump/wiki/Home/">https://sourceforge.net/p/pykdump/wiki/Home/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 20:27 UTC (Thu)
                               by <b>osandov</b> (subscriber, #97963)
                              [<a href="/Articles/789916/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wasn't aware of pykdump (and I couldn't get it to run despite my best efforts). It does look similar. As Jeff commented below, he's also been working on another similar tool, crash-python. Clearly, there's a need for this sort of thing and we haven't done a great job of publicizing our efforts, which is part of the reason I presented it at LSF/MM.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789943"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 1:26 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/789943/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, I’m getting that in the comments section here - lots of tools.<br>
<p>
Pykdump has one decent set of instructions and several bad ones.  These work, I used them the other day:<br>
<a href="https://sourceforge.net/p/pykdump/wiki/Building%20From%20GIT%20-%20old%20Python2%20based/">https://sourceforge.net/p/pykdump/wiki/Building%20From%20...</a><br>
<p>
Those are python2, but I used them just fine for python3 changing only version numbers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789943/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor789778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 29, 2019 23:15 UTC (Wed)
                               by <b>kbingham</b> (subscriber, #92041)
                              [<a href="/Articles/789778/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We already have python scripting support in scripts/gdb?<br>
<p>
That includes a set of python interfaces such as lsmod, dmesg, and iterators and can all be extended as necessary?<br>
<p>
Looking into drgn, there are certainly some nice looking helpers which would merit replicating into the in-kernel scripts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789789"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 0:40 UTC (Thu)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/789789/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You said for gdb, but not for crash?  Are these available for crash as well?  (I'm aware it's a super fancy gdb wrapper)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789789/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 3:34 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789793/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It has a scripting interface, but it is clunky and just wraps the existing GDB commands.</font><br>
<p>
That's not the case at all. You *can* execute GDB commands with Python, yes, but you can also access a much richer object-based API that provides access to GDB's actual data model. See <a href="https://sourceware.org/gdb/onlinedocs/gdb/Python-API.html">https://sourceware.org/gdb/onlinedocs/gdb/Python-API.html</a><br>
<p>
Since the author of drgn is at FB, he should look up "agdb".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789914"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 20:02 UTC (Thu)
                               by <b>jeffm</b> (subscriber, #29341)
                              [<a href="/Articles/789914/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've been leading development of a project at SUSE called crash-python that rides on top of GDB's Python interface (though I've extended it quite a bit).<br>
<p>
It has classic crash-style commands, fully symbolic backtraces through GDB's thread interface (that are also accessible programmatically), a fairly rich set of helpers that the commands (and custom analysis scripts, etc) are built upon.  Of course, the usual suite of GDB commands still work as expected.  At its core is a kdumpfile debugging target that allows GDB to see the crash dump as a native core dump so, technically, the full semantic component of the debugger that loads modules and tasks isn't even required if the use case is quick information gathering. <br>
<p>
<a href="https://github.com/jeffmahoney/crash-python">https://github.com/jeffmahoney/crash-python</a><br>
<p>
Our developers and support engineers have been adopting it more and more to diagnose crash dumps.  As we use it, the one-off scripts get formalized into infrastructure and, ultimately, leveraged into commands. It isn't yet capable of debugging live systems, but there's interest in adding support to do it.  I haven't done the testing yet, but I believe it should also be possible to cross-debug if the underlying gdb is capable of it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789914/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 20:47 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789919/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cool. That sounds similar to the work I did, except that instead of supporting kdumpfiles as native "core"-type files, I implemented support for breakpad-generated minidumps. I also added support for symbol server lookup (because GDB's filesystem-based approach for finding symbols is lacking). IMHO, something like your project is definitely the way to go.<br>
<p>
And once you have something like this --- something that can load crash dumps and analyze them using the full power of the debugger --- it starts to make a lot of sense to implement all automated crash diagnosis and triaging as debugger scripts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789922"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 21:40 UTC (Thu)
                               by <b>vbabka</b> (subscriber, #91706)
                              [<a href="/Articles/789922/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly. I have implemented very extensive SLAB integrity checking in crash-python (reports much more problems than crash), and I plan to do the same for SLUB soon. And the number of one-off scripts is increasing, I should consolidate them into commands - recently it was a check for page allocator pcplists integrity, for example. Perhaps the most complex one was a script that walked page tables of every process and calculated the mapcount for each page, to check against the one stored in the struct page. Imagine doing that with crash and the usual process of dumping stuff, postprocessing it and perhaps generating more commands to dump more stuff etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789922/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789944"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 1:28 UTC (Fri)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/789944/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It sounds cool but also very similar to epython/pykdump for boring old crash.  What’s different about it that led you to create it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789944/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789946"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 1:29 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789946/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Symbol server support and better integration with the Android process model. I was really hurting for a native debugging solution that would Just Work if I tried running it on a random build.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789946/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789948"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 1:30 UTC (Fri)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789948/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Err, wrong parent comment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789948/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789947"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 2:41 UTC (Fri)
                               by <b>jeffm</b> (subscriber, #29341)
                              [<a href="/Articles/789947/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not familiar enough with epython/pykdump to be able to answer that effectively.  The big thing that draws us to develop and use it is the ease of extensibility and that the process tasks are integrated into GDB's ideas of threads, so you can do things like select a task, get a symbolic back trace, examine arguments, locals, etc.  That's only half of it, though.  Since this is all plumbed within GDB to the Python interface, we can programatically access the stacks and do things like the following script:<br>
<p>
<a href="https://github.com/jeffmahoney/crash-python/blob/master/contrib/xfs-analyze.py">https://github.com/jeffmahoney/crash-python/blob/master/c...</a><br>
<p>
This one had a very specific application and obviously would only work on the dump I was using. It cross references the contents of the XFS AIL with the inodes found in task stacks to see what was stuck in the log and why.<br>
<p>
It also allows the debugger itself to be extended quickly as new kernel versions come out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789947/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790903"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 11, 2019 16:56 UTC (Tue)
                               by <b>alexsid</b> (guest, #98432)
                              [<a href="/Articles/790903/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi Jeff,<br>
<p>
I am the main developer of PyKdump and would like to provide  several comments:<br>
<p>
1. While we can execute crash and gdb commands and get results as text, this is not how PyKdump is intended to be used.  API is built directly on crash/GDB internals so that we do not process text information but rather use direct API. The performance is quite nice - typically traversing a list of structures and dereferencing some fields of these structures can be done at about 100,000 structs per second rate.<br>
<p>
2. Just like with your tool, the main reason for PyKdump is writing programs. At this moment we already have many programs (1st pass analysis, NFS analysis, hangs analysis etc.) - about 24,000 lines of Python code.<br>
<p>
See e.g <a rel="nofollow" href="https://sourceforge.net/p/pykdump/code/ci/master/tree/progs/nfsshow.py">https://sourceforge.net/p/pykdump/code/ci/master/tree/pro...</a> for an example of how code looks like.<br>
<p>
3. The tools are written so that they work with different distributions (I work in HPE and we have to analyze vmcores from SLES, RHEL and Ubuntu). This needs significant effort as kernel structures change all the time - but our tools work for anything from 2.6.18 kernels to 5.0 kernels. <br>
<p>
4. While programs/libraries can be located as separate files on your host, everything including the framework and programs can be packaged in a single file that is both .so and ZIP. It does not depend on anything except GLIBC so it is portable between different hosts/distributions. I build  new binary versions regularly and upload them to <a rel="nofollow" href="https://sourceforge.net/projects/pykdump/files/mpykdump-x86_64/">https://sourceforge.net/projects/pykdump/files/mpykdump-x...</a><br>
<p>
5. Current version of PyKdump is based on Python-3.7.3<br>
<p>
Alex<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790903/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789960"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 6:35 UTC (Fri)
                               by <b>vbabka</b> (subscriber, #91706)
                              [<a href="/Articles/789960/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I looked briefly into pykdump code and got the impression (maybe wrong? from the file wrapcrash.py) that it works by executing crash commands and parsing their output. And AFAIK crash does similar thing with the embedded gdb. Building on top of gdb's Python API seems much cleaner and powerful than that. You don't split the kernel-specific knowledge into a binary built from C with commands producing plain text, and your python scripting on top. Instead the whole kernel-specific knowledge is in Python, which your scripts can reuse and extend.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789960/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790046"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 7:10 UTC (Sat)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/790046/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can agree that going to plain text and back is bad but putting the logic in Python is even worse as Python is an old slow scripting language which will quickly limit your use-cases and make the whole system complex and heavy (read bloated). If you put the logic in a clean library it'll be reusable from both scripting languages (C++ could be one of them nowadays) and tools with less overhead like live-monitoring.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790046/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790052"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 11:45 UTC (Sat)
                               by <b>jeffm</b> (subscriber, #29341)
                              [<a href="/Articles/790052/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The idea is to make it quickly extensible for both infrastructure and one-off analysis tools. Doing it a compiled language, especially one like C/C++, throws that out the window. Debugging a python script raising exceptions and terminating is a whole lot nicer than debugging a seg fault before you can start the work that was the real purpose of using the tool.<br>
<p>
As long as the fault isn’t in the core code, failing scripts can be run repeatedly without restarting the debugger.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790052/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790053"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2019 12:32 UTC (Sat)
                               by <b>jeffm</b> (subscriber, #29341)
                              [<a href="/Articles/790053/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, the heavy lifting in both crash-python and drgn is C/C++ code already. GDB and libkdumpfile for the former and libdrgn for the latter.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790053/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor790098"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 21:26 UTC (Sun)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/790098/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes. DRGN seems to be a healthy mix. I didn't question that, I just argued against your statement to put all logic in python.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790098/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor790093"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 2, 2019 18:33 UTC (Sun)
                               by <b>togga</b> (subscriber, #53103)
                              [<a href="/Articles/790093/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That might be the case 5 years ago, today the "two language problem" is basically solved, and tomorrow the scene will shift even further. I wouldn't call the debug-logic we're discussing here a "one-off". There are lots of synergies to be had between "infrastructure" and "analysis", these can easily end up in simulations, tests, live-monitoring or just reusing some code for different purposes in several places etc.<br>
<p>
For real "one-off" things (fire and forget, no reuse) the discussion is pretty much pointless as you could use anything at hand to get from A to B which probably ends up in "it depends on multiple factors".<br>
<p>
<p>
<font class="QuotedText">&gt;&gt; Doing it a compiled language, especially one like C/C++, throws that out the window."</font><br>
<p>
Language and runtime environments are different things. C/C++ itself throws nothing out the window:<br>
[cling]$ #include &lt;stdexcept&gt;<br>
[cling]$ throw std::runtime_error("no segfault here")<br>
<font class="QuotedText">&gt;&gt;&gt; Caught a std::exception!</font><br>
<font class="QuotedText">&gt;&gt;&gt; no segfault here</font><br>
[cling]$ auto x = (int *)nullptr<br>
(int *) nullptr<br>
[cling]$ auto no_segfault_here_either = *x<br>
input_line_7:2:34: warning: null passed to a callee that requires a non-null argument [-Wnonnull]<br>
 auto no_segfault_here_either = *x<br>
                                 ^<br>
<p>
"Debugging a python script raising exceptions and terminating is a whole lot nicer than debugging a seg fault before you can start the work that was the real purpose of using the tool."<br>
<p>
What you also get with Python is:<br>
* one layer of complexity having to wrap/convert everything between "infrastructure world" and "script world"<br>
* code very hard to  reuse elsewhere, doesn't scale very well (GIL still there for instance) and brings a lots of baggage, especially a "forced" runtime environment<br>
<p>
When your get stuck in above constraints or a Python encode/decode-hell you may have to chew and swallow that "lot nicer" statement and it won't be tasty (been there multiple times). Python has not moved away from the "scripting" corner, rather sunken in deeper, whereas other languages is moving in other directions. Everything is evolving (changing) rapidly though.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790093/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789925"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 21:50 UTC (Thu)
                               by <b>tpo</b> (subscriber, #25713)
                              [<a href="/Articles/789925/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is agdb something internal to FB? Because I wasn't able to find it via Duckduckgo?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789925/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789928"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 21:52 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789928/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah. Basically what I described in the other comment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789928/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789949"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 1:36 UTC (Fri)
                               by <b>osandov</b> (subscriber, #97963)
                              [<a href="/Articles/789949/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Huh, I must've missed that part of the GDB API when I started building drgn. It certainly could've replaced a good chunk of the code I wrote. However, the more compelling part of drgn is all of the bells and whistles built on top of the core, which it seems took Jeff a similar amount of effort to build on top of GDB. I think the user experience overall benefits from the from-scratch implementation, especially the startup time and the higher-level API without any leaky GDB abstractions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789949/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 1:44 UTC (Fri)
                               by <b>jeffm</b> (subscriber, #29341)
                              [<a href="/Articles/789951/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is drgn cross-platform?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789955"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 31, 2019 5:26 UTC (Fri)
                               by <b>osandov</b> (subscriber, #97963)
                              [<a href="/Articles/789955/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In theory, although I haven't tested it on anything other than x86-64 yet.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789955/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor790111"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 3, 2019 11:31 UTC (Mon)
                               by <b>mishuang2018</b> (subscriber, #129176)
                              [<a href="/Articles/790111/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wrote a crash command in C to dump the flow table entries of mlx5_core module. Using drgn, it is greatly simplified and it is very fast. This is what I want for years. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/790111/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor791514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A kernel debugger in Python: drgn</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 19, 2019 21:48 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/791514/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Side note: CTF has handled variables for years (though it implements them as a map from name -&gt; type, so the caller has to read /proc/kallmodsyms -- an augmented /proc/kallsyms that shows module names even for built-in modules, and sizes -- and map from name -&gt; address to complete the process.)<br>
<p>
(Right now, the DWARF-&gt;CTF converter for kernel code is not terribly brilliant, though it does work. I'll be working on one that should be much better in the next few weeks.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/791514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
