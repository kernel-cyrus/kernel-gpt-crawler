        <!DOCTYPE html>
        <html lang="en">
        <head><title>Btrfs: Working with multiple devices [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/577961/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/577731/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/577961/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Btrfs: Working with multiple devices</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>December 30, 2013</br>
           <hr>
<a href="/Articles/576276/">LWN's guide to Btrfs</a>
</div>
The previous installments of this series on the
Btrfs filesystem have focused on the basics of using Btrfs like any
other Linux filesystem.  But Btrfs offers a number of features not
supported by the alternatives; near the top of that list is support for
multiple physical devices.  Btrfs is not just a filesystem; it also has its
own <a href="https://en.wikipedia.org/wiki/RAID">RAID</a> mechanism built
in.  This article will delve into how this feature works and how to make
use of it. 
<p>
There are two fundamental reasons to want to spread a single filesystem
across multiple physical devices: increased capacity and greater
reliability.  In some configurations, RAID can also offer improved
throughput for certain types of workloads, though throughput tends to be a
secondary consideration.  RAID arrays can be arranged into a number of
configurations ("levels") that offer varying trade-offs between these
parameters.  Btrfs does not support all of the available RAID levels, but
it does have support for the levels that most people actually want to use.
<p>
RAID 0 ("striping") can be thought of as a way of concatenating multiple
physical disks together into a single, larger virtual drive.  A strict
striping implementation distributes data across the drives in a
well-defined set of "stripes"; as a result, all of the drives must be the
same size, and the total capacity is simply the product of the number of
drives and the capacity of any individual drive in the array.  Btrfs
can be a bit more flexible than this, though, supporting a concatenation
mode (called "single") which
can work with unequally sized drives.  In theory, any number of drives can
be combined into a RAID&nbsp;0 or "single" array.
<p>
RAID 1 ("mirroring") trades off capacity for reliability; in a RAID&nbsp;1
array, two drives (of the same size) store identical copies of all data.
The failure of 
a single drive can kill an entire RAID&nbsp;0 array, but a RAID&nbsp;1
array will lose no data in that situation.  RAID&nbsp;1 arrays will be
slower for write-heavy use, since all data must be written twice, but they
can be faster for read-heavy workloads, since any given read can be
satisfied by either drive in the array.
<p>
RAID 10 is a simple combination of RAID 0 and RAID 1; at least two pairs of
drives are 
organized into independent RAID&nbsp;1 mirrored arrays, then data is
striped across those pairs.
<p>
RAID 2, RAID 3, and RAID 4 are not heavily used, and they are not supported
by Btrfs.  RAID&nbsp;5 can be thought of as a collection of
striped drives with a parity drive added on (in reality, the parity data is
usually distributed across all drives).  A RAID&nbsp;5 array with <i>N</i>
drives has the storage capacity of a striped array with <i>N-1</i> drives, but it
can also survive the failure of any single drive in the array.  RAID&nbsp;6
uses a second parity drive, increasing the amount of space lost to parity
blocks but adding the ability to
lose two drives simultaneously without losing any data.  A RAID&nbsp;5
array must have at least three drives to make sense, while RAID&nbsp;6
needs four drives.  Both RAID&nbsp;5 and RAID&nbsp;6 are supported by
Btrfs.
<p>
One other noteworthy point is that Btrfs goes out of its way to treat
metadata differently than file data.  A loss of metadata can threaten the
entire filesystem, while the loss of file data affects only that one file â€”
a lower-cost, if still highly undesirable, failure.  Metadata is usually
stored in duplicate form in Btrfs filesystems, even when a single drive is
in use.  But the 
administrator can explicitly configure how data and metadata are stored on
any given array, and the two can be configured differently: data might be
simply striped in a RAID&nbsp;0 
configuration, for example, while metadata is stored in RAID&nbsp;5 mode in
the same filesystem.
And, for added fun, these parameters can be changed on the fly.
<p>
<h4>A striping example</h4>
<p>
Earlier in this series, we used <tt>mkfs.btrfs</tt> to create a simple
Btrfs filesystem.  A more complete version of this command for the creation
of multiple-device arrays looks like this:
<p>
<pre>
    mkfs.btrfs -d <i>mode</i> -m <i>mode</i> <i>dev1</i> <i>dev2</i> ...
</pre>
<p>
This command will group the given devices together into a single array and
build a filesystem on that array.  The <tt>-d</tt> option describes how
data will be stored on that array; it can be <tt>single</tt>, <tt>raid0</tt>,
<tt>raid1</tt>, <tt>raid10</tt>, <tt>raid5</tt>, or <tt>raid6</tt>.  The
placement of metadata, instead, is controlled with <tt>-m</tt>; in addition
to the modes available for <tt>-d</tt>, it supports <tt>dup</tt> (metadata
is stored twice 
somewhere in the filesystem).  The storage modes for data and metadata are
not required to be the same.
<p>
So, for example, a simple striped array with two drives could be created
with:
<p>
<pre>
    mkfs.btrfs -d raid0 /dev/sdb1 /dev/sdc1
</pre>
<p>
Here, we have specified striping for the data; the default for metadata
will be <tt>dup</tt>.  This filesystem is mounted with the <tt>mount</tt>
command as usual.  Either <tt>/dev/sdb1</tt> or <tt>/dev/sdc1</tt> can be
specified as the drive containing the filesystem; Btrfs will find all other
drives in the array automatically.
<p>
The <tt>df</tt> command will only list the first drive in the array.  So,
for example, a two-drive RAID&nbsp;0 filesystem with a bit of data on it
looks like this:
<p>
<pre>
    # df -h /mnt
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sdb1       274G   30G  241G  11% /mnt
</pre>
<p>
More information can be had with the <tt>btrfs</tt> command:
<p>
<pre>
    root@dt:~# btrfs filesystem show /mnt
    Label: none  uuid: 4714fca3-bfcb-4130-ad2f-f560f2e12f8e
	    Total devices 2 FS bytes used 27.75GiB
	    devid    1 size 136.72GiB used 17.03GiB path /dev/sdb1
	    devid    2 size 136.72GiB used 17.01GiB path /dev/sdc1
</pre>
<p>
(Subcommands to <tt>btrfs</tt> can be abbreviated, so one could type
"<tt>fi</tt>" instead of "<tt>filesystem</tt>", but full commands will be
used here).  This output shows the data split evenly across the two
physical devices; the total space consumed (17GiB on each device) somewhat
exceeds the size of the stored data.  That shows a commonly encountered
characteristic of Btrfs: the amount of free space shown by a command like
<tt>df</tt> is almost certainly not the amount of data that can actually be
stored on the drive.  Here we are seeing the added cost of duplicated
metadata, among other things; as we will see below, the discrepancy between
the available space shown by <tt>df</tt> and reality is even greater for
some of the other storage modes.
<p>
<h4>Device addition and removal</h4>
<p>
Naturally, no matter how large a particular filesystem is when the
administrator sets it up, it will prove too small in the long run.  That is
simply one of the universal truths of system administration.  Happily,
Btrfs makes it easy to respond to a situation like that; adding another
drive (call it "<tt>/dev/sdd1</tt>") to the array described above is a
simple matter of: 
<p>
<pre>
    # btrfs device add /dev/sdd1 /mnt
</pre>
<p>
Note that this addition can be done while the filesystem is live â€” no
downtime required.  Querying the state of the updated filesystem reveals:
<p>
<pre>
    # df -h /mnt
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sdb1       411G   30G  361G   8% /mnt

    # btrfs filesystem show /mnt
    Label: none  uuid: 4714fca3-bfcb-4130-ad2f-f560f2e12f8e
	    Total devices 3 FS bytes used 27.75GiB
	    devid    1 size 136.72GiB used 17.03GiB path /dev/sdb1
	    devid    2 size 136.72GiB used 17.01GiB path /dev/sdc1
	    devid    3 size 136.72GiB used 0.00 path /dev/sdd1
</pre>
<p>

The filesystem has been expanded with the addition of the new space, but
there is no space consumed on the new drive.  It is, thus, not a truly
striped filesystem at this point, though the difference can be hard to
tell.  New data 
copied into the filesystem will be striped across all three drives, so the
amount of used space will remain unbalanced unless explicit action is
taken.  To balance out the filesystem, run:
<p>
<pre>
    # btrfs balance start -d -m /mnt
    Done, had to relocate 23 out of 23 chunks
</pre>
<p>
The flags say to balance both data and metadata across the array.  A
balance operation
involves moving a lot of data between drives, so it can take some time to
complete; it will also slow access to the filesystem.  There are
subcommands to pause, resume, and cancel the operation if need be.  Once it
is complete, the picture of the filesystem looks a little different:
<P>
<pre>
    # btrfs filesystem show /mnt
    Label: none  uuid: 4714fca3-bfcb-4130-ad2f-f560f2e12f8e
	    Total devices 3 FS bytes used 27.78GiB
	    devid    1 size 136.72GiB used 10.03GiB path /dev/sdb1
	    devid    2 size 136.72GiB used 10.03GiB path /dev/sdc1
	    devid    3 size 136.72GiB used 11.00GiB path /dev/sdd1
</pre>
<p>
The data has now been balanced (approximately) equally across the three
drives in the array.
<p>
Devices can also be removed from an array with a command like:
<p>
<pre>
    # btrfs device delete /dev/sdb1 /mnt
</pre>
<p>
Before the device can actually removed, it is, of course, necessary to
relocate any data stored on that device.  So this command, too, can take a long
time to run; unlike the <tt>balance</tt> command,
<tt>device&nbsp;delete</tt> offers no way to pause and restart the
operation.  Needless to say, the command will not succeed if there is not
sufficient space on the remaining drives to hold the data from the outgoing
drive.  It will also fail if removing the device would cause the array to
fall below the minimum number of drives for the RAID level of the
filesystem; a RAID&nbsp;0 filesystem cannot be left with a single drive,
for example.
<p>
Note that any drive can be removed from an array; there is no "primary"
drive that must remain.  So, for example, a series of <tt>add</tt> and
<tt>delete</tt> operations could be used to move a Btrfs filesystem to an
entirely new set of physical drives with no downtime.
<p>
<h4>Other RAID levels</h4>
<p>
The management of the other RAID levels is similar to RAID&nbsp;0.  To
create a mirrored array, for example, one could run:
<p>
<pre>
    mkfs.btrfs -d raid1 -m raid1 /dev/sdb1 /dev/sdc1
</pre>
<p>
With this setup, both data and metadata will be mirrored across both
drives.  Exactly two drives are required for RAID&nbsp;1 arrays; these
arrays, once again, can look a little confusing to tools 
like <tt>df</tt>:
<p>
<pre>
    # du -sh /mnt
    28G	    /mnt

    # df -h /mnt
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sdb1       280G   56G  215G  21% /mnt
</pre>
<p>
Here, <tt>df</tt> shows 56GB of space taken, while <tt>du</tt> swears that
only half that much data is actually stored there.  The listed size of the
filesystem is also wrong, in that it shows the total space, not taking into
account that every block will be stored twice; a user who attempts to store
that much data in the array will be sorely disappointed.  Once again, more
detailed 
and correct information can be had with:
<p>
<pre>
    # btrfs filesystem show /mnt
    Label: none  uuid: e7e9d7bd-5151-45ab-96c9-e748e2c3ee3b
	    Total devices 2 FS bytes used 27.76GiB
	    devid    1 size 136.72GiB used 30.03GiB path /dev/sdb1
	    devid    2 size 142.31GiB used 30.01GiB path /dev/sdc1
</pre>
<p>
Here we see the full data (plus some overhead) stored on each drive.
<p>
A RAID 10 array can be created with the <tt>raid10</tt> profile; this type
of array requires an even number of drives, with four drives at a minimum.
Drives can be added to â€” or removed from â€” an active RAID&nbsp;10 array,
but, again, only in pairs.  
RAID&nbsp;5 arrays can be created from any number of drives with a minimum
of three; RAID&nbsp;6 needs a minimum of four drives.  These arrays, too,
can handle the addition and removal of drives while they are mounted.
<p>
<h4>Conversion and recovery</h4>
<p>
Imagine for a moment that a three-device RAID 0 array has been created and
populated with a bit of data:
<p>
<pre>
    # mkfs.btrfs -d raid0 -m raid0 /dev/sdb1 /dev/sdc1 /dev/sdd1
    # mount /dev/sdb1 /mnt
    # cp -r /random-data /mnt
</pre>
<p>
At this point, the state of the array looks somewhat like this:
<p>
<pre>
    # btrfs filesystem show /mnt
    Label: none  uuid: 6ca4e92a-566b-486c-a3ce-943700684bea
	    Total devices 3 FS bytes used 6.57GiB
	    devid    1 size 136.72GiB used 4.02GiB path /dev/sdb1
	    devid    2 size 136.72GiB used 4.00GiB path /dev/sdc1
	    devid    3 size 136.72GiB used 4.00GiB path /dev/sdd1
</pre>
<p>
After suffering a routine disk disaster, the system administrator then
comes to the conclusion that there is value in redundancy and that, thus,
it would be much nicer if the above array used RAID&nbsp;5 instead.  It
would be entirely possible to change the setup of this array by backing it
up, creating a new filesystem in RAID&nbsp;5 mode, and restoring the old
contents into the new array.  But the same task can be accomplished without
downtime by converting the array on the fly:
<p>
<pre>
    # btrfs balance start -dconvert=raid5 -mconvert=raid5 /mnt
</pre>
<p>

(The <a
href="https://btrfs.wiki.kernel.org/index.php/Balance_Filters">balance
filters page</a> on the Btrfs wiki and <a
href="http://www.mail-archive.com/linux-btrfs@vger.kernel.org/msg14365.html">this
patch changelog</a> have better information on the
<tt>balance</tt> command than the <tt>btrfs</tt> man page).
Once again, this operation can take a long time; it involves moving a lot
of data between drives and generating checksums for everything.  At the
end, though, the administrator will have a nicely balanced RAID&nbsp;5
array without ever having had to take the filesystem offline:
<p>
<pre>
    # btrfs filesystem show /mnt
    Label: none  uuid: 6ca4e92a-566b-486c-a3ce-943700684bea
	    Total devices 3 FS bytes used 9.32GiB
	    devid    1 size 136.72GiB used 7.06GiB path /dev/sdb1
	    devid    2 size 136.72GiB used 7.06GiB path /dev/sdc1
	    devid    3 size 136.72GiB used 7.06GiB path /dev/sdd1
</pre>
<p>

Total space consumption has increased, due to the addition of the parity
blocks, but otherwise users should not notice the conversion to the
RAID&nbsp;5 organization.
<p>
A redundant configuration does not prevent disk disasters, of course, but
it does enable those disasters to be handled with a minimum of pain.
Let us imagine that <tt>/dev/sdc1</tt> in the above array starts to show
signs of failure.  If the administrator has a spare drive (we'll call it
<tt>/dev/sde1</tt>) available, it can be swapped into the array with a
command like:
<p>
<pre>
    btrfs replace start /dev/sdc1 /dev/sde1 /mnt
</pre>
<p>
If needed, the <tt>-r</tt> flag will prevent the system from trying to read
from the outgoing drive if possible.  Replacement operations can be
canceled, but they cannot be paused.  Once the operation is complete,
<tt>/dev/sdc1</tt> will no longer be a part of the array and can be
disposed of.
<p>
Should a drive fail outright, it may be necessary to mount the filesystem
in the degraded mode (with the "<tt>-o&nbsp;degraded</tt>" flag.  The dead
drive can then be removed with:
<p>
<pre>
    btrfs device delete missing /mnt
</pre>
<p>
The word "<tt>missing</tt>" is recognized as meaning a drive that is
expected to be part of the array, but which is not actually present.  The
replacement drive can then be added with
<tt>btrfs&nbsp;device&nbsp;add</tt>, probably followed by a balance
operation.
<p>
<h4>Conclusion</h4>
<p>
The multiple-device features have been part of the Btrfs design from the
early days, and, for the most part, this code has been in the mainline and
relatively stable for some time.  The biggest exception is the RAID&nbsp;5
and RAID&nbsp;6 support, which was merged for 3.9.  Your editor has not
seen huge numbers of problem reports for this functionality, but the fact
remains that it is relatively new and there may well be a surprise or two
there that users have not yet encountered.
<p>
Built-in support for RAID arrays is one of the key Btrfs features, but the
list of advanced capabilities does not stop there. 
Another fundamental aspect of Btrfs is its support for subvolumes and
snapshots; those will be discussed in the next installment in this series.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Btrfs-LWNs_guide_to">Btrfs/LWN's guide to</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Btrfs">Filesystems/Btrfs</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/577961/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor578300"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 21:25 UTC (Mon)
                               by <b>gioele</b> (subscriber, #61675)
                              [<a href="/Articles/578300/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hasn't Btrfs grown to become more like a new VFS or a new LVM than a simple filesystem?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578300/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578302"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 21:28 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/578302/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That was the plan from the very start :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578302/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor578330"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 23:24 UTC (Mon)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/578330/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The duplication of MD functionality was always part of the plan. It's difficult to really conclude whether this is a good idea. <br>
<p>
For RAID, there's a massive benefit, and Jon did a great job of explaining much of the benefit. A RAID layer that knows about the file system is far more powerful and intelligent. <br>
<p>
On the other hand, it's easy to look at other Device Mapper targets and wonder why they won't become a part of Btrfs. For example, dm-crypt is a particularly interesting example. Btrfs has no builtin support for encryption and doesn't have any plans to do so. Instead, the authors advise users to setup each drive individually with LUKS. That's a poor solution. Now you have N hard drives each configured with different keys and salts (although the same passphrase) that may need to be unlocked separately before mounting the multi-device Btrfs file system.<br>
<p>
Btrfs is supposed to be a fancy multi-device, super intelligent file system, but the way that it treats encryption is lousy. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578330/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578361"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 0:53 UTC (Tue)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/578361/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;authors advise users to setup each drive individually with LUKS. That's a poor solution.</font><br>
<p>
Well, the cryptanalists will probably find some scare stories. If you do not encrypt at the block layer, it is conceivable that your tree structure(s) become somewhat visible (as is the case with encfs).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578361/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 2:17 UTC (Tue)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/578378/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That wouldn't apply to Btrfs.<br>
<p>
Btrfs writes directly to the devices. It's not stacked on top of a regular file system like Encfs (where the regular file system's metadata is what leaks and is the concern that you noted). It would be easy to have Btrfs have an encryptions "plugin" that where data goes through on the way to be written/read from the various devices and have a simple LUKS style header on one or more of the disks. <br>
<p>
The problem with Encfs entirely lies with the lower file system (Ext4, XFS, etc.) because that metadata (file names, inode/extents, permissions/attributes, etc.) is not encrypted. Btrfs is completely capable of securing it. <br>
<p>
It always seemed like a silly omission. It would not have been that complicated largely because the dm-crypt code could have been used, and the kernel has secure key storage and encryption/hash algorithms already implemented. Unfortunately, the clearest way to implement it would be a LUKS-like header on the file system, and I don't think such a thing is possible since the on-disk format was declared stable recently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578418"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 7:02 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/578418/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, encfs can encrypt filenames and other attributes. It can't encrypt the tree structure itself, but it doesn't look like a major problem to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578418/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578500"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 17:41 UTC (Tue)
                               by <b>deepfire</b> (guest, #26138)
                              [<a href="/Articles/578500/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If it can't encrypt the tree structure, doesn't this mean that the tree structure can be surreptitiously tampered with?<br>
<p>
With LUKS you cannot do any transformation on the content of the block device -- any attempt will result in detectable corruption.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578500/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578502"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 17:44 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/578502/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, it can be. Attacker can also corrupt it, but they won't be able to surreptitiously change data.<br>
<p>
I don't think that manipulation of the tree structure is such a big issue.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578502/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578514"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 19:36 UTC (Tue)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578514/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is if you can do a chosen-plaintext attack.<br>
<p>
Let's say I have my /home encrypted with encfs. Let's assume that Joe Cracker, or a Nameless Subversive Adversary (nice acronym, I might keep it), can email me an attachment which in most typical mail programs ends up somewhere on disk. It's easy to find that file.<br>
<p>
It's also easy to find my holiday pictures, or my tax returns. Just check the file's modification date and the file size (+/- a few bytes).<br>
<p>
You can now plant incriminating evidence. Send appropriate emails which look like spam, confiscate my hard disk, move files around.<br>
<p>
I basically have no chance in hell to convince a jury that yes, this is an encrypted system to which only I have the key (unless another Nameless Subversive Adversary has implanted a keylogger in my keyboard's controller), BUT no, my notes originally stated that this money got sent to a banana shipping company, NOT to one that typically ships cocaine; and no, I did NOT take this expertly-manufactured image of me banging an underage prostitute.<br>
<p>
Just as one not-entirely-farfetched example.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578514/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578519"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 19:45 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/578519/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The date is encoded in the encrypted filename, btw. At most you'd be able to swap attachments between e-mails, if they have the same unencrypted filename.<br>
<p>
Knowing plaintext of any e-mail (or any file, for that matter) gets you exactly nothing, because ecryptfs also authenticates file content with MACs so the content is not malleable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578519/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor578793"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 16:35 UTC (Thu)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/578793/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All a encrypted file systems or block devices are good for is stopping people from reading the data on it when your machine is turned off. <br>
<p>
If your machine is running and the filesystem is mounted when it is captured then it's largely worthless at protecting your data. If your machine is compromised, the FS is mounted or at any point after that the file system gets mounted then it's not going to help you.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578793/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor578794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 16:49 UTC (Thu)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/578794/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can automate the decryption of the drives via a keyfile. So you can have it on a USB key or sd card or whatever that gets inserted during boot up. (note having your boot loader on a usb key you always have on you will help counter the 'evil maid' attack) <br>
<p>
command line option:<br>
<p>
rd.luks.key=&lt;keypath&gt;:&lt;keydev&gt;:&lt;luksdev&gt;<br>
<p>
<a href="http://www.freedesktop.org/software/systemd/man/systemd-cryptsetup-generator.html">http://www.freedesktop.org/software/systemd/man/systemd-c...</a><br>
<p>
Note that I have not tried this out myself.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor578305"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 21:58 UTC (Mon)
                               by <b>jaa</b> (subscriber, #14170)
                              [<a href="/Articles/578305/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
First of, thank you Jonathan for very interesting article serie.<br>
<p>
Secondly, what will happen nowdays with btrfs, if you have btrfs(raid1/raid5) as root partition and one drive is missing? Last time I tried the result was busted boot and drop to emergency shell (I think it was with Fedora F18 or F19). Or maybe this has more to do with with boot scripts of distribution in question?<br>
<p>
In any case, it would be interesting to hear if it possible to support degrated boot with btrfs-root partition.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578305/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578311"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 22:07 UTC (Mon)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/578311/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      In my experience, btrfs will not mount a filesystem in the degraded mode unless explicitly told to do so.  So yes, I can see how that could break things at boot time.  It may take a while for various distributions' initramfs and boot-time scripts to catch up.
      
          <div class="CommentReplyButton">
            <form action="/Articles/578311/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578363"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 1:07 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/578363/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This isn't just a problem for btrfs of course.  MD needs to solve it too.<br>
<p>
In the "good old days" when boot was sequential and predictable you would just wait until all physical devices had appeared, then assemble arrays out of whatever happens to be available, starting arrays as degraded if not enough devices are present because it is obvious that the missing devices are absent.<br>
<p>
In the "brave new world" where everything is dynamic and hot-plugged there *is*no*moment* when you can say "everything has been discovered" so there is no moment when you can clearly say "No more devices will appear, I may as well start whatever arrays I can, even if they are degraded".<br>
<p>
My current approach is to start a timer when it is first possible to assemble an array degraded.  If the missing device(s) appear(s) before the timer goes off, the array gets started and the timer is stopped.  If the timer fires, the array is started degraded.<br>
<p>
Choosing a timeout that is appropriate for a system with 2 drives, and also appropriate for a system with 1024 drives is not straight forward....<br>
<p>
Maybe I want to restart the timer any time any device at all appears ....  But I don't think that is straight forward either :-(<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578363/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578434"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 10:39 UTC (Tue)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/578434/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Maybe I want to restart the timer any time any device at all appears .... But I don't think that is straight forward either :-(</font><br>
<p>
That's pretty much a watchdog, isn't it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578434/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor578517"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 19:39 UTC (Tue)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578517/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; Maybe I want to restart the timer any time any device at all appears.</font><br>
<font class="QuotedText">&gt;&gt; But I don't think that is straight forward either :-(</font><br>
<p>
No? Any new device triggers a bunch of udev events. Even if that last RAID disk is attached behind three USB hubs (don't laugh, it can happen), enough events fire regularly that a timeout of five seconds or so should not be a problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578517/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor579227"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2014 13:32 UTC (Sun)
                               by <b>lbt</b> (subscriber, #29672)
                              [<a href="/Articles/579227/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Isn't the "correct" solution to start the array as soon as possible and handle later arrivals gracefully. aka md bitmaps.<br>
<p>
For non-bitmapped arrays it may be sensible to have a reserved bitmap area which is enabled when starting degraded and no-bitmap means no-bitmap-when-not-degraded.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579227/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2014 19:10 UTC (Sun)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/579242/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Certainly a possible solution, and probably an interesting solution.<br>
<p>
Not sure I'd call it "the correct" solution though.<br>
<p>
Having this approach as a fall-back could be used to justify having a fairly show timeout for my current solution.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor579243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 5, 2014 20:08 UTC (Sun)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/579243/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the problem is that if you start the array early and are modifying it, when the final drive(s) show up their content is useless and you have to rebuild them (at least with anything that was modified in the meantime, and that could in theory be the entire contents of disk)<br>
<p>
in addition, with the btrfs method os RAID, you will have multiple points where the array is 'complete enough to start' for different types of data, and if you have some data that's not replicated, you will need to wait for every disk.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2014 18:12 UTC (Mon)
                               by <b>lbt</b> (subscriber, #29672)
                              [<a href="/Articles/579247/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
(aside: "the correct" was definitely poor phrasing)<br>
<p>
Yes - you have to rebuild those parts which would have been written; but that's a little like a deferred write and is an aspect of what write-intent bitmaps in md are for.<br>
<p>
Once the bitmap is full that could become a complete re-sync; but given I've used my system so much that I've filled up the bitmaps I'd say I'd have been rather grumpy if the alternative was that I was still sitting watching a boot prompt and waiting for a device to arrive (by courier rather than usb one assumes!)<br>
<p>
I don't follow - if an array is "complete enough to start [degraded]" for say data but not metadata then it's not yet complete enough to start. If a given non-resilient configuration can't use this early boot method then that's OK.<br>
<p>
In general this is about handling on-going device arrivals in a RAID and avoiding blocking until "all devices are ready"; I'm suggesting that an optimistic approach combined with dynamic write-intent bitmaps may be a solution.<br>
<p>
Also note that degraded assembly in RAID terms is not the same as forcing a potentially corrupt assembly where event counts mismatch.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor582089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 23, 2014 18:51 UTC (Thu)
                               by <b>psusi</b> (guest, #95157)
                              [<a href="/Articles/582089/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Absolutely not.  Any time you bring the array up degraded ( and not read-only ), you risk a drive failure killing the whole array.  Thus, you don't do this just because a drive is a little late to the party -- you make damn sure it's not coming back.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/582089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor579426"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2014 13:30 UTC (Tue)
                               by <b>jschrod</b> (subscriber, #1646)
                              [<a href="/Articles/579426/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is the code for this timer available anywhere?<br>
I think it's a stopgap measure that might come handy for more people. :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579426/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579491"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2014 22:46 UTC (Tue)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/579491/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Have a look in git://neil.brown.name/mdadm, particularly the systemd directory.<br>
<p>
<a href="http://git.neil.brown.name/git?p=mdadm.git;a=tree;f=systemd;h=1afb72b72f91ee85571a6d7db4fff2a3e39e090c;hb=HEAD">http://git.neil.brown.name/git?p=mdadm.git;a=tree;f=systemd;...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579491/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579699"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 0:56 UTC (Thu)
                               by <b>jschrod</b> (subscriber, #1646)
                              [<a href="/Articles/579699/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With openSUSE support. Just what the chef recommended.<br>
<p>
Cool -- thank you. If we ever meet on some conference, a bottle of wine's on you.<br>
<p>
Cheers,<br>
Joachim (FWIW, core-TeXie)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579699/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor579844"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: booting with degrated root-partitions?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 23:34 UTC (Thu)
                               by <b>Lennie</b> (subscriber, #49641)
                              [<a href="/Articles/579844/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe I'm just stupid, but I've tried this many number times, including a number of times during this year with recent kernels.<br>
<p>
Even if I pass the right degraded argument to the kernel commandline and completed a rebalance before I did a shutdown and removed the drive, it did not work.<br>
<p>
I think sometimes grub was even to read the ramdisk and kernel from the disk, but the kernel failed to mount the filesystem proper.<br>
<p>
Just try it.<br>
<p>
It makes me kind of sad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579844/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor578301"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RAID 5/6 not ready for production</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 22:03 UTC (Mon)
                               by <b>jhhaller</b> (guest, #56103)
                              [<a href="/Articles/578301/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While the in-kernel code can create and use RAID 5/6, the code to recover from drive/OS failures is not fully implemented yet. RAID 1/10 are supported.<br>
<p>
I would also recommend that adding a drive or drives is best done when the filesystem is nearly empty. Scrubbing a 13TB (raw space) RAID-5 filesystem took almost a week, and balancing the new drive into RAID-5 is still in progress.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578301/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RAID 5/6 not ready for production</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 12:12 UTC (Thu)
                               by <b>Darkstar</b> (guest, #28767)
                              [<a href="/Articles/579760/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is the reason I'm wondering why btrfs doesn't do RAID4 (i.e. with a dedicated parity drive). This is one of the coolest features that a certain enterprise-storage has, namely being able to add disks instantly to a live RAID group without the need of any rebalancing. The drawbacks of RAID4 (the increased I/O load on the parity disk) can easily be avoided by a filesystem-aware RAID driver which is already implemented in btrfs (by making sure that only full stripes are ever written).<br>
<p>
This would probably mean that data and metadata RAID levels must match but that would be a small price to pay for getting rid of RAID5 rebalancings<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579761"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RAID 5/6 not ready for production</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 12:46 UTC (Thu)
                               by <b>obrakmann</b> (subscriber, #38108)
                              [<a href="/Articles/579761/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The RAID4 (and RAID6, too) implementation of said enterprise storage vendor certainly isn't immune to imbalance.  Hot-adding a drive to a raid will lead to that drive being a hotspot until it fills up enough to catch up with the rest of the drives.  Just look for any discussion of the reallocate command on their community site.<br>
<p>
Also, the effort required to avoid I/O bottlenecks for a similar filesystem in Linux would be huge (and would probably trigger quite a patent scare). The memory requirements would probably also be quite high.<br>
<p>
That said, I love working with their systems so much, and man would it be nice to have a mainline Linux filesystem with a similar feature set!  Btrfs just falls far too short for that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579761/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor578309"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 22:10 UTC (Mon)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578309/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      One question: suppose I use RAID6 for metadata and RAID5 for data. Two drives fail. Random pieces of my data is now unreadable â€¦ so what exactly <b>is</b> the use case for having more redundancy in my metadata? 

The only reason that I can think of would be a slow off-site backup copy (btrfs' incremental backup feature is rather nice for creating that, admittedly) which I might use to restore the unreadable parts of my data â€“ but is there a btrfs tool which emits the missing filename+offset+length triplets which I could use to fetch andre-write the holes?

Speaking of backup, does the output (and thus the applicability) of btrfs' incremental backup depend on the disk geometry, or can I apply any backup as long as the source and destination snapshots' contents match?
      
          <div class="CommentReplyButton">
            <form action="/Articles/578309/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578316"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 22:27 UTC (Mon)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/578316/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
well, assuming that it's not the same drives for your data and your metadata (think very large storage systems where the metadata may be on SSDs and the data on SATA)<br>
<p>
if you loose too many data drives, you have lost some random chunk of your data.<br>
<p>
if you loose too many metadata drives, you have lost _all_ your data.<br>
<p>
that can make it worthwhile to protect your metadata more.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578316/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579105"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2014 0:07 UTC (Sat)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/579105/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>
if you lose too many data drives, you have lost some random chunk of your data.
<p>
if you lose too many metadata drives, you have lost _all_ your data.
</blockquote>
<p>
Actually, if you lose too many data drives, you have lost myriad random chunks spread throughout your data.  The question is is there a use case where that is substantially better than losing everything.
<p>
I think such use cases are too rare for us to talk about using higher redundancy in the metadata than in the data.  I think the reason for using higher redundancy in the metadata than in the data is spot defects (you lose one whole drive plus one sector of another, not two whole drives).

      
          <div class="CommentReplyButton">
            <form action="/Articles/579105/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579166"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2014 14:54 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/579166/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      I sincerely hope they'll add ability to use different RAID modes for different files soon. Because I can easily see a case for <b>that</b>: 20-30GB game downloaded via Steam does not need redundancy at all (I can easily donwload it again), while 1000-10'000 times smaller save files for that same games deserve as much redundancy as I can get. Different RAID modes for data and metadata? Meh. Not interested.
      
          <div class="CommentReplyButton">
            <form action="/Articles/579166/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2014 17:52 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/579181/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Uhm, would you like to lose ALL your data at once (important and unimportant alike) because one of the RAID-0 disks died and all your metadata is now corrupted?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579194"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2014 22:30 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/579194/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Of course not - and metadata most definitely belong into the bucket where inportant files reside. But if said bucket can <b>only</b> contain metadata and nothing else thenâ€¦ I have no usecase for that.</p>

<p>I guess I can try to convert my important data into a metadata (you can convert file into a directory if you use filenames as small pieces of content), but all these tricks quickly becoming excercise in frustration.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/579194/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor578452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 14:05 UTC (Tue)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/578452/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Metadata IO errors have a bigger impact, so the admin might want a higher redundancy for them.<br>
<p>
Also raid1 for metadata and raid5/6 for data will tend to perform much better than raid5 for metadata (fewer sub stripe writes).<br>
<p>
-chris<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor578538"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 0:31 UTC (Wed)
                               by <b>ttonino</b> (guest, #4073)
                              [<a href="/Articles/578538/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Often, errors are single block and not whole drive failures.<br>
<p>
A single sector metadata error might make a part of a tree unavailable, leading to a huge loss of data.<br>
<p>
A single sector data error may hit a small file, an unimportant file, a video file where it will hardly be noticed when replaced with 00's...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578538/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578561"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 8:57 UTC (Wed)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578561/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
â€¦ or it may hit my accounting data where it will be sorely missed when the audit comes. (OK, one should also back up these files, but still â€¦)<br>
<p>
It's a question of what the file system does when there's a bad block. Recover from RAID, sure. Beyond that? Log the error and forget about it? Try to rewrite the offender? Mark the offending block as bad and write the recovered data to someplace else? Drop the whole RAID disk?<br>
Is there an integrity test which reads redundancy blocks and verifies that they match the actual data?<br>
<p>
MD has such a test, but it reads the whole disk regardless of whether there are actual data or just empty space, and when it does find an error it's next-to-impossible to figure out which file the problem belongs to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578561/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BACKUPS??!!!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 12:26 UTC (Wed)
                               by <b>liw</b> (subscriber, #6379)
                              [<a href="/Articles/578570/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Backups? Did someone say backups? Backups! BACKUPS! I HEARD SOMEONE SAY BACKUPS!!!!! BACKUPS ARE AWESOME! I LOVE BACKUPS! BACKUPS ARE BETTER THAN SLICED BREAD BECAUSE I HAVE A SHARP BREAD KNIFE!<br>
<p>
If it's data you care about, you make backups. Any data you haven't backed up, you WILL lose.<br>
<p>
If you really care about the data, you back it up multiple times. I used to have 7 backup copies of all my precious live data, not counting multiple copies on the same storage system (e.g., those made by RAID). Some of these were backups of backups, because that was necessary to thwart certain attack scenarios.<br>
<p>
RAID is excellent for reducing the need to restore: if RAID can fix a disk failure problem for you, you don't have to restore. But RAID is not a backup, and relying on it means you will lose data.<br>
<p>
It is the new year. Apart from 1920x1080 and 445 PPI, a really good resolution for this year would be to make sure you a) review all your data to know what's precious b) review and test all your procedures for backing up, restoring, and verifying backups c) help your loved ones convert from "I know I should" to "I do and I know they work".<br>
<p>
(This was my first backup rant of 2014. I will make more. Be prepared.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BACKUPS??!!!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 16:34 UTC (Wed)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578593/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yay, backups. ;-)<br>
<p>
btrfs is way cool for storing backups. Store the backup on a btrfs volume, create a snapshot before "rsync -a --inplace --delete"ing to the master copy, periodically throw away some (but not all) old snapshots, you're done.<br>
<p>
(Except for these pesky database files which need to be dumped instead of block-copied â€¦ so, instead of many FS snapshots, you store a few DB snapshots plus the transaction logs.)<br>
<p>
These days, of course, you can do the snapshot on the master and use btrfs' diff-and-apply to extract the changes, which is a whole lot faster than using rsync.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor580812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BACKUPS??!!!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 16, 2014 17:57 UTC (Thu)
                               by <b>oldtomas</b> (guest, #72579)
                              [<a href="/Articles/580812/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, the accounting file is the prime example for "classical" backups (by that I mean: backup is a snapshot of the data which you treat as read-only and never ever touch unless for restore). There's an important place for that, and as grandma says "RAID ain't no backup".<br>
<p>
Sometimes backups in the classical sense are just impractical: the image archive with hundreds of terabytes of images; you know something went sour in there, but a restore will take you a week (your customers are elsewhere by then)...<br>
<p>
File systems supporting those classes of problem will become more and more important as long as practical capacity grows faster than practical bandwidth (as is the case at the moment). Either something like btrfs or something totally distributed (Ã  la Ceph -- I don't know which direction Hammer has taken of late).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/580812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor578576"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 13:24 UTC (Wed)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/578576/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On Btrfs, you can start a scrub which will read all the data and metadata blocks and report on errors.<br>
<p>
If you're raided, it'll fix the bad block (raid5/6 don't support this yet), and there are inspection commands to follow backrefs to find the file  that owns the block.<br>
<p>
-chris<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578576/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 18:17 UTC (Wed)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/578613/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also there is the command "btrfs device stat" which reports the error statistic of [each] disk<br>
<p>
root@octopus:~# btrfs device stat /mnt/storage/<br>
[/dev/sdc].write_io_errs   0<br>
[/dev/sdc].read_io_errs    0<br>
[/dev/sdc].flush_io_errs   0<br>
[/dev/sdc].corruption_errs 0<br>
[/dev/sdc].generation_errs 0<br>
[/dev/sdd].write_io_errs   0<br>
[/dev/sdd].read_io_errs    0<br>
[/dev/sdd].flush_io_errs   0<br>
[/dev/sdd].corruption_errs 0<br>
[/dev/sdd].generation_errs 0<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor578314"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 30, 2013 22:24 UTC (Mon)
                               by <b>ssam</b> (guest, #46587)
                              [<a href="/Articles/578314/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One thing to note is that when you convert between levels the tools allow you to produce pointless combinations.<br>
<p>
If you start with a single drive system (defaults to data=single, metadata=dup), then add a drive and do<br>
btrfs fi balance start -dconvert=raid1 /mnt<br>
you will end up with a filesystem where your data is nicely protected by raid1, but you metadata is still dup, so not guaranteed to spread across drives.<br>
<p>
Its up to the user to make sure that the metadata is at least as well protected as the data.<br>
<p>
(details of my experience <a href="http://thread.gmane.org/gmane.comp.file-systems.btrfs/20624/focus=20815">http://thread.gmane.org/gmane.comp.file-systems.btrfs/206...</a>)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578314/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579276"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2014 11:33 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/579276/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be a good idea to have the conversion tool show a warning if the metadata is less protected than the data.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579276/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor578379"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 2:13 UTC (Tue)
                               by <b>ceswiedler</b> (guest, #24638)
                              [<a href="/Articles/578379/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why is the output from df so nonsensical? I can understand why it won't always be as accurate or informative as the btrfs-specific equivalent, but it seems stupid and pointless for the standard df tool to report that a raid1 array has the sum of the capacity of its disks.<br>
<p>
This is going to get fixed at some point, right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578379/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578427"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 10:06 UTC (Tue)
                               by <b>cwillu</b> (guest, #67268)
                              [<a href="/Articles/578427/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Probably not:  there's a pool of space that hasn't been allocated to any particular block group, it's impossible to say how that space will be used.  If you're going to write large files, it'll probably go to a data block group (say, raid5).  If you're going to write a bunch of tiny files, it'll probably go to the metadata block group (say, raid1).  <br>
<p>
Add into this the plans to have different allocation policies per subvolume/folder/file/whatever, and mix thoroughly with the syscall du uses not actually returning the values du prints to the screen (du needs to do some simple arithmetic), and you can see how this gets complicated.  Calculating a simple free space value ends up requiring you to know the future.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578427/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578688"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 2:43 UTC (Thu)
                               by <b>zuki</b> (subscriber, #41808)
                              [<a href="/Articles/578688/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Calculating a simple free space value ends up requiring you to know the future.</font><br>
<p>
It should be enough for btrfs to "predict the future" as a simple extension of present time. If right now I have a certain RAID level, it'd be quite useful for df to return how much free raw disk space I have divided by current average duplication level. Every other answer seems less useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578688/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor578472"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 16:16 UTC (Tue)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/578472/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's no way to fix it. <br>
<p>
The problem is that people conflate two questions when they use df:<br>
<p>
1) How much space is not currently used?<br>
<p>
2) How much space is available for writing?<br>
<p>
Traditionally, the answers to both questions were almost identical. Btrfs changes that dramatically. Df answers #1, but the user is usually asking #2. <br>
<p>
#2 cannot really be answered on Btrfs due to its features and design. Currently, you can set dup and RAID mode for data and metadata independently. Df could cope with this *as the features are currently implemented* because it's only possible to set those values for the entire file system. However, eventually it will be possible to set these at the subvolume (or even per-file!) level, which causes a problem. Additionally, there are features like compression or dedup that complicate things in the other direction.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578472/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578480"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 16:30 UTC (Tue)
                               by <b>ceswiedler</b> (guest, #24638)
                              [<a href="/Articles/578480/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, you're right, what I want to see is the amount of space I can write to the disk. <br>
<p>
I get that in some cases it becomes impossible to answer the question in a simple fashion. And I don't expect that me, the armchair filesystem designer, is going to come up with better solutions than the btrfs people.<br>
<p>
But in the case listed, to answer the question of "how much space on a raid1 set" with "drivecapacity*2" seems really poor.<br>
<p>
Wouldn't it be better to use some conservative estimates for amount of space writeable rather than just listing the total free space? Just because df isn't going to be able to give a precisely correct number, I don't see why it needs to give a wildly incorrect one (in terms of how much space is writeable).<br>
<p>
Dedup, compression, subvolumes, file storage options, small files versus big ones--all of those I expect to be variables I have to cope with as a user. I get that. But I expect the basic df to tell me "if I wrote a stream of bytes to a generic location on this drive, ignoring duplication or compression, how many bytes could I write?"<br>
<p>
I don't mind that the number wouldn't be precise, or that in some cases it might not be correct at all. To me that's like running out of inodes when you still have space--okay, I can deal with it. But most of the time, space will run out first (by design) and so that's what I care about at a high level.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578480/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578486"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 17:03 UTC (Tue)
                               by <b>fandingo</b> (guest, #67019)
                              [<a href="/Articles/578486/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Yes, you're right, what I want to see is the amount of space I can write to the disk. </font><br>
<p>
There's your problem. That's not what df is meant to provide. <br>
<p>
Btrfs is an extraordinarily generic file system. Even though not all the features are complete, the idea is that you can enable a feature *anywhere* in the file system. Want to make a single directory RAID6 but the rest of the file system data single? Sure, that fits with the architecture, although there is no present implementation. <br>
<p>
<font class="QuotedText">&gt; Wouldn't it be better to use some conservative estimates for amount of space writeable rather than just listing the total free space? Just because df isn't going to be able to give a precisely correct number, I don't see why it needs to give a wildly incorrect one (in terms of how much space is writeable).</font><br>
<p>
What is conservative? Why is it df's job to calculate what an individual thinks is reasonable? There are two problems with this approach:<br>
<p>
1) The result will always be incorrect. At least the current implementation gives a correct answer, even if the user believes the df is answering the wrong question.<br>
<p>
2) There's simply no way to provide a consistent answer without knowing the write() operation. There's no "generic location," and that question directly undermines the flexibility of Btrfs.<br>
<p>
To me, whoever or whatever is reading the output of df or `btrfs fi df` should know the file system configuration and the implications of the reported free space to their desired operation. I'd much rather have accurate information, even if it means that I have to recognize, "hey, this file system is in dup, raid6, or what ever." <br>
<p>
There's simply too many different things that can affect on-disk use in Btrfs for df to take into account. The answer is very likely to be plain wrong and no less clear. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578486/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578510"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 18:52 UTC (Tue)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/578510/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm going to vent a little and say that I find it deeply disrespectful and frustrating to be told that the tools I use to do work with computers shouldn't work reasonably or provide relevant information or make my life easier and that instead I should become an expert in the underlying disk format of my filesystem so that I can calculate this by hand myself rather than have a tool that works do it for me.  I find this attitude to be insane.  The computers existence is to make my life easier and do work for me, not to be a complex puzzle to solve just to prove how smart I am.<br>
<p>
Having df provide an estimated free disk by default for btrfs, with an option to provide a more accurate but less useful raw number seem very reasonable to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578510/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578518"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 19:51 UTC (Tue)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578518/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But the point is that you don't know whether that file ends up stored as RAID-0 or RAID-1, so the number from DF is wildly inaccurate anyway.<br>
<p>
All _I_ care about is that this number from df is somewhat smaller than the actual number of bytes I am still guaranteed to be able to write. In the terminal case, I do NOT want to see ENOSPC when df tells me there's still a GB free on that disk. <br>
<p>
Anything else is nice-to-know; if df tells me that there's 1GB free but I can copy 10GB onto the disk before my write actually errors out, so much the better.<br>
<p>
<font class="QuotedText">&gt; a more accurate but less useful raw number</font><br>
<p>
What would you use that number for if it's less useful?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578518/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578610"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 18:10 UTC (Wed)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/578610/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; But the point is that you don't know whether that file ends up stored as </font><br>
<font class="QuotedText">&gt; RAID-0 or RAID-1, so the number from DF is wildly inaccurate anyway.</font><br>
<p>
<font class="QuotedText">&gt; All _I_ care about is that this number from df is somewhat smaller than </font><br>
<font class="QuotedText">&gt; the actual number of bytes I am still guaranteed to be able to write. In</font><br>
<font class="QuotedText">&gt; the terminal case, I do NOT want to see ENOSPC when df tells me there's</font><br>
<font class="QuotedText">&gt; still a GB free on that disk. </font><br>
<p>
I wrote [1] a patch which estimated the available space. The assumption of this estimation was the ratio bytes-allocated-on-the-disk/byte-consumed-by-files is constant in a filesystem.<br>
<p>
With all its limit, this estimation reached two goals:<br>
- it would be compatible with all the code which is unaware of BTRFS and its behaviour<br>
- it gave a good estimation when the space were exhausted.<br>
<p>
The main complaints of this patch were the wording: there was no a consensus about how describe <br>
- the space occupied on the disk <br>
- the free space available for the file<br>
- the sum of the space consumed by the files<br>
<p>
Time to time a new person came and tried to suggest a new set of wording....<br>
May be that it is time I have to re-pushing this set of patch..<br>
<p>
[1] <a rel="nofollow" href="http://www.spinics.net/lists/linux-btrfs/msg23158.html">http://www.spinics.net/lists/linux-btrfs/msg23158.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578610/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579281"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2014 13:35 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/579281/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That reminds me of DoubleSpace/DriveSpace and its bogus free space estimation *shudder*.<br>
<p>
Why not something simpler? The free space is the amount of bytes which could be written, on a single new file on the root of the subvolume, using the default data and metadata mode for the subvolume, and with worst-case expansion in case of transparent compression or deduplication.<br>
<p>
This should match the intuitive expectation of the user: if df says I have a hundred megabytes of free space, I should be able to create at least a single file containing a hundred megabytes, give or take a few hundred kilobytes for a metadata fudge factor.<br>
<p>
If after creating the hundred megabyte file it says I still have thirty megabytes free, that is great (extra disk space for free!). But if it says I have a hundred megabytes of free space, and writing a new file fails after fifty megabytes written, that is bad and should not happen unless there was a hardware failure.<br>
<p>
(I say single file because creating a hundred megabyte-sized files is obviosuly more expensive than a single hundred-megabyte file, and there is no way of knowing how many files the user will create.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579281/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579285"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2014 13:45 UTC (Mon)
                               by <b>cesarb</b> (subscriber, #6266)
                              [<a href="/Articles/579285/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I forgot about the used space part. So how about this for the used space:<br>
<p>
The total size is the amount of bytes which could be written, using the definition from my above comment, if the filesystem were *empty*. The used size is (total - free).<br>
<p>
This would have the following desirable properties:<br>
<p>
- A freshly formatted filesystem would have "used" 0 and "free" = "total".<br>
- A completely full filesystem would have "free" 0 and "used" = "total".<br>
- Adding new files is monotonic; "used" increases (or stays the same), "free" decreases (or stays the same).<br>
- The "total" value does not change, no matter how many files you add or remove.<br>
- If "free" says you have x bytes, you can create at least a file of up to x bytes, even if its contents came from /dev/urandom.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579285/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor578568"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 12:06 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/578568/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The solution here is clearly to soup up df so you can tell it whether you want to know free space or how much can be written. Heck, while we're about it add in multiple column support and reordering as was done long ago for ps.<br>
<p>
df provides crucial facilities btrfs-specific commands cannot: it reports on all filesystems at once (for a summary overview), and it reports on filesystems that may not be btrfs. Retaining those features is, IMHO, crucial, unless we're going to a world in which everyone has one huge btrfs filesystem and nothing else (all eggs in one data structural basket, not really my idea of a good time).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578568/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor578419"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 8:18 UTC (Tue)
                               by <b>jezuch</b> (subscriber, #52988)
                              [<a href="/Articles/578419/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm kind of disappointed with the RAID10 mode in btrfs. I'm currently using RAID10 in md (or was it dm?...) with just two drives, which was intended to give me an option to add more drives as necessary (I used to have four smaller drives - replacing them with two much larger drives was cheaper than going for four drives again). So the four-drive limitation is... limiting, but I guess it makes sense when there is a possibility to convert modes on the fly. The data placement in md also seems to be smarter, not just striping-across-mirror-pairs, and the redundancy levels (near and far) can be parameterized as well. Am I spoiled by all this richness of options? ;)<br>
<p>
I've read that there was an effort to unify the various RAID implementations in md, dm and btrfs. How's that going?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578419/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 31, 2013 14:08 UTC (Tue)
                               by <b>masoncl</b> (subscriber, #47138)
                              [<a href="/Articles/578453/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
MD raid10 is definitely more flexible than Btrfs raid10.  You can still have a 10 drive raid10 in btrfs, but it won't stripe over all 10 for a single logical address range.<br>
<p>
As I add N-way mirroring, the raid10 code will also gain more features.<br>
<p>
-chris<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578540"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 0:44 UTC (Wed)
                               by <b>ttonino</b> (guest, #4073)
                              [<a href="/Articles/578540/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Striping is over rated for rotating disks anyway. It is usually better to have a single file on a single disk, unless that file is huge. With seek time 10 ms, reading 175MB/sec, seek time 8.5 msec, reading a 1.4 MB chunk takes as long as a seek.<br>
<p>
Files much shorter than 1 MB are better off being a single disk, even for an otherwise idle disk (the slowest of 2 disks is slower than the fastest one of them, and as slow as the slowest).<br>
<p>
Striping is effective only when a single file is dominating the disk busy times - and that file is larger than a few megs. Otherwise, one file per disk is better.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578540/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578623"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 21:05 UTC (Wed)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/578623/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
AIUI striping is done at block level, not file level... at least that's how I understand it for LVM... and I seem to remember that the block size can be user-selected.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578623/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578845"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 21:44 UTC (Thu)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/578845/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; and I seem to remember that the block size can be user-selected.</font><br>
<p>
Yes. And these block sizes can be critically important to avoid massive penalties when writing small files to deeply stacked storage arrays.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578845/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor578557"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 5:30 UTC (Wed)
                               by <b>dirtyepic</b> (guest, #30178)
                              [<a href="/Articles/578557/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;    mkfs.btrfs -d raid0 /dev/sdb1 /dev/sdc1</font><br>
&gt;<br>
<font class="QuotedText">&gt; Here, we have specified striping for the data; the default for metadata</font><br>
<font class="QuotedText">&gt; will be dup.</font><br>
<p>
When there's more than one drive the metadata defaults to "raid1", but I think they're pretty much the same thing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578557/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor578585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 16:54 UTC (Wed)
                               by <b>dougg</b> (guest, #1894)
                              [<a href="/Articles/578585/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Btrfs should remain a file system and leave the storage side where it belongs. Its lower interface should be to a SCSI logical unit (LU) or, if you prefer, a VM drive (same thing). Then the (storage) target subsystem, md or block subsystems can take care of size, reliability, replication and backups.<br>
<p>
I'm looking at SCSI xcopy version 2 lite, what Microsoft calls Offloaded Data Transfer (ODX). It facilitates "point in time" copies via ROD (representation of data) tokens. This is almost a perfect mechanism for backups on a live system (i.e. consistent, almost no down time). With the help of a file system log it seems to solve the storage side of what VMWare calls vMotion: the ability to move a VM from one server to another while it is operating. Nicolas Bellinger's Linux target subsystem is part of the way toward implementing ODX; it already implements the building block behind VMWare's VAAI in this area (i.e. SCSI xcopy version 1).<br>
<p>
<a href="http://blogs.technet.com/b/matthewms/archive/2013/09/13/vmware-or-microsoft-offloading-your-storage.aspx">http://blogs.technet.com/b/matthewms/archive/2013/09/13/v...</a><br>
<p>
The redundant array of independent disks (RAID) is a remnant of the age of rotating disks. File systems should forget about it when looking to the future.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 1, 2014 21:07 UTC (Wed)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/578625/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Then the (storage) target subsystem, md or block subsystems can take care of size, reliability, replication and backups.</font><br>
<p>
But then you lose the ability to treat data and metadata differently...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578674"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 1:19 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/578674/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Btrfs allowing metadata to be on a different device LU would suffice for that, I think.  Does it?  <br>
<p>
There's no requirement for btrfs to take over all your RAIDity, is there?  I.e. you could still run it on top of MD (or what-have-you), so long as btrfs sees it as a block device?  So the one benefit of letting btrfs do the work is finer-grained control over what is stored how.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578674/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579164"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!^w^w</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 4, 2014 14:54 UTC (Sat)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/579164/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; So the one benefit of letting btrfs do the work is finer-grained control over what is stored how.</font><br>
<p>
There are a lot of optimizations that could be implemented with an integration between the filesystem and the storage layer<br>
- the "RAID write hole"[1] disappears: the filesystem checksum allow to determine which data is correct <br>
- more, you can also detect error due to random bit flipping on the platter (the disk size is becoming comparable with the error rate [2]) and correct it.<br>
- you don't need to "prepare" the raid before using it: with btrfs you need only few second to create a filesystem w/raid<br>
- you can have different raid profiles in the same filesystem: today BTRFS allow different raid profile only for data and metadata. It was discussed to allow different raid profiles per subvolume basis. [Even tough I am not so sure that it is a good idea, from an administrator point of view]. For example:<br>
  - you can put metadata on RAID1<br>
  - "valuable data" on raid 5/6<br>
  - "cache data" (i.e. downloaded films) on raid0<br>
<p>
The only point which I have to agree that the integration of the raid in a file-system requires longer developing time.<br>
<p>
<p>
<p>
[1] <a rel="nofollow" href="http://www.raid-recovery-guide.com/raid5-write-hole.aspx">http://www.raid-recovery-guide.com/raid5-write-hole.aspx</a><br>
[2] WD reports in its data-sheet an error rate of 1/10^14; an 1 TB disk are about 13^10 bit.... so if you read all the disk ten times, WD says that it is possible that you got a bit wrong<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579164/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor578664"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 1:04 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578664/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I disagree.<br>
<p>
For one, backups at the block level are a very stupid idea, especially if you have a log-structured file system, or one that can do snapshots.<br>
<p>
Also, you will need to have the whole file system in a consistent state in order to make a block-level snapshot. Surprise: this is an expensive operation. Not all work loads tolerate that.<br>
<p>
Also, speaking of taking care of size: Resizing a RAID (by adding a disk) is an expensive operation which touches the whole disk, even if most space is not allocated yet. On the other hand, as I understand it (correct me if I'm wrong) btrfs will only spread new files onto a new disk, which allows one to re-balance the file system at one's leisure. In my case, if I added a new disk, rebalancing the whole RAID would slow down my site for a week; btrfs would require around 80 hours, and I can limit that to dead time in the early morning.<br>
<p>
Also, a link to something that reads like a Windows commercial is hardly an endorsement for THIS crowd. :-P<br>
<p>
In any case, the text you linked to talks about treating a file like a file system, except that this file gets loopback-mounted on the SAN instead of on the host machine and you appear to be able to shrink it. The overlap between that blatant Windows commercial ^w^w^w blog post, and this topic, is essentially zero.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578664/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578849"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 23:34 UTC (Thu)
                               by <b>dougg</b> (guest, #1894)
                              [<a href="/Articles/578849/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Very stupid idea"?? Not it would seem to VMWare, Netapp, HP and Microsoft with more to come.<br>
<p>
Yes, "you will need to have the whole file system in a consistent state in order to make a block-level snapshot. Surprise: this is an expensive operation." And a point_in_time ROD based read can be made a very quick operation; continue almost immediately, backup ready to write whenever, take as many copies as you like; migrate that consistent FS state to another machine, etc.<br>
<p>
How many months has btrfs been delayed while its authors tried to re-invent and re-implement RAID?<br>
<p>
So you don't like marketing BS? Well welcome to planet earth. Just maybe there might be some useful information lurking in there. There doesn't seem to be much pedagogic material available. If you prefer something dry and obtuse, I can provide references to SPC-4 and SBC-3 drafts found at www.t10.org [No marketing BS there.]<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578849/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor578885"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2014 0:38 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/578885/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Btrfs is going to have stuff that is impossible to implement on classic RAIDs.<br>
<p>
For example, it's already possible to use different RAID levels for metadata and data. It's also going to be possible to set individual RAID levels for individual files.<br>
<p>
ZFS can do both, btw.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578885/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor578923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: multiple device support: remove it!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 3, 2014 7:40 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/578923/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Taking a consistent point-in-time snapshot is not a block-level operation, it's a file system problem, and whether it's a good idea or not for btrfs to have its own RAID implementation has nothing whatsoever to do with point-in-time snapshots. <br>
<p>
You cannot do snapshots and all the other cool ideas marketing talks about without file system and OS support. Which block-level technology is below that (file system's RAID, kernel block-level RAID, hardware RAID, no RAID, block storage file of the VM's host; directly connected, NAS, iSCSI, Acronym-of-the-Day) is completely irrelevant.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor578716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 2, 2014 7:26 UTC (Thu)
                               by <b>mrjoel</b> (subscriber, #60922)
                              [<a href="/Articles/578716/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I earnestly tried btrfs for a multi-drive server in the September timeframe, however ran into what I feel were insurmountable roadblocks.<br>
<p>
In short, in order to force fail a drive from a RAID1 in order to replace it, the filesystem must be unmounted, forcibly mounted as degraded, then the devices swapped, readded, synced, then un/remounted to remove degraded flag. I find it a requirement (with hotswap drives) to keep the filesystem mounted, force remove a disk, dynamically go into degraded state, pull the drive, add a replacement, add it and have the sync occur, and then dynamically leave degraded state. That isn't (as of four months ago) possible with btrfs!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/578716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579294"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2014 14:29 UTC (Mon)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/579294/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why you didn't use the command "btrfs device replace (old-dev) (new-dev)" ? (May be that at the time it was not available ).<br>
<p>
Anyway BTRFS is a young filesystem with a lot of capabilities, so some problems exist.<br>
For example, the last time I tried, it was impossible to remove a failed device (even tough it is possible to replace it !)<br>
<p>
GB<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579294/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579295"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2014 14:43 UTC (Mon)
                               by <b>mrjoel</b> (subscriber, #60922)
                              [<a href="/Articles/579295/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"the last time I tried, it was impossible to remove a failed device"<br>
<p>
Precisely for that reason. The particular board I was doing this testing on only had 3 SATA connectors, and I used one for a boot/system SSD and the other two for a RAID1 data volume. In order to have a new device to replace the old one with, I needed to force failure/removal of an existing one first, which I was not able to do.<br>
<p>
The actual thread is below, with several inconsistencies littered throughout.<br>
<p>
<a href="http://thread.gmane.org/gmane.comp.file-systems.btrfs/27953/focus=27964">http://thread.gmane.org/gmane.comp.file-systems.btrfs/279...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579295/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579764"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 12:59 UTC (Thu)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/579764/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hello,<br>
<p>
in your case you should<br>
- shutdown the system<br>
- replace (physically) the disk<br>
- reboot the system<br>
- mount in degraded mode ( mount -o degrade /dev/xxxx /mnt/xxxx) the btrfs filesystem<br>
- add the new device (btrfs device add /dev/&lt;new device&gt; /mnt/xxxx)<br>
- remove the "missing" device  (btrfs device del missing /mnt/xxxx), where missing is the word "missing" (not a device)<br>
<p>
Which BTRFS doesn't support is removing a device when it is not readable without doing an umount.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579764/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579789"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 17:33 UTC (Thu)
                               by <b>mrjoel</b> (subscriber, #60922)
                              [<a href="/Articles/579789/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even so, your response captures the issue I have with it because it uses the words shutdown, reboot, [re]mount. Using MD and ZFS, I can forcibly mark a disk as failed, hot remove and replace it, add the new device into the array, and after resync it is transfers to non-degraded state. During the entire process the system stays up and the filesystem is mounted and available for continued use.<br>
<p>
You also forgot to mention that a remount of the filesystem is also required at the end of the resync (when you have to remember after a few hours to follow-up on the system) to exit degraded mode. I found that even after adding a new device I wasn't able to exit degraded mode without remounting (even though the userspace tools reported it wasn't degraded!).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579789/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 18:59 UTC (Thu)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/579797/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I have to point out that removing is different from replace.<br>
- Removing means that I want to decrease the disk number indefinitely. Even if I can add another disk later. Often this means that I change the raid level.<br>
- Replace means that I want to replace a (faulty) disk with a new one.<br>
<p>
The two options can be done without un-mounting the filesystem, with the exception that it is not possible to *remove* a faulty disk without unmount.<br>
<p>
In your case (i.e. a system with only 3 sata ports), the replace is not a viable solution (you don't have the new disk). So you need to shutdown *anyway* the system. This is the reason why I used the word "shutdown"<br>
<p>
You wrote:<br>
"...mark a disk as failed, hot remove and replace it..."<br>
I read this as replace. This is fully working.<br>
<p>
May be that inverting your sentences I can be more clear: <br>
- it is not true that I need to unmount the filesystem to remove a device (with the exception of above)<br>
- it is not true that I need to unmount the filesystem to replace a device (even if the device is faulty)<br>
<p>
However I agree with you that removing a faulty device should be implemented properly.<br>
<p>
Regarding to exit from the "degraded mode", I don't see what is the problem. The degraded mode means that a filesystem can be mounted without some devices. Nothing more. I don't see the needing to remount the filesystem to remove this flag.<br>
<p>
BTW, I am not suggesting that NOW btrfs can be a replacement of MD. I am quite sure that there is a lot of corner cases not handled properly when a device is fault and need to be replaced. However the main pieces are there. It need only a lot of testing. (which is not secondary).<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579804"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 19:57 UTC (Thu)
                               by <b>mrjoel</b> (subscriber, #60922)
                              [<a href="/Articles/579804/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My claim is simply that in a disk failure scenario it is common to want to remove the drive and replace it with a new one, add it back to the array and have it resync itself and be off to the races. Full Stop.<br>
<p>
That is why much money is spent on enterprise servers with redundancy and why the concept of hot-swappable drive trays is so powerful. The variables of filesystem, RAID level, drive size, drive capacity, etc. don't matter (or are very secondary) in that scenario.<br>
<p>
You have a fair distinction on remove vs. replace, but only if considered for the long-term or permanent desired end state. However, I need to remove/degrade/fail a drive prior to bringing the replacement drive online, but only long enough to replace it with another one.<br>
<p>
I happen to be doing this testing with a limited system with 3 SATA ports, but that seems irrelevant since typically a system owner will want to use all drives that are available, and don't reserve an extra SATA/SAS channel for the times when a drive fails. The notion that I have to shutdown the system because of the number of sata ports or to make the new disk available is ludicrous to me - I have hot-swappable drive bays intentionally to not require that.<br>
<p>
I suppose I could forcibly physically remove the failing drive out from under btrfs, but that's not a clean option either. I'd rather give the system fair notice to stop using the device, but btrfs doesn't allow me to do that.<br>
<p>
<font class="QuotedText">&gt;&gt; "...mark a disk as failed, hot remove and replace it..."</font><br>
<font class="QuotedText">&gt; I read this as replace. This is fully working.</font><br>
No, it is not fully working, it fails at the first step! The other two steps do work in other scenarios, but claiming full or 2/3 functionality when it breaks at the first step is quite optimistic. To quote myself on the btrfs mailing list:<br>
<p>
    "I was surprised to find that I'm not allowed to remove one of the two drives in a RAID1. Kernel message is 'btrfs: unable to go below two devices on raid1' Not allowing it by default makes some sense, however a --force flag or something would be beneficial."<br>
<p>
In the end, I'd like btrfs to improve, however it has been slow going and with this latest round of failed testing for what is a simple enterprise requirement, I've lost most expectations of btrfs filling this need. I'm not against btrfs, I use it often on single drive systems, however don't have any confidence in it for anything but the gentlest of handling on multi-drive systems.<br>
<p>
This isn't just supposition or a paper study, I've tried it, and the following are quotes from Chris Murphy on the referenced thread:<br>
<p>
    "I'd expect to have to add a device and then remove missing"<br>
<p>
    "However, after adding a device and deleting missing, ... the btrfs volume is still mounted degraded. Further, if I [remount the filesytem with -o remount] it's still degraded. I had to unmount and mount again to clear degraded. That seems to be a problem, to have to unmount the volume in order to remove the degraded flag, which is needed to begin the rebalance. And what if btrfs is the root file system? It needs to be rebooted to clear the degraded option."<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579804/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579833"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 22:34 UTC (Thu)
                               by <b>kreijack</b> (guest, #43513)
                              [<a href="/Articles/579833/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; To quote myself on the btrfs mailing list:</font><br>
<p>
<font class="QuotedText">&gt; "I was surprised to find that I'm not allowed to remove one of the two </font><br>
<font class="QuotedText">&gt; drives in a RAID1. Kernel message is 'btrfs: unable to go below two</font><br>
<font class="QuotedText">&gt; devices on raid1' Not allowing it by default makes some sense, however a </font><br>
<font class="QuotedText">&gt; --force flag or something would be beneficial."</font><br>
<p>
I agree with you that allow to force a removing a disk would be useful; if a disk reports problem, it could slowdown the system due to the read-error-reset-retry cycle. So in this case it would be useful to stop using a disk.<br>
<p>
<font class="QuotedText">&gt; typically a system owner will want to use all drives that are available, and </font><br>
<font class="QuotedText">&gt; don't reserve an extra SATA/SAS channel for the times when a drive fails.</font><br>
On that I cannot agree, think about the spare disk... However this doesn't change the point:<br>
btrfs support an "add-remove" replace; but doesn't support a "remove-add" replace<br>
<p>
<font class="QuotedText">&gt; That seems to be a problem, to have to unmount the volume in order to</font><br>
<font class="QuotedText">&gt; remove the degraded flag, which is needed to begin the rebalance. And </font><br>
<font class="QuotedText">&gt; what if btrfs is the root file system? It needs to be rebooted to </font><br>
<font class="QuotedText">&gt; clear the degraded option."</font><br>
<p>
Are you sure about that ? I tried to rebalance a degraded filesystem (but after having added a new disk). It seems to work:<br>
<p>
ghigo@venice:/tmp$ sudo /sbin/mkfs.btrfs -K -f -d raid1 -m raid1 /dev/loop[01]<br>
WARNING! - Btrfs v3.12 IS EXPERIMENTAL<br>
WARNING! - see <a rel="nofollow" href="http://btrfs.wiki.kernel.org">http://btrfs.wiki.kernel.org</a> before using<br>
<p>
Turning ON incompat feature 'extref': increased hardlink limit per file to 65536<br>
adding device /dev/loop1 id 2<br>
fs created label (null) on /dev/loop0<br>
	nodesize 16384 leafsize 16384 sectorsize 4096 size 19.53GiB<br>
Btrfs v3.12<br>
ghigo@venice:/tmp$ sudo mount /dev/loop0 t/<br>
ghigo@venice:/tmp$ sudo umount t/<br>
ghigo@venice:/tmp$ sudo losetup -d /dev/loop0<br>
ghigo@venice:/tmp$ sudo mount /dev/loop1 t<br>
mount: wrong fs type, bad option, bad superblock on /dev/loop1,<br>
       missing codepage or helper program, or other error<br>
       In some cases useful info is found in syslog - try<br>
       dmesg | tail  or so<br>
<p>
ghigo@venice:/tmp$ sudo mount -o degraded /dev/loop1 t<br>
ghigo@venice:/tmp$ sudo btrfs fi balance t/<br>
ERROR: error during balancing 't/' - No space left on device<br>
There may be more info in syslog - try dmesg | tail<br>
ghigo@venice:/tmp$ sudo btrfs dev add -f /dev/loop2 t<br>
Performing full device TRIM (9.77GiB) ...<br>
ghigo@venice:/tmp$ sudo btrfs fi balance t/<br>
Done, had to relocate 2 out of 2 chunks<br>
ghigo@venice:/tmp$ cat /proc/self/mountinfo | grep loop1<br>
79 20 0:39 / /tmp/t rw,relatime shared:63 - btrfs /dev/loop1 rw,degraded,space_cache<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579833/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579836"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 22:39 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/579836/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; typically a system owner will want to use all drives that are available, and  don't reserve an extra SATA/SAS channel for the times when a drive fails.</font><br>
<font class="QuotedText">&gt; On that I cannot agree, think about the spare disk... However this doesn't change the point:</font><br>
<font class="QuotedText">&gt; btrfs support an "add-remove" replace; but doesn't support a "remove-add" replace</font><br>
<p>
A lot of people don't run with a spare disk. They run with all the disks active and when one fails they replace it.<br>
<p>
Yes, this extends the time when they are running in degraded mode, but since the disk will probably be significantly cheaper later, and there's no testing to see if the spare has a problem (and remember, it is running all the time), it's not a completely unreasonable thing to do.<br>
<p>
people routinely run their home systems in much riskier modes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579836/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor591126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2014 22:33 UTC (Wed)
                               by <b>dany</b> (guest, #18902)
                              [<a href="/Articles/591126/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I provide real world example from Solaris10/ZFS, I was recently dealing with.<br>
<p>
Company has servers with many disks, which have raid2z (sort of raid6 analogy) redundancy in zpools/zvols. There is no hot-spare and there is no extra space for new disk. One disk fails (in example, pool name is "pool", failed disk is c7t6d0). ONLINE disk replacement procedure with LIVE ZFS is going to be:<br>
<p>
1. zpool detach pool c7t6d0         #mark failed disk as detached for zfs<br>
2. zpool offline pool c7t6d0        #take disk out of zfs control<br>
3. cfgadm -l | grep c7t6d0          #figure out controller and target of disk<br>
sata5/6::dsk/c7t6d0            disk         connected    configured   ok<br>
4. cfgadm -c unconfigure sata5/6    #power off disk<br>
5. physicaly replace disk<br>
6. cfgadm -c configure sata5/6      #power on disk<br>
7. fdisk/format c7t6d0              #create partition table on disk<br>
8. zpool online pool c7t6d0         #bring disk under zfs control <br>
9. zpool replace pool c7t6d0        #resilver disk<br>
<p>
Similar capability was possible with older volume manager (SDS) in Solaris. For Linux and Solaris there is proprietary VxVM, which also can do that.<br>
<p>
So yes, there is a need for exactly this use case in LINUX also (no reboot, no remount, no extra space for new disk). I would definitely expect this functionality from next-gen FS. Actually it could be a risk to run FS without this capability for some companies. Yes hot-spares are great, but in real world, they are not always available.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/591126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor591130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 19, 2014 22:53 UTC (Wed)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/591130/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
I can't say anything about Btrfs, but the scenario you've outlined should be quite tractable on Linux with LVM and, e.g., Ext4.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/591130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor579837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 23:22 UTC (Thu)
                               by <b>mrjoel</b> (subscriber, #60922)
                              [<a href="/Articles/579837/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I agree with you that allow to force a removing a disk would be useful;</font><br>
<font class="QuotedText">&gt; if a disk reports problem, it could slowdown the system due to the</font><br>
<font class="QuotedText">&gt; read-error-reset-retry cycle. So in this case it would be useful to</font><br>
<font class="QuotedText">&gt; stop using a disk.</font><br>
<p>
<font class="QuotedText">&gt;&gt; typically a system owner will want to use all drives that are</font><br>
<font class="QuotedText">&gt;&gt; available, and don't reserve an extra SATA/SAS channel for</font><br>
<font class="QuotedText">&gt;&gt; the times when a drive fails.</font><br>
<font class="QuotedText">&gt; On that I cannot agree, think about the spare disk... However</font><br>
<font class="QuotedText">&gt; this doesn't change the point:</font><br>
<font class="QuotedText">&gt;   btrfs support an "add-remove" replace; but doesn't support</font><br>
<font class="QuotedText">&gt;   a "remove-add" replace</font><br>
<p>
I see these as two use cases of the same fundamental capability - removing a device when that action inherently results in running in a degraded state. That is indeed what I couldn't reconcile myself with when last evaluating btrfs and ended up being our showstopper.<br>
<p>
On the spare device issue, sure - having at least one hot spare is very common. However, I expect that one typically has a hotspare configured in the hardware RAID controller in which case btrfs just sees a single device so the multi-device support doesn't come into play. That loses the ability of btrfs to do direct device integrity checking, but seems to be the only option since the btrfs wiki lists "Hot spare support" as not claimed and nothing done [1]. Eliminating the cases where HW RAID is used, if an additional drive is spinning in a chassis, then the ideal is have all drives added as RAID-6 and/or a reserved hot spare (in fact, a hot spare in btrfs may end up being just be bump the N-level redundancy one level, which would offer the additional failure tolerance as well as offer the additional active spindle for I/O. However, since both hot spare and RAID6 are not implemented in btrfs, I assume most would be inclined to add it to the mix, especially since btrfs can use odd number of drives in RAID1 since it's per block not overall device.<br>
<p>
On the degraded flag changes, looks like it may have been updated since I was trying in August, I see some mailing list patches to allow changing feature bits while online, so that sounds like good news. However, even in your example, the mount still shows the degraded flag which is misleading, although understandable why required. At the time I was doing my testing, 'btrfs show' didn't reflect the actual runtime status of the filesystem from the kernel, and a quick perusal of the btrfs-progs git tree doesn't show anything updated related to that. So, at least in my mind, the question remains - if showing a degraded mount option in the mount arguments, how can one determine whether or not the mounted filesystem status is still degraded, or has been restored to nominal redundancy state?<br>
<p>
[1] <a href="https://btrfs.wiki.kernel.org/index.php/Project_ideas#Hot_spare_support">https://btrfs.wiki.kernel.org/index.php/Project_ideas#Hot...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor580273"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Btrfs: Working with multiple devices</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 13, 2014 23:53 UTC (Mon)
                               by <b>rodgerd</b> (guest, #58896)
                              [<a href="/Articles/580273/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
My experiences were similar: 3.10 long term kernel, BTRFS mirror (a simple case).  A pull-drive test resulted in a kernel panic and irretrievably corrupted drives.  <br>
<p>
A controlled removal resulted in an 18 hour wait for less than 1 TB of data to migrate from an old drive to a new drive, and then required a reboot to get btrfs to let go of the nominally removed drive.  <br>
<p>
I was pretty disappointed.  Have to try again next year...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/580273/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor579470"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Two meanings of RAID-1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2014 17:50 UTC (Tue)
                               by <b>hpa</b> (guest, #48575)
                              [<a href="/Articles/579470/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are two definitions of RAID-1, and it is very important to know that MD implements one and btrfs the other.<br>
<p>
If you have N devices, MD will store N copies of your data.  Any one drive in isolation contains the entire data.<br>
<p>
If you have N devices, btrfs will store *2* copies of your data, on any 2 devices out of the N available.  You need N-1 drives to remain good to be guaranteed to recover all data.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579470/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579805"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Two meanings of RAID-1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 19:32 UTC (Thu)
                               by <b>Pc5Y9sbv</b> (guest, #41328)
                              [<a href="/Articles/579805/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, I have a 3 disk RAID-1 array using mdadm and it gives me 1.5 the capacity of one disk.  It is actually more like the "RAID 1E" mode that some hardware RAID controllers provide.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579805/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579814"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Two meanings of RAID-1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 20:51 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/579814/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
are you sure that's not the RAID 10 mode? At one point I had a /boot partition that was a 12 disk RAID 1 with the space of a single disk's partition (I build a 12 disk system and needed the /boot so couldn't use that space for much else on the remaining disks, so I figured, why not?)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579814/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor579834"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Two meanings of RAID-1</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2014 22:38 UTC (Thu)
                               by <b>Pc5Y9sbv</b> (guest, #41328)
                              [<a href="/Articles/579834/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, you are right.  I forgot I had both raid1 (-n 2 with third disk as spare) and raid10 (-n 3 and no spare) on the same system.  So it is MD raid10 that acts like btrfs raid1.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/579834/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
