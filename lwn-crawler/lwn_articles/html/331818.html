        <!DOCTYPE html>
        <html lang="en">
        <head><title>The return of devfs [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/331818/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/330908/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/331818/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The return of devfs</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 6, 2009</br>
           </div>
<p> The drive for faster boot times has led to a number of changes in the
kernel.  Some, like the <a href="/Articles/330378/">parallelization of USB
initialization</a> we looked at last week, have caused disruptions for some
users.  But others, like the recently proposed <tt><a
href="/Articles/330985/">devtmpfs</a></tt>, have a different set of challenges.
While it may provide a good solution to reducing boot times,
<tt>devtmpfs</tt> faces some 
fairly stiff resistance, at least partially because it reminds some folks
of a feature previously excised from the kernel, namely <tt>devfs</tt>.
</p>

<p>
The basic idea is to create a <tt>tmpfs</tt> early in the kernel
initialization before the driver core has initialized.  Then, as each
device registers with the driver core, its major and minor numbers and
device name can be used to create an entry in that filesystem.  Eventually,
the root filesystem will be mounted and the populated <tt>tmpfs</tt> can be
mounted at <tt>/dev</tt>.
</p>

<p>
This has a number of benefits, all of which derive from the fact that no
user-space support is required to have a working <tt>/dev</tt> directory.
With the current udev-based approach, there is a need for a
reasonably functional user-space environment for udev to operate
in.  For simplified booting scenarios&mdash;like rescue tools or using the
<tt>init=/bin/sh</tt> kernel boot parameter&mdash;a functional
<tt>/dev</tt> directory is needed, in particular because of
dynamic device numbers.  It would also be useful for embedded devices that
do not need or want a full-featured user space.
</p>

<p>
Andrew Morton's immediate reaction was <a
href="/Articles/331939/">amusement</a>: "<q>Lol, devfs.</q>"  Greg
Kroah-Hartman, who authored the patch along with Kay Sievers and Jan
Blunck, <a href="/Articles/331941/">admitted</a> that it was a kind of
<tt>devfs</tt>: "<q>Well, devfs 'done right' with hopefully none of the
vfs problems the 
last devfs had. :)</q>"  But Morton is somewhat <a
href="/Articles/331943/">concerned</a> that "<tt>devfs2</tt>", as he calls
it, is just going over old ground:
<div class="BigQuote">
I think Adam Richter's devfs rewrite (which, iirc, was tmpfs-based)
would have fixed up these things.  But it was never quite completed and
came when minds were already made up.
<p>
I don't understand why we need devfs2, really.  What problems are
people having with [the] existing design?
</div>
</p>

<p>
Though the other advantages are important, Kroah-Hartman <a
href="/Articles/331944/">replied</a> with the crux of the argument for
<tt>devtmpfs</tt>:
<div class="BigQuote">
Boot speed, boot speed, boot speed.
<p>
Oh, and reduction in complexity in init scripts, and saving embedded
systems a lot of effort to implement a dynamic /dev properly (have you
_seen_ what Android does to keep from having to ship udev?  It's
horrible...)
</div>
</p>

<p>
But Alan Cox is not so sure.  His <a href="/Articles/331986/">argument</a>
is that moving this 
functionality (back) into
the kernel, just papers over a user-space problem, while increasing kernel,
thus not pageable, memory usage.  Others think that the kernel should just
buffer uevents&mdash;the messages generated by the kernel to send to udev
on device state 
changes&mdash;until <tt>udevd</tt> is started.  But, that doesn't solve the
synchronization problem: user space must still wait for a populated
<tt>/dev</tt> hierarchy.
</p>


<p>
A problem with the current scheme is that it
essentially does the device enumeration twice&mdash;once in the kernel as
devices are registered and once in user space by <tt>udevd</tt>, when it gets
started.  The device information that was gathered by the kernel is lost.  When
<tt>udevd</tt> initializes, it walks the <tt>/sys</tt> directory to find
devices, then creates device nodes for them.  That can take 1-2 seconds on
a complex system&mdash;on the order of twice the kernel boot time&mdash;but
worse still, no other user-space processes can start until this "coldplug"
pass has completed.  Using <tt>devtmpfs</tt>, there will be a working
<tt>/dev</tt> that other user-space code can use, so that the udev
coldplug pass can be done in parallel.
</p>

<p>
Several alternate methods of solving the problem were proposed in the
thread, but, by and large, Sievers was able to show why they didn't
actually solve
the problem.  In some cases, the behavior of <tt>devfs</tt> is being
incorrectly attributed to <tt>devtmpfs</tt>, but the two are quite different.
The new scheme would create root-owned device nodes, with fixed 0600
permissions, for each device.  It would avoid much of complexity of
<tt>devfs</tt>. As Sievers <a href="/Articles/331999/">puts
it</a>: 
<div class="BigQuote">
We are not implementing anything crazy here like devfs did, including
the later versions - there is no modprobe behind your back, no lookup
hooks, no stupid new naming scheme, no new filesystem type to
register.
</div>
</p>

<p>
Christoph Hellwig <a href="/Articles/332009/">objected</a> to the proposal
as well.  Part of his complaint is how quickly <tt>devtmpfs</tt> was added
to the linux-next tree, but he also sees it as adding <tt>devfs</tt> back
into the kernel:
<div class="BigQuote">
It basically does re-introduce devfs under a different name, and from
looking at the implementation it might not be quite as bad a Gooch's
original, but it's certainly worse than Adam Richters rewrite the we
never ended up merging.
<p>
Now we might want to revisit the decision to leave all the device name
handling to a userspace daemon, because it [proved] to be quite fragile
under certain circumstances, and you apparently see performance issues.
</div>
</p>

<p>
Sievers <a href="/Articles/332021/">outlines</a> the differences between
<tt>devtmpfs</tt> and Adam Richter's <a
href="http://marc.info/?l=linux-kernel&m=104138806530375&w=2">proposal</a>
from 2003.  It mostly boils down to complexity; <tt>devtmpfs</tt> is a much
simpler scheme, which really adds very little to the kernel.  The
implementation is around 300 lines of code, in comparison to roughly 3600
for devfs and 600 for an early version of Richter's mini-devfs.
</p>

<p>
Anticipating the next complaint, Sievers also points out that the device
naming policy is <i>already</i> in the kernel, but that udev can override
the kernel-supplied values if need be.  From his perspective this has
already occurred, making that an invalid argument against <tt>devtmpfs</tt>:
<div class="BigQuote">
The kernel carries the policy today for 98% of the devices,
if you change any driver given name, it will no longer show up in /dev
with the current name. That's the reality since years, and will not be
different anytime soon, there is no real naming policy besides the
current kernel supplied names.
</div>
</p>

<p>
It is clear that the <tt>devtmpfs</tt> developers have put a fair amount of
thought into just what was needed, and how it could work with existing
code&mdash;both inside and outside the kernel.  It is also clear that there
is some resistance to returning to anything even remotely reminiscent of
<tt>devfs</tt>.  Because <tt>devtmpfs</tt> is really quite different, and
has a nice effect on boot speed, one would think that it is likely to find
its way into the mainline sooner or later.  If no further objections are
raised, and the 
linux-next trials go well, 2.6.31 may very well be the release that sees
the inclusion of 
<tt>devtmpfs</tt>.  
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#devfs">devfs</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#udev">udev</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/331818/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor332190"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 1:36 UTC (Thu)
                               by <b>arjan</b> (subscriber, #36785)
                              [<a href="/Articles/332190/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This devtmpfs is not need to boot fast. Really. <br>
<p>
This is a workaround for a certain distros crappy mkinitrd basically, and nothing more; if you do the initrd correct (or if you don't use an initrd at all), you don't need this "solution" and you'll even boot faster....<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332190/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332200"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 2:29 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/332200/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So, how come nobody has simply done a port of Debian's initramfs-tools to Fedora and SuSE so we <br>
can be done with this whole mess of bad initramfs implementations? I've not played with any of <br>
them extensively, but from what I've read it sounds like everyone else's initramfs implementations <br>
are pretty terrible, and Debian's is flexible enough to be used by any distro already.<br>
<p>
If that's all true, it ought not be much work to port it and demonstrate its superiority and people <br>
can stop wasting time on this stuff, no?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332200/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332214"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 5:42 UTC (Thu)
                               by <b>niner</b> (subscriber, #26151)
                              [<a href="/Articles/332214/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Now I'm curious: what does Debian do right, while others do it wrong?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332214/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332448"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 0:57 UTC (Fri)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/332448/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The only thing that Debian does right that I haven't seen in other distros is that Debian's <br>
initramfs is easier for end users to hack with. <br>
<p>
A) It's documented<br>
<p>
B) Tools to do things like rebuild the initramfs are easily accessable, documented.<br>
<p>
C) The initrd scripts are init-like. They are modular, commented, and occupy a directory <br>
structure in /usr/share/initramfs/ that makes sense according to their purpose and what part <br>
of the boot process they are executed. <br>
<p>
D) They have examples on scripts you can make on your own.<br>
<p>
E) If you install packages that may impact boot-up proceedures, like maybe some hardware, <br>
like LVM, then hooks are added to that directory structure. If you do not have packages for <br>
LVM then support is not in the initramfs irregardless.<br>
<p>
F) It's very easy to add busybox support so that you can do things like shove a 'sh' into the <br>
boot procedure and get a shell to troubleshoot your scripts.<br>
<p>
G) It's documented<br>
<p>
H) The scripts have examples and decent comments.<br>
<p>
<p>
It's certainly not perfect and there are better ways to do stuff. But most of the time dealing <br>
with initrd scripts they are just monolithic and very unfriendly. <br>
<p>
With a evenings worth of effort I've done things like devise a means to reliably network boot <br>
the system using iSCSI software initiator. I've created layered root file systems using <br>
compressed read-only file systems and things like AUFS, which I used on my EEEPC for a <br>
number of montsh.<br>
<p>
I did all this using my own hooks and add-on scripts that didn't affect the the existing Debian <br>
scripts and didn't break when the system was updated. <br>
<p>
Sure it ends up creating a little 'mini-linux-distro' that gets loaded into RAM and that ends up <br>
making stuff slow as shit, during the initial boot process, but is actually something that a <br>
experienced administrator can usefully use. <br>
<p>
Every other distribution I've used always had the most horrid hacks and special-purpose <br>
scripts that supported whatever configurations the installer supported, but were a pain to deal <br>
with and customize. <br>
<p>
Oh, and they were all poorly documented.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332448/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 0:58 UTC (Fri)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/332449/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh. And Midori mangles newlines in when you try to post comments. Hateful. Hateful. Hateful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 15:15 UTC (Fri)
                               by <b>MarkWilliamson</b> (guest, #30166)
                              [<a href="/Articles/332534/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm posting from a KHTML embedded in Akregator and it newline mangles my posts<br>
as well...  Yet posting from KHTML in a full Konqueror instance does not.  I think<br>
Akregator has some Javascript restrictions but otherwise it's using the same engine. <br>
Curious.<br>
<p>
Got any interesting Javascript settings in Midori?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor332478"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 7:11 UTC (Fri)
                               by <b>niner</b> (subscriber, #26151)
                              [<a href="/Articles/332478/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW that sounds pretty much like mkinitrd on openSUSE. A directory structure <br>
in /lib/mkinitrd/ containing startup scripts that may be put there by installed packages <br>
(e.g. /lib/mkinitrd/scripts/boot-lvm2.sh is owned by the lvm2 package). Adding busybox <br>
is just adding "busybox" to the feature list parameter of the mkinitrd call. The scripts <br>
(including mkinitrd) are commented (which already saved me once) and the mkinitrd <br>
manpage even contains instructions how to mount the root partition from a rescue <br>
system with necessary bind mounts to be able to execute mkinitrd.<br>
<p>
Seems like such a structure is the result of natural evolution :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332478/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor332257"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 9:53 UTC (Thu)
                               by <b>vrfy</b> (guest, #13362)
                              [<a href="/Articles/332257/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's not quite right, distros don't do (needless) crack here. Some use braindead tools, which should not even exist in the first place, but that's a totally different story, which is not touched at all by devtmpfs.<br>
<p>
Having static device nodes would be a very dangerous hack for a general purpose distro in the light of dynamic device numbers. You access a /dev name but you can't be sure, you talk to the right device. That's a problem you need to avoid for correctness, not for speed reasons. And we have many subsystems which have dynamic minors only. Even sd* disk nodes can be already, and likely will be dynamic for some systems pretty soon.<br>
<p>
/dev needs to be on tmpfs these days for security reasons, because tools mess around here, and adding user access control lists to device nodes, and create tons of symlinks, which are only meaningful during the lifetime of a specific device.<br>
<p>
Besides simplicity and reliability devtmpfs covers the transition time from the empty mounted tmpfs to the populated /dev. During this time, you can't do much else, but devtpmfs does not have that requirement at all, because /dev always reflects all currently known devices.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332257/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor332275"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 10:39 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/332275/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
mkinitrd seems to be a rather nasty, complex thing though (even if Debian have apparently got it right).  Perhaps 600 lines of kernel code is a price worth paying for simplifying things a bit.  After all, the idea of an initramfs was (IIRC) to move things out of the kernel that could be done better in userspace.  If this can be done more easily in the kernel, why not do it there?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332275/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor332234"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 8:00 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/332234/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I must admit that I wondered at the time that devfs was deprecated what was so important about device node naming policy that it had to be in the hands of the sysadmin.  (Yes, I am not an "old *nix hand" as you will have realised).  I would have thought that device-related policy is more useful at a higher level.  And while I've always admired microkernels, Linux is not one, and devices are handled in the kernel, so it would make sense to have 600 lines of kernel code for handling the device nodes, rather than all the complex user land stuff there is now.  (udev basically duplicates information in sysfs anyway - perhaps this code could be made even smaller by just having a /sys/nodes and linking /dev to that...?)  I'm not saying that udev wasn't the right answer at the time, but it might be time to re-examine it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332234/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 8:59 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/332242/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Device node naming policy is a curious beast.<br>
<p>
In some respects it must be invariant because it is hardwired into <br>
binaries: some names are even in POSIX (/dev/null, /dev/full). <br>
Without /dev/zero nothing will work, because the dynamic linker uses it. <br>
This may as well go into the kernel, because nobody can ever change the <br>
name without breaking things. Changing this sort of name is why devfs's <br>
new /dev layout was so hard to adapt to.<br>
<p>
In some respects it must be tunable by the local admin: only the admin <br>
knows what groups and permissions she wants on any device, and only the <br>
admin knows what she wants to name the USB flash disks that people plug <br>
in. (These names are generally provided to automounters, or mounted by <br>
hand, so it doesn't matter that their names are unpredictably set by <br>
humans.)<br>
<p>
In some respects, all that matters is that the name is *consistent*: e.g. <br>
local fixed disks, which are often referenced in files such as /etc/fstab. <br>
Much of the policy for that may as well go into the kernel, because nobody <br>
really cares *what* the name is as long as it doesn't change.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332246"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 9:13 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/332246/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I see the bit about the permissions.  But what difference does it make what the device node for a flash drive is called, as long as the name fulfils certain criteria (i.e. well known, reasonably unique to the drive, etc).  Policy can be applied to the mount point name :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332246/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 9:29 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/332254/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes indeed: that was covered by my second case. But *not all devices are <br>
like that*.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 9:35 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/332255/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But my point is that these days the user of the system will normally not be interacting with the device nodes and their names unless they are doing something relatively close to the hardware, in which case control over name policy may be nice cosmetics but probably not more.  In other cases, something will be layered between the device node and the user, and while that something needs to know the name, it doesn't care more than that what it actually is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332276"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 10:43 UTC (Thu)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/332276/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <em><blockquote>But my point is that these days the user of the system will normally not be interacting with the device nodes and their names unless they are doing something relatively close to the hardware</blockquote></em>
<p>
If it's just your own system, then indeed, nobody cares. But think of managing hundreds or thousands of systems and you may see the value of being able to standardize device naming. The precise naming policy is not so interesting, but the fact that there is one that is consistent is really rather important.
      
          <div class="CommentReplyButton">
            <form action="/Articles/332276/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332289"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 12:21 UTC (Thu)
                               by <b>mjthayer</b> (guest, #39183)
                              [<a href="/Articles/332289/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Quite agree, which more or less falls under my second point.  Again, that doesn't mean that you have to be able to choose the names yourself, only that you have to be sure they have been well and predictably chosen.  Which is a problem that doesn't necessarily have to be solved over again by every administrator.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332289/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor332261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 9:53 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/332261/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>In some respects, all that matters is that the name is *consistent*: e.g.
local fixed disks, which are often referenced in files such as /etc/fstab.</blockquote>Often nowadays fstab refers to devices by their disk label, because the device names (sda1, sdb1, etc) might jump around depending on what's plugged in where.  Which makes you wonder why the disk label names have to be checked in some magic way, rather than just being exported by the kernel under /dev/disklabel/xxx.
      
          <div class="CommentReplyButton">
            <form action="/Articles/332261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332429"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 22:38 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/332429/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Having the kernel check disk labels at the time they probe for the devices <br>
might work, but wouldn't work if the filesystem on the device was modular <br>
and the module wasn't yet loaded.<br>
<p>
(Also it's yet *more* nonswappable kernel code for a job very easily done <br>
by userspace.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332429/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor355430"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 5, 2009 7:47 UTC (Mon)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/355430/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Which makes you wonder why the disk label names have to be checked in some </font><br>
<font class="QuotedText">&gt; magic way, rather than just being exported by the kernel under </font><br>
<font class="QuotedText">&gt; /dev/disklabel/xxx.</font><br>
<p>
If you're running a non-ancient system with udev, you can find all the disks by label under:<br>
<p>
/dev/disk/by-label/<br>
<p>
Actually, come to think of it, I'm not sure why the LABEL=foo hack was ever implemented. There must be a reason but I don't know it.<br>
<p>
Colin<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/355430/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor355558"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 6, 2009 0:07 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/355558/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Firstly, LABEL= predates udev. Secondly, LABEL= works even before udev has <br>
initialized. Thirdly, it works on systems without udev. (udev and mount <br>
don't yet use the same probing library, but this is changing, I <br>
understand.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/355558/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor357459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 18, 2009 22:43 UTC (Sun)
                               by <b>cmccabe</b> (guest, #60281)
                              [<a href="/Articles/357459/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, that makes sense. Thanks.<br>
<p>
C.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/357459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381622"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2010 11:15 UTC (Fri)
                               by <b>skitching</b> (guest, #36856)
                              [<a href="/Articles/381622/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi nix,<br>
<p>
You mention in your comment that "root=LABEL=" work even when there is no udev. <br>
<p>
Does this also apply to "root=UUID="?<br>
<p>
And would you be able to give me a hint about where to find that code? All the relevant rootfs mounting bits appear to be in init/do_mounts.c, but I can't find anything related to handling LABEL or UUID. Function name_to_dev_t maps things like "root=08:05", "root=0x0805", "root=/dev/sda5" to a (major,minor) but I can't see UUID/LABEL handling anywhere.<br>
<p>
Thanks, Simon<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381622/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor381624"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 2, 2010 12:09 UTC (Fri)
                               by <b>hppnq</b> (guest, #14462)
                              [<a href="/Articles/381624/">Link</a>] 
      </p>
      
      </div>
      </summary>
      I'm sure nix will have more useful information, but you could take a look at <a href="http://www.kernel.org/pub/linux/utils/util-linux-ng/libblkid-docs/libblkid-evaluate.html">libblkid</a> in the meantime. This is used by mount to find devices identified by label or uuid (check the util-linux source).
      
          <div class="CommentReplyButton">
            <form action="/Articles/381624/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor381757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 3, 2010 0:50 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/381757/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I never mentioned root=. For everything *other* than root filesystem <br>
mounting, the code to look at is libblkid, which supports both LABEL= and <br>
UUID=. That's what mount(8) uses.<br>
<p>
Raw non-initramfs/initrd kernel root= parameterwise, all that is supported <br>
in /dev/{fake device name}, root={major:minor}, and <br>
root={major*256+minor}. This is of course yet another reason to use an <br>
initramfs, which can easily use normal mount and/or blkid directly to <br>
support whatever permutations of LABEL=, UUID= or whatever you prefer.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/381757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor332260"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 9:50 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/332260/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Me too.  Why is it considered 'policy' (bad! bad!) for the kernel to specify the name of the device file, but perfectly okay (in classical UNIX terms) to have fixed major and minor device numbers?  Surely the major and minor numbers are just as much policy as the name.  If users really want their own names they can easily say 'ln -s /dev/kernel_name /dev/my_weird_name', just as easily as 'mknod /dev/my_weird_name b major minor'.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332260/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332541"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 16:14 UTC (Fri)
                               by <b>rmini</b> (subscriber, #4991)
                              [<a href="/Articles/332541/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can't set ownership or permissions with symlinks, where you can with device nodes.  That's probably the more important part of policy than symlinks.  Additionally, some devices are difficult to name persistently.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332541/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor332286"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 11:36 UTC (Thu)
                               by <b>Quazatron</b> (guest, #4368)
                              [<a href="/Articles/332286/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Looks like a classic case of a nice piece of software with a badly chosen name.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332286/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332343"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2009 16:20 UTC (Thu)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/332343/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In particular, it seems odd to me to call something "*fs" when it is not, in fact, a filesystem. This seems to be the kernel mounting a filesystem and creating some device nodes on it. Surely this is better than the hack currently used to parse the "root=/dev/sda1" option, which takes something that looks like a path and comes up with a dev_t without anything resembling a filesystem lookup, and therefore has nothing to do with anything that could be seen by userspace.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332343/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor332505"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 11:21 UTC (Fri)
                               by <b>meyert</b> (subscriber, #32097)
                              [<a href="/Articles/332505/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Boot speed, boot speed, boot speed.<br>
<p>
Oh, and reduction in complexity in init scripts, and saving embedded systems a lot of effort to implement a dynamic /dev properly (have you _seen_ what Android does to keep from having to ship udev? It's horrible...)"<br>
<p>
I don't understand this. Can embedded system not jut use a static /dev tree? Isn't this true for android platfrom, that is intended for embedded use?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332505/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor332502"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 11:24 UTC (Fri)
                               by <b>pli</b> (guest, #45060)
                              [<a href="/Articles/332502/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The day devfs was removed from mainline was a sad day. Yes, the devfs implementation had its problems, some major ones, but those could have been fixed (and were fixed by e.g. mini-devfs but was never merged). The whole thing about letting the kernel dynamically manage /dev is a sound, elegant and proven strategy. The udev debacle has been a mess from day one and now they want to save their crappy idea by re-introducing a semi-half-devfs that is in fact a udev-helper-devfs, with some terribly odd and confusing device node life-cycle handling. Part of me is happy though, because the udev people realize that this should be done in the kernel, but I'm worried that this is just a continuation of the udev madness.<br>
<p>
I hope the submission of devtmpfs can restart the general devfs-discussion and lead to the implementation of a real and proper devfs (e.g. let's start from mini-devfs) so that we once and for all can leave udev behind us.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332502/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor332517"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 13:35 UTC (Fri)
                               by <b>incase</b> (guest, #37115)
                              [<a href="/Articles/332517/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh well, sure udev has quite a few problems, but in my experience, it provides a much cleaner interface to device node (or symlink to device node) creation then hotplug ever did.<br>
And I have quite a number of places where I need it:<br>
Give serial USB devices consistent names, even when plugged in later, in another order or whatever.<br>
Give different usb thumb drives consistent device names (as they mount at different places and are access restricted to specific users) etc...<br>
<p>
I never managed to achieve this consistently with the old devfs/hotplug combo. Especially since it made a difference with that combo when a device was connected (before or after hotplug was first run)..<br>
<p>
However, this concerns basically only the hotplug functions of udev, not the coldplug functions in their current full extend. This basically means I'm all for devtmpfs as a helper to make the device nodes that udev coldplug would create available before it finished running, so that other userspace processes could already start before udev coldplug finished.<br>
<p>
regards,<br>
Sven<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332517/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor332527"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2009 14:21 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/332527/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Please no. devfs was an abomination.<br>
<p>
The lifetime rules of objects in devtmpfs are simple: the nodes are <br>
created by the kernel, and that's all. It's just a bunch of automatic <br>
mknod()s. Everything else is handled by udev, as now.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332527/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor332725"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of devfs</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 11, 2009 4:01 UTC (Mon)
                               by <b>Kamilion</b> (subscriber, #42576)
                              [<a href="/Articles/332725/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds like a reasonable idea to me.<br>
Mount a tmpfs on /dev, populate it with a few of the most meaningful device <br>
nodes to get up and running enough to be able to load udev from somewhere or <br>
just fall into a basic busybox shell.<br>
<p>
I'm familiar with this fallback behavior in ubuntu, when their initramfs has <br>
a heart attack on some esoteric hardware I have.<br>
<p>
Most of the other major unixes that are still left have a kernel managed <br>
dynamic device filesystem.<br>
<p>
It seems like a good enough idea to me to have everything necessary to <br>
bootstrap the most basic twenty or so system device nodes that nobody ever <br>
renames strictly from 600 lines of code added to a kernel image.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/332725/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
