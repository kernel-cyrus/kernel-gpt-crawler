        <!DOCTYPE html>
        <html lang="en">
        <head><title>Sticky groups in the shadows [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/855943/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/856149/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/855943/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Sticky groups in the shadows</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 14, 2021</br>
           </div>
Group membership is normally used to grant access to some resource;
examples might include using groups to control access to a shared
directory, a printer, or the ability to use tools like <tt>sudo</tt>.  It
is possible, though, to use group membership to <i>deny</i> access to a
resource instead, and some administrators make use of that feature.  But
groups only work as a negative credential if the user cannot shed them at
will.  Occasionally, some way to escape a group has turned up, resulting in
vulnerabilities on systems where they are used to block access; despite
fixes in the past, it turns out that there is still a potential problem
with groups and user namespaces; <a
href="/ml/linux-kernel/20210510130011.1441834-1-gscrivan@redhat.com/">this
patch set</a> from Giuseppe Scrivano seeks to mitigate it through the
creation of "shadow" groups.
<p>
There are two ways to prevent access to a file based on group membership.
One of those is to simply set the group owner of the file to the group that
is to be denied, then set the permissions to disallow group access.
Members of the chosen group will be denied access to the file, even if the
world permissions would otherwise allow that access.  The alternative is to
use <a href="https://man7.org/linux/man-pages/man5/acl.5.html">access
control lists</a> to explicitly deny access to the intended group or
groups.  Once again, any process in any of the designated groups will not
be allowed access.
<p>
By way of a refresher, it's worth remembering that Linux has two separate
concepts of group membership.  The "primary group" or "effective group ID"
is the group that will be attached to new files in the absence of other
constraints.  This was once the only group associated with a process in
Unix systems, and is set with <a
href="https://man7.org/linux/man-pages/man2/setgid.2.html"><tt>setgid()</tt></a>.
The "supplementary" groups are a newer addition that allow a process to
belong to multiple groups simultaneously; the list of supplementary groups
can be changed with <a
href="https://man7.org/linux/man-pages/man2/getgroups.2.html"><tt>setgroups()</tt></a>.
Negative access-control decisions are usually (but not necessarily) based
on supplementary group membership.
<p>

The "negative groups" access-control technique will prove porous, though,
if processes are allowed to shed group membership at will.  Both
<tt>setgid()</tt> and <tt>setgroups()</tt> are privileged operations so, in
normal circumstances, group membership is not under the control of the
process involved.   At
least, that is true until user namespaces enter the picture.
<p>
Back in 2014, <a href="/Articles/626665/">a problem with user namespaces
and groups</a> came to light.  Any user can create a user namespace and run
as root within that namespace; as a result, actions that are blocked
outside of the namespace (<tt>setgroups()</tt>, for example) become
possible inside.  User namespaces thus made it easy for a user to evade
being hampered by membership in the wrong group; all that was needed was to
create a namespace, then call <tt>setgroups()</tt> to drop membership of
that group inside the namespace.  User namespaces were designed to not
confer any extra privilege outside of the namespace, but the <i>removal</i>
of a credential was not originally seen as raising privilege.
<p>
The solution adopted at the time was to add a control file (called
<tt>setgroups</tt>) to each process's <tt>/proc</tt> directory.  Writing
"<tt>deny</tt>" to that file will disable <tt>setgroups()</tt> to all
processes within the user namespace containing the target process — and to
all descendant user namespaces as well — while writing <tt>allow</tt> will
enable <tt>setgroups()</tt>.  This action must be performed
before setting the group-ID map for the namespace, otherwise writing the
group-ID map will enable <tt>setgroups()</tt>.  This policy was chosen for
ease of verification; there is exactly one place where <tt>setgroups()</tt>
can be enabled for a namespace.  If <tt>setgroups()</tt> is explicitly
disabled, it will remain that way for the life of the namespace; there is
no way to enable it again.
<p>
This fix solved the problem, but at a cost: <tt>setgroups()</tt> exists for
a reason, and there are legitimate workloads that would like to make use of
it.  Denying <tt>setgroups()</tt> will keep processes from escaping
unwanted groups within a namespace, but it also prevents any other change
of supplementary groups.
<p>
To remedy this issue, Scrivano's patch set adds another possible value,
"<tt>shadow</tt>", for the <tt>setgroups</tt> file.  Writing
<tt>shadow</tt> has the same effect as writing <tt>allowed</tt>, in that
the <tt>setgroups()</tt> system call will be allowed inside the namespace,
but there is a difference.  When the <tt>setgroups</tt> file is written,
the kernel will make a copy of the target process's supplementary groups at
that time
and store it with the namespace.  Whenever <tt>setgroups()</tt> is called,
this list of "shadow" groups will be appended to the groups provided by the
caller, essentially requesting continued membership in all of those groups.
<p>
In other words, the "shadow" mode makes the initial set of supplementary
groups sticky.  Suitably privileged processes within the namespace can use
<tt>setgroups()</tt> to add new groups; they can also remove groups that
were not part of the initial set.  But the supplementary groups that the
namespace was created with will always be there, even though the process
can no longer see them — <tt>getgroups()</tt> will not list the groups that
have not been explicitly requested with a <tt>setgroups()</tt> call.
<p>
This particular patch has been around for a while; in the past, its
complexity has not seemed to be justified by the benefits it brings.  A
recent <a
href="/ml/linux-kernel/20210421172714.912119-1-snaipe@arista.com/">user
request</a> for this feature has brought this work back to light, though.
Whether it will clear the bar this time remains to be seen, but it seems
likely that there will always be users who want to have both the ability to
use negative group protections and to change group memberships within user
namespaces.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Namespaces-User_namespaces">Namespaces/User namespaces</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Negative_groups">Negative groups</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/855943/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor856290"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Split group membership into two bits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 16:45 UTC (Fri)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/856290/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Since group membership can be a negative credential, instead of storing a single bit of information &quot;is the user a member of this group?&quot; there should be two separate bits stored:<br>
<p>
A.  Does the user have the privileges associated with being a member of this group?<br>
B.  Does the user have the privileges associated with *not* being a member of this group?<br>
<p>
Removing yourself entirely from a group, as at present, means setting bit A to zero but setting bit B to 1, possibly giving yourself more privileges.  So it has to be restricted.  But if you had a system call that just unset one or both of the bits, it could be a pure dropping of privilege and available in any context.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856290/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor856295"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 18:12 UTC (Fri)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/856295/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;d be nice if the &quot;shadow&quot; groups *only* participated in permission denial, not permission granting. In particular, that way processes inside a namespace that drop permissions do indeed lose those permissions, they just still have the shadow groups around for the purposes of processing negative permissions for that group.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856295/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856991"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2021 19:21 UTC (Sat)
                               by <b>riking</b> (subscriber, #95706)
                              [<a href="/Articles/856991/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, this is what I imagined was going on. If one does not take care to only perform this operation on colluding processes (set to only negative groups, write &quot;shadow&quot;, restore normal/positive groups), odd behavior will certainly result.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856991/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor856296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 18:45 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/856296/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can anyone provide an example where using a group to deny access is simpler to maintain than doing it the normal way (using a group to grant access)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856299"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 19:12 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/856299/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Simple. John is in a project that needs access to shared resources.<br>
<p>
Jane doesn&#x27;t want John to have access to her resources within that shared group.<br>
<p>
As I understand the linux (and windows) access system, trying to lock John out of Jane&#x27;s files is a nightmare.<br>
<p>
(Which is why Pr1mos - &quot;if the user is named the groups are ignored&quot; - makes that so simple ...)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856299/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856301"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 19:30 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/856301/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If Jane wants to limit access to her files, she needs to be in her own group and give access to only those that she want to have access.  Using group membership to deny access at the same time as others are using group membership to grant access is a recipe for confusion.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856301/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856304"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 19:53 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/856304/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thing is, does Jane have the ability to grant and deny access to her files ...<br>
<p>
Especially if they&#x27;re in a project folder and not her private home area.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856304/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor856307"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 20:25 UTC (Fri)
                               by <b>pwfxq</b> (subscriber, #84695)
                              [<a href="/Articles/856307/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Which is why Pr1mos - &quot;if the user is named the groups are ignored&quot; - makes that so simple</font><br>
<p>
It took me a moment to work out what you were saying: The more explicit the setting, the higher its precedence. This is method is used in all sorts of places.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856307/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856309"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 20:36 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/856309/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The &quot;problem&quot; with linux and windows is that, as far as I can make out, user and group permissions add up. So if you give explicit permissions to someone and you don&#x27;t know what groups they are in, what they&#x27;ve actually got may bear no resemblance to what you&#x27;ve given them.<br>
<p>
Whereas if the name trumps the groups, then group permissions become irrelevant.<br>
<p>
And what if the administrator uses group permissions to lock them out of your files, but you want them to have access? It&#x27;s a problem all round ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856309/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 21:03 UTC (Fri)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/856310/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m not sure what you&#x27;re saying, but it sounds incorrect.<br>
<p>
If you&#x27;re the owner of the file (or, in the case of posix ACLs, if you&#x27;re explicitly named in the user list), then those permissions do determine your access.<br>
<p>
But, I may misunderstand what you&#x27;re saying.  Have you tested the actual linux behavior?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856353"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2021 9:58 UTC (Sun)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/856353/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I haven&#x27;t used acls on windows or linux. But reading up on them, as far as I can tell, user and group acls are added together. Otherwise deny acls wouldn&#x27;t make sense ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856353/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856377"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2021 6:39 UTC (Mon)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/856377/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
File permissions in Unix work like this: If you are the owner of the file, the &quot;user&quot; permissions are checked, and nothing else. If you are not the file owner, but one of the group IDs of the process matches the owning group of the file, the group permissions determine access, and nothing else. Only if the above user ID and group ID checks fall through, the &quot;other&quot; permissions are checked. Traditional Unix file permissions are not added together.<br>
<p>
POSIX ACLs work in the same way, except now, for the sake of checking access, a file can have more than one owner, each with potentially different combinations of &quot;rwx&quot;. In the same way, a file can have more than one group owner, each with different permissions.<br>
<p>
With POSIX ACLs, if the user ID of the process matches any of the file owners, then the user permissions determine the access, and nothing else. If there is no user ID match, then the process group IDs are checked: if any of the group IDs of the process matches any of the ACL group owners, then the group permissions determine the access. If a positive match is found, access is granted, else it is denied. As with non-ACL permissions, if there is no owner or group owner match, the &quot;other&quot; permissions are checked.<br>
<p>
POSIX ACLs are further complicated by a &quot;mask&quot; entry, which was added for backwards compatibility; I won&#x27;t go into that here. POSIX ACLs do not have &quot;deny&quot; entries.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856377/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2021 19:41 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/856820/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you have a file with permissions:<br>
Owner someuser: rwx<br>
Group somegroup: ---<br>
Others: r--<br>
<p>
If you&#x27;re &#x27;someuser&#x27;, you have read/write/execute access. If you&#x27;re in somegroup, you have no access. If you&#x27;re not either, you have read access.<br>
<p>
So, if user2 is normally a member of &#x27;somegroup&#x27;, but can somehow drop that group membership, they&#x27;ll gain access to this file, which they shouldn&#x27;t be able to read.<br>
<p>
In practice, this isn&#x27;t usually a problem, because almost nobody ever intentionally sets up permissions like this. But it&#x27;s possible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor856992"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2021 19:29 UTC (Sat)
                               by <b>riking</b> (subscriber, #95706)
                              [<a href="/Articles/856992/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Discord&#x27;s ACLs are the model everyone should be striving for. <a href="https://discord.com/developers/docs/topics/permissions#permission-overwrites">https://discord.com/developers/docs/topics/permissions#pe...</a><br>
<p>
1. Ambient positive access for @everyone is applied<br>
2. Ambient positive access for your groups is applied<br>
3. Resource deny rules for @everyone are applied<br>
4. Resource allow rules for @everyone are applied<br>
5. Resource deny rules for your groups are applied<br>
6. Resource allow rules for your groups are applied<br>
7. Resource deny rules for your user are applied<br>
8. Resource allow rules for your user are applied<br>
<p>
Steps 3+4, 5+6, and 7+8 are represented as bitmask pairs. `permissions = (permissions &amp;~ rule.deny) | rule.allow;`<br>
(Steps 1 and 2 don&#x27;t need a deny value, because they&#x27;re applying onto a blank slate.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856992/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor856318"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2021 0:42 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/856318/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The &quot;problem&quot; with linux and windows is that, as far as I can make out, user and group permissions add up. So if you give explicit permissions to someone and you don&#x27;t know what groups they are in, what they&#x27;ve actually got may bear no resemblance to what you&#x27;ve given them.</font><br>
<p>
I&#x27;m fairly certain Linux doesn&#x27;t work that way, as others have said.<br>
<p>
<font class="QuotedText">&gt; Whereas if the name trumps the groups, then group permissions become irrelevant.</font><br>
<p>
No, because with traditional Unix owner/group/world permissions bits, you can only name one person, and that person has to be the owner (i.e. they have the right to edit the permissions), which effectively means that the owner&#x27;s permissions are &quot;just to prevent mistakes&quot; rather than a meaningful security barrier. So for actual security, you just have the group permissions and the &quot;world&quot; (everybody else) permissions. While it might be uncommon for the world permissions to be more permissive than the group permissions, it&#x27;s not *that* weird or complicated to reason about.<br>
<p>
You can do more elaborate stuff with POSIX ACLs, natch, but not everybody wants to dig out the man page on how those actually work. Sometimes, a negative group file mode is easier to understand and reason about.<br>
<p>
<font class="QuotedText">&gt; And what if the administrator uses group permissions to lock them out of your files, but you want them to have access?</font><br>
<p>
Then the two of you can shout at each other in meatspace until one of you gets hoarse. Ultimately, the kernel provides the primitives which it provides, and it&#x27;s the administrator&#x27;s responsibility to use those primitives wisely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856318/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856379"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2021 8:22 UTC (Mon)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/856379/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One can be the owner of a file on Linux and still has no ability to access it or change it in any way if one does not have the executable permission for the parent folder.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856379/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2021 8:54 UTC (Mon)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/856380/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>
Which is why as an unprivileged user you can't use <tt>chown</tt> to donate files to other users. (Otherwise, Alice could annoy Bob if Bob has a 10-gig quota for files, by creating a 10-gig file in her own – protected – home directory and then making it over to Bob. It counts towards Bob's quota but Bob has no way to get at or remove the file.)
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/856380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856383"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2021 10:05 UTC (Mon)
                               by <b>jem</b> (subscriber, #24231)
                              [<a href="/Articles/856383/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Alice could also annoy Bob by finding a large file in Bob&#x27;s unprotected home directory and making a link to it in her own directory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856383/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856509"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2021 17:57 UTC (Tue)
                               by <b>BenHutchings</b> (subscriber, #37955)
                              [<a href="/Articles/856509/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which is one reason to enable the fs.protected_hardlinks sysctl.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856509/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor856451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2021 21:20 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/856451/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you lack execute permissions to any component of the path, then the permissions on the file are not a security boundary (because you can&#x27;t even get that far to begin with, or if you can, then you must already be the superuser anyway). Therefore, the owner permissions are never a security boundary, just as I said.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor856317"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2021 0:25 UTC (Sat)
                               by <b>rgmoore</b> (<b>&#x272D; supporter &#x272D;</b>, #75)
                              [<a href="/Articles/856317/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>As I understand the linux (and windows) access system, trying to lock John out of Jane's files is a nightmare.</blockquote>

<p>It's actually not that hard under Windows.  It has "deny" permissions, and they take precedence over "allow" permissions.  So Jane just has to tell Windows to deny John access, and he's locked out unless he's an administrator and can ignore everything.
      
          <div class="CommentReplyButton">
            <form action="/Articles/856317/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor856336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2021 14:54 UTC (Sat)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/856336/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is possible to solve Jane’s problem in a rather straightforward way. Crate a group that can can access the shared resources, then grant read and execute privilege to a folder to that group with no access to others then give read/write access to everybody to a sub folder there. That will be the shared area. Then Jane can restrict the access as usual.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor856308"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Denying access w/ groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 20:27 UTC (Fri)
                               by <b>rav</b> (subscriber, #89256)
                              [<a href="/Articles/856308/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On a shared-user system at my university, all users are in a &#x27;users&#x27; group, and the webserver is not in the &#x27;users&#x27; group. Since you&#x27;re not privileged, you can&#x27;t assign your public_html directory to the webserver&#x27;s uid/gid, but you *can* set it to be not group-readable for the &#x27;users&#x27; group, thus in effect allowing the webserver to serve the files but disallowing your colleagues from snooping around.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856308/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor856298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Just make named permission TRUMP everything else</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2021 19:05 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/856298/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Negative permissions are just are nightmare all round.<br>
<p>
Pr1mos was <br>
<p>
If the user is named, THAT&#x27;S WHAT THEY GET<br>
If they&#x27;re not named, but in named groups, permissions are added.<br>
If neither they or their groups are named, they get the default (which defaults to deny)<br>
<p>
Nice and simple, easy to understand, and no worries about the administrator changing group permissions and accidentally granting permissions the file owner didn&#x27;t want.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor856341"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2021 18:05 UTC (Sat)
                               by <b>maximoburrito</b> (guest, #144651)
                              [<a href="/Articles/856341/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is there a reason we don&#x27;t just have negative groups, groups that are defined by the users NOT in them?<br>
<p>
thegroup; -fred, -george<br>
<p>
Everyone but frec and george are in the group. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856341/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856342"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2021 19:41 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/856342/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So, firstly, we need to clarify what we mean by &quot;[supplementary] group.&quot; A (supplementary) group is:<br>
<p>
1. One element of a per-process (or per-thread) attribute, manipulated by getgroups(2) and setgroups(2), and inherited across fork and exec.<br>
2. A set of users who have a group in sense (1) automatically attached to their login shell at startup, along with some extra metadata such as a name.<br>
<p>
You are (I think) proposing a modification to groups in sense (2), such that a group can be made to attach to every user except for (e.g.) &quot;fred and george.&quot; But the process of attaching supplementary groups to users is (I *think*) entirely done in userspace by either login(1) or one of its friends. So from the kernel&#x27;s perspective, groups in sense (2) are Somebody Else&#x27;s Problem, and there is no reasonable way for the kernel to translate a use of subtractive group permissions into an inverted group membership. Instead, they would have to remove subtractive group permissions and tell everyone &quot;go develop a new feature in userspace to replace the kernelspace feature we just killed&quot;; that would be quite obnoxious and obviously contrary to the kernel&#x27;s normal backwards compatibility promises.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856342/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor856357"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2021 23:35 UTC (Sun)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/856357/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When I worked as a windows sysadmin, we had a rule on deny permissions:<br>
Don’t.  They are a road to massive confusion and misunderstanding.<br>
<p>
In our experience in corporate environments, requests for them were almost always the result of bad planning or confused organizational structures.<br>
<p>
I understand they can be useful technically, but gosh they are terrible organizationally.  Weird, magic exceptions, and an overlay atop normal permissions to boot.  “Everyone except Steve” or “everyone except Accounting”, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856357/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856449"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2021 20:26 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/856449/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In my experience, deny is most commonly used for Compliance Reasons™ - i.e. &quot;Our lawyers told us we have to be absolutely certain that group X cannot access thing Y, no matter what.&quot; While it may be annoying, it does mean that the pointy-haired boss can&#x27;t accidentally violate a legal requirement just by telling IT &quot;We need access to thing Y because I said so.&quot; In this respect, it functions like a rudimentary form of mandatory access control.<br>
<p>
In practice, thing Y is often some form of PII, particularly medical or payments information, but occasionally it will be a trade secret, privileged legal document, or other such materials. As a side note, getting these deny ACLs removed or narrowed is often a rather involved bureaucratic process, but that&#x27;s a business requirement, not a technical limitation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856449/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor856526"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Sticky groups in the shadows</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2021 2:12 UTC (Wed)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/856526/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, that makes sense - I had not run across that specific use case.<br>
<p>
My experience of them was people driving themselves to madness rather than being willing to think through their organizational and permission structures.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/856526/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
