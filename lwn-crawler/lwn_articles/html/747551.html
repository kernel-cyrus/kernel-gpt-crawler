        <!DOCTYPE html>
        <html lang="en">
        <head><title>BPF comes to firewalls [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/747551/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/747355/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/747551/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>BPF comes to firewalls</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 19, 2018</br>
           </div>
The Linux kernel currently supports two separate network packet-filtering
mechanisms: iptables and nftables.  For the last few years, it has been
generally assumed that nftables would eventually replace the older iptables
implementation; few people expected that the kernel developers would,
instead, add a third packet filter.  But that would appear to be what is
happening with the newly announced <a href="/Articles/747504/">bpfilter</a>
mechanism.  Bpfilter may eventually replace both iptables and nftables, but
there are a lot of questions that will need to be answered first.
<p>

It may be tempting to think that iptables has been the kernel's
packet-filtering implementation forever, but it is a relative newcomer,
having been introduced in the 2.4.0 kernel in 2001.  Its predecessors
(ipchains, introduced in 2.2.10, and ipfwadm, which dates back to 1.2.1 in
1995) are mostly forgotten at this point.  Iptables has served the Linux
community well and remains the firewalling mechanism that is most widely
used, but it does have some shortcomings; it has lasted longer than the
implementations that came before, but it is clearly not the best possible
solution to the problem.
<p>
The newer <a href="/Articles/564095/">nftables</a> subsystem, merged for
the 3.13 kernel release in early 2014,
introduced an in-kernel virtual machine to implement firewall rules;
users have been slowly migrating over, but the process has been slow.  For
some strange reason, system administrators have proved reluctant to throw
away their existing firewall configurations, which were painful to develop
and which still function as well as they ever did, and start over with a
new and different system.
<p>
Still, it was logical to assume that nftables would eventually take over,
especially as the iptables compatibility layers improved.  Some people
started to doubt this story, though, when serious development started on
the BPF virtual machine.  There seemed to be a lot of overlap between the
two virtual machines, and BPF was being quickly extended in ways that
improved its performance, functionality, and security.  Even so, nftables
development has continued, and there has been little talk — until now — of
pushing BPF into the core of the firewalling code.
<p>
<h4>Bringing in BPF</h4>
<p>
The announcement of bpfilter changes that situation, though.  In short,
bpfilter enables the creation of BPF programs that can be attached to
points in the network packet path and make filtering decisions.  In the
proof-of-concept patches, those programs are attached at the <a
href="/Articles/682538/">express data path</a> (XDP) layer, where they are
run from the network-interface drivers.  But, as Daniel Borkmann noted in
the introduction to the patches, BPF programs could be just as easily
attached at any other point in the path, allowing them to make decisions at
the same points that iptables rules do.
<p>
There are a number of advantages claimed for the bpfilter approach.  BPF
programs can be just-in-time compiled on most popular architectures, so
they should be quite fast.  The work that has been done to enable the
offloading of XDP-level programs to the network interface itself can 
come into play here, moving firewall processing off the host CPU entirely.
The use of BPF enables the writing of firewall rules in&nbsp;C, which
may appeal to some developers who are starting from the beginning.
And firewall code would be subject to the BPF verifier, adding a layer of
security to the whole system.

<p>
One of the core design features for bpfilter is the
ability to translate existing iptables rules into BPF programs.  This
feature is intended to make it easy for existing firewall configurations to
be moved over to the new scheme, perhaps without system administrators even
knowing that it is happening.
This translation is done in an interesting manner.  Iptables
rules are passed to the kernel, so the kernel must take responsibility for
doing that work, but the task can be a complex one that would benefit from
a user-space implementation.
<p>

To enable such an implementation, the bpfilter developers have created a new
mechanism that supports the creation of a special type of kernel module to
handle this kind of task.
These modules would be part of the kernel and would be shipped by
distributors as just another <tt>.ko</tt> file, but they would contain an
ordinary ELF executable.  After the module has
been loaded, its code can be run in a separate user-space process; all
that is required is a call to a special version of
<a
href="https://elixir.bootlin.com/linux/v4.15.4/source/kernel/umh.c#L465"><tt>call_usermodehelper()</tt></a>. 

<p>
This mechanism allows the translation code to be managed as if it were just
another part of the kernel.  That code can be developed in user space,
though.  When it runs, the translation code will be separated from the
kernel, making it harder to attack the kernel via that path.  If this
mechanism catches on, one can imagine that a number of other tasks could
eventually be pushed out of the kernel proper into one of these special
user-space modules.  Developers should be careful, though; this could prove
to be a slippery slope leading toward something that starts to look like a
microkernel architecture.
<p>
<h4>Early responses</h4>
<p>
There have not been a whole lot of comments thus far on the code itself.
That may be partly because, in their haste to get a proof of concept out to
illustrate the idea, the developers never quite got around to writing
comments in the code — or even changelogs for the patches.  The idea
itself, though, has raised concerns for some developers.
<p>
Harald Welte, who is not often seen in this community these days, <a
href="/Articles/747557/">showed up</a> with a number of questions.  At the
top of his list was the decision to emulate iptables rules with the new BPF
mechanism.  If the new subsystem is to ever replace the iptables
implementation, it will need to implement <i>exactly</i> the same behavior;
small and subtle differences could introduce security problems into
deployed firewall configurations.  Given the complexity of iptables, the
chances of such differences happening are significant.
<p>
More fundamentally, the networking developers have wanted to phase out
iptables and its user-space interfaces for some time.  Iptables has not
aged entirely well.  For example, there is no way to add or replace a
single rule (or small set of rules); iptables can only wipe out the entire
configuration and start from scratch.  That makes firewall changes
expensive; it also gets difficult to coordinate changes when they are being
made by multiple actors at once.  The increasing use of containers has
created just this kind of situation; addressing this problem requires
moving away from the iptables API.  The fact that iptables requires
separate rule sets for IPv4 and IPv6 creates a pain point for
administrators as well.
<p>
Implementing the iptables API with bpfilter, Welte said, will "<q>risk
perpetuating the design mistakes we made in iptables some 18 years ago 
for another decade or more</q>".  It will push back the (already
distant) date when that API could be deprecated and removed.
Rather than focusing on iptables, Welte said, the developers should create
an emulation of the newer nftables API, which was designed with the lessons
from iptables in mind.  That would support sites that have
already migrated and encourage that migration to continue.
<P>
 Networking maintainer David
Miller (who authored some of the new code) <a
href="/Articles/747558/">replied</a> that iptables is still far more widely
used, so implementing that interface provides for better testing coverage in
the near 
term.  Welte <a href="/Articles/747559/">answered</a>, though, that most of
the biggest use cases (Docker and Kubernetes, for example) use the
command-line tools rather than the iptables API, so there is no need to
implement emulation of the API itself to test with those systems.  Miller,
however, <a
href="https://www.spinics.net/lists/netdev/msg484259.html">disagreed</a>
with the idea that the iptables binaries could be easily replaced on
deployed systems: "<q>Like it or not iptables ABI based filtering is going to be in the data
path for many years if not a decade or more to come</q>".

<P>
Interestingly, while there was talk of implementing the nftables API,
nobody has yet questioned the idea of applying the BPF virtual machine to
firewalls,
even though it would be likely to supplant nftables relatively quickly.
Instead, Miller <a
href="https://www.spinics.net/lists/netdev/msg484318.html">said</a> in the
discussion that nftables failed to address the performance problems in
Linux's packet-filtering implementation, driving users toward user-space
networking technologies instead.
There is a real possibility that nftables could end up being one of those
experiments that is able to shed some light on the problem space but never
takes over in the real world.
<p>

Overall, bpfilter is an extremely young project and there are a lot of
questions yet to be answered about it.  While much of the packet-filtering
logic can likely be expressed in BPF code, there are more advanced features
(like connection tracking, <a href="/Articles/747561/">pointed out</a> by
Florian Westphal) that are still likely to need a fair amount of kernel
support.  There are no performance numbers with the patch set, so any
performance gains are still theoretical at this point.  And the code itself
is quite young, lacking both features and documentation.
<p>
The end result is that we'll probably not see bpfilter in the mainline
kernel in the immediate future.  Given the developers who have worked on
it, though, bpfilter is clearly a serious initiative that is firmly aimed
at getting into the mainline eventually.  If it truly proves to be a better
solution to the network packet-filtering problem, those developers seem
likely to prevail eventually.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#BPF-Networking">BPF/Networking</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Modules-ELF_modules">Modules/ELF modules</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking-Packet_filtering">Networking/Packet filtering</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/747551/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor747583"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 4:35 UTC (Tue)
                               by <b>eahay</b> (guest, #110720)
                              [<a href="/Articles/747583/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Iptables can delete or insert a single rule at a time...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747583/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747589"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 6:46 UTC (Tue)
                               by <b>kay</b> (subscriber, #1362)
                              [<a href="/Articles/747589/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
iptables command can ... but not the API<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747589/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 12:19 UTC (Tue)
                               by <b>bernat</b> (subscriber, #51658)
                              [<a href="/Articles/747607/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It will download the whole ruleset from the kernel, modify it to add/remove the single rule and upload it again. When your ruleset becomes huge, adding/removing a single rule takes a significant time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747953"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2018 20:07 UTC (Sat)
                               by <b>kleptog</b> (subscriber, #1183)
                              [<a href="/Articles/747953/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well that explains things... I heard someone mumbling about how iptables updates can get lost and I couldn't see how, until now.<br>
<p>
In any case, if we do firewall rules as BPF we end up with the same problem surely? The performance improvement would be that you can pass your firewall through an compiler/optimiser to make it more efficient, but as a side effect you end up with the same problem, namely, to update a single rule you need to replace the whole program. Only now you've added an optimise step in between.<br>
<p>
Unless you change your API to transactional one where you can send updates and get a confirmation asynchronously and the backend is smart enough to avoid actually updating the kernel for every change.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747953/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor752248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 19, 2018 2:26 UTC (Thu)
                               by <b>manhnt</b> (guest, #123784)
                              [<a href="/Articles/752248/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, as kleptog mentioned, there are cases where iptables update can get lost some rules. I've met such cases. Does anyone know how to solve that properly? What I did was simply retrying until success, which may not be an optimum solution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/752248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor762446"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2018 4:07 UTC (Mon)
                               by <b>fest3er</b> (guest, #60379)
                              [<a href="/Articles/762446/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How many rules are you talking about? In some testing 4-6 years ago, I found that iptables could not handle more than about 20 000 rules at a time. Any more and some rules would be 'lost'. IPtables was happy to add 1 000 000 rules as long as I added them around 15 000 at a time (meaning a COMMIT every 15 000 or so). Adding so many rules wasn't real speedy, but it also wasn't outrageously slow.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762446/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor762507"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 13, 2018 16:37 UTC (Mon)
                               by <b>antiphase</b> (subscriber, #111993)
                              [<a href="/Articles/762507/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Use ipset to create address lists instead of using individual per-address rules. It doesn't change the reload behaviour, but it will potentially hugely reduce the number of rules if you're matching in similar ways just with different addresses, and is also faster shifting packets as a bonus.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/762507/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor747586"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 6:42 UTC (Tue)
                               by <b>valberg</b> (guest, #83862)
                              [<a href="/Articles/747586/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks, Jonathan, for another great article.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747586/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747591"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 7:01 UTC (Tue)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/747591/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So what is the origin of BPF? I thought the PF stood for packet filter because it had originated as a way to compile firewall rules — but according to the article this is the first time it has been used there. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747591/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747592"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 7:17 UTC (Tue)
                               by <b>dgm</b> (subscriber, #49227)
                              [<a href="/Articles/747592/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And the "B" stands for Berkely, where it originated. The Wikipedia article (<a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter">https://en.wikipedia.org/wiki/Berkeley_Packet_Filter</a>) is a bit light on details, but you will find them in the original paper (<a href="http://www.tcpdump.org/papers/bpf-usenix93.pdf">http://www.tcpdump.org/papers/bpf-usenix93.pdf</a>).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747592/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747632"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 16:17 UTC (Tue)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/747632/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It was originally used for filtering of packets for tools like tcpdump, so that when you say "show me traffic on tcp port 80 to this IP" the kernel can very quickly select the data you want and feed it to you at wire speed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747632/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor747593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 7:51 UTC (Tue)
                               by <b>vadim</b> (subscriber, #35271)
                              [<a href="/Articles/747593/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>nftables is a quite nice idea. I think the problem with it was that they were slow at implementing the last few features that were actually quite important.</p>

<p>For instance, nftables can do MSS clamping only since kernel 4.14. This was released this November. nftables has been around since 2014, like this article says. MSS clamping is a feature in wide use for DSL and fiber setups, and this is important precisely to the kinds of people that want to run their own firewall.</p>

<p>IMO, the other problem with it is that the documentation is still not great, and the syntax leaves a lot to be desired.</p>

<p>For instance, nftables involves stringing together commands in a way that highly resembles a run-on sentence:</p>

<pre>
    nft add rule ip filter forward oifname ppp0 tcp flags syn tcp option maxseg size set 1452
</pre>

<p>It's not immediately obvious how the syntax works and what words fit in where in the hierarchy. The way "ppp0" is not quoted or delimited in any way also makes it hard to tell apart commands from data, though this can be done as seen below. There's a C-ish form that looks a bit nicer, but then when you run into a command that starts with "nft add" it's not obvious how to put that into your config file, which looks like:</p>

<pre>
table ip filter {
	# allow packets from LAN to WAN, and WAN to LAN if LAN initiated the connection
	chain forward {
		iifname "lan0" oifname "wan0" accept
        }
}
</pre>

<p>Note how it is subtly different: we go from "ip filter" to "table ip filter", and from "forward" to "chain forward", and for someone not familiar with the syntax it's not really apparent that "oifname" in the first example is the point where you'd want to start copy/pasting.</p>

<p>I hope that besides the technical details, the makers of BPF also take care of producing a better syntax and good documentation.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/747593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 15:25 UTC (Tue)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/747621/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, it's a lot like someone looked at the "tc" and "ip" commands and thought "what a great UI, lets do that".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747631"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 16:17 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/747631/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've got a working (AFAIK) nftables setup. The end result looks pretty after months of tweaking, but I completely agree on how unnecessarily painful it was to get there. Spitting nothing but strerror(-ENOENT) at the user whenever any module is missing from the kernel is a nasty thing to do…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747631/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747650"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2018 0:15 UTC (Wed)
                               by <b>florianfainelli</b> (subscriber, #61952)
                              [<a href="/Articles/747650/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Fortunately we now have extended netlink acks to give you a more meaningful error code...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747650/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor748323"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2018 11:31 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/748323/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;For instance, nftables involves stringing together commands in a way that highly resembles a run-on sentence:</font><br>
&gt;<br>
<font class="QuotedText">&gt;    nft add rule ip filter forward oifname ppp0 tcp flags syn tcp option maxseg size set 1452</font><br>
&gt;<br>
<font class="QuotedText">&gt;It's not immediately obvious how the syntax works and what words fit in where in the hierarchy.</font><br>
<p>
This is where the iptables UI excels - the tokens for "options" and tokens for "values" never ever overlap, I am tempted to say *context-free*. The nft "tcp" instead could either mean "-p tcp" or "--tcp-flags ..." depending on where it's located, and what makes the bpf/ip/tc/nft syntax so terrible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/748323/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor747608"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 12:56 UTC (Tue)
                               by <b>iq-0</b> (subscriber, #36655)
                              [<a href="/Articles/747608/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm in favor of a jit-able packet filter that might partially be offloaded to hardware.<br>
<p>
But the real challenges are often not the ruleset overhead, but are related to connection tracking, matching against advanced set datastructures and in the interaction with the rest of the network stack. I feel like here is a basic conflict between calling kernel functions to get better access to advanced algorithms and datastructures and the basic JIT and offloading story of bpfilter.<br>
<p>
And didn't BPF programs have a size constraint? Or is that something that can be worked around using BPF_MAP_TYPE_PROG_ARRAY?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747608/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor747610"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 20, 2018 13:40 UTC (Tue)
                               by <b>kooky</b> (subscriber, #92468)
                              [<a href="/Articles/747610/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I thought nftables ruleset already used BPF?<br>
<p>
I've been using nftables and find it just works now I've got the hang. <br>
<p>
Tim<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747610/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747651"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2018 0:20 UTC (Wed)
                               by <b>florianfainelli</b> (subscriber, #61952)
                              [<a href="/Articles/747651/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You would think it would, but this was actually a custom VM, Pablo just posted patches to do exactly that though:<br>
<p>
<a href="https://www.mail-archive.com/netdev@vger.kernel.org/msg217425.html">https://www.mail-archive.com/netdev@vger.kernel.org/msg21...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747651/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor747670"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2018 13:26 UTC (Wed)
                               by <b>pomac</b> (subscriber, #94901)
                              [<a href="/Articles/747670/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I find this really interesting, I've wondered and tried to push a change to bpf for a while but =)<br>
<p>
Anyway, for those that want to follow the threads in a easier manner:<br>
<p>
<a href="https://marc.info/?l=linux-netdev&amp;m=151905824829539&amp;w=2">https://marc.info/?l=linux-netdev&amp;m=151905824829539&amp;...</a> - [PATCH RFC PoC 0/3] nftables meets bpf<br>
<a href="https://marc.info/?l=netfilter-devel&amp;m=151878844403666&amp;w=2">https://marc.info/?l=netfilter-devel&amp;m=15187884440366...</a> - [PATCH RFC 0/4] net: add bpfilter<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747670/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor747937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2018 23:01 UTC (Fri)
                               by <b>ofranja</b> (subscriber, #11084)
                              [<a href="/Articles/747937/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Developers should be careful, though; this could prove to be a slippery slope leading toward something that starts to look like a microkernel architecture.</font><br>
<p>
Or, even further, an exokernel architecture.<br>
<p>
In the original MIT exokernel research (~1995), a packet filter language w/JIT compiler is mentioned as a way to filter and delegate network traffic to userspace with minimal [1] kernel support (although not necessarily using these terms, but the general idea is the same).<br>
<p>
[1] <a href="https://pdos.csail.mit.edu/archive/exo/exo-slides/sld011.htm">https://pdos.csail.mit.edu/archive/exo/exo-slides/sld011.htm</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/747937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor794718"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BPF comes to firewalls</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 26, 2019 20:13 UTC (Fri)
                               by <b>valentine</b> (guest, #133435)
                              [<a href="/Articles/794718/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hi all,<br>
I've some small questions about the post.<br>
- What is the relationship between BPF and eBPF?<br>
- I still haven't understood how to work BP: are attached at the express data path (XDP) layer, so they are run from the network-interface drivers or not? If yes the NIC drivers must be rewritten?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794718/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2018, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
