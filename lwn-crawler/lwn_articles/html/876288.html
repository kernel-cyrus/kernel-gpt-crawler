        <!DOCTYPE html>
        <html lang="en">
        <head><title>In search of an appropriate RLIMIT_MEMLOCK default [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/876288/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/876364/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/876288/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>In search of an appropriate RLIMIT_MEMLOCK default</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 19, 2021</br>
           </div>
One does not normally expect a lot of disagreement over a 13-line patch
that effectively tweaks a single line of code.  Occasionally, though, such
a patch can expose a disagreement over how the behavior of the kernel
should be managed.  <a
href="/ml/linux-kernel/20211028080813.15966-1-sir@cmpwn.com/">This patch
from Drew DeVault</a>, who is evidently taking a break from <a
href="https://drewdevault.com/2021/11/16/Cash-for-leftpad.html">stirring up
the npm community</a>, is a case in point.  It brings to light the question
of how  the kernel community should pick default values for configurable
parameters like resource limits.

<p>
The kernel implements a set of resource limits applied to each
(unprivileged) running process; they regulate how much CPU time a process
can use, how many files it can have open, and more.  The <a
href="https://man7.org/linux/man-pages/man2/setrlimit.2.html"><tt>setrlimit()</tt>
man page</a> documents the full set.  Of interest here is
<tt>RLIMIT_MEMLOCK</tt>, which places a limit on how much memory a process
can lock into RAM.  Its default value is 64KB; the system administrator can
raise it, but unprivileged processes cannot.
<p>
Once upon a time, locking memory was a privileged operation.  The ability
to prevent memory from being swapped out can present resource-management
problems for the kernel; if too much memory is locked, there will not be
enough left for the rest of the system to function normally.  The
widespread use of cryptographic utilities like GnuPG eventually led to this
feature being made available to all processes, though.  By locking memory
containing sensitive data (keys and passphrases, for example), GnuPG can
prevent that data from being written to swap devices or core-dump files.
To enable this extra security, the kernel community opened up the <a
href="https://man7.org/linux/man-pages/man2/mlock.2.html"><tt>mlock()</tt>
system call</a> to all users, but set the limit for the number of pages
that can be locked to a relatively low value.
<p>
Uses of memory change over time.  GnuPG does not really need more locked memory
than it did years ago, but there are now other ways that users can run into
the locked-memory limit.  BPF programs, for example, are stored in
unswappable kernel memory, with the space used being charged against this
limit.  These programs tend to be relatively small, but 64KB is likely to
be constraining for many users.  The big new consumer of locked memory,
though, is <a href="/Articles/776703/">io_uring</a>.
<p>
Whenever the kernel sets up a user-space buffer for I/O, that buffer must
be locked into memory for the duration of the operation.  This locking is a
short-lived affair and is not charged against the user's limit.  There is,
however, quite a bit of work involved in setting up an I/O buffer and
locking it in memory; if that buffer is used for frequent I/O operations,
the setup and teardown costs can reach a point where they slow the
application measurably.  As a way of eliminating this cost, the io_uring
subsystem allows users to "register" their buffers; that operation sets up
the buffers for I/O and leaves them in place where they can be used
repeatedly.
<p>
I/O buffers can be large, so locking them into memory can consume
significant amounts of RAM; it thus makes sense that a limit on how much
memory can be locked in this way should be imposed.  So, when buffers are
registered, the kernel charges them against the same locked-memory limit.
This is where the 64KB limit becomes truly constraining; to make the use of
io_uring worthwhile, one almost certainly wants to use much larger buffers
than will fit in that space.  The 64KB default limit, as a result, has the
potential to make io_uring unavailable to users unless it is increased by
distributors or administrators — and that tends not to happen.
<p>
To avoid this problem, DeVault would like to raise that limit to 8MB.
Expecting the problem to be addressed elsewhere, he said, is not realistic:
<p>
<blockquote class="bq">
	The buck, as it were, stops with the kernel. It's much easier to
	address it here than it is to bring it to hundreds of
	distributions, and it can only realistically be relied upon to be
	high-enough by end-user software if it is more-or-less ubiquitous.
</blockquote>
<p>
Matthew Wilcox <a
href="/ml/linux-kernel/YZP6JSd4h45cyvsy@casper.infradead.org/">pointed
out</a> that there are plenty of other ways for a malicious user to lock down at
least 8MB of memory, so he saw no added danger from this change, but with a
couple of 
reservations.  Perhaps it would be better to somehow scale the limit, he
said, so that it would be smaller on machines with small amounts of
memory.  He also wondered if 8MB was the right value for the new limit, or
whether io_uring users would need still more.  Jens Axboe, the maintainer
of io_uring, <a
href="/ml/linux-kernel/b97f1b15-fbcc-92a4-96ca-e918c2f6c7a3@kernel.dk/">replied</a>
that "<q>8MB is plenty for most casual use cases</q>", and those are
the cases that should "just work" without the need for administrator
intervention.
<p>
Andrew Morton, though, <a
href="/ml/linux-kernel/20211116133750.0f625f73a1e4843daf13b8f7@linux-foundation.org/">was
not convinced</a> about this value — or any other:
<p>
<blockquote class="bq">
	We're never going to get this right, are we?  The only person who
	can decide on a system's appropriate setting is the operator of
	that system.  Haphazardly increasing the limit every few years
	mainly reduces incentive for people to get this right.
</blockquote>
<p>
DeVault <a
href="/ml/linux-kernel/CFRWRP3RTFT4.3VWRBA26OUSND@taiga/">answered</a> that
"<q>perfect is the enemy of good</q>", and that he lacked the time to
try to convince all of the distributors to configure a more realistic
default.  Morton's further <a
href="/ml/linux-kernel/20211118135846.26da93737a70d486e68462bf@linux-foundation.org/">suggestion</a>
that the limit should have been set to zero from the beginning to force a
solution in user space was <a
href="/ml/linux-kernel/CFTL5A99FTIY.38WS1HS59BT2D@taiga/">not received
well</a>.   And that, more or less, is where the conversation wound down.
<p>
One line of thought here seems to be that the kernel community should not
try to come up with usable defaults for parameters like
<tt>RLIMIT_MEMLOCK</tt>; that will force downstream distributors to think
about what their users need and configure things accordingly.  But that
seems like a recipe for the status quo, where a useful new feature is, in
fact, not useful on most systems.  Putting some thought into reasonable
default values is something one normally expects from a software project;
it's not clear why the kernel would be different in this regard.  So
this change will, in all likelihood, eventually find its way in, but perhaps
not until the emails-to-lines-changed ratio becomes even higher.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#io_uring">io_uring</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-User-space_memory_locking">Memory management/User-space memory locking</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Resource_limits">Resource limits</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/876288/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor876550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 19, 2021 20:46 UTC (Fri)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/876550/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One line of thought here seems to be that the kernel community should not try to come up with usable defaults for parameters like RLIMIT_MEMLOCK; that will force downstream distributors to think about what their users need and configure things accordingly.</font><br>
<p>
I have the opposite thought there. When downstream is forced to set a configuration option, the knowledge about which values are sensible stops flowing upstream. That means an endless growth of suboptimal config flags and tweaking knobs that nobody dares touch because they don&#x27;t understand what they are set to in the real world.<br>
<p>
That is why I think bad heuristics are always preferable to flexible configuration: people will send patches for bad heuristics, flexible configuration just ends up piling up in (often secret) internal tweak lists.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876552"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 19, 2021 21:33 UTC (Fri)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/876552/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;d go even further, and suggest that kernel devs should let downstream users figure converge on a reasonable value empirically.<br>
Don&#x27;t make the default so hopelessly hard to change that users work around it locally, without trying to work with upstream.<br>
Let vaguely reasonable limit increase requests go through, until and unless real-world users find practical concerns.<br>
<p>
These are not the kind of changes that frequently result in systems not booting. I don&#x27;t want to minimize how bad it is to break working code. It is bad. It makes me want to run 2.6.<br>
<p>
But, probably, you save more pain by preventing default ossification than you cause by making rc testers speak up a little more often.<br>
People who like stability will still run stable kernels, and people who like BPF in their io-uring get make -rc1 a proper -rc1.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876552/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor876555"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 19, 2021 22:09 UTC (Fri)
                               by <b>mtaht</b> (subscriber, #11087)
                              [<a href="/Articles/876555/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One way to think about this is how many I/O operations do you want to be held<br>
outstanding in the kernel, and instead of thinking about that in terms of size, but time.<br>
<p>
Putting 1ms of requests in io_uring seems like a reasonable amount of buffering before context switching back into the application.<br>
<p>
Figuring out a BQL-like yet predictive mechanism for sizing io_uring in this way was too long to scribble in the margins of this post.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876555/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor876589"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 23:50 UTC (Sat)
                               by <b>gerdesj</b> (subscriber, #5446)
                              [<a href="/Articles/876589/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
&quot;I have the opposite thought there.&quot;<br>
<p>
Me too.  The article clearly states that Jens Axboe was consulted and he gave his opinion.  That&#x27;s an &quot;expert opinion&quot; in anyone&#x27;s book.  It wasn&#x27;t a &quot;hand on the book&quot; type of opinion but a piece of knowledge from someone who knows stuff. <br>
<p>
For me, as a sysadmin, that is good enough for a default.  I have a massive number of things to juggle already and I need sensible defaults.  If it is wrong for my use case, I&#x27;ll wrangle the problem myself - that&#x27;s my problem, but I want sensible defaults and an opinion from someone who wrote the code is good enough for me.  <br>
<p>
I really don&#x27;t want to be bothered with a minor religious disagreement.  Kernel runtime parameter config is ... sysadmin stuff - that&#x27;s what I do (or try to avoid as much as possible).  Kernel parameter defaults:  I want the likes of Jens to opine on that.  If the defaults eventually turn out to be mad then that will fairly soon come back as a bug and get fixed at source.  Also the person(s) best placed to fix the problem will get the best feedback.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876589/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876573"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 9:34 UTC (Sat)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/876573/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As usual, spender has an interesting take on the matter: raising the RLIMIT_MEMLOCK default value is a great thing... for exploit writers :)<br>
<p>
<a href="https://mobile.twitter.com/spendergrsec/status/1461794900639371266">https://mobile.twitter.com/spendergrsec/status/1461794900...</a><br>
&quot;<br>
This MEMLOCK_LIMIT change is great for exploit reliability when accessing userland data directly (afaik my enlightenment exploits were the only ones at the time that accounted for this)<br>
<p>
8MB of data instead of 64kb (old unpriv limit for most systems) guaranteed not to fault (i.e. crash) when the kernel accesses it (modulo SMAP of course)<br>
&quot;<br>
<p>
I don&#x27;t want the io_uring or eBPF attack surface, because these pieces of infrastructure, appeared on security vulnerability lists multiple times, and more fundamentally, I don&#x27;t need them in the first place: most of the many computers I have access to don&#x27;t have SSDs, even with a SATA interface, and don&#x27;t run high-performance workloads where eBPF is relevant.<br>
Therefore, changing the default value of RLIMIT_MEMLOCK strongly looks like a proposition with net negative value - worse security without a functional improvement relevant to me, the users of said computers... and the probably still many users of other computers whose workloads don&#x27;t benefit from io_uring &amp; eBPF, too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876573/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876581"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 20:11 UTC (Sat)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/876581/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
io_uring is very much relevant even for spinning rust, though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876581/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876583"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 21:25 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/876583/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Efficient completion (rather than readiness) based network IO is also useful in a lot of situations that do not involve meaningful amounts of disk IO. And doing that while not wasting memory requires requires registered buffers... <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876583/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876585"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 21:33 UTC (Sat)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/876585/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think I might have missed something about how to use io_uring with network I/O, though. Are you still supposed to use epoll to check for readiness? I mean, you can&#x27;t just fire off read() or send() (as appropriate) for every socket, since the ring is of finite size, right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876585/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876586"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 22:05 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/876586/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Network IO that internally is waiting doesn&#x27;t take up a ring entry. Of course that opens up the danger that there are completions that don&#x27;t fit the ring - which has been addressed by storing overflowing completions off ring (there&#x27;s a feature flag to test for for this).<br>
<p>
There&#x27;s a second issue with just using readiness for receiving network data: The amount of buffer space that requires. Newer kernel version address that by providing buffer space that isn&#x27;tt associated with a specific IO that are used when needed. But that buffer space IIRC is counted as locked. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876586/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876587"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 22:19 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/876587/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See <a href="https://lwn.net/Articles/815491/">https://lwn.net/Articles/815491/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876587/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor876597"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 21, 2021 20:37 UTC (Sun)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/876597/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t think it&#x27;s a significant help for exploit writers.  The entire mm subsystem is built around keeping in-use pages in memory: it isn&#x27;t tough to have your exploiting process regularly access values from your userspace buffer, preventing it from being swapped out.  Further, the kernel won&#x27;t even be trying to swap out pages unless memory pressure is fairly high: and even in that case, it would be prioritizing the little-used pages (which, for every application that I know of, there are _many_).<br>
<p>
The change may not give you any direct performance improvement: however, the improved preformance of the servers you use (as they are encouraged to use io_uring) benefits you, and even that tiny benefit is probably greater than the cost of slightly reducing the difficulty of exploits that rely on directing the kernel to access userspace buffers without faulting.  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876597/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876575"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2021 9:43 UTC (Sat)
                               by <b>ddevault</b> (subscriber, #99589)
                              [<a href="/Articles/876575/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Given a 10,000 line patch, there is little to argue over. Given a somewhat arbitrarily selected 64-bit integer to tune, and we&#x27;ll come up with 18,446,744,073,709,551,616 possible answers :)<br>
<p>
Either way this is resolved, I ended up coming up with a workaround for my original problem, but it would certainly be much better to do without it. Here&#x27;s to the eternal bikeshed!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876575/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor877416"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2021 14:15 UTC (Thu)
                               by <b>smitty_one_each</b> (subscriber, #28989)
                              [<a href="/Articles/877416/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It seems as though this would be a good selling point for distributions that make heavy use of the feature.<br>
<p>
&quot;Drewnux is your video server distro, because it gets the IO right.&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/877416/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876594"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 21, 2021 11:39 UTC (Sun)
                               by <b>nilsmeyer</b> (guest, #122604)
                              [<a href="/Articles/876594/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m thinking of a different risk here, that is people who run into limits just running the program as root instead. A typical source of confusion here is whether to set the limits (somewhere) in /etc/pam.d or as a systemd override, or just people who don&#x27;t want to expend the effort to research. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876594/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 21, 2021 23:41 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/876599/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The thing to bear in mind about resource limits is that, in most cases, regular apps and services do not directly call setrlimit(2) themselves. Instead, you put everything (that you care about) into a container, and then tell your orchestration system to enforce resource limits, which may or may not be implemented as a call to setrlimit(2). Why? Because you want to manage those resource limits in a central fashion which is aware of the overall amount of resources available in the entire cluster or data center, not just each individual machine. Managing your resources one machine at a time is way too far to the pets end of the pets-vs-cattle spectrum; if your setup is small enough to be a pet shop rather than a cattle shop, your resource management process is probably just &quot;Is the server beefy enough? (Y/N)&quot; rather than some convoluted setrlimit(2) nonsense.<br>
<p>
So the actual consumer of the setrlimit(2) API is generally going to be container orchestration systems, and/or distros that replace the kernel&#x27;s defaults with their own defaults. If you&#x27;re not using a container orchestration system, then it&#x27;s pretty likely that your limits are either whatever the (distro or kernel) default is, or managed in an ad-hoc way where you reactively bump them up or down in order to fix problems, rather than proactively planning out your usage in a systematic fashion. But lots of people don&#x27;t use orchestration systems. So the defaults had better be pretty reasonable, since bad defaults will inconvenience a very large group of sysadmins.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876754"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 24, 2021 8:53 UTC (Wed)
                               by <b>nilsmeyer</b> (guest, #122604)
                              [<a href="/Articles/876754/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m just describing what I&#x27;ve seen in the wild. Of course having the cattle approach and an orchestration system and competent admin/SRE teams is better(tm), but that&#x27;s just not the reality for a lot of organizations I&#x27;ve seen from the inside - granted that&#x27;s usually why I&#x27;m asked to take a look in the first place. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876754/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876827"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2021 9:44 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/876827/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I entirely agree. In fact, that&#x27;s actually my whole point - defaults are used by lots of sysadmins, most of whom are not really in a position to come up with their own settings (at least, not without a lot of manual profiling and other busywork that most sysadmins frankly are not going to get around to doing). When the kernel developers say &quot;I dunno, let&#x27;s just make it the sysadmin&#x27;s problem,&quot; in practice this actually means that many systems will be poorly configured, unless or until the misconfiguration gets so egregiously bad that someone with the authority to do so actually files a P1 ticket (or Urgent, or whatever label your ticketing system uses for &quot;we actually care about this one&quot;).<br>
<p>
The cattle people, by contrast, don&#x27;t care about rlimit defaults in the first place, because they just ingest the dimension into their existing resource management system and automate the whole problem away. So in a sense, these defaults are a pets-only affair, and you need to take a realistic view of what a pet-shop sysadmin can plausibly do in terms of tuning arcane system parameters that they likely have never even heard of. Of course, plenty of pets are actually workstations, or laptops, or other such non-server devices,* in which case the sysadmin is probably either a SWE or the IT department, and might not even speak fluent bash, let alone know what an &quot;rlimit&quot; is supposed to be.<br>
<p>
* I&#x27;m ignoring Android and Android-like devices because I assume that Google or whoever will extensively customize absolutely everything, and pick sane defaults (or at least, defaults that are not obviously ridiculous). Also, it would not really make sense for Linus and co. to try and guess how to tune Linux to perform well on a smartphone.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876827/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876832"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2021 13:03 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/876832/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The cattle people, by contrast, don&#x27;t care about rlimit defaults in the first place, because they just ingest the dimension into their existing resource management system and automate the whole problem away. So in a sense, these defaults are a pets-only affair, and you need to take a realistic view of what a pet-shop sysadmin can plausibly do in terms of tuning arcane system parameters that they likely have never even heard of. Of course, plenty of pets are actually workstations, or laptops, or other such non-server devices,* in which case the sysadmin is probably either a SWE or the IT department, and might not even speak fluent bash, let alone know what an &quot;rlimit&quot; is supposed to be.</font><br>
<p>
And you&#x27;re forgetting people like me, who run a home server, so just like MS pisses me off with the error message &quot;contact your system administrator&quot;, you&#x27;re doing the same telling me to &quot;contact yourself to fix the problem&quot;, WITHOUT giving me any clues as to what the problem is, or how to solve it.<br>
<p>
So the equivalence &quot;pet-shop admin == end user without a clue&quot; is largely true. You&#x27;re just throwing these people under the bus, but the reality is these people are also VERY IMPORTANT in the PR war. We run linux from choice, and our contribution is political, not technical ...<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876832/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876865"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2021 0:25 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/876865/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While I&#x27;m quite sure that YOU speak fluent bash, since you read and comment on LWN articles, there are plenty of SWEs who can barely function in a non-GUI environment. It&#x27;s actually kind of terrifying to me, but in a creeping existential dread sort of way.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876865/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876879"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2021 11:16 UTC (Fri)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/876879/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <p>I went along to my employer's optional internal training on being productive with the command line, and was surprised by how much of what my fellow attendees thought was "amazing information" was stuff I considered basic CLI knowledge.
<p>CLIs just aren't the normal form of interaction for modern programmers, most of the time, and thus the basics aren't being learnt (or taught).


      
          <div class="CommentReplyButton">
            <form action="/Articles/876879/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor877187"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 30, 2021 16:32 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/877187/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This has, of course, been true for decades. The stuff at the start of Charlie Stross&#x27;s _The Atrocity Archive_ involving a necromantic summoning training course in which our protagonist has exactly the same realisation was drawn directly from, er, life -- and that was written in the year 2000...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/877187/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876885"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2021 13:07 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/876885/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually, I *DON&#x27;T* speak fluent bash. My scripting language of choice would be an obsolete language called CPL (Command Procedure Language). I think there are a few Pr1mates here who would recognise it :-)<br>
<p>
sed, grep, awk, etc are all power tools I have never really got to grips with, because I&#x27;ve never been in an envioronment where they were either (a) the goto tools, or (b) my colleagues were familiar with them.<br>
<p>
And while I&#x27;ve forgotten most of my CPL, it had a lot of power capabilites that were the equivalent.<br>
<p>
But yes, I did grow up and cut my computing teeth in a time before guis like X and Windows. It just wasn&#x27;t in a nix environment, which is why I&#x27;m so damning of (li)nux sometimes - I feel it&#x27;s a case of &quot;Unix won because it was good enough and cheap enough&quot;. Doesn&#x27;t stop it being crap :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876885/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor876699"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2021 14:26 UTC (Tue)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/876699/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Using the same number for io_uring as for everything else might be the problem. <br>
<p>
If buffers only written to by the kernel were charged to the kernel, that might sidestep most of the conflict. That would depend on such buffers being made to be writable only by the kernel, which would be a new but IMO valuable feature. A buffer I cannot write into is one that cannot be sprayed by malicious code in my process.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876699/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876724"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2021 17:27 UTC (Tue)
                               by <b>notriddle</b> (subscriber, #130608)
                              [<a href="/Articles/876724/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Limits that are “charged to the kernel” aren’t really limits at all. They’re DoS vectors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876724/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor878228"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2021 7:17 UTC (Fri)
                               by <b>massimiliano</b> (subscriber, #3048)
                              [<a href="/Articles/878228/">Link</a>] 
      </p>
      
      </div>
      </summary>
      Then perhaps the sensible proposal would be to have two separated limits: one (with a low default, like 64Kb) for locked memory writable by user space, and another (with a larger default, like 8Mb, because it is safe anyway) for locked memory writable only by the kernel.


      
          <div class="CommentReplyButton">
            <form action="/Articles/878228/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor876715"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2021 15:43 UTC (Tue)
                               by <b>stevie-oh</b> (subscriber, #130795)
                              [<a href="/Articles/876715/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Something I&#x27;m not quite grasping here -- and I freely admit that I have only the faintest idea of how the underlying mechanisms work, so it may be obvious to those more familiar with them:<br>
<p>
Why isn&#x27;t this a problem for applications that aren&#x27;t using io_uring?<br>
<p>
What if I issue a `read` call with an 8MB buffer? <br>
<p>
What if I create eight new threads and have each thread issue a `read` call into an 8MB buffer?  That&#x27;s 64MB right there.<br>
<p>
As I understand it, from a computational standpoint, using io_uring does not increase a program&#x27;s capabilities.  In the same way that the bulk of the Linux kernel could be written in Brainf*ck instead of C, any program implemented using io_uring could could accomplish the same sort of thing in terms of multiple threads and ordinary calls to `read`/`write`/etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876715/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876717"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2021 16:21 UTC (Tue)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/876717/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      A basic <tt>read()</tt> call does not lock the buffer into memory most of the time.  If you are doing some sort of direct I/O, the buffer may indeed be locked into memory but (as the article says), that lock will only exist for the duration of the I/O operation and is not charged against the locked-memory limit.  Registered buffers, instead, remain locked in memory indefinitely, thus need to be treated differently.



      
          <div class="CommentReplyButton">
            <form action="/Articles/876717/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor878233"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 10, 2021 8:42 UTC (Fri)
                               by <b>njs</b> (guest, #40338)
                              [<a href="/Articles/878233/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Don&#x27;t the io_ring submission and completion buffers also count against the RLIMIT_MEMLOCK limit? That&#x27;s much more annoying, because they&#x27;re the equivalent of e.g. an epoll fd&#x27;s internal state -- that&#x27;s kernel memory, not mapped into userspace, but it&#x27;s still memory. Yet with epoll, userspace gets to freely register as many fds as it wants, without having to worry about hitting RLIMIT_MEMLOCK.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/878233/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876716"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2021 16:27 UTC (Tue)
                               by <b>david.hildenbrand</b> (subscriber, #108299)
                              [<a href="/Articles/876716/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
io_uring with fixed buffers uses a technology called GUP (Get user Pages) with the flavor FOLL_LONGTERM. For starters: take a reference to a target (user space) page with the semantics of holding the reference for a long time, possibly forever. Later, we can simply access that page without any additional locking and page-table lookups, because the additional reference makes the page &quot;stick around&quot; and prevents it from getting freed.<br>
<p>
So there is an additional long-term reference to a page that is not due to the page being mapped into a user space page table.<br>
<p>
While we have such a reference on a page, such a page cannot be swapped out (&quot;locked into memory&quot;) like mlock. But worse, it cannot be migrated/moved around in memory anymore, meaning that it can prevent memory compaction. Possibly forever.<br>
<p>
It behaves &quot;at least as worse&quot; as mlock&#x27;ed memory, therefore, for now we account it as RLIMIT_MEMLOCK. But really, it&#x27;s much worse.<br>
<p>
The only reason io_uring uses FOLL_LONGTERM is because it&#x27;s faster than alternatives that are &quot;nice&quot; to the MM subsystem and can actually drop references temporarily to re-take them when necessary later.<br>
<p>
a) Why isn&#x27;t this a problem for applications that aren&#x27;t using io_uring?<br>
<p>
We barely have features that expose FOLL_LONGTERM to unprivileged user space (for a good reason if you ask me).<br>
<p>
b) What if I issue a `read` call with an 8MB buffer?<br>
<p>
IIUC, with O_DIRECT will take a short-term reference for DMA and pass it to the HW for a very short time frame, then release the page reference. Without O_DIRECT ,we simply copy the result to the target user space page from an in-kernel buffer.<br>
<p>
c) What if I create eight new threads and have each thread issue a `read` call into an 8MB buffer? That&#x27;s 64MB right there.<br>
<p>
At least the 8MB user-space buffer exists only once.<br>
<p>
d) &quot;using io_uring does not increase a program&#x27;s capabilities&quot;<br>
<p>
In regards to fixed buffers I think you are correct. It&#x27;s a pure performance improvement.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876716/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876821"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2021 0:45 UTC (Thu)
                               by <b>Fowl</b> (subscriber, #65667)
                              [<a href="/Articles/876821/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hacks upon hacks but... couldn&#x27;t io_uring conditionally use FOLL_LONGTERM based on if there was sufficient RLIMIT_MEMLOCK quota left?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876821/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876825"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2021 8:15 UTC (Thu)
                               by <b>david.hildenbrand</b> (subscriber, #108299)
                              [<a href="/Articles/876825/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
User space can implement such a fallback quite easily I think.<br>
<p>
It should be as simple as handling (and logging/warning users) errors from IORING_REGISTER_BUFFERS and then, instead of e.g., issuing a IORING_OP_READ_FIXED/IORING_OP_WRITE_FIXED, issue an IORING_OP_READ/IORING_OP_WRITE. Of course, further buffer index management in user space has to onsider that the buffer registration previously failed.<br>
<p>
A fallback inside the kernel itself would also be imaginable, however, this rather hides the error from the user and might bring surprises: not everybody wants to have a silent fallback.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876825/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2021 18:59 UTC (Thu)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/876858/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There&#x27;s no quite as easy fallback when registered buffers are used via IOSQE_BUFFER_SELECT though... Using the pessimistic amount of memory of fallback might cause further issues.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876876"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2021 8:43 UTC (Fri)
                               by <b>david.hildenbrand</b> (subscriber, #108299)
                              [<a href="/Articles/876876/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m for sure no io_uring expert :) Can you elaborate how IOSQE_BUFFER_SELECT is related to IORING_REGISTER_BUFFERS?<br>
<p>
The man page mentions for IORING_REGISTER_BUFFERS: &quot;After a successful call, the supplied buffers are mapped into the kernel and eligible for I/O. To make use of them, the application must specify the IORING_OP_READ_FIXED or IORING_OP_WRITE_FIXED opcodes in the submission queue entry ...&quot;. No notion of IOSQE_BUFFER_SELECT.<br>
<p>
IOSQE_BUFFER_SELECT in contrast is &quot;Used in conjunction with the IORING_OP_PROVIDE_BUFFERS command&quot;.<br>
<p>
Digging through the code, I can spot that io_import_fixed() is really only used for IORING_OP_READ_FIXED and IORING_OP_WRITE_FIXED. IOSQE_BUFFER_SELECT references only buffers in the &quot;IOSQE_BUFFER_SELECT&quot; (&quot;io_buffers&quot;) domain, not in the &quot;IORING_REGISTER_BUFFERS&quot; (&quot;user_bufs&quot;) domain.<br>
<p>
To be precise (include/uapi/linux/io_uring.h):<br>
<p>
            union {<br>
                /* index into fixed buffers, if used */<br>
                __u16    buf_index;<br>
                /* for grouped buffer selection */<br>
                __u16    buf_group;<br>
            }<br>
<p>
IOSQE_BUFFER_SELECT effectively uses the same member, but it&#x27;s interpreted as a buffer group selection, not a fixed buffer selection.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876876/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor876728"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2021 19:40 UTC (Tue)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/876728/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
64KB is a number from a medieval era and an indication that the whole mechanism needs to be rethought. Do away with the hard limit entirely and put that effort into making the OOM killer more robust.<br>
<p>
Visible arbitrary limits like this are stable ABI, whether we like it or not. By increasing them you subconsciously train developers to take that number for granted and grow their software towards it, and we&#x27;ve seen the end result of that in this area with glibc&#x27;s gigantic thread stacks leading to supposedly portable software not working in musl. We need good backpressure mechanisms, not more bufferbloat.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876728/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor876937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2021 18:44 UTC (Fri)
                               by <b>Hattifnattar</b> (subscriber, #93737)
                              [<a href="/Articles/876937/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Personally, I would like the kernel itself to have &quot;unreasonable&quot; default settings everywhere possible  (e.g. everything optional turned off, any numeric parameter set to zero, etc), BUT come with a default  human-readable config file where the reasonable values for a typical setup were set. This config would be a part of the upstream, subject to the same strictures and developed by the same people, but the policy would be separated from the code.<br>
<p>
Then have a 3-tier configuration system, where distributions and users would not generally _replace_ config files, but rather supplement/override values in them via separate (config-level and user-level) configs. <br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876948"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2021 19:18 UTC (Fri)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/876948/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;d like decent defaults.<br>
<p>
But your idea should be implemented everywhere. Systemd uses that idea - where I know it has system and sysadmin config files (and user where appropriate).<br>
<p>
But so many programs have a monolithic config file. Running gentoo, I have to be careful the config file doesn&#x27;t get updated trashing my config. I made the mistake of editing the Dovecot config file, and then an update trashed everything. Only after that :-) did I discover that dovecot imports a local config, which gentoo obviously doesn&#x27;t provide, so now all my config is in that ... :-)<br>
<p>
But how many other programs are that sensible?<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876948/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor877477"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">In search of an appropriate RLIMIT_MEMLOCK default</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 2, 2021 21:19 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/877477/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In systemd we actually already bump the RLIMIT_NOFILE hard limit for all userspace. I&#x27;d be fine to do the same for RLIMIT_MEMLOCK, if there are good reasons for it. We are a bit more open regarding tweaking defaults -- if there are good reasons for it -- than upstream kernel people i guess. But someone would have to file a github issue/pr for this, and include enough quotes from relevant people to make it sufficiently clear to us that this is a good idea.<br>
<p>
Lennart<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/877477/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
