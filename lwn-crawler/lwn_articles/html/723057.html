        <!DOCTYPE html>
        <html lang="en">
        <head><title>Restricting pathname resolution with AT_NO_JUMPS [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/723057/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/722566/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/723057/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Restricting pathname resolution with AT_NO_JUMPS</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="GAByline">
           <p>May 17, 2017</p>
           <p>This article was contributed by Nur Hussein</p>
           </div>
<p>On April 29, Al Viro <a
href="/Articles/721443/">posted a
patch</a> on the linux-api mailing list adding a new flag to be used in
conjunction with the <tt>...at()</tt> family of system calls. The flag is for
containing pathname resolution to the same filesystem and subtree as
the given starting point. This is a useful feature to have for
implementing file I/O in programs that accept pathnames as untrusted user
input.  The ensuing discussion made it clear that there were multiple use
cases for such a feature, especially if the granularity of its restrictions
could be increased.
<p>
As an example use case, consider a web server that accepts requests for
documents along with a 
relative path to said documents from the root of the server data
directory. It is imperative that the 
user-supplied pathname sent to a web server is not allowed to name files
outside of the web-server subtree. If the web server could
use file I/O system calls that guaranteed that any given path will never
break out of a certain subdirectory tree, it would give an additional layer of
security to the server.</p>


<p>The <tt>...at()</tt> family of system calls (such as <tt><a
href="http://man7.org/linux/man-pages/man2/open.2.html">openat()</a></tt>,
<tt><a
href="http://man7.org/linux/man-pages/man3/fstatat.3p.html">fstatat()</a></tt>,
<tt><a
href="http://man7.org/linux/man-pages/man2/mknod.2.html">mknodat()</a></tt>,
etc.) are a relatively new series of POSIX filesystem interfaces, similar to
<tt>open()</tt>, <tt>fstat()</tt>, <tt>mknod()</tt>, and friends, but
allowing the start point
for relative pathnames to be something other than the current working
directory. For example, the <tt>openat()</tt> system call's prototype is:

<pre>
    int openat(int dirfd, const char *pathname, int flags);
</pre>

<p>A call to <tt>openat()</tt> will try to open the file specified by the
<tt>pathname</tt>. If the pathname is a relative path, such as
<tt>../home/user1</tt>, <tt>openat()</tt> will try and walk the directory
structure relative to the directory bound to the file descriptor
<tt>dirfd</tt>, instead of the current working directory (which is what
<tt>open()</tt> does). The behavior of this and other calls in the same
family can be further altered with the <tt>flags</tt> parameter.</p>


<p>Viro's proposed flag (initially called <tt>AT_NO_JUMPS</tt>) for the
<tt>..at()</tt> calls would restrict the directory traversal of those
calls to the same subtree as the starting point and, in any case,
within the same filesystem. When the flag is set, the <tt>...at()</tt> call
affected would fail with <tt>-ELOOP</tt> upon encountering an absolute
pathname, an absolute symbolic link, a procfs-style symbolic 
link, a pathname that results in the traversal of a mount point, or any
relative path that starts with "<tt>..</tt>". This flag
thus confines pathname lookups to subdirectories of the starting point that
are contained within the same mount point, while allowing the traversal of
relative symbolic links that do not violate the aforementioned rules. The
error code <tt>-ELOOP</tt> is used by Unix-like operating systems to tell
the user that too many symbolic links were encountered during pathname
lookup, but it is used here as a
placeholder. The patch only implements <tt>AT_NO_JUMPS</tt> for 
<tt>fstatat()</tt> and friends, but the 
proposal is for it to be extended to all the <tt>...at()</tt> calls.  

<p>Jann Horn <a
href="http://marc.info/?l=linux-kernel&m=149366024305125&w=2">commented</a>
that this proposal is somewhat similar to the <a
href="/Articles/619146/"><tt>O_BENEATH</tt>
functionality</a> that was <a
href="/Articles/619151/">sent to the
Linux kernel list</a> by David Drysdale in November 2014, but was
ultimately not merged. The <tt>O_BENEATH</tt> flag is a port
of a feature from <a href="https://lwn.net/Articles/604015/ ">Capsicum</a>,
a project that seeks to provide the ability to use capabilities to let
applications sandbox themselves with a high degree of
control. Horn noted that, while the functionality is similar, the intended
use case for <tt>O_BENEATH</tt> is application sandboxing, whereas the
<tt>AT_NO_JUMPS</tt> flag is to enable user programs to limit their own
filesystem access. Viro <a
href="http://marc.info/?l=linux-api&m=149394423423941&w=2">commented</a>
that, unlike <tt>O_BENEATH</tt>, <tt>AT_NO_JUMPS</tt> does allow relative
symbolic links, which he thinks is the saner option:</p> 

<div class="BigQuote">
It's not quite O_BENEATH, and IMO it's saner that way - a/b/c/../d is
bloody well allowed, and so are relative symlinks that do not lead out of
the subtree.  If somebody has a good argument in favour of flat-out
ban on .. (_other_ than "other guys do it that way, and it doesn't need
to make sense 'cuz security!!1!!!", please), I'd be glad to hear it.
</div>

<p>Andy Lutomirski <a
href="http://marc.info/?l=linux-fsdevel&m=149351485126402&w=2">suggested</a>
splitting the flag into two, "<q>one to prevent moving between mounts
and one for everything else</q>". This is because web servers and the
like will probably be fine with mount-point traversal; they only need the
directory containment feature. Horn <a
href="http://marc.info/?l=linux-api&m=149366026005128&w=2">concurred</a>
with Lutomirski about the usefulness of the split.</p> 

<p>Viro agreed that the no-mount-point-crossing policy from
<tt>AT_NO_JUMPS</tt> could be split out into a separate flag. He proposed
<tt>AT_XDEV</tt> for preventing mount point crossing, and the original flag
be renamed to <tt>AT_BENEATH</tt> to match the functionality of
<tt>O_BENEATH</tt>, which does allow crossing mount points. The
returned error for crossing mount points when <tt>AT_XDEV</tt> is enabled
could be the obvious <tt>-EXDEV</tt>, while the error for
<tt>AT_BENEATH</tt> would still be <tt>-ELOOP</tt> (which Viro isn't too
satisfied with, but nothing else has been suggested thus far). 

<p>Linus Torvalds <a
href="http://marc.info/?l=linux-kernel&m=149394765324531&w=2">liked the
split</a>, but wanted to go even further:</p> 

<div class="BigQuote">
So I would still like to split that NO_JUMP flag even more.

I like the AT_BENEATH | AT_XDEV split, but I think XDEV should be
split further, and I think the symlink avoidance should be split more
too.
<p>
As mentioned last time, at least for the git usage, even relative
symlinks are a no-no - not because they'd escape, but simply because
git wants to see the *unique* name, and resolve relative symlinks to
either the symlink, or to the actual file it points to.

So I think that we'd want an additional flag that says "no symlinks at all".

And I think the "no mountpoint" traversal might be splittable too.
</div>

<p>Torvalds went on to say that, sometimes, the use case is just to
guarantee that
pathname resolution does not go above a certain point in the directory
tree, regardless of whether the directory walk crosses mount
points. However this should only be the case of non-bind mount points. Bind
mount points are basically views of directories (or files) that are mounted
in another place in the directory tree. Since bind mounts can be used to
break the directory containment, they should not be allowed. However from
the system's point of view, there is no difference between a mounted
filesystem and a bind-mounted directory, and thus Torvalds is not sure if
it a mount point can be tested if it is a bind mount or not. Viro <a
href="http://marc.info/?l=linux-api&m=149395326325891&w=2">agreed</a> that
it wasn't testable, and thus cannot be handled as a special case.</p> 

<p>Viro then proposed that the flags become <tt>AT_BENEATH</tt>,
<tt>AT_XDEV</tt>, and <tt>AT_NO_SYMLINKS</tt>, which is the flag used when
no symbolic links are allowed at all. This proposal raises a few questions
on how to handle some of the combinations of these three
flags. Viro asked  what <tt>AT_XDEV</tt> should do
with absolute symbolic links. Torvalds <a
href="http://marc.info/?l=linux-api&m=149395688726538&w=2">replied</a> that,
while it might be more consistent to allow an absolute symbolic link to be
traversed with <tt>AT_XDEV</tt> (but without <tt>AT_BENEATH</tt>) as long
as the root directory is on the 
same mount point as the starting point, it would be more straightforward to
just return <tt>-EXDEV</tt> on all absolute symbolic links. 

<p>Next, if the apparently conflicting flags <tt>AT_BENEATH</tt> (which
allows symbolic links) and <tt>AT_NO_SYMLINKS</tt> (which disallows all
symbolic links) are invoked simultaneously, Viro suggested that
<tt>AT_NO_SYMLINKS</tt> take precedence since it was convenient to
implement, to which Torvalds agreed.</p> 

<p>Finally, Viro asked what should happen when the final component
of a pathname is a symbolic link when <tt>AT_NO_SYMLINKS</tt> is
applied. Torvalds thinks it should be an error if the symbolic link is
followed, except if paired with <tt>AT_SYMLINK_NOFOLLOW</tt>, which
indicates that the user is fine with a "dangling symlink" at the end, which
will not be followed.</p> 

<p>If Viro's proposed changes are picked up in the mainline kernel, we
should see more robust directory containment options in the Linux API,
which application writers can in turn use for file I/O. Since the pathname
traversal protection mechanism will be in the kernel, there will no longer
be a need for each user program to do its own pathname checking.
This should be a welcome
feature for anyone writing applications that work with file and directory
names as user input.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Virtual_filesystem_layer">Filesystems/Virtual filesystem layer</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Filesystems">Linux kernel/Filesystems</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Hussein_Nur">Hussein, Nur</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/723057/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor723124"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2017 23:33 UTC (Wed)
                               by <b>jra</b> (subscriber, #55261)
                              [<a href="/Articles/723124/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cautiously optimistic - this could be very useful for Samba and other userspace file servers !<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723124/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723125"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2017 23:47 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723125/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With a caveat: application authors should consider that every time they use any of these flags, they are restricting administration flexibility and ruining techniques that sysadmins have used for many decades. Most seriously, mounting in extra disk space where needed on a full filesystem breaks, where right now you can bind-mount or NFS-mount or whatever you want to get more space in there. Tools to manage locally-built software that use symlinks extensively like stow, graft, and DEPOT might break (though one would assume that programs wouldn't use this facility for looking up parts of themselves, but mostly stuff under $HOME etc -- but even then, that's an *assumption*, and God knows what application authors who don't consider or know about such cases will do).<br>
<p>
Frankly I think this stuff should be controllable via a (root-only?) prctl() or /proc flag or something, so that it can be flipped off when it's being used wrongly and breaking legitimate use cases. We don't want to end up with a Windows-like world in which mountpoints look just like directories to applications except when the application decides they don't, and you can't tell it otherwise. The inability to rmdir() them is bad enough (and why isn't rmdir() of a mountpoint with no content just like umount() anyway?).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723125/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723142"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2017 5:59 UTC (Thu)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/723142/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The ability to mount stuff at any point in the filesystem nowadays looks like a bit of a misdesign.  It would be better if all mounts appeared only under /mnt (or perhaps ~/mnt if you allow ordinary users to mount filesystems) and then can be symlinked as necessary.  Of course, original Unix didn't have symlinks, so the flexibility of mounting anywhere in the tree was needed, not least for having /usr on a separate filesystem.<br>
<p>
I agree, arbitrary rules that stop following symlinks are annoying and I turn them off, but I understand that they do block whole classes of attack.  Safe path traversal without going 'up' is certainly a useful thing to have and will simplify logic in many applications, even simple ones like tar(1).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723142/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723157"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2017 9:35 UTC (Thu)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/723157/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  The ability to mount stuff at any point in the filesystem nowadays looks like a bit of a misdesign. </font><br>
<p>
Actually this is the best feature of UNIX.<br>
<p>
Mountpoint security is simple: you can only access a mount point it you have access to the parent directory, and creating mountpoint is a priviledged operation.<br>
<p>
By contrast symlink are much more messy: creating symlink is unpriviledged, symlink have no permission by themselves and does not prevent the target to be accessed through a different pass.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723157/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor723159"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2017 9:49 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723159/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Symlinks don't always cut it -- again, because applications can easily tell they are not directories, and can refuse to traverse them. I have a number of cases where I *had* to use an fs mount because nothing else would work. Your solution breaks real programs.<br>
<p>
Another use case for bind mounts being near-invisible to applications, from just this month. I have a system with disks mostly devoted to a bcached, journalled spinning-rust RAID-6 array, but it's bcached onto an SSD that is not really rated for massive write loads, so I'd prefer only to write stuff to the journal that I'm going to read again, and read more than once. That means that I don't want object files from autobuilders on there, nor really video storage, most certainly not half-terabyte uncompressed video intermediates, etc or QEMU disk images I plan to use twice with a reboot in the middle, etc. I could put the things on a tmpfs but when you build real monsters like LibreOffice or Chromium you need really rather a lot of RAM or swap for that to not run you short (and the QEMU disk images can be bigger yet).<br>
<p>
So I turned the first quarter-terabyte of each disk in the array (1.25TiB in total) into a "transient store": an uncached RAID-0 with an unjournalled ext4 fs on it. As you'd expect of a RAID-0 array made of the fast front portion of individual disks clocking 240MiB/s each, this is blisteringly fast. It's mounted on /.transient and contains only directories that represent transient mounts, with a file /.transient/.transient giving the names of each mountpoint: each directory is named after the SHA-256 of the mountpoint name, and has an accompanying dotfile with the same SHA-256 name after the dot giving its original mountpoint name again (letting me easily build /.transient/.transient whenever I add or remove a mount, just by catting all those dotfiles together).<br>
<p>
There are scripts to create and remove transient mounts, but after those have run *nothing notices* that their objdir or whatever is actually on a different filesystem and not using up SSD lifetime. They could tell, of course, by comparing statfs() output or struct stat.st_dev, but that would take extra work and nobody does it. If they were symlinks it would be much easier to tell.<br>
<p>
Bind mounts are really *useful* here -- at boot, we mount the fs (fscking it if needed, *remkfsing* it if that fails, because this is a *transient* filesystem and I don't much care if I lose everything on it, though I'd rather keep it if necessary), cat /.transient/.transient to get the targets of the mountpoints (their names are one SHA away) then bind-mount everything into place, so from my perspective all this machinery is almost invisible: it just happens at boot. I was thinking "I have to buy Al Viro a drink" after hacking this up. It works amazingly well and with almost no effort, and it took less than half an hour to write, and it's all down to bind mounts.<br>
<p>
If people start using AT_XDEV liberally, or frankly using it at all for anything not utterly crucial, this use case too collapses, since it absolutely depends on things routinely traversing mount points without noticing: every user of a transient fs does it at least once. I frankly cannot see any case other than things like backup software or rsync where the program should know or care that it's traversing mount points: only root can create them (a restriction I'd rather was lifted, but is helpful here), what does the application think it's doing second-guessing the admin's decisions? I'm damn sure that if this happens to me even once or twice I'm going to be stubbing AT_XDEV out completely. An application that second-guesses and prohibits admin decisions -- and that's what AT_XDEV is doing -- is an insulting application. If it provides a way to turn that behaviour off, fine, but how many applications do you think will bother? That's extra work! Samba will, obviously, but other things?<br>
<p>
In particular, Jeremy's example, userspace file servers: mounting extra storage into place so you don't have to reconfigure your clients is *exactly* the sort of thing a userspace file server's admin might find useful, but it won't work if the fileserver is using AT_XDEV, even though you could move the entire thing it was using onto a big enough fs (if you had one!) and it would suddenly start working again: what's the sense in *those* semantics? (Userspace fileservers *are* one case where AT_NO_JUMPS is likely to be desirable: it's useful for building jails at points other than / without chrooting. However, even there, it seems to me this is a process attribute too -- something you will often want such programs to do, but not always, i.e. only when both some prctl() or /proc flag *and* AT_NO_JUMPS are turned on. Sometimes the sysadmin will actually want a symlink farm, and the application should not be allowed to gainsay her.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723159/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723346"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2017 5:26 UTC (Sat)
                               by <b>linuxrocks123</b> (guest, #34648)
                              [<a href="/Articles/723346/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If it comes to it, you should be able to write a .so that intercepts any calls to the glibc functions using these flags and manually takes them out, then LD_PRELOAD that .so when running a problem application.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723346/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2017 11:44 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723356/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's almost as easy just to hack the kernel to add a prctl() (inherited across fork() and exec()) to dike out AT_NO_JUMPS and/or AT_XDEV. With that in place, an exec()ing wrapper is all that's needed.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor723827"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2017 22:56 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/723827/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; In particular, Jeremy's example, userspace file servers: mounting extra storage into place so you don't have to reconfigure your clients is *exactly* the sort of thing a userspace file server's admin might find useful,</font><br>
<p>
My moan with samba, though, is this seems to be a server-level option, not a share-level option. I have a lot of symlinks in home directories, and I have symlink traversal in samba disabled by default. I would like to enable it for CERTAIN SHARES ONLY, but that doesn't seem to be an option :-(<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723827/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor723254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why isn't rmdir of a mountpoint just like umount?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 0:46 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/723254/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
History and the general caution of breaking applications.<br>
<p>
You can  can remove a directory a mount is on and it does work, but you have to be in a mount namespace where that directory is not a mountpoint.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723259"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why isn't rmdir of a mountpoint just like umount?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 3:24 UTC (Fri)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/723259/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I saw that once, heh. It was one of those very surprising things when the mount failed after reboot, because its mount point was gone.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723259/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor723162"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2017 9:50 UTC (Thu)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723162/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm trying to figure out what it means if an application uses an absolute path with AT_XDEV (without AT_NO_JUMPS). It's bad enough with AT_NO_JUMPS because it's likely there are symlinks on the fs somewhere, quite possibly symlinks to directories, but use of AT_XDEV suddenly means that you have a program that works on the developer's default-configured RH box (with one big / fs and not much else) but not on production systems with more filesystems, because if there are mount points *anywhere* that app will fail when it tries to look into them.<br>
<p>
I can hear the vendor of crapware who decided to use AT_XDEV everywhere for "security" or "speed" now: "no, we only support one big filesystem". Of course they won't fix it, they'll just make excuses, and the only reason they'd bother to do this is because AT_XDEV makes rarely-sensible behaviour so easy to do.<br>
<p>
This is *exactly* the problem we see on Windows systems that only allow you to install to C:, and MS just went through hell trying to fake things out so applications thought they were installing to C: even though they aren't. Do we really want to bring the same problem to Linux?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723162/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor723255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 1:17 UTC (Fri)
                               by <b>mattrose</b> (guest, #19610)
                              [<a href="/Articles/723255/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So, AT_BENEATH would check for absolute pathnames (beginning with "/") and check for leading ".." but allow "a/b/../c" because not allowing .. is insane?<br>
But the reason that most of these checks disallow ".." anywhere in the pathname is so that you can't break out of the restriction by doing "a/../../../etc/passwd"<br>
<p>
I didn't read the patches, but I assume it has some other way of detecting that, but if not that seems like an obvious shortfall<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723330"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 21:11 UTC (Fri)
                               by <b>ssmith32</b> (subscriber, #72404)
                              [<a href="/Articles/723330/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I skimmed the article first and thought the same, but then read it more closely, and, no, you can't break out like that:<br>
<p>
"Viro's proposed flag (initially called AT_NO_JUMPS) for the ..at() calls would restrict the directory traversal of those calls to the same subtree as the starting point"<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723330/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor723340"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2017 3:40 UTC (Sat)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/723340/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Among the prohibited things there's this: "traversal of .. in the starting point of pathname resolution".  So your a/../../&lt;whatever&gt; will start at some directory, traverse the first component and go into subdirectory named "a", traverse the first ".." and go back to the starting point, then try to traverse the second ".." and run afoul of that restriction.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723340/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor723256"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 2:07 UTC (Fri)
                               by <b>helsleym</b> (guest, #92730)
                              [<a href="/Articles/723256/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What if, instead of a simple flag there was a numeric limit? For example at most &lt;limit&gt; mount points could be traversed if userspace takes the following steps:<br>
0) Optionally use fcntl() to set the F_AT_XDEV_LIMIT (default: 0) on the fd that will be used in *at() calls.<br>
1) Call *at() and pass an AT_LIMIT_XDEV flag to enforce the limit.<br>
<p>
bikeshed paint: Not a fan of the name AT_NO_XDEV -- why not XMNT instead of XDEV to better reflect the semantics?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723256/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723279"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 11:09 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723279/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because -xdev is what find(1) uses, and every other command to speak of that spells it using more than one letter.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723279/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723325"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 19, 2017 18:16 UTC (Fri)
                               by <b>mbunkus</b> (subscriber, #87248)
                              [<a href="/Articles/723325/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Both tar and rsync use "--one-file-system", not "-(-)xdev". Not that "one file system" is any more correct than "do not cross devices" if you consider bind mounts, of course.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723325/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723353"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2017 9:17 UTC (Sat)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/723353/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
rm also uses "--one-file-system"<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723353/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor723395"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2017 11:34 UTC (Sun)
                               by <b>smcv</b> (subscriber, #53363)
                              [<a href="/Articles/723395/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps a more compelling argument (than the existence of find -xdev) for XDEV over something longer is that the POSIX-standardized error raised by syscalls like link() that already can't work across mounts is EXDEV.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723395/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor723622"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2017 4:15 UTC (Wed)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/723622/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I've actually implemented something like this in Go (and Docker has a similar implementation), and am trying to get it into the standard library (though it has semantics more similar to chroot(2) when it comes to symlinks and absolute links)[1]. It is used heavily by Docker and other container runtimes in order to make it safe for a management process outside of a container to mutate a container root filesystem.<br>
<p>
I'm not convinced that the API described is all that useful for the usecases I would want to use it in. I feel like we need to make it possible to scope resolution in a more sane way than "just use chroot(2)" -- which doesn't work for unprivileged users for example. Though ultimately I'm sort of on the fence whether this should be done in the kernel.<br>
<p>
[1]: <a href="https://github.com/cyphar/filepath-securejoin">https://github.com/cyphar/filepath-securejoin</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723622/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor723971"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Restricting pathname resolution with AT_NO_JUMPS</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2017 0:59 UTC (Sat)
                               by <b>kmeyer</b> (subscriber, #50720)
                              [<a href="/Articles/723971/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Viro commented that, unlike O_BENEATH, AT_NO_JUMPS does allow relative symbolic links, which he thinks is the saner option:</font><br>
<p>
<font class="QuotedText">&gt; It's not quite O_BENEATH, and IMO it's saner that way - a/b/c/../d is bloody well allowed, and so are relative symlinks that do not lead out of the subtree.</font><br>
<p>
For what it's worth, Capsicum (as implemented in FreeBSD) allows ".." and relative symlinks that don't lead out of the directory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723971/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2017, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
