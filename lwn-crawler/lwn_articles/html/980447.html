        <!DOCTYPE html>
        <html lang="en">
        <head><title>Another try for getrandom() in the vDSO [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/980447/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/980655/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/980447/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Another try for getrandom() in the vDSO</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>July 4, 2024</br>
           </div>
Random numbers, it seems, can never be random enough, and they cannot be
generated quickly enough.  The kernel's <a
href="https://man7.org/linux/man-pages/man2/getrandom.2.html"><tt>getrandom()</tt></a>
system call might, after years of discussion, be seen as sufficiently
secure by most users, but it is still a system call.  Linux system calls
are relatively fast, but they are necessarily slower than calling a
function directly.  In an attempt to speed the provision of secure random
data to user space, Jason Donenfeld has put together <a
href="/ml/all/20240703183115.1075219-1-Jason@zx2c4.com">an
implementation of <tt>getrandom()</tt></a> that lives in the <a
href="https://man7.org/linux/man-pages/man7/vdso.7.html">virtual dynamic
shared object (vDSO) area</a>.
<p>
Random data is used in no end of applications, including modeling of
natural phenomena, generation of identifiers like <a
href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUIDs</a>,
and game play; it's how <a href="https://www.nethack.org/">NetHack</a>
somehow summons those three balrogs all in one corner of a dark room.
Security-related operations, such as the generation of nonces and keys,
also make heavy use of random data — and depend heavily on that data
actually being random.  Some applications need so much random data that
they spend a significant amount of time in the <tt>getrandom()</tt> system
call.
<p>
One possible solution to this problem is to generate random numbers in user
space, perhaps seeded by random data from the kernel; many developers have
taken that route over the years.  But, as Donenfeld
explains in the cover letter to his patch series, that approach is not
ideal.  The kernel has the best view of the amount of entropy in the system
and what is needed to generate truly random data.  It is also aware of
events, such as virtual-machine forks, that can compromise a random-number
generator and make a reseeding necessary.  He concluded:
<p>
<blockquote class="bq">
	The simplest statement you could make is that userspace RNGs that
	expand a getrandom() seed at some point T1 are nearly always
	*worse*, in some way, than just calling getrandom() every time a
	random number is desired.
</blockquote>
<p>
Always calling <tt>getrandom()</tt> ensures the best random data, but the
associated performance problem remains.  Moving that function into the vDSO
can help to address that problem.

<!-- middle-ad -->
<p>
<h4><tt>getrandom()</tt> in the vDSO</h4>
<p>
The vDSO is a special mechanism provided to accelerate tasks that require
some kernel involvement, but which can otherwise be carried out just as
well in user space.  It contains code and data provided in user space
directly by the kernel in a memory area mapped into every thread's
address space.  The classic vDSO function is <a
href="https://man7.org/linux/man-pages/man2/gettimeofday.2.html"><tt>gettimeofday()</tt></a>,
which returns the current system time as kept by the kernel.  This function
can be implemented as a system call, but that will slow down applications
that frequently query the time, of which there are many.  So the Linux vDSO
includes an implementation of <tt>gettimeofday()</tt>; that implementation
can simply read a time variable in memory shared with the kernel and return
it to the caller, avoiding the need to make a system call.
<p>
<tt>getrandom()</tt> is a similar sort of function; it reads data from the
kernel and returns it to user space.  So a vDSO implementation of
<tt>getrandom()</tt> might make sense.  Such an implementation must be done
carefully, though; it should return data that is just as random as a direct
call into the kernel would, and it must be robust against the types of
events (a fork, for example) that could compromise the state of a thread's
random-number generation.
<p>
In Donenfeld's implementation, user-space programs will continue to just
call <tt>getrandom()</tt> as usual, with no changes needed.  Under the
hood, though, there are some significant changes needed within the C
library, which provides the <tt>getrandom()</tt> wrapper for the system
call.
<p>
<h4>State-area allocation</h4>
<p>
The random-number generator works on some state data stored in memory.
When random data is needed, a pseudo-random-number generator creates it
from that state, mutating the state in the process.  Every thread must have
its own state, and care must be taken to avoid exposing that state during
events like process forks, core dumps, virtual-machine forks, or
checkpointing.  That state should be reseeded with random data regularly,
and specifically at any time when its content might have been compromised.
<p>
The vDSO implementation of <tt>getrandom()</tt> requires that the memory to
be used for this state be allocated by the kernel.  So the first thing that
the C library must do is to allocate this state storage for as many threads
as it thinks are likely to run.  That is done with a new system call:
<p>
<pre>
    struct vgetrandom_alloc_args {
        u64 flags;
      	u64 num;
      	u64 size_per_each;
      	u64 bytes_allocated;
    };

    void *vgetrandom_alloc(struct vgetrandom_alloc_args *args, size_t args_len);
</pre>
<p>
The structure pointed to by <tt>args</tt> describes the allocation request,
while <tt>args_len</tt> is <tt>sizeof(*args)</tt>; that allows the
structure to be extended in a compatible way if needed in the future.
Within that structure, <tt>flags</tt> must currently be zero, and
<tt>num</tt> is the number of thread-state areas that the kernel is being
requested to allocate.  On a successful return, <tt>num</tt> will be set to
the number of areas actually allocated, <tt>size_per_each</tt> describes
the size of a state area, and <tt>bytes_allocated</tt> is the total amount
of memory that was allocated.  The return value will point to the base of
the allocated area.
<p>
The allocated area is ordinary anonymous memory, except that it will be
specially marked within the kernel using a number of virtual-memory-area
flags.  The <tt>VM_WIPEONFORK</tt> flag causes its contents to be zeroed if
the process forks (so that the two processes do not generate the same
stream of random numbers), <tt>VM_DONTDUMP</tt> keeps its contents from
being written to core dumps, and <tt>VM_NORESERVE</tt> causes it to not be
charged against the process's locked-memory limit.  Donenfeld also added a
new flag to use with this area: <tt>VM_DROPPABLE</tt> allows the
memory-management subsystem to simply reclaim the memory if need be; since
this is anonymous memory, accessing it after it is reclaimed will cause a
new, zero-filled page to be allocated.  The result is memory that should
remain private, but which can be zeroed (or reclaimed, which has the same
effect) by the kernel at any time.
<p>
<h4>Generating random data</h4>
<p>
The kernel also shares some memory with the vDSO containing this structure:
<p>
<pre>
    struct vdso_rng_data {
	u64	generation;
	u8	is_ready;
    };
</pre>
<p>
This structure is used by the vDSO version of <tt>getrandom()</tt>, which
has this prototype:
<p>
<pre>
    ssize_t vgetrandom(void *buffer, size_t len, unsigned int flags,
                       void *opaque_state, size_t opaque_len);
</pre>
<p>
The first three arguments mirror <tt>getrandom()</tt>, describing the
amount of random data needed and whether the call should block waiting for
the kernel's random-number generator to be ready.  The final two, instead,
describe one of the state areas allocated by <tt>vgetrandom_alloc()</tt>.
This function's job is to provide the same behavior that
<tt>getrandom()</tt> would.
<p>
It starts by looking at the <tt>is_ready</tt> field in the shared
structure; if the kernel's random-number generator is not yet ready,
<tt>vgetrandom()</tt> will just call <tt>getrandom()</tt> to handle the
request.  Once the random-number generator has initialized, though, that
fallback will no longer be necessary.  So the next thing to do is to
compare the <tt>generation</tt> count (which tracks the number of times
that the kernel's random-number generator has been reseeded) with a
generation count stored in the state area.  If the two don't match, then
the state area must be reseeded with random data obtained from the kernel.
<p>
When the state area is first allocated, it is zeroed, so the generation
number found there will be zero, which will never match the kernel's
generation number; that will cause the state area to be seeded on the first
call to <tt>vgetrandom()</tt>.  The same thing will happen if this area has
been cleared by the kernel, as the result of a fork
(<tt>VM_WIPEONFORK</tt>) or the memory being reclaimed
(<tt>VM_DROPPABLE</tt>), for example.  So the kernel is able to clear that
memory at any time in the knowledge that <tt>vgetrandom()</tt> will do the
right thing.
<p>
Once the state area is known to be in a good condition,
<tt>vgetrandom()</tt> uses it to generate the requested random data using
the same algorithm used within the kernel itself.  Doing this calculation
securely is a bit tricky; if the process forks or core-dumps while it is
underway, any data kept on the stack could be exposed.  So
<tt>vgetrandom()</tt> has to use an implementation of the <a
href="https://datatracker.ietf.org/doc/html/rfc7539">ChaCha20 stream
cipher</a> that uses no stack at all.  The patch series only includes an
x86 implementation of this cipher; other architectures seem certain to
follow. 
<p>
As a final step before returning the generated data to the caller,
<tt>vgetrandom()</tt> checks the generation number one more time.  If, for
example, the state area was wiped by the kernel while the call was
executing, the generation-number check will fail.  In such cases,
<tt>vgetrandom()</tt> will throw away its work and start over.
<p>
Donenfeld described the end result of this work as "<q>pretty stellar
(around 15x for uint32_t generation)</q>" and noted happily that "<q>it
seems to be working</q>".
<p>
<h4>Prospects</h4>
<p>
LWN last <a href="/Articles/919008/">looked at this work</a> at the
beginning of 2023.  At that time, there were a number of objections, many
of which were focused on the <tt>VM_DROPPABLE</tt> changes to the
memory-management subsystem, which included some tricky, x86-specific
tricks.  When <a
href="/ml/linux-kernel/20240521111958.2384173-1-Jason@zx2c4.com/">version&nbsp;15</a>
of the patch series was posted several months later, <tt>VM_DROPPABLE</tt>
remained, but the logic had been simplified considerably in the hope of
addressing those concerns, seemingly successfully.  There does not appear
to be anybody who is arguing against the inclusion of this series now.
<p>
As of the current version (20), this work has been added to linux-next for
wider testing; if all goes well, it could go upstream as soon as the 6.11
merge window later this month.  "If all goes well", of course, includes
passing muster with Linus Torvalds, who has not commented this time around;
he was <a
href="/ml/linux-kernel/CAHk-=wg_6Uhkjy12Vq_hN6rQqGRP2nE15rkgiAo6Qay5aOeigg@mail.gmail.com/">not
thrilled</a> with previous versions, though.  Should the mainline merge
happen, the work to integrate the needed changes into the C libraries can
begin.  The end result will be a significant internal change, but the only
thing that users should notice is that their programs run faster.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Random_numbers">Random numbers</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Random_number_generation">Security/Random number generation</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/980447/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor980774"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linus commenting....</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2024 19:38 UTC (Thu)
                               by <b>knewt</b> (subscriber, #32124)
                              [<a href="/Articles/980774/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Funnily enough, Linus started commenting on it less than an hour after this article was posted 😂<br>
<p>
The "deconflicting new syscall numbers for 6.11" thread on lkml: <a href="https://lore.kernel.org/lkml/CAHk-=wiGk+1eNy4Vk6QsEgM=Ru3jE40qrDwgq_CSKgqwLgMdRg@mail.gmail.com/">https://lore.kernel.org/lkml/CAHk-=wiGk+1eNy4Vk6QsEgM=Ru3...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980774/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980808"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linus commenting....</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 8:51 UTC (Fri)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/980808/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus disagrees with vgetrandom_alloc() syscall. He seems to be suggesting, instead, exposing VM_DROPPABLE as a new mmap() flag, MAP_DROPPABLE, so anyone can use it, not just vgetrandom.<br>
<p>
<a href="https://lore.kernel.org/all/CAHk-=win2mesMNEfL-KZQ_jk1YH8N8dL9r=7XOLp28_WMazpVg@mail.gmail.com/">https://lore.kernel.org/all/CAHk-=win2mesMNEfL-KZQ_jk1YH8...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980808/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor980776"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2024 19:54 UTC (Thu)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/980776/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;virtual-machine forks, that can compromise a random-number generator and make a reseeding necessary</span><br>
<p>
Wouldn't it be better to make fork information more easily available to userspace?<br>
A userspace RNG could react on it and it could potentially have more uses beyond RNG.<br>
<p>
This all sounds like it should be solved at a lower level.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980776/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980783"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2024 22:12 UTC (Thu)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/980783/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That was proposed and implemented (and even almost merged) several times in several different forms, but always rejected by the random maintainer:<br>
<p>
<a href="https://lore.kernel.org/lkml/e1c03136-b873-1f1d-8b06-d9186566fc0c@amazon.es/T/">https://lore.kernel.org/lkml/e1c03136-b873-1f1d-8b06-d918...</a><br>
<a href="https://lore.kernel.org/lkml/e09ce9fd-14cb-47aa-a22d-d295e466fbb4@amazon.com/">https://lore.kernel.org/lkml/e09ce9fd-14cb-47aa-a22d-d295...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980783/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 4:49 UTC (Fri)
                               by <b>donald.buczek</b> (subscriber, #112892)
                              [<a href="/Articles/980797/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OMG, this is really sad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980895"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 15:24 UTC (Fri)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/980895/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Especially because it seems like they moved their proposal entirely out of random's purvue since they're not tracking reseeds but an entirely different and specific event, so I don't see why the NACK from random matters when it's no longer integrating with their subsystem?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980895/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980897"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 15:29 UTC (Fri)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/980897/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Those are excellent questions. The issue is that the random subsystem maintainer also happens to the vmgenid acpi driver maintainer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980897/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980899"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 15:32 UTC (Fri)
                               by <b>bluca</b> (subscriber, #118303)
                              [<a href="/Articles/980899/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is a very sad situation indeed, especially because in the end, even though it could be really trivially fixed, the result is that from that point of view, Windows works better as a VM guest than Linux.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980899/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor980815"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Make vm fork information available instead?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 10:53 UTC (Fri)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/980815/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
MADV_WIPEONFORK was added to Linux 4.14: <a href="https://www.man7.org/linux/man-pages/man2/madvise.2.html">https://www.man7.org/linux/man-pages/man2/madvise.2.html</a><br>
<p>
It does not cover VM forks, though. People disagree whether this is a problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980815/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor980785"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2024 22:39 UTC (Thu)
                               by <b>comex</b> (subscriber, #71521)
                              [<a href="/Articles/980785/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I still don’t understand how this design allows programs to be truly safe in the face of VM cloning.  Sure, with kernel support you can fix things up if the clone happens before or during the call to getrandom().  But what if it happens right after?  When the program has gotten some random bytes but has yet to do anything with them?<br>
<p>
I suppose it’s enough for some cases.  Suppose you need to sign a message with a cryptographic scheme that requires a random nonce, where it’s very bad to sign two messages with the same (or perhaps related) nonce.  Then you can ensure that your code generates the nonce with a single call to getrandom(), *after* reading in or otherwise determining the message to be signed. If the VM forks before or during the call to getrandom(), you’ll get a fresh new nonce (theoretically).  If it forks after, then you’ll get the same nonce, but it’ll be used to sign the same message, which isn’t (necessarily) insecure.<br>
<p>
But what about more complex protocols, particularly interactive ones (e.g. TLS)?  Is a single call to getrandom() a flexible enough API?  It feels like programs need a way to say “abort this connection if a VM fork has happened at any time since the connection started”.  Perhaps even something that’s atomic with send() somehow.<br>
<p>
Disclaimer: Not a cryptography expert.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980785/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980787"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 4, 2024 23:56 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/980787/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In general, uses of vmfork that care about security are forking at request time, not at some random time in the middle.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980787/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 4:17 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/980794/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Personally, I'm unclear on how a mid-request fork would even function. Both parent and child VMs are (presumably) going to be trying to talk to the remote host at the same time. If your guests have distinct public IP addresses, then at least one of the two connections should break right there. If not, then you'd have interleaved TCP streams with duplicate sequence numbers, and the whole thing should fall apart pretty quickly.<br>
<p>
The only case I can think of where this could possibly work is when the application is in cahoots with the VM management plane and intentionally causes VM forks to occur as part of its request handling logic. But in that case, this is trivial: At worst, you have to design your request handling logic to ensure that the fork does not happen at the same time as some delicate crypto code is running (e.g. take a lock). Which you were maybe already doing anyway, since some code in this genre uses a userspace CSPRNG instead of getrandom (for the performance reasons cited in the article), and that absolutely requires you to be aware of forking and mitigate it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980800"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 5:51 UTC (Fri)
                               by <b>comex</b> (subscriber, #71521)
                              [<a href="/Articles/980800/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
When I mentioned TLS, I was imagining a scenario where the VM just happens to fork while some software on it is coincidentally in the middle of a TLS connection, and meanwhile there is an on-path network attacker specifically waiting for it to fork, with a custom TCP implementation designed to paper over the broken sequencing.<br>
<p>
As for why the VM forks in the first place, well, as one possibility, it could be a desktop VM which the user manually chose to fork (while some service was talking to the network in the background).  Some desktop VM software offers cloning as an option.  Or even without cloning, the risks seem similar if the VM is just restored from a snapshot.<br>
<p>
Admittedly, waiting for a desktop VM to be forked/restored seems like a pretty niche thing for an attacker to do, but not completely unrealistic.  I'm sure there are people who make a habit of regularly restoring their VMs from snapshot.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980800/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980930"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 20:28 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/980930/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; When I mentioned TLS, I was imagining a scenario where the VM just happens to fork while some software on it is coincidentally in the middle of a TLS connection, and meanwhile there is an on-path network attacker specifically waiting for it to fork, with a custom TCP implementation designed to paper over the broken sequencing.</span><br>
<p>
That would require the application to be originally deployed in a broken state where it randomly drops TCP connections for no apparent reason. Maybe there are some people who do that, but I wouldn't want to work there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980930/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980931"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 20:43 UTC (Fri)
                               by <b>comex</b> (subscriber, #71521)
                              [<a href="/Articles/980931/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you're still envisioning a server.  That's definitely one possible scenario, but as I described in the rest of my comment, a simpler scenario is a desktop VM where the user is manually pausing the VM and either restoring it from snapshot or cloning it.  Yes, this normally drops TCP connections, but not for no apparent reason.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980931/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 23:28 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/980941/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Simpler, and far less common. The people running desktop VMs are mostly security researchers and a few power users and hobbyists. Especially if it's desktop *Linux*. In the real world, to a first approximation, a Linux VM is nearly always a cloud VM.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980942"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">End goal</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 23:31 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/980942/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
(Just in case I wasn't clear enough: Attackers usually want to compromise as many users as possible, so an attack that only affects a tiny fraction of the computer-using population is simply not worth developing. Especially when a significant portion of that tiny fraction is made up of security researchers, whom malware authors generally try to avoid hitting in order to further obfuscate their work.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980942/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor980798"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">droppable sounds great </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 5:00 UTC (Fri)
                               by <b>ringerc</b> (subscriber, #3071)
                              [<a href="/Articles/980798/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm actually more interested in VM_DROPPABLE than the randomness patch.<br>
<p>
That sounds like something that would be exceedingly handy for garbage collected languages' object reuse lists, various in-app caches, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980798/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">droppable sounds great </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 7:12 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/980801/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Also, when you have VM_DROPPABLE (and a generation counter in the VDSO) the rest can easily be implemented in libc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor980803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">droppable sounds great </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 8:15 UTC (Fri)
                               by <b>jtaylor</b> (subscriber, #91739)
                              [<a href="/Articles/980803/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
can't you do what you can do with VM_DROPPABLE already with madvise(MADV_FREE)?<br>
<p>
I'm not quite clear on the difference, I assume VM_DROPPABLE can have memory reset to zero on read at any time while MADV_FREE can only be zeroed after the madvise once?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980810"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">droppable sounds great </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 9:01 UTC (Fri)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/980810/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See this patch <a href="https://lore.kernel.org/linux-mm/20240703183115.1075219-2-Jason@zx2c4.com/T/">https://lore.kernel.org/linux-mm/20240703183115.1075219-2...</a><br>
<p>
The difference in semantics with MADV_FREE is explained in the comments on the last file in the patch (mm/rmap.c):<br>
<p>
1. "Unlike MADV_FREE mappings, VM_DROPPABLE ones can be dropped even if they've been dirtied."<br>
2. "Unlike MADV_FREE mappings, VM_DROPPABLE ones never get swap backed on failure to drop."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980810/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor980802"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Known number of threads - bad assumption?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 7:44 UTC (Fri)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/980802/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I imagine whoever wrote that requirement to specify the number of threads does not work on code bases outside of C where every library has its innards hanging out for everyone to see. How are you supposed to even know how many threads the overall program uses if you have proper encapsulation that does include thread use, possibly by indirect dependencies?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980802/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor980819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Known number of threads - bad assumption?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 11:28 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/980819/">Link</a>] 
      </p>
      
      </div>
      </summary>
      You can always allocate more space for more threads, so that should not be a problem.


      
          <div class="CommentReplyButton">
            <form action="/Articles/980819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor980816"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Not sure this solves more headaches than it creates</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 5, 2024 11:15 UTC (Fri)
                               by <b>neverpanic</b> (subscriber, #99747)
                              [<a href="/Articles/980816/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not convinced this actually solves more headaches than it creates. Yes, random number generation is kind of slow, and it would be great if cryptographic libraries could just point to getrandom() whenever they needed random numbers without being concerned that it is going to be slow.<br>
<p>
Linus' insists on actual users speaking up, but I'm convinced those do exist. Heck, we looked at the OpenSSL RNG setup and thought about ripping out their three-tiered primary-per-process and public/private-per-thread DRBG tree and just replacing it, or parts of it, with getrandom(). Now, we considered this because of FIPS certification and the requirements it imposes on chained DRBGs, all of which become much simpler if you just don't chain.<br>
<p>
But, and this brings me to the two points I want to make: Merging this patchset in Linux does not solve the issue of a slow RNG on other platforms, so cryptographic libraries with cross platform support (i.e., essentially all of them) will still keep a multi-level setup, seed from the kernel and then run a user space DRBG, or just continue accepting that they are slow. So yeah, it's great if this would exist, but anybody who takes this seriously and isn't just optimizing for a single platform already has to deal with this in user space anyway, so there really isn't as big of a gain as the author claims.<br>
<p>
And second, the author claims this would use the exact same DRBG algorithm as used by the kernel, but completely ignores that the kernel will use a different DRBG in FIPS mode (because ChaCha20 isn't FIPS-compliant). This is also the source of the headache I have with the proposal. What's currently in the kernel sort of works for us, but if this lands we need to take a closer look to either figure out how to use a CTR-DRBG in user space instead of the ChaCha20 one, plus fulfill the DRBG chaining requirements that NIST requires, or figure out a way to completely disable this.<br>
<p>
For these reasons, I don't think this should land. Just the generation counter that Linus' proposed, that sounds like a good improvement for user space to do the right thing™ on fork or VM cloning, but the rest of the stuff is possibly an improvement for the top 0.5% of cloud load balancers, and pointless for everybody else.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/980816/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor984420"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RFC 7539</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 2, 2024 19:48 UTC (Fri)
                               by <b>steve1440</b> (subscriber, #166333)
                              [<a href="/Articles/984420/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
RFC 7539 (ChaCha20 stream cipher link) has been obsoleted by RFC 8439.<br>
<a href="https://datatracker.ietf.org/doc/html/rfc8439">https://datatracker.ietf.org/doc/html/rfc8439</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/984420/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
