        <!DOCTYPE html>
        <html lang="en">
        <head><title>New system calls: pidfd_open() and close_range() [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/789023/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/789232/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/789023/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>New system calls: pidfd_open() and close_range()</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 23, 2019</br>
           </div>
The linux-kernel mailing list has recently seen more than the usual amount
of traffic proposing new system calls.  LWN is endeavoring to catch up with
that stream, starting with a couple of proposals for the management of file
descriptors.  <tt>pidfd_open()</tt> is a new way to create a "pidfd" file
descriptor that refers to a process in the system, while
<tt>close_range()</tt> is an efficient way to close many open descriptors
with a single call.
<p>
<h4>pidfd_open()</h4>
<p>
There has been <a href="/Articles/784831/">a fair amount of development
activity</a> around pidfds, which can be used to send signals to processes
without worries that the target process may die and be replaced by another
one using the same process ID.  The 5.2 merge window saw the addition of a
new <tt>CLONE_PIDFD</tt> flag to the <a
href="http://man7.org/linux/man-pages/man2/clone.2.html"><tt>clone()</tt></a>
system call.  If that flag is present, the kernel will return a pidfd
(referring to the newly created child) to
the parent by way of the <tt>ptid</tt> argument; that pidfd can then be
used to send signals to the child process at some future point.
<p>
There are times, though, when it is not possible to create a process in
this manner, but a management process would still like to get a pidfd for
another process.  Opening the target's <tt>/proc</tt> directory could work;
that was once the only way to get a pidfd for a process.  But the
<tt>/proc</tt> approach is apparently not usable in all situations.  On
some systems, <tt>/proc</tt> may not exist (or be accessible) at all.  For
situations like this, Christian Brauner has <a
href="/ml/linux-kernel/20190520155630.21684-1-christian@brauner.io/">brought
back an earlier proposal</a> for a new system call to create a pidfd:
<p>
<pre>
    int pidfd_open(pid_t pid, unsigned int flags);
</pre>
<p>
The target process is identified with <tt>pid</tt>; the <tt>flags</tt>
argument must be zero in the current proposal.  The return value will be a
pidfd corresponding to <tt>pid</tt>.  It's worth noting that there is a
possible race window here; <tt>pid</tt> could be recycled before
<tt>pidfd_open()</tt> runs.  That window is small in most normal usage,
though, and there are ways for the caller to check and ensure that the
process of interest is still running.
<p>
When <tt>pidfd_open()</tt> was proposed in the past, it would return a
different flavor of pidfd than would be obtained by opening <tt>/proc</tt>;
an <tt>ioctl()</tt> call was provided to convert between the two.  This
behavior was not particularly popular, and has been dropped; there is now
just a single type of pidfd, regardless of where it has been obtained.
<p>
The lack of <tt>pidfd_open()</tt> is, Brauner says, the main obstacle
keeping applications like Android's low-memory killer and systemd from using
pidfds for process management.  Once that has been resolved, "<q>they
intend to switch to this API for process supervision/management as soon as
possible</q>".  Comments on this system call have settled down to relatively
small implementation details, so it seems likely to go in during the 5.3
merge window.
<p>
<h4>close_range()</h4>
<p>
One possibly surprising <tt>pidfd_open()</tt> feature is that the pidfd it
creates has the <tt>O_CLOEXEC</tt> flag set automatically; that will cause
the descriptor to be automatically closed should the owning process call <a
href="http://man7.org/linux/man-pages/man2/execve.2.html"><tt>execve()</tt></a>
to run a new program.  This is a hardening feature, intended to prevent
open file descriptors from leaking into places where they were not intended
to be.  David Howells has recently <a
href="/ml/linux-kernel/155800752418.4037.9567789434648701032.stgit@warthog.procyon.org.uk/">proposed</a>
changing <a href="/Articles/759499/">the new filesystem mounting API</a> to
unconditionally set that flag as well.
<p>
This change evoked <a
href="/ml/linux-kernel/20190516162259.GB17978@ZenIV.linux.org.uk/">a
protest</a> from Al Viro, who does not feel that changing longstanding Unix
conventions is the right approach, especially since the behavior of
existing calls like <tt>open()</tt> cannot possibly change in this way.  
He later <a
href="/ml/linux-kernel/20190516165021.GD17978@ZenIV.linux.org.uk/">suggested</a>
that a <tt>close_range()</tt> system call might be a better way to ensure
that file descriptors are closed before calls like <tt>execve()</tt>.
Brauner duly <a
href="/ml/linux-kernel/20190521113448.20654-1-christian@brauner.io/">implemented
this idea</a> for consideration.  The new system call would be:
<p>
<pre>
    int close_range(unsigned int first, unsigned int last).
</pre>
<p>
A call to <tt>close_range()</tt> will close every open file descriptor from
<tt>first</tt> through <tt>last</tt>, inclusive.  Passing a number like
<tt>MAXINT</tt> for <tt>last</tt> will work and is the expected usage much
of the time.  Closing descriptors in the kernel this way, rather than in a
loop in user space, allows for a significant speedup; as Brauner put it,
"<q>the performance is striking</q>", even though there are clearly
ways in which the implementation could be made faster yet.
<p>
This API is rather less settled at this point.  Howells <a
href="/ml/linux-kernel/28114.1558456227@warthog.procyon.org.uk/">suggested</a>
something more like:
<p>
<pre>
    int close_from(unsigned int first);
</pre>
<p>
This variant would close all open descriptors starting with
<tt>first</tt>.  It seems that there are use cases, though, for leaving
some high-numbered file descriptors open, so this version would be less
useful.  Florian Weimer, instead, <a
href="/ml/linux-kernel/87tvdoau12.fsf@oldenburg2.str.redhat.com/">suggested</a>
looking at <a
href="https://docs.oracle.com/cd/E88353_01/html/E37843/closefrom-3c.html">the
Solaris <tt>closefrom()</tt> and <tt>fdwalk()</tt> functions</a> for
inspiration.  <tt>closefrom()</tt> is equivalent to Howells's
<tt>close_from()</tt>, while <tt>fdwalk()</tt> allows a process to iterate
through its open file descriptors.  Weimer said that if the kernel were to
implement a <tt>nextfd()</tt> system call to obtain the next open file
descriptor, both <tt>closefrom()</tt> and <tt>fdwalk()</tt> could be
implemented in the C library.
<p>
The value of these functions <a
href="/ml/linux-kernel/20190521130438.q3u4wvve7p6md6cm@brauner.io/">was not
clear</a> to Brauner, though.  In particular, <tt>fdwalk()</tt> appears to
be mostly needed on systems that lack information on open file descriptors
in <tt>/proc</tt>.  In the absence of a pressing need for
<tt>nextfd()</tt>, it is unlikely to be implemented, much less merged.  So,
unless some other proposal comes along and proves more interesting, a
future <tt>close_range()</tt>
implementation appears to be the most likely to find its way into a
mainline kernel release.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#pidfd">pidfd</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls">System calls</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/789023/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor789238"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 14:41 UTC (Thu)
                               by <b>dskoll</b> (subscriber, #1630)
                              [<a href="/Articles/789238/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <p>It would be handy if close_range took another argument of type <code>fd_set *</code> that contained a set of file descriptors you definitely want to keep open.  One use case is if a parent process opens a PID file and wants to keep it open in the child / grandchild for locking purposes.

<p>If you don't need this facility, just supply <code>NULL</code> where the <code>fd_set *</code> argument goes.
      
          <div class="CommentReplyButton">
            <form action="/Articles/789238/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789256"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:46 UTC (Thu)
                               by <b>ttuttle</b> (subscriber, #51118)
                              [<a href="/Articles/789256/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      Would it be possible to have <tt>close_set(fd_set* fds)</tt> instead/as well? (Or does that already exist?)
      
          <div class="CommentReplyButton">
            <form action="/Articles/789256/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789269"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 17:35 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/789269/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
close_set wouldn't be *substantially* faster than doing a series of close calls in userspace. It'd eliminate a bit of syscall overhead, but that alone doesn't seem worth it.<br>
<p>
The advantage of close_range is that the kernel knows which file descriptors the process has, so instead of userspace closing thousands of *possible* descriptors, the kernel can quickly close the handful of *actual* descriptors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789269/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 23:43 UTC (Thu)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789310/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This comes back to the question of "do you have /proc". Userspace can know what fds it has open by looking at /proc/self/fd. This is what rpm, zypper, and quite a few other programs do now (they used to loop over all possible file descriptors but it turns out this can be incredibly slow inside containers).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor794569"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2019 22:39 UTC (Wed)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/794569/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As I recall the problem with reading /proc/self/fd is that now you have to open a FD to know which FDs you can close.<br>
<p>
It might be that you're out of file descriptors, so you need to close one in order to open /proc/self/fd in order to know which file descriptors you can close. But how do you know which one to close?<br>
<p>
You could institute a rule like "always close the lowest numbered one that we aren't being asked to keep open". But that's not guaranteed to be an open file descriptor. Although FDs are usually small positive integers, they *could* be any positive integer up to 2^31. Will you loop through all descriptors up to 2^31, just so you can find one to close? (Worst case: the FD limit is 1, and the only FD that's open is 2^31-1).<br>
<p>
You might need to close more than one FD. IIRC it's possible to open, say, 1000 FDs, and then set the resource limit much lower than 1000, and the process will have to close enough FDs to get under the limit before it can open /proc/self/fd.<br>
<p>
There's also the possibility that /proc isn't mounted. It's not sensible that a filesystem should need to be mounted in order for a process to manage its own internal state.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794569/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789242"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 14:50 UTC (Thu)
                               by <b>brauner</b> (subscriber, #109349)
                              [<a href="/Articles/789242/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just for the sake of completeness, the seccomp notification fd retrieved via SECCOMP_RET_USER_NOTIF is also O_CLOEXEC by default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789242/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789240"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:02 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/789240/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That syscall prototype with the "unsigned int" used for fds looks like the kernel side prototype. In userspace fds are generally "int". (Isnt't it great that the Linux kernel side and userspace type disagree on such a fundamental type? Yay for Linux!). Hence I presume the MAXINT in the article should actually be a UINTMAX, i.e. the same as (unsigned int) -1...<br>
<p>
I must say, for all purposes I have in the codebases I care for (systemd…) the range thing is a bit weird though, usually we want to close everything but a few arbitrary fds, and then rearrange those fds to specific positions. But for that close_range() is not particularly useful, as it requires you to sort your list of fds to keep open first and then find all ranges between them. This means behaviour of closing everything is O(n*log(n)) (for the worst case where the fds to keep open are fully distributed over the entire range), for n being the number of fds to keep open. This is only marginally better than enumerating /proc/self/fd/ and closing everything found there, which is O(m) for m being the number of fds previously open. Marginally better since usually n ≪ m.<br>
<p>
I personally would much rather prefer a prototype like:<br>
<p>
int close_except(const int *fds, size_t n_fds);<br>
<p>
i.e. just specify the fds you want to keep open explicitly, regardless of order, trivially easily...<br>
<p>
And I think not only systemd would benefit from such a close_except() call, but also everything else that invokes something with fds set up in a special way, for example popen() and friends.<br>
<p>
Lennart<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789240/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789259"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 16:10 UTC (Thu)
                               by <b>tao</b> (subscriber, #17563)
                              [<a href="/Articles/789259/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, close_except() certainly seems like a more desirable behaviour.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789259/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 16:22 UTC (Thu)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/789261/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can't you rearrange before close instead of after? Say that you want fds 5, 26 and 4, and then close the rest:<br>
<p>
dup2(5, 0);<br>
dup2(26, 1);<br>
dup2(4, 2);<br>
close_range(3, MAXINT);<br>
<p>
(If you also wanted to keep e.g. 1, you would need some extra fiddling, but that goes for close_except(), too.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789354"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 12:49 UTC (Fri)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/789354/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, for stdin/stdout/stderr that'll work, but it falls apart if the fds you want to keep and maybe later rearrange are already in the range you want to rearrange them to... The socket activation protocol systemd implements (i.e. LISTEN_FDS=) supports large numbers of fds, and systemd might create them a long time before actually activating things, hence they likely are in the range we want to move fds to.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789354/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789357"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 12:53 UTC (Fri)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/789357/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
But that's still true even with your proposed close_except()?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789357/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789811"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 8:44 UTC (Thu)
                               by <b>mina86</b> (guest, #68442)
                              [<a href="/Articles/789811/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <pre>int close_except(int *fds_to_keep, size_t n) {
    qsort(fds_to_keep, n, sizeof *fds_to_keep, int_cmp);
    int fd = 0;
    for (size_t i = 0; i &lt; n; ++i)
        if (fds_to_keep[i] != fd) dup2(fds_to_keep[i], fd++);
    return close_range(fd, INT_MAX);
}</pre>
Handling of <code>EBADF</code> and <code>EINTR</code> left as exercise to the reader.
      
          <div class="CommentReplyButton">
            <form action="/Articles/789811/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 10:31 UTC (Thu)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/789817/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Handling of EBADF and EINTR left as exercise to the reader.</font><br>
<p>
And the important exercise is fixing the bug ;-). The fd's have to be moved back to their original value.<br>
<p>
Closing every fd I don't know about is only a band-aid to fix buggy software (own or 3rd part library). The correct solution is using CLOEXEC and is available for ages.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 10:49 UTC (Thu)
                               by <b>mina86</b> (guest, #68442)
                              [<a href="/Articles/789819/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; And the important exercise is fixing the bug ;-).  The fd's have to be moved back to their original value.</font><br>
<p>
Or start referring to the file descriptors by their new numbers (though even then the function lacks a way to communicate all the remappings) to save on bunch of syscalls.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor798687"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 7, 2019 17:59 UTC (Sat)
                               by <b>ceplm</b> (subscriber, #41334)
                              [<a href="/Articles/798687/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Closing every fd I don't know about is only a band-aid to fix buggy software (own or 3rd part library). The correct solution is using CLOEXEC and is available for ages.</font><br>
<p>
No, it is useful also for programs where the author doesn’t have full control. See <a href="https://bugs.python.org/issue11284">https://bugs.python.org/issue11284</a>. I could have switch all Python open() calls to use CLOEXEC (that’s essentially what happened in Python 3.2 as an implementation of <a href="https://www.python.org/dev/peps/pep-0446/">https://www.python.org/dev/peps/pep-0446/</a>), but it doesn’t save me from C extensions which just use open(2) with default values and create inheritable file descriptors on POSIX platforms.<br>
<p>
And walking through /proc/self/fd/ is horribly slow (think about FreeBSD’s MAXFD=655000), and mostly not async signal safe.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/798687/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor799200"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 14, 2019 20:54 UTC (Sat)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/799200/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are libraries (I have encountered one) opening a file-descriptor which has to remain open across exec to be used by the same library in (grand)child processes.<br>
<p>
Mangling with unknown resources is never good practice but maybe as I said: a band-aid to fix buggy software. The C extension of your example is such buggy software you are applying a band-aid to.<br>
<p>
I hope I never see close_range() in production-code. Using it is the confession one has given up on producing/using good software.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/799200/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789286"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 20:07 UTC (Thu)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/789286/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about having a open() flag that doesn't guarantee the lowest syscall number? That is also O(n) for no good reason.<br>
<p>
O_ANYFD<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789286/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789319"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 6:14 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/789319/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You mean the lowest FD number.<br>
<p>
Well, that's O(n) over a bitmap, plus there's a CPU instruction to find the first free bit, so the cost is reasonably low no matter how large N is. You could even cache the first free FD or two. I doubt that there'd be any measurable impact of O_ANYFD, esp. compared to the cost of looking up the target of the open().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789319/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789389"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 22:50 UTC (Fri)
                               by <b>dezgeg</b> (subscriber, #92243)
                              [<a href="/Articles/789389/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See <a href="https://lwn.net/Articles/787473/">https://lwn.net/Articles/787473/</a>, specifically this quote: "Jan Kara wondered if the file-descriptor table bouncing could be handled by allocating file descriptors in a way that causes separate threads to use different parts of the table. "<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789389/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789393"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 0:33 UTC (Sat)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/789393/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW, fcntl F_DUPFD (or F_DUPFD_CLOEXEC) can be used to get a higher descriptor: it returns a descriptor greater than equal to the fcntl argument. Not ideal because you have to open and close the original descriptor, but technically sufficient to implement your suggested interface. One still has to figure out what the highest descriptor is and ensuring contiguous allocation of related descriptors, but so too with O_ANYFD.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789393/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor789244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Double standards</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:06 UTC (Thu)
                               by <b>magfr</b> (subscriber, #16052)
                              [<a href="/Articles/789244/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is interesting that systems where /proc ain't accessible is a problem for open_pid() but not for nextfd() <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789246"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:10 UTC (Thu)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/789246/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Clearly there should be an API that takes an eBPF callback and queries it for each fd!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789246/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789368"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 15:05 UTC (Fri)
                               by <b>perennialmind</b> (guest, #45817)
                              [<a href="/Articles/789368/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>
Whether you were serious or not, <code>close_range</code> and <code>close_except</code> do share the familiar pattern "do thing <i>foo</i> on series <i>bar</i>". All these round-trip eliminating optimizations remind me of capnproto's "infinity times faster" tagline.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/789368/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789245"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:13 UTC (Thu)
                               by <b>magfr</b> (subscriber, #16052)
                              [<a href="/Articles/789245/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While a close_range or close_except certainly would be useful I think an O_CLOFORK flag to set on file descriptors would be even better as it would prevent the creation of all the fds in the child.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789245/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789248"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:19 UTC (Thu)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/789248/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That'd be unusable in a threaded environment, since if three threads want to use this and fork of different programs with different sets of fds they might end up turning off and on O_CLOFORK for each other interefering with each other.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789248/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 15:30 UTC (Thu)
                               by <b>magfr</b> (subscriber, #16052)
                              [<a href="/Articles/789250/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, threads and fork does not mix very well.<br>
For threaded use i suppose som monstrosity like CreateProcess that allows the caller to specify the file descriptors that should be duplicated is better.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789324"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 7:49 UTC (Fri)
                               by <b>maxfragg</b> (subscriber, #122266)
                              [<a href="/Articles/789324/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
well, for most of those cases, it can be solved without the kernel using something like pthread_atfork()<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789324/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789356"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 12:51 UTC (Fri)
                               by <b>mezcalero</b> (subscriber, #45103)
                              [<a href="/Articles/789356/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
pthread_atfork() is probably one of those concepts that are supposed to solve a problem, but when you use it you then have two problems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789356/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789395"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 1:16 UTC (Sat)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/789395/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Even POSIX admits pthread_atfork was a mistake. It explains the history and why it's broken in the RATIONALE section; for FUTURE DIRECTIONS it says:</p>
<pre><blockquote>The pthread_atfork() function may be formally deprecated (for example, by shading it OB) in a future version of this standard.</blockquote></pre>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789395/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor789258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 16:03 UTC (Thu)
                               by <b>sorokin</b> (guest, #88478)
                              [<a href="/Articles/789258/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What is the computation complexity of this close_range function? Is it linear from the number of opened descriptors in range or is it linear from the size of the range?<br>
<p>
If it is the latter it must be very inefficient for the processes with elevated limit of the number of possible file descriptors.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789322"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 7:03 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789322/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be O(#open_fds) given that files_struct has an open_fds bitmap that can be iterated over. This is what close_files() does already in the free path for put_files_struct().<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789322/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789416"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 20:00 UTC (Sat)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/789416/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Technically walking a bitmap is O(size of the bitmap); from the point of view of big-O notation it doesn't matter that the constant in front of it is much smaller than the cost of actually closing those few open file descriptors.<br>
<p>
However, walking the bitmap is for all purposes fast enough (a handful of instructions for 64 entries) that you can consider close_range to be linear in the number of file descriptors to be closed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789416/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789262"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 16:38 UTC (Thu)
                               by <b>ju3Ceemi</b> (subscriber, #102464)
                              [<a href="/Articles/789262/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not create a call to get a list of opened fd ?<br>
Using it, the userspace could do whatever it wants : filtering, closing some or others etc<br>
<p>
I suppose "Closing descriptors in a loop in user space is slower" because it basically bruteforce the whole fd-space, calling close() for every fd, even if there is none<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789262/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789309"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 23:40 UTC (Thu)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789309/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can already do this by looping over /proc/self/fd. This is what rpm, zypper, and quite a few other programs do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789309/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789379"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 17:27 UTC (Fri)
                               by <b>ju3Ceemi</b> (subscriber, #102464)
                              [<a href="/Articles/789379/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure, but one needs access to the procfs, which is the issue<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789379/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789427"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 23:06 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789427/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, it isn't the issue at all. We shouldn't optimize the kernel for random important kernel interfaces being disabled. Why should running without procfs be a supported configuration at all? Why are we even spending time on this bizarre usecase? We should just hardcode CONFIG_PROCFS=y.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789427/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789433"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 23:21 UTC (Sat)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/789433/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just because /proc is mounted doesn't mean that all the processes on the system have a view of the fs hierarchy that lets them see it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789433/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789434"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 23:31 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789434/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's true, but the right approach here is to make a useful subset of /proc visible to all processes regardless of the mount table instead of adding dedicated system calls that reproduce what /proc can already do just for those rare cases where /proc isn't available.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789434/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789454"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 20:46 UTC (Sun)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/789454/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mount namespaces and filesystem path resolution are already complicated enough without adding new "always visible" mounts.<br>
<p>
Maybe a single new form of "open" syscall that opts into a different mount namespace that contains /proc and nothing else?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789454/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789455"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 20:52 UTC (Sun)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789455/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Maybe a single new form of "open" syscall that opts into a different mount namespace that contains /proc and nothing else?</font><br>
<p>
That's basically what I had in mind. I'm imagining an open_proc(2) that returns a dirfd that can be used to access standard procfs files using openat(2), with the specific filesystem returned by open_proc(2) filtered to restrict access to security-sensitive parts of procfs like /proc/pid/net.<br>
<p>
But I got a ton of opposition on lkml when I proposed something like this, so I think that my always-available procfs idea will be in the far future. :-(<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789455/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 16:21 UTC (Tue)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/789599/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I'm imagining an open_proc(2) that returns a dirfd that can be used to access standard procfs files using openat(2) ...</font><br>
<p>
If the pidfd_open() syscall is added, would it be possible to use the returned pidfd with openat()? My understanding is that the result should be equivalent to calling open("/proc/PID") in a context where /proc is procfs, whether or not /proc is visibly mounted. That would offer access to at least the standard /proc/PID hierarchy regardless of mount namespaces or other factors affecting path resolution.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor794570"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 24, 2019 22:52 UTC (Wed)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/794570/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's also the case where you have too many file descriptors open already, and shouldn't have to open one more in order to close some.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794570/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor789272"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 17:42 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789272/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
close_range may be useful although determining open file descriptors on Linux is easy enough. But pidfd_open is inherently broken for the exact same reason "pid files" are broken: If the pid was a reliable identfier for the process, nobody would need a pidfd instead. So, please, dump this idea.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789272/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789273"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 17:56 UTC (Thu)
                               by <b>james</b> (subscriber, #1325)
                              [<a href="/Articles/789273/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      I presume the idea is to open the pidfd, check you've got the right process, and then you can reliably use it. (If you haven't got the right process, then the one you were interested in isn't there anymore).
      
          <div class="CommentReplyButton">
            <form action="/Articles/789273/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789279"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 19:25 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/789279/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could also use pidfd_open if you're the parent process but can't use CLONE_PIDFD, because then you know the PID will stay valid until you wait on it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789279/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789283"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 20:03 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789283/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How's that supposed to happen?<br>
<p>
I've tried to find something about this but the only thing I got is the author's firm conviction that "it [pid re-use] ain't gonna happen".<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789283/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789316"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 5:11 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789316/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Once you have the pidfd, then you will get ESRCH if the associated process dies -- even if the pid itself gets reused. This is by design and comes from the same property you get from "v1" pidfds (opening /proc/$pid).<br>
<p>
This is similar to opening a file with O_PATH, checking whether it is the file you expect through readlink(/proc/self/fd/$fd) and then operating on the O_PATH. Once you've got the reference, and checked it, the reference is free from TOCTOU attacks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789316/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789358"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 13:06 UTC (Fri)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789358/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This doesn't help. The pid may already refer to the wrong process by the time pidfd_open is called.<br>
<p>
A reminder for "But the time window is sooo small! It really ain't gonna happen!"-people: Processes can be suspended. Or can be blocked for extended periods of time if the system is thrashing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789358/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789359"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 13:26 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789359/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
We are in strong agreement over the pid reuse -- that's literally the whole point of this interface. What I'm saying is that you:<br>
<p>
 1. Do a pidfd_open(); *then*<br>
 2. Check that it is the process you want; and *then*<br>
 3. Operate on the pidfd which you now know reference the process you want.<br>
<p>
If the process dies after (1) then you will get -ESRCH on all operations. If (1) is the wrong process, you will detect it during (2) and can error out. Thus (3) will only ever operate on the correct process -- because you have a re-usable reference that won't be recycled you aren't subject to recycling problems. This is not possible with the original pid-based interfaces because any operations in (3) would be using a pid that might be recycled and thus the check in (2) is worthless.<br>
<p>
Please note that all of the above is also true with the current pidfd interface which works through opening /proc/$pid and pidfd_send_signal(2) (this was merged in 5.1). pidfd_open(2) is not anything more radical than that, it just offers a way of using pidfds without the need for procfs to be mounted and usable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789359/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789367"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 14:44 UTC (Fri)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789367/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was asking how this "check that you got the right process" is supposed to happen.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789367/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789372"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 15:44 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789372/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess I misunderstood your question (you were talking about the race condition not how the check might work).<br>
<p>
This depends strongly on what the application is doing. If the application is pkill(1), then you check openat(pidfd, "cmdline") and check the name of the command. If you're an init system you might check the ppid is 1, that it's in the right cgroup, that it has the right exe magiclink, that you haven't received a death signal from that service, and so on.<br>
<p>
In addition, the benefit of pidfds is that they can be passed around or even persisted (through bind-mounts) so that if you are in a scenario where you are sure the pidfd is correct (for instance, you are the parent process and spawned the child) you can pass the pidfd to another process which can operate on the pidfd even though they could not (by themselves) get a pidfd that they were sure about. A toy usecase might be a container runtime bind-mounting the pidfd of the pid1 of containers (after spawning the pid1) and then using that pidfd after-the-fact to operate on the container's namespaces.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789372/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789381"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 18:31 UTC (Fri)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789381/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Short version of the answer: It can't de done. This was my impression as well.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789381/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789385"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 19:59 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/789385/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What do you mean by "it can't be done"? Cyphar provided the exact way it can be done.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789385/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 15:43 UTC (Sat)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789409/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"It can't be done".<br>
<p>
Various heuristics can be applied here in order to find a process which is (according to someone's opinion at least) very likely to be the process whose pid was originally acquired but this doesn't mean that it actually is this process. The only way to know that it pid refers to a certain process is to acquire it from the parent and 'somehow' ensure that the exit status won't be reaped until one is done using the pid. If this is guaranteed, jumping through the pidfd hoop is just useless. The pid could be used instead (for signalling at least). <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789429"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 23:09 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789429/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cyphar really did describe exactly how it should be done, as Cyberax noted. Either provide a *precise timeline* showing a scenario under which Cypher's approach fails or admit that you're wrong. Your comment makes unsubstantiated claims that are simply incorrect. Coordination with parental reaping is unnecessary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789429/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789451"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 20:34 UTC (Sun)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789451/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The original statement was that it would be possible to check that a pid which was used for pidfd_open indeed referred to the process it was intended to refer when the open was done. This is impossible unless the process doing the open is the parent or communicates with the parent. In particular, it cannot be done by looking at the content of /proc-files related to the process now using the pid as there's nothing specific to a particular process in there: All /proc directories for processes running ls -l /proc/self/ will contain the same metainformation (except the timestamps, that is, but these depend on the system clock and could also repeat in sufficiently adverse circumstances).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789451/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789453"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 20:46 UTC (Sun)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789453/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All you've done is repeat your initial assertion. You're wrong. Either admit that or provide a *SPECIFIC* and *CONCRETE* concrete counter-example showing an example of the race you're claiming exist.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789453/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789458"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 21:33 UTC (Sun)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789458/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm sorry but if you don't understand that, I obviously won't be able to explain it to you.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789458/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor789439"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 3:28 UTC (Sun)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/789439/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The behaviour of pill(1) is well documented - it kills processes that have specified attributes. You take a reference to a pid and then start examining those attributes. If they all match, you send an appropriate signal to that pid. Where's the race?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789439/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789452"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 20:42 UTC (Sun)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789452/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's inherent in the semantics of the command: pkill (I'm assuming this was typo) kills some processes which are currently running and have certain attributes, namely, all it happens to find. This may include processes which were started after the pkill (and thus, very likely shouldn't have been killed by it) but it may as well not (they might be started such that pkill won't find them). Arguably, a pidfd_open in pkill would stop that from possibly killing processes it shouldn't ever have killed because they didn't match the specification. I didn't understand that.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789452/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789463"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 22:46 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/789463/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Now you're just being silly.<br>
<p>
pkill() has a contract - it kills processes by specified attributes. Right now it can kill a random process due to the PID-based race condition. There's still a race condition - pkill is not guaranteed to kill processes that launched concurrently with it.<br>
<p>
The new pkill() would _always_ kill the right processes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789463/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789287"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 20:11 UTC (Thu)
                               by <b>droundy</b> (subscriber, #4559)
                              [<a href="/Articles/789287/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And I'll add that you can't do the same process *without* pidfds, because the process may die and be replaced between when you check that it is the one you want to signal, and when you actually signal it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789287/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789290"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 20:21 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789290/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you're the parent, there's no issue here: The pid will remain associated with the correct process until its exit status has been collected.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789290/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789308"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 22:49 UTC (Thu)
                               by <b>droundy</b> (subscriber, #4559)
                              [<a href="/Articles/789308/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Agreed, if you are the parent then you don't need to check that you've got the right process.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789308/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789292"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 20:31 UTC (Thu)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789292/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Those longstanding unix conventions are terrible. Al is simply wrong here to fight to preserve them. O_CLOEXEC really is the right approach. This debate was settled a long time ago, when most system calls got O_CLOEXEC options. Let's not reopen it for pointless reasons.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789292/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789294"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 20:57 UTC (Thu)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789294/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The reason for O_CLOEXEC options is that this flag needs to be set atomically if the process doing the open is multithreaded to prevent accidental inheritance of a file descriptor because another thread initiated a fork/exec after the open returned and before a fcntl calls setting FD_CLOEXEC was made.<br>
<p>
Apart from that, there's no "wrong" and no "right" approach here. There are two choices for a default policy, namely inheritable or not inheritable, and which is better for a certain application depends on what the application is trying to do. Making the default policy a configurable per-process setting would probably make sense. Different default policies depending on whatever the person who implemented the syscall perferred for whatever reason just make the system more complicated without any benefit.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789294/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789311"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2019 23:45 UTC (Thu)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789311/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Right, but the point is that you can always disable O_CLOEXEC safely through fnctl(2) but you cannot safely enable it. So really, making O_CLOEXEC the default seems to have no real downside other than inconsistencies with existing syscalls -- but open(2) is already inconsistent with almost every other syscall by ignoring unknown flags instead of giving -EINVAL.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789311/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789355"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 12:59 UTC (Fri)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/789355/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
These are three grammatically connected but unrelated statements.<br>
<p>
The O_CLOEXEC file descriptor creation flag doesn't belong into this discussion. <br>
<p>
The default policy for existing system calls is mandated by POSIX, hence, changing that is not an option. Different default policies for different system calls are still a bad idea as they make the system more difficult to program for no real benefit. A default policy which could be changed on a per-process basis could be a good idea. OTOH, file descriptor creation is a fairly rare occurence, hence, this might also not be worth the effort. But it would at least solve a problem and not create one.<br>
<p>
That some aspects of open are different from every other system call is unsurprising. If this wasn't the case, an open syscall wouldn't exist.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789355/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789360"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 13:35 UTC (Fri)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789360/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess we have different opinions on what APIs make the most sense. I agree that it does result in inconsistencies, though I disagree this makes systems significantly harder to program.<br>
<p>
<font class="QuotedText">&gt; That some aspects of open are different from every other system call is unsurprising. If this wasn't the case, an open syscall wouldn't exist.</font><br>
<p>
I don't understand what you mean by this. open(2) is a syscall that must exist for reasons that should be abundantly obvious. However, the fact that open("foo", 0xFFFFFFFFFFFFFFFF, 0) works today -- despite many of those bits being undefined -- is not required for open(2) to exist. This is known as a bad practice -- no other syscall operates like this (and the kernel documentation explicitly tells you not to design syscalls or ioctls like this).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789360/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor789313"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Linux is catching up with MirBSD</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 1:03 UTC (Fri)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/789313/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cool, close_range() will make it possible to emulate the OpenBSD-derived closefrom(2) syscall:<br>
<p>
<a href="https://www.mirbsd.org/htman/i386/man2/closefrom.htm">https://www.mirbsd.org/htman/i386/man2/closefrom.htm</a><br>
<p>
I for one will be rooting for that!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789313/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789330"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 8:34 UTC (Fri)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/789330/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How will error handling work? You're supposed to check the return value from close(), but if it fails, how do you know which fd had an issue…?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789330/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789406"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 14:52 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/789406/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There have been articles about the return value of close(2) here before. Basically the state of the descriptor after a failed close(2) is undefined, even for EINTR, so checking the return value is only of "notify that something went wrong" value. There's nothing to actually *do* in response an error from close(2).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789406/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789332"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 24, 2019 11:36 UTC (Fri)
                               by <b>stressinduktion</b> (subscriber, #46452)
                              [<a href="/Articles/789332/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would like to propose another idea on how to attack this problems:<br>
<p>
a new flag/flags or bitset to open and a new syscall that closes all descriptors with a particular flag:<br>
<p>
- open(..., O_FD_KEEP_OPEN_EXECVE)<br>
- fnctl(fd, F_SETFL, ...|O_FD_KEEP_OPEN_EXECVE)<br>
<p>
and finally close all descriptors without those flags: close_except(O_FD_KEEP_OPEN_EXECVE)<br>
<p>
Obviously I haven't put much time into the naming of those flags. :)<br>
<p>
One could build on top of that and implement:<br>
<p>
close_type(FD_STDIO); // dubious semantics<br>
close_type(FD_ALL_SOCKETS);<br>
close_type(FD_ALL_TTYS);<br>
close_type(FD_ALL);<br>
<p>
Not sure if it is worth the complexity, but could be useful. I think that in most cases it is already known at open/fcntl time if a descriptor should stay open. Furthermore it might be useful during debugging, if those information are also discoverable in the proc/pid/fd hierarchy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789332/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789408"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 15:31 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/789408/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are a lot of ABI problems here. open(2) can't take new flags (because the implementation never verified that unused flags were passed in unused), POSIX specifies how things work, etc. I'm also suspicious that applications would actually list the full set of fd-kinds for closing all kinds (block, character, pidfd, memfd, etc.) except those which they care about. Or that they even know the answer to such a question.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789408/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789545"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 1:03 UTC (Tue)
                               by <b>cyphar</b> (subscriber, #110703)
                              [<a href="/Articles/789545/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; open(2) can't take new flags (because the implementation never verified that unused flags were passed in unused), POSIX specifies how things work, etc.</font><br>
<p>
We add flags to open(2) (and openat(2)) all the time, despite this problem. New syscalls aren't defined this way, but we're stuck with this behaviour unfortunately.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789545/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor789431"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 23:11 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789431/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm opposed to closerange. procfs already provides the necessary functionality, and I don't think we should be putting engineering effort into duplicating features of procfs in a procfs-free environment. Instead, we should ensure that procfs is always available --- at least a subset of procfs useful for process-management tasks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789431/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789432"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2019 23:20 UTC (Sat)
                               by <b>quotemstr</b> (subscriber, #45331)
                              [<a href="/Articles/789432/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Granted, a batched close(2) would be useful, and not just immediately before an execve! I'd be fully in support of a close_fds(2) that accepted a *list* of FDs --- I just think that reading the list of FDs from /proc is perfectly reasonable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789432/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor789435"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 0:13 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/789435/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Scanning /proc/self is not at all free or fast. You'll need to do a bunch of kernel-userspace transitions instead of one syscall.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789435/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor794951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jul 30, 2019 23:30 UTC (Tue)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/794951/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The killer problem (to me) with procfs is that you have to open an FD in order to close any FDs. What if the process has reached the maximum number of FDs? Do you try to close arbitrary FDs in the hope of hitting one that is actually open, so that you can then open /proc/self/fd in order to know the rest of the FDs to close?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/794951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor789437"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 26, 2019 3:27 UTC (Sun)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/789437/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
close_range, and its more common form closefrom, are much worse for Unix conventions than setting CLOEXEC by default. Many foolish processes run closefrom on startup, which means you can't implicitly pass down arbitrary file descriptors to them. That is, you can't pass down a file descriptor without explicitly telling the program about it. That in turn closes off a whole class of tricks. For example, passing a temporary file via file descriptor and referencing it with /proc/self/fd/n means you can pass a file without every linking it into the filesystem. Libraries can accept file descriptors specified by environment variables and use them to extend the main program's functionality without the main program having to be aware.<br>
<p>
I'm in favor of setting CLOEXEC by default - that's the only safe way to do things in the presence of a shared file descriptor table (i.e. with threads). Sometimes you want to implicitly inherit a file descriptor, and you can just unset CLOEXEC in that case. But closefrom will make that impossible: it does not support implicit inheritance of file descriptors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789437/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789475"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2019 14:34 UTC (Mon)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/789475/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You’re not supposed to run closefrom() at startup… only before passing control to another process via exec*() after a fork(), for example.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789475/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789544"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 0:04 UTC (Tue)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/789544/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;You’re not supposed to run closefrom() at startup… only before passing control to another process via exec*() after a fork(), for example.</font><br>
<p>
That doesn't solve the problem; it still breaks implicit inheritance of file descriptors. If my shell, for example, ran closefrom after fork but before exec, I wouldn't be able to pass down fds to programs started by the shell. The same concern applies in any fork/exec case.<br>
<p>
Also, independently, many unfortunate programs already do call closefrom at startup. I think adding it as a syscall will make this worse, as userspace programmers hear the bad advice to call closefrom on startup.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789544/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 1:11 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/789546/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  That doesn't solve the problem; it still breaks implicit inheritance of file descriptors. If my shell, for example, ran closefrom after fork but before exec, I wouldn't be able to pass down fds to programs started by the shell. The same concern applies in any fork/exec case.</font><br>
A shell can just loop through FDs and close them. So what's the difference?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789548"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 1:36 UTC (Tue)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/789548/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;A shell can just loop through FDs and close them. So what's the difference?</font><br>
<p>
Not sure what you're meaning to ask. There is no difference in functionality. close_range or closefrom are just a more efficient version of looping through all open FDs and closing them.<br>
<p>
I'm saying that close_range, closefrom, and looping through open FDs are all bad things that you shouldn't do. close_range makes it easier to do something you shouldn't do. So it shouldn't be added. We shouldn't add syscalls to make it faster to do things that shouldn't be done.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789548/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789550"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 2:50 UTC (Tue)
                               by <b>mirabilos</b> (subscriber, #84359)
                              [<a href="/Articles/789550/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except it’s in the Korn Shell’s definition that only explicitly passed fds are passed to processes.<br>
<p>
Except that sometimes you *do* want to close all other fds (sometimes even all fds, before reopening /dev/null as fd 0 and duping it to 1 and 2) for security reasons.<br>
<p>
Programmers will shoot themselves into the foot, but if the rope is efficient… *shrug*<br>
<p>
And if you don’t like it, it’s open source and you’ll be able to remove the call in your local copy of the software.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789550/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789551"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 3:56 UTC (Tue)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/789551/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Except it’s in the Korn Shell’s definition that only explicitly passed fds are passed to processes.</font><br>
<p>
Yes, the Korn shell (and mksh) are wrong here, I'm afraid. Thankfully most shells don't have that particular bad behavior.<br>
<p>
<font class="QuotedText">&gt;Except that sometimes you *do* want to close all other fds (sometimes even all fds, before reopening /dev/null as fd 0 and duping it to 1 and 2) for security reasons.</font><br>
<p>
The "security reasons" argument here applies identically to environment variables. Indeed, I think it's sound to clear the environment and close all fds when you really want to harden something - in setuid environments, for example. But most programs shouldn't be clearing their environment, and most programs shouldn't be closing all fds.<br>
<p>
<font class="QuotedText">&gt;Programmers will shoot themselves into the foot, but if the rope is efficient… *shrug*</font><br>
<font class="QuotedText">&gt;And if you don’t like it, it’s open source and you’ll be able to remove the call in your local copy of the software.</font><br>
<p>
This doesn't make any sense. Again, we shouldn't add syscalls to speed up operations which should not be done in the first place. That has nothing to do with open source choice. If you think this operation is good, then say that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789551/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 6:58 UTC (Tue)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/789554/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Again, we shouldn't add syscalls to speed up operations which should not be done in the first place.</font><br>
<p>
But many programs do want hardening --- e.g. Firefox and Chrome need to close all fds in sandboxed child processes --- and probably that trend is to be encouraged. Why shouldn't they have an efficient way to do it?<br>
<p>
Plus, it seems to me that leaking internal file descriptors into spawned subprocesses is unhygenic, asking for trouble, and should not be the default.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2019 12:57 UTC (Tue)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/789556/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;But many programs do want hardening --- e.g. Firefox and Chrome need to close all fds in sandboxed child processes --- and probably that trend is to be encouraged. Why shouldn't they have an efficient way to do it?</font><br>
<p>
Primarily: because they don't need an efficient way to do it. They can close file descriptors once at startup and thereafter make sure to use CLOEXEC to prevent file descriptor leakage. That works fine and doesn't encourage bad practices in the rest of userspace. But more generally...<br>
<p>
It's obviously hard to argue against "we should do more sandboxing". But I fall back to the analogy to environment variables: If we shouldn't clear the environment before running the program, then we shouldn't close all file descriptors before running it. Browser Javascript sandboxes are totally closed off from the rest of the system - they certainly don't need environment variables, and they wouldn't benefit from file descriptors either. So it's fine to clear the environment and close all fds before running them.<br>
<p>
Certainly I think we should move towards a world where processes can't access things they haven't somehow been given access to. But I don't think we should make every process like a browser Javascript sandbox, and be totally closed off from the system. There are many things that are implicitly inherited in Linux - the root directory, the current working directory, all the namespaces, tons of things. Most of those should be removed or reworked, because they're easy to mess up and can't easily be controlled, and most of them can't even be changed without privileges. But many parts of Unix are still useful, and shouldn't be removed. Environment variables shouldn't be removed, and the possibility of implicit inheritance of file descriptors shouldn't be removed. Otherwise we'll inevitably end up reinventing those, slowly and painfully.<br>
<p>
<font class="QuotedText">&gt;Plus, it seems to me that leaking internal file descriptors into spawned subprocesses is unhygenic, asking for trouble, and should not be the default.</font><br>
<p>
I agree! Thankfully, there is already a way to prevent this: CLOEXEC. You don't need close_range to avoid leaking file descriptors into spawned subprocesses.<br>
<p>
As I said in my original comment: CLOEXEC is the right way to stop to stop implicit inheritance of file descriptors, and I think it should be the default. Almost all file descriptors shouldn't be implicitly inherited into children - that would be massive resource leakage. But sometimes you *do* want to implicitly inherit a file descriptor and CLOEXEC gives you that option, because you can turn it off and inherit a file descriptor without having to explicitly tell your child that you're doing it. closefrom is wrong because there's no way to turn it off when some random glue program in the middle of the tree calls it, so it completely prevents implicit inheritance of file descriptors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor789829"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">New system calls: pidfd_open() and close_range()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2019 12:26 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/789829/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; They can close file descriptors once at startup and thereafter make sure to use CLOEXEC to prevent file descriptor leakage. That works fine and doesn't encourage bad practices in the rest of userspace. But more generally...</font><br>
<p>
That would mean a bug in a third-party library that creates a non-CLOEXEC file descriptor, even for a moment, creates a security hole for the sandbox. That's not really acceptable.<br>
<p>
<font class="QuotedText">&gt; If we shouldn't clear the environment before running the program, then we shouldn't close all file descriptors before running it.</font><br>
<p>
I don't buy that argument. Reading the environment can't usually affect other processes. Reading or writing leaked file descriptors can, sometimes in very subtle ways.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/789829/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2019, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
