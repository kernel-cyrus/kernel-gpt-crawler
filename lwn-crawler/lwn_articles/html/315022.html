        <!DOCTYPE html>
        <html lang="en">
        <head><title>A SystemTap update [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/315022/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/316193/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/315022/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A SystemTap update</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="GAByline">
           <p>January 21, 2009</p>
           <p>This article was contributed by Mark Wielaard</p>
           </div>
<P><A HREF="http://sourceware.org/systemtap/">SystemTap</A> has been under
active development for a some years.  More than 35 people have
<A HREF="http://sourceware.org/systemtap/wiki/Myths">contributed
enhancements</A> in the last year. But newer developments, like the
ability to dynamically trace user space programs, seem to have been very
quietly introduced and, thus, have not always been noticed by users that
are not yet using SystemTap extensively.  So this article will take a look
at what
currently works out of the box, what that box should contain to make
things work, the work in progress, and the challenges SystemTap faces
to be more powerful and get more widespread adoption. 
</P>

<P>SystemTap's goal is to provide full system observability on
production systems, which is safe, non-intrusive, (near) zero-overhead
and which allows ubiquitous data collection across the whole system for any
interesting event that could happen. To achieve this goal, SystemTap defines
the <A HREF="http://sourceware.org/systemtap/langref/langref.html">stap
language</A>, in which the user defines probes, actions, and data
acquisition. The SystemTap translator and runtime guarantees that probe
points are only placed on safe locations and that probe functions
cannot generate too much overhead when collecting data. For dynamic
probes on addresses inside the kernel, SystemTap
uses <A HREF="http://lwn.net/Articles/132196/">kprobes</A>; for
dynamic probes in user space programs, instead, SystemTap uses its
cousin <A
HREF="http://ols2006.108.redhat.com/2007/Reprints/keniston-Reprint.pdf">uprobes
[PDF]</A>.
This provides a unified way of probing and then collecting data for
observing the whole system. To dynamically find locations for probe
points, arguments of the probed functions and the variables in scope
at the probe point, SystemTap uses the debuginfo
(<A HREF="http://dwarfstd.org/">Dwarf</A>) standard debugging
information that the compiler generates.
</P>

<P>So, to provide an ideal setting for using SystemTap, GNU/Linux
distributions should provide easy access to debuginfo for the kernel and user
space programs.  Almost all distributors do this.
The kernel supports
kprobes, which 
has been in the upstream kernel for some years, and uprobes, which
comes with (and is automatically loaded by) SystemTap, but which relies
on the full utrace framework, which isn't yet in the mainline kernel.
(The latest few releases of the Fedora family, including Red
Hat Enterprise Linux and CentOS, do include full utrace support by
default). SystemTap works without debuginfo, but the range of probes
and the amount of data you can collect is then very limited. And it
works without utrace support, but then you won't be able to do deep
user space probing, only observe direct user/kernel space
interactions.
</P>

<P>There are various probe variants one can use with SystemTap, but
the most interesting ones are the debuginfo-based probes for the
kernel, kernel modules, and user space applications. These can use
function, statement or return variants, and wildcards, such as:
<p>
<ul>
<li> <CODE>kernel.function(&quot;rpc_new_task&quot;)</CODE>: a named kernel
function, 
<li> <CODE>process(&quot;/bin/ls&quot;).function(&quot;*&quot;)</CODE>:
any function entry in a specific process,
<li> <CODE>module(&quot;usb*&quot;).function(&quot;*sync*&quot;).return</CODE>:
every return of a function containing the word <tt>sync</tt>, in any module
starting with <tt>usb</tt>, or
<li> <CODE>kernel.statement(&quot;bio_init@fs/bio.c+3&quot;)</CODE>: for 
a specific statement in a particular file
</ul>
</P>

<P>Depending on the type of probe, one can access specifics of the
probe point. For the debuginfo based probes these
are <CODE>$var</CODE> for in-scope variables or function
arguments, <CODE>$var-&gt;field</CODE> for accessing structure
fields, <CODE>$var[N]</CODE> for array elements, <CODE>$return</CODE>
for the return value of a function in a return probe, and meta
variables like <CODE>$$vars</CODE> to get a string representation of
all the in-scope variables at a particular probe point. All access to
such constructs are safeguarded by the SystemTap runtime to make sure
no illegal accesses can occur.
</P>

<P>Given that one has the debuginfo of a program installed, one can
easily get a simple call trace of a specific program, including all
function parameters and return values with the following stap script:
</P>

<PRE>  probe process(&quot;/bin/ls&quot;).function(&quot;*&quot;).call
  {
    printf(&quot;=&gt;%s(%s)\n&quot;, probefunc(), $$parms);
  }

  probe process(&quot;/bin/ls&quot;).function(&quot;*&quot;).return
  {
    printf(&quot;&lt;=%s:%s\n&quot;, probefunc(), $$return);
  }</PRE>

<P>
The <A HREF="http://sourceware.org/systemtap/examples/keyword-index.html#CALLGRAPH">examples
included with SystemTap</A> come with much more powerful versions
that show timed, per-thread call graphs, optionally showing only
children of a particular function call.
</P>

<P>While these probing and data extraction constructs are 
powerful, they do require some knowledge of the kernel or program code
base. Since you are often interested in <i>what</i> is happening and not
precisely <i>how</i>, SystemTap comes with "tapsets," which are utility
functions and aliases for groups of interesting probes in a particular
subsystem. Examples include system calls, NFS operations, signals,
sockets, etc. Currently these tapsets are distributed with SystemTap itself,
but ideally each program or subsystem would come with its own tapset of
interesting events provided by the program or subsystem maintainer.
</P>

<P>Just printing out events while they occur is not always ideal.
First, you may be overwhelmed by volume of the output; second, you might
only be 
interested in a specific subset of the same event (only certain
parameters, only calls that take longer than a specific time, only
from the process that does the most calls over a specific time frame,
etc.).  Finally, processing all the events on your production system
might interfere with the thing you are trying to observe. Especially
at the start of your investigations, when you might not yet be sure
what the interesting events are, you may do some very wide
probing to see what is going on.
</P>

<P>For this reason the stap language supports variables that can be
used
as <A HREF="http://sourceware.org/systemtap/langref/node9.html">associative
arrays</A>,
simple <A HREF="http://sourceware.org/systemtap/langref/node8.html">control
structures</A>
and <A HREF="http://sourceware.org/systemtap/langref/node10.html">data
aggregation functions</a> to do simple statistics during probe time,
with very low overhead and without having to call external programs
that might interfere with the system being probed.
</P>

<P>The following script might be how you would start investigating
a problem involving a system which seems to do an excessive amount of reads.
It uses the "vfs" tapset and an associative array to store the number of
reads a particular executable with a specific process ID does:
</P>

<PRE>
  global totals;
  probe vfs.read
  {
    totals[execname(), pid()]++
  }

  probe end
  {
    printf(&quot;== totals ==\n&quot;)
    foreach ([name,pid] in totals-)
      printf(&quot;%s (%d): %d \n&quot;, name, pid, totals[name,pid])
  }
</PRE>

<P>
This will give you a list of executables and their pid sorted by the
total number of vfs reads done while the script was running. These
facilities in the stap language help greatly to 
minimize any overhead of the tracing framework. If you would try to do
the same thing by just printing each vfs event and then
post-processing the results with Perl, you might end up with Perl
itself being the process doing the most vfs calls, or worse, by having
to parse  megabytes of trace data, Perl might start trashing
the system even more, making it harder to determine the root cause of the
original problem.
</P>

<P>SystemTap now also
supports <A HREF="http://lwn.net/Articles/245671/">static markers</A>
in the kernel. This allows subsystem maintainers to mark specific
events as interesting, providing a format string of the arguments to
the event that can be easily parsed by tracing tools.
The advantage of static markers over tapsets is that they are in-code and so
might be easier to maintain, though you probably still want to have an
associated tapset for utilities to nicely format the
arguments or associate various markers with each other.  Also, they can
work without needing any DWARF debuginfo around, but you lose
the ability to inspect local variables or function parameters not
passed to the marker. You use them with a command like:
<p>
<pre>
    probe kernel.mark(&quot;kernel_sched_wakeup&quot;)
</pre>
<P>
The tapset can then
access the arguments through <CODE>$argN</CODE> and get the argument
format string of the marker with <CODE>$format</CODE>.
</P>

<P>An alternate way of adding static markers to the kernel,
<A HREF="http://lwn.net/Articles/291091/">tracepoints</A>, is not yet
directly supported in SystemTap. Tracepoints have the disadvantage that
they require the DWARF debuginfo to be around because they don't
currently specify the types of their arguments except through their
function prototypes. So SystemTap can currently only use tracepoints
via hand-written intermediary code that maps them to markers.
</P>

<P>The development version of SystemTap recently got support for user-space
static markers. Although SystemTap defines its own STAP_PROBE 
macros for usage in applications that want to add static markers, there
is also an alternative tracing
tool, <A HREF="http://lwn.net/Articles/244536/">Dtrace</A>, that
has its own way for programs to embed static markers.  SystemTap
supports the convention used by Dtrace by providing an
alternative include file and build preprocessor so that programs using
DTRACE_PROBE macros can be compiled as if for Dtrace and
have their static markers show up with SystemTap.
</P>

<P>Luckily, there are various programs that already have such markers
defined. For
example <A
HREF="http://www.postgresql.org/docs/8.2/static/dynamic-trace.html">PostgreSQL</A> 
has various static markers to
trace higher-level events like transactions and database locks.
Currently one has
to <A HREF="http://sourceware.org/systemtap/wiki/UsingStaticUserMarkers">adapt
the build process</A> of such programs by hand, but the next version
of SystemTap will come with scripts that will automate that
process.</P>

<P>While SystemTap works well on GNU/Linux distributions that support
it, there are a couple of challenges to overcome to make it more
ubiquitous and easier for more people to use out of the box.  This goes
beyond work on the SystemTap code base itself. Since the goal is to
provide full system observability, from low-level kernel events to
high-level application events, there is work to be done all across the GNU/Linux
stack.  Also needed is better integration into more distributions,
providing 
default installation of SystemTap and tapsets, easy access to debuginfo for
deep inspection, binaries compiled with marker support for high-level
events, etc.  The two main challenges to make SystemTap more powerful
and easier to use on any distribution are debuginfo and better
kernel support.
</P>

<P>A lot of power of SystemTap comes from the fact that it can use 
DWARF debuginfo from the kernel and applications to do very detailed
inspection. But this power comes at a price, since the debuginfo is often
large. For example, on Fedora, the kernel debuginfo package is far
larger than the kernel package itself. One easy win will be to split
the debuginfo package into the DWARF files and the source files, which
are needed for a debugger, but not directly for a tracer like
SystemTap. Fedora <A HREF="https://fedoraproject.org/wiki/Features/DebugInfoRevamp">plans
to do this</A> for its next release. The elfutils team is also working
on <A HREF="https://fedorahosted.org/elfutils/wiki/DwarfTasks">a
framework for Dwarf transformation and compression</A> that could be
used as post-processor on the output of the compiler.
</P>

<P>SystemTap sometimes suffers from the same issues you might have
with a debugger: the compiler has optimized the code, but forgot where
it put a certain variable after the optimization. Of course this is
always the variable you are most interested in. Alexandre Oliva is
working on improving the local variable debug information in
GCC. His <A HREF="http://www.lsd.ic.unicamp.br/~oliva/papers/vta/paper.pdf">variable
tracking assignments</a> [PDF] branch in GCC aims to improve debug
information by annotating assignments early in the compilation process and
carrying over such annotations throughout all optimization passes so
that you can always accurately track variables, even in optimized code.
</P>

<P>Finally, there is work being done on having a SystemTap &quot;client
and server&quot; that could be used on production systems where you
might not even want to have any tools or debuginfo installed. You can
then set up a development client that has the same configuration as the
production system with the addition of the SystemTap translator and all
debuginfo, create and test your scripts there.  The final
result of this work could then be used on the bare-bones production server.</P>

<P>Most of the SystemTap runtime, like the kprobes support, is
maintained in the upstream linux kernel, but there is some stuff still
missing. This leads to distributions having to add patches
to their kernel, especially to support user space tracing. In
particular, the utrace framework is still not upstream.
Over the last few kernel releases, various parts have been merged,
including the
utrace <A HREF="http://lwn.net/Articles/263204/">user_regset</A>
framework, which creates an interface for code accessing the
user-space view of any machine specific state, and
the <A HREF="http://lwn.net/Articles/290954/">tracehook</A> work,
which provides a framework for all the user process tracing.
The actual utrace framework sits on top of these components;
the <tt>ptrace()</tt> interface is implemented as utrace client.  Anything
that changes the ptrace implementation is hairy stuff, so there is a
large <A HREF="http://sourceware.org/systemtap/wiki/utrace/tests">ptrace
testsuite</A> to make sure that nothing breaks.  One idea under
consideration  is to
<A HREF="https://www.redhat.com/archives/utrace-devel/2009-January/msg00039.html">push
utrace upstream in two installments</A>. At first, using utrace or ptrace on
a process would
be <A HREF="https://www.redhat.com/archives/utrace-devel/2009-January/msg00040.html">mutually
exclusive</A>. That could pave to path to get pure-utrace upstream in
first and then do proper ptrace cooperation in a second go.</P>

<P>This approach would also provide the way for uprobes, which depends on the
utrace framework, to be submitted upstream. Uprobes components such as
breakpoint insertion and removal and the single-stepping
infrastructure are also potentially useful for other user space
tracers and debuggers. Like with utrace, one idea is to factor out
these portions of uprobes so that it can be used by multiple clients
as a
shared <A HREF="https://www.redhat.com/archives/utrace-devel/2008-November/msg00020.html">user-space
breakpoint support</A> (ubs) layer. With multiple clients using the
same layer, upstream acceptance might be easier.</P>

<P>One candidate for using both the utrace and the uprobes layer
besides SystemTap
is <A HREF="http://sourceware.org/cgi-bin/cvsweb.cgi/froggy/?cvsroot=systemtap">Froggy</A>,
which provides an alternative debugger interface to ptrace. The
<A HREF="http://sourceware.org/gdb/wiki/ProjectArcher">GDB Archer</A>
project would like to serve as testbed for Froggy, which they hope
will also make GDB more robust when linked with libpython, which is
being used for GDB scripting.</P>

<p> 
In the past, kernel maintainers were skeptical about tracing, which
resulted in tracing frameworks like dprobes, LTT and parts of the SystemTap
runtime being maintained
outside the main kernel tree. But now that there is actually <A
HREF="http://lwn.net/Articles/291091/">no shortage of tracing options</A>
in the kernel, people like Ted Ts'o have been urging the SystemTap hackers
to push as much as possible upstream.  Ted also encourages the developers
to focus more on the kernel 
hackers as first-rate customers, rather than focusing exclusively on the whole
system experience for production setups. 
The SystemTap developers have been successful in making their module
support &quot;just work&quot; with any kernel. It currently works with
kernel versions between 2.6.9 and the latest, 2.6.28; it is also regularly
tested against the latest -rc kernels. But, maybe they have been a little
too successful, because having this activity be more visible on the linux kernel
mailing list would be good publicity.
In response, there is now an active
SystemTap bug called &quot;<A
HREF="http://sourceware.org/bugzilla/show_bug.cgi?id=7042">Make upstream
kernel developers happy</A>&quot; that calls for more frequent postings on
the main kernel mailing list, improvements in the usage of debuginfo as
described above, and pushing utrace and uprobes upstream first as a
priority. 


<P>There is still work to do, but over the last couple of years the
GNU/Linux tracing and debugging experience has kept improving.
Hopefully soon, all these parts will fall into place and provide
hackers with a fairly nice environment for not only debugging on
development systems, but also for unobtrusive tracing on production
systems.
</P>

<P>About the author: Mark Wielaard is a Senior Software engineer at
Red Hat working in the Engineering Tools group hacking on SystemTap.
</P><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#SystemTap">SystemTap</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Wielaard_Mark">Wielaard, Mark</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/315022/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor317079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 4:04 UTC (Thu)
                               by <b>akpm</b> (guest, #4826)
                              [<a href="/Articles/317079/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
um, which genius decided to make systemtap dependent upon two large<br>
kernel patches (utrace and uprobes) which have dim-to-zero prospects<br>
of ever being included in Linux?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317096"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 8:23 UTC (Thu)
                               by <b>eugeniy</b> (guest, #24280)
                              [<a href="/Articles/317096/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
SystemTap is not dependent on any patches, it works fine with unpatched kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317096/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 10:08 UTC (Thu)
                               by <b>ctg</b> (guest, #3459)
                              [<a href="/Articles/317104/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Me and a colleague were discussing just last night the thorny problem of how we work out which of many competing processes are using disk access - causing contention on the disk, so that everything queues up, and more and more disk access is caused...  not really a lot of tools in linux todo that... (If we knew the worst offenders, then we could focus our effort on making them more efficient - having to put instrumentation in each process is really time consuming).<br>
<p>
.. so reading this article was timely. Looks like systemtap would enable us to quickly home in on the big disk users..<br>
<p>
.. the article quite clearly states that to get the best out of systemtap you need these patches, so when Mr Morton himself makes this sort of criticism, then its a bit of a concern.<br>
<p>
Despite all that, I'm off to look at systemtap in a bit more detail (it's lack of ubiquity has put me off before), but the lack of decent tools for working out what is really going on in a complex system is pretty frustrating  (I'm still suffering from the lack of the "W" flag in the output of ps(1) to show which processes are swapped out - I understand why it doesn't show that any more - but when your system goes into swap, it's useful to see which processes are being paged out.. I suspect systemtap might be able to help with this too).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317114"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 10:42 UTC (Thu)
                               by <b>mjw</b> (subscriber, #16740)
                              [<a href="/Articles/317114/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The vfs tapset example in the article works without needing any additional user space hook patches.<br>
<p>
Also take a look at some of the examples that come with Systemtap. disktop.stp probably does what you want:<br>
<a href="http://sourceware.org/systemtap/examples/keyword-index.html#DISK">http://sourceware.org/systemtap/examples/keyword-index.ht...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317114/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317175"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 17:05 UTC (Thu)
                               by <b>knobunc</b> (subscriber, #4678)
                              [<a href="/Articles/317175/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
See also iotop.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317175/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317215"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 20:07 UTC (Thu)
                               by <b>epb205</b> (guest, #50182)
                              [<a href="/Articles/317215/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why doesn't ps show which processes are swapped out anymore? Is that somehow a security hole?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317215/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317815"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 3, 2009 22:33 UTC (Tue)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/317815/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No idea, but you can get the same information also from /proc/PID/smaps. <br>
It's separate for each of the memory mapping the process has i.e. you may <br>
need to write a small script to process the data.<br>
<p>
If the process has stuff that's marked as swapped, but not anymore as <br>
dirty, it's completely swapped out.  For some reason kernel/SMAPS doesn't <br>
think swapped pages to be anymore dirty which loses the distinction <br>
between shared dirty and private dirty that SMAPS shows for pages still in <br>
RAM.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317815/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor317263"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 3:15 UTC (Fri)
                               by <b>SEJeff</b> (guest, #51588)
                              [<a href="/Articles/317263/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actually the block_dump feature of modern 2.6 linux kernels will show you which processes are writing to which devices. I wrote a proof of concept script to show them:<br>
<p>
<a href="http://www.digitalprognosis.com/opensource/scripts/top-disk-users">http://www.digitalprognosis.com/opensource/scripts/top-di...</a><br>
<p>
The output looks like this:<br>
root@desktopmonster:~# ./top-disk-users <br>
        COMMAND        PID        NUM     ACTION     DEVICE<br>
      banshee-1      23999          8       READ       sda9<br>
      kjournald       2494        131      WRITE       sda5<br>
      kjournald       5182          5      WRITE       sda8<br>
        pdflush        228         15      WRITE       sda5<br>
        pdflush        228          1      WRITE       sda8<br>
        pdflush        228         32      WRITE       sda9<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317263/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor317125"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 12:46 UTC (Thu)
                               by <b>eugeniy</b> (guest, #24280)
                              [<a href="/Articles/317125/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Correction: patches are not needed for probing kernel. It looks like for userspace utrace is required. uprobes source, it seems, is included in systemtap.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317125/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor317108"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 10:38 UTC (Thu)
                               by <b>mjw</b> (subscriber, #16740)
                              [<a href="/Articles/317108/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As the article states there is no hard dependency, they are just used for deeper user space probing if wanted. And some of the utrace foundations have been going in, with the groundwork now upstream.<br>
<p>
The last part of the article gives some idea of ways people are working on getting this functionality faster upstream, so they are included with more distributions by default. By splitting it up, providing other users, etc. One recent example is the utrace-&gt;ftrace engine proof of concept: <a href="http://lkml.org/lkml/2009/1/27/294">http://lkml.org/lkml/2009/1/27/294</a><br>
<p>
If you have any hints and tips for getting these things, or similar user space hooks that Systemtap can use, upstream faster that would be appreciated.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317108/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 13:28 UTC (Thu)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/317132/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; [why is] systemtap dependent upon two large</font><br>
<font class="QuotedText">&gt; kernel patches (utrace and uprobes)</font><br>
<p>
For probing user-space, there is apprx. no alternative: one needs a<br>
kprobes-like infrastructure.<br>
<p>
<font class="QuotedText">&gt; which have dim-to-zero prospects of ever being included in Linux?</font><br>
<p>
While skepticism may be warranted, we are making efforts to make this<br>
code more palatable to the gatekeepers.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317160"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 16:15 UTC (Thu)
                               by <b>jejb</b> (subscriber, #6654)
                              [<a href="/Articles/317160/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Actuallly, only the user space tracing aspect of systemtap is dependent on these.  You can still do kernel space tracing without them.<br>
<p>
We've spent quite a lot of effort explaining the problems with the utrace/uprobes dependency (especially the issues of having to pull the process symbol table into the kernel and of having the kernel actually execute the compiled code to do the traps).  There is hope that we might be able to go with a lighter weight infrastructure that simply vectors traps to the user space stap runtime and does all the interpreting in user space.  It's just we still haven't quite got system tap buy in yet.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317160/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317166"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 16:36 UTC (Thu)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/317166/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; We've spent quite a lot of effort explaining the problems with the</font><br>
<font class="QuotedText">&gt; utrace/uprobes dependency</font><br>
<p>
Can you provide some links to discussion about these specifics: ?<br>
<p>
<font class="QuotedText">&gt; (especially the issues of having to pull the </font><br>
<font class="QuotedText">&gt; process symbol table into the kernel</font><br>
<p>
User-space symbol tables are made available to the systemtap module<br>
only if it is required by the script - if it performs symbolic<br>
address or backtrace type lookups.<br>
<p>
<font class="QuotedText">&gt; and of having the kernel actually </font><br>
<font class="QuotedText">&gt; execute the compiled code to do the traps</font><br>
<p>
Like in dtrace, instrumentation is run within the kernel because<br>
having user-space processes instrument each other is too disruptive.<br>
We're looking for microsecond-level probe effect, not something<br>
involving multiple context switches, indirect address space accesses,<br>
and so on.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317166/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317172"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 16:55 UTC (Thu)
                               by <b>jejb</b> (subscriber, #6654)
                              [<a href="/Articles/317172/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; We've spent quite a lot of effort explaining the problems with the</font><br>
<font class="QuotedText">&gt;&gt; utrace/uprobes dependency</font><br>
&gt;<br>
<font class="QuotedText">&gt; Can you provide some links to discussion about these specifics: ?</font><br>
<p>
Um, just use a search ... if you search lkml for utrace you get the less polite version .. if you search the systemtap lists on the same thing, you get the more polite one.<br>
<p>
<font class="QuotedText">&gt;&gt; (especially the issues of having to pull the</font><br>
<font class="QuotedText">&gt;&gt; process symbol table into the kernel</font><br>
&gt;<br>
<font class="QuotedText">&gt; User-space symbol tables are made available to the systemtap module</font><br>
<font class="QuotedText">&gt; only if it is required by the script - if it performs symbolic</font><br>
<font class="QuotedText">&gt; address or backtrace type lookups.</font><br>
<p>
Only if you buy the premise that the kernel has to be intimately involved in the trace instead of being a simple conduit for mediating it.<br>
<p>
<font class="QuotedText">&gt;&gt; and of having the kernel actually</font><br>
<font class="QuotedText">&gt;&gt; execute the compiled code to do the traps</font><br>
&gt;<br>
<font class="QuotedText">&gt; Like in dtrace, instrumentation is run within the kernel because</font><br>
<font class="QuotedText">&gt; having user-space processes instrument each other is too disruptive.</font><br>
<font class="QuotedText">&gt; We're looking for microsecond-level probe effect, not something</font><br>
<font class="QuotedText">&gt; involving multiple context switches, indirect address space accesses,</font><br>
<font class="QuotedText">&gt; and so on.</font><br>
<p>
Well, this would be the classic illustration of the problems systemtap faces.  Nothing on the above laundry list is impossible even if the kernel merely controls the traced process and lets userspace poke at it ... that, after all, is how gdb works.  The brick wall is that kernel developers don't think this is at all a compelling argument and apparently systemtap people think it is.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317172/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor317176"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 29, 2009 17:26 UTC (Thu)
                               by <b>fuhchee</b> (guest, #40059)
                              [<a href="/Articles/317176/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Um, just use a search</font><br>
<p>
I asked because I recall no serious debate about the two specific items ("process symbol tables in the kernel" and "having kernel ... execute code ... to do the traps") you listed.  Please humor fellow readers and give some links.<br>
<p>
<p>
<font class="QuotedText">&gt; &gt; User-space symbol tables are made available to the systemtap module</font><br>
<font class="QuotedText">&gt; &gt; only if it is required by the script</font><br>
<p>
<font class="QuotedText">&gt; Only if you buy the premise that the kernel has to be intimately involved </font><br>
<font class="QuotedText">&gt; in the trace instead of being a simple conduit for mediating it.</font><br>
<p>
There are many possible details behind such a summary.  If one wants dtrace-level introspection and manipulation, never mind going beyond it, some "intimate involvement" (kernel-side processing?) is necessary.  Merely "mediating" (data copying?) is not sufficient, since the choice of data and the nature of the programmed reaction is itself variable.<br>
<p>
<font class="QuotedText">&gt; [...] that, after all, is how gdb works. [...]</font><br>
<p>
The work involved in how gdb does its thing is several orders of magnitude heavier.<br>
<p>
<font class="QuotedText">&gt; The brick wall is that kernel developers don't think this is at all a </font><br>
<font class="QuotedText">&gt; compelling argument and apparently systemtap people think it is.</font><br>
<p>
Individual kernel people don't need to buy into every argument for systemtap to bloom.  We have promoted numerous "dual-use" kernel-side technologies that can stand on their own feet.  For example, with utrace, if you believe that user-space instrumentation is plausible, you should support utrace and forthcoming ("froggy" or "ubs"-like) layers on top, for dispatching those events to a hypothetical user-space handler.<br>
<p>
The details deserve more in-depth discussion.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317176/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor317817"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 3, 2009 22:41 UTC (Tue)
                               by <b>oak</b> (guest, #2786)
                              [<a href="/Articles/317817/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Well, this would be the classic illustration of the problems systemtap </font><br>
faces. Nothing on the above laundry list is impossible even if the kernel <br>
merely controls the traced process and lets userspace poke at it ... that, <br>
after all, is how gdb works.<br>
<p>
As to why to do it in kernel... Doing it from user space is just too slow.  <br>
Try e.g. get backtraces to mallocs through ptrace and you notice how <br>
infeasible this is from user-space (at least through the interface ptrace <br>
offers).  With the modern desktop apps that use malloc pretty heavily, the <br>
programs become unusable slow (in addition to their usability, also their <br>
functionality may suffer if they use timeouts for responses etc).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317817/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor317286"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A SystemTap update</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 10:31 UTC (Fri)
                               by <b>mjw</b> (subscriber, #16740)
                              [<a href="/Articles/317286/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Actuallly, only the user space tracing aspect of systemtap is dependent on these. You can still do kernel space tracing without them.</font><br>
<p>
Correct.<br>
<p>
<font class="QuotedText">&gt; We've spent quite a lot of effort explaining the problems with the utrace/uprobes dependency (especially the issues of having to pull the process symbol table into the kernel and of having the kernel actually execute the compiled code to do the traps).</font><br>
<p>
Could you post the problems you see?<br>
<p>
How a tracing tool like systemtap processes and uses the symbol table is kind of orthogonal from utrace and uprobes. utrace and uprobes might make it easier to access them during runtime. But that isn't what Systemtap currently does. If you want a tracer to do these things dynamically at trace event time, or even push the whole thing towards user space in reaction to trace events and hand it off to a user space helper then that is certainly a design choice you can make (unlike tracers, debuggers do this for example since they don't mind suspending the tracee for a longer period). The article does hint at why "offloading" this to a user space helper might not be practical (see the vfs example and the explanation of what might happen if you try to offload something like that to a perl script). But those are tradeoffs you can make independent of the infrastructure you use in the kernel to handle events and trace point insertion.<br>
<p>
<font class="QuotedText">&gt; There is hope that we might be able to go with a lighter weight infrastructure that simply vectors traps to the user space stap runtime and does all the interpreting in user space.</font><br>
<p>
Yes, there is nothing inherent in utrace or uprobes about how you handle trace events or how you use and insert vector traps into user space. That is the basic idea behind pushing them upstream, because they are useful apart from systemtap. They should also be useful for other tracers like connecting them to ftrace or lttng. You could even use them for a new debugger interface if you aren't interested in a no-overhead tracer. That is what the froggy project is exploring. It seems time to provide something better than the ptrace interface for debuggers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317286/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor317377"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">&quot;Client and server&quot;</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 30, 2009 23:25 UTC (Fri)
                               by <b>saffroy</b> (guest, #43999)
                              [<a href="/Articles/317377/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm really glad to see that the idea of the "client and server" to debug constrained platforms has caught. Systemtap, even when "only" used for kernel debugging, is way too good to be only for big servers where you can install large debug RPMs. Embedded platform developpers will bless such a tool when it becomes available!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/317377/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2009, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
