        <!DOCTYPE html>
        <html lang="en">
        <head><title>From O_MAYEXEC to trusted_for() [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/832959/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/833229/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/832959/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>From O_MAYEXEC to trusted_for()</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>October 1, 2020</br>
           </div>
The ability to execute the contents of a file is controlled by the
execute-permission bits — some of the time.  If a given file contains code
that can be executed by an interpreter — such as shell commands or code in a
language like Perl or Python, for example — there are easy ways to run the interpreter on
the file regardless of whether it has execute permission enabled or not.
Mickaël Salaün has been working on tightening up the administrator's
control over execution by interpreters for some time, but has struggled to
find an acceptable home for this feature.  His latest attempt takes the
form of a new system call named <tt>trusted_for()</tt>.
<p>
Tightly locked-down systems are generally set up to disallow the execution
of any file that has not been approved by the system's overlords.  That
control is nearly absolute when it comes to binary machine code, especially
when security modules are used to enforce signature requirements and prevent techniques
like mapping a file into some process's address space with execute
permission.  Execution of code by an interpreter, though, just looks like
reading a file to the kernel so, without cooperation from the interpreter
itself, the kernel cannot know whether an attempt is being made to execute
code contained within a given file.  As a result, there is no way to apply
any kernel-based policies to that type of access.

<p>
Enabling that cooperation is the point of Salaün's work; it is, at its
core, a way for an interpreter to inform the kernel that it intends to
execute the contents of a file.  Back in May 2020, the first attempt tried
to add
<a href="/Articles/820000/">an <tt>O_MAYEXEC</tt> flag</a> to be used with the <a
href="http://man7.org/linux/man-pages/man2/openat2.2.html"><tt>openat2()</tt></a>
system call.  If system policy does not allow a given file to be executed,
an attempt to open it with <tt>O_MAYEXEC</tt> will fail.
<p>
This feature was controversial for a number of reasons, but Salaün
persisted with the work; <a
href="/ml/linux-kernel/20200723171227.446711-1-mic@digikod.net/">version&nbsp;7
of the <tt>O_MAYEXEC</tt> patch set</a> was posted in August.  At that
point, Al Viro <a
href="/ml/linux-kernel/20200727042106.GB794331@ZenIV.linux.org.uk/">asked</a>,
in that special way he has, why this check was being added to 
<tt>openat2()</tt> rather than being made into its own system call.
Florian Weimer <a
href="/ml/linux-kernel/87y2n55xzv.fsf@oldenburg2.str.redhat.com/">added</a>
that doing so would allow performing checks on an already-open file; that
would enable interpreters to indicate an intent to execute code read from
their standard input, for example — something that <tt>O_MAYEXEC</tt>
cannot do.  Salaün <a
href="/ml/linux-kernel/eaf5bc42-e086-740b-a90c-93e67c535eee@digikod.net/">replied</a>
that controlling the standard input was beyond the scope of what he was
trying to do.
<p>
Nonetheless, he tried to address this feedback in <a
href="/ml/linux-kernel/20200908075956.1069018-1-mic%40digikod.net/">version&nbsp;8</a>,
which implemented a new flag (<tt>AT_INTERPRETED</tt>) for the proposed <a
href="/ml/linux-kernel/20200416143532.11743-1-mszeredi@redhat.com/"><tt>faccessat2()</tt></a>
system call instead.  That allowed the check to be performed on either a
file or an open file descriptor.  This attempt did not fly either, though,
with Viro <a
href="/ml/linux-kernel/20200909171316.GW1236603@ZenIV.linux.org.uk/">insisting</a>
that a separate system call should be provided for this feature.  This
approach also introduced a potential race condition if an attacker could
somehow change a file between the <tt>faccessat2()</tt> call and actually
opening the file.  So Salaün <a
href="/ml/linux-kernel/2ed377c4-3500-3ddc-7181-a5bc114ddf94@digikod.net/">agreed</a>
to create a new system call for this functionality.
<p>
Thus, <a
href="/ml/linux-kernel/20200910164612.114215-1-mic@digikod.net/">the ninth
version</a> introduced <tt>introspect_access()</tt>, which would ask the kernel
if a given action was permissible for a given open file descriptor.  There
comes a point in kernel development (and beyond) when one can tell that the
substantive issues have been addressed: when everybody starts arguing about
naming instead.  That is what happened here; Matthew Wilcox <a
href="/ml/linux-kernel/20200910170424.GU6583@casper.infradead.org/">didn't
like the name</a>, saying that checking policy on a file descriptor is not
really "introspection".  Various suggestions then flew by, including
<tt>security_check()</tt>,
<tt>interpret_access()</tt>,
<tt>entrusted_access()</tt>,
<tt>fgetintegrity()</tt>,
<tt>permission()</tt>,
<tt>lsm()</tt>,
<tt>should_faccessat()</tt>, and more.
<p>
In <a href="/ml/linux-kernel/20200924153228.387737-1-mic@digikod.net/">the
tenth version</a>, posted on September&nbsp;24, Salaün chose none of
those.  The proposed new system call is now:
<p>
<pre>
    int trusted_for(const int fd, const enum trusted_for_usage usage,
                    const unsigned int flags);
</pre>
<p>
The <tt>fd</tt> argument is, of course, the open file descriptor, while
<tt>usage</tt> describes what the caller intends to do with that file
descriptor; in this patch set, the only possible option is
<tt>TRUSTED_FOR_EXECUTION</tt>, but others could be added in the future.
There are no flags defined, so the <tt>flags</tt> argument must be zero.
The return value is zero if the 
system's security policy allows the indicated usage, or <tt>EACCES</tt>
otherwise.  In the latter case, it is expected that the caller will refuse
to proceed with executing the contents of the file.
<p>
The patch also adds a new sysctl knob called <tt>fs.trust_policy</tt> for
setting a couple of policy options.  Setting bit zero disables execution
access for files located on a filesystem that was mounted with the
<tt>noexec</tt> option; bit one disables execution for any file that does
not have an appropriate permission bit set.  Both of these are checks that
are not made by current kernels.  There are no extra
security-module hooks added at this time, but that would appear to be the
plan in the future; that will allow more complex policies and techniques like
signature verification to be applied.
<p>
This time around, even the name of the system call has avoided complaints —
as of this writing, at least.  So it may just be that this long-pending
feature will finally make its way into the mainline kernel.  That is not a
complete solution to the problem, of course.  Security-module support will
eventually be needed, but also support within the interpreters themselves.
That will require getting patches accepted into a variety of user-space
projects.  Fully locking down access to files by interpreters, in other
words, is going to take a while yet.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-Virtual_filesystem_layer">Filesystems/Virtual filesystem layer</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Language_interpreters">Security/Language interpreters</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/832959/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor833268"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2020 21:10 UTC (Thu)
                               by <b>zev</b> (subscriber, #88455)
                              [<a href="/Articles/833268/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      The cover letter of the patch series mentions things like modifying the python interpreter to disable <code>-c</code>, but if you can control a shell enough to attempt <code>python -c "$(cat foo.py)"</code> as a workaround for not being able to run <code>python foo.py</code> directly, why not just have the shell do your evil bidding itself?

<br><br>

What exactly even defines an interpreter though anyway?  Or execution of code?  As soon as you've got a data-dependent conditional branch, the line between data and code starts to melt into much more of a continuous spectrum.

      
          <div class="CommentReplyButton">
            <form action="/Articles/833268/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833274"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 1, 2020 21:58 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/833274/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; What exactly even defines an interpreter though anyway? Or execution of code?</font><br>
<p>
My understanding of this entire effort is that these questions are fundamentally userspace&#x27;s problem. If the Python interpreter tells the kernel &quot;I want to execute this file,&quot; then that counts as &quot;executing&quot; that file. If the Python interpreter does not so indicate, then it doesn&#x27;t count. As far as the kernel is concerned, userspace is a black box that can call trusted_for() whenever it wants, and the kernel gives it answers based on security policies, in the same way as userspace can call flock() whenever it wants, and the kernel gives it answers based on previous calls to flock(). flock() is not enforced in any meaningful way; it&#x27;s up to userspace to decide what it means and when it ought to be called.<br>
<p>
In practice, I would imagine that it will be completely impractical for Python to audit all possible instances of code being evaluated at runtime, *and* tie those audit events back to an identifiable file or file descriptor (for example, if the user does exec(open(&quot;foo.py&quot;).read()), how does exec() know what file that string came from?). The former is already in PEP 578, but the latter does not seem possible from my understanding of how Python actually works. So instead, you basically have two options:<br>
<p>
1. Some kind of &quot;restricted mode Python,&quot; which would disable most runtime code-evaluation altogether unless it can be directly tied to a file (but see <a href="https://www.python.org/dev/peps/pep-0578/#why-not-a-sandbox">https://www.python.org/dev/peps/pep-0578/#why-not-a-sandbox</a>).<br>
2. Put Python inside of a container, VM, or hypervisor, and use that as your security boundary instead of trying to lock down Python.<br>
<p>
IMHO #2 is by far the most straightforward approach to something like this. It does not require any changes to either Python or the kernel. But there are certainly other interpreted languages that are easier to lock down than Python, and defense in depth is a good idea anyway, so this is probably still worth doing regardless of factors specific to Python.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833274/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor833287"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 5:15 UTC (Fri)
                               by <b>comex</b> (subscriber, #71521)
                              [<a href="/Articles/833287/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I can think of two possibilities; both pretty marginal though:<br>
<p>
- Preventing attackers from pivoting from some limited or unstable form of ‘code execution’, like return-oriented programming after exploiting some C code, to a more flexible and stable Python script.  But ROP is Turing complete, so there’s no real *need* to pivot in the first place; it’s just more convenient for an attacker.<br>
<p>
- Guarding against some kind of command injection vulnerability that involves arguments directly passed to execve() or similar rather than going through a shell.  But that would be a very unusual vulnerability.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833287/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor833290"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 5:42 UTC (Fri)
                               by <b>richiejp</b> (guest, #111135)
                              [<a href="/Articles/833290/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because most people won&#x27;t understand the security implications of using `-c` in a shell script. You have to put up barriers to people taking the insecure path.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833290/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833293"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 7:13 UTC (Fri)
                               by <b>zarak</b> (guest, #132244)
                              [<a href="/Articles/833293/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can you elaborate the issue with `-c` in a script ? I must be part of &quot;most people&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833293/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 8:38 UTC (Fri)
                               by <b>richiejp</b> (guest, #111135)
                              [<a href="/Articles/833296/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well the problem is not with -s in general, but using it when you could pass the file name instead. If you load the script contents into memory with `cat` and then pass it as an argument to Python with -s, Python can&#x27;t check the original file with `trusted_for`. It either has to assume the script is trusted, disable -s or sh/cat needs to check the permissions before passing the data to Python. I suppose there is the same issue with passing data on stdio, which is mentioned in the article.<br>
<p>
Also, on a partially related note, there was some buffer overflow or &quot;stack smashing&quot; attack involving large command lines and now the linux command line length is much more limited to prevent that, so you probably don&#x27;t want to use `-s` in shell scripts unless it is a string of known length generated in the script or static.<br>
<p>
BTW &quot;most people&quot; includes myself when I&#x27;m in a less trusted state.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 8:41 UTC (Fri)
                               by <b>richiejp</b> (guest, #111135)
                              [<a href="/Articles/833298/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I mean -c not -s xD<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor835970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 20:53 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/835970/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
Also, on a partially related note, there was some buffer overflow or "stack smashing" attack involving large command lines
</blockquote>
This was incredibly annoying and continues to break my workflows to this day, but apparently not breaking userspace doesn't apply when it can be abused by attackers and it might be inconvenient to fix it.
      
          <div class="CommentReplyButton">
            <form action="/Articles/835970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor833310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 11:41 UTC (Fri)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/833310/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The shell is less powerful than Python, e.g. as far as I know, you can&#x27;t open TCP connections to remote sites from the shell without using external programs like curl, wget, netcat, etc. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833311"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 12:40 UTC (Fri)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/833311/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I thought so, too.  Until I ran "man bash", and found:

<pre>
       Bash handles several filenames specially when they are used in redirec‐
       tions, as described in the following table.  If the operating system on
       which bash is running provides these special files, bash will use them;
       otherwise it will emulate them internally with the  behavior  described
       below.

              /dev/tcp/host/port
                     If host is a valid hostname or Internet address, and port
                     is  an integer port number or service name, bash attempts
                     to open the corresponding TCP socket.
              /dev/udp/host/port
                     If host is a valid hostname or Internet address, and port
                     is  an integer port number or service name, bash attempts
                     to open the corresponding UDP socket.
</pre>

And it works!
<pre>
machineA$ nc -l -p 8000

machineB$ echo hello &gt; /dev/tcp/machineA/8000
</pre>


      
          <div class="CommentReplyButton">
            <form action="/Articles/833311/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833361"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 2, 2020 15:30 UTC (Fri)
                               by <b>mwsealey</b> (guest, #71282)
                              [<a href="/Articles/833361/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If the operating system on which bash is running provides these special files, bash will use them; otherwise it will emulate them internally</font><br>
<p>
About time for someone to write a system-level /dev/tcp and /dev/udp... isn&#x27;t this something systemd-networkd should provide?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833361/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor833405"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2020 4:38 UTC (Sat)
                               by <b>martin.pitt</b> (subscriber, #26246)
                              [<a href="/Articles/833405/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I totally don&#x27;t see the point of this entire approach. As the author admits himself, this is super-easy to work around, and there is not even a well-defined goal. There may be embedded systems where the user is not supposed to do arbitrary stuff, but then disable login or bash/python/awk/sed/perl/etc. But this doesn&#x27;t work with standard distros obviously. <br>
<p>
If you want to lock down a system, protect the filesystem/OS *objects* with MAC like SELinux or AppArmor, and restrict resource usage with cgroups. That&#x27;s a proven and robust path. Whereas this is just dead weight and snake oil, sorry. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833405/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2020 7:03 UTC (Sat)
                               by <b>dxin</b> (guest, #136611)
                              [<a href="/Articles/833417/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
 &gt;There may be embedded systems where the user is not supposed to do arbitrary stuff<br>
<p>
That&#x27;s the entire Android ecosystem BTW, aka 90%+ of Linux users. I&#x27;m pretty sure the need for this comes from Android as it&#x27;s the only distro that has complete control over the entire FS. For any other distro that control is partially in the hands of admins and partially in the users&#x27;.<br>
<p>
The usecase is pretty clear IMO. The interpreter wants to know if it should proceed to execute a script. Until this feature there&#x27;s simply nowhere to ask. To take full advantage of this feature of course every interpreter that ships with the distro will be patched to disable execuating from stdin and respect what kernel returns from trusted_for().<br>
<p>
TBH it&#x27;s kind of a design mistake for an interpreter to not check for execute flag from the beginning.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833437"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2020 19:58 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/833437/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; TBH it&#x27;s kind of a design mistake for an interpreter to not check for execute flag from the beginning.</font><br>
<p>
The only way (that I know of) to do that is to call access(2), which has a Big Honking Warning telling you not to use it as a security boundary because of TOCTTOU races.<br>
<p>
Sure, you can call fstat(2) and manually evaluate the mode bits against the EUID, but then the operating system cannot enforce filesystem noexec and similar policies, which the Android people almost certainly want to do. So instead the interpreter has to know about every system-level policy that might possibly want to restrict execute permission, for every platform where it runs, and manually check them all one at a time, which is gross and uncivilized. Much better to just ask the kernel &quot;Hey, can I execute that?&quot; - exactly the question trusted_for() is intended to answer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833437/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833445"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2020 23:09 UTC (Sat)
                               by <b>MrWim</b> (subscriber, #47432)
                              [<a href="/Articles/833445/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <code>access("/proc/self/fd/n", X_OK)</code> should be safe from TOCTTOU I would have thought.
      
          <div class="CommentReplyButton">
            <form action="/Articles/833445/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833617"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 6, 2020 16:38 UTC (Tue)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/833617/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you&#x27;re right, but I can still think of a number of problems with this:<br>
<p>
- euidaccess(3) appears to fall back to mode bits if uid != euid. The version I looked at doesn&#x27;t even check for EROFS in this case (a fact which is conveniently omitted from the man page). But interpreters probably shouldn&#x27;t be setuid in the first place.<br>
- stdin might be a tty/pty, an anonymous pipe, etc., which are non-executable on most systems most of the time. But most interpreters want to treat a tty, at least, as if it were executable (because otherwise you can&#x27;t have a REPL), so now you have to figure out whether to allow any other stdin-related exceptions, and if so, how to check for them.<br>
- You need proc to be mounted and accessible.<br>
- /proc/[pid]/fd is Linux-specific. So is trusted_for(), but trusted_for() was specifically designed for this individual use case, while /proc was not, so interpreters would have had to foresee that this extra permissions enforcement would be useful on Linux in particular. They would be unable to do it on systems that lacked a /proc or lacked a /proc/[pid]/fd.<br>
- I&#x27;m having some difficulty figuring out exactly when /proc/[pid]/fd was introduced. For very old interpreters, it might not have been available at the time they made this decision (especially for languages that originated on a pre-Linux Unix).<br>
<p>
And the single most important reason:<br>
<p>
- Most people are going to read the access/euidaccess man pages, which tell you not to use them, and then they will conclude that you should not use them. This is the same problem that /dev/urandom had.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833617/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 7, 2020 6:46 UTC (Wed)
                               by <b>zev</b> (subscriber, #88455)
                              [<a href="/Articles/833635/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <i>stdin might be a tty/pty, an anonymous pipe, etc., which are non-executable on most systems most of the time. But most interpreters want to treat a tty, at least, as if it were executable (because otherwise you can't have a REPL), so now you have to figure out whether to allow any other stdin-related exceptions, and if so, how to check for them.</i>

<br>
<br>

On the kinds of systems this is (I guess?) purportedly targeted at, I'd expect losing REPL functionality wouldn't be considered a problem.

<br>
<br>

However, that in turn makes me wonder if they might be better served by eliminating the general-purpose interpreter binary entirely and replacing each script that depends on it with the equivalent of

<pre>
#include &lt;Python.h&gt;
int main(void) { PyRun_SimpleString("...script source code..."); }
</pre>

(A partial application of the script to the interpreter, basically.)  Seems like it'd be a much more foolproof approach.

      
          <div class="CommentReplyButton">
            <form action="/Articles/833635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833732"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2020 3:29 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/833732/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You would also need to C-ify every single .py file in both the standard library and all of your external dependencies. Since you can&#x27;t use PyRun_SimpleString() for anything that doesn&#x27;t live in __main__, this quickly becomes a lot more complicated than what you describe.<br>
<p>
Cython can *mostly* do that work automatically, but I don&#x27;t think they&#x27;ve yet managed to reach perfect 1:1 compatibility with pure Python modules, so you would need to run a battery of unit tests over the resulting output to be sure it actually works.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833732/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor833440"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 3, 2020 21:34 UTC (Sat)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/833440/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With this kind of interface, it&#x27;s less clear why the kernel is even involved. Couldn&#x27;t this check be performed in userspace, by querying some kind of userspace policy daemon? If a userspace daemon can&#x27;t get enough information to determine whether the access should be allowed, perhaps userspace should be given that information in some way...<br>
<p>
Maybe that sounds excessively micro-kernel-y, but this whole scheme will require a carefully tuned and controlled userspace anyway...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833440/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 6, 2020 5:14 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/833556/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If a userspace daemon can&#x27;t get enough information to determine whether the access should be allowed, perhaps userspace should be given that information in some way...</font><br>
<p>
You mean by adding a trusted_for() system call?  ;)<br>
<p>
Sorry, could not resist.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor833618"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 6, 2020 16:31 UTC (Tue)
                               by <b>jamesmorris</b> (subscriber, #82698)
                              [<a href="/Articles/833618/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One use-case is the flag then being used by an LSM (e.g. IPE) to cause the file to be integrity-verified.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833618/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833619"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 6, 2020 16:48 UTC (Tue)
                               by <b>sbaugh</b> (guest, #103291)
                              [<a href="/Articles/833619/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That could happen in user space too, though, couldn&#x27;t it? Can&#x27;t user space query the integrity-verified-status of a file?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833619/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833739"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2020 6:16 UTC (Thu)
                               by <b>jamesmorris</b> (subscriber, #82698)
                              [<a href="/Articles/833739/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, but this crosses a trust boundary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833739/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor833738"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 8, 2020 5:21 UTC (Thu)
                               by <b>skx</b> (subscriber, #14652)
                              [<a href="/Articles/833738/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>It is funny you say that, because I wrote a Linux Security Module which does almost exactly that:</p>
<ul>
<li>Every time the kernel tries to execute a binary..</li>
<li>I calls back to user-space to run a "is this permitted" executable.</li>
<li>If the user-space program returns 0 the execution is permitted, otherwise it is denied.</li>
</ul>
<p>On the one hand this is horrific, on the other hand it does work.  It would allow you to write policies in userspace.</p>
<p>The overhead is high, for every executable that is launched you have to also launch the policy-program.</p>
<p>No chance in hell of this getting merged into the kernel, so I didn't even try, but I had fun learning:</p>
<ul>
<li><a href="https://github.com/skx/linux-security-modules/tree/master/security/can-exec">https://github.com/skx/linux-security-modules/tree/master/security/can-exec</a></li>
</ul>
      
          <div class="CommentReplyButton">
            <form action="/Articles/833738/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor833934"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 9, 2020 23:18 UTC (Fri)
                               by <b>sbelmon</b> (subscriber, #55438)
                              [<a href="/Articles/833934/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m baffled. Since the interpreter has to cooperate anyway, why not have it check some setting in /etc that says &quot;hey, interpreters, don&#x27;t run any script that isn&#x27;t +x&quot;?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833934/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor833937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 10, 2020 2:15 UTC (Sat)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/833937/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just leaving it up to the interpreters to do validation means you can&#x27;t do signature validation without implementing equivalent code in every interpreter. Passing information up to the kernel lets you apply an appropriate IMA check instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/833937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor835972"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 3, 2020 21:01 UTC (Tue)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/835972/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Hm. Don&#x27;t like that syscall much. Not because of the name, though:<br>
<p>
 - what&#x27;s with all the const? Const applied to pointers is meaningful. Const applied to integers... it has no effect, but it doesn&#x27;t even feel like useful for documentation purposes. I can&#x27;t figure out what it might mean even conceptually. You can&#x27;t modify this... integer constant? Well, no, you generally can&#x27;t mutate abstract mathematical entities like integers without being God (or older FORTRAN ;) ).<br>
 - is it sane to use enums in system calls, given that their bit-width is implementation-defined and can change merely because you *add values* to the enumeration?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/835972/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor836779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2020 17:09 UTC (Tue)
                               by <b>ksandstr</b> (guest, #60862)
                              [<a href="/Articles/836779/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The consting applied to parameters passed by value is just noise. And the enum issue applies in userspace alone, since the user-to-kernel syscall interface promotes integral-typed parameters to native word size anyway; so the manpage trusted_for(2) would specify that as an int.<br>
<p>
Sort of smells like a literal-minded machine translation of a completely different language, in fact.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/836779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor836807"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2020 22:31 UTC (Tue)
                               by <b>anselm</b> (subscriber, #2796)
                              [<a href="/Articles/836807/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><em>
Const applied to integers... it has no effect, but it doesn't even feel like useful for documentation purposes. I can't figure out what it might mean even conceptually.
</em></blockquote>
<p>
Hm. No effect?
</p>
<pre>
$ cat t.c
void foo(int k) {
    k++;
}

void cfoo(const int k) {
    k++;
}
$ gcc t.c
t.c: In function ‘cfoo’:
t.c:6:6: error: increment of read-only parameter ‘k’
    6 |     k++;
      |      ^~
</pre>
<p>
Looks like you don't get to change a <tt>const int</tt> parameter inside a function. This doesn't seem to require huge conceptual leaps.
</p>
<p>
As far as the C language is concerned, it's OK to change the (non-<tt>const</tt>) <tt>int</tt> parameter inside the <tt>foo()</tt> function, if one doesn't mind that the caller of <tt>foo()</tt> never sees the change. In effect, the parameter is just another local variable.
</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/836807/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor836935"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2020 0:29 UTC (Thu)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/836935/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Const in a <em>declaration</em> is what's meaningless (and ignored by the compiler).
<p>
E.g. if you have a declaration in a header:
<pre>
void foo(const int k);
</pre>

You can still entirely validly and correctly have the implementation:
<pre>
void foo(int k) {
    k++;
}
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/836935/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor837983"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">From O_MAYEXEC to trusted_for()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2020 22:12 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/837983/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Aha! Thank you: as with so many decades-old misconceptions this one is really obvious in hindsight once pointed out.<br>
<p>
Occasionally I fall into the trap of thinking I know a lot about C, and then something dead obvious and simple like this pops up and I realise I know nothing.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/837983/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
