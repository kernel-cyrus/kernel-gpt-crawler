        <!DOCTYPE html>
        <html lang="en">
        <head><title>Some upcoming memory-management patches [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/875587/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/875756/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/875587/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Some upcoming memory-management patches</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Benefits for LWN subscribers</b>
<p>
The primary benefit from <a href="/Promo/nst-nag5/subscribe">subscribing to LWN</a>
       is helping to keep us publishing, but, beyond that, subscribers get
       immediate access to all site content and access to a number of extra
       site features.  Please sign up today!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 12, 2021</br>
           </div>
The memory-management subsystem remains one of the most complex parts of
the kernel, with an ongoing reliance on various heuristics for
performance.  It is thus not surprising that developers continue to try to
improve its functionality.  A number of memory-management patches are
currently in circulation; read on for a look at the freeing of page-table
pages, <tt>kvmalloc()</tt> flags, memory clearing, and NUMA "home nodes".
<p>

<h4>Freeing page-table pages</h4>
<p>
When user space allocates memory, the kernel,  obviously, must find pages to
satisfy that allocation.  But it must also allocate page-table pages to
handle the mapping of addresses to the newly allocated memory.  For a
system with 4KB pages and 64-bit addresses, one page-table page is needed
for every 512 ordinary pages of memory (assuming huge pages are not in
use).  For applications with massive address spaces, the amount of memory
used just for page-table pages can be significant.
<p>
That memory can end up being wasted if the user-space pages are reclaimed,
perhaps in response to an <a
href="https://man7.org/linux/man-pages/man2/madvise.2.html"><tt>madvise()</tt></a>
call.  Those pages will be removed from the working set, but the page-table
pages that mapped them will remain allocated.  If all of the pages mapped
by a given page-table page have been reclaimed, the page-table page itself
will be empty and serving no purpose.  Applications that allocate, then free,
large ranges of memory can accumulate a lot of these useless page-table
pages, which is less than optimal.
<p>
<a href="/ml/linux-kernel/20211110105428.32458-1-zhengqi.arch@bytedance.com/">This
patch set</a> from Qi Zheng aims to fix that problem.  It works by adding a
reference count for page-table pages (via yet another overloaded field in
<tt>struct page</tt>).  Users of the page, such as page-fault handlers,
will increment that reference count, ensuring that the page stays around while
they do their work.  Adding a page-table entry for a user-space page will
also increase the reference count, while reclaiming a page will cause the
reference count to be decremented.  If the reference count drops to zero,
the kernel knows that the page-table page does not actually contain any
page-table entries and can be freed.
<p>
Test results included with the patch set show that, indeed, reclaiming
empty page-table pages can free up a lot of memory for other uses.  On the
other hand, there is an impact on the page-fault handlers that makes itself
felt in a couple of ways.  One, of course, is the overhead of maintaining
the reference counts as page-table entries are added.  But there is also a
cost to freeing a page-table page, then having to allocate a new one should
that part of the address space become populated again.  Overall, the result
is an approximately 1% performance hit in page-fault handling.
<p>
That cost may be more than some users want to bear.  For now, though, there
is no associated knob to turn this behavior off; if this patch set is
merged, all systems will free empty page-table pages.  Chances are, in any
situation where large numbers of page-table pages are affected, performance
gain from freeing all of that memory will exceed the page-fault costs, but
that may not hold for other types of applications.
<p>
<h4>More flags in <tt>vmalloc()</tt></h4>
<p>
Kernel memory allocated with <tt>vmalloc()</tt> must be mapped into a
special part of the kernel's address space.  Unlike memory from
<tt>kmalloc()</tt> or the page allocator, it is not accessed directly via
the kernel's direct memory mapping.  Use of <tt>vmalloc()</tt> was, at one
time, discouraged; the address space available in the <tt>vmalloc()</tt>
area was small, and there is an extra cost to creating the additional
mappings.  Over time, though, use of <tt>vmalloc()</tt> has grown.  The
advent of 64-bit systems has eliminated the address-space limitation, and
there are increasing numbers of places in the code where multi-page
allocations are needed.  The chances of successfully allocating a
multi-page buffer are much higher if the pages involved need not be located
in physically contiguous memory.
<p>
The <tt>vmalloc()</tt> interface, however, has never supported the various
<tt>GFP_*</tt> flags passed to <tt>kmalloc()</tt> to influence how the
memory is allocated; this limitation persists in add-on functions like
<tt>kvmalloc()</tt>, which attempts a <tt>kmalloc()</tt> call with a
fallback to <tt>vmalloc()</tt> on failure.  This has proved to be a real
problem for some kernel subsystems, especially filesystems, that need to
be able to allocate memory with flags like <tt>GFP_NOFS</tt>,
<tt>GFP_NOIO</tt>, or <tt>GFP_NOFAIL</tt>.  As a result, some filesystems
have avoided <tt>kvmalloc()</tt>, while others, such as Ceph, have rolled
their own memory-allocation functions to work around the problem.
<p>
Michal Hocko has <a
href="/ml/linux-kernel/20211025150223.13621-5-mhocko@kernel.org/">addressed
this problem</a> with a patch set adding support for the above
<tt>GFP_</tt> flags to the <tt>vmalloc()</tt> subsystem, and to
<tt>kvmalloc()</tt> specifically.  That makes these functions useful in
filesystem settings, and allows the removal of Ceph's special allocation
function.  As of this writing, one of the precursor patches from that set
has made it to the mainline, but the rest have not yet been merged.  That
may well change before the end of the 5.16 merge window, stay tuned.
<p>
<h4>Uncached memory clearing</h4>
<p>
Modern computers make heavy use of memory caches for one simple reason:
caches improve performance.  So it is interesting to see <a
href="/ml/linux-kernel/20211020170305.376118-1-ankur.a.arora@oracle.com/">this
patch set</a> from Ankur Arora that claims to improve memory performance by
<i>bypassing</i> caching.  As one might expect, this is an improvement that
only works in specific circumstances.
<p>
If the kernel needs to zero out a single page of memory, a series of
normal, cached writes will almost certainly be the way to go.  That allows
the cached writes to be flushed to main memory at the system's
convenience.  A newly zeroed page is also fairly likely to have other data
written to it in short order; having that page in cache will speed those
writes, and may eliminate the need to write the initial zeroes out to
memory at all.  Caching is, thus, a performance win here.
<p>
The situation changes, though, when large amounts of memory need to be
cleared.  If the amount of memory to clear exceeds the size of the
last-level cache, it turns out to be faster to just write directly to
memory rather than wait for all of those zeroes to be flushed out of the
cache.  Such a large write will also flush everything else out of the
cache, and some of that data is likely to be wanted in the near future.
So, for large clearing operations, bypassing the cache seems like the
better way to go.
<p>
Arora's patch set thus changes the kernel to use uncached writes whenever a
huge (2MB) or gigantic (1GB) page is to be cleared.  This kind of operation
happens frequently in systems running virtualized guests; a new guest
starts off with a range of zeroed memory hosted, when possible, on huge or
gigantic pages.  Test results included with the patch set show performance
improvements of 1.6x to 2.7x for virtual-machine creation.  That would seem
to be good enough to justify making this change.
<p>
<h4>Setting a home NUMA node</h4>
<p>
NUMA systems are characterized by the fact that memory located on the local
NUMA node (or a nearby node) is faster to access than memory on a remote
node.  That means there can be considerable scope for performance
improvements by controlling which nodes are used for memory allocations.
The kernel provides a number of ways of controlling these allocations,
including the recently added <tt>MPOL_PREFERRED_MANY</tt>, which was <a
href="/Articles/862707/">covered here</a> in July.
<p>
Aneesh Kumar K.V. would like to <a
href="/ml/linux-mm/20211101050206.549050-1-aneesh.kumar@linux.ibm.com/">add
another one</a>, though, in the form of a new system call:
<p>
<pre>
    int set_mempolicy_home_node(unsigned long start, unsigned long len,
    				unsigned long home_node, unsigned long flags);
</pre>
<p>
This system call will set the "home node" for the <tt>len</tt> bytes of
address space beginning at <tt>start</tt> to the NUMA node number passed in
<tt>home_node</tt>.  The
<tt>flags</tt> argument is currently unused.
<p>
The home node is meant to be used in combination with the
<tt>MPOL_PREFERRED_MANY</tt> or <tt>MPOL_BIND</tt> memory-allocation
policies.  Those policies can specify a set of nodes that are to be used
for new memory allocations, but do not say anything about which of those
nodes, if any, is the preferred one.  If a home node has been set with
<tt>set_mempolicy_home_node()</tt>, allocations will happen on that node if
possible; failing that, the kernel will fall back to one of the other nodes
allowed by the in-force policy, preferring the node that is closest to the
home node.
<p>
The intent is to give applications a bit more control over memory
allocations while avoiding memory from slow nodes.  No word yet on when the
NUMA developers will throw in the towel and just have user space provide a
BPF program to direct memory-allocation policies.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-GFP_flags">Memory management/GFP flags</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-NUMA_systems">Memory management/NUMA systems</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-Scalability">Memory management/Scalability</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#vmalloc">vmalloc()</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/875587/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor875946"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2021 18:03 UTC (Fri)
                               by <b>NHO</b> (guest, #104320)
                              [<a href="/Articles/875946/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Any of them builds upon folio work?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875946/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor875974"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2021 23:02 UTC (Fri)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/875974/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, these are all orthogonal.  I have two folio-related patchsets currently in progress for the next merge window.<br>
<p>
The first is for iomap/xfs. That&#x27;s a series of about 25 patches that readies XFS to use multi-page folios. That&#x27;s been through a couple of rounds of reviews.<br>
<p>
The second series is for the page cache. There are a number of places that aren&#x27;t yet ready to handle multi-page folios. I haven&#x27;t posted it yet because my testing found a problem when using PMD pages in shmem/tmpfs.<br>
<p>
After that (ie the next merge window), I&#x27;ll be pushing the patches to create multi-page folios during readahead.<br>
<p>
Other people are also working on folio patches. eg Dave Howells is foliating AFS, Ceph, and 9P. There&#x27;s also interest from other filesystems, although I don&#x27;t know what will be ready for next merge window.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875974/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor875980"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 6:42 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/875980/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Dave Howells is foliating</font><br>
<p>
Did you name it &quot;folio&quot; just to be able to type &quot;foliating&quot;?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875980/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor875982"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 8:44 UTC (Sat)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/875982/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Will each page in a folio be called a follicle?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875982/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor876002"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 16:26 UTC (Sat)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/876002/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Dave came up with that one. I&#x27;d been saying &quot;convert to folios&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876002/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor876236"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 16, 2021 17:08 UTC (Tue)
                               by <b>acarno</b> (subscriber, #123476)
                              [<a href="/Articles/876236/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This also means that someday if the name &quot;folio&quot; is changed, folks will need to &quot;exfoliate&quot; the code ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876236/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2021 23:39 UTC (Sun)
                               by <b>Paf</b> (subscriber, #91811)
                              [<a href="/Articles/876063/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know I’m asking for something that will be forthcoming shortly, but any idea of the nature and scale of some of the performance gains?  This sort of batching is extremely exciting in general.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor875970"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2021 22:03 UTC (Fri)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/875970/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The page table reference count patch is a great start on something I&#x27;ve been meaning to fix for ages now: page tables *themselves* should be copy-on-write.<br>
<p>
Right now, when a process forks, the child process shares its *data* pages with its parent, but it gets its own private copy of the page *tables*. (We call copy_page_range(() in dup_mmap()). On Android, processes are forked from Zygote. Even a simple flashlight is paying hundreds of KB just for page tables even those page tables describe exactly the same memory layout that those in the parent process do! Even a tiny flashlight app pays almost a megabyte just in page tables. Why should it?<br>
<p>
(Granted, copy_page_range() skips copying PTEs for file-backed VMAs --- but even anonymous PTEs waste a lot of shareable memory.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875970/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor875979"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 6:32 UTC (Sat)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/875979/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Could it make sense, shorter term, to use explicit huge pages in parts of zygote to reduce page table size?<br>
<p>
I&#x27;d imagine making the page table itself COW has some interesting concurrency challenges? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875979/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor875995"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 13:44 UTC (Sat)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/875995/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Huge pages have various problems with page management, e.g. being swapped to zram.<br>
<p>
What I really want to see on Android --- and desktop/server too, actually --- is a migration away from 4KB pages to 16KB pages. iOS made this migration years ago and it worked fine. 4KB is just too small for modern systems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/875995/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876001"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 16:25 UTC (Sat)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/876001/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s what folios does ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876001/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876019"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2021 23:28 UTC (Sat)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/876019/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Folios doesn&#x27;t literally program the system MMU to operate in 16KB-page mode... does it?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876019/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2021 0:30 UTC (Sun)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/876020/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No. A lot of people make the mistake of thinking that&#x27;s important. The important thing is reducing the software overhead of managing memory in such tiny fragments. It&#x27;s not necessary to go all the way to 2MB on x86 to see huge wins. If we manage memory in 64kB chunks, that makes the LRU list 16x shorter. We free 16x as much memory at once. We hold LRU list locks for 16x less time.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876022"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2021 0:34 UTC (Sun)
                               by <b>dancol</b> (guest, #142293)
                              [<a href="/Articles/876022/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s *also* important to reduce the actual amount of memory that page tables occupy. Both things can be important. I&#x27;m sure folios is very nice, but it doesn&#x27;t solve the problem I&#x27;m talking about. Page tables can, *in principle*, be CoWed. I know it&#x27;s hard to get there, but there&#x27;s no theoretical barrier.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876022/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2021 14:28 UTC (Sun)
                               by <b>willy</b> (subscriber, #9762)
                              [<a href="/Articles/876039/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, I didn&#x27;t realise you were talking about saving memory by increasing the amount of memory represented by a PTE.<br>
<p>
It&#x27;s far from being a guaranteed win. I&#x27;ve seen various benchmarks regress when using 64kB pages on ARM. I haven&#x27;t seen those benchmarks run with a 16kB page size, so it&#x27;s possible that 16kB are the current sweet spot and 64kB are too big. It&#x27;s also possible that those benchmarks have no relevance to the phone use case.<br>
<p>
I have reservations about CoWing page tables. They&#x27;re going to improve some situations and regress others. Many benchmarks will be needed to convince people that it&#x27;s a net win.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2021 7:52 UTC (Mon)
                               by <b>joib</b> (subscriber, #8541)
                              [<a href="/Articles/876073/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
AFAIU most high end CPU&#x27;s have various optimizations for TLB entries representing consecutive pages. So even if you realistically can&#x27;t change the base page size for backwards compatibility reasons, the CPU can avoid a lot of the overhead of processing each entry in isolation. So if the folios related work could help reduce fragmentation, that could give a performance boost.<br>
<p>
I&#x27;m far from an expert on this topic, but one thing I&#x27;ve wondered about is why does the kernel keep track of each page individually, rather than some kind of extents-like structure similar to how filesystems keep track of disk blocks. AFAICS folios doesn&#x27;t change this, but rather folio is a new name for a head page. Or is the idea to eventually move in a direction like this, or is it unworkable for some reason? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 24, 2021 16:49 UTC (Wed)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/876801/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>AFAIU most high end CPU's have various optimizations for TLB entries representing consecutive pages.</blockquote>

Reference needed.  I am not an expert, either, but I have not heard of such optimizations on Intel and AMD CPUs, and I have seen big slowdowns when needing more than 512 pages on an Ivy Bridge (where the L2 TLB has 512 entries), so whatever the optimization is, it does not extend the reach of the TLB.  IIRC Alpha supported power-of-8 page granularity (rather than power-of-512) with 8KB as minimal granularity, but it's dead.  Also in the 1990s some of the Cyrix CPUs supported power-of-2 page granularity, but it did not catch on.

<p>Somehow computer architecture seems to have settled on 4KB pages, with RISC-V being the latest architecture to embrace this page size.  Only Apple is diverging, but they have their own universe anyway.



      
          <div class="CommentReplyButton">
            <form action="/Articles/876801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor876812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 24, 2021 19:43 UTC (Wed)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/876812/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
maybe someone is just using a really out of date version of Hennesy and Patterson?<br>
<p>
The MIPS r10k processor had 4k page granularity but each TLB entry mapped two consecutive pages for locality reasons.  I&#x27;m not sure if this was ever widespread though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor876021"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2021 0:33 UTC (Sun)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/876021/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  Huge pages have various problems with page management, e.g. being swapped to zram.</font><br>
<p>
Does that really matter for the mappings inherited from zygote? I can see why that&#x27;s a reason to not generally use hugepages (explicit or transparent), but using it selectively seems like it ought to be ok?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876021/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor876068"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2021 3:17 UTC (Mon)
                               by <b>alxndr</b> (guest, #152964)
                              [<a href="/Articles/876068/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exciting! Fork-servers occur all over the place (web-servers, fuzzers) etc, and the overhead from copying page-tables can have a significant performance impact. Here is some work from a long time ago in this direction:<br>
[1] <a href="https://lwn.net/Articles/149804/">https://lwn.net/Articles/149804/</a><br>
[2] <a href="https://landley.net/kdocs/ols/2003/ols2003-pages-315-320.pdf">https://landley.net/kdocs/ols/2003/ols2003-pages-315-320.pdf</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876068/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor876690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Some upcoming memory-management patches</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 22, 2021 20:18 UTC (Mon)
                               by <b>smooth1x</b> (subscriber, #25322)
                              [<a href="/Articles/876690/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
<p>
On Solaris processes which use shared memory can pass flag SHM_SHARE_MMU to share page tables, most databases use this.<br>
<p>
It would be great if this was added to Linux.<br>
<p>
Solaris calls it Intimate Shared Memory!<br>
<p>
<a href="https://docs.oracle.com/cd/E88353_01/html/E37841/shmat-2.html">https://docs.oracle.com/cd/E88353_01/html/E37841/shmat-2....</a><br>
<p>
<a href="http://www.adp-gmbh.ch/unix/solaris/ism.html">http://www.adp-gmbh.ch/unix/solaris/ism.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor876024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">1% cost for page faults</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2021 2:47 UTC (Sun)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/876024/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Am I crazy, or is 1% cost a worst-case that won&#x27;t occur in the real world?  Conceptually, a (major) page fault is going to be slow: you need to go through the entire IO stack, load the data from disk (that might involve waiting for a hard disk), wait for the latency of your disk... etc.  A minor page fault will have much fewer costs, but shouldn&#x27;t occur in steady-state operation: forking into a new process is expensive, and so a process that is constantly forking will be paying so many costs from that as to make the costs from this insignificant.<br>
<p>
The benchmark in question appears to measure a worst-case for this patch: constantly causing units of 512 pages (a full PTE) to be zero-intialized (a pretty cheap thing), and then freed.  That means we aren&#x27;t simply paying the change in page fault handler cost with the different benchmarks: we&#x27;re also paying the cost of the constant creation and destruction of PTE&#x27;s, which probably dwarfs that of a few atomic increments/decrements in the fault handlers themselves.<br>
<p>
I just think that should be mentioned: even really bizarre real-world applications are not paying so much as a tiny fraction of that cost (more so than most microbenchmarks)  This isn&#x27;t the cost increase felt by page faults: it&#x27;s the cost increase of constantly freeing and demanding new PTE&#x27;s, because you&#x27;re using SO MUCH memory.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/876024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
