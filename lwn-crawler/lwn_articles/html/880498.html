        <!DOCTYPE html>
        <html lang="en">
        <head><title>VSTATUS, with or without SIGINFO [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/880498/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/880577/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/880498/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>VSTATUS, with or without SIGINFO</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>January 6, 2022</br>
           </div>
The Unix <a
href="https://man7.org/linux/man-pages/man7/signal.7.html">signal
interface</a> is complex and hard to work with; some developers 
have <a href="/Articles/414618/">argued</a> that its design is
"unfixable".  So when Walt Drummond <a
href="/ml/linux-kernel/20220103181956.983342-1-walt@drummond.us/">proposed</a>
increasing the number of signals that Linux systems could manage, eyebrows
could be observed at increased altitude across the Internet.  The proposed
increase seems unlikely to happen, but the underlying goal — to support a
decades-old feature from other operating systems — may yet become a
reality.
<p>
The kernel is able to support up to 64 different signal types, which seems
like a fair number, but all 64 are taken, on some architectures at least.
That makes it impossible to add new signal types to Linux.  Drummond sought
to address that problem by raising the limit to 1024, which would surely be
enough for all time.  Raising the limit requires making some subtle changes
to the user-space API (putting a larger signal mask into the information
passed to realtime signal handlers, for example) that have the possibility
of breaking
applications, which means that extra scrutiny would be required.  But that,
it seems, is what would be needed to be able to add more signals.
<p>
Developers immediately wanted to know why there was a need to add signals,
and urged Drummond to find an alternative if possible.  As Eric Biederman <a
href="/ml/linux-kernel/87iluzidod.fsf@email.froward.int.ebiederm.org/">put
it</a>:
<p>
<blockquote class="bq">
	Please let's not expand the number of signals supported if there is
	any alternative.  Signals only really make sense for supporting
	existing interfaces.  For new applications there is almost always
	something better.
</blockquote>
<p>
So why is there a need to add new signals?  The answer has roots in ancient
history, well before the creation of Linux.  The <a
href="https://en.wikipedia.org/wiki/TOPS-10">TOPS-10</a> operating system
was developed by Digital Equipment Corporation in the 1970s; one feature it
offered was to print a line of status information (what was running, CPU
time consumed, etc.) when the user typed control-T.  It was a quick way for
users to verify that the system was still alive and making progress on
whatever task they were running.  This feature found its
way into VMS later on, and it still exists today in a number of BSD variants.
Linux, however, does not have this feature — in that form, anyway.
<p>
Within the kernel, there are two aspects to supporting this feature, which
goes by the name VSTATUS.  The first is to recognize the status request in
the terminal driver; this is done using the same logic that recognizes
other control characters, such as control-C to send a <tt>SIGINT</tt>
signal to the running process.  The kernel would then respond to the
keystroke in two ways:
<p>
<ul class="spacylist">
<li> The kernel will print a status line directly to the terminal with
     generic information about the running process and the state of the
     system.
<li> A <tt>SIGINFO</tt> signal is sent to the process running on the
     terminal at the time.  Applications can catch this signal to print
     some status information of their own; a copy application could tell
     the user how far the copy has progressed, for example.
</ul>
<p>
The Linux kernel doesn't implement VSTATUS, so it won't do either of the
above things.  Adding the ability to print a status line to the terminal
driver is not that hard; neither is sending a signal in response to an
event.  The problem is that Linux does not implement <tt>SIGINFO</tt>, so
that signal would need to be added and, as noted above, there is no room to
add new signals.  Thus Drummond's patch set.
<p>
This is not the first time that VSTATUS support has been requested; the
issue also <a
href="https://lore.kernel.org/lkml/1415200663.3247743.187387481.75CE9317@webmail.messagingengine.com/">came
up in 2014</a> and <a
href="/ml/linux-kernel/20190625161153.29811-1-ar@cs.msu.ru/">again in
2019</a> — and undoubtedly other times as well.  In 2019, Arseny
Maslennikov tried to get around the signal 
limitation by defining <tt>SIGINFO</tt> as a synonym for <tt>SIGPWR</tt>,
which was meant to (depending on who is reminiscing at the time) indicate
that either <a
href="/ml/linux-kernel/20190625213215.GB3116@mit.edu/">a
power failure was impending</a> or <a
href="https://lore.kernel.org/lkml/20141110142200.676b5d04@alan.etchedpixels.co.uk/">power
had been restored</a>.  Either way, the signal is delivered only to the
<tt>init</tt> process, and it tends to be little used on current systems.
Repurposing it for VSTATUS requires changing the default action for
<tt>SIGPWR</tt> to "ignore" but otherwise shouldn't prove disruptive to
user space.
<p>
Or so the developers would hope.  Real-world uses of <tt>SIGPWR</tt> are
rare, but they do exist; as Ted Ts'o <a
href="/ml/linux-kernel/YdSzjPbVDVGKT4km@mit.edu/">pointed out</a>, systemd
can be made to respond to it, for example.  Changing the default
handling of <tt>SIGPWR</tt> would <i>probably</i> not break any user-space
applications, but it is hard to know that for sure.  If something does
break, it could show up years later when the change makes it into an
enterprise kernel; at that point, the problem would be nearly impossible to
fix to everybody's satisfaction.  So it is unsurprising that kernel
developers are reluctant to make a change like this.
<p>
Over the years, there have also been questions about whether the feature is
really needed or not.  As Greg Kroah-Hartman <a
href="/ml/linux-kernel/20190730161940.GA15798@kroah.com/">pointed out</a>
in 2019, the kernel's "<a
href="https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html">magic
SysRq</a>" feature does everything VSTATUS does (and a lot more).  But
magic SysRq only works on the system console; as Biederman noted in the
above-linked message, a "<q>persuasive case</q>" could be made for
the utility of this feature for users interacting with systems over SSH,
for example.  So a use case for VSTATUS does appear to exist.
<p>
Given that, what is to be done?  Ts'o's message above included a suggestion:
implement VSTATUS as far as printing the status line from the kernel, but
don't bother sending the <tt>SIGINFO</tt> signal to user space.  That
eliminates the need to add a new signal (or repurpose an old one), which is
where all the problems arise.  This
implementation would deprive user space of the ability to add its own
status information, but the number of programs that have ever implemented
<tt>SIGINFO</tt> handling is quite small; Drummond <a
href="/ml/linux-kernel/CADCN6nzT-Dw-AabtwWrfVRDd5HzMS3EOy8WkeomicJF07nQyoA@mail.gmail.com/">said</a>
that only <tt>sleep</tt>, <tt>dd</tt>, and <tt>ping</tt> have such support,
"<q>so it's not like there's a vast hole
in the tooling or something, nor is there a large legacy software base
just waiting for SIGINFO to appear</q>".  He readily <a
href="/ml/linux-kernel/CADCN6nz0ih2k7-LB9D3qJjQ9Dv5QAkn7KC9Ci-qcbMHTG7_F+A@mail.gmail.com/">agreed</a>
to leave out the <tt>SIGINFO</tt> part.
<p>
The followup patch set without <tt>SIGINFO</tt> has not been posted as
of this writing.  Once it arrives, there should not be a great deal of
opposition to its merging into the mainline; at that point, Linux will have
most of the VSTATUS functionality that is offered by the BSDs.  If it turns
out later on that somebody really needs the <tt>SIGINFO</tt> part, that
whole problem can be reconsidered.  Meanwhile, though, the kernel community
is happy to kick that can further down the road.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Signal_handling">Signal handling</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/880498/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor880605"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 19:48 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880605/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IIRC there are some tools (including GNU dd) that respond to SIGUSR1 by printing a line of status information. But the default disposition of that signal is terminate, so obviously the kernel should not send it by default. Perhaps the kernel could grow some sort of process-wide &quot;send SIGUSR1 when the user presses ^T&quot; flag. Or maybe that&#x27;s too much extra complexity for not enough user value.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880605/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880607"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 20:16 UTC (Thu)
                               by <b>pdewacht</b> (subscriber, #47633)
                              [<a href="/Articles/880607/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      As long as we're over-engineering, what about letting applications opt-in with something like this? :p
<pre>prctl(PR_VSTATUS_SIGNAL, SIGUSR1)</pre>



      
          <div class="CommentReplyButton">
            <form action="/Articles/880607/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880609"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 20:44 UTC (Thu)
                               by <b>josh</b> (subscriber, #17465)
                              [<a href="/Articles/880609/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That doesn&#x27;t seem like over-engineering; that seems like the obvious solution, rather than adding a new signal.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880609/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 23:03 UTC (Thu)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/880625/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, since applications need adaption anyways, this seems quite sane to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880626"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 23:40 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/880626/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It would be sane if the use of signals was sane, but that is not universally accepted.<br>
Setting up a pollable fd to get status request notifications might be better.<br>
Maybe a way to request POLLPRI notifications on the tty fd, and an ioctl to request timestamp of most recent status request.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880626/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880631"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 1:20 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880631/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMHO there are two options:<br>
<p>
1. What is described above, where applications opt into receiving SIGUSR1, or possibly another signal. Pros: Some apps already have signal handlers for SIGUSR1, so this is a one-line change for them. Cons: Signals suck.<br>
2. What you describe, where applications have to hook this into their main event loops somehow, which for some applications would entail *writing* a main event loop in the first place. Pros: The design is clearly superior to signals. Cons: What if you build it and nobody comes? More prosaically, this is not a one-line change for existing apps, and I&#x27;m sure that at least one will say &quot;To hell with it, that&#x27;s too much work for a minor status-reporting feature. Just manually run kill -SIGUSR1 if you really want us to output a status line.&quot;<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880631/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880640"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 5:26 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/880640/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why not have both.<br>
Arrange that fcntl(F_SETSIG) on the tty fd can cause the requested signal to be sent for the status request.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880640/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880642"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 5:39 UTC (Fri)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/880642/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about extending sysrq?   It&#x27;s already well-known and seems to be easier to extend than signals.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880642/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880643"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 5:52 UTC (Fri)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/880643/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Documentation/admin-guide/sysrq.rst already shows<br>
<p>
``t``	    Will dump a list of current tasks and their information to your<br>
            console.<br>
<p>
which seems inspired by Ctrl-T signals.    It is a bit hard to see why another signal is needed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880643/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880651"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 8:24 UTC (Fri)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/880651/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That also would not work over SSH or in other non-system-console contexts.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880651/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880665"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 14:34 UTC (Fri)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/880665/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FYI, sysrq isn&#x27;t limited to the system console:<br>
<p>
echo t &gt; /proc/sysrq-trigger<br>
dmesg<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880665/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880695"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 17:54 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/880695/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The downside to this is the high possibility of fat-fingering the status key. There&#x27;s at least six sysrq letters that&#x27;ll instantly kill a running system.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880695/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor880722"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2022 11:50 UTC (Sat)
                               by <b>fw</b> (subscriber, #26023)
                              [<a href="/Articles/880722/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And for that, you don&#x27;t even need support in the kernel, it&#x27;s sufficient to register the process with some monitor daemon. The kernel can then use some appropriate form of IPC to request status information.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880722/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880764"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2022 16:57 UTC (Sun)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/880764/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Neat.  It also allows SIGUSR2 to be chosen instead (which I commonly use for various reasons).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880764/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor880612"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 21:00 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/880612/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; A SIGINFO signal is sent to the process running on the terminal </font><br>
<p>
Because of course there is only one process running on a terminal at a time. Pipelines don&#x27;t exist...<br>
<p>
I wonder what happens if multiple processes in a pipeline respond to the signal. Do their status messages get intermingled?<br>
<p>
If I recall correctly, RSTS/E responded to ctrl-T as well.<br>
I don&#x27;t remember it supporting pipelines though.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880612/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880613"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 6, 2022 21:28 UTC (Thu)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/880613/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I wonder what happens if multiple processes in a pipeline respond to the signal. Do their status messages get intermingled?</font><br>
<p>
One approach (and I&#x27;m not necessarily advocating it) would be:<br>
<p>
Which process has the terminal on fd 0 and would NOT get SIGTTIN if it tried to read from fd 0?<br>
<p>
That&#x27;s the one that should get the signal.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880613/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880633"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 2:29 UTC (Fri)
                               by <b>kschendel</b> (subscriber, #20465)
                              [<a href="/Articles/880633/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Because of course there is only one process running on a terminal at a time. Pipelines don&#x27;t exist..</font><br>
<p>
Well, of course they don&#x27;t.  It was TOPS-10.  A process either belonged to a terminal, or was a daemon.  In fact, the word &quot;process&quot; wasn&#x27;t used much, outside of register W being the PDB (process data block).  A more commonly used term was &quot;job&quot;.<br>
<p>
This brings back (mostly) fond memories of hammering on control-T to find out whether the internal dev KL10 had crashed again or not.  Realistically, control-T was usually about as useful as an elevator Close Door button, but much more rewarding.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880633/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880632"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 3:05 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/880632/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; &gt; A SIGINFO signal is sent to the process running on the terminal</font><br>
<font class="QuotedText">&gt;</font><br>
<font class="QuotedText">&gt; Because of course there is only one process running on a terminal at a time.</font><br>
<p>
Technically SIGINFO is sent to the foreground process group: <a href="https://github.com/openbsd/src/blob/5a74f40/sys/kern/tty.c#L523">https://github.com/openbsd/src/blob/5a74f40/sys/kern/tty....</a>.  But for the kernel-generated message, it seems the kernel picks just one foreground process to report on. On OpenBSD the relevant code (<a href="https://github.com/openbsd/src/blob/5a74f40/sys/kern/tty.c#L2219">https://github.com/openbsd/src/blob/5a74f40/sys/kern/tty....</a>) in ttyinfo is commented thusly,<br>
<p>
/*<br>
 * Find the most active thread:<br>
 *  - prefer runnable<br>
 *  - prefer higher pctcpu<br>
 *  - prefer living<br>
 * Otherwise take the newest thread<br>
 */<br>
<p>
The termios(4) manual page STATUS description on FreeBSD and macOS comport with that behavior.<br>
<p>
<font class="QuotedText">&gt; I wonder what happens if multiple processes in a pipeline respond to the signal. Do their status messages get intermingled?</font><br>
<p>
AFAICT, yes, but that&#x27;s not really any different than other situations where multiple processes share stderr. Normally message formatting and write atomicity (up to PIPE_BUF, maybe more if writes to a TTY have better guarantees?) will preserve line boundaries if only by accident, and in interactive sessions usually that&#x27;s good enough. That said, the OpenBSD code sends SIGINFO *before* printing the kernel message, and it doesn&#x27;t look like there&#x27;s any buffering involved. ttyprintf calls kprintf without the optional output buffer, which results in kprintf printing the formatted message byte-by-byte straight to the tty (kprintf -&gt; kputchar -&gt; tputchar -&gt; ttyoutput). See subr_prf.c and tty.c. But maybe there&#x27;s some buffering lower down in the tty layer or higher up with a lock on the TTY? (I&#x27;ve expended my curiosity.) If not it would seem better to print the kernel diagnostic before invoking SIGINFO.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880632/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880634"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 3:28 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/880634/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oops. I pasted the wrong comment, but link is to the intended comment. Basically, it picks one thread within one foreground process to report on.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880634/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor880630"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 1:13 UTC (Fri)
                               by <b>judas_iscariote</b> (guest, #47386)
                              [<a href="/Articles/880630/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that actually a very nice compromise. Adding more signals is a big red flag, yet vstatus is kinda useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880630/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880645"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 6:17 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/880645/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Perhaps it would be a good time to start _replacing_ signals instead? With a centralized way to allocate signal numbers, and a better way to raise them.<br>
<p>
One simple proposal:<br>
1. Use file descriptors for signal numbers.<br>
2. Signals are raised by writing a special &quot;struct signal_info_t&quot; into that descriptor.<br>
3. Third-party processes can either receive the descriptor through usual descriptor sending means or use &quot;/proc/pid/&lt;fd&gt;&quot; files.<br>
4. Signals are delivered asynchronously, with the usual semantics. With a way to get the copy of signal_info_t associated with the signal.<br>
<p>
This would make signals so much more usable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880645/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880660"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 12:10 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/880660/">Link</a>] (19 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Is this not what signalfd(2) is for?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880660/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880694"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 17:49 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/880694/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds a bit like the systemd/s6 daemon status protocols to me...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880694/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880701"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 19:17 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/880701/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Signalfd allows to monitor for signals using file descriptors, not to raise them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880701/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880719"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2022 9:18 UTC (Sat)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/880719/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
signalfd is fundamentally broken. If you call signalfd in process A and send it to process B, you would expect process B to be able to observe signals to process A. In fact the fd will observe signals to process *B*. I don&#x27;t know who decided that was a good idea, but it cripples the feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880719/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880773"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 9, 2022 22:33 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880773/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would be very surprised if it were possible to do that in a completely safe, race-free, and performant way without forcing process A to mask all signals (which signalfd does not actually require). Because if process B dequeues a signal sent to A, then A should not receive that signal, right? But then, what would you do if process A receives e.g. a SIGILL or SIGBUS? Process A can&#x27;t mask those signals, because it would just get stuck. So now you have to carve out an exception for signals which would block a process&#x27;s forward progress if not handled the traditional way. I&#x27;m not sure exactly what that would end up looking like, but it would probably be a damned mess on the userspace side at least.<br>
<p>
Anyway, the purpose of signalfd is not to share signals with other processes, it&#x27;s to make signals less painful for people who are already in the business of writing an epoll/select loop, and don&#x27;t want to faff about with pselect, signal handlers, etc. For this purpose, it works just fine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880773/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880777"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 2:16 UTC (Mon)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/880777/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are some nasty interactions with signal blocking that made signalfd  much less useful to the point that writing to a pipe in a signal handler and listening on that in the event loop is still preferable. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880777/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 3:06 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880779/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Could you please elaborate? I&#x27;m looking through the man page but I don&#x27;t see any obvious gotchas there...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 9:22 UTC (Mon)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/880784/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
From the man page:<br>
<p>
As described above, in normal usage one blocks the signals that will be accepted via signalfd(). If spawning a child process to execute a helper program (that does not need the signalfd file descriptor), then, after the call to fork(2), you will normally want to unblock those signals before calling execve(2), so that the helper program can see any signals that it expects to see. Be aware, however, that this won&#x27;t be possible in the case of a helper program spawned behind the scenes by any library function that the program may call.  In such cases, one must fall back to using a traditional signal handler that writes to a file descriptor monitored by select(2), poll(2), or epoll(7).<br>
<p>
Surely if one controls the code and does not use libraries that executes processes it is fine. But it easy to forget about that. So in one code I just used a signal handler and pipe. As a bonus the code stays compatible with BSD. What is puzzling is that in all those years since signalfd were added no flag were added to reset blocked signals on exec.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880863"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 19:25 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880863/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To be fair, that exact same problem applies to pselect, which is POSIX-standardized and supposedly the Right Way to do this.<br>
<p>
I&#x27;m not really a fan of libraries randomly forking off temporary processes without the application code&#x27;s knowledge or consent, to be honest. Sure, if a library is specifically designed to do something like implement a process pool, I suppose it&#x27;s unavoidable, but if you&#x27;re just forking off a process because you can, then maybe don&#x27;t do that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880863/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 11, 2022 11:23 UTC (Tue)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/880957/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
With various sandboxing forking an extrenal process or even just executing another copy of the application becomes a common practice.<br>
<p>
As for pselect if one writes to a pipe in the signal handler, then one does not need that. I wish that somebody would come up with a flag or something not to keep signals blocked across exec similarly to noexec flags to file descriptors, but I guess that writing to a pipe from a signal handler is so common knowledge that nobody bothered.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor880780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 3:37 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/880780/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How safe is the current behavior? Can you mess up signal handling in another process—perhaps a system service or SUID binary—by sending it an unexpected signalfd file descriptor via Unix-domain sockets, or as an inherited FD?<br>
<p>
From a security point of view, the process calling signalfd() does not have the capability to block signals in arbitrary other processes, or to access data about those signals, so it should not be possible for it to send a file descriptor with those effects to another process. Even if the receiving process is blocking and getting data about its *own* signals, it&#x27;s still a security risk since those signal handlers shouldn&#x27;t be blocked and data about the process state, including code addresses otherwise protected by ASLR, might be leaked. (The receiving process would reasonably assume that any data read from the FD would also have been available to the sender—which is not true for signalfd file descriptors.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880781"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 7:23 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880781/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; How safe is the current behavior? Can you mess up signal handling in another process—perhaps a system service or SUID binary—by sending it an unexpected signalfd file descriptor via Unix-domain sockets, or as an inherited FD?</font><br>
<p>
Current behavior where signalfd always gives your own signals: signalfd does not mask or ignore signals just by existing. If you completely ignore it, then it doesn&#x27;t do anything, so unexpectedly sending someone a signalfd accomplishes nothing from a security perspective, at least as far as I understand its semantics.<br>
<p>
Proposed behavior where signalfd operates cross-thread or cross-process: 🤷‍♂️. I&#x27;m having a hard time believing you can maintain the &quot;doesn&#x27;t block signals automatically&quot; invariant and *also* maintain the &quot;every signal is delivered exactly once&quot; invariant, but I don&#x27;t know enough about the implementation to say that for sure.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880781/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880782"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 7:34 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/880782/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A signalfd() replacement would just allow an alternative way to call signal(), nothing more. The signal will be delivered through the usual mechanisms (either signalfd or through asynchronous interruption).<br>
<p>
That&#x27;s because a way to asynchronously interrupt a thread is extremely useful for many practical purposes. For example, Golang uses signals to force GC in tight loops without having to poll for it. But you have to jump through lots of hoops to be able to use signals. They are completely useless for libraries or anything that shares address space, like plugins (Flash plugin signal bug comes to mind).<br>
<p>
Windows has a similar mechanism: APC (Asynchronous Procedure Calls) - <a href="https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">https://docs.microsoft.com/en-us/windows/win32/sync/async...</a> and it&#x27;s extremely useful for some low-level functionality.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880782/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880812"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 15:46 UTC (Mon)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/880812/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If you completely ignore it, then it doesn&#x27;t do anything, so unexpectedly sending someone a signalfd accomplishes nothing from a security perspective, at least as far as I understand its semantics.</font><br>
<p>
Sure, if you completely ignore the received file descriptor it doesn&#x27;t do anything. The same would apply for the proposed alternative version—just holding a signalfd from another process would have no effect on either process. But generally one would expect the receiving process to *read* from the file descriptor, which for signalfd is the part that affects signal delivery.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880812/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880858"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 19:18 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880858/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMHO an appropriately-designed setuid binary generally should not be in the business of accepting and reading from random file descriptors that it did not open itself. This still leaves the door open to /proc/self/fd shenanigans with inherited file descriptors, but I should hope that the binary calls fstat to confirm that it is interacting with a normal file after opening it.<br>
<p>
The basic principle remains, however, that writing setuid binaries is an extremely fragile process and you need to be highly paranoid about absolutely everything. signalfd does not materially change that fact (especially since it&#x27;s been in Linux &quot;since kernel 2.6.22&quot; according to signalfd(2), so the people who make these binaries really should be aware of it by now...).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880858/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor881063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 12, 2022 2:46 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/881063/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; IMHO an appropriately-designed setuid binary generally should not be in the business of accepting and reading from random file descriptors that it did not open itself.</font><br>
<p>
Do you have any examples of situations where this would be an issue, apart from signalfd()? Passing file descriptors has been a standard part of various protocols for a long time now, including between processes of different privilege levels. The expectation is that reading from a file descriptor has the same effect in both the sending and receiving processes, which would imply that there is no security issue. The signalfd API breaks that expectation.<br>
<p>
The problem isn&#x27;t limited to SUID binaries. The destination could be any process running as a different user. The Wayland clipboard protocol[0], to pick one example, involves sending a file descriptor from the data source to the client obtaining the data, which is expected to read the content from the provided file descriptor after negotiating the format. These processes need not belong to the same user.<br>
<p>
Also, /dev/stdin is a potential risk as an inherited FD which the target process does not open itself. Do SUID binaries routinely check FD 0 with fstat() before reading input to verify that it isn&#x27;t a signalfd file descriptor, as opposed to a file, socket, pipe, tty, etc.—basically anything other than signalfd—which could be a reasonable and safe input source?<br>
<p>
The behavior and permissions of a file descriptor should be determined by who opens or creates the descriptor, not who reads from it.<br>
<p>
[0] <a href="https://wayland.freedesktop.org/docs/html/ch04.html#sect-Protocol-data-sharing">https://wayland.freedesktop.org/docs/html/ch04.html#sect-...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/881063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor880786"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 9:57 UTC (Mon)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/880786/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Synchronous SIGILL/SIGSEGV/SIGBUS already have &quot;automatically unmask and proceed&quot; behavior.<br>
<p>
I think my preferred behavior for signalfd would be that the signal is available through the fd if and only if it is blocked in the process that is the source of the signalfd, i.e. if the signal is unblocked (by the user or in the synchronous case) then signalfd doesn&#x27;t get it.<br>
<p>
<font class="QuotedText">&gt; Anyway, the purpose of signalfd is not to share signals with other processes</font><br>
<p>
Maybe that&#x27;s not the original purpose, but the whole point of orthogonal API design and &quot;everything is a file&quot; is that you can compose features to address new use cases not anticipated by the designers of the individual APIs.<br>
<p>
In rr and Pernosco we have a couple of instances of a non-uncommon case: the user runs a process A that in some cases forwards its work to another process B in an unrelated part of the process tree. We want signals like SIGINT, SIGTERM etc sent to A to be handled in B. signalfd looks like it should work for this, but it doesn&#x27;t, because it has this very strange behavior that what you read from the file descriptor depends on which process is reading from it. Instead we pretend it&#x27;s the 1980s and install signal handlers that write data to a pipe.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880786/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880865"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 19:40 UTC (Mon)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/880865/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Synchronous SIGILL/SIGSEGV/SIGBUS already have &quot;automatically unmask and proceed&quot; behavior.</font><br>
<p>
I see. That makes a great deal of sense to me, but I would still be concerned about all of the following:<br>
<p>
* What data structure holds the list of pending signals for a given process or thread? How thread-safe is this structure?<br>
* Is it possible to atomically dequeue a signal from the list, without taking a mutex?<br>
* If the above is not currently possible, what would be the performance overhead of modifying the data structure so that it is amenable to atomic operations?<br>
* What does the existing &quot;inject a signal handler&quot; code path look like? Can the dequeue be cleanly separated from the injection, or are they tightly coupled? Presumably, you have to preempt the thread before the dequeue (to prevent the thread from exiting or blocking the signal before you can inject the handler), so I imagine there must be some amount of coupling there...<br>
<p>
<font class="QuotedText">&gt; I think my preferred behavior for signalfd would be that the signal is available through the fd if and only if it is blocked in the process that is the source of the signalfd, i.e. if the signal is unblocked (by the user or in the synchronous case) then signalfd doesn&#x27;t get it.</font><br>
<p>
* Does this cause thread-safety issues with pselect, which has to atomically (modify the signal mask) and (wait for FD events)? What if you use pselect to unmask a signal which is associated with a signalfd that you are pselecting against? I should expect that to Just Work (i.e. it always executes the signal handler and never returns a ready-to-read event for the signalfd), regardless of when the signal arrives. Is the current implementation prepared to do that?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880865/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880877"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 20:29 UTC (Mon)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/880877/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I&#x27;m not really qualified to comment on the kernel-side implementation details.<br>
<p>
<font class="QuotedText">&gt; What if you use pselect to unmask a signal which is associated with a signalfd that you are pselecting against?</font><br>
<p>
The signal will be delivered normally and not be received by the signalfd. That seems to be the only reasonable behavior.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880877/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880878"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Replace signals!</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 20:32 UTC (Mon)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/880878/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess the interesting case is when a signal is pending but masked and the process uses pselect to unmask it. In that case it probably makes sense to just deliver the signal normally instead of making signalfd readable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880878/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor880647"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 7:32 UTC (Fri)
                               by <b>bof</b> (subscriber, #110741)
                              [<a href="/Articles/880647/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t understand how this can be considered at all, and not for the signal part of it:<br>
<p>
tty/pty suddenly reacting to Ctrl-T, will be a regression for anything now sending ctrl-T through e.g. an ssh session to some remote process and not requesting no-pty, whatever the use of that might be - and use cases doing that, would then break.<br>
<p>
Right?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880647/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880655"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 9:34 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/880655/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Presumably there would be a new termios setting to choose the control character, and it could default to NONE.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880655/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor880700"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 18:52 UTC (Fri)
                               by <b>bof</b> (subscriber, #110741)
                              [<a href="/Articles/880700/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah yes, making it opt-in per session. Got it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880700/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor880657"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 7, 2022 10:41 UTC (Fri)
                               by <b>dveeden</b> (subscriber, #120424)
                              [<a href="/Articles/880657/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The ^T is interesting.<br>
<p>
<a href="http://dtrace.org/blogs/brendan/2013/10/05/control-t-for-tenex/">http://dtrace.org/blogs/brendan/2013/10/05/control-t-for-...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880657/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor880735"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 8, 2022 17:21 UTC (Sat)
                               by <b>jrtc27</b> (subscriber, #107748)
                              [<a href="/Articles/880735/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On FreeBSD it&#x27;s not just dd, ping and sleep. The full list is:<br>
<p>
* bin/chflags<br>
* bin/chmod<br>
* bin/cp<br>
* bin/dd<br>
* bin/rm<br>
* bin/sleep<br>
* sbin/devd (like udev)<br>
* sbin/dump (creates a full dump from a UFS filesystem that can be later restored)<br>
* sbin/fsck_ffs<br>
* sbin/newfs_msdos<br>
* sbin/ping<br>
* sbin/savecore (kernel core dumps)<br>
* usr.bin/du<br>
* usr.bin/fetch (lightweight curl/wget equivalent)<br>
* usr.bin/gzip<br>
* usr.bin/sort<br>
* usr.bin/time<br>
* usr.bin/wc<br>
* usr.sbin/camdd (like dd but can use pass(4) for issuing asynchronous reads/writes directly to the CAM storage layer in the kernel)<br>
* usr.sbin/chown<br>
<p>
So it turns out people tend to add support for features if they exist and not when they don&#x27;t.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880735/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor881882"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 20, 2022 5:42 UTC (Thu)
                               by <b>Shabbyx</b> (guest, #104730)
                              [<a href="/Articles/881882/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would totally use ctrl-t on cc, the lack of progress info on cc, rm etc is horrendous.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/881882/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor881883"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 20, 2022 5:43 UTC (Thu)
                               by <b>Shabbyx</b> (guest, #104730)
                              [<a href="/Articles/881883/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
s/cc/cp obviously<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/881883/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor880778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">VSTATUS, with or without SIvGINFO</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jan 10, 2022 3:10 UTC (Mon)
                               by <b>NightMonkey</b> (subscriber, #23051)
                              [<a href="/Articles/880778/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just a comment on another use of Ctrl-T from when terminals were heavy and CPU registers had blinking lights:<br>
<p>
If one were to come upon terminal either powered off or with a lonely blinking cursor or teletype with no text, what is a quick, non-intrusive way to see if a process is running, or not? Our friend &quot;Ctrl-T&quot;. :)<br>
<p>
This approach has a practical benefit, too. If the previous user was not really very responsible, or was late for their class/party/wedding/funeral, they could have left their TTY at the input prompt of any program. The next person to not use Ctrl-T, but instead hit space or return or enter could set off whatever was on the other side of that input statement or request... which could be a reboot, a disk erase, a terminal lock, etc.<br>
<p>
You see where I&#x27;m going with this... ;) Cheers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/880778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
