        <!DOCTYPE html>
        <html lang="en">
        <head><title>Randomizing structure layout [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/722293/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/722566/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/722293/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Randomizing structure layout</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="GAByline">
           <p>May 11, 2017</p>
           <p>This article was contributed by Nur Hussein</p>
           </div>
<p>Kees Cook is working on a series of <a
href="http://www.openwall.com/lists/kernel-hardening/2017/04/06/14">patches
for C structure randomization</a> to improve security in the Linux
kernel. This is an important part of obfuscating the internal binary layout
of a running kernel, making kernel exploits harder. The <tt>randstruct</tt>
plugin is a new GCC add-on that lets the compiler randomize the layout of C
structures. When
enabled, the plugin will scramble the layout of the kernel structures that
are specifically designated for randomization.</p>

<p>The patches in question are part of the <a
href="https://kernsec.org/wiki/index.php/Kernel_Self_Protection_Project">Kernel
Self Protection Project</a> (KSPP). The goal of KSPP is to harden the
 mainline Linux kernel. Currently, KSPP is primarily
working on porting features from <a
href="https://grsecurity.net/">grsecurity</a>/<a
href="https://pax.grsecurity.net/">PaX</a> to mainline Linux, and sending
them incrementally to the Linux kernel mailing list. The structure
randomization patches are part of that effort, and is a port of
grsecurity's structure layout randomization plugin.</p>

<h4>Structure randomization</h4>

<p>Fields in a C structure are laid out by the compiler in order of their
declaration. There may or may not be padding between the fields, depending
on architecture alignment rules and whether the "<tt>packed</tt>" attribute
is present. One
technique for attacking the kernel is using memory bounds-checking flaws to
overwrite specific fields of a structure with malicious values. When the
order of fields in a structure is known, it is trivial to calculate the
offsets where sensitive fields reside. A useful type of field for such
exploitation is the function pointer, which an attacker can overwrite with
a location containing malicious code that the kernel can be tricked into
executing. Other sensitive data structures include security credentials, which
can result in privilege-escalation vulnerabilities when overwritten.</p>

<p>The <tt>randstruct</tt> plugin randomly rearranges fields at compile
time given a randomization seed. When potential attackers do not know the
layout of a structure, it becomes much harder for them to overwrite
specific fields in those structures. Thus, the barrier to exploitation is
raised significantly, providing extra protection to the kernel from such
attacks. Naturally, compiler support is necessary to get this feature to
work. Since kernel 4.8, <a href="/Articles/691102/">GCC's
plugin infrastructure</a> has been used by the kernel to implement such
support for KSPP features.</p>

<p>To get structure randomization working in the kernel, a few things need
to be done to ensure that it works smoothly without breaking anything. Once
enabled, the <tt>randstruct</tt> plugin will do its magic provided a few
conditions are met. First, structures marked for randomization need to be
tagged with the <tt>__randomize_layout</tt> annotation. However, structures
consisting entirely of function pointers are automatically randomized.
Structures that only contain function pointers are a big target for
attackers and reordering them is unlikely to cause problems elsewhere.
This
behavior can be overridden with the <tt>__no_randomize_layout</tt>
annotation, when such randomization is undesirable. Therefore, if enabled,
structure randomization is opt-in, except for structures that only contain
function pointers, in which case it becomes opt-out. An example of a
situation where <tt>__no_randomize_layout</tt> is needed is <a
href="http://www.openwall.com/lists/kernel-hardening/2017/04/06/25">this
patch</a> from Cook, in which some paravirtualization structures
(consisting entirely of function pointers) are used outside the kernel,
hence should not be auto-randomized.</p>

<p>Structures to be randomized need to be initialized with <a
href="https://gcc.gnu.org/onlinedocs/gcc/Designated-Inits.html">designated
initializers</a>. A designated initializer is a C99 feature where the
members of a C structure are initialized in any order explicitly by member
name instead of anonymously by order of declaration. Also, structure
pointers should 
not be cast 
to other pointer types for randomized structures. Cook has sent
a number of patches to convert a few sensitive structures to use designated
initializers, but their use has been standard practice in
the kernel for some time now, so the kernel is pretty much ready for that
feature. Structures that explicitly require designated initializers can be
<a
href="http://www.openwall.com/lists/kernel-hardening/2017/04/06/13">tagged
with</a> <tt>__designated_init</tt>; that will trigger a warning if a
designated initializer is not used when initializing them.</p>

<h4>Randomization of <tt>task_struct</tt></h4>

<p>This is a change that affects the source code in many places, so careful
consideration is required when reordering some structure's internals as there
are special cases that need to be handled. The <a
href="http://elixir.free-electrons.com/linux/latest/source/include/linux/sched.h#L483"><tt>task_struct</tt></a> 
structure is a prime example of a structure that benefits from field
randomization. Inside <tt>task_struct</tt> are sensitive fields such as
process credentials, flags for enabling or disabling process auditing, and
pointers to other <tt>task_struct</tt> structures. Those fields, among
others, are juicy targets for potential attackers to overwrite. However, we
can't just randomize the entirety of <tt>task_struct</tt>, as some fields
on the very top and very bottom of the structure need to be where they
are.</p>

<p>The top of <tt>task_struct</tt> is as follows:</p>

<pre>
    struct task_struct {
    #ifdef CONFIG_THREAD_INFO_IN_TASK
	    /*
	     * For reasons of header soup (see current_thread_info()), this
	     * must be the first element of task_struct.
	     */
	    struct thread_info		thread_info;
    #endif
</pre>

<p>To make it easy for <tt>current_thread_info()</tt> to get to the
<tt>thread_info</tt> structure of the current running thread, it is
possible to just use a <tt>struct&nbsp;thread_info</tt> pointer to the first
element of the <tt>task_struct</tt> without having to actually include the
file that defines it. This is to avoid circular header dependencies that
arise from such an inclusion. Therefore, <tt>thread_info</tt> needs to be
at that fixed location for the pointer access to work.</p>

<p>The bottom of <tt>task_struct</tt> has a similar position-locked
structure:</p>

<pre>
	    /* CPU-specific state of this task: */
	    struct thread_struct		thread;

	    /*
	     * WARNING: on x86, 'thread_struct' contains a variable-sized
	     * structure.  It *MUST* be at the end of 'task_struct'.
	     *
	     * Do not put anything below here!
	     */
    };
</pre>

<p>From here we can see that the implementation of <tt>thread_struct</tt>
is architecture-specific, can be variable in size and sensitive to
alignment. Thus it needs to be placed at the very end, and cannot be
shifted around.</p>

<p>Linus Torvalds <a
href="https://marc.info/?l=linux-kernel&m=149083181100577&w=2">weighed in
on <tt>task_struct</tt> randomization</a>:

<div class="BigQuote">
Making "struct task_struct" be something that
contains a fixed beginning and end, and just have an unnamed randomized
part in the middle might be the way to go.
</div>

<p>
Thus, the solution in Cook's patch is to <a
href="http://www.openwall.com/lists/kernel-hardening/2017/04/06/27">introduce
another sub-structure</a> that encompasses the middle of
<tt>task_struct</tt>, just after the first fields and just before the last
one, and to mark that as randomizable. Any other fields that need to be
position-locked can be carved out with more sub-structures without the
<tt>__randomize_layout</tt> annotation; two such fields are
<tt>blocked</tt> and <tt>saved_sigmask</tt> (both <tt>sigset_t</tt>). These
fields 
are directly copied to user space and are expected to be adjacent and in that
order.</p>

<h4>More caveats</h4>

<p>There is one major caveat to structure randomization: to build third party
or out-of-tree kernel modules against a kernel with randomized structures, the
randomization seed is required. Therefore, those distributing kernel binaries 
(such as Linux distributions) will need a way to expose the randomization
seed to 
users that install the kernel headers or other kernel development package;
attackers can use that to defeat the randomization. Since the same seed
will be used across all instances of that particular distribution (as the
seed needs to be chosen at compile time), any successful attack on a
distribution kernel would work for all installations of that
distribution kernel version. Nevertheless, compile-time randomization
remains useful for 
custom private kernel builds, where the seed need not be exposed. Cook
explains:

<div class="BigQuote">
While less useful for distribution kernels (where the randomization seed
must be exposed for third party kernel module builds), it still has some
value there since now all kernel builds would need to be tracked by an
attacker. It is most useful to "in-house" kernel builds where the
randomization seed is not available to an attacker.
</div>

<p>
Nevertheless, Torvalds is unimpressed by structure randomization, <a
href="https://marc.info/?l=linux-kernel&m=149083181100577&w=2">calling it
security theater</a>. The fact that distributions need to publish the
randomization seeds for module-building meant it did not provide as big of
a security feature as advertised. Torvalds however did add:

"<q>So it's imnsho a pretty questionable security thing. It's likely most
useful for one-off 'special secure installations' than mass productions.
</q>"
To which, Cook <a
href="https://marc.info/?l=linux-kernel&m=149083865202302&w=2">replied</a>:
"<q>Well, Facebook and Google don't publish their kernel builds. :)</q>"

<p>
There is a good argument to be made that large production servers running
custom kernels do benefit from additional security protections such as
structure randomization, so it is a worthwhile addition to the mainline.</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Kernel_hardening">Security/Kernel hardening</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel-Hardening">Linux kernel/Hardening</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Hussein_Nur">Hussein, Nur</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/722293/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor722525"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 4:37 UTC (Fri)
                               by <b>k8to</b> (guest, #15413)
                              [<a href="/Articles/722525/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm sure this will be a joy to debug on.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722525/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722555"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 12:41 UTC (Fri)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/722555/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It should be fine, I think -- the debuginfo GCC emits will contain appropriate offsets for all structure members post-randomization. (And debugging without debuginfo will remain precisely as painful as it always was.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722555/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722708"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2017 23:49 UTC (Sun)
                               by <b>jreiser</b> (subscriber, #11027)
                              [<a href="/Articles/722708/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <i>debugging without debuginfo will remain precisely as painful as it always was.</i>

&nbsp;&nbsp;No, it will be harder.  The mapping from source declaration to binary layout previously could be understood quickly; now it will require reverse engineering (inspecting machine instructions for offsets from pointers), and it may change from version to version.
      
          <div class="CommentReplyButton">
            <form action="/Articles/722708/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722820"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2017 21:47 UTC (Mon)
                               by <b>autious</b> (guest, #114303)
                              [<a href="/Articles/722820/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Which is kinda the goal I think?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722820/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2017 12:45 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723005/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Quite. The point is that if you ask gdb or crash or something else with access to the DWARF for info on some structure member's contents, it'll still be able to tell you what they are, exactly as it always could.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor722558"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 13:03 UTC (Fri)
                               by <b>abradona</b> (subscriber, #96602)
                              [<a href="/Articles/722558/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
that's what I was thinking about too ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722558/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor722698"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2017 17:49 UTC (Sun)
                               by <b>johan</b> (guest, #112044)
                              [<a href="/Articles/722698/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"The randstruct plugin is a new GCC add-on that lets the compiler randomize the layout of C structures."<br>
<p>
Since it's a plugin I'm hoping that it has sane defaults so the randstruct plugin is disabled when specifying -g<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722698/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723004"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 17, 2017 12:44 UTC (Wed)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/723004/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, if it were built in to GCC and not a plugin this would actually be considered unacceptable: specifying -g should not change the generated code in any way (including disabling, say, structure randomization). What should happen, instead (and what I think does in fact happen) is that the generated debugging info correctly represents the structures' randomized field offsets in the DWARF. (DWARF does not require structure members to be represented in ascending order: indeed, they can be entirely overlapping -- this is how unions are represented -- or even partially overlapping, reversed, or, as here, in random order.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723004/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor722529"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 5:51 UTC (Fri)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/722529/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Presumably container_of() and offset_of() still work, as within the kernel the usual pointer-lookup methods remain unchanged?   That is, the offset is known at compile time, so the CPP will "do the right thing"?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722529/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor722531"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 6:10 UTC (Fri)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/722531/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Clearly we need to teach tinycc to do structure layout randomization, and have it compile the kernel from source on each boot.<br>
<a href="https://bellard.org/tcc/tccboot.html">https://bellard.org/tcc/tccboot.html</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722531/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722541"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 7:48 UTC (Fri)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/722541/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm not sure you need that - you could have relocations for all struct references, given enough compiler support :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722541/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor722533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 7:20 UTC (Fri)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/722533/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On my own systems, I did never run a distro provided kernel image, except for installation. When I started with Linux with a kernel from the 2.0.x series, it was quite common do compile the kernel even in binary distros. Having all hardware needed at boot inside the kernel (and not in modules) was common practice. Afterwards I changed to Gentoo, where even today it is quite common to build your own kernel. <br>
<p>
Also a binary distro should be able to provide a package that builds a randomized kernel including all needed modules. This should not require the user to run make config, as the config would be provided by the distribution. Probably this would not be the default option, except maybe for distros that are specialized on security, but it could be an optional feature.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722560"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 13:14 UTC (Fri)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/722560/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <I>Also a binary distro should be able to provide a package that builds a randomized kernel including all needed modules.</I>
<P>
It might even work as long as the user doesn't need any third party binary only module. Might even work for enterprise distributors - when they need support, they already share a lot of possibly confidential information with support, so they might also share the random seed. If there is an actual bug in the kernel, they have to rebuild it anyway and use a different seed.
      
          <div class="CommentReplyButton">
            <form action="/Articles/722560/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722781"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2017 15:59 UTC (Mon)
                               by <b>and</b> (guest, #2883)
                              [<a href="/Articles/722781/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It might even work as long as the user doesn't need any third party binary only module.</font><br>
<p>
even in this case it can be made to work fine: mechanisms like DKMS allow to automatically recompile kernel modules after package updates. for this to work, the seed must be stored somewhere in the system, but remember that it is basically already game over if the attacker can access a random file that requires root permissions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722781/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor722534"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 7:38 UTC (Fri)
                               by <b>nhippi</b> (subscriber, #34640)
                              [<a href="/Articles/722534/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is unfortunate security developers focus on probabilistic runtime defenses. The added complexity can easily become an attack surface itself. Making the code harder to understand and debug will inevitably create new bugs - some which will have security implications. I take working on better static checks (and integrating them into developer/maintainer workflow) would have better long term effect. But that of cause doesn't make nice bullet points to marketing brochures like "randomized structs" may make...<br>
<p>
<p>
<p>
 <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722534/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722543"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 8:17 UTC (Fri)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/722543/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Focusing only on probabilistic defences is certainly not good. But I do not see this happening. It is just one defence among many.<br>
<p>
Certainly it would be better to just have provably secure code. But as the kernel is several orders of magnitude too large for proving its correctness, there have to be other measures. <br>
<p>
Also I do not see, where this makes the code harder to understand. This change takes the right way of hiding the added complexity in the compiler (to be precise in a plugin). The visible changes in code mostly come down to some hints, where randomization is allowed or not allowed.<br>
<p>
For debug it is a bit different. However, with proper support in the debugger, this should be no problem. The debugger should be able to decode randomized structs, if it has the necessary seed.<br>
<p>
Both approaches have long term effects. Static analysis can prevent some bugs (not all of them unless we restrict to non Turing complete languages). Randomization can prevent bugs being exploited. This includes bugs in newly added code. Which has more effect is hard to tell.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722543/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 14:07 UTC (Fri)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/722564/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Provably secure is pretty much a non-starter as it requires a full and accurate theory of everything, and a proof the hardware you run on meets it's specification.  Short of that you will have assumptions that may be wrong somewhere in your approach.<br>
<p>
That said it is possible to manage the assumptions and prove certain properties about code.  Which could in principle could close many lines of attack.   The kernel deliberately does not implement any turning machines  not even with eBPF so the halting problem should not be an issue.<br>
<p>
The practical problem and what most attacks today exploit is that to be able to reason soundly about logic or algorithms requires the abstractions you build those out of to be well defined.   Currently C explicitly is not well defined with respect to memory management.   When you add in devices that can perform DMA and are not restricted by an IOMMU (as a kernel must) there is an additional problem.<br>
<p>
To my knowledge no one has yet demonstrated a system that can build operating systems that is sufficiently well defined as to allow proofs of correctness for anything interesting.  Which unfortunately leaves proofs of correctness needing a proof of concept before anyone will believe in them.<br>
<p>
Which is all to say people are adding kernel defenses some of the randomization because no one has been clever enough yet to think of something better.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 18:40 UTC (Fri)
                               by <b>walters</b> (subscriber, #7396)
                              [<a href="/Articles/722602/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<a href="https://sel4.systems/">https://sel4.systems/</a> is pretty interesting on this topic.  That said, I thought Coccinelle was an intimidating but <a href="https://github.com/seL4/l4v/commit/df7693b687a5ad541d1beec24148ddae082f00e7">https://github.com/seL4/l4v/commit/df7693b687a5ad541d1bee...</a> is totally unintelligible to me.  (Why are there almost no comments?)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor722650"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 18:04 UTC (Sat)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/722650/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <I>"To my knowledge no one has yet demonstrated a system that can build operating systems that is sufficiently well defined as to allow proofs of correctness for anything interesting"</I>
<P>
I remember 20 years ago someone mentioned to me that the VMS kernel (the OS running on VAX computers) was formally proven to be correct (to some degree). Of course, in that case DEC provided the hardware and the software too. Unfortunately I don't remember the details.
      
          <div class="CommentReplyButton">
            <form action="/Articles/722650/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor723132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2017 0:52 UTC (Thu)
                               by <b>smoogen</b> (subscriber, #97)
                              [<a href="/Articles/723132/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was told by a Dec guy was that the original story was that with the right assumptions you could make anything provably secure and then showed how it could be done with the VMS system. You basically start by assuming all sorts of things like not having an active attacker, a set of actions that the system will only do, dropping down all the hardware to the bare minimum etc etc. All of these are things that various "provable" had used in one set or another.. so why not put them all together. You basically had a brick with VMS installed on it, but it was provable that it was secure within the parameters that could be used.<br>
<p>
The problem was that the joke got out hand as someone took it seriously and started passing around about how VMS was superior to Unix because it was provably secure. <br>
<p>
How true this story is versus all the others... I don't know. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor723819"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 25, 2017 20:47 UTC (Thu)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/723819/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Provably secure is pretty much a non-starter as it requires a full and accurate theory of everything, and a proof the hardware you run on meets it's specification. Short of that you will have assumptions that may be wrong somewhere in your approach.</font><br>
<p>
A correctness proof is mathematics.<br>
<p>
Hardware is reality.<br>
<p>
Congratulations on finding a proof that reality and mathematics coincide ... :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/723819/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor722546"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing snake-oil</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 8:56 UTC (Fri)
                               by <b>aggelos</b> (subscriber, #41752)
                              [<a href="/Articles/722546/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Actually solving problems is not in the interest of most people in the security field. Randomized defenses which "raise the bar", only to be conclusively shown inadequate within a few months are very convenient that way. This is a pattern both in academia and the industry. By pursuing defenses which cannot be complete (if you allow arbitrary programmer expressivity, you're always confronted with the halting problem), you keep the arms race going. This is to the benefit of both defenders and attackers (keeps the funds flowing).</p>

<p>Not being totally cynical about this, as of course "raising the bar" <i>now</i> is a consideration for many production deployments. In my (perhaps poorly informed) opinion though, the allocation of funds is clearly not concerned with eventually having robust solutions, just with piling complexity on top of complexity (academia is pretty good at that) with no end in sight.</p>

<p>And yes, there's no way to have flawless programs. Logic errors aside, even in a memory safe language, the programmers can very well implement their own instruction set and have a memory safety violation in their binary code (which would only be data to the type system). This is not really in the same class of "fundamentally unworkable" as expecting a huge source base to be kept bug free (see the recent kernel quotes of the week). This line of thought is a total derailment IMHO.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/722546/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor722545"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How much entropy is actually gained ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 9:00 UTC (Fri)
                               by <b>moltonel</b> (guest, #45207)
                              [<a href="/Articles/722545/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While it's certainly a step in the right direction (better security with zero runtime cost, yeah !), I wonder if it'll be a big deterrent to exploit writers, who are used to working around randomization by trying many combinations. Is there some study that quantifies the gains ?<br>
<p>
A 2-fields struct ought to give 1 bit of entropy, except if the exploit can still function when overwriting all fields instead of one. I suspect that randomization is also restricted to avoid padding bloat, so a 10-fields struct might not add 10 bits of entropy. Things get better when a exploit has to subvert multiple structs in a row, but I wonder of frequent that is ?<br>
<p>
It's interesting to compare that to the efforts of the rust community which has also implemented field reordering (<a href="http://camlorn.net/posts/April%202017/rust-struct-field-reordering.html">http://camlorn.net/posts/April%202017/rust-struct-field-r...</a>). In their case the main goal is speed (reduce struct padding) rather than security (although adding a bit of randomization on top of that should be a comparatively small step), and it's opt-out rather than opt-in (when a struct is an interface to C code, basically).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722545/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722554"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How much entropy is actually gained ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 12:11 UTC (Fri)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/722554/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; While it's certainly a step in the right direction (better </font><br>
<font class="QuotedText">&gt; security with zero runtime cost</font><br>
<p>
Has it been shown to have zero runtime cost?<br>
<p>
What about structs that cross cachelines?  Suddenly frequently accessed fields that are close together and have good cache behavior might be moved apart.<br>
<p>
Or structs that used to be far apart might be moved together and cause false sharing which is a really hard performance issue to track down.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722554/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722608"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How much entropy is actually gained ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 19:40 UTC (Fri)
                               by <b>Lionel_Debroux</b> (subscriber, #30014)
                              [<a href="/Articles/722608/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The version of RANDSTRUCT in grsecurity definitely aims at addressing at least your first concern, and possibly your second one as well. The Kconfig snippet corresponding to the GRKERNSEC_RANDSTRUCT_PERFORMANCE config option reads:<br>
+config GRKERNSEC_RANDSTRUCT_PERFORMANCE<br>
+       bool "Use cacheline-aware structure randomization"<br>
+       depends on GRKERNSEC_RANDSTRUCT<br>
+       default y if GRKERNSEC_CONFIG_PRIORITY_PERF<br>
+       help<br>
+         If you say Y here, the RANDSTRUCT randomization will make a best effort<br>
+         at restricting randomization to cacheline-sized groups of elements.  It<br>
+         will further not randomize bitfields in structures.  This reduces the<br>
+         performance hit of RANDSTRUCT at the cost of weakened randomization.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722608/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722635"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How much entropy is actually gained ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 10:53 UTC (Sat)
                               by <b>aggelos</b> (subscriber, #41752)
                              [<a href="/Articles/722635/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In the absence of any way to quantify the "security" "increase" by this kind of defense, how could one possibly decide whether they want to make this tradeoff or not? I mean, yah, if you can't afford any slowdown at all then sure, you probably want to set this option at least. In the absence of hard "fails to perform adequately"-situations though, this seems to be more of a CYA solution for the vendor, not the user. "Here's a choice that's impossible to make. Take a guess and it's not our fault for the users that get it wrong". There's really a continuum here (e.g. structures consisting only of function pointers are usually singletons, so you can "raise the bar" by blowing them up X% and fill them with booby-trap function pointers) and this applies to most other kinds of probabilistic defenses too.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722635/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor722643"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How much entropy is actually gained ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 14:21 UTC (Sat)
                               by <b>Nelson</b> (subscriber, #21712)
                              [<a href="/Articles/722643/">Link</a>] 
      </p>
      
      </div>
      </summary>
      How does the system maintain compatibility with anything?

You clearly can't randomize the unions and structs that are used to read network packets.  Nor could you do that to any structs that are used for device register access.   

You could randomize the structs that are part of the kernel API, but every application would have to be rebuilt with the knowledge of how they are randomized.  You can really only safely do this to completely internal structures which doesn't seem as useful.
      
          <div class="CommentReplyButton">
            <form action="/Articles/722643/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor722648"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">How much entropy is actually gained ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 17:57 UTC (Sat)
                               by <b>zlynx</b> (guest, #2285)
                              [<a href="/Articles/722648/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The biggest advantage to these things is that it tends to remove stealth from attacks. The system administrator should notice repeated kernel BUG outputs and/or system crashes caused by overwriting random struct fields.<br>
<p>
With a perfect attack script, the administrator never notices anything wrong and the attack leaves no traces.<br>
<p>
Once an attack is noticed, the machine can be turned into a honeypot with full network recording. On the next attack, you've then got the complete log of how it was done, and can find and patch the bug.<br>
<p>
It's the difference between breaking into a building with a copied key or lockpicks, vs. breaking the glass and setting off the alarm. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722648/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor722547"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 9:02 UTC (Fri)
                               by <b>aggelos</b> (subscriber, #41752)
                              [<a href="/Articles/722547/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>Nevertheless, Torvalds is unimpressed by structure randomization, calling it security theater.</blockquote>

<p>No argument here. Can anyone explain why this is going into the kernel then? Or why KASLR went into the kernel? As an uninformed observer,
 I have a bit of trouble understanding the acceptance criteria that Torvalds and the core kernel developers apply here.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/722547/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722556"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 12:49 UTC (Fri)
                               by <b>MatejLach</b> (guest, #84942)
                              [<a href="/Articles/722556/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd reckon it has something to do with there not being too many downsides of merging it in and it offering *some* additional obfuscation, even if not real *security* (in depth). So given that and Torvalds probably being encouraged by others + a nice headline about Linux security actually being *strengthened*, as opposed to breached again,, Torvalds probably went something like; "Alllriigt then...I'll merge, but I am under no illusions that this really solves anything...", but I am purely guessing there.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722556/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor722594"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 12, 2017 15:57 UTC (Fri)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/722594/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It can be taken further:<br>
  - Generate random seed<br>
  - Feed seed to softcore generation for FPGA<br>
  - Feed seed to gcc toolchain build<br>
  - Build kernel and userland<br>
Now I have a "secure" device using a "random" instruction set that nobody else knows about. Happy cracking ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722594/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722624"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing kernel structures layout - external modules compulation?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 0:57 UTC (Sat)
                               by <b>darwish</b> (guest, #102479)
                              [<a href="/Articles/722624/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I do not understand how would this affect compiling external kernel modules?<br>
<p>
If I compile a module with a statement "x-&gt;y", how would a compiler know the _right_ actual offset of y? Would the seed be saved somewhere statically in the system? (E.g. /lib/modules/kernel-version/random-seed)<br>
<p>
And if the seed is stored somewhere globally readable, can't the exploit writer just use that? And if the seed is not globally readable, does that mean we will have to compile kernel modules using sudo / root access in the future?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722624/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor722625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debugging randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 0:58 UTC (Sat)
                               by <b>vomlehn</b> (guest, #45588)
                              [<a href="/Articles/722625/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm less than happy with this. I often dump out structure memory for, say 64 bytes or so, starting at some particular structure.  Then I look at the source for the structure to see where various things are. This will make that impossible. I will instead have to specify each item individually, which means paying a lot more attention to the debugger and less to debugging.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722652"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Debugging randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 18:32 UTC (Sat)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/722652/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can still do an eu-readelf --debug=info on the bit of the kernel containing the structure definition you're interested in and look at the debuginfo to see where the structure members are. (Yes, this is a drag.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722652/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor722629"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Contrary to reproducible builds</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 5:53 UTC (Sat)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/722629/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Reproducible builds" is another very popular topic in security.  RB is more useful to distros due to the need to distribute the randomization string associated with struct randomization.   I can't see why anyone with a public kernel build would go this route.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722629/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Contrary to reproducible builds</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2017 15:49 UTC (Mon)
                               by <b>and</b> (guest, #2883)
                              [<a href="/Articles/722778/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
RB should not be a problem: e.g., you can make the randomization seed depend on the hash of the tarball, so you'll get the same seed for different builds of the same thing but a different one for a different kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Contrary to reproducible builds</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2017 4:30 UTC (Tue)
                               by <b>alison</b> (subscriber, #63752)
                              [<a href="/Articles/722841/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;you can make the randomization seed depend on the hash of the tarball, so you'll get the same &gt;seed for different builds of the same thing but a different one for a different kernel.</font><br>
<p>
If I understand you correctly, the result would be that each release of a particular package would have a different layout of structs, but everyone who had the same source tarball would build the same package with the same structs.    That would certainly make exploits less portable across machines: they would work with the Fedora version of a package perhaps, but not the RHEL or CENTOS ones.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Contrary to reproducible builds</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 16, 2017 7:51 UTC (Tue)
                               by <b>and</b> (guest, #2883)
                              [<a href="/Articles/722854/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
exactly! With this, exploits would not even work for different versions of the Fedora kernel, i.e., the attacker would have to guess the exact patchlevel of the kernel to make an exploit that depends on structure layout work. While this usually won't stop state-sponsored adversaries from doing targeted attacks, it would likely prevent the spreading of most worms even in scenarios where everyone runs distribution kernels, so I think adding this functionality to the kernel is totally worth its costs. (note that this is just my personal "couch philosophy" -- I'm in involved that effort at all.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor722634"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 13, 2017 8:23 UTC (Sat)
                               by <b>tdz</b> (subscriber, #58733)
                              [<a href="/Articles/722634/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Glad I'm not the poor soul who has to debug with this...<br>
<p>
<font class="QuotedText">&gt; When potential attackers do not know the layout of a structure, it becomes much harder for them to overwrite specific fields in those structures. Thus, the barrier to exploitation is raised significantly</font><br>
<p>
There are 6 possible permutations for structures with 3 fields, 24 permutations for structures with 4 fields, and so one. With millions  (billions?) of installed kernel binaries, this still leaves a good number of systems for each variant. And if the attacker knows distribution and version number, the structure layout is trivial to find out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722634/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor722671"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Gentoo</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2017 4:33 UTC (Sun)
                               by <b>linuxrocks123</b> (guest, #34648)
                              [<a href="/Articles/722671/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In addition to Facebook and Google, presumably anyone who runs Gentoo would benefit from this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722671/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor722676"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 14, 2017 7:40 UTC (Sun)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/722676/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;structures consisting entirely of function pointers are automatically randomized. </font><br>
<p>
How does this even help to improve security?<br>
Even if I don't know the actual structure layout and thus don't know which pointer I'm going to overwrite, there's a good chance I could exploit it anyway. I would just have to try out each function call until I hit my overwritten one.<br>
Someone will eventually call the pointer. Otherwise it would not be there in the structure. And if that happens my code will run.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722676/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor722726"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 15, 2017 12:52 UTC (Mon)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/722726/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You seem to have assumed that you'll be the one calling the functions. In some scenarios we may be relying upon somebody else to do the calling, and they may not be inclined to run whichever random function we've actually tampered with in the way we hoped.<br>
<p>
The pointers are there because _if_ the corresponding function is used we need to follow the pointer, but their presence doesn't mean anybody is actually obliged to use the function. Furthermore, in some cases function pointers are invoked conditionally. The kernel doesn't do this for simple "If exists then..." tests, which are traditionally done just by checking if the pointer is non-NULL (which will work if you scribble over it) but it does do this in other places, and some people's C code may not follow that style even for "if exists then..." tests so they'd benefit from this feature too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/722726/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor732902"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Randomizing structure layout</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 4, 2017 22:43 UTC (Mon)
                               by <b>bokr</b> (subscriber, #58369)
                              [<a href="/Articles/732902/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<p>
Terminology nit: IMO "hardening" is not the right term<br>
for what this is about, any more than making yourself<br>
harder to hit by wearing camouflage in your own bunker.<br>
It's not even a hard kevlar vest ;-)<br>
<p>
Sad if necessary, but real security will come by other means, ISTM.<br>
<p>
Obviously, people are trying, from BIOS/UEFI on through hypervisors<br>
and up and sideways to ineluctable management engines. Which may all<br>
be good and clever dogs, but better hope they can be trained to be<br>
loyal to you ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/732902/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2017, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
