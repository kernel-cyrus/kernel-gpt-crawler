        <!DOCTYPE html>
        <html lang="en">
        <head><title>CAP_PERFMON — and new capabilities in general [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/812719/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/812974/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/812719/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>CAP_PERFMON — and new capabilities in general</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 21, 2020</br>
           </div>
The <tt><a
href="http://man7.org/linux/man-pages/man2/perf_event_open.2.html">perf_event_open()</a></tt>
system call is a complicated beast, requiring a fair amount of study to
master.  This call also has some interesting security implications: it can
be used to obtain a lot of information about the running system, and the
complexity of the underlying implementation has made it more than usually
prone to unpleasant bugs.  In current kernels, the security controls around
<tt>perf_event_open()</tt> are simple, though: if you have the
<tt>CAP_SYS_ADMIN</tt> capability, <tt>perf_event_open()</tt> is available
to you (though the system administrator can make it available without any
privilege at all).  Some
current work to create a new capability for the perf events subsystem would
seem to make sense, raising the question of why adding new capabilities
isn't  done more often.
<p>
Capabilities are a longstanding effort to split apart the traditional Unix
superuser's powers into something more fine-grained, allowing
administrators to give limited privileges where needed without making the
recipients into full superusers.  There are <a
href="http://man7.org/linux/man-pages/man7/capabilities.7.html">37
capabilities</a> defined in 
current Linux kernels, controlling the ability to carry out a range of
tasks including configuring terminal devices, overriding resource limits,
installing kernel modules, or adjusting the system time.  Among these
capabilities, though, is <tt>CAP_SYS_ADMIN</tt>, nominally the capability
needed to perform system-administration tasks.  <tt>CAP_SYS_ADMIN</tt> has
become the default capability to require when nothing else seems to fit; it
enables so many actions that it has long been known as "<a
href="/Articles/486306/">the new root</a>".
<p>
A quick check shows well over
500 checks for <tt>CAP_SYS_ADMIN</tt> in the 5.6-rc kernel.  During the 5.6
merge window, new checks were added to allow holders of <tt>CAP_SYS_ADMIN</tt> to
send hardware-specific commands to obscure devices,
configure <a href="/Articles/766089/">time namespaces</a>,
load <a href="/Articles/811631/">BPF programs for kernel operations
structures</a>, and open access to x86 <a
href="https://en.wikipedia.org/wiki/Memory_type_range_register">MTRR</a>
registers.  

The perf events subsystem has also come to rely on
<tt>CAP_SYS_ADMIN</tt> to keep unprivileged users out.  As a result, to
enable a user to call <tt>perf_event_open()</tt>, an administrator must
also allow that user to mount filesystems, access PCI configuration spaces,
tune memory-management policies, load BPF programs, and more.  That is a
lot of privilege to associate with a task that ordinary users are fairly
likely to legitimately need to do.
<p>
This <a
href="/ml/linux-kernel/c8de937a-0b3a-7147-f5ef-69f467e87a13@linux.intel.com/">patch
set</a> from Alexey Budankov addresses that problem by creating a new
capability called <tt>CAP_PERFMON</tt> to govern performance-monitoring
tasks.  With this patch installed, users (or their programs) could be
granted <tt>CAP_PERFMON</tt> rather than <tt>CAP_SYS_ADMIN</tt>, enabling
them to get performance data without adding all those other powers.  Of
course, <tt>CAP_SYS_ADMIN</tt> would still be sufficient to call
<tt>perf_event_open()</tt>; otherwise the chances of breaking existing
systems are high.  But it would no longer be necessary if a user has
<tt>CAP_PERFMON</tt> instead.
<p>
At a first look, this change seems relatively obvious; it is hard to
complain about separating out a relatively constrained, low-danger
activity from a powerful capability.  But it does lead one to wonder why
this kind of change is done so rarely.  The last time a new capability was
added was in 2014, when <a
href="https://git.kernel.org/linus/3a101b8de0d3"><tt>CAP_AUDIT_READ</tt></a>
joined the set.  It would appear that the last time a capability
was split out of <tt>CAP_SYS_ADMIN</tt> was <a
href="https://git.kernel.org/linus/ce6ada35bdf7">the creation of
<tt>CAP_SYSLOG</tt></a> in 2010.  Once something becomes part of
<tt>CAP_SYS_ADMIN</tt>, it seems, it stays there.  Why might that be the
case? 
<p>
One reason, of course, is the aforementioned compatibility issue: once
<tt>CAP_SYS_ADMIN</tt> allows an action, it can never lose that power
without possibly breaking existing systems.  When Serge Hallyn added
<tt>CAP_SYSLOG</tt>, he added the usual code that made things continue to
work if the process in question had <tt>CAP_SYS_ADMIN</tt>.  In that case,
though, the kernel issues a warning that use of <tt>CAP_SYS_ADMIN</tt>
for these operations is
deprecated.  Nearly ten years later, the compatibility code — and the
warning — remain.  Splitting capabilities out of <tt>CAP_SYS_ADMIN</tt> is
less than fully rewarding when the power of <tt>CAP_SYS_ADMIN</tt> itself
can never be reduced.
<p>
Adding capabilities has hazards of its own, in that existing code will know
nothing about a new capability and what it might control.  A program that
clears bits out of a capability mask is likely to clear the new one, but
that capability might be needed going forward.  Experience has shown that
running a privileged program with selectively removed capabilities can open
up surprising vulnerabilities; every new capability potentially creates
just that sort of situation.  So capabilities must be added with care.
There is a reason why the SELinux build has <a
href="https://elixir.bootlin.com/linux/latest/source/security/selinux/include/classmap.h#L31">a
check that explicitly fails</a> if new capabilities have been added without
corresponding changes in SELinux itself.
<p>
Then, there is the unfortunate fact that capabilities in Linux are seen by
many as a failed experiment.  Nobody has ever made a practical, fully
capability-based system using them, and many of the defined capabilities
are relatively easily escalated to full root powers.  Linux systems above
the kernel level have made limited use of them, if indeed capabilities have been
used at all.  It can be hard to generate enthusiasm for refining a system
that can never work as was originally intended and which may never be used
in any serious way.
<p>
As an example, one obvious way to use capabilities to reduce privilege
would be to remove the setuid bit on existing utilities and install just
the needed capabilities instead.  The kernel has supported <a
href="/Articles/211883/">file-based capabilities</a> since the 2.6.24
release in 2008
after all.  Your editor's current system, running Fedora&nbsp;31 (which
includes "first" among its goals) contains a grand total of nine binaries
with capabilities attached:
<p>
<pre>
    # getcap -r /
    /usr/bin/gnome-keyring-daemon = cap_ipc_lock+ep
    /usr/bin/clockdiff = cap_net_raw+p
    /usr/bin/arping = cap_net_raw+p
    /usr/bin/newuidmap = cap_setuid+ep
    /usr/bin/newgidmap = cap_setgid+ep
    /usr/bin/ping = cap_net_admin,cap_net_raw+p
    /usr/bin/gnome-shell = cap_sys_nice+ep
    /usr/sbin/mtr-packet = cap_net_raw+ep
    /usr/sbin/suexec = cap_setgid,cap_setuid+ep
</pre>
<p>
It is good to know that <tt>gnome-shell</tt> does not run setuid root, so
capabilities have brought some value here.  But that compares with 31
setuid root binaries; it would appear that there is no prospect of this
distribution becoming capability-only anytime soon.
<p>
That said, there are signs of a shift with regard to capabilities.  The
never-ending desire to harden our systems against attacks is driving
developers to take another look at Linux capabilities and how they might
help. The Android system makes use of capabilities, for example.  Systemd
gives administrators extensive control over the capabilities granted to
running programs.  It may just be that, after many years of disuse, Linux
capabilities are finally finding a place in deployed systems.
<p>
If that is the case, we may well see a renewed level of interest in
increasing the granularity of the permissions controlled by capabilities.
That could include splitting more powers out of <tt>CAP_SYS_ADMIN</tt>
though, as noted above, that must be done carefully.
<tt>CAP_SYS_ADMIN</tt> is unlikely to stop being the not-so-new root
anytime soon, but perhaps it could be made into a capability that few
programs need to have to get their work done.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Capabilities">Capabilities</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Capabilities">Capabilities</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/812719/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor812996"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2020 18:03 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/812996/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <p>Perhaps I just don't understand what the kernel developers are trying to do (which is a very real possibility as I don't read LKML religiously). But it appears that quite a lot of capability-guarded operations are inherently root-equivalent and cannot be meaningfully sandboxed without a complete redesign of Linux's security model. Some examples:
<ul>
<li>"Mount and unmount any filesystem" can be used to create a setuid-root binary, to backdoor anything in /bin or /sbin, and for a variety of other privilege escalation attacks.
<li>"ptrace any process" can be used to execute arbitrary code as any user who is running code on the machine, which will generally include root.
<li>"Load kernel modules" can be used to execute arbitrary code in kernel space, because that's exactly what it is meant to do.
<li>"Call setuid(2) with any value" can be used to become root, and then full capabilities are regained on calling execve(2).
</ul>
<p>I don't really understand the purpose of trying to sandbox operations similar to the above. I suppose capabilities could be used to mitigate the confused-deputy problem in some cases, but they seem like a rather roundabout way of doing that (contrast seccomp, containers, etc.). Of course, there are privileged operations which are not root-equivalent, and sandboxing those does make sense. I just don't understand why capabilities are applied to literally every privileged operation under the sun.
      
          <div class="CommentReplyButton">
            <form action="/Articles/812996/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813004"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2020 19:17 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/813004/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The operative word is "can be". These granular privileges aren't supposed to be granted to any random user process.<br>
<p>
The idea is that the program that's been granted the privilege needs only be careful when using that exact privilege.<br>
<p>
As an example, a program that has "mount any filesystem" privileges needs only be careful when actually mounting a file system, but not when opening the file that's backing the data for the file system (just as a random example). Similarly, the system profiler might be allowed to profile the system, but not to overwrite /etc/shadow with the resulting data.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813004/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813005"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2020 19:54 UTC (Fri)
                               by <b>smcv</b> (subscriber, #53363)
                              [<a href="/Articles/813005/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  The idea is that the program that's been granted the privilege needs only be careful when using that exact privilege</font><br>
<p>
... and when defending itself against being subverted by processes that don't have the privilege, including its parent process.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813005/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor814661"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 12, 2020 16:29 UTC (Thu)
                               by <b>immibis</b> (guest, #105511)
                              [<a href="/Articles/814661/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think that was his/her point - you know that any subversion has to go through the mechanism to which permission is granted, so you only need to be especially careful there. You don't need to check the output file path the parent passed to you, because you don't have any special permission to write to files that the parent process couldn't write to anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/814661/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor813014"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 21, 2020 21:57 UTC (Fri)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/813014/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It depends on the usecase. Some capabilities are not equivalent to root, and others can be paired with other defense mechanism:<br>
<p>
<font class="QuotedText">&gt; "Mount and unmount any filesystem" can be used to create a setuid-root binary, to backdoor anything in /bin or /sbin, and for a variety of other privilege escalation attacks. </font><br>
<p>
Not in combination with mount namespaces + seccomp to block exec, for example. A program that is launched as root can set them up before dropping all other capabilities.<br>
<p>
<font class="QuotedText">&gt; "Call setuid(2) with any value" can be used to become root, and then full capabilities are regained on calling execve(2). </font><br>
<p>
Besides using seccomp to block execve, you can also use inheritable capabilities so that children do not keep them.<br>
<p>
In other cases, the environment around the program can limit the root-equivalence of capabilities:<br>
<p>
<font class="QuotedText">&gt; "Load kernel modules" can be used to execute arbitrary code in kernel space, because that's exactly what it is meant to do. </font><br>
<p>
You can use SELinux to prevent the program from loading a .ko file that wasn't given a particular SELinux label; or you can reject non-signed modules.<br>
<p>
<font class="QuotedText">&gt; "ptrace any process" can be used to execute arbitrary code as any user who is running code on the machine, which will generally include root. </font><br>
<p>
A process that runs in a pid namespace will not be able to exit it and do ptrace outside its pid namespace (IIRC).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813014/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813040"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 12:35 UTC (Sun)
                               by <b>ibukanov</b> (guest, #3942)
                              [<a href="/Articles/813040/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Those examples actually prove the grand-parent point. In my experience things like no-new-privileges, namespaces, syscall filters are vastly more useful to secure systems than capabilities. With those it is possible to secure a system even without restricting capabilities, while capabilities alone cannot realistically secure the system. Then again, why it took so long to come up with ambient capabilities that allow to grant a particular capability to a particular invocation of a process, not each and every execution of a binary? <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813040/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813041"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 12:45 UTC (Sun)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/813041/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Capabilities alone are useless. Capabilities make no new privs, seccomp stronger and seccomp makes capabilities usable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813041/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor813020"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 22, 2020 8:03 UTC (Sat)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/813020/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On a large number of deployed systems, any ordinary user account can be escalated to root, either because of unpatched bugs or because the architecture is inherently not that secure. That does not mean the whole structure of user permissions is useless.<br>
<p>
A buggy daemon running as root will be much easier to subvert than one that runs as a normal user account with a couple of extra capabilities. Those capabilities might get you root through a few tricks, but getting the daemon to perform those steps is harder than getting it to overwrite a random file because of missing path sanitization. <br>
<p>
For human accounts it can also work to have specific administrative roles with their needed capabilities rather than an all-powerful root account. This is why even oclassical Unix systems have a sudoers file, so admins log in with an ordinary account and ‘sudo’ particular commands when needed. In principle this gives the same power as just logging in as root, but it gives better protection against mistakes and some auditing of what the admin does, even if half the time the command is ‘sudo bash’. <br>
<p>
In simpler times there were efforts to split the human admin account into its capabilities too. Windows NT defined roles like ‘Backup operator’. Unfortunately the messy world we inhabit means that any admin probably does need full access to get anything done.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813020/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813028"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 22, 2020 20:03 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/813028/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; A buggy daemon running as root will be much easier to subvert than one that runs as a normal user account with a couple of extra capabilities. </font><br>
The problem is that there are almost no capabilities that are useful for regular daemons, with the exception of CAP_SYS_NET_BIND (which shouldn't have existed in the first place).<br>
<p>
So if your daemon runs as root then it probably needs it for something that can't be expressed as capabilities anyway.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813028/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813160"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2020 17:24 UTC (Mon)
                               by <b>imMute</b> (guest, #96323)
                              [<a href="/Articles/813160/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why do you believe CAP_NET_BIND_SERVICE shouldn't exist?<br>
I, for one example, believe it would be useful to allow an HTTP server to bind to port 80/443 without needing to be started as root.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813160/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813161"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2020 17:49 UTC (Mon)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/813161/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Why do you believe CAP_NET_BIND_SERVICE shouldn't exist?</font><br>
Because there should have been no restriction on &lt;1024 ports to begin with (i.e. everything should have CAP_NET_BIND_SERVICE).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813161/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor813171"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2020 18:38 UTC (Mon)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/813171/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You could pass the open port to the web server as an open file descriptor.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813171/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813173"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2020 19:16 UTC (Mon)
                               by <b>andresfreund</b> (subscriber, #69562)
                              [<a href="/Articles/813173/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And then when the web server wants to e.g. use SO_REUSEPORT to have a separate socket for each socket / group of cores/core, you have to teach your system startup tooling that. And can't configure it in the application's config file anymore. <br>
<p>
Not saying that passing the fd in is not a good solution in some cases, just that it does has its own set of implied limitations.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813173/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor813067"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 19:20 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/813067/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; On a large number of deployed systems, any ordinary user account can be escalated to root, either because of unpatched bugs or because the architecture is inherently not that secure. That does not mean the whole structure of user permissions is useless.</font><br>
<p>
The difference, I think, is that you are describing a bug, and I am describing how the system was designed to work.<br>
<p>
Obviously, defense in depth is a Good Thing. I am not suggesting we eliminate capabilities entirely, or that we do anything at all, for that matter. The concern is that additional complexity in privileged code (such as the kernel) carries additional risk. So when adding new layers of security,  we need to balance the security benefits with the complexity. It's not clear to me how capabilities strike that balance, and under what circumstances they ought to be used in concert with or in lieu of seccomp, containerization, SELinux, etc. As a sysadmin, I would like to know which security subsystems are actually best practices, and which ones are just there because somebody wanted them to be there.<br>
<p>
<font class="QuotedText">&gt; A buggy daemon running as root will be much easier to subvert than one that runs as a normal user account with a couple of extra capabilities. Those capabilities might get you root through a few tricks, but getting the daemon to perform those steps is harder than getting it to overwrite a random file because of missing path sanitization.</font><br>
<p>
This is a reasonable point. As I said, capabilities do offer some defense against confused deputies. It's just not clear to me that they are the Right Way to go about doing that.<br>
<p>
(Of course, this is a more general problem with Linux. The man pages are great at telling you what syscall X does, but often not so good at telling you why you might want that functionality, or how you might choose to compose it with other syscalls. Section 7 pages frequently do provide this information, but they can be hard to find because it's less obvious what name you should give to man. Section 2 pages, on the other hand, tend to be rather terse. I realize this is by design, but rightly or wrongly, many people learn to program Unix by reading man pages, and this is not a great first impression.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813067/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813109"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2020 13:28 UTC (Mon)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/813109/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
True.  I think that splitting the root account's powers into umpteen different capability bits is conceptually pretty simple.  Instead of checking uid==0 you check whether the relevant bit is set.  There's not too much to go wrong in that, and it's certainly less code than SELinux or seccomp.  The hard part seems to be finding space for the bitmask in relevant structures and perhaps in filesystems .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813109/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor813034"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 7:08 UTC (Sun)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/813034/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; One reason, of course, is the aforementioned compatibility issue: once CAP_SYS_ADMIN allows an action, it can never lose that power without possibly breaking existing systems. When Serge Hallyn added CAP_SYSLOG, he added the usual code that made things continue to work if the process in question had CAP_SYS_ADMIN. In that case, though, the kernel issues a warning that use of CAP_SYS_ADMIN for these operations is deprecated. Nearly ten years later, the compatibility code — and the warning — remain. Splitting capabilities out of CAP_SYS_ADMIN is less than fully rewarding when the power of CAP_SYS_ADMIN itself can never be reduced.</font><br>
<p>
I do not buy this. The compatibility code could be made optional in kernel config. There already are a bunch of options that say in the help text "Only enable this if you want to run binaries from the stone age." Probably there is no demand for such an option because CAP_SYS_ADMIN is omnipotent anyway. The reward for splitting capabilities out of CAP_SYS_ADMIN is not that CAP_SYS_ADMIN becomes less powerfull. The reward is that less processes need the power of CAP_SYS_ADMIN and processes can use less privileged capabilities instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813034/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor813039"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 12:10 UTC (Sun)
                               by <b>meyert</b> (subscriber, #32097)
                              [<a href="/Articles/813039/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Increasing major version number to 5 could have been used to introduce breaking changes like above deadlock situation, and get rid of other legacy stuff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813039/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813065"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 18:35 UTC (Sun)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/813065/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Alas — Linux kernel does not use semantic versioning. The model is "we do not break userspace".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813065/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor813070"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 23, 2020 19:01 UTC (Sun)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/813070/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A majver bump for Linux means "Linus woke up and felt like bumping the majver instead of the minver", and nothing more.<br>
<p>
To be allowed to break a userspace interface, you have to be able to demonstrate that nobody who's paying attention is using that interface on a system that has a realistic prospect of being upgraded to the new kernel version.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813070/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor813104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 24, 2020 7:53 UTC (Mon)
                               by <b>diconico07</b> (guest, #117416)
                              [<a href="/Articles/813104/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Another reason to add capabilities carefully is the fact there can only be a limited number of these (64 if I remember well), so a badly defined or "useless" capability (e.g CAP_SYS_PACCT or CAP_NET_BROADCAST) only lowers the number of capabilities for future features that would be needing a clearly separated capability.<br>
<p>
I really think CAP_SYS_ADMIN is bloated and unusable, and that some of its feature could have get their own capability (e.g seccomp related checks), because for now I prefer giving root rather than CAP_SYS_ADMIN as it shows more clearly that the process might do dangerous things in a quite uncontrollable manner (without other things like seccomp and al.), however I don't think we can have this balance of having some really usable and useful capabilities without having some bloated ones (remember that there is nothing just checking for root in the kernel anymore, becoming root just means getting all capabilities).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813252"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">CAP_PERFMON — and new capabilities in general</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 25, 2020 17:35 UTC (Tue)
                               by <b>Freeaqingme</b> (subscriber, #103259)
                              [<a href="/Articles/813252/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I concur.<br>
<p>
A few years ago I had a process that spawned workers. The parent process would then assign jobs to these workers. I wanted every job to be performed in a specific namespace/cgroup. Therefore, I needed the master process to change the namespaces of the spawned workers. Such a syscall does not exist, so we decided the worker should switch to that namespace (setns()) itself.<br>
<p>
Ideally, we'd not run the child processes as root because they also executed/processed user input. As such, I set out to implement a custom capability that would grant a process the rights to change its namespace/cgroups without having to run as root.<br>
<p>
A few limitations I ran into:<br>
- There's indeed a max of 64 (IIRC) capabilities. This makes it difficult to pick a number of which you're sure it won't be used by another capability (introduced by 'upstream') in the future.<br>
- I don't entirely recall it anymore, but I believe we'd have to modify libcap, libapparmor, libc as well as the kernel itself.<br>
<p>
These constraints make it hard to prototype something. Lack of prototypes will probably also - at least in part - be a reason why there's not much of it upstreamed.<br>
<p>
Also, because it's very specific to our use case, I did expect that upstream would not be willing to accept this new privilege. That may be a reason why there's so relatively few capabilities. For every scenario a different capability could probably be thought of. <br>
<p>
I'm not a seasoned kernel developer, so I may have had some more challenges than someone more experienced in this regard would have been. However, after trying various options for a couple of days, our solution simply was to run the mentioned master process as root, and harden it through things like appamor instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813252/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor813771"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reducing CAP_SYS_ADMIN</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2020 13:40 UTC (Wed)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/813771/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think that as a new capability is added, that ability should be "deleted" from CAP_SYS_ADMIN. Have a boot flag that says "restrict CAP_SYS_ADMIN" and those abililties will no longer be there (okay the default is don't restrict, and those abilities will still be available to anything that needs them).<br>
<p>
But then, if we get the distros on board, especially long term distros like RHEL, they should state that "anything that won't compile and run when the flag is on, is not supported". If the long-term-kernel maintainers also agree that no capability-removal code will be back-ported, so the CAP_SYS_ADMIN capabilities are fixed for any individual x.y kernel, then there is clear pressure on upstream to support new capabilities, and users who run longer-term kernels can rely on the capability system to provide the protection it was designed to.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813771/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor813772"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Reducing CAP_SYS_ADMIN</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2020 14:20 UTC (Wed)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/813772/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Won't that break containers running older distros on newer kernels? Would we need capability namespaces then?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/813772/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2020, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
