        <!DOCTYPE html>
        <html lang="en">
        <head><title>ELCE: Grant Likely on device trees [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/414016/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/413521/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/414016/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>ELCE: Grant Likely on device trees</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>November 10, 2010</br>
           </div>
<p>
Device trees are a fairly hot topic in the embedded Linux world as a means
to more easily support multiple system-on-chip (SoC) devices with a single
kernel image.  Much of the work implementing device trees for the PowerPC
architecture, as well as making that code more generic so that others could
use it, has been done by Grant Likely.  He spoke at the recent <a
href="http://www.embeddedlinuxconference.com/elc_europe10/index.html">Embedded
Linux Conference Europe</a> (ELCE) to explain what device trees are, what
they can do, and to update the attendees on efforts to allow the ARM
architecture use them.
</p>

<a href="https://lwn.net/Articles/414439/">
<img src="https://static.lwn.net/images/2010/elce-likely-sm.jpg" border=0 hspace=3 align="left"
width=96 height=125 alt="[Grant Likely]">
</a>

<p>
All of the work that is going into adding device tree support for various
architectures is not being done for an immediate benefit to users, Likely said.  It
is, instead, being done to make it easier to manage embedded Linux
distributions, while simplifying the boot process.  It will also make
it easier to port devices (i.e. components and "IP blocks") to different
SoCs. But it is "<q>not going to make your Android phone faster</q>". 
</p>

<p>
A device tree is just a data structure that came from <a href="http://en.wikipedia.org/wiki/Open_Firmware">OpenFirmware</a>.  It
represents the devices that are part of particular system, such that it can
be passed to the kernel at boot time, and the kernel can initialize and use
those devices.  For architectures that don't use device trees, C code must
be written to add all of the different devices that are present in the hardware.
Unlike desktop and server systems, many embedded SoCs do not provide a way
to enumerate their devices at boot time.  That means developers have to
hardcode the devices, their addresses, interrupts, and so on, into the kernel.
</p>

<p>
The requirement to put all of the device definitions into C code is hard to
manage, Likely said.  Each different SoC variant has to have its own,
slightly tweaked kernel version.  In addition, the full configuration of
the device is scattered over multiple C files, rather than kept in a single
place.  Device trees can change all of that.
</p>

<p>
A device tree consists of a set of nodes with properties, which are simple key-value pairs.  The nodes are organized into a tree
structure, unsurprisingly, and the property values can store arbitrary data
types.  In addition, there are some standard usage conventions for
properties so that they can be reused in various ways.  The most important
of these is the <tt>compatible</tt> property that uniquely defines devices, but
there are also conventions for specifying address ranges, IRQs, GPIOs, and
so forth.
</p>

<p>
Likely used a <a
href="http://devicetree.org/Device_Tree_Usage#Basic_Concepts">simplified
example from 
devicetree.org</a> to show what these trees look like.  They are
defined with an essentially C-like syntax:
<pre>
    / {
	compatible = "acme,coyotes-revenge";

	cpus {
	    cpu@0 {
		compatible = "arm,cortex-a9";
	    };
	    cpu@1 {
		compatible = "arm,cortex-a9";
	    };
	};

	serial@101F0000 {
	    compatible = "arm,pl011";
	};
        ...
	external-bus {
	    ethernet@0,0 {
		compatible = "smc,smc91c111";
	    };

	    i2c@1,0 {
		compatible = "acme,a1234-i2c-bus";
		rtc@58 {
		    compatible = "maxim,ds1338";
		};
	    };
            ...

</pre>

The <tt>compatible</tt> tags allow companies to define their own namespace
("acme", "arm", "smc", and "maxim" in the example) that they can manage
however they like. 
The kernel already knows how to attach an ethernet device to a local bus or
a temperature sensor to an i2c bus, so why redo it in C for every
different SoC, he asked.  By parsing the
device tree (or the binary "flattened" device tree), the kernel can set up the
device bindings that it finds in the tree.
</p>

<p>
One of the questions that he often gets asked is: "<q>why bother
changing what we already have?</q>"  That is a "<q>hard question to
answer</q>" in some ways, because for a lot of situations, what we have
in the kernel currently does work.  But in order to support large numbers
of SoCs with a single kernel (or perhaps a small set of kernels), something
like device tree is required. Both Google (for Android) and Canonical (for
Linaro) are very interested in seeing device tree support for ARM.
</p>

<p>
Beyond that, "<q>going data-driven to describe our platforms is the
right thing to do</q>".  There is proof that it works in the x86 world
as "<q>that's how it's been done for a long time</q>".  PowerPC
converted to device trees five years ago or so and it works well.  There
may be architectures that won't need to support multiple devices
with a single kernel, and device trees may not be the right choice for
those, but for most of the architectures that Linux supports, Likely
clearly thinks that device trees are the right solution.
</p>

<p>
He next looked at what device trees aren't.  They don't replace
board-specific code, and developers will "<q>still have to write drivers
for weird stuff</q>".  Instead, device trees simplify the common case.
Device tree is also not a boot architecture, it's "<q>just a data
structure</q>".  Ideally, the firmware will pass a device tree to the
kernel at boot time, but it doesn't have to be done that way.  The device
tree could be included into the kernel image.  There are plenty of devices
with firmware that doesn't know about device trees, Likely said, and they
won't have to.
</p>

<p>
There is currently a push to get ARM devices into servers, as they can
provide lots of cores at low power usage.  In order to facilitate that,
there needs to be one CD that can boot any of those servers, like it is in
the x86 world.  Device trees are what will be used to make that happen,
Likely said.
</p>

<p>
Firmware that does support device trees will obtain a <tt>.dtb</tt>
(i.e. flattened device tree binary) file from somewhere in memory, and
either pass it verbatim to the kernel or modify it before passing.  Another
option would be for the firmware to create the <tt>.dtb</tt> on-the-fly,
which is what OpenFirmware does, but that is a "<q>dangerous</q>"
option.  It is much easier to change the kernel than the firmware, so any
bugs in the firmware's <tt>.dtb</tt> creation code will inevitably be
worked around in the 
kernel. In any case, the kernel doesn't care how the <tt>.dtb</tt> is created. 
</p>

<p>
For ARM, the plan is to pass a device tree, rather than the existing,
rather inflexible ARM device configuration known as ATAGs.  The kernel
will set up the memory for the processor and unflatten the <tt>.dtb</tt>
into memory.  It will unpack it into a "<q>live tree</q>" that can
then be directly dereferenced and used by the kernel to register devices.
</p>

<p>
The Linux device model is also tree-based, and there is some congruence
between device tree and the device model, but there is not a direct 1-to-1
mapping between them.  That was done "<q>quite deliberately</q>" as
the design goal was "<q>not to describe what Linux wants</q>",
instead it was meant to describe the hardware.  Over time, the Linux device
model will change, so hardcoding Linux-specific values into the device tree
has been avoided.  The device tree is meant to be used as support data, and
the devices it describes get registered using the Linux device model.
</p>

<p>
Device drivers will match <tt>compatible</tt> property values with device nodes in
a device tree.  It is the driver that will determine how to
configure the device based on its description in a device tree.  None of
that configuration code lives in the device tree handling, it is part of
the drivers which can then be built as loadable kernel modules.
</p>

<p>
Over the last year, Likely has spent a lot of time making the device tree
support be generic.  Previously, there were three separate copies of much
of the support code (for Microblaze, SPARC, and PowerPC).  He has removed
any endian dependencies so that any architecture can use device trees.
Most of that work is now done and in the mainline.  There is some minimal
board support that has not yet been mainlined.  The MIPS architecture has
added device tree support as of 2.6.37-rc1 and x86 was close to getting it
for 2.6.37, but some last minute changes caused the x86 device tree support to
be held back until 2.6.38.
</p>

<p>
The ARM architecture still doesn't have device tree support and ARM
maintainer Russell King is "<q>nervous about merging an unmaintainable
mess</q>".  King is taking a wait-and-see approach until a real ARM
board has device tree
support.  Likely agreed with that approach and ELCE provided an opportunity
for him and King to sit down and discuss the issue.  In the next
six months or so (2.6.39 or 2.6.40), Likely expects that the board support
will be completed and he seems confident that ARM device tree support in
the mainline won't be far behind.
</p>

<p>
There are other tasks to complete in addition to the board support, of
course, with documentation being high on that list.  There is a need for
documentation on how to use device trees, and on the property conventions
that are being used.  The <a
href="http://devicetree.org/Main_Page">devicetree.org wiki</a> is a
gathering point for much of that work.
</p>

<p>
There were several audience questions that Likely addressed, including the
suitability of device tree for Video4Linux (very suitable and the
<tt>compatible</tt> property gives each device manufacturer its own
namespace), the 
performance impact (no complaints, though he hasn't profiled it &mdash;
device trees are typically 4-8K in size, which should minimize their
impact), and licensing or patent issues (none known so far, the code is
under a BSD license so it can be used by proprietary vendors &mdash; IBM's
lawyers don't seem concerned).  Overall, both Likely and the audience
seemed very optimistic about the future for device trees in general and
specifically for their future application in the ARM architecture.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Device_tree">Device tree</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/414016/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor414705"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 5:40 UTC (Thu)
                               by <b>glikely</b> (subscriber, #39601)
                              [<a href="/Articles/414705/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks for the coverage Jake.<br>
<p>
A few words of clarification: First off, while I was peripherally involved with the initial migration of all powerpc support to use a device tree, the credit for most of the heavy lifting goes to others like Paul Mackerras, Ben Herrenschmidt,  Becky Bruce, David Gibson and others. I'm building on their work, and many thanks go to tbem.<br>
<p>
Second, while I know that Canonical and Linaro are both committed to device tree support, I cannot comment on Google's plans. As it stands, Brian Swetland from Android has eloquently expressed his skepticism about the device tree approach and has no intention of using it (which is fine; the current code allows dt and non-dt platforms to coexist. Board ports are not forced to use a dt).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/414705/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor414767"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 11:10 UTC (Thu)
                               by <b>etienne</b> (guest, #25256)
                              [<a href="/Articles/414767/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I still would like to know what is better using a device tree than using a standard relocatable (common to all ARM) kernel and running a last linker command for each ARM configuration.<br>
Anyway, if the bus cannot be queried for what it contains and at which address - that means that those address are constant and at some point the kernel has to know them.<br>
So the same kernel with few relocations would be distributed to all ARMs targets, and each target would have to do a partial and final "ld" with a linker command file containning something like:<br>
<p>
smc91c111_base = 0x1532000;<br>
rtc_ds1338_v1 = 0;<br>
rtc_ds1338_v2 = 0x15325000;<br>
memcpy = memcopy_cortex_a9;<br>
<p>
Each driver should check that the base address of its device is not null before trying to initialise itself.<br>
If a higher level description is needed, a tool can be used to generate that linker command file.<br>
Maybe there is something I am missing?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/414767/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor414779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 11:39 UTC (Thu)
                               by <b>kronos</b> (subscriber, #55879)
                              [<a href="/Articles/414779/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can add information about addresses and interrupts (and also device specific data) to the tree. There are example on <a href="http://devicetree.org">http://devicetree.org</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/414779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor414787"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2010 12:16 UTC (Thu)
                               by <b>etienne</b> (guest, #25256)
                              [<a href="/Articles/414787/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, I do not see the problem of having:<br>
serial_irq = 3;<br>
network_irq = 4;<br>
in the linker microcontroller-dependant-file,<br>
and you can include explicit data in this file too:<br>
<a href="http://sourceware.org/binutils/docs-2.20/ld/Output-Section-Data.html#Output-Section-Data">http://sourceware.org/binutils/docs-2.20/ld/Output-Sectio...</a><br>
You could even include binary blob if that is your aim.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/414787/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor415247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2010 23:48 UTC (Fri)
                               by <b>giraffedata</b> (guest, #1954)
                              [<a href="/Articles/415247/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
The most important of these is the <tt>compatible</tt> property that uniquely defines devices
</blockquote>
<p>
It does nothing of the kind.  <tt>compatible</tt> classifies the device according to how you use it -- it essentially tells you what device driver to use for it.  Lots of devices have the same <tt>compatible</tt> property and it normally takes additional properties to completely and uniquely define any one of these.

      
          <div class="CommentReplyButton">
            <form action="/Articles/415247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor416888"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2010 22:35 UTC (Tue)
                               by <b>jgg</b> (subscriber, #55211)
                              [<a href="/Articles/416888/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I recently converted some old PPC code from the 'C' way to the device tree way and for the most part things were about the same.<br>
<p>
However, what really made a big difference was how much device tree cleans up the mess of GPIO, MDIO, I2C and other ancillary stuff.<br>
<p>
For instance our SOCs have a ethernet MAC driver that needs to speak to the PHY using MDIO over a certain bus. The bus, address and PHY chip changes depending on the platform, and several ethernet MACs often have to share the same MDIO. With device tree we specify all these relationships in the DT and things work great. The proper phy driver is loaded and attached to the MDIO, the proper MAC attaches to that, etc. <br>
<p>
Something similar happens with I2C as well, I2C auto probing doesn't work for real embedded systems, DTS cleans that up wonderfully. The C version it replaced was horrid.<br>
<p>
Frankly, I'm surprised at the reluctance from the ARM community. Just expressing the existing C code to setup each unique platform as a device tree and hard-wiring the tree into the kernel would clean things up a lot, without really changing how anything functions.<br>
<p>
The arguments I've seen for DT seem to think all the world is an eval board. I've never implemented an embedded CPU that matched an eval board exactly - we *always* change things. Generally we've had to #ifdef through the BSP for the eval board to get things working, it is an ugly mess that won't be upstreamed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/416888/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor416893"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">ELCE: Grant Likely on device trees</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2010 22:45 UTC (Tue)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/416893/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm confused, the arguments against device trees seem to be that they have C code to document every eval board so they don't need device trees.<br>
<p>
the arguments _for_ device trees seems to be that real-world devices largely contain the same types of devices as you find on eval boards, but hooked up in different ways, so the device tree tells the system how they are hooked up without having to have every system be it's own defineition in C.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/416893/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
