        <!DOCTYPE html>
        <html lang="en">
        <head><title>The trouble with dropping groups [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/621612/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/620192/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/621612/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The trouble with dropping groups</h1>
</div>
<div class="ArticleText">
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 19, 2014</br>
           </div>
Linux, like all but the earliest of Unix-like systems, allows a
process to be a member of multiple groups at any given time.  Any of those
group memberships can be used to make access-control decisions.  Changing
the list of groups a process belongs to is a privileged operation for
obvious reasons.  Recently, though, a developer started to think about
letting processes drop some groups from their lists.  On its face, allowing
a process to discard credentials seems like it should be a safe thing to
do.  In practice, it turns out that there are some surprises waiting for
anybody wanting to give the idea a try.
<p>
Josh Triplett would like to make it easy for unprivileged users to run
programs in a sandboxed mode.  As part of that work, he put together <a
href="/Articles/621617/">a patch</a> allowing an unprivileged process to
drop its membership in one or more groups.  The idea is that a user could
fire off a sandboxed process with minimal credentials, including a reduced
set of group memberships, without having to resort to privileged helper
commands.  That should reduce the level of privilege in the system overall
and, hopefully, make things more secure.
<p>
But it seems that no Unix-like system anywhere has made it possible for
unprivileged processes to drop group membership.  The reason may be
surprising, but it's there nonetheless: some systems use group membership
as a way of <i>reducing</i> privilege; such schemes would no longer work if
users could discard groups at will.
<p>
Casey Schaufler <a href="/Articles/621624/">jumped in</a> early with the
assertion that Tizen is one of the systems using groups in this way.  The
specific mechanism he is worried 
about is access control lists (ACLs).  An ACL can make either positive or
negative access decisions, so one can write an ACL to deny access to a
resource if the accessing process is a member of a given group.  It makes
sense in a way; user applications could be run with membership in a special
"untrusted" group that would be denied access to most system resources.
Casey was pretty clear in his opinion that this change should not be
merged:
<p><blockquote class="ad">
<b><tt>$ sudo subscribe today</tt></b>
<p>
Subscribe today and elevate your LWN privileges. You’ll have
access to all of LWN’s high-quality articles as soon as they’re
published, and help support LWN in the process.  <a href="https://lwn.net/Promo/nst-sudo/claim">Act now</a> and you can start with a free trial subscription.
</blockquote>
<p>
<div class="BigQuote">
	This is going to introduce a whole class of vulnerabilities.  Don't
	even think of arguing that the reduction in use of privilege will
	make up for that. Developers have enough trouble with the
	difference between setuid() and seteuid() to expect them to use
	group dropping properly.
</div>
<p>
Ted Ts'o <a href="/Articles/621626/">pointed out</a> that there is no need
to have ACLs to use groups as a negative access indicator.  Imagine you had
a directory called <tt>games</tt> that you wanted to make available to all
users except those in the <tt>games-abusers</tt> group.  All that is needed
is a command sequence like:
<p>
<pre>
    chown bin.games-abusers games
    chmod 705 games
</pre>
<p>
This will have the (possibly surprising) effect of blocking access to the
directory for anybody in the <tt>games-abusers</tt> group — the "no access"
group permission bits override the more open permissions for the whole
world.  Once again, being able to drop group membership would defeat this
kind of mechanism.
<p>
Finally, the sudo utility can also make decisions based on group membership or
the lack thereof.  Being able to drop group membership could thus enable a
user to get privileges via sudo that would normally have been denied.
<p>
As it happens, on a Linux system one does not actually need Josh's patch to
be able to drop group membership.  As Andy Lutomirski <a
href="/Articles/621627/">noted</a>, user namespaces already make that
possible.  In a user namespace, normal users can have root access and can
thus call <tt>setgroups()</tt>.  In
theory, that access does not enable any expanded privilege outside of the
namespace, but, as can be seen here, a few surprises still lurk in that
code.  Beyond <tt>setgroups()</tt>, though, user namespaces can be used to
drop groups by simply neglecting to map them to groups outside of the
namespace; see <a href="/Articles/532593/">this article</a> for details on
how this mapping works.  Andy sees the problem as being serious enough that
he <a 
href="/Articles/621629/">reported</a> it to the oss-security mailing list
as a vulnerability with no fix available.
<p>
A few of the participants in the discussion seemed to feel that the idea of
using credentials to reduce privilege was a bit backward.  But it appears
to be something that people do, so breaking it is not an option.  For the
case of user namespaces, some sort of fix will have to be applied; it may
become impossible to drop group memberships from within a user namespace.
The sudo problem can be addressed by only allowing groups to be dropped if
the "no new privileges" flag (originally introduced for <a
href="/Articles/475678/">system call filtering</a>) is set, but Eric
Biederman <a href="/Articles/621631/">worries</a> about the additional
complexity that would bring in.
<p>
There was talk of adding a sysctl knob to control the unprivileged dropping
of group membership.  Such a flag would default to "off"; system
administrators could turn it on if they were confident that it would not
subvert the security models in use on their systems.  But Casey <a
href="/Articles/621635/">is not confident</a> that this option makes sense;
just because a system does not use groups to restrict privilege now doesn't
mean that somebody won't install a package using that approach tomorrow.
Also, as he pointed out: "<q>The developers of user namespaces didn't
notice it might be a problem.  You can't count on sysadmins or distro
developers to do better.</q>"
<p>
So, in the end, unprivileged dropping of group membership may turn out to
be one of those ideas that just can't quite be shoehorned into the
decades-old Unix privilege model.  There is a lot of history there and no
end of systems that might see surprising results coming from a change like
this.  If this work does go forward, expect to hear some loud complaints
before it makes it into the mainline.
<p>
(Those interested in this work may also want to have a look at <a
href="/Articles/621580/">Josh's other patch</a>.  It allows a process to
have multiple user IDs in the same way that multiple group IDs are possible
now.  The idea is that the process could use those supplemental IDs to run
sandboxed processes each with their own user ID.)<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Namespaces-User_namespaces">Namespaces/User namespaces</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Negative_groups">Negative groups</a></td></tr>
            <tr><td><a href="/Security/Index/">Security</a></td><td><a href="/Security/Index/#Linux_kernel">Linux kernel</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/621612/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor622154"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 1:38 UTC (Thu)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/622154/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What about a flag on a group which says it is allowed to be dropped by an unprivileged process? By default, that flag would not be enabled for any group, but sysadmin could enable it on a group-by-group basis. That would likely be much safer than an across-the-board sysctl knob.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622154/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622188"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 5:21 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/622188/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I had the same thought, immediately. There must be something wrong with it if everybody on the kernel list didn't also post it simultaneously, but I am evidently too ignorant to guess what the flaw is. Would anyone care to enlighten us?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622188/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622204"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 6:50 UTC (Thu)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/622204/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Groups are just numbers -- they have no flags.  I did suggest a sysctl to specify groups that are safe to drop, but that's tedious and ugly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622204/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622210"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 7:45 UTC (Thu)
                               by <b>neilbrown</b> (subscriber, #359)
                              [<a href="/Articles/622210/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A sysctl which identified a range of groups that could be dropped wouldn't be too tedious.<br>
<p>
Then it would only be logical to also identify a range of groups that could freely be added - if the goal is to lose privileges, and adding groups achieves that, then maybe it should be allowed.<br>
<p>
Having observed that, it starts to feel very much like the wrong solution to the problem.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622210/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor622400"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 21:26 UTC (Thu)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/622400/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
How about modifying struct group_info to add a flags word for each supplementary group? One bit of the flags word would be used to indicate if the supplementary group is droppable by unprivileged callers, the others would be reserved for future use. Add new setgroups2() system call which allows privileged processes to set the flags words when the groups are set, and allow getgroups2() to allow unprivileged callers to retrieve both the groups and the associated flags.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622400/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622406"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 21:37 UTC (Thu)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/622406/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem with that is that existing userspace won't understand it at all.  Without something clever, one side effect is likely to be that it will completely disable unprivileged user namespaces on most systems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622406/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622444"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 21, 2014 0:48 UTC (Fri)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/622444/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would expect that setgroups() / getgroups() would still work, setgroups() would just zero the flags words. (Alternatively, if we call setgroups() with an already present group, it could leave the flags word for that group unchanged.) So yes, for this to be usable, privileged userspace code which calls setgroups() would need to be modified to call setgroups2(). Without that change, existing userspace code should still work, it just wouldn't be able to access the droppable groups feature. In order to use the droppable groups feature, you'd need to update user space code which calls setgroups() to call setgroups2() instead with the desired flags word (reading it from NSS groups database I presume). [Of course, setgroups2() should fail if an attempt is made to set a reserved bit to a non-zero value.]<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622444/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor622199"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 6:31 UTC (Thu)
                               by <b>Comet</b> (subscriber, #11646)
                              [<a href="/Articles/622199/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As another example of negative groups: a shared webhosting product at an ISP I used to work at was implemented in part using a uid per customer (namespaced per "instance" of the hosting platform, to scale across the customer base) with all users in one "customer" group.  Then the default umask was 072, so that ls -l would show, for a typical file, "-rw----r--  custid42 customer".<br>
<p>
Thus customer Foo can not see the files of customer Bar, but the webserver process, not in the "customer" group, can access all files.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622199/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622249"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 11:13 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/622249/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would definitely use an ACL for this instead.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622249/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622254"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 11:37 UTC (Thu)
                               by <b>knan</b> (subscriber, #3940)
                              [<a href="/Articles/622254/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, but a negative-access group is the traditional unix way. I've seen it too in hosting cases. Dropping this will certainly lead to compromises.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622254/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622429"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 23:37 UTC (Thu)
                               by <b>gerdesj</b> (subscriber, #5446)
                              [<a href="/Articles/622429/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It wouldn't even occur to me to attempt this.  ACLs are surely the way to go for filesystems.  Your posited "Unix way" reminds me of the Inherited Right Filter in NetWare filesystems - a shortcut to madness.  <br>
<p>
I note that Novell ended up putting in an override in the filesystem so that having certain eDirectory rights to the object corresponding to the root of a volume (they are pinned as objects in the directory) would override an IRF thus always ensuring someone could get to files to fix fuck ups.  Bit like root really ...<br>
<p>
I have always been able to design filesystem layouts for user data that only needed additive rights.  It only needs some thought and let's face it, real ACLs have been around for a while.  The old days of just rwxrwxrwx are long gone.<br>
<p>
Cheers<br>
Jon<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622429/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor622435"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 23:54 UTC (Thu)
                               by <b>Comet</b> (subscriber, #11646)
                              [<a href="/Articles/622435/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Predates any standardized ACL semantics, predates Linux support for ACLs, and was implemented on top of NFS.<br>
<p>
The permissions-stripping group membership is very reliable in every Unix to date.<br>
<p>
That doesn't mean it's not a little icky, or that we can't move forward with better ways today, but unless the better way also reliably supports both NFS (various protocol versions) and other operating systems (not everything is pure Linux) then demanding that everyone switch to doing things in a way which doesn't expose the Linux change as a security flaw is only going to create acrimony for the high-handedness.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622435/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor622318"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 15:23 UTC (Thu)
                               by <b>ebiederm</b> (subscriber, #35028)
                              [<a href="/Articles/622318/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thank you for that example.  That is the clearest example I have seen about<br>
negative group permissions.  I especially like the fact that supplementary groups are not needed for it to work.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622318/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor641855"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Apr 25, 2015 16:37 UTC (Sat)
                               by <b>mcortese</b> (guest, #52099)
                              [<a href="/Articles/641855/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>It looks to me a pretty poor security scheme. It implies <em>every</em> user is more trustworthy than those in the customer group, even nobody, irc, anonymous FTP, etc. It is as bad as setting up iptables to default to ACCEPT and then specifying all the conditions to DROP.</p>

<p>I think that, in most cases where a negative-access group seems advisable, equivalent solutions with positive-access group are also possible. In Ted's example, defining a "fair-gamer" group and giving it to all users is just a couple commands longer than using "game-abuser".</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/641855/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor622237"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A somewhat related problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 10:21 UTC (Thu)
                               by <b>giggls</b> (subscriber, #48434)
                              [<a href="/Articles/622237/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is another Problem with traditional group handling in Linux I came across recently.<br>
<p>
It is the lack of a system call to change the primary gid of a process in a way the suid utility sg does.<br>
<p>
I consider it somewhat broken, that sg has to be suid at all.<br>
<p>
It is at least very inconvenient that it is impossible to do inside a binary without an ugly wrapper script or execing itself via sg.<br>
<p>
Sven<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622237/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor622250"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 11:17 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/622250/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd solve that with two group lists. You use one for granting access and the other for denying it. The latter must of course be a superset of the former, which is the only one the process itself can modify.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622250/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor622383"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 19:35 UTC (Thu)
                               by <b>micka</b> (subscriber, #38720)
                              [<a href="/Articles/622383/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; it may become impossible to drop group memberships from within a user namespace</font><br>
<p>
Given an hypothetical userspace system that uses the ability to drop groups from within a user namespace (say, to drop priviliges), wouldn't that mean breaking userspace?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622383/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor622386"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 19:56 UTC (Thu)
                               by <b>rgb</b> (subscriber, #57129)
                              [<a href="/Articles/622386/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
May be silly, but another approach could be to -instead of actually dropping a group- flag the group as dropped within the process and from then on consider the group only for negative permission checks.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622386/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor622405"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Further negative group examples pam_access, pam_limits</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 21:37 UTC (Thu)
                               by <b>cdmiller</b> (guest, #2813)
                              [<a href="/Articles/622405/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
access.conf:<br>
-:wheel:ALL EXCEPT LOCAL .win.tue.nl<br>
<p>
limits.conf:<br>
@faculty        soft    nproc           20<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622405/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor622411"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 22:05 UTC (Thu)
                               by <b>jspaleta</b> (subscriber, #50639)
                              [<a href="/Articles/622411/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So that namespacing wrinkle with groups...that impacts the security of unprivileged containers that some vendors are now advertising as a feature?<br>
<p>
-jef<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622411/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622423"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 23:37 UTC (Thu)
                               by <b>spender</b> (guest, #23067)
                              [<a href="/Articles/622423/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There have been at least a dozen vulnerabilities caused by the existence of unprivileged user namespaces by now, so if this is the first one to draw your attention, you're a bit late to the game ;)  It's so obviously bad that it's become a running joke on my Twitter.  <br>
<p>
Just a small sampling of the vulns:<br>
<a href="http://article.gmane.org/gmane.linux.network/283310">http://article.gmane.org/gmane.linux.network/283310</a><br>
<a href="http://thread.gmane.org/gmane.linux.file-systems/89076">http://thread.gmane.org/gmane.linux.file-systems/89076</a><br>
<a href="https://lkml.org/lkml/2013/3/14/579">https://lkml.org/lkml/2013/3/14/579</a><br>
<a href="http://git.kernel.org/cgit/linux/kernel/git/davem/net.git/commit/?id=d661684cf6820331feae71146c35da83d794467e">http://git.kernel.org/cgit/linux/kernel/git/davem/net.git...</a><br>
<a href="http://stealth.openwall.net/xSports/clown-newuser.c">http://stealth.openwall.net/xSports/clown-newuser.c</a><br>
<a href="http://comments.gmane.org/gmane.comp.security.oss.general/10787">http://comments.gmane.org/gmane.comp.security.oss.general...</a><br>
<p>
If upstream had any security sense, they wouldn't have removed the privilege checks for creating user namespaces despite the code clearly not being ready for such a change.  Grsecurity put the privilege checks back ever since they were removed and avoided this entire mess.  I don't see how the creation of nearly arbitrarily-deep user namespaces by unprivileged users is of such importance in the present time to be putting systems at risk for what Ubuntu and others promote as a security feature.<br>
<p>
-Brad<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622423/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor622433"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 20, 2014 23:54 UTC (Thu)
                               by <b>jspaleta</b> (subscriber, #50639)
                              [<a href="/Articles/622433/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'm aware of other problems yes. <br>
I just wanted to be clear on this to the list.<br>
<p>
But yes I'm not up to speed on state of the art on containers as much as I would like to be, can't seem to scope playing with it as relevant to my current paying gig... unless you can point me to containers that work with qnx. <br>
<p>
-jef<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622433/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor622886"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 24, 2014 15:29 UTC (Mon)
                               by <b>ortalo</b> (guest, #4654)
                              [<a href="/Articles/622886/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Whatever the debate, personnally I consider such setups (using groups to restrict rights) as counterintuitive, and thus most probably contrary to protection rather than beneficial.<br>
(Note these rwx things are most commonly called "access rights", which means "permissions" for most of the world, not forbidden actions. I'd like to have interdictions in our security systems, but only if they are called interdictions and cannot be easily mistaken from permissions.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/622886/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor623013"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 25, 2014 12:45 UTC (Tue)
                               by <b>Jandar</b> (subscriber, #85683)
                              [<a href="/Articles/623013/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn't matter if it's counterintuitive to some, it is an old standard practise from times well before ACL (and Linux) existed.  It's embarrassing I find it more natural than this newfangled ACL thing ;-).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/623013/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor624881"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2014 0:46 UTC (Sat)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/624881/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, if linux acls are anything like windows acls then I find them thoroughly confusing too. Especially adding user and group rights. And negative rights.<br>
<p>
The system I am used to is simple.<br>
<p>
If user acl then grant user rights else if group acl(s) then grant sum of group rights else grant default rights.<br>
<p>
Okay, I then can't restrict a group of users, but it makes it dead easy for me to control what rights someone has over my project - if I give a user an explicit set of rights then their (possibly unknown to me) group rights are irrelevant.<br>
<p>
The problem with adding user and group rights is it prevents an administrator delegating to a project manager the ability to manage his projects. Okay, the best way is proper group management but if the project manager doesn't know (and he may well not have access to) the list of groups his staff belong to, then my version gives him the ability to explicitly control access at the user level.<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/624881/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor624932"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2014 20:05 UTC (Sat)
                               by <b>bfields</b> (subscriber, #19510)
                              [<a href="/Articles/624932/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <blockquote> If user acl then grant user rights else if group acl(s) then grant sum of group rights else grant default rights.</blockquote>

<p>That's more or less what the "posix" acls supported by most linux filesystems do.  (See the "ACCESS CHECK ALGORITHM" section in the acl(5) man page for details.)   They don't have the explicit deny aces that windows acls do.
      
          <div class="CommentReplyButton">
            <form action="/Articles/624932/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor624934"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2014 20:57 UTC (Sat)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/624934/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not true. For POSIX ACLs only the most specific entry is evaluated:<br>
<p>
<font class="QuotedText">&gt; The ACL entries are looked at in the following order: owner, named users, (owning or named) groups, others. Only a single entry determines access. Step two checks if the matching entry contains sufficient permissions. </font><br>
(c) <a rel="nofollow" href="http://users.suse.com/~agruen/acl/linux-acls/online/main.html">http://users.suse.com/~agruen/acl/linux-acls/online/main....</a><br>
<p>
This can be used (and often is!) for effectively negative ACLs.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/624934/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor624937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with dropping groups</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Dec 6, 2014 22:44 UTC (Sat)
                               by <b>rleigh</b> (guest, #14622)
                              [<a href="/Articles/624937/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I suppose this is one area where NFS4 ACLs are a much better solution than "POSIX" ACLs, since you can have an explicit deny in the ACEs.  (I see your name on the nfs4_acl(5) manpage, so I assume you'll know the answer!)<br>
<p>
At least when using ZFS/NFS4 with FreeBSD, it appears to have fully native support for NFS4 ACLs, while Linux doesn't appear to have support there at the moment (when testing using an NFS4 ZFS export).  Are there any plans for support for NFS4 ACLs with Linux on native and remote filesystems?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/624937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2014, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
