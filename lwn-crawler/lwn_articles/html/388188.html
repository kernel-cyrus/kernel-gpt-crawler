        <!DOCTYPE html>
        <html lang="en">
        <head><title>The trouble with the TSC [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/388188/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/387564/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/388188/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The trouble with the TSC</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jake Edge</b><br>May 19, 2010</br>
           </div>
<p>
The time stamp counter (TSC) provided by x86 processors is a
high-resolution counter that can be read with a single instruction
(RDTSC), which 
makes 
it a tempting target for applications that need fine-grained timestamps.
Unfortunately, it is also rather unreliable, so the kernel jumps
through hoops to decide whether to use it and to try to detect when it goes
awry.  An effort to export the kernel's knowledge about the reliability of
the TSC has met strong resistance for a number of reasons, but
the biggest is that the kernel developers don't think that applications
should be accessing the counter directly.  
</p>

<p>
Dan Magenheimer and Venkatesh Pallipadi <a
href="/Articles/388263/">proposed</a> adding a <tt>/sys/devices/tsc</tt>
directory with several entries corresponding to the kernel's internal TSC
information, including the <tt>tsc_unstable</tt> flag, which governs
whether the kernel uses the counter as a stable time source.  Andi Kleen <a
href="/Articles/388278/">questioned</a> the idea:
<div class="BigQuote">
Is this really a good idea?  It will encourage the applications
to use RDTSC directly, but there are all kinds of constraints on
that. Even the kernel has a hard time with them, how likely
is it that applications will get all that right?
</div>
</p>

<p>
That is exactly what the patch is meant to do, Magenheimer <a
href="/Articles/388280/">said</a>, because applications have no reliable
way to determine whether the standard system calls will be "fast" or
"slow":
<div class="BigQuote">
The problem is from an app point-of-view there is no vsyscall.
There are two syscalls: gettimeofday and clock_gettime.  Sometimes,
if it gets lucky, they turn out to be very fast and sometimes
it doesn't get lucky and they are VERY slow (resulting in a performance
hit of 10% or more), depending on a number of factors completely
out of the control of the app and even undetectable to the app.
<p>
Note also that even vsyscall with TSC as the clocksource will
still be significantly slower than rdtsc, especially in the
common case where a timestamp is directly stored and the
delta between two timestamps is later evaluated; in the
vsyscall case, each timestamp is a function call and a convert
to nsec but in the TSC case, each timestamp is a single
instruction.
</div>
</p>

<p>
Depending on the hardware, <tt>gettimeofday()</tt> and
<tt>clock_gettime()</tt> may be implemented as vsyscalls&mdash;virtual
system calls&mdash;rather than standard
system calls, which eliminates the user space to kernel transition. 
Vsyscalls are code that is stored in a special memory region in user space
(the vdso region)
that may access kernel-maintained data, like clock ticks.
Using vsyscalls, the calls are (relatively) fast, but on some hardware (or
virtual machines) that
requires kernel-space operations to get to a reliable counter, a vsyscall
cannot be 
used, so the calls are slower.  For applications that "<q>need to obtain timestamp data
tens or hundreds of thousands of times per second</q>", the difference
is significant.
</p>

<p>
But Magenheimer believes that 
if the kernel finds the TSC stable enough for its own timekeeping purposes, then that guarantees that it is usable by applications.  Arjan
van de Ven and Thomas Gleixner are quick to correct that misunderstanding.
Van de Ven <a href="/Articles/388284/">notes</a> that the stability of the
TSC can change under certain circumstances and there would be no way to
notify the applications.  His advice: "<q>friends don't let friends use
rdtsc in application code</q>". 
</p>

<p>
Gleixner <a href="/Articles/388286/">goes into some detail</a> about how
the TSC can get out of whack, including system management mode interrupts (SMIs)
fiddling with the TSC to hide their presence, that multiple cores can
have different values because of boot offsets and/or hotplugging, and that
multiple sockets can introduce differences due to separate clocks or drift
in the clock signals due to temperature.  There is, in short, nothing
reliable about the TSC: "<q>the stupid hardware is
not reliable whether it has some 'I claim to be reliable tag' on it or
not</q>".  Gleixner did offer a possible alternative, though:
<div class="BigQuote">
[...] but as long as we do not have some really
reliable hardware I'm going to NACK any exposure of the gory details
to user space simply because I have to deal with the fallout of this.
<p>
What we can talk about is a vget_tsc_raw() interface along with a
vconvert_tsc_delta() interface, where vget_tsc_raw() returns you an
nasty error code for everything which is not usable.
</div>
</p>

<p>
Currently, there are unnamed "enterprise applications" that attempt to
figure out whether they can use the TSC, and do so if they think it will
work because of the uncertainty in the performance of
<tt>gettimeofday()</tt> and friends.  Magenheimer <a
href="/Articles/388294/">suggests</a> that perhaps that information could
be made available:
<div class="BigQuote">
But the kernel doesn't expose a "gettimeofday
performance sucks" flag either.  If it did (or in the case of
the patch, if tsc_reliable is zero) the application could at least
choose to turn off the 10000-100000 timestamps/second and log
a message saying "you are running on old hardware so you get
fewer features".
</div>
</p>

<p>
Magenheimer also wonders if the kernel developers are suffering from "hot
stove" syndrome, in that they have been burned in the past and are reluctant to
even consider changes.  But Gleixner and van de Ven both point out that
there is no hardware that can make the guarantees that Magenheimer wants.
And Gleixner has the <a href="/Articles/388295/">burn marks</a> to prove it:
<div class="BigQuote">
I'm unfortunately forced to deal with the 500+
different variants of borked timers and that makes me very reluctant
to believe anything what chip/board/bios vendors promise. It's not the
one time hot stove experience, it's the constant exposure to the never
ending supply of hot stoves, which makes me nervous.
</div>
</p>

<p>
While the discussion had various interesting analogies including hanging
ropes/knives and condoms versus abstention, it did not (yet) find a car
analogy.  It did, however, seem to find some common ground that information
about whether the clock calls are implemented as vsyscalls or system calls
should be exported.  That is unlikely to satisfy those that have been "<q>using vsyscalls for a while and still have a
performance headache</q>", who Magenheimer <a
href="/Articles/388299/">quotes</a>, but there is nothing stopping
applications from reading the TSC directly.  Those applications just have
to be prepared to handle any strange TSC behavior they encounter.
</p>

<p>
Ingo Molnar <a href="/Articles/388301/">tries to clarify</a> the reasons
that the kernel can't export the reliability information: "<q>The point is for the kernel to not be complicit in 
practices that are technically not reliable.
[...]
So the kernel wont 'signal' that something is safe to 
use if it is not safe to use.</q>"
But he also sees <a href="/Articles/388300/">some reason to hope</a>:
<div class="BigQuote">
You could win the argument by coming up with a patch 
that changes gettimeofday to make use of the TSC in a 
reliable manner.
<p>
I really mean it - and it might be possible - but we 
have not found it yet.
</div>
</p>

<p>
Peter Zijlstra has <a href="/Articles/388303/">another solution</a> to the problem.  He would like to see
the kernel move to eventually disable RDTSC from user space.  By
emulating the instruction and logging all uses of it (and the related
RDTSCP), user-space programs that use it could be identified and changed:
<div class="BigQuote">
Once we get most of userspace running fine, we can switch it to
generating faults.
<p>
Of course closed source stuff will have to deal with it themselves, but
who cares about that anyway ;-)
</div>
</p>

<p>
Exporting the information about whether <tt>gettimeofday()</tt> is "slow"
or not seems like a reasonable starting
point.  No patches to do that have emerged yet, but it is a fairly
straightforward thing to do.  Eventually, something like Gleixner's
<tt>vget_tsc_raw()</tt> may also come about, though it won't satisfy those
who are unhappy with the current vsyscall performance.  Those applications
will just have to read the TSC themselves and deal with whatever the
hardware throws at them.
</p><br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Timers">Timers</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/388188/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor388531"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">TSC useful for embedded</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2010 13:49 UTC (Thu)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/388531/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I write code for embedded x86 systems.  I use RDTSC in my code on embedded systems where testing has shown it to be reliable.  I don't use it with AMD processors or boards with multiple CPU sockets, etc.  Most applications have to run on a large variety of hardware, but my embedded code runs only on hardware that I personally test and verify to work.  Maybe you can't use RDTSC in a reliable way in general applications on general hardware, but in more restricted circumstances it can be useful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388531/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor388569"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2010 17:36 UTC (Thu)
                               by <b>sustrik</b> (guest, #62161)
                              [<a href="/Articles/388569/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am using RDTSC as well. I don't need it to be reliable, but I need it to be fast. Disabling it in userspace would suck badly.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388569/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388734"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 17:04 UTC (Fri)
                               by <b>blitzkrieg3</b> (guest, #57873)
                              [<a href="/Articles/388734/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So you're cool with time going backwards?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388734/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388736"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 17:13 UTC (Fri)
                               by <b>sustrik</b> (guest, #62161)
                              [<a href="/Articles/388736/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sure. No problem with that. It's only used as a heuristic to find out whether at least some time have elapsed since the previous time measurement. I don't need correct answer each time. Correct answer in say 90% of cases will do.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388736/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor388760"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 21:11 UTC (Fri)
                               by <b>foom</b> (subscriber, #14868)
                              [<a href="/Articles/388760/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, if you use gettimeofday(), you'd better be cool with time going backwards too, cause it happens rather often.<br>
<p>
(hardware/kernel version with malfunctioning timekeeping, also running NTP; NTP will step the time once in a while because it can't keep up with the clock drift. You might say that's uncommon, but not so uncommon that you won't run into it!)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388760/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor388604"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 20, 2010 19:35 UTC (Thu)
                               by <b>dmadsen</b> (guest, #14859)
                              [<a href="/Articles/388604/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I know!  Let's make a GUI with a paperclip that says "I'm sorry Dave, I'm afraid I can't do that".<br>
<p>
What happened to the philosophy of letting the {user,programmer} decide if he wants to shoot his foot?  If someone is accessing the TSC, then he also should know the pitfalls.  <br>
<p>
Isn't there a better use of kernel developer time than creating needless restrictions?  <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388604/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388649"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 1:32 UTC (Fri)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/388649/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
the kernel developers are afraid that if they provide this and programs rely on it, there will be a bunch of complaints to the kernel people when it doesn't work well.<br>
<p>
given how badly it works, they expect this to be the common case rather than the exception, so they don't want to enable something that doesn't work and will cause them problems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388649/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor388677"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;philosophy&quot; was dead for a long, long time aready... deal with it</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 8:30 UTC (Fri)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/388677/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <p>The ability to shoot his foot is all good and well if you only have knowledgeable, responsive people at the keyboard. Or massive per-review system. When IT was young all IT people were like this (hey, if you need a week just to run the program once you'll be careful... and ask a lot of other people to verify that you've not written crap).</p>

<p>But over time as more and more people got access to the computer this approach started to fail: more and more clueless people appeared. First as users, then as developers too. And as access to the CPU become less and less expensive (hey, the CPU you have in your pocket is more powerful then what you had for million dollars fifty years ago) even clueful people started doing mistakes (there are not enough time to carefully reread every written line hundred times anymore). So today this approach is limited to the kernel - and may be even this group is too big.</p>

<p>This is natural evolution. Compare with cars. Early models were primitive but allowed you to tinker freely - and it was easy to damage them by abuse. Today if you'll sell car which blows up if you press the gas pedal too much... well, you'll fired - best case. Worst case - you'll go to jail.</p>

<p>Unix (and linux) always had the ability to restrict the user (file permissions and quotas). Today it can restrict the program too (seccomp, SELinux, AppArmor, etc). The next step if, if course, developers.</p>

<p>And just like with cars: if you need highly specialized system which will not use the same roads as regular cars (off-road car or rocket car) - you can ignore the warnings and remove the "superfluous" checks - but this is not an options for 99% developers out there.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/388677/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388780"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;philosophy&quot; was dead for a long, long time aready... deal with it</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2010 6:38 UTC (Sat)
                               by <b>dmadsen</b> (guest, #14859)
                              [<a href="/Articles/388780/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem I have is not necessarily with this particular instance; it's with the philosophy of restricting someone else's freedom "for their own good".  <br>
<p>
I should not have to pay because "more and more clueless people appeared".  Shall we all then live to the lowest common denominator?  My God, soon we'd all be using Windows Starter Edition! :-)<br>
<p>
One way I got to be a "knowledgable, responsive [responsible?] user" was to hurt myself doing "stupid" things.  Ctrl-Alt-Backspace *should* hurt -- once.  <br>
<p>
And you know, code review isn't so bad:  when I coded at the keypunch, it required more debugging than when I used the coding pad.  Writing code that I (and hopefully others) reviewed not only made better code then, but taught me (and others) to write better in the future.  (I would recommend reading "The Psychology of Computer Programming" by Gerald M Weinberg for more information).  And if I talked to someone who'd done rm -rf incorrectly, maybe I could avoid their pain.<br>
<p>
If it is true that natural evolution is to produce buggy code quicker, than perhaps we should resist.  Maybe sometimes celerity isn't a virtue, and the modern motion of the inevitability of bugs in code isn't true.  <br>
<p>
The assumption that kernel code is somehow special and should be specially treated is wrong -- *someone* is going to depend on code you write no matter how big or small the project, and an error in that code is gonna cause *someone* some trouble.  If you don't believe that, than you should not be writing code for others to use.<br>
<p>
File permissions, quotas, etc are there to mainly stop a system user from hurting other system users.  That's one of the normal policies of an OS.  On the other hand, training wheels are fine for novices, but they are meant to come off.  <br>
<p>
Again, I'm not talking about removing for everyone the equivalent of safety gear in a program.  What I'm talking about is deliberately engineering something so that any safety gear is [almost] impossible to remove.  In normal use, I should be able to use something safely, but, in my freedom, I must be able to remove or modify it *even if you don't think I should*.  <br>
<p>
Keeping up with the car analogy, would you buy a car deliberately built so it cannot go faster than 65 MPH and attempts to circumvent that would be illegal?<br>
<p>
I do understand -- and appreciate -- the point that they aren't only trying to protect others, but that the kernel devs don't want to hear clueless whining.  <br>
<p>
My point -- and really my main point -- is that when you operate to remove another's freedom, it had better be at more than just a whim, and more than your convenience.  In this case, that fact that you have a couple people saying "don't do it!" to me means that it shouldn't be done.  <br>
<p>
It's not as if there aren't a lot of other kernel decisions that people can't whine about, you know.  This is just yet another reason for those on LKML to say "RTFM. Go Away.". :-)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388780/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388795"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Look around you before answering... please...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 22, 2010 10:26 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/388795/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <blockquote>I should not have to pay because "more and more clueless people appeared".</blockquote>

<p>You are not paying "more". If anything you pay less - old systems can be bought for cheap (unless they are very old and reach the antique category). You want new stuff for cheap? Sorry, it's not for you - it's cheap because of the economy of scale and this economy is only possible because it's not for you.</p>

<blockquote>One way I got to be a "knowledgable, responsive [responsible?] user" was to hurt myself doing "stupid" things.</blockquote>

<p>You think that being a "knowledgable, responsible user" is worthwhile goal and worth spending time. Most users don't think so - and since systems are created for them the rules are adjusted for them.</p>

<blockquote>Maybe sometimes celerity isn't a virtue, and the modern motion of the inevitability of bugs in code isn't true.</blockquote>

<p>Bug-free software is <a href="http://en.wikipedia.org/wiki/Soft_error">absolutely impossible</a>. Deal with it. You can create tiny kernel which is mostly bug-free (and no, linux is way too big for that), but the rest of system will be bug-infested no matter what the programmers will be doing.</p>

<blockquote>The assumption that kernel code is somehow special and should be specially treated is wrong -- *someone* is going to depend on code you write no matter how big or small the project, and an error in that code is gonna cause *someone* some trouble.</blockquote>

<p>Brilliant observation! That's why I have zero sympathy for <a href="http://freetype.sourceforge.net/freetype2/freetype-2.2.0.html">freetype developers</a>. They brought the problems on themselves by exposing private interfaces - so not they should deal with the fallout. They should have done what all sensible people are doing: attached the visibility ("hidden") to all internal functions.</p>

<blockquote>File permissions, quotas, etc are there to mainly stop a system user from hurting other system users. That's one of the normal policies of an OS. On the other hand, training wheels are fine for novices, but they are meant to come off.</blockquote>

<p>Helmet, on the other hand, is meant to be used by everyone. Yes, some things should only be enabled in debug libraries (like _GLIBCXX_DEBUG) and some should be enabled all the time.</p>

<blockquote>What I'm talking about is deliberately engineering something so that any safety gear is [almost] impossible to remove.</blockquote>

<p>This is the right way to design things. Safety gear must be built robustly - or else it'll not work. It can always be removed by direct modification of program source (or even binary if the need is really strong). The ability to turn it off <b>easily</b> is actively harmful.</p>

<blockquote>Keeping up with the car analogy, would you buy a car deliberately built so it cannot go faster than 65 MPH and attempts to circumvent that would be illegal?</blockquote>

<p>Brilliant example. Of course not! 65 MPH is not enough - there are roads where you can travel faster! Real car's speed limit is set to <a href="http://en.wikipedia.org/wiki/Speed_limiter">155mph or 112mph</a> (depending on country). On the other hand, if you meat to say that artificial limits in cars is something unimaginable you've utterly failed: not only it's imaginable - it's widespread in real world!</p>

<blockquote>My point -- and really my main point -- is that when you operate to remove another's freedom, it had better be at more than just a whim, and more than your convenience.</blockquote>

<p>See the freetype example above. API usage freedom is not right, you must earn it - by showing use cases where it's needed and where nothing else really fits. See the recent dicussion <a href="http://lwn.net/Articles/388131/">related to such right</a>: it looks like Google will get the wakelocks in the end, but it was not an easy sell. And this is good thing. Often it's much easier to just muck with system internals rather then use proper interfaces - but this leads to the Windows-like mess, where you can't change anything without breaking something.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/388795/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388828"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Look around you before answering... please...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 5:40 UTC (Sun)
                               by <b>dmadsen</b> (guest, #14859)
                              [<a href="/Articles/388828/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It is clear to me that we have rather different world views in the areas we have discussed.<br>
<p>
This has brought home to me in a personal way the difficulties that a successful project manager must have when working with a diverse population, especially regarding cohesiveness and consistency of vision.  Gentlemen, my hat's off to you!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388828/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor388841"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Look around you before answering... please...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 13:49 UTC (Sun)
                               by <b>nix</b> (subscriber, #2304)
                              [<a href="/Articles/388841/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There was no portable way to enable hidden visibility when FreeType 2.0 was released. GCC's visibility attribute is much newer. (But, yes, they should have hidden their internal interfaces *somehow*.)<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388841/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor388854"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">I can understand SNAFU with freetype 2.1, but why persist in folly ?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 23, 2010 17:54 UTC (Sun)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/388854/">Link</a>] 
      </p>
      
      </div>
      </summary>
      You are right, of course. Freetype 2.1 was released in 2002 and gcc only got visibility attribute in 2003. And other methods are not as nice. But we are in 2010 - and yet Freetype 2.3.12 (released just a few months ago) does not use visibility(hidden). Not even as option! 
      
          <div class="CommentReplyButton">
            <form action="/Articles/388854/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor389941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;philosophy&quot; was dead for a long, long time aready... deal with it</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 30, 2010 4:32 UTC (Sun)
                               by <b>fredi@lwn</b> (subscriber, #65912)
                              [<a href="/Articles/389941/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I agree on most of what you said. Except for one thing; you're talking about freedom, freedom to use your hardware as you please. And kernel people taking out that freedom. Here is where i dont agree, look, you have the sources, is not that the fact that there's no interface kernelside to use eg. RDTSC limits you, you have the source, so ... in case you need it, just add another syscall and use it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/389941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor390205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The &quot;philosophy&quot; was dead for a long, long time aready... deal with it</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Jun 1, 2010 5:30 UTC (Tue)
                               by <b>dmadsen</b> (guest, #14859)
                              [<a href="/Articles/390205/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I understand your point: if I don't like the code, I'm free to modify it as I please.  And that is such a good thing, because it means that no matter what anyone does, if I feel strongly enough about it to spend money/time/effort, I can change it.<br>
<p>
But I'm also talking about something a bit more subtle, which says "[don't restrict me] ** only because you think it's for my own good **".  In this case, the reasoning is "let's disable it because it's not reliable and someone using it might have negative results".  As a philosophy, this says "protect people from harming themselves".<br>
<p>
My point is that to go down this path *in a general way* is a slippery slope; where do we stop in making a "safe" system, one where a {user,developer} can't hurt himself?  Shall we, for example, as a policy decision, eliminate the ability to remove files from users and make it for root only?  <br>
<p>
I am aware, of course, that different functionality is directed towards users of different experience levels, and how that might affect any let's-protect-the-user-from-himself decisions.<br>
<p>
But much learning comes from making mistakes -- and the "baby-proofing" one does in a home with toddlers is only enough to so that the baby doesn't get permanently damaged before he learns. <br>
<p>
So I re-emphasize that we must be careful not to *blindly* apply the "let's remove that function for his own good" philosophy.  Each case must be thought about carefully.  And even then, should the decision to be made to protect the user from himself, it should be easy for that user to say "I've learned I can hurt myself, and I don't want to be coddled/restricted anymore because I've also learned how to use that sharp knife you were shielding me from".  That's where freedom comes in.<br>
<p>
And I re-state that the particular function in this article is surely not likely to be used by someone who doesn't already have the level of knowledge to understand the potential pitfalls.  That is, he should not need to be protected, as he knows the stove is hot already.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/390205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor388690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 10:20 UTC (Fri)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/388690/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>There's a well-supported interface that (in theory) could be almost as fast as <tt>RDTSC</tt> for the case where the TSC is reliable - it's called <tt><a href="http://www.opengroup.org/onlinepubs/000095399/functions/gettimeofday.html">gettimeofday()</a></tt>. It has the advantage that it can be reliable even when the TSC is not, and can exploit future timers that are even better than the TSC. And, with vsyscall support, it's all userspace, so you don't pay the price of a context switch, just of converting the TSC to seconds.
<p>Given this, why not disable userspace support for <tt>RDTSC</tt> when it's not needed as part of a fast implementation of <tt>gettimeofday()</tt>? Applications on a custom platform can use a slightly modified kernel that always permits <tt>RDTSC</tt> (and the serializing variant <tt>RDTSCP</tt>), while applications that can't control the platform should rely on <tt>gettimeofday()</tt>. The missing bit is kernel support for telling you whether <tt>gettimeofday()</tt> is fast or slow - if it's slow, you can log this, and disable things that depend on <tt>gettimeofday()</tt> being fast.
      
          <div class="CommentReplyButton">
            <form action="/Articles/388690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor388693"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The trouble with the TSC</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 21, 2010 10:39 UTC (Fri)
                               by <b>tialaramex</b> (subscriber, #21167)
                              [<a href="/Articles/388693/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The kernel also "goes out of its way" to stop you from trying to generically hook system calls. No doubt there are thousands of developers out there who think they have a brilliant use case for hooking a system call, and no doubt one of them really does - he should talk to the LKML about his idea. The rest though, were going to do something horrid and thoughtless and then everyone else was going to have to live with the resulting mess. So, you don't get to do that in a vanilla kernel.<br>
<p>
There's a balance to be struck and I think that the difference between what people think the TSC will do (cheap, fast, reliable way to measure time) and what they get (rarely all, and often none of the above) makes the status quo acceptable. I wouldn't support actively blocking use of TSC, but it certainly makes no sense for the kernel folk to endorse it as this patch proposed.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/388693/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2010, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
