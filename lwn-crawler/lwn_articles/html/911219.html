        <!DOCTYPE html>
        <html lang="en">
        <head><title>The search for the correct amount of split-lock misery [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/911219/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/911047/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/911219/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The search for the correct amount of split-lock misery</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>October 19, 2022</br>
           </div>
Unlike many other architectures, x86 systems support atomic operations that
affect more than one cache line.  This support comes at a cost, though, in
terms of overall system performance and, even, security.  Over the last few
years, kernel developers have worked to discourage the use of this sort of
"split-lock" operation.  Now, though, one group of users is feeling
a little too discouraged, leading to a discussion of how much misery can
appropriately be inflicted upon users who use problematic but
architecturally legal operations.
<p>
The problem with atomic operations that cross cache-line boundaries is that
the system bus must take special measures to ensure that both cache lines are
simultaneously protected from concurrent access.  In practice, that means
locking the bus 
for the duration of the operation, which can stall every other processor in
the system.  A malicious program executing a tight loop with a split-lock
operation can destroy the performance of the system as a whole.  For this
reason, split-lock operations have long been frowned upon.
<p>
Unfortunately, software that is malicious (or just poorly written) turns
out to be remarkably indifferent to even the most severe of frowns.  So, <a
href="/Articles/790464/">starting
in 2019</a>, kernel developers sought more persuasive ways to
get their point across.  The initial work was done by Fenghua Yu but, in
the end, <a
href="https://git.kernel.org/linus/6650cdd9a8cc">this patch</a> by Peter
Zijlstra was  merged in
January 2020 for the 5.7 kernel release.  It gives the kernel the ability
to respond to traps caused by split-lock operations and provides
three modes for that response, selectable by
the <tt>split_lock_detect=</tt> command-line parameter:
<p>
<ul class="spacylist">
<li> <tt>off</tt> causes the kernel to behave as it did before; split-lock
     operations are not detected and nothing is done when they occur.
<li> <tt>warn</tt> (the default) causes a (rate-limited) warning to go to
     the system log when a split-lock operation is detected.
<li> <tt>fatal</tt> causes the kernel to immediately kill (with
     <tt>SIGBUS</tt>) any process attempting split-lock operations.
</ul>
<p>
The hope was that the <tt>warn</tt> mode would be sufficient to alert users
to the problem, 
and lead to software being fixed, while not actually interfering with
anybody's use of their systems.  By the time the 5.19 development cycle
came around earlier this year, though, it seemed that little progress
toward the removal of split lock operations had
been made, and the denial-of-service problem was as present as before.  So
it was decided to take a stronger stance against split
locks.
<p>
One option, of course, would be to just switch to the <tt>fatal</tt> mode
by default, but that would be a rather draconian solution.  Instead, Tony
Luck <a href="https://git.kernel.org/linus/b041b525dab9">wrote a patch</a>
with the descriptive title of "make life miserable for split lockers".  It
modified the <tt>warn</tt> mode to punish processes doing split locks without
actually killing them.  Instead, detection of a split lock would lead to a
10ms delay, then serialization via a semaphore.  When this mode is
selected, a malicious program performing split locks succeeds in slowing
itself down, but no longer has much effect on the system as a whole.
This change was applied during the 5.19 merge window.
<p>
In mid-September, a GitHub user named "pibberflibbits" <a
href="https://github.com/doitsujin/dxvk/issues/2938">posted a bug
report</a> saying that the performance of the <a
href="https://en.wikipedia.org/wiki/God_of_War_(franchise)">God of War
game</a> on Linux had become "<q>insanely low</q>".  It took a little
while, but the 
participants in the resulting discussion eventually figured out that the
problem was the split-lock penalty.  Evidently one cannot be a proper god
of war using just ordinary locks, so the game does a lot of split locking.
Luck's patch had achieved its intended purpose; God of War players are now
suitably miserable.
<p>
Guilherme G. Piccoli, though, was not celebrating this victory over the
Gods; instead, he posted <a
href="/ml/linux-kernel/20220928142109.150263-1-gpiccoli@igalia.com/">a
patch</a> arguing that "<q>it seems unacceptable to regress old/proprietary
userspace programs through a default configuration that previously
worked</q>".  This patch restored the old behavior of the <tt>warn</tt>
mode and added a new <tt>seq</tt> mode that would slow down split-lock
users like <tt>warn</tt> mode does now.  The <tt>warn</tt> mode would
remain the default, lifting the misery from the game-playing world.
<p>
Opinions on this change were mixed.  Luck <a
href="/ml/linux-kernel/SJ1PR11MB6083113884DD0B3031FE372CFC549@SJ1PR11MB6083.namprd11.prod.outlook.com/">pointed
out</a> that gamers can simply disable split-lock detection by rebooting
with <tt>split_lock_detect=off</tt> on the kernel command line.  If the
<tt>seq</tt> mode were to be added, he said, it should be the default.  He
also suggested filing a bug with the publishers of God of War to get its
misbehavior fixed.
<p>
Others disagreed, though.  Joshua Ashton <a
href="/ml/linux-kernel/f568c82c-738b-c5ec-5059-36659b3f5b44@froggi.es/">argued</a>
that the problem is more widespread: "<q>It's not just about God of War
specifically.  There are many old 
titles that will never, ever, get updated to fix this problem.
These titles worked perfectly fine and were performant before.</q>"
Others pointed out that many gamers are unlikely to be comfortable with
adjusting kernel command-line parameters.
Dave Hansen <a
href="/ml/linux-kernel/24f31510-5b33-ada5-9f0e-117420403e8c@intel.com/">observed</a>
that the misery-inflicting mode had worked as intended and had brought the
problem to light.  Even so, he continued:
<p>
<blockquote class="bq">
	My gut says we should keep the warnings and kill the misery.  The
	folks who are going to be able to fix the issues are probably also
	the ones looking at dmesg and don't need the extra hint from the
	misery.  The folks running Windows games don't look at dmesg and
	just want to play their game without misery.
</blockquote>
<p>
Luck, though, <a
href="/ml/linux-kernel/SJ1PR11MB60839A08E01742321F8446BCFC579@SJ1PR11MB6083.namprd11.prod.outlook.com/">argued</a>
that split locking creates its own misery for processes other than the one
responsible, and that the current mode "<q>serves a very useful purpose on
multi-user systems</q>".  He suggested that perhaps some sort of heuristic
could be developed to confine the misery to multi-user systems.
<p>
The <a href="/ml/linux-kernel/87pmf4bter.ffs@tglx/">definitive answer</a>,
though, came from Thomas Gleixner, who pointed out that slowing down split
lockers by default is the only choice that distributors could make;
anything else creates an easily exploitable denial-of-service
vulnerability.  So the slowdown 
needs to remain: "<q>Attack vector prevention has precedence over broken
applications</q>".  He did suggest, though, that a sysctl knob could be
added to control split-lock detection; that would allow users of broken
applications to get their performance back without the need to figure out
how to change command-line parameters or reboot their systems.
<p>
That is the approach that Piccoli has taken for <a
href="/ml/linux-kernel/20221014180506.211592-1-gpiccoli@igalia.com/">his
second attempt</a> at addressing the problem.  The new
<tt>kernel.split_lock_mitigate</tt> knob, if set to zero, will disable the
penalization of processes using split locking (while retaining the warning
sent to the system log).  The default is to retain the slowdown.  This
patch seems to have pleased everybody 
involved and looks likely to find its way into the 6.2 kernel.  Affected
gamers will have to set the new knob appropriately, but knowing which
sysctls to tweak could be said to be part of being a true God of War.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Architectures-x86">Architectures/x86</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/911219/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor911755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 16:27 UTC (Wed)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/911755/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I wonder if it would be viable to hook this into one of the process priority mechanisms that the kernel has. Surely, it's okay to potentially stall all of the other processors on the system if the process has sufficient priority to preempt any processes that are running on those processors, and gamers could use a new launcher that expresses the fact that they really don't mind if their software builds make little or no progress while they're playing God of War.<br>
<p>
It seems like it might be sufficient to just remove the explicit delay; you'd still be heavily penalizing processes that do split-lock operations, but only if there's anything else for them to contend with, so they'd be unaffected if they have a whole computer to themselves.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor911763"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 16:53 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/911763/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If it's just a game, perhaps lock safety is not that important?  Can the kernel trap on the split-lock operation and execute a less strongly atomic operation instead? As an option, not enabled by default, of course.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911763/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911764"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 17:08 UTC (Wed)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/911764/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would be really (!!1!11) upset, if a non-atomic increment of the score counter in my favorite Hello Kitty game spoiled my all time high score!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911764/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor911766"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 17:44 UTC (Wed)
                               by <b>mss</b> (subscriber, #138799)
                              [<a href="/Articles/911766/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      Games, as other programs, can crash if their atomic operation sematics get suddenly weakened.<br>
<br>
Just imagine how annoying random game crashes would be.


      
          <div class="CommentReplyButton">
            <form action="/Articles/911766/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 19:37 UTC (Wed)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/911778/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
To which the only answer is ‘suck it and see’. If the game still runs, doesn’t crash or behave strangely, then the looser behaviour is good enough.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911784"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 20:15 UTC (Wed)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/911784/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What you gained: Nothing at all. On a gaming system there is no concern of stalled or otherwise DoSed other applications, because there are none.<br>
<p>
What you payed: The game crashes or sporadically misbehaves or is slower than before.<br>
<p>
In a single application scenario, which a game effectively is, the only task of the kernel is to make that application run as smooth as possible.<br>
If there is a change to the kernel, which reduces game performance with no additional gain whatsoever, then it is a regression.<br>
Clearly, there is no stalling problem of other applications, because it would have been noticed by the game developer before. This is mitigating a problem, that doesn't exist in this scenario.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911784/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911796"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 19, 2022 22:14 UTC (Wed)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/911796/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; On a gaming system there is no concern of stalled or otherwise DoSed other applications, because there are none.</font><br>
<p>
Unless you're streaming to Twitch, or your multiplayer game has no built-in chat and you're using a third-party application to communicate with your fellow players, or you hate the in-game music and are running a media player to get a soundtrack you actually like, or ...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911796/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911806"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 3:10 UTC (Thu)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/911806/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And neither of these situations is improved or solved by stalling the game (the app that uses split locks).<br>
It always reduces the user experience. It doesn't improve anything.<br>
<p>
I would go as far to argue that throttling an application due to split locks on a single user system is always wrong.<br>
The only case where we gain something from throttling the app is on a multiuser system where one user is maliciously attacking the system as a whole. (This might be an unpriviledged remote user who might not even need a system account).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911806/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912108"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2022 6:20 UTC (Mon)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/912108/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It improves the future for maintained and future apps. For everything except orphaned apps.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912108/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912823"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2022 11:52 UTC (Fri)
                               by <b>Vipketsh</b> (guest, #134480)
                              [<a href="/Articles/912823/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If you are only ever looking to make the future good, the present will *always* suck.<br>
<p>
Is there any known exploit using this scenario to guard against ?  I mean, users shouldn't go off and install random "break my machine" programs or if they do DoS-ing an individual's machine isn't exactly beneficial, nor is it the worst that an evil application can do.<br>
<p>
I see this change and behaviour as more inline with the seemingly recent trend that the linux kernel is to do well out-of-the-box for cloud-based deployments, and only as a second concession allow individuals to tweak things so their single-user laptops and systems may work reasonably.  A little sad and quite backwards since cloud operators have lots of talent on hand to tweak and analyse their systems (and they do anyway) with which individuals can't hope to compete.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912823/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912956"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2022 22:18 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/912956/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; If you are only ever looking to make the future good, the present will *always* suck.</span><br>
<p>
Actually, by stalling abusive applications this improves the present of other applications too. Single app gaming really does not feel like a top Linux use case today. Unless you're counting ChromeOS, Android and Steam deck but then you're not administering your own system and you can count on its admins to optimize all this for you.<br>
<p>
<span class="QuotedText">&gt; Is there any known exploit using this scenario to guard against ? </span><br>
<p>
This is not just about intentional abuse but also about performance under unintentional abuse too.<br>
<p>
<span class="QuotedText">&gt; recent trend that the linux kernel is to do well out-of-the-box for cloud-based deployments, and only as a second concession allow individuals </span><br>
<p>
As already explained elsewhere this is not just about multi-user but about multi process in general.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912956/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912964"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2022 2:30 UTC (Sat)
                               by <b>Vipketsh</b> (guest, #134480)
                              [<a href="/Articles/912964/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; by stalling abusive applications this improves the present of other applications too</span><br>
<p>
In theory I understand, but do you or anyone else have any numbers to the magnitude of this slowdown on, say, a typical 4/8 core laptop ?  Theoretical problems should always be trumped by practical breakage, until proven otherwise.<br>
<p>
This is like arguing that some application causing heavy contention on a kernel lock is a DoS attack or, if not that, the application is slowing down the system and thus the kernel should prevent it from running.  Clearly this is madness.  How are split locks any different ?<br>
<p>
<span class="QuotedText">&gt; also about performance under unintentional abuse too.</span><br>
<p>
The malicious case is all that matters.  For everything else, one of two possible outcomes is possible: (i) the performance issue is fixed and so is not a problem or (ii) the performance issue is not fixed in which case the choices are "slow(er) system" and "program does not work".  A slower system is *always* preferred to a non working one and that is doubly true for machines of individuals.<br>
<p>
Also let's not forget that this case is only relevant to x86 -- the risc machines (arm &amp; riscv) not only don't support this feature but often don't support *any* unaligned access, atomic or otherwise.  With their rise in popularity there will practically not be any cases of this in opensource and with propriety apps the question is that it works or not and working is always preferred.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912964/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor912949"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2022 21:31 UTC (Fri)
                               by <b>mrugiero</b> (guest, #153040)
                              [<a href="/Articles/912949/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; I would go as far to argue that throttling an application due to split locks on a single user system is always wrong.</span><br>
<p>
You could, probably accurately, argue that this is always wrong if forced on the user. I.e., you could argue it should be opt-in for single user systems. But some of use would rather want to be able to report these kind of issues. Let alone being the developer of one such game and wanting a fair warning that you may be causing problems. Do you code in a multi-user system most of the time? I don't.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912949/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor914048"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2022 8:39 UTC (Tue)
                               by <b>roblucid</b> (guest, #48964)
                              [<a href="/Articles/914048/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, a performance bug that prevents effective multi-core operation has been detected and should be fixed.<br>
Gamers are concerned about core scaling, the application is sabotaging itself.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914048/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor914050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2022 13:10 UTC (Tue)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/914050/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The question is simple - if the majority of apps affected by this are games, then this is a user space regression. It needs to be reverted.<br>
<p>
Seeing as it appears to be pretty much only gaming systems that are affected, then it most definitely is a user space regression. Especially as a lot of these applications cannot be fixed by the users. And driving gamers to Windows/Apple will be seriously damaging to linux.<br>
<p>
And lastly, isn't the (mis)feature itself actually a HARDWARE bug? "Mitigating" the bug by rendering the computer pretty much unusable for its intended purpose isn't a good idea!<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/914050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor911904"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 15:41 UTC (Thu)
                               by <b>ericproberts</b> (guest, #139553)
                              [<a href="/Articles/911904/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It certainly would make things more miserable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911904/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor911802"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 2:25 UTC (Thu)
                               by <b>kschendel</b> (subscriber, #20465)
                              [<a href="/Articles/911802/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The sysctl knob seems a good idea, but IMO it's backwards -- the name is "split_lock_mitigate", so to mitigate, it should be set to 1.  To cause pain, mitigation is turned off, ie should be set to zero.<br>
<p>
Bikeshedding, I guess, but still.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911802/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911832"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 13:00 UTC (Thu)
                               by <b>tamara_schmitz</b> (guest, #141258)
                              [<a href="/Articles/911832/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think it's already as you described it:<br>
<p>
0 Disables the misery mode - just warns the split lock on kernel log.<br>
1 Enables the misery mode (this is the default) - penalizes the split lockers with intentional performance degradation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911832/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor911906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 15:53 UTC (Thu)
                               by <b>WolfWings</b> (subscriber, #56790)
                              [<a href="/Articles/911906/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In this case the mitigation is preventing impact to the rest of the system, which indeed is what "1" does. It directly penalizes anything that triggers split-cacheline-atomic scenarios by forcing it to eat a 10ms pause in it's next scheduling.<br>
<p>
"0" disables the mitigation, allowing any single application to hog the bus for it's own locks and arbitrarily DDoS the rest of the system as a result.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912076"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2022 1:11 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/912076/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's not a DDoS, it's just a regular DoS. There's only one system involved.<br>
<p>
More to the point, this whole idea is clownshoes anyway. The purpose of the kernel is to serve userspace, not to tell userspace what to do. If userspace wants to hurt its own performance, that's the sysadmin's* problem. For some configurations, it might make sense to allow the sysadmin to block or restrict split-lock operations, but it should function like an rlimit, not a system-wide "block first, ask questions later" flag.<br>
<p>
* If there is no sysadmin, that means it's a single-user system and the "problem" is even more nonsensical.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912076/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912090"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2022 17:27 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/912090/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; The purpose of the kernel is to serve userspace, not to tell userspace what to do. </span><br>
<p>
No, the purpose of the kernel is to protect userspace from each other (some single application systems don't even have a kernel)<br>
<p>
<span class="QuotedText">&gt; If userspace wants to hurt its own performance, that's the sysadmin's* problem.</span><br>
<p>
Default settings matter A LOT and it's really good to see overbusy maintainers spending so much time discussing and getting them right.<br>
<p>
<span class="QuotedText">&gt; &gt; Affected gamers will have to set the new knob appropriately, but knowing which sysctls to tweak could be said to be part of being a true God of War.</span><br>
<p>
Happy ending:<br>
- The "bug" will  not go unnoticed and new applications will avoid it<br>
- Old applications will run too after a few minutes searching the Internet.<br>
<p>
Very delicate trade-off perfectly found.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912090/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor911941"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 4:08 UTC (Fri)
                               by <b>ballombe</b> (subscriber, #9523)
                              [<a href="/Articles/911941/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, there should exist a mitigation that still allow God of War to run with decent performance.<br>
The current one was made painful by design, not by necessity. This is a false dilemma.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911941/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor911801"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 2:36 UTC (Thu)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/911801/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Attack vector prevention has precedence over broken applications.</font><br>
Taken in context, I find this statement absurd. <br>
<p>
There is no attack being mitigated. The users of split-lock dependent software on single-user machines run those workloads fully accepting (nay, _expecting_*) the performance characteristics. It is tautologically impossible for this mechanism to provide them with any protection whatsoever from themselves.<br>
<p>
The default is very plainly in the wrong place. The default should indeed prevent harm: by not disrupting existing workloads.<br>
<p>
The place where the penalty is useful is in a multiuser system system. These multiuser systems are *exactly* the place to find a capable sysadmin who can fiddle a knob to ward off bad behavior, even as it arises. User complaints roll in, as do dmesg messages, and the problem is swiftly rectified.<br>
<p>
I think this is simply a case where annoyance that "software is still not being fixed" is fueling an impulse to steam-roll past the reports of harm that the new default is causing. The unjustified expectation is that inflicting additional pain on the reporters will somehow convince an unrelated population to change their behavior.<br>
<p>
* "Why shouldn't my game/database/whatever consume all available resources for maximum performance?"<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911801/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911803"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 2:39 UTC (Thu)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/911803/">Link</a>] (18 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As a footnote:<br>
<p>
These users running various software may not be in a position to adjust the setting in question. There is a very good reason for the hard requirement that WINE and similar *MUST* work without elevated privileges available. This has come up before during the work on system call emulation.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911803/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911815"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 7:17 UTC (Thu)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/911815/">Link</a>] (17 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The number of people gaming on a system where they have limited privileges must be extremely small though.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911815/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911826"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 10:19 UTC (Thu)
                               by <b>hkario</b> (subscriber, #94864)
                              [<a href="/Articles/911826/">Link</a>] (16 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
no, it isn't, wine _really_ doesn't like being run as root; everybody is running their wine environments or the whole Steam client from regular user accounts, no sudo prompts in sight<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911826/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911827"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 10:32 UTC (Thu)
                               by <b>syrjala</b> (subscriber, #47399)
                              [<a href="/Articles/911827/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe the point was that most people that need this have the ability to just edit /etc/sysctl.conf or whatever.<br>
<p>
And I think most of the remaining cases are probably solved by: "Mom/Dad, can you toggle this sysctl knob for me?". Assuming the kid hasn't found some local root exploit already ;)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911827/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911923"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 20:32 UTC (Thu)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/911923/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
These same arguments came up in system call emulation and it didn't fly there either.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911923/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor911959"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 12:11 UTC (Fri)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/911959/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Presumably you would do something similar to how windows programs are installed on steam, upon first launch it (sometimes) requests elevation and installs "things", in this case one such thing could be a suid program that turns off misery mode and then launches the game, restoring misery mode when the game has exited.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911959/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911961"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 12:19 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/911961/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mmm, yes, the fun problem of figuring out "what did this program do to my machine?" when trying to uninstall it. Not sure I'd like to import that particular behavior from Windows.<br>
<p>
Incidentally, more programs supporting `/etc/prog.d/*.conf`-style configuration would be greatly appreciated :) .<br>
<p>
<font class="QuotedText">&gt; restoring misery mode when the game has exited.</font><br>
<p>
ABAB problems sound fun with this. Also sounds like a maze full of fun error code paths that will never be reliably tested.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911961/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911963"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 12:29 UTC (Fri)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/911963/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah. Though actually another option might be to just have wine know how to bump around the allocations in question to avoid the split-locks in the first place. It would have to be a game-specific hack probably.<br>
<p>
I wonder if windows has compat shims for this kinda stuff.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911963/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912009"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 15:00 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/912009/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, it's done those kinds of things: <a href="https://arstechnica.com/gadgets/2022/10/windows-95-went-the-extra-mile-to-ensure-compatibility-of-simcity-other-games/">https://arstechnica.com/gadgets/2022/10/windows-95-went-t...</a><br>
<p>
TheOldNewThing blog by Raymond Chen also has lots of tales to this effect: <a href="https://devblogs.microsoft.com/oldnewthing/">https://devblogs.microsoft.com/oldnewthing/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912009/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912034"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 23:40 UTC (Fri)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/912034/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
yeah ofc, but I mean _this specific problem_<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912034/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912073"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2022 23:26 UTC (Sat)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/912073/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not possible, see comment below. This approach was also suggested during the kernel syscall emulation saga and also shot down then too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912073/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor912072"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2022 23:25 UTC (Sat)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/912072/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is not possible.<br>
<p>
This same suggestion *also* came up during the kernel syscall emulation work. It was suggested that instead of having the kernel reroute attempts by a program to call a windows kernel syscall, wine could simply scan for and patch any such attempts.<br>
<p>
This is not only hideously complicated and unreliable, it also doesn't work at all with exactly the class of programs we're interested with: Games.<br>
<p>
They frequently include a wide variety of very gnarly anti-tampering features which cannot be automatically overcome. It is for this reason wine seeks to emulate the environment around the program, and never ever attempts to reach inside it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912072/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor912071"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 22, 2022 23:21 UTC (Sat)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/912071/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This is unfortunately completely unacceptable.<br>
<p>
The entire steam linux runtime, and indeed every wine runtime MUST NOT require any more privileges than a regular user program. For installation or during runtime.<br>
<p>
One philosophical reason: If it's emulating the windows ABI to run a program that doesn't requires privileges, then it must not as for any additional privileges of it's own.<br>
<p>
Privileges during installation have never been required and are not allowed. Privileges that are repeatedly granted through permanently-lodged a setuid program that runs every time the game launches? Unthinkable.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912071/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912075"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2022 0:26 UTC (Sun)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/912075/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; One philosophical reason: If it's emulating the windows ABI to run a program that doesn't requires privileges, then it must not as for any additional privileges of it's own.</span><br>
<span class="QuotedText">&gt; </span><br>
<span class="QuotedText">&gt; Privileges during installation have never been required and are not allowed. Privileges that are repeatedly granted through permanently-lodged a setuid program that runs every time the game launches? Unthinkable.</span><br>
<p>
That is a somewhat odd position to take, because on Windows:<br>
<p>
1. Steam installs a service, which runs as "Local System." This is entirely equivalent to a daemon running as root, it's just that Windows uses different terminology.<br>
2. It is not uncommon for Steam games to display a UAC prompt on first run. This is usually to install MSVC++ redistributable or something of that nature, rather than doing some weird custom thing, but it still technically qualifies as elevated privileges.<br>
3. The way that Steam manages to install games without requiring a UAC prompt for every installation is kind of... terrible. Basically, it sets the library as world-writable and world-executable. That means anyone can drop a DLL in the same directory as the game and silently hijack it, because Windows considers the directory permissions to constitute a security boundary (indeed, you could just as easily replace the whole exe file). Now, you may argue that this is irrelevant, since the game is running as an ordinary user rather than a superuser, but we have to consider the <a href="https://xkcd.com/1200/">https://xkcd.com/1200/</a> factor.<br>
<p>
Note: (3) is my understanding of how it works, but like a lot of gamers, I do something *even more terrible than the above* and install everything into C:\Games instead of Program Files, so I don't know for sure if (3) is the default behavior or just my own damn fault. Why do I do this, if I know it's terrible? Because life is too short, that's why. It is not uncommon for older games to randomly break if they don't have full write access to "everything," so deliberately subverting the OS's security is not uncommon for PC gamers. Even if Steam is doing everything right, that doesn't help when half the users are overriding the defaults and using a less-secure configuration.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912075/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912182"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2022 15:01 UTC (Mon)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/912182/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
All of the above is pretty much invalidated by "on windows."<br>
We all know that user account permissions on windows are a total mess.<br>
<p>
The point is that high permissions should *never* be required for installing and running a game, which does nothing but:<br>
1) download some files<br>
2) copy them into the home directory<br>
3) launch an executable<br>
4) access graphics APIs/sound APIs/input APIs<br>
<p>
NONE of those things have ever warranted elevated privledges. Wine has continued doing it's thing for over a decade now without requiring sudo even once. The use of sudo wasn't needed when the ability to trap and redirect windows syscalls was added to the linux kernel, it sure as hell shouldn't be required because of a performance knob.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912182/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor912122"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2022 13:35 UTC (Mon)
                               by <b>implr</b> (guest, #159818)
                              [<a href="/Articles/912122/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;The entire steam linux runtime, and indeed every wine runtime MUST NOT require any more privileges than a regular user program. For installation or during runtime.</span><br>
It already does, at least for VR. On first run SteamVR will ask for sudo, which it uses to setcap CAP_SYS_NICE on its various binaries. If it detects that it can already run at nice -10, it'll skip that step.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912122/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912184"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2022 15:08 UTC (Mon)
                               by <b>developer122</b> (guest, #152928)
                              [<a href="/Articles/912184/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
*Due to unix's legacy as a multiuser system.* It dates back to the early days of unix that only root can decrease a nice value, giving more cpu time.<br>
<p>
Does this privileged tunable make any sense on a singe user system? No it does not.<br>
Worst case scenario, the user only DoSs themselves.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912184/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912206"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 24, 2022 21:01 UTC (Mon)
                               by <b>Wol</b> (subscriber, #4433)
                              [<a href="/Articles/912206/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And wasn't Unix originally written to run games? Specifically Star Trek, iirc ... :-)<br>
<p>
Cheers,<br>
Wol<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912206/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912260"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 25, 2022 10:22 UTC (Tue)
                               by <b>geert</b> (subscriber, #98403)
                              [<a href="/Articles/912260/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Didn't they just needed an OS to develop a document formatting system for the AT&amp;T patents division? ;-)<br>
<p>
<a href="https://www.gnu.org/software/groff/manual/html_node/History.html">https://www.gnu.org/software/groff/manual/html_node/Histo...</a><br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912260/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor912951"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2022 21:35 UTC (Fri)
                               by <b>mrugiero</b> (guest, #153040)
                              [<a href="/Articles/912951/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; * "Why shouldn't my game/database/whatever consume all available resources for maximum performance?"</span><br>
<p>
To be fair, split locks hurt their own performance as well. Maybe you do want your game to consume all available resources for maximum performance. Then take care of it actually providing maximum performance instead of harming it :)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912951/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor911835"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 13:13 UTC (Thu)
                               by <b>DouglasJM</b> (subscriber, #6435)
                              [<a href="/Articles/911835/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"...proper god of war using just ordinary locks, so the game does a lot of split locking. Luck's patch had achieved its intended purpose; God of War players are now suitably miserable. "<br>
<p>
This is the type of writing that makes reading LWN so enjoyable, tongue in cheek comments that make me smile or laugh out loud.  Keep up the great work folks, I look forward to reading LWN!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911835/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor911839"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 14:12 UTC (Thu)
                               by <b>JamesErik</b> (subscriber, #17417)
                              [<a href="/Articles/911839/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Couldn't agree more.  For me, the welcome levity was this:<br>
<p>
'''...split-lock operations have long been frowned upon.  Unfortunately, software that is malicious (or just poorly written) turns out to be remarkably indifferent to even the most severe of frowns.'''<br>
<p>
Thank you, Jonathan.  I very much admire your editorial style, your professionalism, and your consistently human touch to your work... including humor that hits the funnybone of geeks everywhere!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911839/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor911902"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 15:32 UTC (Thu)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/911902/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If a sysctl is being added, why not expose the ability to make split locks fatal via the knob (or even make that the default)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911902/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor911911"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 20, 2022 17:37 UTC (Thu)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/911911/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This article sounds a little suspicious of the merits of the gods and wars, but God of War is actually a heartwarming tale about a troubled man learning how to be a better father to his estranged son as they go on a journey together, hoping to achieve some closure by scattering his wife's ashes on the highest peak in the lands. It's surprisingly sophisticated and a lovely game.<br>
<p>
Also you have a cool axe and kill a few gods and rip many thousands of monsters' heads off.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911911/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor911953"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 21, 2022 10:04 UTC (Fri)
                               by <b>scientes</b> (guest, #83068)
                              [<a href="/Articles/911953/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Considering the long history of silicon bugs around "transactional memory" which is basically atomic operations over a much larger amount of multiple cache lines, this is clearly just the "exercise for the reader" warm-up to getting that stuff correct.<br>
<p>
Ivan Goddard said that atomic operations rather than the cache-flushing approach is not really worth it, because it costs almost the same due to cache-coherency issues. I have no thought through that however (I can't even get my head around L2 cache-coherent Zync-9000 FPGA with AXI yet...)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/911953/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912089"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 23, 2022 17:22 UTC (Sun)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/912089/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Considering the long history of silicon bugs around "transactional memory" which is basically atomic operations over a much larger amount of multiple cache lines</span><br>
<p>
Silicon bugs asides, this "basically" sounds weird in a discussion about split lock performance. The concept of a transaction is exactly what provides atomicity over a larger set of data _without_ any extra performance cost. Transactions make performance independent from the data size.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912089/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor912235"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 25, 2022 6:27 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/912235/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Can this be a prctl setting? Perhaps a cgroup one?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912235/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor912976"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2022 8:40 UTC (Sat)
                               by <b>wtarreau</b> (subscriber, #51152)
                              [<a href="/Articles/912976/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was going to ask the same. prctl() is precisely used exactly for such things, you can decide of FPU emulation, alignment checks, speculation bypass etc. The sole reason people complain precisely is because there's no wrapper allowing the behavior to change for the life time of a program, which prctl would do just fine.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912976/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor913030"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2022 20:06 UTC (Sat)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/913030/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
prctl() is for things which affect the operation of the process itself. This controls whether a program making use of split locks can negatively impact the performance of the entire *system*, which puts it in a category similar to real-time priorities. As such, a privileged sysctl knob is a reasonable solution. A cgroup option could also work, and would allow access to split locks to be more precisely targeted, but it would need to require some form of elevated privilege to enable it for a regular user account.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/913030/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor913033"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 29, 2022 21:11 UTC (Sat)
                               by <b>joib</b> (subscriber, #8541)
                              [<a href="/Articles/913033/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not sure cgroups are appropriate either, since the kernel cannot isolate the impact of the split-locking only to the members of the cgroup. I guess you could make some mechanism like "at most N split locks per second for this cgroup, after that split lock usage will be throttled", though I'm not sure if it would actually be useful for any practical situation. The sysctl knob sounds much simpler and should cover most usecases.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/913033/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor912957"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The search for the correct amount of split-lock misery</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 28, 2022 22:20 UTC (Fri)
                               by <b>marcH</b> (subscriber, #57642)
                              [<a href="/Articles/912957/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; The hope was that the warn mode would be sufficient to alert users to the problem, and lead to software being fixed, while [...]. By the time the 5.19 development cycle came around earlier this year, though, it seemed that little progress toward the removal of split lock operations had been made, and the denial-of-service problem was as present as before.</span><br>
<p>
Wait, how does anyone know the warning had no effect? When we spot a warning and try to address it we don't tell anyone and AFAIK the kernel has no telemetry feature yet.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/912957/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
