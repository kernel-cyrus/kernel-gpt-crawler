        <!DOCTYPE html>
        <html lang="en">
        <head><title>The trouble with struct sockaddr's fake flexible array [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/997094/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/997294/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/997094/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The trouble with struct sockaddr's fake flexible array</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>November 7, 2024</br>
           </div>
Flexible arrays — arrays that are declared as the final member of a
structure and which have a size determined at run time — have long drawn
the attention of developers seeking to harden the kernel against
buffer-overflow vulnerabilities.  These arrays have reliably been a source
of bugs, so anything that can be done to ensure that operations on them
stay within bounds is a welcome improvement.  While many improvements,
including the recent <a href="/Articles/936728/">counted-by work</a>, have
been made, one of the most difficult cases remains.  Now, however,
developers who are interested in using recent compiler bounds-checking
features are trying to get a handle on <tt>struct sockaddr</tt>.
<p>
<h4>The many faces of <tt>struct sockaddr</tt></h4>
<p>
The <tt>sockaddr</tt> structure dates back to the beginning of the BSD
socket API; it is used to hold an address corresponding to one side of a
network connection.  The <a
href="https://digitalassets.lib.berkeley.edu/techreports/ucb/text/CSD-83-146.pdf">4.2
BSD networking implementation notes</a> from 1983 give its format as:
<p>
<pre>
    struct sockaddr {
        short sa_family;
	char sa_data[14];
    };
</pre>
<p>
The <tt>sa_family</tt> field describes which address family is in use —
<tt>AF_INET</tt> for an IPv4 address, for example.  <tt>sa_data</tt> holds
the actual address, the format of which will vary depending on the family.
The implementation notes say that: "<q>the size of the data field,
14&nbsp;bytes, was selected based on a study of current address
formats</q>".  In other words, 14&nbsp;bytes — much longer than the four
needed for an IPv4 address — should really be enough for anybody.
<!-- middle-ad -->
<p>
Need it be said that 14 bytes turned out not to be enough?  As new
protocols came along, they brought address formats that were longer than
would fit in <tt>sa_data</tt>.  But the <tt>sockaddr</tt> structure was
firmly set in stone as user-space API and could not be changed.  It appears
in essentially the same form in any modern Unix-like system; on Linux the
type of <tt>sa_family</tt> is now <tt>sa_family_t</tt>, but otherwise the
structure is the same.
<p>
The result was one of the (many) historic kludges of the Unix API.  New
protocol implementations typically brought with them a variant of
<tt>struct sockaddr</tt> that was suitably sized for the addresses in use;
<tt>struct sockaddr_in6</tt> for IPv6 addresses, for example, or <tt>struct
sockaddr_ax25</tt> for AX.25.  All of the socket API interfaces still
specified <tt>struct sockaddr</tt>, but implementations on both sides would
use the appropriate structure for the protocol in use.  Code on both sides
of the API would cast pointers to and from <tt>struct sockaddr</tt> as
needed.
<p>
Even now, the documented APIs for system calls like <a
href="https://man7.org/linux/man-pages/man2/connect.2.html"><tt>connect()</tt></a>
and library functions like <a
href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html"><tt>getaddrinfo()</tt></a>
use <tt>struct sockaddr</tt>.  As a result, both user-space programs and
the kernel contain a whole set of casts between that type and the type they
are (hopefully) actually using.  Needless to say, these casts can be error
prone; casting a pointer between different structure types is also deemed
to be undefined behavior in current&nbsp;C.  But that's the price we pay
for API compatibility.
<p>
The advent of IPv6 also brought another type: <tt>struct
sockaddr_storage</tt>; it is defined as starting with the same
<tt>sa_family</tt> field, but being large enough to hold any of the other
<tt>sockaddr</tt> variants.  Code dealing with network addresses can
allocate a structure of this type and be sure of having enough space to
store any address.  This structure is now what is often allocated, but it
never appears explicitly in the system-call interface.
<p>
<h4>Making the flexible array explicit</h4>
<p>
The C language has accumulated a few idioms for the declaration of flexible
arrays over the years; specifying a dimension of zero or one are both
common (though deprecated) examples.  The syntax blessed by the language
standard, though, is to omit the dimension entirely:
<p>
<pre>
    struct something {
        /* ... */
	int flex_member[]; /* A flexible array */
    };
</pre>
<p>
This syntax makes it clear that a flexible array is in use and that the
type declaration cannot be used, on its own, to check for overflows of that
array.  In no convention is it deemed reasonable to use a dimension
of&nbsp;14 for a flexible array, but that is exactly what now happens with
<tt>struct sockaddr</tt>.  The actual length of <tt>sa_data</tt> is not
known, and has a good chance of being larger than the declared size.
It is a flexible array disguised as an ordinary array.
<p>
That usage complicates checking of <tt>struct sockaddr</tt> usage for
overflows, but the effects go beyond that; it makes detection of flexible
arrays harder across the kernel.  As Kees Cook noted in <a
href="/ml/all/20221018095503.never.671-kees@kernel.org/">this 2022
patch</a>:
<p>
<blockquote class="bq">
	One of the worst offenders of "fake flexible arrays" is struct
	sockaddr, as it is the classic example of why GCC and Clang have
	been traditionally forced to treat all trailing arrays as fake
	flexible arrays: in the distant misty past, sa_data became too
	small, and code started just treating it as a flexible array, even
	though it was fixed-size.
</blockquote>
<p>
As long as this usage remains, the checking tools built into both compilers
must treat <i>any</i> trailing array in a structure as if it were flexible;
that can disable overflow checking on that array entirely.
<p>
It would be nice to change this usage but, as was noted above, the layout
of <tt>struct sockaddr</tt> is wired deeply into the socket interface and
cannot be changed without breaking applications.  But that doesn't mean
that the kernel must treat <tt>sa_data</tt> as anything but a flexible
array.  To enable that without changing the binary interface, Cook
redefined <tt>struct sockaddr</tt> within the kernel to:
<p>
<pre>
    struct sockaddr {
        sa_family_t	sa_family;
	union {
	    char sa_data_min[14];
	    DECLARE_FLEX_ARRAY(char, sa_data);
	};
    };
</pre>
<p>
(The <a
href="https://elixir.bootlin.com/linux/v6.11.6/source/include/linux/stddef.h#L83"><tt>DECLARE_FLEX_ARRAY()</tt>
macro</a> jumps through some hoops needed to declare a flexible array
within a union).  This change made it clear that <tt>sa_data</tt> is a
flexible array, which helped, in turn, in the goal of allowing the
compilers to treat trailing arrays as non-flexible unless they are
explicitly declared as such.
<p>
This patch was merged for the 6.2 release, and all seemed to be well.  But,
as Gustavo A. R. Silva pointed out in <a
href="/ml/all/cover.1729802213.git.gustavoars@kernel.org">this patch
series</a>, there is a problem with this approach.  There are many places
in the kernel where <tt>struct sockaddr</tt> is embedded within another
structure, usually not at the end.  That has the result of placing a
flexible array in the middle of the embedding structure, which is
problematic for fairly obvious reasons; the compiler no longer knows what
the offsets to the members after <tt>struct sockaddr</tt> should be.  That
has resulted in "<q>thousands of warnings</q>" when the suitable check is
enabled in the compiler.
<p>
Silva's solution was to introduce yet another variant with a familiar form:
<p>
<pre>
    struct sockaddr_legacy {
        sa_family_t	sa_family;
	char		sa_data[14];
    };
</pre>
<p>
This structure, which lacks the flexible-array member, was then embedded in
the other structures, making the warning go away.  Since the embedding
cases did not use <tt>sa_data</tt> as a flexible array (otherwise things
would never have worked in the first place), this change was deemed safe to
make.
<p>
Networking maintainer Jakub Kicinski <a
href="/ml/all/20241031180145.01e14e38@kernel.org/">was not convinced</a>
about this change, though.  He suggested that perhaps Cook's patch should
be reverted instead, and a new type should be added for places where a
flexible array is actually needed.  Cook <a
href="/ml/all/202411031920.BEF6CEBCD@keescook/">acknowledged</a> this
suggestion as "<q>a pretty reasonable position</q>" and started to ponder
on alternatives.  He concluded: "<q>Now, if we want to get to a place with
the least ambiguity, we need to abolish sockaddr from the kernel
internally, and I think that might take a while.</q>"
<p>
<h4>Leaving <tt>struct sockaddr</tt> behind</h4>
<p>
In early November, Cook returned with <a
href="/ml/all/20241104221450.work.053-kees@kernel.org">a brief patch
series</a> meant to show what that approach would look like.  It begins by
reverting the 2022 patch, returning <tt>struct sockaddr</tt> to its
original non-flexible form.  There is <a
href="/ml/all/20241104222513.3469025-2-kees@kernel.org">a patch</a> adding
comments to places in the networking code that are known to use this
structure within its original bounds; they do not need to be changed, and
do not need <tt>sa_data</tt> to be flexible.  But that still leaves many uses of
<tt>struct sockaddr</tt> where the data area may, in reality, be larger
than 14&nbsp;bytes.
<p>
The solution for many of those places is just to use <tt>struct
sockaddr_storage</tt> instead.  Indeed, parts of the network stack already
use that structure, but then cast pointers to <tt>struct sockaddr</tt> for
functions that expect that type.  One example is <a
href="https://elixir.bootlin.com/linux/v6.11.6/source/net/core/utils.c#L402"><tt>inet_addr_is_any()</tt></a>,
which takes a <tt>struct sockaddr *</tt> argument, but is only called by
functions using <tt>struct sockaddr_storage</tt>.  In this case, <a
href="/ml/all/20241104222513.3469025-4-kees@kernel.org">the solution</a> is
to change the prototype of the function to match what is really being
passed to it and remove the casts from the callers.
<p>
Some changes will require more churn, even if they are conceptually simple.
The <tt>getname()</tt> callback (in the <a
href="https://elixir.bootlin.com/linux/v6.11.6/source/include/linux/net.h#L162"><tt>proto_ops</tt>
structure</a>) has long expected a pointer to a <tt>sockaddr_storage</tt>
structure, but its prototype was never changed to match.  The <a
href="/ml/all/20241104222513.3469025-5-kees@kernel.org">patch</a>
eliminating the use of <tt>struct sockaddr</tt> for <tt>getname()</tt>
mostly consists of name changes and cast removal, but it touches
66&nbsp;files.  It also, as Cook noted in the cover letter, is still lying to
the compiler in cases where the backing structure is actually smaller than
<tt>struct sockaddr_storage</tt>, "<q>these remain just as safe as they
used to be. :)</q>"
<p>
This series shows that truly eliminating the use of this structure's
<tt>sa_data</tt> field as a flexible array in disguise will involve a fair
amount of work and code churn.  Even so, Kicinski <a
href="/ml/all/20241105171607.48c0c24d@kernel.org">commented</a> that it
"<q>feels like the right direction</q>".  So, while <tt>struct
sockaddr</tt> will likely remain part of the kernel's system-call API
forever, its use within the kernel can be expected to fade away over time.
A design miscalculation made over 40&nbsp;years ago may finally stop
impeding the use of modern memory-safety tools.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Flexible_arrays">Flexible arrays</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/997094/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor997403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BSD didn't even save a size_t by doing this</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 7, 2024 19:37 UTC (Thu)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/997403/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As I read this, it looks like this comes down to a poor design decision in the initial API, namely the choice to use a statically-sized array instead of a dynamic array. It's easy to claim that this would have made sense at the time because it saves a size_t... but that's not actually true:<br>
<p>
<span class="QuotedText">&gt; The sa_family field describes which address family is in use — AF_INET for an IPv4 address, for example. sa_data holds the actual address, the format of which will vary depending on the family. The implementation notes say that: "the size of the data field, 14 bytes, was selected based on a study of current address formats". In other words, 14 bytes — much longer than the four needed for an IPv4 address — should really be enough for anybody.</span><br>
<p>
A size_t (or the moral equivalent in pre-standards C) has never been 10+ bytes on any real platform that people have used for serious purposes, with the possible exception of a small handful of natively 128-bit supercomputers. If you're willing to waste 10 bytes in the extremely common case of IPv4, you should be willing to spend 4 bytes on a size_t/long/whatnot (or however many bytes a size_t-ish was in 1983), since that would net out to 6 bytes saved in the case of IPv4. I think the more plausible explanation is that somebody didn't feel like writing the extra code to initialize the size field.<br>
<p>
(And no, using something other than a size_t due to its lack of standardization would not have caused problems today. Unless there's some weird networking protocol I don't know about that requires addresses bigger than 64K, a 16-bit size field would still be more than adequate even if it would be a bit nonstandard.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997411"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">BSD didn't even save a size_t by doing this</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 7, 2024 20:53 UTC (Thu)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/997411/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <font class="QuotedText">&gt; I think the more plausible explanation is that somebody didn't feel like writing the extra code to initialize the size field.</font>

<p>The simple explanation is that was 1983. Time where backward compatibility started becoming <b>important</b> but no one really felt it would become <b>critical</b>.</p>

<p>Just five years before that FORTRAN removed some pieces from standard without anyone batting an eye!</p>

<p>Surely it's a <b>soft</b>ware, it's malleable, people would just fix it later, when requirements would change?</p>

<p>It's only when people started dragging feet with upgrade to FORTRAN 77, when people essentially boycotted MS-DOS 4.0 (in 1988!) because it changed some internal data structures which “programs were not supposed to ever touch”, only when OS/2 completely imploded because someone decided to “improve” Presentation Manager API… only then developers of operation systems realized that keeping ABI stable would make or break them (and even after that moment Linux developers denied the obvious for decades, but that's another thing).</p>

<p>I would bet that <b>no one</b> expected to see <code>sockaddr</code>, casually introduced in 1983 just for the “large-scale experiment” (as Vint Cerf attests <code>IPv4</code> was envisioned as large-scale experiment, no one expected it to be used outside of academy and there were expectation that <a href="https://en.wikipedia.org/wiki/OSI_protocols">another thing</a> or <a href="https://en.wikipedia.org/wiki/STREAMS">yet another thing</a> would be used by everyone else) – would still be in use 40 years later and would affect hundreds of <b>billions</b> devices… if they have heard about it they would have assumed you have lost all your marbles.</p>




      
          <div class="CommentReplyButton">
            <form action="/Articles/997411/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor997409"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why oh why …?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 7, 2024 20:19 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997409/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; places in the kernel where struct sockaddr is embedded within another structure, usually not at the end</span><br>
<p>
Well since the subtype of "struct sockaddr" that's actually used in these places is not and never was 14+2 bytes long, why was the option to replace these with the sockaddr type that's actually used there not considered?<br>
<p>
Seems like a no-brainer to me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997409/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor997415"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr API design</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 7, 2024 23:52 UTC (Thu)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/997415/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;struct sockaddr_storage [...] is now what is often allocated, but it never appears explicitly in the system-call interface. </span><br>
<p>
I am surprised no one has mentioned that the sockaddr struct family essentially forms a class hierarchy. Think of it like so:<br>
<p>
struct sockaddr { sa_family_t family; } struct sockaddr_in6 : public sockaddr { uint16_t port; ... } struct sockaddr_storage : public sockaddr { char moarroom[126]; };<br>
<p>
And then it's obvious why bind() and connect() take a struct sockaddr. It works with any sockaddr type, and in that sense, userland should have no need to care about the size of sockaddr::sa_data, or that this member even exists. sockaddr::sa_data (as well as sockaddr_storage) may help code reduction, fewer casts, or performance optimizations, but it is not needed conceptually.<br>
<p>
<span class="QuotedText">&gt;Code dealing with network addresses can allocate a [sockaddr_storage] and be sure of having enough space to store any address</span><br>
<p>
sockaddrs are inherently variable-length (as evidenced by the length argument to bind/connect/accept), and sockaddr_storage does not fix that. It's just a conveniently-sized buffer for "this operating system's most common sockaddrs at the time of compilation", but it is not completely future-proof.<br>
<p>
In fact, we could have limitness AF_UNIX paths already if we did not constrain ourselves to using sockaddr_un (in both userland and kernelspace):<br>
<p>
        const char *path = argv[1];<br>
        socklen_t addrlen = offsetof(struct sockaddr, sa_data) + strlen(path) + 1;<br>
        char *addr = malloc(addrlen);<br>
        ((struct sockaddr *)addr)-&gt;sa_family = AF_UNIX;<br>
        strcpy(&amp;addr[2], argv[1]);<br>
        int ret = bind(sk, (struct sockaddr *)addr, addrlen);<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997415/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997426"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr API design</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 1:37 UTC (Fri)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/997426/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; In fact, we could have limitness AF_UNIX paths already if we did not constrain ourselves to using sockaddr_un (in both userland and kernelspace):</span><br>
<p>
Some systems, like macOS, do allow providing a path larger than sizeof .sun_path (104 on my laptop). On those systems, when querying an address using getsockname or getpeername, you should check the returned addrlen and try again if it's larger than the provided buffer. Though in the case of macOS the path length isn't limitless, but 252 characters (address structure size of 255, including a trailing NUL character).<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997426/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor997430"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 2:59 UTC (Fri)
                               by <b>clugstj</b> (subscriber, #4020)
                              [<a href="/Articles/997430/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"There are many places in the kernel where struct sockaddr is embedded within another structure"<br>
<p>
How can this be anything but a bug?  It's not big enough for many address formats.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997430/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997431"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 3:41 UTC (Fri)
                               by <b>iabervon</b> (subscriber, #722)
                              [<a href="/Articles/997431/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was wondering the same thing, so I looked at some of the patches. The answer is that it's an address from a specific family. E.g., your wireless card's MAC address is always a MAC address, not an IPv6 address. However, storing those 6 bytes next to the right 2 bytes and 8 unused bytes allows it to be passed in situ to functions that can take all sorts of addresses, without needing a ton of MAC-address-specific functions or using two function arguments per address in all of the functions.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997431/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 7:02 UTC (Fri)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997438/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well. But several addresses are longer anyway, so presumably the called functions restrict themselves to the sa_family-specified length.<br>
<p>
So why do the short variants need padding up to an arbitrary 14, which happens to not match *any* actual address type's length?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997441"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 7:58 UTC (Fri)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/997441/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because ... history. The API to userspace was defined that way (some of it perhaps even back when 14 "was enough for everyone"), so it cannot be changed now.<br>
<p>
Sure, wireless extensions wouldn't need 14 bytes for a MAC address there, only ever 6. But now it's stuck with 14 and can't use 6, and shouldn't use "14 or variable" either because it's embedded in other types.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997441/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997567"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 21:31 UTC (Fri)
                               by <b>magfr</b> (subscriber, #16052)
                              [<a href="/Articles/997567/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am actually also curious about why the padding is needed?<br>
<p>
Would it be confirming if the kernel returned a size of 8 and only filled in the sin_family, sin_port, and sin_addr fields?<br>
<p>
I suppose the kernel does nothing with the padding as it is today so beeing explicit about it should be ok.<br>
<p>
It should be noted that posix says sa_data must exist but it says nothing about it's size.<br>
<p>
Then there is the issue that all the sockaddr_xx types must have the same alignment.<br>
<p>
What I am going for is if the following is standards conforming:<br>
<p>
typedef alignas(16) int16_t sa_family_t;<br>
struct sockaddr { sa_family_t sa_family; char sa_data[]; };<br>
struct sockaddr_in { sa_family_t sin_family; uint16_t sin_port; struct inaddr sin_addr; };<br>
<p>
with an obvious caveat for what the alignment of sa_family_t should be.<br>
<p>
In particular this makes sizeof(struct sockaddr) == 2 and sizeof(struct sockaddr_in) == 8 but note that <br>
sizeof(struct sockaddr[2]) == 32 due to the alignment.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997567/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor997599"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 9, 2024 8:33 UTC (Sat)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997599/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly which userspace API requires a 16-byte sockaddr? Using that type always requires a socket type. Some addresses are larger than the traditional sockaddr_t (Unix, IPv6, …) some are smaller (IPv4); there's nothing that requires zeroing out the padding in the latter.<br>
<p>
So why does the kernel really need padded addresses anywhere? Just use / copy however many bytes the address's type requires and be done with it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997599/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997638"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 9, 2024 23:15 UTC (Sat)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/997638/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
None requires 16 bytes, probably?<br>
<p>
But for some APIs the address is _embedded_ into other structures (which is what most of the article is about), and changing the size now would change the position of everything that comes after it, breaking the ABI.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997638/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997649"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 9:17 UTC (Sun)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997649/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Exactly which API are we talking about here? (Presumably one that doesn't support IPv6 …)<br>
<p>
I'm not aware of any system call that embeds a sockaddr in some other data structure, but maybe that's just me.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997649/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997667"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 19:20 UTC (Sun)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/997667/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, it's just you? ;-)<br>
<p>
You can take a look at <a href="https://lore.kernel.org/netdev/cover.1729802213.git.gustavoars@kernel.org/">https://lore.kernel.org/netdev/cover.1729802213.git.gusta...</a> for probably most/all of the APIs affected.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997667/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997670"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 21:18 UTC (Sun)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997670/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Ah, so ioctls for the IPv4 ARP table, legacy routing, and similar stuff that frankly I'd deprecate in a heartbeat. Does anybody (except /sbin/arp AFAICT) still not use netlink for that, these days?<br>
<p>
Oh well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997670/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997673"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 21:32 UTC (Sun)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/997673/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A surprisingly large number of tools still use(d) wext, but I'm kicking them out - WiFi7 hardware no longer supports wext in any way. Let's see if I can win that fight ...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997673/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997684"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2024 9:21 UTC (Mon)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/997684/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd happily switch to iw, except… I really like the output of iwconfig and iwlist? I don't understand why we need to couple API changes with how a CLI works (especially when said CLI moves more towards the needs of low-level expert users).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997684/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997690"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2024 10:36 UTC (Mon)
                               by <b>mb</b> (subscriber, #50428)
                              [<a href="/Articles/997690/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
cfg80211 has always included a wireless-extensions API emulation to keep iwconfig and lwlist working.<br>
So it's exactly the opposite of what you say: The fundamental API has changed, but the obsolete CLI and its obsolete API have not.<br>
So, if almost two decades is not enough for you to adapt to the "new" iw CLI, then you can keep using iwconfig/iwlist.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997690/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997702"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">sockaddr used in the kernel?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 11, 2024 12:34 UTC (Mon)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/997702/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, no, as I said - I'm removing that part too now for WiFi7 hardware. There are some technical reasons for that even.<br>
<p>
As for the question about why it "must" be coupled with changes in the CLI, well ... it doesn't really need to be, but when writing a completely new tool that for the most part has completely new semantics, keeping the CLI intact really isn't the first priority.<br>
<p>
If you want to submit patches to make 'iw' have a mode where it behaves like iwconfig/iwlist for a subset of functionality, I guess I'd even apply them if they're reasonably well implemented.<br>
<p>
But you can keep using it for eternity, for all I care, just don't expect new hardware support etc., and then you can just keep using an old kernel version too.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997702/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor997436"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">minimum size for flexible arrays</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 6:23 UTC (Fri)
                               by <b>magnus</b> (subscriber, #34778)
                              [<a href="/Articles/997436/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess the data length of 14 in the sockaddr was also chosen to get a nice even size of 16 bytes on older archs where short is 2 bytes long. <br>
<p>
Beside legacy issues, could it make sense to have a minimum size for flex arrays in some cases, like to know you can always use a bigger access to fetch it or use the first n bytes as a hash or something (provided the unused bytes are always 0)? <br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997436/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997437"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">minimum size for flexible arrays</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 6:57 UTC (Fri)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/997437/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; on older archs where short is 2 bytes long</span><br>
<p>
Isn't short more-or-less always 2 bytes long? (Checked x86-64, aarch64, mips64 and ppc64, what did I miss?)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997437/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997446"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">minimum size for flexible arrays</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 10:20 UTC (Fri)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/997446/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Common, but not required. It's not the size that is mandated, but the bit width/value range. Think sizeof(long long)=1 with CHAR_BIT=64.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997446/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor997454"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">minimum size for flexible arrays</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 13:19 UTC (Fri)
                               by <b>magnus</b> (subscriber, #34778)
                              [<a href="/Articles/997454/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I learned something today! Thanks..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997454/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor997442"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 8:57 UTC (Fri)
                               by <b>taladar</b> (subscriber, #68407)
                              [<a href="/Articles/997442/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Sounds to me like a good example why backwards compatibility should sometimes be broken even if it causes great pain once so we won't be stuck with bad design decisions from literally decades ago forever.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997442/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997560"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 19:48 UTC (Fri)
                               by <b>jeremyhetzler</b> (subscriber, #127663)
                              [<a href="/Articles/997560/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would love to read a book about the history of API backward compatibility in OSes, and how we got to where we are today.<br>
<p>
Because intuitively I see your point, but demonstrably Linux is very *very* committed to the concept. MS maybe less so, but still more than I imagine is convenient for them.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997560/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor997564"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 8, 2024 20:25 UTC (Fri)
                               by <b>rweikusat2</b> (subscriber, #117920)
                              [<a href="/Articles/997564/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The chances that people will modify all existing software ever developed for the BSD sockets API just because someone thinks he has a better idea for representing network addresses are - politely put - not very great.<br>
<p>
:-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997564/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997600"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 9, 2024 8:38 UTC (Sat)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997600/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IMHO the only incompatibility is that for addresses smaller than 16 bytes the kernel will no longer zero out the padding when it copies an address to userspace / require the padding to even exist when it reads an address.<br>
<p>
Everything else should literally stay the same. I have no idea how many programs go splat because their address padding is no longer overwritten but if the number is nonzero then a compatibility mode can be added to the place where the address is copied to userspace. Not spread across the whole of the kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997600/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor998106"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2024 5:40 UTC (Thu)
                               by <b>dvdeug</b> (guest, #10998)
                              [<a href="/Articles/998106/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You can always have a BSD sockets API translation layer. It could be constrained to libc, but the kernel would probably support those system calls indefinitely. But that wouldn't stop a new set of system calls and the old system calls being wrappers around the new system calls.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998106/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor998107"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2024 7:01 UTC (Thu)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/998107/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The Sockets API isn't the problem. It happens not to embed a sockaddr in anything, much less in the middle of another struct.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998107/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor998216"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2024 21:29 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/998216/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It kinda is...<br>
<p>
A lot of the sockets API needs to be rewritten. It needs to support Happy Eyeballs, it needs to expose the DNS data explicitly (TXT queries, etc.), it needs to be able to deal with changing/multiple addresses for the bound sockets, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998216/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor997661"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 18:33 UTC (Sun)
                               by <b>lunaryorn</b> (subscriber, #111088)
                              [<a href="/Articles/997661/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If we go that way we might just as well deprecate the entire socket API right away and invent an entirely new networking API, because frankly, the socket API is not a great by modern standards. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997661/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor997671"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 21:31 UTC (Sun)
                               by <b>intelfx</b> (subscriber, #130118)
                              [<a href="/Articles/997671/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt;  If we go that way we might just as well deprecate the entire socket API right away and invent an entirely new networking API, because frankly, the socket API is not a great by modern standards. </span><br>
<p>
How would you do one better? (Architecturally, not just minor C technicalities like the one discussed in the article.)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997671/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor999329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 23, 2024 18:15 UTC (Sat)
                               by <b>anton</b> (subscriber, #25547)
                              [<a href="/Articles/999329/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <blockquote>
How would you do one better?
</blockquote>

By looking at what Ken Thompson did, i.e. Plan 9.  The Berkeley socket API appears totally alien to Unix, and was probably designed to have as little to do with the rest of the kernel as possible.  E.g., send() instead of write() and recv() instead of read(); at least that was corrected later, but we still have send() and recv().


      
          <div class="CommentReplyButton">
            <form action="/Articles/999329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor997672"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 10, 2024 21:35 UTC (Sun)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/997672/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While the Berkeley socket API is in fact not that great by today's standard, it's also not interesting WRT this discussion because it does *not* have sockaddr structs embedded somewhere in the middle of other objects.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997672/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor998477"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2024 19:35 UTC (Sun)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/998477/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; the socket API is not a great by modern standards.</span><br>
<p>
The IETF is working on a "successor to the sockets API": <a href="https://datatracker.ietf.org/doc/draft-ietf-taps-interface/">https://datatracker.ietf.org/doc/draft-ietf-taps-interface/</a><br>
<p>
Although who knows who will actually implement it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998477/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor998486"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2024 21:05 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/998486/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
STREAMS, but different!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998486/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor998497"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 18, 2024 6:18 UTC (Mon)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/998497/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Streams are *way* cool when you do them The Right Way.<br>
They can also eat your machine's performance for breakfast (and have room left over) when you do them naïvely.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998497/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor998484"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Backwards compatibility at any cost?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2024 21:13 UTC (Sun)
                               by <b>smurf</b> (subscriber, #17840)
                              [<a href="/Articles/998484/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; The IETF is working on a "successor to the sockets API":</span><br>
<p>
Well. Eight people have written 26 RFC drafts, during the last 6 years, for this one.<br>
That's four people, five years, and 20 drafts too many IMHO.<br>
Also, the latest of those drafts expired two months ago, but at least it's in Approved state and in the RFC editor queue by now.<br>
<p>
<span class="QuotedText">&gt;  Although who knows who will actually implement it.</span><br>
<p>
IMHO the comment by Roman Danyliw (see the RFC history) is telling:<br>
<p>
<span class="QuotedText">&gt; […] I am abstaining on this document because there is a degree of specificity in the abstract API in this document that I cannot reconcile with proposed standard status. […]</span><br>
<p>
… meaning that it's way not specific enough that, given this RFC, somebody'd be able to write a program that's expected to work with any specific implementation. Thus, more RFCs and system-specific (thus mostly-incompatible) scaffolding will be needed.<br>
<p>
Thus, again IMHO, this will not replace the Socket API any time soon.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998484/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor997614"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 9, 2024 13:08 UTC (Sat)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/997614/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The non-existent uptake of the Naval Research Lab's library for dealing with struct sockaddr (IIRC, it provided a portable replacement structure and hid all the fine details) suggests that, at least in the mid 90s, there wasn't much interest in reliable memory handling.<br>
<p>
It would have required a fair bit of work for legacy code, yes, but you might have expected new code to use it as IPv6 was quite difficult to handle.<br>
<p>
This suggests that there's a degree of conservatism in programming, a preference for The Old Ways. This is going to complicate efforts to do anything new that is visible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/997614/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor998475"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interesting problem</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 17, 2024 19:24 UTC (Sun)
                               by <b>skissane</b> (subscriber, #38675)
                              [<a href="/Articles/998475/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; the Naval Research Lab's library for dealing with struct sockaddr </span><br>
<p>
Is that available somewhere still? Would be an interesting bit of history to look at.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/998475/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
