        <!DOCTYPE html>
        <html lang="en">
        <head><title>A sandbox mode for the kernel [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/963734/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/964043/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/963734/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A sandbox mode for the kernel</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>This article brought to you by LWN subscribers</b>
<p>
Subscribers to LWN.net made this article &mdash; and everything that
       surrounds it &mdash; possible.  If you appreciate our content, please
       <a href="/Promo/nst-nag3/subscribe">buy a subscription</a> and make the next
       set of articles possible.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 29, 2024</br>
           </div>
The Linux kernel follows a monolithic design, and that brings a well-known
problem: all code in the kernel has access to the entirety of the kernel's
address space.  As a result, a bug in (for example) an obscure driver may
well be exploitable to wreak havoc on core-kernel data structures.  Various
attempts have been made over the years to increase the degree of isolation
within the kernel.  The latest of these, <a
href="/ml/linux-kernel/20240214113035.2117-1-petrtesarik@huaweicloud.com/">"SandBox
Mode"</a> proposed by Petr Tesařík, makes it possible for the kernel to run
some limited code safely, but it has encountered a bit of a chilly reception.
<p>
<h4>Sandbox mode</h4>
<p>
The intent behind this new mode is to allow the kernel to run a function in
a way that it cannot affect the rest of the kernel.  In its simplest form,
sandbox mode is used by defining a function to be run in this isolated
mode:
<p>
<pre>
    #include &lt;linux/sbm.h&gt;

    static SBM_DEFINE_FUNC(untrusted_func, void *input_data, void *output_data);
</pre>
<p>
That function would then be invoked with a sequence like:
<p>
<pre>
    struct sbm sbm;

    sbm_init(&amp;sbm);
    result = sbm_call(&amp;sbm, untrusted_func, SBM_COPY_IN(&amp;sbm, input_buffer, in_size),
			                    SBM_COPY_OUT(&amp;sbm, output_buffer, out_size));
</pre>
<p>
This code will result in a call to <tt>untrusted_func()</tt>.  The input
and output buffers will be allocated, and the input data copied, before
that function is called with pointers to the new buffers.  On a successful
return, output data will be copied back, and <tt>sbm_call()</tt> will
return the value returned by <tt>untrusted_func()</tt>.
<p>
In the absence of architecture-specific support, that is about all that
sandbox mode does; the <a
href="/ml/linux-kernel/20240214113035.2117-6-petrtesarik@huaweicloud.com/">associated
documentation</a> rightly describes this as "<q>weak isolation</q>".  It
might be enough to trap a simple overflow of the input or output buffers,
but it still does not protect the kernel from any stray accesses that go
further afield.
<p>
In <a
href="/ml/linux-kernel/20240214113035.2117-6-petrtesarik@huaweicloud.com/">a
separate series</a>, Tesařík provided a set of x86-64 architecture hooks
that enhance the sandbox to provide stronger isolation.  Specifically:
<p>
<ul class="spacylist">
<li> The sandboxed function will be run with a separate set of page tables
     that limit its address space to the relevant code, the input buffer
     (mapped read-only), and the output buffer.  As a result, the function
     will have no access to any other memory in the system.  This change
     has some far-ranging implications; for example, it must be undone if
     an interrupt arrives so that the interrupt handler can run within the
     kernel's address space.
<li> The CPU is put into user mode, so that it cannot execute any
     privileged instructions; the function runs as if it were a user-space
     process.
<li> A separate kernel stack is allocated and the function is called on
     that stack so that it has no access to the normal kernel stack.  There
     is also a separate exception stack that is used while sandbox mode is
     in effect.
<li> Any sort of CPU fault causes the immediate termination of the sandbox
     and an error return to the caller.
</ul>
<p>
At this point, according to the documentation, sandbox mode provides
"<q>strong isolation</q>" that should suffice to prevent the sandboxed
function from accessing the rest of the kernel.
<p>
<h4>In search of users</h4>
<p>
But for what purpose has this mode been created?  The documentation says
that sandbox mode exists for "<q>parsing data from untrusted sources,
especially if the parsing cannot be reasonably done by a user mode
helper</q>", but there was no actual user included with the patch series,
so there was no way to see what an intended user looks like.  That,
naturally, led to questions.  Andrew Morton <a
href="/ml/linux-kernel/20240214053053.982b48d993ae99dad1d59020@linux-foundation.org/">remarked</a>
that the API seemed overly restrictive and wondered how it would be
possible to get any real work done; he asked for an example to clarify the
situation, a request that Greg Kroah-Hartman <a
href="/ml/linux-kernel/2024021425-audition-expand-2901@gregkh/">echoed</a>.
<p>
Tesařík <a
href="/ml/linux-kernel/20240214155524.719ffb15@meshulam.tesarici.cz/">answered</a>
that the framework is "<q>quite limited</q>" in its current form, but that
he intended to expand it over time.  A bit later, he posted <a
href="/ml/linux-kernel/20240216152435.1575-1-petrtesarik@huaweicloud.com/">a
PGP-key parser</a> that would run within the sandbox mode as an example
user, but that did little to increase acceptance of this work.  As Dave
Hansen <a
href="/ml/linux-kernel/c65eb8f1-2903-4043-a3ab-945d880043b5@intel.com/">pointed
out</a>, the kernel does not currently contain a parser for PGP keys, so
the new series just raised the question of why <i>that</i> needs to be
added too.  Hansen said it would be far better to move some existing kernel
functionality into the sandbox to show how it could be made safer.
<p>
The response to that request was <a
href="/ml/linux-kernel/20240222131230.635-1-petrtesarik@huaweicloud.com/">yet
another patch series</a> moving the parsing of AppArmor profiles into a
sandbox.  Supporting this use case required making a number of changes to
the sandbox mode itself, including a new "fixup" mechanism designed to make
it possible to call specific kernel functions from within the sandbox.  So,
for example, if code within the sandbox needs to allocate memory, it can
call <tt>kmalloc()</tt>.  That call will result in a fault, which will
result in the execution of a proxy version of <tt>kmalloc()</tt> that will
restore the kernel's full address space for the duration of the call.
<p>
Hansen <a
href="/ml/linux-kernel/f6135f2c-BC8f-41c3-9c6a-8346d685e4dc@intel.com/">responded</a>
that the "fixup" mechanism looked like a maintenance problem:
"<q>Establishing and maintaining this proxy list will be painful.  Folks
will change the code to call something new and break this
*constantly*.</q>" He <a
href="/ml/linux-kernel/5de7d665-7047-497b-94fb-76ec2af3c9e2@intel.com/">concluded</a>
that sandbox mode did not seem like a good
idea overall:
"<q>I don't see any viable way forward for this approach</q>".  He did not
even comment on the need to add a special "<tt>__nosbm</tt>" marker to all
functions that might land in the same page as one that has been marked for
calls from within sandbox mode — an extra step that seems almost certain to go
wrong at some point.
<p>
The obvious conclusion is that sandbox mode is unlikely to make it
into the mainline in anything resembling its current form.  But there is
clear value in isolating some kinds of kernel code, if there were only an
acceptable way in which it could be done.  One possibility is to use BPF,
which is intended to provide isolation; non-trivial BPF programs can be
tricky to get past the verifier, though, and the fact that they are loaded
from user space may make some security-oriented people nervous.
<p>
Another possibility might be the <a href="/Articles/755919/">user-mode blob
feature</a> that was merged into the 4.18 kernel nearly six years ago.  It
was intended for a similar purpose — the parsing of firewall rules for the
BPF-based "bpfilter" subsystem — but has never seen use in the mainline
kernel.  In response to <a
href="/ml/linux-kernel/87y1bktjdk.fsf@meer.lwn.net/">a query</a> about
using this feature instead of a new sandbox mode, Roberto Sassu <a
href="/ml/linux-kernel/33a1fae4-d713-4e93-89ff-ff9f377e8391@huaweicloud.com/">said</a>
that "<q>security people don't feel confident</q>" about using it.  The
main concern seems to be that, since user-mode blobs run in a separate,
user-space process, they would be subject to manipulation by user space;
sandbox mode, being fully contained within the kernel, should be better
protected.
<p>
If complete isolation from user space is also a requirement for this work,
then it may be that there are no viable solutions for Linux at this time.
Hardening the kernel is a worthy goal, but it is just one of many that have
to be traded off in the creation of a kernel that is both useful and
maintainable in the real world.  In the absence of a better implementation,
it would appear that sandbox mode does not offer enough to justify the
tradeoffs it would require.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Security-Kernel_hardening">Security/Kernel hardening</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/963734/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor964079"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 29, 2024 16:33 UTC (Thu)
                               by <b>auc</b> (subscriber, #45914)
                              [<a href="/Articles/964079/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Naive question: can nothing be done in this direction using the ring 1/2 levels of Intel like CPUs ? Weren't those initially designed to help isolate e.g. device drivers ?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964079/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964082"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 29, 2024 17:00 UTC (Thu)
                               by <b>izbyshev</b> (subscriber, #107996)
                              [<a href="/Articles/964082/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Even if something can be done, rings 1 and 2 don't exist in the recently proposed X86S.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964082/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964083"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 29, 2024 17:04 UTC (Thu)
                               by <b>ErikF</b> (subscriber, #118131)
                              [<a href="/Articles/964083/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
x86-64 long mode has removed rings 1 and 2 (<a href="https://www.intel.com/content/www/us/en/developer/articles/technical/envisioning-future-simplified-architecture.html">https://www.intel.com/content/www/us/en/developer/article...</a>).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964083/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964110"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 29, 2024 21:03 UTC (Thu)
                               by <b>draco</b> (subscriber, #1792)
                              [<a href="/Articles/964110/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Linus wrote a withering critique of the ring 1/2 architecture a few years ago: <a href="https://www.realworldtech.com/forum/?threadid=200812&amp;curpostid=200835">https://www.realworldtech.com/forum/?threadid=200812&amp;...</a><br>
<p>
So I don't think that's going to happen<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964110/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2024 14:21 UTC (Thu)
                               by <b>tesarik</b> (subscriber, #52705)
                              [<a href="/Articles/964682/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>FWIW I had a quick glance at CPL 1 and 2:

<ol>
<li>This thing is x86-specific (whereas my SandBox Mode can be implemented for any platform with a MMU).</li>
<li>Memory protection in Linux is based on paging, which does not offer more than a U/S bit even on x86.</li>
</ol>

<p>Despite what Linus wrote in the reply linked above, a “Supervisor page” does not mean CPL=0, but rather CPL≠3. So, there is a difference between ring 1 (can access Supervisor pages) and ring 3 (cannot access only User pages), and there is also a difference between ring 0 (can execute privileged instructions) and ring 1 (cannot execute privileged instructions). From this, it would seem that ring 1 matches SandBox Mode requirements quite nicely, but not really. Since kernel pages are accessible from ring 1, I would have to flush the whole TLB (including global pages) on every SandBox Mode entry. If sandbox code runs in ring 3, I can do lazy TLB invalidation, which is a huge performance win.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/964682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964887"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 9, 2024 10:56 UTC (Sat)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/964887/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Keep in mind that his critique is specifically about x86 implementation and not about the idea of having more then two dedicated levels of privelege separation.</p>

<p>The core of his critique was this: <i>there is basically absolutely no difference between rings 1-3</i>.</p>

<p>These rings were added to 80286 to support very limited version of what <a href="https://en.wikipedia.org/wiki/Intel_iAPX_432">iAPX 432</a> did and if you would structure your OS and all you programs as bunch of objects that don't use flat address space and use everything via descriptors they <b>are</b> useful… but nobody does that (except maybe OS/2) and x86-64 doesn't even support that mode.</p>

<p>These rings are, indeed, supremely useless for most modern OSes.</p>

<p>That doesn't mean <b>all</b> rings are useless, e.g. there are more rings for virtualization and they <b>are</b> useful. Just not for what here is attempted.</p>



      
          <div class="CommentReplyButton">
            <form action="/Articles/964887/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor964101"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 29, 2024 19:43 UTC (Thu)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/964101/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Use WebAssembly.<br>
<p>
But also, if user-space helpers aren't adequately isolated, fix that! That seems much more generally useful, and leads to a better long-term outcome.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964101/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964683"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2024 14:34 UTC (Thu)
                               by <b>tesarik</b> (subscriber, #52705)
                              [<a href="/Articles/964683/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <p>Yes, SandBox Mode could be redefined as <i>immutable user space</i>. I did consider this option but then decided against it, because I wanted to make it reasonably easy to to move existing kernel code into a SandBox Mode. Making a user-mode driver (UMD) is substantially more effort:</p>

<ul>
<li>UMD is a user-space application. It cannot use the standard kernel APIs.</li>
<li>Data passed between the kernel and UMD must be serialized and deserialized, plus you may have to add some glue code in the kernel.</li>
</ul>

<p>That said, if such definition of SandBox Mode is more welcome by the community, it is a viable alternative.</p>




      
          <div class="CommentReplyButton">
            <form action="/Articles/964683/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor964104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 29, 2024 19:51 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/964104/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
WASM.<br>
<p>
/me runs and takes a cover.<br>
<p>
But really, this should be a good application for eBPF. Especially because the code in question is not performance-critical.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964170"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2024 13:55 UTC (Fri)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/964170/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <blockquote><i>since user-mode blobs run in a separate, user-space process, they would be subject to manipulation by user space</i></blockquote>
<p>
How so? Certainly possible if the blob execs or dloads some file, but if the blob only uses kernel-provided data and code, as described in the linked lwn article, I don't see how it could be manipulated (unless there is a security breach allowing normal programs to hack privileged user-mode programs, but then the game is already lost anyway).



      
          <div class="CommentReplyButton">
            <form action="/Articles/964170/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964183"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2024 15:00 UTC (Fri)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/964183/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      Remember that there are people setting up locked-down systems where even root can only do so much.  On such a system, the ability to attack a process with <tt>ptrace()</tt> could be a real concern.


      
          <div class="CommentReplyButton">
            <form action="/Articles/964183/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964244"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2024 22:48 UTC (Fri)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/964244/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The only way I can think of to make this work is to make the userspace helper exceptional in some way, such as:<br>
<p>
* The kernel automatically panics if any part of userspace messes with it.<br>
* The kernel automatically denies any attempt by userspace to mess with it.<br>
* It is owned by some kind of super-root user which is superior to "regular" root, and there is no way for init or its children to obtain super-root creds.<br>
* It is a kernel thread, with all of the usual "can't touch this" special-casing, but it runs in user mode instead of kernel mode.<br>
<p>
All of the above are probably difficult for one reason or another.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964244/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964247"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2024 23:40 UTC (Fri)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/964247/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Run the userspace helper in an entirely disjoint set of namespaces that aren't children of anything running elsewhere? (would this work? I assume PIDs end up being screwy in some way, but you could special case this namespace in the ptrace and signal path and maybe that would be good enough)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964247/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964286"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 2, 2024 23:14 UTC (Sat)
                               by <b>NYKevin</b> (subscriber, #129325)
                              [<a href="/Articles/964286/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
What does the namespace data structure look like? Is there any code path that tries to recursively enumerate the whole set of namespaces (for some particular kind of namespace)?<br>
<p>
I tend to imagine that, at a minimum, there must be some code path that reclaims unreachable namespaces when the last process in them dies...<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964286/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964495"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 5, 2024 23:12 UTC (Tue)
                               by <b>laarmen</b> (subscriber, #63948)
                              [<a href="/Articles/964495/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn't simple refcounting work to reclaim unreachable namespaces?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964495/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor964255"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 2, 2024 2:08 UTC (Sat)
                               by <b>roc</b> (subscriber, #30627)
                              [<a href="/Articles/964255/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Maybe the people who don't trust root should run everything in a container where they're root in the container's user namespace but not the toplevel user namespace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964255/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2024 19:33 UTC (Sun)
                               by <b>eru</b> (subscriber, #2753)
                              [<a href="/Articles/964329/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      Haven't used ptrace (directly), but looking at the manpage, it already comes with a complex set of conditions under which it is allowed, or not. Adding one for "disallowed if the process is a blob" would fit there.


      
          <div class="CommentReplyButton">
            <form action="/Articles/964329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964333"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 3, 2024 21:03 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/964333/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's also /proc/pid/fd that can expose file descriptors.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964333/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor964378"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2024 15:07 UTC (Mon)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/964378/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Wouldn't having the sandbox task isolated from the kernel necessarily mean that information leaks from it are permissible?  I think the fear of allowing ptrace is that it enables attackers to take the now-trusted output of the sandbox task and mess with it, re-opening the attack surface.  It doesn't matter if we leak the exact details of what the user-mode task is doing, if those details are only dependent on what the original process was trying to do; an attacker who can ptrace the sandbox can ptrace the original.  You can't use the sandbox to, say, break KALSR if it's not mapped to the kernel.**<br>
<p>
** This is a blatant lie; we would need to be very careful with what data is passed into the sandbox.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964378/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor964685"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2024 14:49 UTC (Thu)
                               by <b>tesarik</b> (subscriber, #52705)
                              [<a href="/Articles/964685/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That's not the only concern. User-mode environment is very different from kernel mode. Quite importantly, it cannot run “inside” kernel mode, that is if your kernel code wants to delegate something to a user-mode helper, you must create a new task and wait for its completion. A lot can happen there… For example, it creates an opportunity for priority inversion. You'd better not hold any locks while executing a user-mode helper.<br>
<p>
SandBox Mode does not change the task state from runnable. SandBox Mode can finish without a task switch.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964685/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964746"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Interference from user space</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2024 21:30 UTC (Thu)
                               by <b>alkbyby</b> (subscriber, #61687)
                              [<a href="/Articles/964746/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
+1 for sharing as much as possible details on why going with user-space helpers didn't work. Whatever user-space lockdown features people think might be missing, introducing them seems more useful path then adding odd kernel-space trickery. There will always be demand for more lockdowns for user-space.<br>
<p>
It would also be interesting to see any data on cost overheads of weak isolation as explained above, strong isolation and "honest" user-space context switchings.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964746/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor964219"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 1, 2024 18:35 UTC (Fri)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/964219/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This doesn't pass the smell test. Set up a pair of memfds for your ROM/RAM, pass them to a userspace helper running in seccomp mode 1. The tools are already there and they don't have an arbitrary x86-64 constraint besides. Am I missing anything?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964219/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964380"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 4, 2024 15:36 UTC (Mon)
                               by <b>calumapplepie</b> (guest, #143655)
                              [<a href="/Articles/964380/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<span class="QuotedText">&gt; Supporting this use case required making a number of changes to the sandbox mode itself, including a new "fixup" mechanism designed to make it possible to call specific kernel functions from within the sandbox. </span><br>
<p>
This screams "quick and dirty fix".  If C had the obscene metaprogramming power of, say, LISP, then it might make sense to try and write code that can appear in both trusted an untrusted environments, being rewritten to match.  But allowing access to functions written and compiled for the general kernel in a sandbox... kind of defeats the point of the sandbox.  There shouldn't be a "proxy list"; there should be a separate, defined API of functions a sandboxes process can call.<br>
<p>
Code within the sandbox doesn't get to call kmalloc().  It gets to call sandy_malloc, which will do all kinds of fun sanity checks. Now, interestingly, sandy_malloc will start to look a lot like glibc's malloc; one wonders if a sensible implementation of these sandboxes will start to look like a magic process that does work for the kernel.  I suppose that's what the discussion in some of the other parts of this thread is about;  ultimately, I think that trying to have a second implementation of userspace in the kernel is a bad idea.  The one we have is already pretty good.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964380/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor964665"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A sandbox mode for the kernel</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Mar 7, 2024 10:09 UTC (Thu)
                               by <b>tesarik</b> (subscriber, #52705)
                              [<a href="/Articles/964665/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just for the record, I have always been aware of many drawbacks. I wrote this blog post back in December in an attempt to sort out my thoughts. (Some implementation details have been changed since then, e.g. there are no “trampoline interrupt handlers”.)<br>
<p>
<a href="https://sigillatum.tesarici.cz/2023-12-04-sandbox-mode.html">https://sigillatum.tesarici.cz/2023-12-04-sandbox-mode.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/964665/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
