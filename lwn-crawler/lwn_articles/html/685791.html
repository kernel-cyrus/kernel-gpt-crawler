        <!DOCTYPE html>
        <html lang="en">
        <head><title>task_diag and statx() [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/685791/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/685372/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/685791/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>task_diag and statx()</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Please consider subscribing to LWN</b>
<p>
Subscriptions are the lifeblood of LWN.net.  If you appreciate this
content and would like to see more of it, your subscription will
help to ensure that LWN continues to thrive.  Please visit
<a href="/Promo/nst-nag1/subscribe">this page</a> to join up and keep LWN on
the net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 4, 2016</br>
           </div>
The interfaces supported by Linux to provide access to information about
processes and files have literally been around for decades.  One might
think that, by this time, they would have reached a state of relative
perfection.  But things are not so perfect that developers are deterred
from working on alternatives; the motivating factor in the two cases
studied here is the same: reducing the cost of getting information out of
the kernel while increasing the range of information that is available.
<p>
<h4>task_diag</h4>
<p>
There is no system call in Linux that provides information about running
processes; instead, that information can be found in the
<tt>/proc</tt> filesystem.  Each process is represented by a directory
under <tt>/proc</tt>; that directory contains a directory tree of its own
with files providing information on just about every aspect of the
process's existence.  A quick look at the <tt>/proc</tt> hierarchy for a
running <tt>bash</tt> instance reveals 279 files in 40 different
directories.  Whether one wants to know about control-group membership,
resource usage, memory mappings, environment variables, open files,
namespaces, out-of-memory-killer policies, or more, there is a file
somewhere in that tree with the requisite information.
<p>
There are a lot of advantages to <tt>/proc</tt>, starting with the way it
implements the classic Unix "everything is a file" approach.  The
information is readable as plain text, making it accessible from the
command line or shell scripts.  To a great extent, the interface is
self-documenting, though some parts are more obvious than others.  The
contents of the <tt>stat</tt> file, for example, require an outside guide
to be intelligible.
<p>
There are some downsides to this approach too, though.  Accessing a file in
<tt>/proc</tt> requires a minimum of three system calls — <tt>open()</tt>,
<tt>read()</tt>, and <tt>close()</tt> — and that is after the file has been
located in the directory hierarchy.  Getting a range of information can
require reading several files, with the system-call count multiplied
accordingly.  Some <tt>/proc</tt> files are expensive to read, and much of the
resulting data may not be of interest to the reading process.  There has
been, to put it charitably, no unifying vision guiding the design of the
<tt>/proc</tt> hierarchy, so each file there must be approached as a new
parsing problem.  It all adds up to a slow and cumbersome interface for
applications that need significant amounts of information about multiple
processes.
<p>
A possible solution comes in the form of <a href="/Articles/683371/">the
<tt>task_diag</tt> patch set</a> from Andrey Vagin; it adds a 
binary interface allowing the extraction of lots of process information
from the kernel using a single request.  The starting point is a file
called <tt>/proc/task-diag</tt>, which an interested process must open.
That process then uses the netlink protocol to send a message describing
the desired information, which can then be read back from the same file.
<p>
The request for information is contained within this structure:
<p>
<pre>
    struct task_diag_pid {
	__u64   show_flags;
	__u64   dump_strategy;
	__u32   pid;
    };
</pre>
<p>
The <tt>dump_strategy</tt> field tells the kernel which processes are of
interest.  Its value can be one of <tt>TASK_DIAG_DUMP_ONE</tt> (information about
the single process identified by <tt>pid</tt>),
<tt>TASK_DIAG_DUMP_THREAD</tt> (get information about all threads of
<tt>pid</tt>), <tt>TASK_DIAG_DUMP_CHILDREN</tt> (all children of
<tt>pid</tt>), <tt>TASK_DIAG_DUMP_ALL</tt> (all processes in the system) or
<tt>TASK_DIAG_DUMP_ALL_THREADS</tt> (all threads in the system).
<p>
The <tt>show_flags</tt> field, instead, describes which information is to
be returned for each process.  With <tt>TASK_DIAG_SHOW_BASE</tt>, the
"base" information will be returned:
<p>
<pre>
    struct task_diag_base {
	__u32   tgid;
	__u32   pid;
	__u32   ppid;
	__u32   tpid;
	__u32   sid;
	__u32   pgid;
	__u8    state;
	char    comm[TASK_DIAG_COMM_LEN];
    };
</pre>
<p>
Other possible flags include <tt>TASK_DIAG_SHOW_CREDS</tt> to get
credential information,
<tt>TASK_SHOW_VMA</tt> and <tt>TASK_SHOW_VMA_STAT</tt> for information on
memory mappings,
<tt>TASK_DIAG_SHOW_STAT</tt> for resource-usage statistics, and
<tt>TASK_DIAG_SHOW_STATM</tt> for memory-usage statistics.  If this
interface is merged into the mainline, other options will surely follow.
<p>
The patches have been through a few rounds of review.  Presumably something
along these lines will eventually be merged, but it is not clear that the
level of review required to safely add a new major kernel API has
happened.  There is also no man page for this feature yet.
So it would not be surprising if a few more iterations were
required before this one is declared to be ready.
<p>
<a name="statx"></a>
<h4>statx()</h4>
<p>
Information about files in Linux, as with all Unix-like systems, comes via
the <a
href="http://man7.org/linux/man-pages/man2/stat.2.html"><tt>stat()</tt>
system call and its variants</a>.  Developers have chafed 
against its limitations for a long time.  This system call, being enshrined
in the POSIX standard, cannot be extended to return more information.  It
will likely return information that the calling process doesn't need — a
wasted effort that can, for some information and filesystems, be
expensive.  And so on.  For these reasons, an extended <tt>stat()</tt>
system call has been a topic of discussion for many years.
<p>
Back in 2010, David Howells <a href="/Articles/394298/">proposed a
<tt>xstat()</tt> call</a> that addressed a number of these problems, but
that proposal got bogged down in discussion  without being merged.  Six years
later, David is 
back with <a href="/Articles/685519/">a new version of this patch</a>.
Time will tell if he is more successful this time around.
<p>
The new system call is now called <tt>statx()</tt>; the proposed interface
is: 
<p>
<pre>
	int statx(int dfd, const char *filename, unsigned atflag,
		  unsigned mask, struct statx *buffer);
</pre>
<p>
The file of interest is identified by <tt>filename</tt>; that file is
expected to be found in or underneath the directory indicated by the file
descriptor passed in <tt>dfd</tt>.  If <tt>dfd</tt> is <tt>AT_FDCWD</tt>,
the <tt>filename</tt> is interpreted relative to the current working
directory.  If <tt>filename</tt> is null, information about the file
represented by <tt>dfd</tt> is returned instead.
<p>
The <tt>atflag</tt> parameter modifies how the information is collected.
If it is <tt>AT_SYMLINK_NOFOLLOW</tt> and <tt>filename</tt> is a symbolic
link, information is returned about the link itself.  Other <tt>atflag</tt>
values include <tt>AT_NO_AUTOMOUNT</tt> to prevent filesystems from being
automatically mounted by the request, <tt>AT_FORCE_ATTR_SYNC</tt> to force
a network filesystem to update attributes from the server before returning
the information, and <tt>AT_NO_ATTR_SYNC</tt> to avoid updating from the
server, even at the cost of returning approximate information.  That last
option can speed things up considerably when querying information about files
on remote filesystems.
<p>
The <tt>mask</tt> parameter, instead, specifies which information the
caller is looking for.  The current patch set has fifteen options, varying
from <tt>STATX_MODE</tt> (to get the permission bits) to <tt>STATX_GEN</tt>
to get the current inode generation number (on filesystems that have such a
concept).  That mask appears again in the returned structure to indicate
which fields are valid; that structure looks like:
<p>
<pre>
    struct statx {
	__u32	st_mask;	/* What results were written [uncond] */
	__u32	st_information;	/* Information about the file [uncond] */
	__u32	st_blksize;	/* Preferred general I/O size [uncond] */
	__u32	st_nlink;	/* Number of hard links */
	__u32	st_gen;		/* Inode generation number */
	__u32	st_uid;		/* User ID of owner */
	__u32	st_gid;		/* Group ID of owner */
	__u16	st_mode;	/* File mode */
	__u16	__spare0[1];
	__u64	st_ino;		/* Inode number */
	__u64	st_size;	/* File size */
	__u64	st_blocks;	/* Number of 512-byte blocks allocated */
	__u64	st_version;	/* Data version number */
	__s64	st_atime_s;	/* Last access time */
	__s64	st_btime_s;	/* File creation time */
	__s64	st_ctime_s;	/* Last attribute change time */
	__s64	st_mtime_s;	/* Last data modification time */
	__s32	st_atime_ns;	/* Last access time (ns part) */
	__s32	st_btime_ns;	/* File creation time (ns part) */
	__s32	st_ctime_ns;	/* Last attribute change time (ns part) */
	__s32	st_mtime_ns;	/* Last data modification time (ns part) */
	__u32	st_rdev_major;	/* Device ID of special file */
	__u32	st_rdev_minor;
	__u32	st_dev_major;	/* ID of device containing file [uncond] */
	__u32	st_dev_minor;
	__u64	__spare1[16];	/* Spare space for future expansion */
    };
</pre>
</p>
Many of those fields match those found in the classic <tt>struct stat</tt>
or are close to them.  Times have been split into separate second and
nanosecond fields, enabling both high-precision timestamps and year-2038
compliance. The  <tt>__spare1</tt> array at the end is meant to
allow other types of data to be added in the future.  Finally,
<tt>st_information</tt> gives general information about the file, including
whether it's encrypted, whether it's a kernel-generated file, or whether
it's stored on a remote server.
<p>
The only response to this patch set, as of this writing, <a
href="/Articles/685807/">came from Jeff Layton</a>, who suggested "<q>I
think we really ought to resist excessive bikeshedding this time
around</q>".  If the other developers accept that advice, then it's
possible that an enhanced <tt>stat()</tt> interface might just get into the
kernel sometime this year.  Nobody will be able to complain that this
particular change has been rushed.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Filesystems-stat">Filesystems/stat()</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#proc">/proc</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#System_calls">System calls</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/685791/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor686192"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 9:58 UTC (Wed)
                               by <b>kolyshkin</b> (guest, #34342)
                              [<a href="/Articles/686192/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The task-diag interface was born as an answer to complex and slow CRIU code to gather information about the processes on the system (to be checkpointed). But the most obvious use case is to make utilities like ps and top fast again. I bet every seasoned sysadmin saw very slow "ps ax" and/or unresponsive "top". Some testing with ps patched to use the task-diag interface showed 5x to 10x speed improvement over one using traditional /proc/$PID/ forest.<br>
<p>
Will LWN readers be interested in an article describing task-diag in greater details?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686192/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686205"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 10:47 UTC (Wed)
                               by <b>johannbg</b> (guest, #65743)
                              [<a href="/Articles/686205/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"Will LWN readers be interested in an article describing task-diag in greater details?"<br>
<p>
Yeah why not?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686205/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor686340"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 20:26 UTC (Wed)
                               by <b>scottt</b> (guest, #5028)
                              [<a href="/Articles/686340/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Will LWN readers be interested in an article describing task-diag in greater details?</font><br>
<p>
Yes, definitely!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686340/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor686646"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 8, 2016 8:37 UTC (Sun)
                               by <b>richmoore</b> (guest, #53133)
                              [<a href="/Articles/686646/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd definitely be interested.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686646/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor698104"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2016 9:56 UTC (Wed)
                               by <b>xman</b> (guest, #46972)
                              [<a href="/Articles/698104/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Like in other cases, CRIU just highlighted the extant pain. This has been annoying in so many ways. Beyond just simple efficiency, having the potential for parsing errors with such primitive functions of the OS seemed pretty crazy.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/698104/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor686193"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 10:00 UTC (Wed)
                               by <b>kolyshkin</b> (guest, #34342)
                              [<a href="/Articles/686193/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is some more information about task-diag at <a href="https://criu.org/Task-diag">https://criu.org/Task-diag</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686193/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor698105"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 24, 2016 9:57 UTC (Wed)
                               by <b>xman</b> (guest, #46972)
                              [<a href="/Articles/698105/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
More articles on CRIU would be nice.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/698105/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor686214"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 11:53 UTC (Wed)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/686214/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Curious to see the “spare space” at the end. Why doesn't it simply set a size-of-struct member at the start? It's what Win32 has done for years, with great success.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686214/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686221"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 12:52 UTC (Wed)
                               by <b>fishface60</b> (subscriber, #88700)
                              [<a href="/Articles/686221/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      When the suggested new clone syscall (for returning a file descriptor) was discussed, it passed the size of the struct in for extensibility, so new information could be added at the end without requiring padding, by the API later supporting a larger struct. So you call it something like:

<pre>
struct statx buffer;
statx(dfd, filename, 0, STATX_MODE|STATX_GEN, sizeof(buffer), &amp;buffer);
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/686221/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686224"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 13:03 UTC (Wed)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/686224/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yes, that would work equally well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686224/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686331"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 19:20 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/686331/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is already a parameter controlling which fields are accessed (mask), so it shouldn't even be necessary to pass the structure size. If any additional fields are appended in the future they will just be ignored unless the corresponding mask bits are set, so programs using the older, smaller structure (and none of the new mask bits) won't see any difference.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686331/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686334"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 19:27 UTC (Wed)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/686334/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As long as you're not out of mask bits? =)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686334/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686357"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 22:01 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/686357/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You would need more mask bits, but I presume we wouldn't want to add more fields without corresponding mask bits anyway. That just gets back to the stat() API and the overhead of returning data the caller doesn't need.<br>
<p>
If we were getting close to running out of mask bits, the logical thing to do, short of defining a new syscall, would be to add a single MASK_OTHER bit and a corresponding mask2 field in the structure which the caller would set before invoking statx(). (Which raises a question: Why not do the same with the existing mask parameter, which after all is already part of the structure? Is there some advantage to making the mask a parameter?)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686357/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor686368"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 22:43 UTC (Wed)
                               by <b>derobert</b> (subscriber, #89569)
                              [<a href="/Articles/686368/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I believe the idea of the mask bits is so the caller can indicate "I really want this, even if its expensive." If its not expensive, it'll return it regardless—for example, it appears ext4 returns create time regardless of the mask <a href="https://git.kernel.org/cgit/linux/kernel/git/dhowells/linux-fs.git/commit/?h=xstat&amp;id=3ac480d1364814a33b0abae343a190a171bd0e2f">https://git.kernel.org/cgit/linux/kernel/git/dhowells/lin...</a><br>
<p>
So, if future fields work like that to, they may be returned even if not requested. Thus, the struct needs to start big enough.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686368/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686375"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 5, 2016 0:22 UTC (Thu)
                               by <b>jiiksteri</b> (subscriber, #75247)
                              [<a href="/Articles/686375/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I believe the idea of the mask bits is so the caller can indicate "I really want this, even if its expensive." If its not expensive, it'll return it regardless</font><br>
<p>
But that "it'll return it regardless" part is kind of dangerous, right? Because that gives sloppy $userspace_app the opportunity of relying on statx() always returning a valid statx-&gt;foo even when STATX_FOO isn't set in the mask parameter. And obviously because said $userspace_app is sloppy it doesn't check -&gt;mask in the returned struct either.<br>
<p>
I admit the example is a bit contrived, but if this sloppy $userspace_app ever becomes important enough, the kernel will have to yield and just state that this potentially expensive statx-&gt;foo will need to be returned regardless of the mask passed in.<br>
<p>
This would never happen if the interface stated that _only_ the fields set in the mask parameter are ever set in the returned struct, period. And at that point it might just as well use the mask bits in the struct passed in.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686375/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686415"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 5, 2016 11:18 UTC (Thu)
                               by <b>keeperofdakeys</b> (guest, #82635)
                              [<a href="/Articles/686415/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That is a great point, and is related to ensuring unused flag bits are indeed zero <a href="https://lwn.net/Articles/588444/">https://lwn.net/Articles/588444/</a>. The truth is, even if your documentation says one thing, you can't go back on an interface if something uses it - otherwise you'd break userspace.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686415/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor686459"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 5, 2016 15:13 UTC (Thu)
                               by <b>derobert</b> (subscriber, #89569)
                              [<a href="/Articles/686459/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mainly that'd be a risk that an app would break if the underlying filesystem were changed. E.g., it might work on ext4 but not btrfs (I haven't actually checked if they return different things). <br>
<p>
That's certainly a tradeoff in this design. You can't have three-valued (need, want if cheap, never) bit though, and even then someone could pass want if cheap and forget to check the return mask. <br>
<p>
I wouldn't be surprised if concerns like yours have been part of the discussion of previous statx/xstat patches. As the article notes, it's been subject to a lot of design... <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686459/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686615"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 7, 2016 11:08 UTC (Sat)
                               by <b>jiiksteri</b> (subscriber, #75247)
                              [<a href="/Articles/686615/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Mainly that'd be a risk that an app would break if the underlying filesystem were changed. E.g., it might work on ext4 but not btrfs (I haven't actually checked if they return different things). </font><br>
<p>
...or if later developments suddenly made it more expensive for, say, ext4 to return a piece of information it used to return by default because it was easy. I'm not sure they could stop returning it by default at that point.<br>
<p>
So in a way filesystems returning extra information here without being asked to restrict their own freedom of implementation. And of course, as you mention, this could make things difficult for other filesystems that _don't_ return the same information without the flag; I imagine the user whose apps break when changing filesystems would easily blame the (new) filesystem for something like this :)<br>
<p>
<font class="QuotedText">&gt; I wouldn't be surprised if concerns like yours have been part of the discussion of previous statx/xstat patches. </font><br>
<p>
Most likely. These are smart people and I appreciate the work they do. I'm just playing the devil's advocate here.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686615/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor686215"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 12:11 UTC (Wed)
                               by <b>giggls</b> (subscriber, #48434)
                              [<a href="/Articles/686215/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I once learned, that in contrast to other systems like Windows Unix-like Systems have many simple system calls instead of fewer complicated ones.<br>
<p>
So to me implementing something like this looks like combining the bad part of both of these approaches.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686215/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686243"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 15:32 UTC (Wed)
                               by <b>HenrikH</b> (subscriber, #31152)
                              [<a href="/Articles/686243/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And which are those bad parts and why are they bad? Simply stating that something is done way X in Windows does not make it inheritable bad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686243/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor686314"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 17:49 UTC (Wed)
                               by <b>zyga</b> (subscriber, #81533)
                              [<a href="/Articles/686314/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The article clearly states that this is not new data, just data exposed from various places in one system call. The article also states that this makes some operations faster and easier (and I'd add myself, that unless the task at hand is frozen, also atomic). The downside of the existing, fine grained interface is that it is slower.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686314/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor686311"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 17:49 UTC (Wed)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/686311/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Think of it as premature optimization. Windows rushed into adding as many features as possible (which is now a perpetual back-compat burden) while Unix gave people a few RISC-ish syscalls and left them to their own devices.<br>
<p>
With the benefit of half a century or so in hindsight it doesn't seem excessive to say “yes, there's enough people doing this to warrant tuning it”. I for one would love to run htop sorted by CPU time and not have it permanently occupy a row of its own output.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686311/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor686339"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 20:18 UTC (Wed)
                               by <b>shemminger</b> (subscriber, #5739)
                              [<a href="/Articles/686339/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why is this using a system call and not something like generic netlink which is both extensible and message based?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686339/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor686373"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 4, 2016 23:56 UTC (Wed)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/686373/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Indeed, there is already a netlink task interface which provides at least some of these fields<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686373/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor687873"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2016 17:48 UTC (Wed)
                               by <b>avagin</b> (subscriber, #63724)
                              [<a href="/Articles/687873/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you mean taststats. It doesn't handle user and pid namespaces properly. And it works only from the root user namespace.<br>
<p>
We try to use this interface in a second version of task_diag patches:<br>
<a href="https://lkml.org/lkml/2015/7/6/142">https://lkml.org/lkml/2015/7/6/142</a><br>
<p>
There is an opinion that netlink isn't completely suitable for non-network tasks. And Andy Lutomirski suggests to add a new interfaces to fix known issues of netlink:<br>
<a href="https://www.mail-archive.com/netdev@vger.kernel.org/msg109212.html">https://www.mail-archive.com/netdev@vger.kernel.org/msg10...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/687873/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor686576"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 6, 2016 15:13 UTC (Fri)
                               by <b>droundy</b> (subscriber, #4559)
                              [<a href="/Articles/686576/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was wondering the opposite: why is task_diag not implemented as a system call? What are the advantages of using the netlink protocol?<br>
<p>
All I can think of is that it enables flexible returning of arbitrary length data through multiple reads. Is there anything else that provides a compelling advantage for netlink?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/686576/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor687880"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2016 18:05 UTC (Wed)
                               by <b>avagin</b> (subscriber, #63724)
                              [<a href="/Articles/687880/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
netlink allows to extend protocol without breaking backward compatibility. You can add new attributes or append new fields to an existing one. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/687880/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor687871"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">task_diag and statx()</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 18, 2016 17:19 UTC (Wed)
                               by <b>avagin</b> (subscriber, #63724)
                              [<a href="/Articles/687871/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
First versions of task_diag used netlink sockets, but there were some questions about security issues, about handling user and pid namespaces.<br>
Here is a thread with our discussion about using netlink for task_diag: <a href="https://lkml.org/lkml/2015/12/15/520">https://lkml.org/lkml/2015/12/15/520</a>.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/687871/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2016, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
