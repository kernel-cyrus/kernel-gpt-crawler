        <!DOCTYPE html>
        <html lang="en">
        <head><title>Device trees I: Are we having fun yet? [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/572692/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/573226/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/572692/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Device trees I: Are we having fun yet?</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>LWN.net needs you!</b>
<p>
Without subscribers, LWN would simply not exist.  Please consider
       <a href="/Promo/nst-nag2/subscribe">signing up for a subscription</a> and helping
       to keep LWN publishing.
</blockquote>
<div class="GAByline">
           <p>November 12, 2013</p>
           <p>This article was contributed by Neil&nbsp;Brown</p>
           </div>
Given that Linus Torvalds's biography is titled <i>Just for Fun</i> it seems
appropriate that people working on Linux might expect to have some fun
too.  Yet when one hears the device tree concept (herein referred to as
"devicetree") discussed at conferences or 
reads about it on mailing lists, there seems to be more agonizing and
(generally constructive) arguments than enjoyment.
The blessing, or the curse, of devicetree forming a stable ABI, how
backward compatibility is a bane to one and a boon to another, what
exactly it means to describe the hardware but not the behavior, and the
joy that would flow if only we could have discoverable buses, are all
topics which are thrown around with much fervor but not so much
joyfulness (for indeed there are many buses which are not and never
will be discoverable).
<p>
By contrast, my own experience with devicetree has produced a lot of
fun (though it must be admitted that some was akin to the pleasure
received when one stops a repeated cranial impact with a brick wall).  This
is the first in a two-part series on my experience with the devicetree
mechanism.
<p>
The <a href="http://projects.goldelico.com/p/gta04-main/downloads/47/">GTA04</a>, the replacement motherboard for the Openmoko
mobile phone, has struggled along until recently with no help from
devicetree.  As devicetree is apparently the way of the future and a
necessary precondition for full upstream support, that had to change.
The opportunity arose recently to pursue two ends in parallel:
implementing sufficient devicetree support to boot and use the GTA04,
and learning what this devicetree thing was really all about.  Both
have been achieved to a level of approximately 80% (suggesting that
20% of the required time has been spent so far).  This experience was
a lot of fun and, in order to savor that joy a little longer, the
highlights are collected below to form a practical introduction to
devicetree.  Most of the examples are taken from the GTA04, partly
because that is all I really know, but also because it has a variety
of components sufficient to highlight several interesting devicetree
issues.
<h4>It's all about the platform</h4>
<p>
While devicetree started life serving SPARC and PowerPC architectures, its
use with ARM is the current focus of development.  It is
reasonable to ask: amid all this name dropping, where is x86?  What do
the Intel architectures use if they don't use devicetree?
<p>
The early IBM-PC triggered a boom in personal computer sales in part
because it was so easy for other manufacturers to make copies or
"clones".  The specification was open and it went much further than
just the choice of a particular CPU instruction set.  It included known
devices (like a keyboard) with a known controller at an known address
in the I/O address space.  It also included a "BIOS" (basic IO system)
in ROM with well-defined entry points to achieve simple tasks like
reading a block from the floppy disk, or writing a character onto the
monitor.  As long as cloners copied these standard interfaces, they
could build a device that standard software could run on without needing
to know it was running on something new.
<p>
As time progressed this "PC platform" evolved â€” largely driven by
Intel creating hardware standards and Microsoft enforcing them through
market dominance with its software.  The BIOS was repeatedly extended,
giving us a VBIOS (for video-drivers), an SMM BIOS (for system
management) and ACPI, which does lots of different things.
<p>
While the PC platform has changed substantially over the years, there
has always been the one platform with strong market forces to ensure
compatibility.  Operating systems can safely be written to assume the
presence of whatever the platform requires, and to be able to probe
for optional components with a confidence that, for example, probing
for a mouse will not accidentally switch off the main power supply.
<p>
ARM has taken a very different approach to creating a platform, in
that it hasn't bothered.  ARM specifies the instruction set and CPU behavior
(memory model, etc.) and provides VLSI designs (aka "IP blocks") which can be
integrated into hardware, typically as parts of a system on a chip
(SoC).  Details beyond the CPU are largely left up to the individual
manufacturer.  There are no standard components, and no required
BIOS.
<p>
ARM has another challenge which did not affect the early PC platform:
power management is crucially important on many ARM-based devices,
whereas it was largely uninteresting in the PC space.  Part of the
standard for the PC platform is a variety of "discoverable" buses
which provide the bus-master with a mechanism for asking devices
on the bus to identify and describe themselves.  This leads to a very
general solution for handling control and data flow.  It is less clear
that it leads to optimal solutions for power management.  We will see
an example of this below.
<p>
This lack of imposed standards in the ARM world provides for a great deal of
flexibility (and product differentiation) for the hardware engineers
but presents a real challenge for operating system engineers: you
don't know what to expect or where it might be found, and just poking
around is impractical and unlikely to be successful.
<p>
This is where devicetree comes in.  A devicetree essentially
describes a specific device.  There is no BIOS component to the platform
(which is likely a good thing given what kernel engineers seem to think
of BIOS quality) but rather a list of devices or device-details that
cannot be discovered by poking.  This devicetree (encoded as a binary
"dtb" file) can be stored in ROM on the system, or can be loaded from
wherever the kernel is loaded.  The theory is that when a system
(e.g. motherboard) is created, a "dtb" can be created for it, and it
will work with all future software releases. It is a nice theory...
<h4>Getting bored of board files?</h4>
<p>
Support for ARM hardware has been in the kernel a lot longer than
devicetree has been used for it.  The "old" approach (still widely
used where devicetree support isn't complete) is the so-called "board"
file.  This is essentially a description of the platform written in C.
<p>
Each board file ends with a MACHINE description something like:
<pre>
    MACHINE_START(GTA04, "GTA04")
        /* Maintainer: Nikolaus Schaller - http://www.gta04.org */
        .atag_offset    =   0x100,
        .reserve    	=   omap_reserve,
        .map_io    	=   omap3_map_io,
        .init_irq   	=   omap3_init_irq,
        .handle_irq 	=   omap3_intc_handle_irq,
        .init_early 	=   omap3_init_early,
        .init_machine   =   gta04_init,
        .init_late  	=   omap3630_init_late,
        .timer      	=   &amp;omap3_secure_timer,
        .restart    	=   omap_prcm_restart,
    MACHINE_END
</pre>
<p>
which, as you can see, is completely generic for "omap3" devices except
for "<tt>init_machine</tt>".
<p>
<code>gta04_init()</code> contains a fairly ad-hoc collection of initializations,
probably the most interesting being calls to
<code>platform_add_devices()</code> and
<code>omap_register_i2c_bus()</code>.  These provide lists of device identifiers
together with "<tt>platform_data</tt>" data structures which describe many of
the various components on the GTA04 board and how they are connected
together.  (See <a href="/Articles/448499/">this article</a> for
information on the platform device API).
<p>
So a board file identifies the SoC which the board is built around,
identifies all the other components, and has various bits of glue code
to make things work (like initializing GPIO lines).
<p>
A devicetree source file (dts) contains the first two elements (SoC
identification and component configuration) but doesn't have the
ad-hoc glue code.  This is the first source of joy â€” much less clutter
in the platform description as you cannot include code.  This
means, of course, that the generic code must be improved so that
individual platforms don't need their own code and this is the second
source of joy: more complete and coherent design in the generic code.
<p>
To see the difference, my git tree contains a <a
href="http://git.neil.brown.name/?p=gta04.git;a=blob;f=arch/arm/mach-omap2/board-omap3gta04.c;h=3beca85b144fa41cba445321e167f4d8b998a6fc;hb=3.7-gta04">board
file</a> for the GTA04 and a <a
href="http://git.neil.brown.name/?p=gta04.git;a=blob;f=arch/arm/boot/dts/omap3-gta04.dts;h=15e21fe1b40ca54309cd08c12d7d08fdae9d1242;hb=refs/heads/mainline">devicetree</a>
file that does nearly as much. 

<p>
<h4>Let's start with a leaf</h4>
<p>
The following fragment is taken from somewhere several levels deep
into the devicetree for the GTA04.  It doesn't actually appear in
<tt>omap3-gta04.dts</tt> file linked above, but rather in
<a
href="http://git.neil.brown.name/?p=gta04.git;a=blob;f=arch/arm/boot/dts/twl4030.dtsi;h=3f6bf4eba139b1381d5a7019d024b0a680353ce4;hb=refs/heads/mainline"><tt>twl4030.dtsi</tt></a>
which the former file includes.
<p>
<pre>
    charger: bci {
    	compatible = "ti,twl4030-bci";
    	interrupts = &lt;9&gt;, &lt;2&gt;;
    	bci3v1-supply = &lt;&amp;vusb3v1&gt;;
    };
</pre>
<p>
This fragment describes the battery charger ("<tt>bci</tt>" for "battery charger
interface").  This is one component on a multi-function chip which
serves as the PMIC (Power Management IC) â€” the twl4030 from Texas
Instruments.
<p>
The "<tt>charger:</tt>" string is simply a label which allows this node to be
referenced from elsewhere in the tree as we will see shortly.
"<tt>bci</tt>" is the name of this node within its parent.  The full name
in the GTA04 is
actually <tt>/ocp/i2c@48070000/twl@48/bci</tt>.  The choice of names seems to
have little practical effect providing they are unique among
siblings.  There are standards that are best followed, such as the
"@NNN" suffix to give the device's address.  Failing to follow these
standards certainly results in non-compliance but does not seem to
result in non-functionality.
<p>
The "<tt>compatible</tt>" field, rather than the node name, tells you (and
Linux) what this device does.  Every device can list one or more
strings that it is "compatible" with.  Similarly every driver in the
kernel can list one or more strings that it is compatible with (via
the "<tt>driver.of_match_table</tt>" field).  The driver that is bound to a
particular device is the one that appears to be most compatible.  In
many cases both the device and the driver will only have one
"compatible" name, but it is reasonable to assume that over time some
IP blocks will prove particularly successful, will be refined in
backward-compatible ways, and so will benefit from this flexibility.
<p>
The "<tt>interrupts</tt>" field lists two interrupt numbers as the BCI can
generate two different interrupts.  These are interpreted in the
context of the nearest interrupt controller.  As the "<tt>twl@48</tt>" node,
which is the parent of the BCI, declares itself to be an interrupt
controller (by 
having the attribute "<tt>interrupt-controller</tt>" present), these interrupt
numbers (9 and 2) are interrupts within the twl4030 itself (interrupt
management is one of the multiple functions of the chip).
<p>
Since the BCI is an integral part of the twl4030 with these interrupt
lines hardwired in, there seems little point in explicitly
listing the numbers in the devicetree node.  Surely they can simply
be hardcoded in any "<tt>ti,twl4030-bci</tt>" compatible driver.

The reason they are explicit is that, in principle at least, the BCI
IP block in the twl4030 might be reused in some other
packaging when TI makes some new PMIC, and in that case the interrupts
might be wired differently, but the same driver should be able to be
used.  So it is good forward-planning to keep their definition
separate.
<p>
Given this, it is somewhat surprising that the bci node (like all the
other nodes in the "twl" parent) does not have a "<tt>reg</tt>" property.

This property identifies the address at which the device can be found, in
whatever address space the current node in the tree resides.
For example the parent "<tt>twl@48</tt>" node contains:
<pre>
    reg = &lt;0x48&gt;;
</pre>
<p>
meaning that the whole twl4030 multi-function device can be found at
address 0x48 in the I2C bus that it is on.

The twl4030 has a number of registers (accessed over the I2C bus) which
are grouped into modules.  The "<tt>MAIN_CHARGE</tt>" module is at address 0x74
and has 54 bytes of register space.  So:
<pre>
    reg = &lt;0x74 0x36&gt;
</pre>
<p>
in the <tt>bci</tt> node
might seem appropriate (when given, the second number is the size of
the register set).  Unfortunately the BCI driver needs to
access registers for other modules, such as <tt>PM_MASTER</tt>,
<tt>PM_RECEIVER</tt>, 
and <tt>INTERRUPTS</tt>.  This could be achieved with something like:
<p>
<pre>
    reg = &lt;0x74 0x36&gt; &lt;0xB9 0x0E&gt; &lt;0x14 0x08&gt; &lt;0x00 0x14&gt;
</pre>
<p>
But those values, instead, are hardcoded in the driver.
It's possible that the general solution just seemed to be more trouble than it is
worth.  While it is nice to imagine that each individual IP block can
be treated as an individual device, independent from everything else,
this is often not the case.
<p>
The final point of interest in this node is the attributes that
<i>aren't</i> there. 
<p>
Part of the role of the battery charger is to charge the backup
battery (which, for example, keeps the real-time clock ticking when
the main battery is removed).  The parameters for charging the main
battery can vary due to policy and circumstance so it is important
that they are configured at run time, probably though a "sysfs"
interface.  However the parameters for charging the backup battery
(which are a target voltage and a maximum current) depend primarily on
the electrical characteristics of the battery (or super-capacitor)
which is installed.  So they are really part of the platform
description.
<p>
Being part of the GTA04 platform, they should live in the
"<tt>omap3-gta04.dts</tt>" devicetree file. However the above
"<tt>bci</tt>" node lives 
in the "<tt>twl4030.dtsi</tt>" include file.  So different fields for the one
node might need to live in different files.  This is where the
"<tt>charger:</tt>" label comes in.
<p>
In the GTA04 file (<tt>omap3-gta04.dts</tt>) we have:
<p>
<pre>
    &amp;charger {
    	ti,bb-uvolt = &lt;3200000&gt;;
    	ti,bb-uamp = &lt;150&gt;;
    };
</pre>
<p>
The "<tt>&amp;charger</tt>" expands to the full name of the node with the label
"<tt>charger</tt>", and this simply adds some attributes to that node.  It can
equally well replace attributes, so common defaults can be placed in
an include file, and divergent values can be given in the main file.

This ability to present the nodes in the tree in other than the
obvious depth-first order is very valuable and quite widely used.  I
needed to follow several such indirections to piece together the full
path of "<tt>/ocp/i2c@48070000/twl@48/bci</tt>".
<p>
It could be argued that specifying the charging parameters for the
backup battery is specifying behavior (of the charger) rather than
describing hardware.  This is seen by some as contrary to the purpose
of devicetree.

This could be addressed by a simple sleight-of-hand. We simply create
a new devicetree node that represents the battery.
<p>
<pre>
    &amp;backup-battery {
    	ti,target-uvolts = &lt;3200000&gt;;
    	ti,max-uamps = &lt;150&gt;;
    };
</pre>
<p>
These are now physical properties of the battery: the voltage it
produces when fully charged and the maximum charge current that it can
comfortably accept.  The driver could then inspect the properties
of the battery (if one is present) and configure the charger
accordingly.
<p>
This does raise a question of where in the devicetree the "backup
battery" should be attached.  It is conceptually connected to both the
battery charger and the real time clock.  As "devicetree" is in the
form of a tree, the battery can only have one parent - which device
node should that be?  Hierarchical trees can be extremely powerful,
but they don't always map cleanly to the real world.
<h4>From nodes to a tree</h4>
<p>
As we have already hinted at, devicetree nodes can contain child
nodes as well as attributes.  For example the "<tt>twl@48</tt>" node contains
the "<tt>bci</tt>" node, as well as a real time clock, some power regulators,
some GPIO pins, a watchdog timer, and more.

The case where this is most obviously necessary is when the platform
contains some devices on a bus that doesn't support discovery such as
the I2C bus.
<p>
The OMAP3 contains three I2C buses.  The GTA04 places
just the twl4030 on one, leaves one unused, and includes quite a
collection of sensors as well as the touchscreen and LED
controllers on the third.  There is no way that Linux could know anything
about these unless they were described in a board file (passed to
<code>omap_register_i2c_bus</code>), or in a devicetree.
<p>
Less obvious is the need for child nodes of the "twl@48" node.  Certainly
the driver for the twl4030 would know what component devices it
contains.  So the issue of having discoverable buses doesn't really
apply here.

There are at least two reasons that the member devices of the twl4030
need to be explicitly listed.  One is that it allows platform-specific
configuration to be added, as with the "<code>ti,bb-uvolt</code>" and "<code>ti,bb-uamp</code>"
attributes for the battery charger (though if they were in a separate
"battery" node, that would be less important).
<p>
The other is that other devices might need to make reference to the
individual components.  As mentioned the twl4030 contains
some regulators and some GPIO pins.  While the GTA04 doesn't use any
of the GPIOs it does use the regulators.  For example the WiFi chip is
powered by "<tt>VAUX4</tt>" from the twl4030.  The "MMC" driver which
communicates with the WiFi chip needs to know about this so it can
power up the WiFi interface to talk to it, then power it down while it isn't in
use.  This interconnection is specific to this particular platform and
so needs to be explicit in the devicetree file.  For that to be
possible, each of the power regulators in the twl4030 must be
listed as a child node.

Given these obvious needs for many things to be listed, it makes a
certain amount of sense to list everything.
<p>
One interesting twist in the GTA04 involves the module used for
communicating with the GSM telephone network â€” the Option GTM601.
This is primarily a USB device that is permanently connected to one of
the USB ports on the OMAP3.  As USB is considered to be a discoverable
bus, there is no mechanism in devicetree to list the devices attached to
a USB bus.

However the GTM601 doesn't <em>only</em> use USB.  It also has a DAI port
(Digital Audio Interface)
for bi-directional audio (which is connected to one of the McBSP audio
ports on the OMAP3), and a "wake-up" line which is pulsed on an
incoming phone call or text message.
<p>
While these three connections all relate to the one device, there is
no way to describe this hardware in devicetree as a single unit.
Rather the input "wake-up" signal and the audio channel are specified
as separate devices, the USB interface is left to be discovered, and
the relationship between the three is left for some application to
just "know" about.
<p>
Both the audio data and the wake-up signal could be sent over the USB
connection which would make it much easier for the operating system to
treat it as a single device.  However, as this approach would result in
significantly higher energy usage, it is not used.

Having a separate "wake-up" signal connected to an "always-on" GPIO bank
on the OMAP3 allows the whole USB path to be completely powered off
when idle.  Having a separate DAI allows it to be connected directly
to the audio codec/amplifier (in the magic twl4030 chip) so that the
CPU is not involved in audio routing and can enter deep sleep during a
phone call.
<p>
The second installment in this series will focus on some of the
difficulties involved with the device tree abstraction and whether it will
ever truly be possible to support system-independent kernel images on
non-discoverable platforms.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Device_tree">Device tree</a></td></tr>
            <tr><td><a href="/Archives/GuestIndex/">GuestArticles</a></td><td><a href="/Archives/GuestIndex/#Brown_Neil">Brown, Neil</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/572692/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor573593"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 12, 2013 23:09 UTC (Tue)
                               by <b>mwsealey</b> (guest, #71282)
                              [<a href="/Articles/573593/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is a way to define USB devices on a USB bus in device trees, just as there are bindings to present PCI devices on a PCI bus which is intended to be "discovered" by the OS.<br>
<p>
There definitely should be a little standardization around it - imagine a platform where USB ports are present but also parts are soldered to the PCB. They will *always* appear at the same places in the USB topology.<br>
<p>
PCI device "compatible" properties are usually derived from the device and vendor ids (and sub ids) in the configuration space. USB has much the same thing. If you ever enabled dynamic network device naming on a modern Linux kernel, it is much the same gobbledegook string - v8081d1504u8181s8171.<br>
<p>
If it is fixed to the board, then it should be fixed in the tree. And sometimes, hubs and other USB devices need configuring to tell them they're fixed to a board and their ports are not hot-pluggable.<br>
<p>
For a dynamic firmware implementation that can generate a device-tree on the fly (more relevant on PowerPC than ARM, but there is no reason it cannot happen on ARM), it is still expected that it would fill in /chosen properly in the final device tree for things like it's boot device. In this case, a USB device has to be present in the tree to be referenced by phandle.<br>
<p>
For WiFi and suchlike, it is acceptable that a 'pretend' rfkill node might be created to control the devices and follow the Linux subsystem, but this would go against the OS-neutrality of device trees. In this case, the solution is simple. If it is soldered down or shipped as a fixed option in a consumer device (such as in a Netbook, under a door you may remove but wouldn't want to remove the warranty sticker to do so) then it should be listed.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573593/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor573618"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2013 6:03 UTC (Wed)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/573618/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There certainly will be more standardization in the ARM platform going forward, in particular in the server space. You saw the public announcement that ACPI is now part of the UEFI forum. I would be surprised if that were the last such announcement over the coming months.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573618/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573619"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2013 6:26 UTC (Wed)
                               by <b>olof</b> (subscriber, #11729)
                              [<a href="/Articles/573619/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ACPI and UEFI doesn't magically solve the ARM server problems, and it's troubling that people just walk around that topic thinking it will. They just give you yet another mechanism to communicate the mess that the vendors create.<br>
<p>
The x86 space has been more organized because Microsoft forced people to comply with the standard specs (and a product wouldn't ship, plain and simple, if it didn't boot an unmodified Windows install). That's not true for these ARM servers since Linux will be the primary target for many of them -- the same strict requirements aren't there.<br>
<p>
On the other hand, maybe, just maybe we can avoid the mess of SMM. It's definitely a mixed blessing to have (or require) that level of under-the-covers workaround for compliance, since we all know just how messy and buggy firmware can be. On the other hand, it avoids the same mess to crawl into the kernel.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573619/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573621"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2013 6:57 UTC (Wed)
                               by <b>jcm</b> (subscriber, #18262)
                              [<a href="/Articles/573621/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Olof, I agree that ACPI doesn't magically solve the problems. But what I mean is, I expect to see such platform standardization in the ARM server space. I would be /very/ surprised if there aren't movements in that regard. As far as SMM, sadly I raised this 3 years ago that I thought vendors would abuse TrustZone (and in particular create their own apps running on the TEE) to emulate SMM on AArch64, and that's roughly what I see happening. I've made recommendations to mitigate the impact, which I see being lesser because: a). You don't stop all CPUs in the system. b). Most of this crap can be handled by management cores in the designs that I have reviewed so far.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573621/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573625"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2013 7:39 UTC (Wed)
                               by <b>olof</b> (subscriber, #11729)
                              [<a href="/Articles/573625/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Oh, I have hope that the vendors that have had enough planning to involve you in their designs will come out with something fairly sane, even though some of the recent patch sets can introduce a good amount of doubt.<br>
<p>
My greater concern is the second-tier vendors, or the mass-market vendors that will do the bare minimum (and not quite know what they're doing, or at least not seeing the bigger picture), etc. It'll take quite a bit of education of them to sort things out right, and it only takes a few of them going to market anyway to make the kernel side of thing very interesting and possibly messy. It'll be interesting to see how it plays out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573625/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor573762"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 9:23 UTC (Thu)
                               by <b>deepfire</b> (guest, #26138)
                              [<a href="/Articles/573762/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; The x86 space has been more organized because Microsoft forced people to</font><br>
<font class="QuotedText">&gt; comply with the standard specs (and a product wouldn't ship, plain and</font><br>
<font class="QuotedText">&gt; simple, if it didn't boot an unmodified Windows install).</font><br>
<p>
I find "boot an unmodified Windows install" being a rather weak substitute for standards compliance.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573762/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573794"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 14:24 UTC (Thu)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/573794/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well it isn't just being able to boot, MS has pushed for several device standards such as for webcams so they didn't have to deal with buggy crashy vendor drivers making them look bad.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573794/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor575046"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 26, 2013 17:18 UTC (Tue)
                               by <b>nye</b> (subscriber, #51576)
                              [<a href="/Articles/575046/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
On a related note, anyone know why there's no such thing as a standardised ethernet class driver?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/575046/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor573949"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2013 17:52 UTC (Fri)
                               by <b>drag</b> (guest, #31333)
                              [<a href="/Articles/573949/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I find "boot an unmodified Windows install" being a rather weak substitute for standards compliance.</font><br>
<p>
<p>
Yet it's the most effective standards compliance mechanism that has ever existed as far as hardware goes.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573949/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor573646"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2013 13:33 UTC (Wed)
                               by <b>arnd</b> (subscriber, #8866)
                              [<a href="/Articles/573646/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A lot of the arm64 "server" components that people are talking about are not really PC-style servers as we know them from x86 but rather system-on-chip designs more akin to today's embedded 32-bit products. There is no real infrastructure in the kernel to deal with these using ACPI, nor is that likely to get added any time soon. <br>
<p>
<p>
There is a real danger of people trying to use ACPI on these systems anyway (as shown by some patches posted for X-Gene), which implies that they come up with random out-of-tree and out-of-spec hacks that they cannot rectify before shipping products to end-users. Unlike for dtb files (which can be shipped alongside a kernel), there is not really a backwards-compatible way to replace an ACPI BIOS, so a system like that is either stuck with a custom kernel (i.e. the thing we're all trying to avoid here) or with an ugly per-product workaround  (i.e. a board file) in the kernel.<br>
<p>
We found out the hard way with DT that it's not really possible to have a stable ABI while simultaneously trying to figure out how to describe things in the first place. ACPI on ARM today is in a worse position than DT on ARM was three years ago when we could sufficiently describe all PowerPC SoCs, and there is no way for ACPI to not be an ABI.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573646/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor573637"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 13, 2013 10:23 UTC (Wed)
                               by <b>fidelleon</b> (subscriber, #91950)
                              [<a href="/Articles/573637/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
MANY thanks for this article, after looking at a lot of places I wasn't able to find a *right* description of what a devicetree is (yep, I was unaware of their meaning).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573637/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor573798"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 14:43 UTC (Thu)
                               by <b>rwmj</b> (subscriber, #5474)
                              [<a href="/Articles/573798/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I'd love someone to explain why it is in practice that I see *.dtb files shipped with the kernel, rather than with the hardware or bootloader.  AIUI device tree describes the hardware to the kernel, and so it's something you should get with the hardware (or perhaps with uboot).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573798/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573838"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 20:16 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/573838/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Because there's no fixed device tree ABI, and if you ship a DTB in flash there's no guarantee that you'll be able to boot newer kernels. It's actually worse than that, in that vendor kernels and mainline are often ABI-incompatible when it comes to Device Tree, so if a board vendor ships with the SoC vendor kernel you wouldn't be able to boot a mainline kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573838/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573847"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 21:24 UTC (Thu)
                               by <b>scottwood</b> (guest, #74349)
                              [<a href="/Articles/573847/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not having a fixed device tree ABI breaks use cases such as a boot loader fixing up portions based on run time information, or a hypervisor using it to tell the guest OS what devices the VM has been configured with, or sharing the tree with other OSes (we do all of these on Freescale PPC, and on some ARM boards the device tree is shared with U-Boot -- not just to pass to the kernel, but for U-Boot to learn about the hardware).  A fixed ABI is how it works with actual Open Firmware, and is how ACPI works, etc.  Likewise with PCI -- it works because there's a standard, that isn't subject to revision as part of Linux patch acceptance.<br>
<p>
Granted, it's harder to standardize things well when the hardware being described is changing so rapidly, but by treating the device tree as a Linux implementation detail rather than an ABI, you take away the incentive to get it (reasonably close to) right the first time.  You could still have a separate Linux-internal tree (we already do -- struct device and friends) that encodes Linux concepts and/or fixes quirks in the hardware tree, which is generated from the hardware tree plus quirk code in the kernel, and possibly some supplementary external data file which *is* a Linux implementation detail and not meant for sharing with other components.  In extreme cases the "quirk and supplementary external data" could be an entire replacement tree, if the standard one is hopeless for anything other than identifying which replacement tree to use, but most cases should not be that bad.<br>
<p>
Moving the hardware tree outside the kernel source would send a clear message that it is not a Linux implementation detail (and thus compatibility between the trees and OSes including but not limited to Linux needs to be considered), and that things which are need to go somewhere else.<br>
<p>
Also note that the dts sometimes contains implementation details of the bootloader -- it may make assumptions about how the loader sets up the address map, or it may make assumptions about what things the loader will fill in before passing the tree to the kernel.  Both of these are true on Freescale PPC.  In those cases ideally the trees would be stored in the bootloader tree.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573847/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor573862"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 22:14 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/573862/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; if a board vendor ships with the SoC vendor kernel you wouldn't be able to boot a mainline kernel.</font><br>
<p>
Sounds like a job for GPL enforcement ;) .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573862/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573874"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 22:48 UTC (Thu)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/573874/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Why? GPL doesn't require that you be able to boot the mainline kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573874/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573875"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 14, 2013 22:52 UTC (Thu)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/573875/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
No, but it can get you the source that you would need to use a custom kernel.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573875/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor573878"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Device trees I: Are we having fun yet?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Nov 15, 2013 0:06 UTC (Fri)
                               by <b>mjg59</b> (subscriber, #23239)
                              [<a href="/Articles/573878/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Getting the vendor tree typically isn't a problem. Finding a vendor tree that's up to date with security fixes, on the other hand... <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/573878/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
