        <!DOCTYPE html>
        <html lang="en">
        <head><title>The return of nftables [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/564095/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/563667/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/564095/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The return of nftables</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ready to give LWN a try?</b>
<p>
With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features.  We are pleased to offer you <b><a href="https://lwn.net/Promo/nst-trial/claim">a free trial subscription</a></b>, no credit card required, so that you can see for yourself.  Please, join us!
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>August 20, 2013</br>
           </div>
Some ideas take longer than others to find their way into the mainline
kernel.  The network firewalling mechanism known as "nftables" would
be a case in point.  Much of this work was done in 2009; despite showing
a lot of promise at the time, the work languished for years afterward.
But, now, there would appear to be a critical mass of developers working on
nftables, and we may well see it merged in the relatively near future.
<p>
A firewall works by testing a packet against a chain of one or more rules.
Any of those rules may decide that the packet is to be accepted or
rejected, or it may defer judgment for subsequent rules.  Rules may include
tests that take
forms like "which TCP port is this packet destined for?", "is the source IP
address on a trusted network?", or "is this packet associated with a known,
open connection?", for example.  Since the tests applied to packets are
expressed in networking terms (ports, IP addresses, etc.), the code that
implements the firewall subsystem ("netfilter") has traditionally contained
a great deal of protocol awareness.  In fact, this awareness is built so
deeply into the code that it has had to be replicated four times — for
IPv4, IPv6, ARP, and Ethernet bridging — because the firewall engines are
too protocol-specific to be used in a generic manner.
<p>
That duplication of code is one of a number of shortcomings in netfilter
that have long driven a desire for a replacement.  In 2009, it appeared that
such a replacement was in the works when Patrick McHardy announced his <a
href="/Articles/324989/">nftables</a> project.  Nftables replaces the
multiple netfilter implementations with a single packet filtering engine
built on an in-kernel virtual machine, unifying firewalling at the expense
of putting (another) bytecode interpreter into the kernel.  At the time,
the reaction to the idea was mostly positive, but work stalled on nftables
just the same.  Patrick committed some changes in July 2010; after that, he
made no more commits for more than two years.
<p>
Frustrations with the current firewalling code did not just go away,
though.  Over time, it also became clear that a general-purpose in-kernel
packet classification engine could find uses beyond firewalls; packet
scheduling is another fairly obvious possibility.  So, in October 2012,
current netfilter maintainer Pablo Neira Ayuso <a
href="/Articles/531876/">announced</a> that he was resurrecting Patrick's
nftables patches with an eye toward relatively quick merging into the
mainline.  Since then, development of the code has accelerated, with
nftables discussion now generating much of the traffic on the netfilter
mailing list.
<p>
Nftables as it exists today is still built on the core principles designed
by Patrick.  It adds a simple virtual machine to the kernel that is able to
execute bytecode to inspect a network packet and make decisions on how that
packet should be handled.  The operations implemented
by this machine are intentionally basic: it can get data from the packet
itself, look at the associated metadata (which interface the packet arrived
at, for example), and manage connection tracking data.  Arithmetic,
bitwise, and comparison operators can be used to  make decisions based on
that data. 
The virtual machine is capable of manipulating sets of data (typically IP
addresses), allowing multiple comparison operations to be replaced with a
single set lookup.  There is also a "map" type that can be used to store
packet decisions directly under a key of interest — again, usually an IP
address.  So, for example, a whitelist map could hold a set of known IP
addresses, associating an "accept" verdict with each.
<p>
Replacing the current, well-tuned firewalling code with a dumb virtual
machine may seem like a step backward.  As it happens, there are signs that
the virtual machine may be faster than the code it replaces, but there are
a number of other advantages independent of performance.  At the top of the
list is removing all of the protocol awareness from the decision engine,
allowing a single implementation to serve everywhere a packet inspection
engine is required.  The protocol awareness and associated intelligence
can, instead, be pushed out to user space.
<p>
Nftables also offers an improved user-space API that allows the atomic
replacement of one or more rules with a single netlink transaction.  That
will speed up firewall changes for sites with large rulesets; it can also
help to avoid race conditions while the rule change is being executed.
<p>
The code worked reasonably well in 2009, though there were a lot of loose
ends to tie down.  At the top of Pablo's list of needed improvements to
nftables when he picked up the project was a bulletproof compatibility
layer for existing netfilter-based 
firewalls.  A new rule compiler will take existing firewall rules and
compile them for the nftables virtual machine, allowing current firewall
setups to migrate with no changes needed.  This compatibility code should
allow nftables to replace the current netfilter tables relatively quickly.
Even so, chances are that both mechanisms will have to coexist in the
kernel for years.  One of the other design goals behind nftables — use of
the existing netfilter hook points, connection-tracking infrastructure, and
more — will make that coexistence relatively easy.
<p>
Since the work on nftables restarted, the repository has seen over 70
commits from a half-dozen developers; there has also been a lot of work
going into the user-space <tt>nft</tt> tool and <tt>libnftables</tt>
library.  The kernel changes have added missing features (the ability to
restore saved counter values, for example), compatibility hooks allowing
existing netfilter <a
href="http://ipset.netfilter.org/iptables-extensions.man.html">extensions</a>
to be used until their nftables replacements
are ready, many improvements to the rule update mechanism, IPv6 NAT
support, packet tracing support, ARP filtering support, and more.  The
project appears to have picked up some momentum; it seems unlikely to fall
into another multi-year period without activity before being merged.
<p>
As to when that merge will happen...it is still too early to say.  The
developers are closing in on their set of desired features, but the code has
not yet been exposed to wide review beyond the netfilter list.  All that
can be said with certainty is that it appears to be getting closer and to
have the development resources needed to finish the job.
<p>
See <a href="http://netfilter.org/projects/nftables/">the nftables web
page</a> for more information.  A <a
href="https://home.regit.org/netfilter-en/nftables-quick-howto/">terse but
useful HOWTO document</a> has been posted by Eric Leblond; it is probably
required reading for anybody wanting to play with this code, but a quick,
casual 
read will also answer a number of questions about what firewalling will look
like in the nftables era.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Networking-Packet_filtering">Networking/Packet filtering</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Nftables">Nftables</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/564095/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor564171"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 5:48 UTC (Wed)
                               by <b>kugel</b> (subscriber, #70540)
                              [<a href="/Articles/564171/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Interesting, however i thought the kernel already has a virtual machine for packet inspection: the Berkeley packet filter (bpf)?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564171/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564228"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 15:55 UTC (Wed)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/564228/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A cursory look through the article and the website suggests that there are, for example, extra data structures, like a hashtable (?) for IPv4 lookups etc. Such things don't exist in BPF.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564228/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564295"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 22:01 UTC (Wed)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/564295/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess the question, then, is why not add this stuff to bpf?  In the best case, it would be that bpf proved not to be a good enough foundation. The way these things go, it could as well be that improving bpf was less exciting than replacing it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564295/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564302"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 23:50 UTC (Wed)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/564302/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The original author was well aware of BPF, and used it as the model. But clearly he thought it preferable to start writing code from scratch, and the project has already surpassed BPF in functionality. Plus, he who writes the code gets the say-so. (Also, the BPF virtual machine is actually quit tiny, and the line between re-writing it and copy+pasting it is rather thin.)<br>
<p>
So, it's kind of a moot point. It would be one thing if the project stalled before surpassing BPF in functionality. Then we could all jeer "I told you so". But this doesn't seem to be one of those occasions. nftables seemed to stall simply because too many people are comfortable with iptables, and are heavily invested in the arcane common-line syntax. And those who aren't can shift to using PF on OpenBSD or FreeBSD. Plus NetBSD has NPF, now, which is pretty cool.<br>
<p>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564302/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564438"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 16:57 UTC (Thu)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/564438/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; Also, the BPF virtual machine is actually quit tiny, and the line between re-writing it and copy+pasting it is rather thin</font><br>
<p>
One of the advantages of BPF is that Linux already has a working BPF JIT compiler for many architectures (x86, ARM, SPARC, POWER and S/390). This is a non-trivial amount of code.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564438/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564462"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 18:25 UTC (Thu)
                               by <b>raven667</b> (subscriber, #5198)
                              [<a href="/Articles/564462/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Could this work the other way around, consolidating on nftables as the backend for BPF processing in the kernel rather than maintaining two similar systems.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564462/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor564181"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 9:08 UTC (Wed)
                               by <b>rvfh</b> (guest, #31018)
                              [<a href="/Articles/564181/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A conversion tool from iptables would be handy too, and as the nftables compiler can take iptables rules, maybe it could take that result and un-compile it into nftables rules?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564181/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564329"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 8:07 UTC (Thu)
                               by <b>tobur</b> (guest, #89244)
                              [<a href="/Articles/564329/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is already a project for this.<br>
Check this out: <a href="https://git.netfilter.org/iptables-nftables/">https://git.netfilter.org/iptables-nftables/</a><br>
<p>
The idea is of course not to mess up too much with users habits, this makes using nftables totally transparent for those who will want to keep using iptables. And I bet most will do for a while.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564329/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor564183"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 9:48 UTC (Wed)
                               by <b>patrick_g</b> (subscriber, #44470)
                              [<a href="/Articles/564183/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      What about <a href="https://lwn.net/Articles/531752/">Xtables2</a> ?
      
          <div class="CommentReplyButton">
            <form action="/Articles/564183/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564280"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 20:26 UTC (Wed)
                               by <b>jengelh</b> (subscriber, #33263)
                              [<a href="/Articles/564280/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The project is practically abandoned.<br>
<p>
At first nftables chugged along (it was presented on the workshop as early as 2008, corbet!) until I pushed for early merging of a nextgen packetfilter (which happened to be xt2 code, but that is not the point), in the style of btrfs. But the powers that be wanted rather complete implementations instead. Doable, tho...<br>
<p>
With NFWS 2013, everybody (especially new contributors) sided with nftables by way of submitting many patches there. xt2 got no support and has been rendered incompetetive too, with nft taking up and reimplementing ideas I had for xt2. That situation is very discouraging.<br>
<p>
I temporarily work on more rewarding projects.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564280/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor564201"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 14:03 UTC (Wed)
                               by <b>dambacher</b> (subscriber, #1710)
                              [<a href="/Articles/564201/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I am only aware of the acpi bytecode interpreter, <br>
Then there was (is?) a java bytecode module somewhere<br>
<p>
Wich ones am I missing?<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564201/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564226"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 15:51 UTC (Wed)
                               by <b>johill</b> (subscriber, #25196)
                              [<a href="/Articles/564226/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There's BPF, as somebody else has commented on, and even though it's also related to packets I doubt it's similar - BPF is likely much simpler.<br>
<p>
There's also an ASN.1 decoder, though I'm not really sure what that really is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564226/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564276"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 18:35 UTC (Wed)
                               by <b>aliguori</b> (subscriber, #30636)
                              [<a href="/Articles/564276/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ASN.1 is an RPC description language.  There are multiple encoding rules for encoding an ASN.1 grammar such as BER, CER, and DER.<br>
<p>
Many protocols use ASN.1 such as CIFS, X509, etc.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564276/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564303"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 0:21 UTC (Thu)
                               by <b>wahern</b> (subscriber, #37304)
                              [<a href="/Articles/564303/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It's the original Protocol Buffers, which Google decided to reinvent for some ridiculous reason. ASN.1 is also used for signaling on 3GP and LTE cellular networks, for LDAP, and for a host of other things:<br>
<p>
<a href="http://www.itu.int/ITU-T/asn1/uses/">http://www.itu.int/ITU-T/asn1/uses/</a><br>
<p>
It's a darned shame that ASN.1 support isn't more widespread in the FOSS world. Even Perl modules are crappy. OpenSSL has a fairly complete library, but it's a gigantic PITA to use, like most FOSS ASN.1 tools. Really, ASN.1 was meant to be automatically compiled from the message description to code, with your application code manipulating a real data structure. This is the best open source ASN.1 project I'm aware of:<br>
<p>
<a href="http://lionet.info/asn1c/compiler.html">http://lionet.info/asn1c/compiler.html</a><br>
<p>
It supports streaming parsing and composition without being tied to any I/O model. The only downside is that strings and arrays are always dynamically allocated, which makes constructing and destroying messages fairly verbose, especially if you care about malloc failure. Some proprietary ASN.1 compilers support fixed length arrays which make life a little easier when you're dealing with several simple string fields or lists with a small, finite limit on their length. That makes it easier to use message caches with simpler initialization.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564303/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564312"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 3:51 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/564312/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ASN.1 is too complicated, nobody knows how to use it. <br>
<p>
BTW, if something was initially designed by telecom guys then it is a great reason to avoid it like a plague.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564312/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564335"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 8:52 UTC (Thu)
                               by <b>gdt</b> (subscriber, #6284)
                              [<a href="/Articles/564335/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
ASN.1 is a complex encoding designed for an era of 48Kbps links. Because of the small bandwidths of that era it codes to very few bits. But in these days of 10Gbps links it asks too much of the CPU. ASN.1's complexity also lead to a history of implementation errors, and thus vulnerabilities.<br>
<p>
Your "telecom guys" comment serves no purpose. It references an issue of twenty years ago. These days at IETF meetings you're just as likely to see a "telecom guy" arguing against some hacked-together draft and asking that time be taken to do it better, with the IP equipment vendors opposing that for reasons of "time to market".<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564335/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564336"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 9:17 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/564336/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
actually, as I see it, cpu power is increasing faster than line rate, so while it may not make sense to trade CPU for tight encoding in all cases, I can sure see it being a worthwhile trade in many cases.<br>
<p>
This is like the claims that transparent disk compression was made obsolete by faster disks (including, but not limited to SSDs). In some cases this is true and the system does have better things to spend it's processor time on, but in other cases, the system has more processing power than it needs while waiting for the I/O, so spending even a substantial amount of processing power to cut down on the amount of I/O needed can be a substantial win.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564336/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564344"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 10:25 UTC (Thu)
                               by <b>khim</b> (subscriber, #9252)
                              [<a href="/Articles/564344/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Single-core CPU power basically flatlined: nine years ago top-of the line CPU was <a href="http://ark.intel.com/products/27475/">Pentium 4 570J</a> @ 3.8GHz while today it's <a href="http://ark.intel.com/products/75123">Core i7 4770K</a> @ 3.9GHz. Micro-architectural improvements mean that today's Core i7 is faster then identically-clocked Pentium 4 from last decade, but difference is not striking.</p>

<p>Meanwhile ethernet went from <a href="http://en.wikipedia.org/wiki/10_Gigabit_Ethernet">10GbE</a> to <a href="http://en.wikipedia.org/wiki/100_Gigabit_Ethernet">100GbE</a>, USB went from <a href="http://en.wikipedia.org/wiki/USB#USB_2.0_.28High_Speed.29">480Mbit/s</a> to <a href="http://en.wikipedia.org/wiki/USB#USB_3.1_.28SuperSpeed_10_Gbps.29">10GBit/s</a>, even  PCIExpress went from <a href="http://en.wikipedia.org/wiki/PCI_Express#PCI_Express_1.0a">250MB/s</a> to <a href="http://en.wikipedia.org/wiki/PCI_Express#PCI_Express_3.0">985MB/s</a>!</p>

<p>Sure, if you'll include number of cores in your analysis you'll find out that CPU copes more-of-less fine - but then latency is often limiting factor in communication protocols and SMP is not a big help there.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/564344/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564348"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 12:57 UTC (Thu)
                               by <b>intgr</b> (subscriber, #39733)
                              [<a href="/Articles/564348/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; nine years ago top-of the line CPU was Pentium 4 570J @ 3.8GHz while today it's Core i7 4770K @ 3.9GHz. [...] but difference is not striking.</font><br>
<p>
Depends on what you mean by "striking". I find that current server CPUs are 3-5 times faster at single-threaded workloads than 8-year-old single-core ones. Every generation of Intel processors still has performance gains of 10% or so while consuming less power.<br>
<p>
I see your point about the overhead of complex protocol encodings. But if we go back to the original topic of firewalling: increasing network speeds would not be such a big problem if we weren't still be stuck with packet sizes that were designed for 10 Mbps networks.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564348/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor564503"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 22:05 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/564503/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
clock speed isn't the only factor in cpu speed.<br>
<p>
It's also _extremely_ unlikely that you are going to need to limit your computation to a single core. Using multiple cores is trivial if you have multiple communication streams to process (put each stream on it's own core, or processing of data from each interface on it's own core, etc). But even if you have one stream to process, you can almost always find a way to split the workload across multiple cores (one core works on what you are sending now, the second works on what you will be sending in a few hundred ms, etc)<br>
<p>
so the move to multiple cores does end up helping the processing of things like this.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564503/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor564362"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 12:40 UTC (Thu)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/564362/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
IETF produces standards with a wonderful feature - they are written by humans, not by some humanoid aliens.<br>
<p>
As for compactness, GZIP+XML is about as compact as ASN.1 BER for most use-cases. Google's protobufs are also pretty compact.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564362/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor565258"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 29, 2013 14:24 UTC (Thu)
                               by <b>moltonel</b> (guest, #45207)
                              [<a href="/Articles/565258/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
While ASN.1 *is* riddled by some design-by-commitee issues that make the grammar hard to master and the implementations rare and buggy, it remains supperior in flexibility, features and packet size. As with any tool, it's not a one-size-fits-all, but there are a lot of areas where it is a winner.<br>
<p>
Concerning CPU usage, while hard to compare (the codec gives you many data verifications for free, which you have to write yourself with the likes of protobuf and msgpack), it is nothing to be ashamed of. And while some people have 10Gbits to play with, others are more concerned with the per-MB data roaming fee that is drilling a hole through their wallet.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/565258/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor564403"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">another bytecode interpreter ? </h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 14:43 UTC (Thu)
                               by <b>dw</b> (guest, #12017)
                              [<a href="/Articles/564403/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Having built protocols in both, saying ASN.1 is the original Protocol Buffers is like saying Python is the original COBOL. It's a markedly simpler design, with vastly less optional fluff, and a definition language you can master in an hour instead of a few weeks.<br>
<p>
Also to my knowledge, nobody has yet to ship a Protocol Buffers implementation riddled with security holes due to specification complexity, although that might just be because nobody thought to look there yet..<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564403/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor564261"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 21, 2013 17:26 UTC (Wed)
                               by <b>luto</b> (subscriber, #39314)
                              [<a href="/Articles/564261/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      I wonder how this compares to the <a href="http://pdos.csail.mit.edu/~engler/dpf.html">demultiplexing packet filter</a>.
      
          <div class="CommentReplyButton">
            <form action="/Articles/564261/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor564310"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 22, 2013 2:41 UTC (Thu)
                               by <b>ras</b> (subscriber, #33059)
                              [<a href="/Articles/564310/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yikes.<br>
<p>
To give Patrick his due, he has implemented good academic proposals in the past.  (The HFSC qdisc springs to mind).<br>
<p>
I hope he has seen this one.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/564310/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor565416"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2013 20:15 UTC (Sat)
                               by <b>compte</b> (guest, #60316)
                              [<a href="/Articles/565416/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I still use Peerguardian, based on libnetfilter_queue &amp; libfnetlink, although it's not maintained.<br>
I tried to make rules with iptables but it could not read 150 000 (but managed 100 000), while Peerguardian read more than that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/565416/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor565417"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2013 21:05 UTC (Sat)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/565417/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>That sounds like a prime use case for the new(-ish) IP set rules. You wouldn't want to do 150,000 separate tests on every packet anyway. IP set matches are much more efficient.</p>

<pre>ipset create peerguard hash:ip family inet maxelem 262144
xargs -i ipset add peerguard {} &lt; ip-list
iptables -A INPUT -m set --match-set peerguard src -j DROP</pre>

<pre>ipset create peerguard6 hash:ip family inet6 maxelem 262144
xargs -i ipset add peerguard6 {} &lt; ip6-list
ip6tables -A INPUT -m set --match-set peerguard6 src -j DROP</pre>

<p>Note that once you've created the set, you can use the "save" and "restore" ipset commands to avoid running 150,000 "add" commands every time you set up your firewall rules. You can also add a range of IPs with a single command, e.g. "ipset add peerguard 1.2.3.0/24".</p>

<p>Requires Linux 2.6.39 or later with CONFIG_IP_SET_HASH_IP enabled.</p>
      
          <div class="CommentReplyButton">
            <form action="/Articles/565417/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor565425"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Aug 31, 2013 23:41 UTC (Sat)
                               by <b>compte</b> (guest, #60316)
                              [<a href="/Articles/565425/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Thanks, I was using a lot of:<br>
-A INPUT -s 1.2.3.4/24 -j REJECT<br>
lines. So the trick is in "peerguard {} &lt; ip-list"<br>
Is peerguard{} an existing Peerguardian function pointing to a p2p file?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/565425/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor565427"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The return of nftables</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 1, 2013 1:51 UTC (Sun)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/565427/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; So the trick is in "peerguard {} &lt; ip-list"</font><br>
<font class="QuotedText">&gt; Is peerguard{} an existing Peerguardian function pointing to a p2p file?</font><br>
<p>
Not quite. This doesn't depend on any code other than ipset and iptables. The list of IP addresses/ranges to block is in the file "ip-list". In the command<br>
<p>
<font class="QuotedText">&gt; xargs -i ipset add peerguard {} &lt; ip-list</font><br>
<p>
the "{}" is an argument to "xargs -i" which serves as a placeholder. The xargs tool (with the "-i" option) runs the given command once for each line in the standard input (here redirected from the file ip-list), replacing any occurrences of "{}" with the data from the input. This is equivalent to a series of commands like:<br>
<p>
<font class="QuotedText">&gt; ipset add peerguard 12.23.34.45</font><br>
<font class="QuotedText">&gt; ipset add peerguard 21.32.43.54</font><br>
<p>
The ipset tool adds each IP address to the IP set named "peerguard", which was created in the previous "ipset create" command as a hash-based set of IP addresses, and referenced with the "-m ipset --match-set peerguard src" option to iptables to search the set for the source IP address of the packet.<br>
<p>
You'll probably want to change the "-j DROP" in my example to "-j REJECT", to match your previous rules. I wasn't sure which approach Peerguardian took. Also, if you have a large number of address ranges, like the /24 in your example, you may want to use "hash:net" rather than "hash:ip" when creating the IP set so that the ranges are stored more efficiently in the kernel. You can pass ranges to "ipset add" either way, but in the "hash:ip" case they're expanded to individual addresses in the table, whereas "hash:net" keeps separate tables for each prefix length and stores only the network address.<br>
<p>
See also:<br>
* <a href="http://ipset.netfilter.org/">http://ipset.netfilter.org/</a><br>
* <a href="http://ipset.netfilter.org/ipset.man.html">http://ipset.netfilter.org/ipset.man.html</a><br>
* <a href="http://ipset.netfilter.org/iptables-extensions.man.html">http://ipset.netfilter.org/iptables-extensions.man.html</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/565427/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2013, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
