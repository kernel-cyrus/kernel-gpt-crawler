        <!DOCTYPE html>
        <html lang="en">
        <head><title>Using Rust for kernel development [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/870555/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/870122/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/870555/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Using Rust for kernel development</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>We're bad at marketing</b>
<p>
We can admit it, marketing is not our strong suit. Our strength is
writing the kind of articles that developers, administrators, and
free-software supporters depend on to know what is going on in the
Linux world. Please <a href="/Promo/nsn-bad/subscribe">subscribe today</a> to help us keep doing that, and so
we don’t have to get good at marketing.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 27, 2021</br>
           <hr>
<a href="/Articles/870415/">Maintainers summit</a>
</div>
The Rust for Linux developers were all over the <a
href="https://linuxplumbersconf.org/">2021 Linux Plumbers Conference</a>
and had many fruitful discussions there.  At the Maintainers Summit, Miguel
Ojeda stepped away from Plumbers to talk about Rust in a different
setting.  What will it take to get the Rust patches merged?  The answers he
got were encouraging, even if not fully committal.
<p>
Ojeda started by asking the group whether the community wanted Rust in the
kernel.  If it goes in, he said, it should do so as a first-class citizen.
In his discussions he has encountered a number of kernel developers who are
interested in the language; many of them are quite open to it.  He has
gotten help from a number of those developers in the process.  Some groups,
including the Android team, actively want it, he said.
<p>
Linus Torvalds answered that the kernel community will "almost certainly" do a
trial with the language, but that the Rust developers need to accept that
it's a trial.  It is not necessary to convince everybody in the kernel
community before this can happen, but there does need to be a certain level
of buy-in from the subsystem maintainers who will be directly affected at
the beginning.  The support from "fake Linus" (GPIO maintainer Linus
Walleij) and Greg Kroah-Hartman is a good start, he said; a majority of
kernel maintainers is not
mandatory.  Torvalds had looked at the patches a few months ago when they
were posted, and nothing therein made him say "no way".  He has not seen
any postings since, though.  If Rust support is not merged, Torvalds ended,
it will never get to be good enough for real use in the kernel.
<p>
Kroah-Hartman said that the Rust patches are looking a lot better, but
aren't ready yet.  The <a href="/Articles/863459/">Rust GPIO driver</a>
that Wedson Almeida Filho posted in July was "awesome", and he
added that a number of filesystem developers are interested in
Rust.  That could be a good place to work, since the virtual filesystem
APIs in the kernel are relatively stable.
<p>
Kees Cook suggested that WiFi or Bluetooth drivers could be a good place to
use Rust; Kroah-Hartman answered that he would love to drop all of the
current Bluetooth drivers.  He said (to groans from the group) that he
knows of an upcoming phone that is shipping with
100 out-of-tree drivers; he suggested that developers interested in Rust
pick ten of those and see how things work.
<p>
Dave Airlie said that some maintainers will certainly be scared by the
addition of a new language; they are going to have to take the time to
learn it by writing something useful.  They will need to know that there
are resources out there to help them in dealing with Rust code in their
subsystems.  Torvalds said that Rust is not that hard to read, even if the
error-handling patterns are very different.  Anybody who can review patches
should be able to pick up enough Rust to review code in that language.
<p>
Ted Ts'o suggested that the Rust developers should post patches more
regularly — every week or two.  Developers will look when something shows
up in their inbox, that is the way to get their attention.
<p>
Airlie said that there are examples of Rust code at the edges of the kernel,
such as drivers.  Has any work gone into putting Rust into the core, with C
code at the edges?  Ojeda answered that the Rust developers are not trying
to rewrite things in the core kernel; instead, they are making a set of
abstractions so that drivers can be written in safe rust.  A C driver using
a Rust core would lose a lot of the advantages of using Rust, he said;
once you go to Rust, you want to stay there.
<p>
Ts'o raised the often-heard concern of wide-ranging, cross-subsystem
changes.  How hard are those going to be when there is Rust code involved
too?  It is fine if the GPIO maintainer buys in, since that subsystem is
reasonably well contained.  But if, say, the filesystem developers have to
make a change that breaks the Rust GPIO interface, what happens then?  Ojeda
repeated that kernel maintainers need to buy into the change, and that they
need to be ready to review changes to their subsystem.  Developers from
other subsystems who want to make a change in a Rust-using subsystem will
need to learn the language.  The Rust developers can provide help, but it
will not be enough; if the kernel maintainers want Rust, they are going to
have to help.  Mark Brown said that, even when maintainers are
enthusiastic, review from the Rust developers to be sure that work is
"tasteful" will be important.  After all, he just started learning the
language one week ago and doesn't know what he is doing at this point.
<p>
Arnd Bergmann said that putting the Rust code into a corner of the kernel
tree is not the 
right approach.  In the current patches there is one top-level Rust
directory, but it would be far better to distribute the Rust code among the
affected subsystems.  As little of that code as possible should be in a
central location.  Ojeda answered that there needs to be some general
support code, but that a lot of things could be split out of the current
kernel crate and put into subsystem-specific crates.
<p>
Al Viro asked about the stability of the Rust toolchain, noting that the
current requirement to use the latest Rust compiler is a problem.  At least
once a month he ends up bisecting a problem over three or four years of
history; if a different compiler is needed at each bisection step, things
are not going to work.  Ojeda said that the kernel work is using unstable
Rust features now, and that is a problem; it does make compatibility
harder.  For now, the Rust patches support a single Rust version for each
kernel release, and they cannot guarantee that a newer compiler will work
later on.  So yes, bisection would require changing compiler versions.
<p>
If, however, Rust support gets into the mainline kernel, the situation
might change.  That would put pressure on the Rust development community to
stabilize the needed features in the language — though there is never a
guarantee that this will actually happen.  Sooner or later, though, it will
be possible to build a kernel using only stable Rust features; at that
point the compatibility problems should go away.  He would understand, he
said, if the community chose to not merge Rust support until that happens.
<p>
Ts'o said that, if the Rust community wants the public-relations win that
would (presumably) come from use in the kernel, it might well feel moved to
stabilize the needed features.  Ojeda said that he had been invited to
Rustconf this year, which was a good sign, but then his submission on Rust
in the kernel was 
rejected — a less-good sign.  The consideration of Rust for the kernel was
then highlighted at that 
conference, though, so there is definitely some interest in the Rust
community at some level.
<p>
Thomas Gleixner said that he is not opposed to the experiment, and he likes
some of the concepts in the language.  He is worried, though, about "the
blank page where the memory model should be".  Ojeda said that the Rust
community is taking its memory-model cues from the C++11 and C11 standards,
but nothing is finalized.  During a conversation earlier that
week, Ojeda said, he encouraged Paul McKenney that this is the best time to
go to the Rust community and tell them how things could be; this is an
opportunity to fix issues in the C memory model and do things right.
<p>
Torvalds concluded the session by reiterating that bringing Rust into the
kernel is an experiment, the community is just putting its toes into the
water.  It will take years to sort things out and determine whether it
actually works in the kernel.  He is positive toward Rust, he said, and
likes the language; he wants a safer language, especially for driver
development.  But, he admonished at the end, he does not expect to rewrite
the whole kernel in the Rust language.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Development_tools-Rust">Development tools/Rust</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Kernel_Maintainers_Summit-2021">Kernel Maintainers Summit/2021</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/870555/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor870620"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2021 17:33 UTC (Mon)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/870620/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  He is worried, though, about &quot;the blank page where the memory model should be&quot;.</font><br>
<p>
I should really write the &quot;C11 memory model for kernel programmers&quot; article that I&#x27;ve been mulling over for a while. The same issues pretty much occur with Rust, as Miguel pointed out.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/870620/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor871044"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 27, 2021 23:36 UTC (Mon)
                               by <b>jgg</b> (subscriber, #55211)
                              [<a href="/Articles/871044/">Link</a>] (13 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I hope the outcome of all of this is a widespread recongition that C is no longer a great language to write the kind of software the Kernel has turned out to be.<br>
<p>
I also hope sanity prevals and top level kernel contributors are not required to be experts in two languages. It is hard to reconcile Linus suggesting we need a 10:1 submitter/maintainer ratio while making it ridiculously hard to actually train a kernel maintainer. I&#x27;d put up with this for ~5 years, but not forever.<br>
<p>
Which suggests to me any path to fixing the problem requires a long-term outcome where all of the kernel is in a single language.<br>
<p>
For instance I&#x27;d be much happier if someone was working on something like the python 2to3 tool with the idea of mechnically converting entire swaths of the kernel into rust. Eg lets make the *entire* GPIO subsystem rust/etc. Yes, the conversion may be riddled with unsafe, but at least it is one language and can get fixed in an incremental way. IMHO this is a fine way to let old HW drivers ride out into the sunset.<br>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871044/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871045"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 0:39 UTC (Tue)
                               by <b>viro</b> (subscriber, #7872)
                              [<a href="/Articles/871045/">Link</a>] (12 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Lovely.  When you are done with your &quot;convert not quite safe C into Rust, without turning it into completely undebuggable mess&quot; tool (and after having received the Nevanlinna Prize, richly deserved for such achievement), make sure to contact us mere mortals.  Until then, comp.lang.advocacy and alt.sex.masturbation are over -&gt; that way.<br>
<p>
And no, it&#x27;s not too harsh - anyone who suggest that automated transliteration from one language to another can improve anything is delusional and ignorant in the best case.  It&#x27;s not even &quot;one can write Fortran in any language&quot; (and I&#x27;ve seen the results of that), it&#x27;s &quot;replace the core parts of the kernel with a mess of horribly unidiomatic Rust, produced by automated conversion with unknown amount of bugs introduced by that and zero odds of discovering them in the resulting unreadable obsce^Wcodebase&quot;.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871045/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871047"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 2:13 UTC (Tue)
                               by <b>jgg</b> (subscriber, #55211)
                              [<a href="/Articles/871047/">Link</a>] (9 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Who said core parts? I said obsolete drivers. I said incremental change.<br>
<p>
Advocating for a permentant state of two completely different languages bridged together with a vast hodpodge of bindgen and hand written code only a rare expert can understand is barely a better outcome.<br>
<p>
And yes, I know C to Rust-as-it-is-today is halfway insane, but come on, lets at least be open to imagining there is some outcome out there where we could have a language improvement and not end up with a permanent dual-language mess.<br>
<p>
There is historical context for upgrading codebases in-place, many C to C++  and C++03 to C+11 uplifts have gone down an incremental upgrade path over the last 20 years without hitting your doomsday prophecy. Mechanically fix enough to be compilable in the new standard, then incremental passes to update high value areas. Programs like clang-tidy and coccinelle are even a proven path for machine guided incremental improvement.<br>
<p>
In my experiance dual language is really rare. The only direct experiances I have doing this has ended up being pretty horrible in the interfacing layer.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871047/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871050"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 7:21 UTC (Tue)
                               by <b>tux3</b> (subscriber, #101245)
                              [<a href="/Articles/871050/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Mozilla seems to think having two languages in the same codebase is reasonable. Given Rust was created at Mozilla and used to ship major Firefox components, I imagine they have thought about this quite a bit.<br>
<p>
Unsurprisingly, Mozilla is not trying to convert their existing C++ codebase into transpiler output.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871050/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871153"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2021 6:29 UTC (Wed)
                               by <b>maxfragg</b> (subscriber, #122266)
                              [<a href="/Articles/871153/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
you might be surprised to learn, that mozillas codebase started with transpiler-output, as what later became the mozilla suit and in turn firefox had a transpiled java core.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871153/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871174"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2021 9:13 UTC (Wed)
                               by <b>farnz</b> (subscriber, #17727)
                              [<a href="/Articles/871174/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <p>Have you got a reference for this? I can trace the core of Firefox's codebase back to Netscape 1.0, which predates Java, so if a transpiler was involved, it was during the rewrite.


      
          <div class="CommentReplyButton">
            <form action="/Articles/871174/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871176"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2021 9:33 UTC (Wed)
                               by <b>Fowl</b> (subscriber, #65667)
                              [<a href="/Articles/871176/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I don&#x27;t know if there is any transpilation in the &quot;original&quot; Mozilla, but the HTML (5, at the time) parser was converted from Java to C++ - <a href="https://johnresig.com/blog/html-5-parsing/">https://johnresig.com/blog/html-5-parsing/</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871176/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871180"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2021 10:41 UTC (Wed)
                               by <b>excors</b> (subscriber, #95769)
                              [<a href="/Articles/871180/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; I don&#x27;t know if there is any transpilation in the &quot;original&quot; Mozilla, but the HTML (5, at the time) parser was converted from Java to C++ - <a href="https://johnresig.com/blog/html-5-parsing/">https://johnresig.com/blog/html-5-parsing/</a></font><br>
<p>
The HTML5 parser is a special case since it&#x27;s a large amount of mostly very repetitive code, defining a complex state machine to turn characters into tokens and another to turn tokens into a DOM tree. (There&#x27;s enough special cases and weird rules, for backward compatibility reasons, that it&#x27;s not very practical to implement the state machines declaratively - it&#x27;s easier to write as imperative code. Plus the code closely mirrors the structure of the HTML5 specification, which makes it easier to verify that the spec and implementation are consistent.)<br>
<p>
Since it&#x27;s so repetitive, it&#x27;s relatively easy to mechanically translate between languages. And I think in this case the transpiler was custom-written for the HTML5 parser, and the Java version of the code was modified to be easy to transpile. E.g. compare &quot;startTag&quot; in Java (<a href="https://hg.mozilla.org/mozilla-central/diff/8b5103cb12a6b62558ba6ad64109f50bb66bd820/content/html/parser/javasrc/TreeBuilder.java#l1.1383">https://hg.mozilla.org/mozilla-central/diff/8b5103cb12a6b...</a>) and C++ (<a href="https://hg.mozilla.org/mozilla-central/diff/8b5103cb12a6b62558ba6ad64109f50bb66bd820/parser/html/nsHtml5TreeBuilder.cpp#l1.563">https://hg.mozilla.org/mozilla-central/diff/8b5103cb12a6b...</a>): the Java has some explicit &quot;// [NOCPP[&quot; markers for sections to omit from the C++, function calls like err() are deleted from the C++ (because the Java version was meant for use in a validator, which needs to report parse errors with as much detail as possible, whereas a browser doesn&#x27;t), enum values are renamed to Mozilla&#x27;s naming convention, string literals are replaced with global constants, etc, so there&#x27;s a lot of translation rules specific to this codebase.<br>
<p>
This is very different from general-purpose transpiling of arbitrary code that wasn&#x27;t designed for it.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871180/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
<a name="CommAnchor871060"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 12:41 UTC (Tue)
                               by <b>alonz</b> (subscriber, #815)
                              [<a href="/Articles/871060/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      Upgrading C to C++ (and C++03 to C++11) is somewhat of a joke; the language is generally 99.9% identical, and the only "conversion" required is often just to replace identifiers which conflict with keywords in the other language with something else. (And even then, in some such "uplifted" codebases I have seen, the resulting identifiers were jarring and clearly not what a human programmer would choose to use.)

<p>Conversion between languages with larger semantic differences - such as the case with Rust - would indeed be a feat worthy of a Nobel-prize-equivalent. And that's even <em>before</em> you try to care about readability of the resulting code. (I had myself written two such "transpilers" in my career; both were <em>very</em> special-purpose, targeting very limited code-bases, and both produced code that was nearly impossible to maintain.)



      
          <div class="CommentReplyButton">
            <form action="/Articles/871060/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871061"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 13:41 UTC (Tue)
                               by <b>jgg</b> (subscriber, #55211)
                              [<a href="/Articles/871061/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Just making C compile in a C++ compiler is not at all what I mean by upgrade. Proper C++11 code looks and operates very differently from C code. Human led, machine assisted incremental improvement is required to get from C to C++11 stuff. This is things like converting to use unique_ptr/smart_ptr, changing open coded containers into STL stuff, relying on the language to do cleanup, using move semantics, references,  etc/etc.  This is where the code becomes safer and more understandable.<br>
<p>
My point is there is a proven path from C code to high quality C++11 code that is incremental and auditable (and a wack of human work). It starts with a lightweight &#x27;transpile&#x27; to get C code into the C++ compiler in the first place, and no, it doesn&#x27;t completely destroy the readability of the code base.<br>
<p>
To my mind this should be the gold standard. This approach to add Rust parallel to C without any sane migration path is not. The fact that C to Rust, to even get started on the human-led incremental improvement, is basically impossible is not inherent. It comes from the deliberate design of Rust.<br>
<p>
Despite Al&#x27;s virtrol, I think there is merit in exploring what an ideal language upgrade for the kernel would be like - at least we can understand how far away this Rust proposal is.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871061/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor871296"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2021 23:47 UTC (Wed)
                               by <b>MrWim</b> (subscriber, #47432)
                              [<a href="/Articles/871296/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
In case you&#x27;re not already aware there&#x27;s the c2rust project: <a href="https://c2rust.com/">https://c2rust.com/</a> . The idea was that it does an automatic conversion for you to unsafe rust and then provides tools to help with conversion to idiomatic rust, and to help confirm that the conversion was faithful.<br>
<p>
I can thoroughly recommend the blog series on the same: <a href="https://immunant.com/blog/">https://immunant.com/blog/</a> and the wiki contains a discussion of some of the limitations of the approach: <a href="https://github.com/immunant/c2rust/wiki/Known-Limitations-of-Translation">https://github.com/immunant/c2rust/wiki/Known-Limitations...</a> .  It&#x27;s sufficiently advanced to allow transpiling Quake 3 with only minor changes required to the C source.<br>
<p>
From looking at the github history it seems like the project has slowed over the last year or two. I don&#x27;t know of its current state.<br>
<p>
(This isn&#x27;t an endorsement of the approach, just a pointer to it)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871296/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor872419"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Oct 10, 2021 14:42 UTC (Sun)
                               by <b>NAR</b> (subscriber, #1313)
                              [<a href="/Articles/872419/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <i>In my experiance dual language is really rare. The only direct experiances I have doing this has ended up being pretty horrible in the interfacing layer.</i>
<p>
Interesting. I thought it's quite common - have the frontend in Java or Javascript, the backend in C++ or Elixir or whatever, throw in some SQL for the stored procedures, some Python for test glue, maybe a Perl binding... Even if there are separate teams working on the frontend and backend, they might still look into each others code from time to time... I didn't need to be a Python expert to add a testcase or a Javascript expert to figure out the parameters passed to the backend. Granted, there are few projects needing the level of C expertise as the Linux kernel, so maybe being an expert in two languages might be harder - but I don't think (maybe C++ is the big exception, that's a horrible complicated language).


      
          <div class="CommentReplyButton">
            <form action="/Articles/872419/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor871056"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 9:39 UTC (Tue)
                               by <b>dvrabel</b> (subscriber, #9500)
                              [<a href="/Articles/871056/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And kernel maintainers wonder why they have trouble attracting new developers and maintainers.  Only the last sentence has actual, valid content and the rest is entirely unnessesary vitriol.<br>
<p>
FWIW, this sort of toxic response and culture is why I&#x27;m highly unlikely to ever be a kernel subsystem maintainer again.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871056/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871482"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2021 21:53 UTC (Thu)
                               by <b>piexil</b> (subscriber, #145099)
                              [<a href="/Articles/871482/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For real, it was completely unnecessary, and it&#x27;s so smug.  People also already do things similar to fixing transpiled code in their freetime. (reverse engineering decompiled assembly to c like the super mario 64 decomp comes to mind) <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871482/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor871062"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 14:46 UTC (Tue)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/871062/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;Thomas Gleixner ... is worried, though, about &quot;the blank page where the memory model should be&quot;. Ojeda ... encouraged Paul McKenney that this is the best time to go to the Rust community and tell them how things could be.</font><br>
<p>
I&#x27;m a fan of cross-pollination and have huge respect for Paul McKenney&#x27;s ability to  build consensus on a way forward while also teaching the lessons of the past that went wrong. It might be unfair to say that the Kernel memory model is x86, but there&#x27;s a heavy overlap on the assumptions Linus Torvalds made 30 years ago. I might put a slots on the bingo card that: other memory models do it better; Rust wants to learn those lessons; mismatch with the LKMM when it comes to the essential bikeshedding.<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871062/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871101"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 16:40 UTC (Tue)
                               by <b>pbonzini</b> (subscriber, #60935)
                              [<a href="/Articles/871101/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It might be unfair to say that the Kernel memory model is x86, but there&#x27;s a heavy overlap on the assumptions Linus Torvalds made 30 years ago.</font><br>
<p>
I think that&#x27;s quite incorrect since:<br>
<p>
* any x86-based memory model would have serious problem on weakly-ordered architectures, and also would have serious problems with optimizations that do not respect the TSO (total store ordering) model that x86 uses.<br>
<p>
* I might be wrong on this, but the first architecture for which Linux supported SMP was either SPARC or Alpha, almost certainly not x86<br>
<p>
Right now, the Rust memory model _is_ the C/C++ model since it just reuses the same backend code.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871101/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871103"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 17:24 UTC (Tue)
                               by <b>PaulMcKenney</b> (<b>&#x272D; supporter &#x272D;</b>, #9624)
                              [<a href="/Articles/871103/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
And that reuse of the backend code is the challenge!<br>
<p>
At the informal meeting called out in the article, I committed to write a blog series on the specific topics that I am concerned about.  As Dan Frye was wont to say, &quot;It should be good clean fun.&quot;  ;-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871103/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor871098"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 16:04 UTC (Tue)
                               by <b>linusw</b> (subscriber, #40300)
                              [<a href="/Articles/871098/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As &quot;fake Linus&quot; I can just acknowledge the protocol here: I am happy about Rust when done right (read: with true grit) and don&#x27;t mind to go first.<br>
<p>
However during review I did point out that the security hurdles that Rust can help to solve are not in drivers, and I pointed to filesystems and suggested that the developers look at reimplementing the (then out-of-tree) ksmbd in Rust. ksmbd was then merged unbeknownst to me and my worries confirmed to be true as some out-of-bounds bugs (which are impossible in Rust) surfaced immediately.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871098/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor871122"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 21:03 UTC (Tue)
                               by <b>lwnli</b> (guest, #141318)
                              [<a href="/Articles/871122/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
If drivers are encouraged to be implemented in user space, what benefit does writing drivers in Rust bring about?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871122/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 28, 2021 21:57 UTC (Tue)
                               by <b>rahulsundaram</b> (subscriber, #21946)
                              [<a href="/Articles/871126/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; If drivers are encouraged to be implemented in user space, what benefit does writing drivers in Rust bring about?</font><br>
<p>
The article doesn&#x27;t talk about user space drivers.  Where are you getting that from?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871292"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 29, 2021 21:42 UTC (Wed)
                               by <b>lwnli</b> (guest, #141318)
                              [<a href="/Articles/871292/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
read somewhere else. wonder if writing it in user space gives the same benefit as writing it in Rust.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871292/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871298"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2021 0:03 UTC (Thu)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/871298/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Writing in Rust turns many kinds of memory safety violation into compile-time errors, meaning that you have to fix them before you can start testing the code.<br>
<p>
Running in user-space turns some subset of memory safety violations, which partially overlap with those that Rust turns into compile-time errors, into SIGSEGVs instead of kernel data structure corruption.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871298/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor871303"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Using Rust for kernel development</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 30, 2021 0:06 UTC (Thu)
                               by <b>mpr22</b> (subscriber, #60784)
                              [<a href="/Articles/871303/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
(And, of course, it turns the rest into process-local data structure corruption. Which could still be disastrous when the program has control of a DMA-capable peripheral device and your IOMMU capabilities are insufficient...)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/871303/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2021, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
