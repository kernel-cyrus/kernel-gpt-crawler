        <!DOCTYPE html>
        <html lang="en">
        <head><title>The next steps for the maple tree [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/974860/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/974710/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/974860/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>The next steps for the maple tree</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Ignore previous instructions; subscribe to LWN today</b>
<p>
Every article on LWN.net is written by humans, for humans. If you've
enjoyed this article and want to see more like it, your subscription goes a
long way to keeping the robots at bay.  We are offering <a href="https://lwn.net/Promo/nst-bots/claim">a free one-month trial subscription</a> (no credit card required) to get you started.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>May 27, 2024</br>
           <hr>
<a href="/Articles/lsfmmbpf2024/">LSFMM+BPF</a>
</div>
The <a href="/Articles/845507/">maple tree data structure</a> was added
during the 6.1 development cycle; since then, it has taken its
place at the core of the kernel's memory-management subsystem.
Unsurprisingly, work on maple trees is not yet done.  Maple-tree maintainer
Liam Howlett ran a session in the memory-management track of the <a
href="https://events.linuxfoundation.org/lsfmmbpf/">2024 Linux Storage,
Filesystem, Memory-Management and BPF Summit</a> to discuss the current
state of the maple tree and which features can be expected next.
<p>
Howlett has a backlog of requested features that seems likely to keep him
busy for some time.  Some of them are internal to the data structure
itself:
<p>
<ul class="spacylist">
<li> There is a desire for a fast way to get a count of the number of
     null entries within a node.
<li> "Dense nodes", which contain more pointers per node.
<li> The removal of "big nodes", which are a special structure used when nodes
     are rebalanced or split.  Among other things, removing them will help
     to improve support for singleton ranges â€” process IDs, for example.
<li> Finally, he plans to implement index compression.
</ul>
<p>
With regard to externally visible features:
<p>
<ul class="spacylist">
<li> The ability to search marks and tags is at the top of the to-do list.  That
     would allow searching a tree for entries with, for example, the
     "dirty" bit set.
<li> The ability to prune trees under memory pressure would help the system
     overall; it could be used with the cache that holds shadow page-table
     entries for evicted pages.
<li> Filesystem users would benefit from 64-bit indices on 32-bit
     architectures.
<li> A contiguous iterator that would iterate over a range only as long as
     there are no gaps.
<li> "Big dense nodes" were described as a large list that could
     hold up to 4K singleton items.
</ul>
<p>
Overall, he said, he is trying to get maple trees to the point that they
can match the features provided by <a
href="https://docs.kernel.org/core-api/xarray.html">XArrays</a>.  The maple
tree should be able to do the same things with better performance; once the
features are there, it should be possible to implement the XArray interface
and switch users without anybody else having to even be aware of it.
<p>
Howlett said that the maple tree is getting more users, and he is seeing
some common errors when code is converted over.  It is possible to use
external locks to serialize access to a maple tree, he said, and some users
do it, but it is better avoided if possible.  He cautioned that anybody
using read-copy-update (RCU) read locks should be aware that the lock
protects a maple-tree node from being freed, but not necessarily the data
contained within that node.
<p>
Users of the generic storage API were encouraged to wrap it with a typed
interface so that the compiler can catch mistakes.  Developers converting
from an XArray often are surprised when <a
href="https://elixir.bootlin.com/linux/v6.9.1/source/lib/maple_tree.c#L5741"><tt>mas_next()</tt></a>
fails to return the first entry.  Its job is to get the <i>next</i> entry;
to start at the beginning, <a
href="https://elixir.bootlin.com/linux/v6.9.1/source/lib/maple_tree.c#L6048"><tt>mas_find()</tt></a>
should be used instead.
<p>
In general, he said, he is working toward the addition of a type-safe
interface and moving away from <tt>void&nbsp;*</tt> pointers.  Eventually
there will be a <tt>DEFINE_MAPLE_TREE()</tt> macro that creates a tree
handling objects of a given type.
<p>
As usage has grown, the maple tree structure has encountered a number of
challenges.  Tracking of virtual memory areas (VMAs) is one of those; he is
trying to find ways to remove some of the complexity associated with
special VMAs.  One example is guard VMAs, which define a short range of
no-access address space to catch overruns.  If guard VMAs are in use, the
total number of VMAs in the tree is doubled, which is expensive, but those
guard VMAs are never really used.  So Howlett is trying to find a way to
mark guard regions directly in the maple tree and avoid allocating so many
extra structures.
<p>
Maple trees should eventually implement upper and lower limits, he said;
that would be useful, for example, to implement restrictions on mapping the
page at virtual address zero.  Currently a maple tree will show gaps in
areas that are not actually available for allocation.  There are also some
challenges in representing the <a
href="https://en.wikipedia.org/wiki/VDSO">vDSO</a> area.
<p>
There were a few comments once Howlett finished.  David Hildenbrand said
that the kernel contains a lot of checks for gate VMAs, which are a special
VMA used to represent the virtual-system-call page; it would be
nice to find a way to represent them in the maple tree and remove those
checks.  Suren Baghdasaryan said that guard VMAs are one of the biggest
allocation slabs on Android systems, so removing them would be a welcome
optimization.  The session wound down with a bit of discussion on the best
way to identify guard VMAs within the kernel.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Maple_trees">Maple trees</a></td></tr>
            <tr><td><a href="/Archives/ConferenceIndex/">Conference</a></td><td><a href="/Archives/ConferenceIndex/#Storage_Filesystem_Memory-Management_and_BPF_Summit-2024">Storage, Filesystem, Memory-Management and BPF Summit/2024</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/974860/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor975436"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The next steps for the maple tree</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2024 18:32 UTC (Mon)
                               by <b>jedix</b> (subscriber, #116933)
                              [<a href="/Articles/975436/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
For the guard areas, there are two issues:<br>
1. guard VMAs are used to catch writes beyond a particular VMA<br>
2. some VMAs that grow have unusable areas that are outside the range but are still unusable.<br>
<p>
The first issue is primarily about the inflated memory use and counting towards the mm-&gt;map_count limit of a VMA.<br>
<p>
The second issue is about how we track gaps.  Since this area is considered fully usable from the trees point of view, we end up in a situation that is both not empty and not usable; an empty area can be found to place allocations but the search must continue for a place that is actually usable.  This is a lot like the upper and lower bound issue, but not entirely the same as the area can more easily shift (annoyingly, upper and lower bounds can also shift).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975436/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor975447"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The next steps for the maple tree</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2024 20:07 UTC (Mon)
                               by <b>jedix</b> (subscriber, #116933)
                              [<a href="/Articles/975447/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
"we end up in a situation that is both not empty and not usable" should read<br>
<p>
"we end up in a situation that is both empty and not usable"<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975447/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor975446"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The next steps for the maple tree</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 27, 2024 20:11 UTC (Mon)
                               by <b>vbabka</b> (subscriber, #91706)
                              [<a href="/Articles/975446/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
During the session I have proposed an alternative to guard VMAs (which AFAIU is a VMA with mprotect() set to PROT_NONE). What should be enough to catch the stray accesses before/after the VMA would be to have the respective entries in page tables (PTE) marked as such. But because we match protections on VMAs and PTEs, once userspace e.g. creates a larger VMA that includes the guard pages and then mprotect(PROT_NONE) the boundary pages, the kernel will split the VMA into 3.<br>
<p>
Instead we could extend e.g. madvise() with two new modes (tentatively called MADV_POISON and MADV_REMEDY) that would only mark the PTE's into something that behaves like PROT_NONE, or undoes this. Since there would be no actual page mapped (pfn) for them, it could be implemented as a new special swap type (such as e.g. migration entries are) to avoid the hassle of distinguishing it from other PROT_NONE marked entries such as those used for NUMA balancing. The page fault handler would recognize this and cause a segfault. This would avoid the VMA splitting. Users could also do this to pages in the middle of a VMA, not just boundaries i.e. in a userspace malloc implementation to catch a use-after-free. In that sense MADV_POISON would extend MADV_DONTNEED in that the PTE is zapped before setting the special swap type.<br>
<p>
Has something like that been tried before? Any obvious gotchas? It could be also done with userfaultfd but that adds its own overhead to all the page faults.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975446/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor975476"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The next steps for the maple tree</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2024 2:31 UTC (Tue)
                               by <b>jedix</b> (subscriber, #116933)
                              [<a href="/Articles/975476/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
One potential issue is that some platforms (I believe MIPS?) can have PTEs outside of the areas mapped by the VMAs.  This is why, when we munmap, we use the start of the next VMA and the end of the previous VMA as the area being unmapped (and passed through to free_pgtables() in unmap_region()).  If we have special PTEs mapped in that area for other uses, we would need to work around the free_pgtables() using the extended range beyond the VMAs to avoid including these new mappings when removing the next VMA.  The arguments passed through to free_pgtables() is already a mess.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975476/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor975533"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The next steps for the maple tree</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2024 13:39 UTC (Tue)
                               by <b>jedix</b> (subscriber, #116933)
                              [<a href="/Articles/975533/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think this isn't a concern as the guard would be included within the vma guards.<br>
<p>
Also, for reference it seems what I was thinking of was for arm:<br>
<a href="https://lore.kernel.org/all/Pine.LNX.4.61.0504070210430.24723@goblin.wat.veritas.com/T/">https://lore.kernel.org/all/Pine.LNX.4.61.0504070210430.2...</a><br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975533/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor975504"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">The next steps for the maple tree</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 28, 2024 11:23 UTC (Tue)
                               by <b>david.hildenbrand</b> (subscriber, #108299)
                              [<a href="/Articles/975504/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
As raised, Jann Horn played with that idea and I remember he had a prototype, see <a href="https://lore.kernel.org/lkml/CAG48ez2NrQjB5T5++uJSZ8-id5-H2mbSRX8c36gAJ5p_BMHOFw@mail.gmail.com/#t">https://lore.kernel.org/lkml/CAG48ez2NrQjB5T5++uJSZ8-id5-...</a><br>
<p>
MADV_GUARD might be a more appropriate name.<br>
<p>
I have a related project on my back burner to tackle optimize very sparse VMAs (raised in reply to Jann's mail), that I discussed in the bi-weekly MM meeting. While my initial idea was to similarly use PTE markers, I'm investigating using using something like sparse bitmaps instead. Other things keep interrupting me, so I did not yet have time to do more work on that. But the focus is a bit different than having only a handful of guard pages (MADV_GUARD might be more appropriate for that).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/975504/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2024, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
