        <!DOCTYPE html>
        <html lang="en">
        <head><title>Extended system call error reporting [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/657341/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/657114/">Return to the Kernel page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/657341/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>Extended system call error reporting</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>September 16, 2015</br>
           </div>
The interface between the kernel and user space is, in places, surprising
in its complexity.  There are numerous tasks that involve passing detailed
information about hardware configurations, process state, and more, in
either direction.  When something goes wrong, though, that communication
channel narrows to a single integer error code, often making it difficult
for developers to figure out what is going on.  There have been various
proposals for widening the error-reporting interface in the past; the <a
href="/Articles/657147/">latest proposal</a>, from Alexander Shishkin, may
not get any further than its predecessors, but it does show that there is
ongoing interest in the problem.
<p>
As an example, consider the <tt>VIDIOC_S_FMT</tt> <tt>ioctl()</tt> call,
provided by the media subsystem.  Its job is to set the format of images
returned to user space from a capture device (such as a camera).  There is
a mind-boggling variety of possible image formats out there, so the <a
href="http://linuxtv.org/downloads/v4l-dvb-apis/pixfmt.html">format
description</a> passed to the kernel from user space contains a number of
complex, interrelated parameters.  There are a lot of ways such a
description can go wrong — and that's before the vagaries of specific
driver implementations are taken into account.  Should there be a problem,
though, the only thing user space is likely to know is that the
<tt>VIDIOC_S_FMT</tt> call returned <tt>EINVAL</tt>.  The kernel, of
course, knows what it was objecting to, but there is no way to communicate
that knowledge to user space.
<p>
Fixing that problem is not easy; the <tt>errno</tt> mechanism is clearly
inadequate, but it is set in stone by several decades of Unix tradition and
cannot be changed without breaking applications.  So any extended error
information must be carried by a new channel that can be ignored by unaware
applications.  The addition of error information to the kernel must also be
done carefully, so as to avoid slowing down kernel hot paths or clogging
the source 
with an overwhelming set of error messages.  Alexander's patch attempts to
meet all of these criteria.
<p>
How the mechanism works is best illustrated with some examples.  In his
patch set, Alexander targets the <a
href="http://man7.org/linux/man-pages/man2/perf_event_open.2.html"><tt>perf_event_open()</tt></a>
system call; it takes a <tt>perf_event_attr</tt> structure as a parameter.
That structure has a vast and growing set of parameters describing the
events to be captured and, correspondingly, there are a lot of ways in
which things can go wrong.
<p>
<h4>Describing errors</h4>
<p>
The first step is to create a structure that describes an error site — a
place where an error is detected and passed back to user space.  That
structure should include a field called <tt>site</tt> that holds an
<tt>ext_err_site</tt> structure; beyond that, it can contain any
information needed to fully report the error to user space.  In the perf
case, that structure looks like this:
<p>
<pre>
    #include &lt;linux/exterr.h&gt;

    struct perf_ext_err_site {
	struct ext_err_site	site;
	const char		*attr_field;
    };
</pre>
<p>

The <tt>attr_field</tt> member is meant to hold the name of the field in
<tt>struct&nbsp;perf_event_attr</tt> that generated the error.
<p>
Then, it is necessary to define a function that can turn any extra
information in this structure into a string to be passed back to user
space.  The perf version is:
<p>
<pre>
    static char *perf_exterr_format(void *site)
    {
	struct perf_ext_err_site *psite = site;

	return kasprintf(GFP_KERNEL, "\t\"attr_field\": \"%s\"\n",
			 psite-&gt;attr_field);
    }
</pre>
<p>

Note that this function returns a dynamically allocated string; the
extended error infrastructure will free that string when it is no longer
needed.
<p>
With these two pieces in place, it is possible to define an "error domain"
that handles a specific class of errors — perf errors in this case:
<p>
<pre>
    DECLARE_EXTERR_DOMAIN(perf, perf_exterr_format);
</pre>
<p>
The actual reporting of error information is done by way of a rather
frightening bit of macro magic called <tt>ext_err()</tt>.  Real users will
almost certainly wrap it, though; this is how it is done in the perf code:
<p>
<pre>
    #define perf_err(__code, __attr, __msg)				\
	({ /* make sure it's a real field before stringifying it */	\
	    struct perf_event_attr __x; (void)__x.__attr;		\
	    ext_err(perf, __code, __msg, 				\
	        .attr_field = __stringify(__attr));			\
	})
</pre>
<p>
The parameters to <tt>ext_err()</tt> are the name of the domain defined
above, the (negative) error code, a message to be reported to user space,
and a set of initialization strings to initialize the rest of the
error-site structure.  In this case, the final parameter to
<tt>ext_err()</tt> sets the <tt>attr_field</tt> of the
<tt>perf_ext_err_site</tt> structure to the name of the erroneous
attribute.  See <a href="/Articles/657346/">this patch</a> for an actual
invocation of the <tt>perf_err()</tt> macro.
<p>
There are a couple of other important details.  One is that the
<tt>EXTERR_MODNAME</tt> symbol must be set separately before calling
<tt>ext_err()</tt>:
<p>
<pre>
    #define EXTERR_MODNAME	"perf"
</pre>
<p>
The other is that <tt>ext_err()</tt> returns a value, which is a modified
version of the error code passed into it.  This code can be thought of as
an index into an array of <tt>ext_err_site</tt> structures describing every
extended error known to the kernel.  The normal way to return the error
code to user space will then be through a line like:
<p>
<pre>
    return ext_err_errno(code);
</pre>
<p>
The modified code from <tt>ext_err()</tt> must not be returned directly to user
space, since applications will have no idea what it means.  On the other
hand, the original error code should not be returned without calling
<tt>ext_err_errno()</tt>; that call is the one that causes the kernel to
remember the extended error information.  In short, there is a new
<tt>task_struct</tt> field called <tt>ext_err_code</tt>; the call to
<tt>ext_err_errno()</tt> causes the special error code to be placed into
that field.  If an ordinary (non-extended) error code is passed to
<tt>ext_err_errno()</tt>, the right thing will happen, so it is safe to use
in situations where a support code might return ordinary or extended error
codes.
<p>
<h4>The user-space side</h4>
<p>
At this point, the kernel is prepared to tell user space about an extended
error, but the return value from the system call can still only be the
ordinary <tt>errno</tt> value that it has always been.  If the application
wants to know more, it can make a call like:
<p>
<pre>
    char message[SIZE];

    len = prctl(PR_GET_ERR_DESC, message, SIZE);
</pre>
<p>

The return value is not just an ordinary message; it is a string in the
<a href="http://json.org/">JSON</a> format containing the file and line
where the error was generated, the 
error code, the module name, the actual message, and any specific
information added by the domain format function described above.  The
changes to the user-space <tt>perf</tt> tool duly include a new JSON parser
to pick this message apart again.  The <tt>prctl()</tt> call will clear the
error information on the kernel side, so a second call will return no
data. 
<p>

The patch set has, thus far, not seen much in the way of review comments.
In the end, the error-reporting issue is one that most developers
recognize, but few feel up to trying to fix.  So it is hard to say whether
this attempt to widen the error-reporting channel from the kernel will meet
with success or not.  Ancient traditions are hard to change but, every now
and then, somebody succeeds.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Error_codes">Error codes</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Messages">Messages</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#User-space_API-Error_reporting">User-space API/Error reporting</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/657341/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor657682"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Signal handlers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 14:41 UTC (Thu)
                               by <b>abatters</b> (<b>&#x272D; supporter &#x272D;</b>, #6932)
                              [<a href="/Articles/657682/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      What if a signal handler runs in between the syscall that failed and the prctl() to get the extended error, and the signal hander does another system call that fails and sets a different extended error?

Pseudocode:

<pre>
sighandler() {
  bad_syscall_2();
  return;
}

main() {
  ...
  if (bad_syscall_1()) {
    // interrupted by signal here
    prctl(PR_GET_ERR_DESC)
    // is extended error from bad_syscall_1() or bad_syscall_2()?
  }
}
</pre>
      
          <div class="CommentReplyButton">
            <form action="/Articles/657682/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657697"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Signal handlers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 14:55 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/657697/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      There are a number of open questions currently about the lifetime of extended error information and how to know that you're getting the information you think you are.  Signals just, as usual, throw another wrench into a scenario already full of them.
      
          <div class="CommentReplyButton">
            <form action="/Articles/657697/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657712"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Signal handlers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 16:04 UTC (Thu)
                               by <b>deater</b> (subscriber, #11746)
                              [<a href="/Articles/657712/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I use perf_event_open() a lot and am often hit by this issue [I usually resort to sprinkling printk()s all over the code, but you can't really ask someone filing a bug report to do that].<br>
<p>
I was following these developments at first, but the patches involved quickly went from something I could review to things involving deep and mysterious kernel internals as well as complex JSON interfaces.<br>
<p>
I was hoping for something where a user could just provide the kernel with a 4k circular buffer to printk error messages in, maybe with errno providing a pointer to the relevant offset to handle the case where multiple errors happen.  But I think the various race conditions, compatability, and ABI issues people have brought up mean that something simple is not possible.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657712/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657737"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Signal handlers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 18:57 UTC (Thu)
                               by <b>JGR</b> (subscriber, #93631)
                              [<a href="/Articles/657737/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Rather than the user providing a circular buffer, or having to make another syscall, it would seem easier to have the user provide a buffer for the extended error info to be written into, as an extra pointer or field(s) added to struct perf_event_attr. That way you would avoid ambiguities about which syscall any extended error info is referring to, though it does make it at least partly specific to perf_event_open.<br>
struct perf_event_attr has a size field, so adding more fields to the end need not break backwards compatibility.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657737/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657764"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Signal handlers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 23:38 UTC (Thu)
                               by <b>ncm</b> (guest, #165)
                              [<a href="/Articles/657764/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This seems like the Right Thing.  Did  nobody think of it?  It seems unlikely.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657764/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657765"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Signal handlers</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 23:44 UTC (Thu)
                               by <b>corbet</b> (editor, #1)
                              [<a href="/Articles/657765/">Link</a>] 
      </p>
      
      </div>
      </summary>
      It's the Right Thing if you only want to add extended error reporting for perf.  If you want a generalized facility that can work with any system call, you need to do something else.
      
          <div class="CommentReplyButton">
            <form action="/Articles/657765/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor657755"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 21:48 UTC (Thu)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/657755/">Link</a>] (15 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Json seems a bit cludgy, requiring a parser to be present in anything that wishes to use this functionality.  Also json is very weakly typed with lots of strings. It doesn't sound like the foundations for a solid or secure interface.<br>
<p>
I would prefer something a bit more rigid.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657755/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657757"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 21:56 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/657757/">Link</a>] (14 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
any format you use is going to require a parser. You can only return a series of bytes, something needs to assign meaning to those bytes.<br>
<p>
If you think that JSON is a bad standard to convert that string of bytes to structure, what do you suggest instead?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657757/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657758"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 22:14 UTC (Thu)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/657758/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A C structure would be my suggestion.  Anything making system calls probably already knows about structures, and the pitfalls of alignment and packing are well trodden and avoidable.<br>
<p>
I would probably make the structure at least a page in size, and allow for either strings and/or blobs to be returned.  For example, some device may be able to return hardware generated error octets or register codes which could be passed through to use space for further decode along with EIO.  This would then not require the driver to decode the registers or octets, or use a bulky ASCII coding for binary data in a json string.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657758/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657762"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 17, 2015 23:26 UTC (Thu)
                               by <b>dlang</b> (guest, #313)
                              [<a href="/Articles/657762/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
where is the definition of the structure kept? how do you change the structure over time?<br>
<p>
while a direct C structure is more efficient when passing binary blobs, it's far less efficient in passing strings that may or may not be populated or have different lengths.<br>
<p>
I also question needing to allocate a full page (or more) to return a handful of bytes)<br>
<p>
keep the simple stuff simple, while still making the hard stuff possible.<br>
<p>
you seem to be focused on making the hard (and rare) stuff efficient at the cost of making the simple stuff very complex.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657762/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657779"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 18, 2015 7:21 UTC (Fri)
                               by <b>mm7323</b> (subscriber, #87386)
                              [<a href="/Articles/657779/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; where is the definition of the structure kept? how do you change the structure over time?</font><br>
<p>
Come on.  The kernel uses lots of structures to communicate with userspace - it's no stretch of the imagination to see another.<br>
<p>
<font class="QuotedText">&gt; while a direct C structure ... it's far less efficient in passing strings that</font><br>
<font class="QuotedText">&gt; may or may not be populated or have different lengths.</font><br>
<p>
I don't think any sane person would try to claim JSON would be more efficient - the extra braces, brackets, quotes and escaping all add overhead.  Storing a list of key-value pairs in a structure isn't difficult, though without using pointers you end up doing something like the uBoot environment:<br>
<p>
a=1\0<br>
b=2\0<br>
\0<br>
<p>
The above is very simple to write out from C and needs no escaping.  Hand writing the JSON, as proposed in the article, is going to lead to all sorts of mistakes on rarely used error paths.<br>
<p>
From the article:<br>
<p>
	return kasprintf(GFP_KERNEL, "\t\"attr_field\": \"%s\"\n",<br>
			 psite-&gt;attr_field);<br>
<p>
What if psite-&gt;attr_field contains a double quote?  What if the programmer forgets to add the colon or makes some other typo?  Now we have errors in error reporting.  A sane API should make it hard to get things wrong, and needs static checking at compile time in my opinion.<br>
<p>
<font class="QuotedText">&gt; I also question needing to allocate a full page (or more) to return a handful of bytes)</font><br>
<p>
Being on an error path, we would probably want to ensure this buffer is pre-allocated so we don't have to risk a cascade of failures.  Consider trying to get an extended error message when ENOMEM was returned - we wouldn't really like to call malloc() or extend the stack significantly in case we fall to mmap()/brk()/sbrk().<br>
<p>
So if we pre-allocate the buffer, we should also make it large enough for the worst case, so writing that down somewhere is a good idea.<br>
<p>
<font class="QuotedText">&gt; you seem to be focused on making the hard (and rare) stuff efficient at the cost of making the simple stuff very complex.</font><br>
<p>
I don't think C structures are hard or complex.  I do see a JSON formatter and parser as unneeded complexity on error paths and a departure from current interface style and practices. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657779/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657837"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 18, 2015 18:18 UTC (Fri)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/657837/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Except, it doesn't work. You simply end up with a hacked up JSON lookalike, that uses zeroes as terminators instead of double quotes.<br>
<p>
<font class="QuotedText">&gt;  What if psite-&gt;attr_field contains a double quote? What if the programmer forgets to add the colon or makes some other typo? Now we have errors in error reporting. A sane API should make it hard to get things wrong, and needs static checking at compile time in my opinion.</font><br>
C structures provide no real advantage in this regard.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657837/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor657916"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2015 11:55 UTC (Sun)
                               by <b>bcopeland</b> (subscriber, #51750)
                              [<a href="/Articles/657916/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;  What if psite-&gt;attr_field contains a double quote? What if the programmer forgets to add the colon or makes some other typo? Now we have errors in error reporting. A sane API should make it hard to get things wrong, and needs static checking at compile time in my opinion.</font><br>
<p>
I have to agree that JSON is one of those things that seems easy at first glance, but there's JSON and then there's JSON.  <br>
<p>
Like the escaping you already pointed out, encoding can be an issue.  Here's an example I ran into once: JSON was being used as a serialization format for binary data [1], and Python's JSON serializer dumped the byte strings as unicode codepoints, even if they were invalid.  Turns out that, for a time, Python couldn't parse JSON it serialized itself [2].<br>
 <br>
[1] <a href="https://bugs.launchpad.net/meliae/+bug/876810">https://bugs.launchpad.net/meliae/+bug/876810</a><br>
[2] <a href="http://bugs.python.org/issue11489">http://bugs.python.org/issue11489</a><br>
<p>
Of course, you can make rules about escaping and encoding and police them, but it's much better to rule out that class of problems altogether.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657916/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor657778"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 18, 2015 6:50 UTC (Fri)
                               by <b>kugel</b> (subscriber, #70540)
                              [<a href="/Articles/657778/">Link</a>] (8 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I would have hoped for a string that can be printed on the command line as-is.<br>
<p>
Such as "EINVAL at LINE x in FILE y. REASON: FOO must not be combiend with BAR."<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657778/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657795"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 18, 2015 13:28 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/657795/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah, but now you'll have crazy borderline-NLP attempts to get the meaningful information from that. Not to mention there's just about no way to enforce consistency and structure in such free-form text (and this basically becomes an ABI…hello spelling errors becoming enshrined as ABI). We'd still have sucky implementations trying to deal with the thing, but I feel like JSON parsing is more of a known than NLP in the "how bad can people screw this up?" department.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657795/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657797"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 18, 2015 13:28 UTC (Fri)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/657797/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt;&gt; combiend</font><br>
<font class="QuotedText">&gt; hello spelling errors becoming enshrined as ABI</font><br>
<p>
Heh, case in point :) .<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657797/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor657893"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2015 20:40 UTC (Sat)
                               by <b>robbe</b> (guest, #16131)
                              [<a href="/Articles/657893/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      Just because something is structured does not prevent enshrining of spelling errors. I take you are intimely familiar with the HTTP standards...
<p>
Do we have to optimise for size? I think not. So why not stipulate that the JSON return code MUST begin with
<br>
<code>{\n\t"human-readable": "</code>
<br>
followed by a message helpful to users that MUST NOT contain double quotes nor zero bytes and is terminated by a double quote. This is dirt easy to parse correctly for any software that just wants to give a better abort message than "something happened, use 'dmesg' to find out what".
      
          <div class="CommentReplyButton">
            <form action="/Articles/657893/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657896"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 19, 2015 21:55 UTC (Sat)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/657896/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The HTTP typo is unfortunate, but it is in a label which users don't typically see. Here, a typo such as was made there would seriously impair the "just print the string out" simplicity that (I suspect) was a bullet point of that format. Not to mention i18n of such a string…<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657896/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657908"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2015 7:42 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/657908/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
So what's the difference between:<br>
struct _perf_error { <br>
   const char *raeson;<br>
};<br>
<p>
and <br>
<p>
'{"perf_error": {"raeson": "..."}}'<br>
<p>
?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657908/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2015 14:04 UTC (Sun)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/657919/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Not much. They would, I expect, be used as:<br>
<p>
<font class="QuotedText">&gt; printf("%s", err-&gt;raeson);</font><br>
<p>
or:<br>
<p>
<font class="QuotedText">&gt; print("%(raeson)s", err["perf_error"])</font><br>
<p>
Which might get bug reports, but comments in the code could avoid that. If it is, instead, just a freeform string with no inherent structure, bugs will never end about there being a typo because people will just print the whole thing out. Those who do try to extract information may regex match it to extract the key bits for their own i18n, but then fixing the typo breaks ABI. And sprinkling "[sic]" throughout the logs isn't really nice either.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor657937"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 20, 2015 21:58 UTC (Sun)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/657937/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
JSON is likely to be used not for free-form strings, but for individual elements. So it's not really different from a C structure.<br>
<p>
Yes, you can actually dump JSON as-is into the system log, which is impossible with C structures. But personally, I consider this a plus.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/657937/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor658024"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Why json?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Sep 22, 2015 5:38 UTC (Tue)
                               by <b>mathstuf</b> (subscriber, #69389)
                              [<a href="/Articles/658024/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
The problem with a structure is that you're going to end up with some union monstrosity on par with struct page to actually represent everything. And it will need to be versioned. And good luck getting any sensible language bindings for such a struct. JSON is pretty well universally understood, and creating strings from a dictionary is simple with any language that doesn't come with a built-in, pre-aimed foot cannon these days (Bash, C, and C++ if you're allergic to Boost).<br>
<p>
For example, Python:<br>
<p>
ERROR_DICT = { "prctl:0": "foo {bar}" }<br>
ERROR_DICT.get("{type}:{version}".format(**exterr), "unhandled").format(**exterr)<br>
<p>
Or something like that.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/658024/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2015, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
