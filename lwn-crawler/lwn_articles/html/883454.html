        <!DOCTYPE html>
        <html lang="en">
        <head><title>A memory allocator for BPF code [LWN.net]</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<META NAME="robots" CONTENT="noai, noimageai">
        <link rel="icon" href="https://static.lwn.net/images/favicon.png"
              type="image/png">
        <link rel="alternate" type="application/rss+xml" title="LWN.net headlines" href="https://lwn.net/headlines/rss">
<link rel="alternate" type="application/rss+xml" title="Comments posted to this article" href="https://lwn.net/headlines/883454/">
        <link rel="stylesheet" href="/CSS/lwn">
<link rel="stylesheet" href="/CSS/nosub">

        
<script type="text/javascript">var p="http",d="static";if(document.location.protocol=="https:"){p+="s";d="engine";}var z=document.createElement("script");z.type="text/javascript";z.async=true;z.src=p+"://"+d+".adzerk.net/ados.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(z,s);</script>
<script type="text/javascript">
var ados_keywords = ados_keywords || [];
if( location.protocol=='https:' ) {
        ados_keywords.push('T:SSL');
} else {
        ados_keywords.push('T:HTTP');
}

var ados = ados || {};
ados.run = ados.run || [];
ados.run.push(function() {

ados_add_placement(4669, 20979, "azk13321_leaderboard", 4).setZone(16026);

ados_add_placement(4669, 20979, "azk93271_right_zone", [5,10,6]).setZone(16027);

ados_add_placement(4669, 20979, "azk31017_tracking", 20).setZone(20995);



ados_setKeywords(ados_keywords.join(', ')); 
ados_load();
});</script>

        </head>
        <body>
        <a name="t"></a>
<div id="menu"><a href="/"><img src="https://static.lwn.net/images/logo/barepenguin-70.png" class="logo"
                 border="0" alt="LWN.net Logo">
           <span class="logo">LWN<br>.net</span>
           <span class="logobl">News from the source</span></a>
           <a href="/"><img src="https://static.lwn.net/images/lcorner-ss.png" class="sslogo"
                 border="0" alt="LWN"></a><div class="navmenu-container">
           <ul class="navmenu">
        <li><a class="navmenu" href="#t"><b>Content</b></a><ul><li><a href="/current/">Weekly Edition</a></li><li><a href="/Archives/">Archives</a></li><li><a href="/Search/">Search</a></li><li><a href="/Kernel/">Kernel</a></li><li><a href="/Security/">Security</a></li><li><a href="/Calendar/">Events calendar</a></li><li><a href="/Comments/unread">Unread comments</a></li><li><hr></li><li><a href="/op/FAQ.lwn">LWN FAQ</a></li><li><a href="/op/AuthorGuide.lwn">Write for us</a></li></ul></li>
<li><a class="navmenu" href="#t"><b>Edition</b></a><ul><li><a href="/Articles/883698/">Return to the Front page</a></li></ul></li>
</ul></div>
</div> <!-- menu -->
<div class="not-handset"
            	     style="margin-left: 10.5em; display: block;">
                   <div class="not-print"> <div id="azk13321_leaderboard"></div> </div>
                </div>
            <div class="topnav-container">
<div class="not-handset"><form action="https://lwn.net/Login/" method="post" name="loginform"
                 class="loginform">
        <label><b>User:</b> <input type="text" name="uname" value="" size="8" id="uc" /></label> 
		<label><b>Password:</b> <input type="password" name="pword" size="8" id="pc" /></label> <input type="hidden" name="target" value="/Articles/883454/" /> <input type="submit" name="submit" value="Log in" /></form> |
           <form action="https://lwn.net/subscribe/" method="post" class="loginform">
           <input type="submit" name="submit" value="Subscribe" />
           </form> |
           <form action="https://lwn.net/Login/newaccount" method="post" class="loginform">
           <input type="submit" name="submit" value="Register" />
           </form>
        </div>
               <div class="handset-only">
               <a href="/subscribe/"><b>Subscribe</b></a> /
               <a href="/Login/"><b>Log in</b></a> /
               <a href="/Login/newaccount"><b>New account</b></a>
               </div>
               </div><div class="maincolumn flexcol">
<div class="middlecolumn">
<div class="PageHeadline">
<h1>A memory allocator for BPF code</h1>
</div>
<div class="ArticleText">
<blockquote class="ad">
<b>Did you know...?</b>
<p>
LWN.net is a subscriber-supported publication; we rely on subscribers
       to keep the entire operation going.  Please help out by <a
       href="/Promo/nst-nag4/subscribe">buying a subscription</a> and keeping LWN on the
       net.
</blockquote>
<div class="FeatureByline">
           By <b>Jonathan Corbet</b><br>February 4, 2022</br>
           </div>
Loading a BPF program into the kernel involves a lot of steps, including
verification, permissions checking, linking to in-kernel helper functions,
and compilation to the native instruction format.  Underneath all of that,
though, lies one other simple task: allocating some memory to store the
compiled BPF program in the kernel's address space.  It turns out that this
allocation 
can be somewhat wasteful of memory in current kernels, especially on
systems where large numbers of BPF programs are loaded.  <a
href="/ml/linux-kernel/20220201062803.2675204-1-song@kernel.org/">This
patch set</a> from Song Liu seeks to remedy this problem by introducing yet
another specialized memory allocator into the kernel.
<p>
The kernel allows BPF programs to be reasonably large, but most of them
are, in practice, quite small.  BPF can do quite a bit with a few hundred
bytes of code space.  But the kernel allocates space for BPF programs in
units of full base (usually 4KB) pages, with all of the space past the end
of each program 
being wasted for as long as that program remains loaded.  For a small
program, most of the page allocated to hold the code is unused; if there
are many programs loaded, the amount of wasted memory can start to add up.
<p>
Liu's patch set adds a new "bpf_prog_pack" allocator to address this
problem.  It would be, on the surface, one of the simplest memory allocators in
the system.  It maintains a list of huge pages to hold BPF programs,
allocating new ones as needed.  Whenever space is needed for a new BPF
program, a simple, first-fit algorithm allocates the amount needed.  A
bitmap associated with each huge page (or "pack") tracks the free space (in
64B chunks),
thus automatically coalescing chunks returned to the allocator when
programs are unloaded.  It is not written for speed, but it does not need
to be; even on a system that makes heavy use of BPF, allocation and free
operations will be relatively rare.
<p>
The advantages of this simple allocator are reasonably clear.  Because
multiple programs can be packed into a single page, the memory
that is wasted due to internal fragmentation will be greatly reduced.
Performance will be helped by putting BPF programs into huge pages, which
reduces translation lookaside buffer (TLB) pressure.  But it is worth
asking why yet another allocator is needed when the kernel already has
memory-management code that has been extensively developed and tuned over
the years.  The answer is that BPF brings some special needs that cannot be
met with existing allocators.
<p>
The problem with using the kernel's page allocator without a subdividing
layer has already been described: too much space is wasted.  But the
kernel's slab allocators have been designed for exactly this task: they
take large chunks from the page allocator and pass them out to the rest of
the kernel in smaller pieces.  So it might be natural to think about using
the slab allocator here; Liu does not explain why that was not done, but
there are a couple of plausible reasons for this choice.
<p>
One reason is that the slab allocators are optimized for the allocation of
equal-sized chunks.  But there is no one size that fits all for BPF
programs, so the simple expedient of using a dedicated slab and
<tt>kmem_cache_alloc()</tt> will not work here.  It would be possible to
use multiple slabs, of course, either directly within the BPF code or
simply by allocating space with <tt>kmalloc()</tt>, but there would be
internal fragmentation issues there (albeit smaller) either way.  The
power-of-two approach used by <tt>kmalloc()</tt> would still waste a fair
amount of space at the end of each program.
<p>
There is a more fundamental problem with using the slab allocator, though.
BPF programs are executable code, which must be handled specially.  Code
requires execute permissions at the page level, meaning that it cannot
be intermixed with data (as <tt>kmalloc()</tt> would do).  After all,
developers have gone out of their way for years to ensure that data
cannot be made executable within the kernel.  So the slab allocators, which
are meant to manage space for data, are not really suitable for this
application.
<p>
A certain amount of trickery is required to make the program-packing scheme
work, even with the
special-purpose allocator.  Updating code in a running system is fraught
with perils; if a CPU in the system tries to run code while it is being
changed, the results tend to be bad.  The kernel relies fairly heavily on
self-modifying code, so the mechanisms to do this modification safely are
there, but the task must still be handled carefully.
The inability to write to executable memory in straightforward ways, along
with the fact that executable memory in the kernel must be read-only, 
presents challenges for the JIT compiler.
<p>
So when the new allocator is
invoked to find a spot for a new program, it actually allocates <i>two</i>
buffers.  The first is the read-only, executable space where the program is
destined to live; the second is ordinary memory obtained with
<tt>kvmalloc()</tt>.  The JIT compiler will compile into the second buffer,
which can be written to,
but any addresses it generates must be relative to the first buffer
instead.  Once the compilation process is complete, the kernel's "text
poke" machinery, <a
href="/ml/linux-kernel/20220201062803.2675204-6-song@kernel.org/">enhanced</a>
with a new copy function, can be used to move the compiled program into the
read-only space and the temporary buffer freed.
<p>
This patch set has been through eight revisions as of this writing, with a
fair amount of review activity creating a stream of new items to fix.  At this
point, though, there may not be a whole lot more to change.  So it
would not be entirely surprising to see this code find its way into 5.18;
heavy BPF users should benefit with reduced memory usage and a small
performance improvement.<br clear="all"><table class="IndexEntries">
           <tr><th colspan=2>Index entries for this article</th></tr>
           <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#BPF-Memory_management">BPF/Memory management</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Memory_management-BPF">Memory management/BPF</a></td></tr>
            <tr><td><a href="/Kernel/Index">Kernel</a></td><td><a href="/Kernel/Index#Releases-5.18">Releases/5.18</a></td></tr>
            </table><br clear="all">
<hr width="60%%" align="left">
            <form action="/Login/" method="post">
            <input type="hidden" name="target" value="/Articles/883454/" />
            <input type="submit" name="login" value="Log in" /> to post comments
            <p>
        
</div> <!-- ArticleText -->
<p><a name="Comments"></a>
<a name="CommAnchor883862"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">Pointed question, I guess...</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 4, 2022 20:56 UTC (Fri)
                               by <b>warrax</b> (subscriber, #103205)
                              [<a href="/Articles/883862/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess it&#x27;s not that much about the allocator specifically, but I&#x27;m wondering... as this BPF thing gains more and more capabilities... is there *any* attempt at formal verification that extensions don&#x27;t break the critical guarantees of the verification step?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883862/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883906"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 0:06 UTC (Sun)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/883906/">Link</a>] (27 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You sure have a lot of BPF programs if you feel that a huge page (2MB) is a good minimum size to spend on them!<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883906/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883918"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 8:00 UTC (Sun)
                               by <b>epa</b> (subscriber, #39769)
                              [<a href="/Articles/883918/">Link</a>] (23 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think you must have a lot if you care at all that each one uses a whole four kilobytes normally. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883918/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883927"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 14:30 UTC (Sun)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/883927/">Link</a>] (22 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There are already kubernetes CNIs that use bpf to create the overlay network.  Maybe someone is pushing packet filtering into bpf as one rule per prog?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883927/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884063"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 7:53 UTC (Tue)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/884063/">Link</a>] (21 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I remain baffled that overlay networks are so ingrained in Kubernetes<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884063/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884126"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 21:22 UTC (Tue)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/884126/">Link</a>] (20 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I think they are unfortunately pretty inevitable when everyone has to share the same 24/16 bits of address space, especially over existing networks usually not built to the security and scalability requirements of running thousands of containers.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884126/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884128"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 21:27 UTC (Tue)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/884128/">Link</a>] (7 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Really, “has no”? I assume these things support IPv6?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884128/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884136"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 22:50 UTC (Tue)
                               by <b>atnot</b> (subscriber, #124910)
                              [<a href="/Articles/884136/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It does theoretically, except that:<br>
<p>
* It is only somewhat usable in recent versions<br>
* docker still does not enable it out of the box so nobody builds oci images with ipv6 in mind<br>
* very little of the tooling has ever encountered a v6 address nevermind a v6-only environment<br>
* neither have most developers working in the space<br>
* the cloud and corporate environments these systems are usually rigidly v4-only<br>
<p>
Sometimes I wonder where we&#x27;d be today if the people at docker had decided to use v6 internally right away. Not like anyone would have batted an eye with all of the other quirks of docker. But instead every organization using 172.16.0.0/16 internally now has to deal with an endless stream of users running docker complaining not being able to access the network. Oh well.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884136/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884140"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 22:59 UTC (Tue)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/884140/">Link</a>] (5 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
OK, that&#x27;s pretty insane (it&#x27;s not like IPv6 has been particularly exotic for the last decade or two). But I guess people are so incredibly wed to their IPv4 thinking that they&#x27;d rather add thirty layers of complexity than switch to the version with more address space :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884140/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884168"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2022 6:58 UTC (Wed)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/884168/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Yeah having to administer bgp servers of all things always seemed more painful to me than just getting ipv6 working correctly.<br>
<p>
I think part of it is that it comes from google&#x27;s borg, and google is the main contributor to the ecosystem, and google built out their datacenter architecture and management tools before ipv6 was a &quot;thing&quot;, and deploying ipv6 at the lowest levels of the &quot;hyperscalers&quot; data centers is .... really, really scary, so they didn&#x27;t, and then k8s needs to actually work on google infrastructure (and indeed, there&#x27;s no incentive to make it work anywhere else).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884168/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884567"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2022 20:12 UTC (Fri)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/884567/">Link</a>] (3 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Google was founded in 1998, two years after I&#x27;d set up Manchester University&#x27;s IPv6 node. So, yes, it&#x27;s before IPv6 became mainstream, but stacks were in Linux as of 2.0.20 (with a patch) and were in the main kernel by early 2.1 IIRC. (They&#x27;d already been in Windows - thanks to FTP Software, and Solaris.) KAME was already out for the BSDs, I think.<br>
<p>
At that time, IIRC, NRL were distributing a library for stack-independent network code. (The connection could be IPv4, IPv6 or indeed any other supported protocol and that detail would be hidden from the application.) Since Google&#x27;s use case was not that complicated, Google could even have written a small bit of code to do the same thing, although it would have meant getting the web server to support it, which would have added to what they had to maintain.<br>
<p>
So Google could have either supported IPv6 directly or developed their code to simply not care about that layer at all. Now, in hindsight, the extra work then (when things were simple) might have made sense, although it&#x27;s just as possible that they simply didn&#x27;t have the time or money to throw in features that they couldn&#x27;t sell at the time. And, let&#x27;s be honest, there was quite a lot of cynicism about IPv6 back then as well.<br>
<p>
Today, to have a protocol-independent communications layer would be a LOT of work for everyone, I&#x27;m not sure you could introduce such a system at this point, and switching a massive heap of interdependent legacy IPv4 code to IPv6 would be almost as painful.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884567/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884571"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2022 20:39 UTC (Fri)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/884571/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It&#x27;s worth noting there&#x27;s another company with great engineering accomplishments, namely Facebook (or maybe Meta now?). They went with IPv6-first internal networks in DCs. They also have own container-orchestration solution – Tupperware. <br>
I&#x27;d love to see a comparison (with emphasis on networking) between Tupperware and Kubernetes/Borg.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884571/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor884602"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2022 1:07 UTC (Sat)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/884602/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
FWIW, I did large chunks of Google&#x27;s IPv6 porting back in the day, and nearly all code was indeed written protocol-independently, so slotting in IPv6 support was fairly easy. You had to fix a few central abstractions, and some stuff around logging and ACLs and such, but it turns out most code doesn&#x27;t care much about what an IP address _is_, just that you can store it and send it around to other parts of the code. (We were, de facto, three people who did most of it over a period of 1–2 years, not all of us full-time.) IIRC, you could have pulled up an IPv6-only Borg cluster around early 2011 or so if you wanted, and have it run real production-like workloads. But changing how cluster operations work is a completely different game; one that I never pursued, and I have no idea how it works internally now (I&#x27;ve since quit and then rejoined Google, but in a completely different part of the company). And public cloud happened after all of us had moved on to other systems, so no, I&#x27;m not responsible for any deficiencies that might have :-)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884602/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor893245"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted May 1, 2022 12:01 UTC (Sun)
                               by <b>MaZe</b> (subscriber, #53908)
                              [<a href="/Articles/893245/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Cluster stuff is now (finally!) basically done and ipv6-only.<br>
Though of course there&#x27;s always weird special cases and exceptions, like critical ipv4-only hardware (temperature sensors, ntp/gps and the like).<br>
The current true battlefront is in cloud... and to a lesser extent trying to get to ipv6-only corp (due to rfc1918 [incl. cgnat] exhaustion).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/893245/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor884130"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 21:40 UTC (Tue)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/884130/">Link</a>] (11 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
It doesn&#x27;t particularly matter how large the addressable space is.  The option is to either try to coordinate the ports used by potentially 100s of containers dynamically scheduled onto the same host or use an abstraction layer such that every container can have a service listening on port 80.  I can think of no examples of a container orchestrator that went with port coordination. docker swarm, meos, ecs, k8s, cloud foundry, etc. support an overlay.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884130/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884132"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 21:43 UTC (Tue)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/884132/">Link</a>] (10 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It doesn&#x27;t particularly matter how large the addressable space is. The option is to either try to coordinate the ports used by potentially 100s of containers dynamically scheduled onto the same host or use an abstraction layer such that every container can have a service listening on port 80.</font><br>
<p>
Why is it not an option to give each container an IPv6 subnet?<br>
<p>
<font class="QuotedText">&gt; I can think of no examples of a container orchestrator that went with port coordination.</font><br>
<p>
Borg did.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884132/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884141"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 23:02 UTC (Tue)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/884141/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
You certainly can, and that&#x27;s what the newest K8s does. But K8s overlay network also provides some security guarantees, because it&#x27;s trusted and is not open to the public Internet.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884141/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884176"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2022 7:34 UTC (Wed)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/884176/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
That&#x27;s sort of true I suppose, but it&#x27;s true in the same way that nat provides security guarantees (you can&#x27;t have an overlay network without doing that stuff, but you can do that stuff without having an overlay network)<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884176/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884178"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2022 7:51 UTC (Wed)
                               by <b>Cyberax</b> (<b>&#x272D; supporter &#x272D;</b>, #52523)
                              [<a href="/Articles/884178/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
K8s network is not open to the public Internet at all. If you receive a packet from it, there&#x27;s a guarantee that it has been sent by somebody within the trusted net.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884178/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
<a name="CommAnchor884155"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2022 1:19 UTC (Wed)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/884155/">Link</a>] (6 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Giving each container its own network address which is distinct from the container host is called an overlay network.  If it is ipv4, ipv6, ipx, or appletalk is just an implementation detail.<br>
<p>
k8s supports ipv4, ipv6, and last year dual stack came out of beta.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884155/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884171"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 9, 2022 7:31 UTC (Wed)
                               by <b>bartoc</b> (guest, #124262)
                              [<a href="/Articles/884171/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
no, &quot;overlay networks&quot; are not the same as &quot;giving each container it&#x27;s own IP&quot;<br>
<p>
Overlay networks imply some kind of packet encapsulation, with ipv6 that&#x27;s not necessary.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884171/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor884569"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2022 21:18 UTC (Fri)
                               by <b>jd</b> (guest, #26381)
                              [<a href="/Articles/884569/">Link</a>] (4 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
Well, given the way IPv6 has been used in practice, you&#x27;re absolutely right. And if you are content to only consider what is mainstream practice, nothing after this point will be of the slightest interest.<br>
<p>
According to how it was originally designed (a prefix which defines the route, and a suffix that defines any given physical or virtual machine that is connected via that route), there was a bit more freedom as any physical or virtual interface was absolutely guaranteed a unique IPv6 address. This was when autoconfiguring networks were to be the way and DHCP was seen as a maintenance-heavy dead end.<br>
<p>
(This is how the original mobility system worked. If you moved a machine from one network to another, you simply notified everyone connected that your prefix had changed and all packets - including those in transit - would be diverted to your new prefix. Your old address would be marked transient and would remain usable for existing packets but not new ones. This necessitates a unique suffix.)<br>
<p>
This means that to have a new subnet, you simply add a byte to the prefix to identify the new network. As long as there were bytes left you could use, defining new subnets was trivial. Which meant one interface had one IP address. There was no concept of multihome. In order to have more than one IP address go through an interface, you needed a virtual network, where each virtual interface had one IP address. Yes, it&#x27;s still an overlay network, but it became part of the design rather than an add-on, and there was no distinction between what was software and what was hardware. It was just one network.<br>
<p>
Telebit devised an extension for this, although I think it vanished with them. As far as I could understand, their system allowed the creation of networks that were utterly transparent to the outside world through some sort of NAT. Your traffic could even go over these transparent segments and back onto the visible network but it would look like a single hop to the outside world, which wasn&#x27;t bad for nascent IPv6 in 1996. That would have let you get past the prefix length limit.<br>
<p>
Of course, nothing actually stops you from using the autoconfigure protocol for containers and virtual switches in a virtual network of containers - well, other than this really doesn&#x27;t play nice with software that assumes a static IP. You&#x27;re only guaranteed a static suffix.<br>
<p>
If you&#x27;re happy with mainstream protocols, whether or not it&#x27;s standard use, then stop here. Because it&#x27;s about to get scary.<br>
<p>
IPv6 evolved out of a couple of experimental IPng protocols, one of which was TUBA. Now, with TUBA, the idea was that addresses were variable length. (I did say it was about to get scary.) IIRC, routing would be done by moving the cursor up or down from the current position to just the next few bytes to see where the packet should go. Something hardware engineers were getting ready to mutiny over, from the sounds of things. How this would have ever worked is left as an exercise for Steven King fans. But in principle, it would have meant that you couldn&#x27;t run out of space on the prefix.<br>
<p>
<p>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884569/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884583"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 11, 2022 21:29 UTC (Fri)
                               by <b>jhoblitt</b> (subscriber, #77733)
                              [<a href="/Articles/884583/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
There is also the small issue that until extremely recently, ipv6 support in network equipment often could not be trusted.  It is easy to wave your hands and be dismissive of this but all of the so called hyperscalers had massive difficulty in rolling out ipv6.  It is easy to say supports ipv6 on the box of a switch but does it work with the same reliability and hardware acceleration as ipv4? Say with NDP working reliability over an EVPN based spine+leaf deployment?  The answer was obviously no until practical last week.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884583/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884603"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 12, 2022 1:10 UTC (Sat)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/884603/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; It is easy to wave your hands and be dismissive of this but all of the so called hyperscalers had massive difficulty in rolling out ipv6.</font><br>
<p>
Citation needed, please? Or at least a clarification of what “rolling out IPv6” would entail, because e.g. www.google.com has had AAAA records since June 6th, 2012 (World IPv6 Launch).<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884603/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
<a name="CommAnchor885037"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2022 19:49 UTC (Wed)
                               by <b>flussence</b> (guest, #85566)
                              [<a href="/Articles/885037/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
<font class="QuotedText">&gt; IPv6 evolved out of a couple of experimental IPng protocols, one of which was TUBA.</font><br>
<p>
Wait, the real answer to the ignoramuses going “LOL IPv6, why don&#x27;t we just make IPv4 addresses longer?” was sitting right there in an RFC (1347) all this time?!<br>
<p>
I almost want them to find it and try and implement it, just for the schadenfreude.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/885037/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor885041"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 16, 2022 20:14 UTC (Wed)
                               by <b>nybble41</b> (subscriber, #55106)
                              [<a href="/Articles/885041/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
TUBA (RFC1347) keeps TCP and UDP but replaces the IP layer with Connectionless Network Layer Protocol (CNLP). No compatibility was offered via translation or tunneling between IP and CNLP networks and the CNLP protocol diverges more from IPv4 than IPv6 does. Ergo, TUBA would not have been any less disruptive than dual-stack IPv4+IPv6 and represents a step backward from something like 464XLAT which permits IPv6-only networks to communicate with IPv4-only hosts via stateful NAT and protocol translation. Plus, of course, all the hardware engineers&#x27; perfectly legitimate objections to variable-length addresses.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/885041/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
</details>
<a name="CommAnchor883919"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 8:10 UTC (Sun)
                               by <b>zdzichu</b> (subscriber, #17118)
                              [<a href="/Articles/883919/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      There could be more than you expect. You can use <code>bpftool prog</code> command to see them.<br></br>
On my typical Fedora laptop, there are 21 programs loaded. On my home server there are 470. All of them loaded by systemd and libvirtd, nothing custom.





      
          <div class="CommentReplyButton">
            <form action="/Articles/883919/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883930"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 16:25 UTC (Sun)
                               by <b>plugwash</b> (subscriber, #29694)
                              [<a href="/Articles/883930/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
A huge page is 512 regular pages. So it sounds like you would need hundreds of bpf programs to see a memory usage benefit from this patch. From your numbers it sounds like that would not be the case on your laptop.<br>
<p>
Of course you could argue that a couple of wasted megabytes is lost in the noise on a modern desktop/laptop but.............<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883930/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor883934"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 17:46 UTC (Sun)
                               by <b>Sesse</b> (subscriber, #53779)
                              [<a href="/Articles/883934/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
More precisely: You&#x27;d need hundreds just to break even, and in the thousands to see any gains.<br>
<p>
My server seems to have 20–30 BPF programs, but I guess this will eventually increase. Maybe this allocator will be optional?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883934/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</details>
<a name="CommAnchor883932"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 6, 2022 17:29 UTC (Sun)
                               by <b>ttuttle</b> (subscriber, #51118)
                              [<a href="/Articles/883932/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
BPF programs come in as bytecode, and this allocator holds machine code. By the time it&#x27;s running, the code is already stored in a temporary buffer (from kvmalloc), so it knows how much space it needs.<br>
<p>
How does the BPF code itself know how big a buffer to ask kvmalloc for? Or is it one of those &quot;ask for a reasonable size and double it every time it fills up&quot; kind of deals?<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883932/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
<a name="CommAnchor883981"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">A memory allocator for BPF code</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 7, 2022 10:41 UTC (Mon)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/883981/">Link</a>] (2 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
This &#x27;packing and fragmentation&#x27; pattern looks like a filesystem -- would extending RAMFS with de-allocation (so the kernel can manage the pool) be a better way to manage permissions and pack smaller-than-4K items across pages?<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/883981/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884067"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RAMFS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 8:56 UTC (Tue)
                               by <b>matthias</b> (subscriber, #94967)
                              [<a href="/Articles/884067/">Link</a>] (1 responses)
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I guess the answer is a simple no.<br>
<p>
Does RAMFS even support block sizes smaller than pagesize? The new allocator uses 64B as blocksize. Also the filesystem has a huge overhead, as each file needs an inode and a directory entry. All this is not needed for BPF programs. Knowing their address (in memory) and maybe size is enough to use them. All the overhead a filesystem has to represent a single file will be much bigger than the program itself.<br>
<p>
And the filesystem cannot manage the permissions. Filesystem permissions are a completely different thing. Here, we are talking about the access bits that are used by the memory management unit. And a filesystem will not help with that. You cannot mix data with executable code, as both things need different bits set in the pagetables. However these bits are only available per page. So you need a pool in memory that does not hold any data, just executable code. <br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884067/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    <a name="CommAnchor884068"></a>
    <details class="CommentBox" open>
      <summary><h3 class="CommentTitle">RAMFS?</h3>
      <div class="AnnLine">
      <p class="CommentPoster"> Posted Feb 8, 2022 11:45 UTC (Tue)
                               by <b>k3ninho</b> (subscriber, #50375)
                              [<a href="/Articles/884068/">Link</a>] 
      </p>
      
      </div>
      </summary>
      <div class="FormattedComment">
I was so hoping we could apply everything-is-a-file to this filter-all-the-things pattern...<br>
<p>
K3n.<br>
</div>

      
          <div class="CommentReplyButton">
            <form action="/Articles/884068/comment" method="post">
            <input type="submit" value="Reply to this comment">
            </form>
          </div>
        
     <p>
     
    </details>
</details>
</details>
</div> <!-- middlecolumn -->
<div class="rightcol not-print">
<div id="azk93271_right_zone"></div>
</div>
</div> <!-- maincolumn -->

            <br clear="all">
            <center>
            <P>
            <span class="ReallySmall">
            Copyright &copy; 2022, Eklektix, Inc.<BR>
            This article may be redistributed under the terms of the
              <a href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
              Commons CC BY-SA 4.0</a> license<br>
            Comments and public postings are copyrighted by their creators.<br>
            Linux  is a registered trademark of Linus Torvalds<br>
            </span>
            </center>
            
            </body></html>
