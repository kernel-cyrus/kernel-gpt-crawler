# Replacing /dev/urandom [LWN.net]

> **Ready to give LWN a try?**
> 
> With a subscription to LWN, you can stay current with what is happening in the Linux and free-software community and take advantage of subscriber-only site features. We are pleased to offer you **[a free trial subscription](https://lwn.net/Promo/nst-trial/claim)** , no credit card required, so that you can see for yourself. Please, join us! 

By **Jonathan Corbet**  
May 4, 2016 

The kernel's random-number generator (RNG) has seen [a great deal of attention](/Kernel/Index/#Random_numbers) over the years; that is appropriate, given that its proper functioning is vital to the security of the system as a whole. During that time, it has acquitted itself well. That said, there are some concerns about the RNG going forward that have led to various patches aimed at improving both randomness and performance. Now there are two patch sets that significantly change the RNG's operation to consider. 

[The first of these](/Articles/685468/) comes from Stephan Müller, who has two independent sets of concerns that he is trying to address: 

  * The randomness (entropy) in the RNG, in the end, comes from sources of physical entropy in the outside world. In practice, that means the timing of disk-drive operations, human-input events, and interrupts in general. But the solid-state drives deployed in current systems are far more predictable than rotating drives, many systems are deployed in settings where there are no human-input events at all, and, in any case, the entropy gained from those events duplicates the entropy from interrupts in general. The end result, Stephan fears, is that the current RNG is unable to pick up enough entropy to be truly random, especially early in the bootstrap process. 

  * The RNG has shown some scalability problems on large NUMA systems, especially when faced with workloads that consume large amounts of random data from the kernel. There have been [various attempts](/Articles/660452/) to improve RNG scalability over the last year, but none have been merged to this point. 




Stephan tries to address both problems by throwing out much of the current RNG and replacing it with "a new approach"; see [this page](http://www.chronox.de/lrng/doc/lrng.xhtml) for a highly detailed explanation of the goals and implementation of this patch set. It starts by trying to increase the amount of useful entropy that can be obtained from the environment, and from interrupt timing in particular. The current RNG assumes that the timing of a specific interrupt carries little entropy — less than one bit. Stephan's patch, instead, accounts a full bit of entropy from each interrupt. Thus, in a sense, this is an accounting change: there is no more entropy flowing into the system than before, but it is being recognized at a higher rate, allowing early-boot users of random data to proceed. 

Other sources of entropy are used as well when they are available; these include a hardware RNG attached to the system or built into the CPU itself (though little entropy is credited for the latter source). Earlier versions of the patch used the [CPU jitter RNG](/Articles/642166/) (also implemented by Stephan) as another source of entropy, but that was removed at the [request](/Articles/686048/) of RNG maintainer Ted Ts'o, who is not convinced that differences in execution time are a trustworthy source of entropy. 

The hope is that interrupt timings, when added to whatever other sources of entropy are available, will be sufficient to quickly fill the entropy pool and allow the generation of truly random numbers. As with current systems, data read from `/dev/random` will remove entropy directly from that pool and will not complete until sufficient entropy accumulates there to satisfy the request. The actual random numbers are generated by running data from the entropy pool through the [SP800-90A](https://en.wikipedia.org/wiki/NIST_SP_800-90A) deterministic random bit generator (DRBG). 

For `/dev/urandom`, another SP800-90A DRBG is fed from the primary DRBG described above and used to generate pseudo-random data. Every so often (ten minutes at the outset), this secondary generator is reseeded from the primary. On NUMA systems, there is one secondary generator for each node, keeping the random-data generation node-local and increasing scalability. 

There has been a certain amount of discussion of Stephan's proposal, which is now in its third iteration, but Ted has said little beyond questioning the use of the CPU jitter technique. Or, at least, that was true until May 2, when he posted [a new RNG of his own](/Articles/685737/). Ted's work takes some clear inspiration from Stephan's patches (and from Andi Kleen's scalability work from last year) but it is, nonetheless, a different approach. 

Ted's patch, too, gets rid of the separate entropy pool for `/dev/urandom`; this time, though, it is replaced by the [ChaCha20 stream cipher](https://en.wikipedia.org/wiki/Salsa20#ChaCha_variant) seeded from the random pool. ChaCha20 is deemed to be secure and, it is thought, will perform better than SP800-9A. There is one ChaCha20 instance for each NUMA node, again, hopefully, helping to improve the scalability of the RNG (though Ted [makes it clear](/Articles/686050/) that he sees this effort as being beyond the call of duty). There is no longer any attempt to track the amount of entropy stored in the (no-longer-existing) `/dev/urandom` pool, but each ChaCha20 instance is reseeded every five minutes. 

When the system is booting, the new RNG will credit each interrupt's timing data with one bit of entropy, as does Stephan's RNG. Once the RNG is initialized with sufficient entropy, though, the RNG switches to the current system, which accounts far less entropy for each interrupt. This policy reflects Ted's unease with assuming that there is much entropy in interrupt timings; the timing of interrupts might be more predictable than one might think, especially on virtualized systems with no direct connection to real hardware. 

Stephan's [response](/Articles/686052/) to this posting has been gracious: ""In general, I have no concerns with this approach either. And thank you that some of my concerns are addressed."" That, along with the fact that Ted is the ultimate decision-maker in this case, suggests that his patch set is the one that is more likely to make it into the mainline; it probably will not come down to flipping a coin. It would be most surprising to see that merging happen for 4.7 — something as sensitive as the RNG needs some review and testing time — but it could happen not too long thereafter.  
Index entries for this article  
---  
[Kernel](/Kernel/Index)| [Random numbers](/Kernel/Index#Random_numbers)  
[Kernel](/Kernel/Index)| [Security/Random number generation](/Kernel/Index#Security-Random_number_generation)  
[Security](/Security/Index/)| [Linux kernel](/Security/Index/#Linux_kernel)  
[Security](/Security/Index/)| [Random number generation](/Security/Index/#Random_number_generation)  
  


* * *

to post comments 
