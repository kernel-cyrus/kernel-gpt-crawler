# P4TC hits a brick wall [LWN.net]

> **Did you know...?**
> 
> LWN.net is a subscriber-supported publication; we rely on subscribers to keep the entire operation going. Please help out by [buying a subscription](/Promo/nst-nag4/subscribe) and keeping LWN on the net. 

By **Jonathan Corbet**  
June 10, 2024 

[P4](https://opennetworking.org/p4/), short for "Programming Protocol-independent Packet Processors", is a programming language aimed at networking devices; it is useful for the configuration of firewalls and complicated routing architectures. Since a lot of advanced networking is done with Linux systems, it stands to reason that there would be value in supporting P4 and, indeed, [an implementation of P4](/ml/netdev/20230124170346.316866-1-jhs@mojatatu.com/) in the kernel's traffic-control subsystem was first posted by Jamal Hadi Salim at the beginning of 2023. After nearly 18 months, though, this feature has not been merged, and the chances of that happening would appear to be getting worse. 

#### Introducing P4TC

The kernel supports a number of traffic-control mechanisms in its networking subsystem; [`tc-flower`](https://man7.org/linux/man-pages/man8/tc-flower.8.html) is perhaps one of the most commonly used. The P4TC subsystem proposed by Salim fits into that subsystem, adding the ability to use the P4 language for the description of networking policies. It is entirely implemented in software, and runs within the kernel. 

That software implementation was one of the first aspects of this work to attract attention. While one can do complicated network processing and routing in the kernel, any implementation that is intended to keep up with current network speeds needs quite a bit of hardware support. There are vendors selling networking hardware that is programmable with P4 now, and P4TC intends to support that hardware, but that capability was not present in the patch set (or any subsequent version). Jiri Pirko [asked about that omission](/ml/netdev/Y9QXWSaAxl7Is0yz@nanopsycho/) in response to the initial posting; Salim [answered](/ml/netdev/CAAFAkD8kahd0Ao6BVjwx+F+a0nUK0BzTNFocnpaeQrN7E8VRdQ@mail.gmail.com/) that the traffic-control subsystem requires a software implementation for any functionality that can be offloaded to hardware (thus ensuring that the functionality is universally available), and that the hardware-offload interfaces were still under consideration. Daniel Borkmann [complained](/ml/netdev/b47d1950-add0-6449-4160-d5e2f7a8d7f7@iogearbox.net/) that nobody would use the software implementation, an assertion that Salim [disagreed with](/ml/netdev/CAM0EoMnxXi+LpbLGhW3L60ehw6PwD43U+DVAGbCahaQCbUQN4w@mail.gmail.com/). 

The other significant comment from the first posting came from Stanislav Fomichev, who [suggested](/ml/netdev/Y9RPsYbi2a9Q/H8h@google.com/) that, rather than adding another packet parser to the kernel, P4TC should compile P4 programs to BPF, which could then run under the protection of the BPF verifier. That is a suggestion that Salim chose to accept; the [second version of the P4TC patches](/ml/netdev/20230517110225.29327-1-jhs@mojatatu.com/), posted in June 2023, included an early implementation of that BPF support. 

#### Increasing opposition

Several versions of the P4TC patch set followed, generally receiving little in the way of reviewer attention. [Version 7](/ml/netdev/20231016093549.181952-1-jhs@mojatatu.com/), posted in October 2023, removed the "RFC" tag, indicating that Salim thought it was ready for merging into the mainline. [Version 8](/ml/netdev/20231116145948.203001-1-jhs@mojatatu.com/), which came in November, attracted more comments. John Fastabend was the first to [raise](/ml/netdev/65571196cff83_55d7320865@john.notmuch/) what was to become an ongoing objection: the new kfuncs added by the patch set implement functionality that is seen as being similar to what BPF maps already provide. These kfuncs were received by a few members of the BPF community as wasteful duplication of code at best, and possibly an abuse of the kfunc mechanism as well. 

Fastabend later [brought forward](/ml/netdev/6557b2e5f3489_5ada920871@john.notmuch/) some other objections. Integrating P4 into the traffic-control subsystem, he said, was likely to hurt performance in a number of ways. Instead, he thought, P4 could be compiled directly to BPF without the need for the traffic-control part. The use of netlink to control P4TC, he said, was slower and more complex than just storing policy information in a BPF map. He also complained that the real benefit from P4 comes with hardware offload, but the patch set still had no support for interfacing with hardware. Throughout these conversations, Salim tried to address the criticisms that were directed toward this work, sometimes showing frustration and often digging in his heels. The use of netlink, for example, was [described](/ml/bpf/CAM0EoM=vbyKD9+t=UQ73AyLZtE2xP9i9RKCVMqeXwEh+j-nyjQ@mail.gmail.com/) as ""not negotiable"". 

[Version 10](/ml/netdev/20240122194801.152658-1-jhs@mojatatu.com/) of the series added more context to the cover letter in an attempt to explain why certain decisions had been made, but Fastabend [reiterated and extended](/ml/netdev/65df6935db67e_2a12e2083b@john.notmuch/) his objections in response to [version 12](/ml/netdev/20240225165447.156954-1-jhs@mojatatu.com/), posted in February. Also in response to that version, networking maintainer Paolo Abeni [pointed out](/ml/netdev/b28f2f7900dc7bad129ad67621b2f7746c3b2e18.camel@redhat.com/) that, while a few developers had expressed opposition to the patches, there were no voices (other than Salim) expressing support; he wondered if the lack of hardware support might be part of the reason for that. Anjali Singhai, [answered](/ml/netdev/CO1PR11MB49931E501B20F32681F917CD935F2@CO1PR11MB4993.namprd11.prod.outlook.com/) that both Intel and AMD need the hardware offload support, but that they also need a standard kernel API to manage P4 programs and an in-kernel pipeline to mix both hardware and software implementation. ""This patch series helps create a SW pipeline and standard API"". Chris Sommers also [expressed support](/ml/all/IA0PR17MB7070B51A955FB8595FFBA5FB965E2@IA0PR17MB7070.namprd17.prod.outlook.com) for the work, giving a long list of reasons why it would be useful for his company. 

[Version 13](/ml/netdev/20240325142834.157411-1-jhs@mojatatu.com/) (late March) got [an ACK](/ml/netdev/877chfmoe5.fsf@toke.dk/) from Toke Høiland-Jørgensen, but little other response. [Version 14](/ml/all/20240404122338.372945-1-jhs@mojatatu.com/) (early April), instead, gained [an explicit NACK](/ml/all/CAADnVQLw1FRkvYJX0=6WMDoR7rQaWSVPnparErh4soDtKjc73w@mail.gmail.com/) from BPF maintainer Alexei Starovoitov resulting from his objections to the BPF integration (and the use of kfuncs in particular). Borkmann [added his NACK](/ml/all/f27bfc4d-8985-6d3d-01f5-782ae1ccb9ee@iogearbox.net) shortly thereafter, as [did Fastabend](/ml/all/661444789fccf_49a6208ec@john.notmuch). 

#### In search of a path forward

Salim persisted, posting [version 16](/ml/all/20240410140141.495384-1-jhs@mojatatu.com) in mid-April. Abeni [suggested](/ml/all/41736ea4e81666e911fee5b880d9430ffffa9a58.camel@redhat.com) removing the BPF component (and significantly reworking the series) as a possible way to move the work into the kernel, drawing [an exasperated response](/ml/all/CAM0EoM=982OctjvSQpx0kR7e+JnQLhvZ=sM-tNB4xNiu7nhH5Q@mail.gmail.com) from Salim, who felt that he should not be asked to remove the BPF support after having added in response to comments from the same people who are objecting now. He later [said](/ml/all/CAM0EoM=VhVn2sGV40SYttQyaiCn8gKaKHTUqFxB_WzKrayJJfQ@mail.gmail.com): ""My view is this series should still be applied with the nacks since it sits entirely on its own silo within networking/TC (and has nothing to do with ebpf)"". Abeni, though, [declined to do that](/ml/all/87cf4830e2e46c1882998162526e108fb424a0f7.camel@redhat.com). 

On May 21, Salim [came back](/ml/all/CAM0EoMmsB5jHZ=4oJc_Yzm=RFDUHWh9yexdG6_bPFS4_CFuiog@mail.gmail.com) with a history of the work and a request that ""a third party mediator"" be brought in to look at the situation and make recommendations. He put together [a web page](https://github.com/p4tc-dev/pushback-patches) describing the work, the objections that have been raised, and his response to them. That mediator has not been named, though, and it does not seem likely that this situation will change. Instead, people like Tom Herbert have [questioned the value of P4](/ml/all/CAOuuhY9b6WZd6eunVGr6QQ=sd7KLvx7OVn4ozzon3+ABRQaYeQ@mail.gmail.com) in general, and networking maintainer Jakub Kicinski [said](/ml/all/20240522151933.6f422e63@kernel.org) that ""the submission is neither technically strong enough, nor broadly useful enough to consider making questionable precedents"" like overriding maintainers. 

As seems to be increasingly frequently the case with controversial kernel patches, one fundamental question here has to do with just how far a subsystem maintainer's reach can go. The P4TC patches are contained within the traffic-control subsystem, which is maintained by (among others) Jamal Hadi Salim. As he has pointed out numerous times, this work _uses_ BPF, but does not change the BPF subsystem; the BPF developers, he says, should thus have no right to block it. 

That view notwithstanding, this work appears to be effectively blocked, and it is not clear where a mutually acceptable resolution might be found. Potential users like Sommers have [expressed their dismay](/ml/all/SN6PR17MB21102057A1745DBCBB101DBB96F42@SN6PR17MB2110.namprd17.prod.outlook.com) at this state of affairs, but that does not appear to have swayed those who are opposed to P4TC. At this point, the positions are deeply entrenched and it is hard to see how they might be reconciled.  
Index entries for this article  
---  
[Kernel](/Kernel/Index)| [BPF/Networking](/Kernel/Index#BPF-Networking)  
[Kernel](/Kernel/Index)| [Networking](/Kernel/Index#Networking)  
  


* * *

to post comments 
